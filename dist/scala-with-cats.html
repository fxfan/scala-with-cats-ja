<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="pandoc" />
    <meta name="author" content="Noel Welsh" />
    
  <title>Functional Programming Strategies</title>

  
  <link href="data:text/html; charset=utf-8;charset=utf-8,%3Chtml%20lang%3D%22en%22%20dir%3Dltr%3E%3Cmeta%20charset%3Dutf%2D8%3E%3Cmeta%20name%3Dviewport%20content%3D%22initial%2Dscale%3D1%2C%20minimum%2Dscale%3D1%2C%20width%3Ddevice%2Dwidth%22%3E%3Ctitle%3EError%20404%20%28Not%20Found%29%21%211%3C%2Ftitle%3E%3Cstyle%3E%2A%7Bmargin%3A0%3Bpadding%3A0%7Dhtml%2Ccode%7Bfont%3A15px%2F22px%20arial%2Csans%2Dserif%7Dhtml%7Bbackground%3A%23fff%3Bcolor%3A%23222%3Bpadding%3A15px%7Dbody%7Bcolor%3A%23222%3Btext%2Dalign%3Aunset%3Bmargin%3A7%25%20auto%200%3Bmax%2Dwidth%3A390px%3Bmin%2Dheight%3A180px%3Bpadding%3A30px%200%2015px%3B%7D%2A%20%3E%20body%7Bbackground%3Aurl%28%2F%2Fwww%2Egoogle%2Ecom%2Fimages%2Ferrors%2Frobot%2Epng%29%20100%25%205px%20no%2Drepeat%3Bpadding%2Dright%3A205px%7Dp%7Bmargin%3A11px%200%2022px%3Boverflow%3Ahidden%7Dpre%7Bwhite%2Dspace%3Apre%2Dwrap%3B%7Dins%7Bcolor%3A%23777%3Btext%2Ddecoration%3Anone%7Da%20img%7Bborder%3A0%7D%40media%20screen%20and%20%28max%2Dwidth%3A772px%29%7Bbody%7Bbackground%3Anone%3Bmargin%2Dtop%3A0%3Bmax%2Dwidth%3Anone%3Bpadding%2Dright%3A0%7D%7D%23logo%7Bbackground%3Aurl%28%2F%2Fwww%2Egoogle%2Ecom%2Fimages%2Fbranding%2Fgooglelogo%2F1x%2Fgooglelogo%5Fcolor%5F150x54dp%2Epng%29%20no%2Drepeat%3Bmargin%2Dleft%3A%2D5px%7D%40media%20only%20screen%20and%20%28min%2Dresolution%3A192dpi%29%7B%23logo%7Bbackground%3Aurl%28%2F%2Fwww%2Egoogle%2Ecom%2Fimages%2Fbranding%2Fgooglelogo%2F2x%2Fgooglelogo%5Fcolor%5F150x54dp%2Epng%29%20no%2Drepeat%200%25%200%25%2F100%25%20100%25%3B%2Dmoz%2Dborder%2Dimage%3Aurl%28%2F%2Fwww%2Egoogle%2Ecom%2Fimages%2Fbranding%2Fgooglelogo%2F2x%2Fgooglelogo%5Fcolor%5F150x54dp%2Epng%29%200%7D%7D%40media%20only%20screen%20and%20%28%2Dwebkit%2Dmin%2Ddevice%2Dpixel%2Dratio%3A2%29%7B%23logo%7Bbackground%3Aurl%28%2F%2Fwww%2Egoogle%2Ecom%2Fimages%2Fbranding%2Fgooglelogo%2F2x%2Fgooglelogo%5Fcolor%5F150x54dp%2Epng%29%20no%2Drepeat%3B%2Dwebkit%2Dbackground%2Dsize%3A100%25%20100%25%7D%7D%23logo%7Bdisplay%3Ainline%2Dblock%3Bheight%3A54px%3Bwidth%3A150px%7D%3C%2Fstyle%3E%3Cmain%20id%3D%22af%2Derror%2Dcontainer%22%20role%3D%22main%22%3E%3Ca%20href%3D%2F%2Fwww%2Egoogle%2Ecom%3E%3Cspan%20id%3Dlogo%20aria%2Dlabel%3DGoogle%20role%3Dimg%3E%3C%2Fspan%3E%3C%2Fa%3E%3Cp%3E%3Cb%3E404%2E%3C%2Fb%3E%20%3Cins%3EThat%E2%80%99s%20an%20error%2E%3C%2Fins%3E%3Cp%3EThe%20requested%20URL%20was%20not%20found%20on%20this%20server%2E%20%3Cins%3EThat%E2%80%99s%20all%20we%20know%2E%3C%2Fins%3E%3C%2Fmain%3E" rel="preconnect">
  <link href="data:text/html; charset=UTF-8;charset=utf-8,%3C%21DOCTYPE%20html%3E%0A%3Chtml%20lang%3Den%3E%0A%20%20%3Cmeta%20charset%3Dutf%2D8%3E%0A%20%20%3Cmeta%20name%3Dviewport%20content%3D%22initial%2Dscale%3D1%2C%20minimum%2Dscale%3D1%2C%20width%3Ddevice%2Dwidth%22%3E%0A%20%20%3Ctitle%3EError%20404%20%28Not%20Found%29%21%211%3C%2Ftitle%3E%0A%20%20%3Cstyle%3E%0A%20%20%20%20%2A%7Bmargin%3A0%3Bpadding%3A0%7Dhtml%2Ccode%7Bfont%3A15px%2F22px%20arial%2Csans%2Dserif%7Dhtml%7Bbackground%3A%23fff%3Bcolor%3A%23222%3Bpadding%3A15px%7Dbody%7Bmargin%3A7%25%20auto%200%3Bmax%2Dwidth%3A390px%3Bmin%2Dheight%3A180px%3Bpadding%3A30px%200%2015px%7D%2A%20%3E%20body%7Bbackground%3Aurl%28%2F%2Fwww%2Egoogle%2Ecom%2Fimages%2Ferrors%2Frobot%2Epng%29%20100%25%205px%20no%2Drepeat%3Bpadding%2Dright%3A205px%7Dp%7Bmargin%3A11px%200%2022px%3Boverflow%3Ahidden%7Dins%7Bcolor%3A%23777%3Btext%2Ddecoration%3Anone%7Da%20img%7Bborder%3A0%7D%40media%20screen%20and%20%28max%2Dwidth%3A772px%29%7Bbody%7Bbackground%3Anone%3Bmargin%2Dtop%3A0%3Bmax%2Dwidth%3Anone%3Bpadding%2Dright%3A0%7D%7D%23logo%7Bbackground%3Aurl%28%2F%2Fwww%2Egoogle%2Ecom%2Fimages%2Fbranding%2Fgooglelogo%2F1x%2Fgooglelogo%5Fcolor%5F150x54dp%2Epng%29%20no%2Drepeat%3Bmargin%2Dleft%3A%2D5px%7D%40media%20only%20screen%20and%20%28min%2Dresolution%3A192dpi%29%7B%23logo%7Bbackground%3Aurl%28%2F%2Fwww%2Egoogle%2Ecom%2Fimages%2Fbranding%2Fgooglelogo%2F2x%2Fgooglelogo%5Fcolor%5F150x54dp%2Epng%29%20no%2Drepeat%200%25%200%25%2F100%25%20100%25%3B%2Dmoz%2Dborder%2Dimage%3Aurl%28%2F%2Fwww%2Egoogle%2Ecom%2Fimages%2Fbranding%2Fgooglelogo%2F2x%2Fgooglelogo%5Fcolor%5F150x54dp%2Epng%29%200%7D%7D%40media%20only%20screen%20and%20%28%2Dwebkit%2Dmin%2Ddevice%2Dpixel%2Dratio%3A2%29%7B%23logo%7Bbackground%3Aurl%28%2F%2Fwww%2Egoogle%2Ecom%2Fimages%2Fbranding%2Fgooglelogo%2F2x%2Fgooglelogo%5Fcolor%5F150x54dp%2Epng%29%20no%2Drepeat%3B%2Dwebkit%2Dbackground%2Dsize%3A100%25%20100%25%7D%7D%23logo%7Bdisplay%3Ainline%2Dblock%3Bheight%3A54px%3Bwidth%3A150px%7D%0A%20%20%3C%2Fstyle%3E%0A%20%20%3Ca%20href%3D%2F%2Fwww%2Egoogle%2Ecom%2F%3E%3Cspan%20id%3Dlogo%20aria%2Dlabel%3DGoogle%3E%3C%2Fspan%3E%3C%2Fa%3E%0A%20%20%3Cp%3E%3Cb%3E404%2E%3C%2Fb%3E%20%3Cins%3EThat%E2%80%99s%20an%20error%2E%3C%2Fins%3E%0A%20%20%3Cp%3EThe%20requested%20URL%20%3Ccode%3E%2F%3C%2Fcode%3E%20was%20not%20found%20on%20this%20server%2E%20%20%3Cins%3EThat%E2%80%99s%20all%20we%20know%2E%3C%2Fins%3E%0A" rel="preconnect" crossorigin>
  <style type="text/css">@font-face {
font-family: 'Crimson Pro';
font-style: normal;
font-weight: 400;
font-display: swap;
src: url(data:font/ttf;base64,AAEAAAAQAQAABAAAR0RFRkNHQhMAAAJAAAAA2EdQT1PhDnNUAABB2AAAdRxHU1VCxMe6OAAAC8AAAAfqT1MvMjt+Xm4AAAHgAAAAYFNUQVTnhswUAAABmAAAAEhjbWFwT9fvtwAAE6wAAAgyZ2FzcAAAABAAAAEUAAAACGdseWbYq+wPAAC29AAAxJxoZWFkGG9KSgAAAWAAAAA2aGhlYQfIBJUAAAE8AAAAJGhtdHiz9KKrAAAb4AAADA5sb2NhY44ziAAABXwAAAZCbWF4cAMxBLwAAAEcAAAAIG5hbWU1UVvbAAADGAAAAmJwb3N0GtnQSAAAJ/AAABnncHJlcGgGjIUAAAEMAAAAB7gB/4WwBI0AAAEAAf//AA8AAQAAAyAETAAHAG4ABQABAAAAAAAAAAAAAAAAAAQAAQABAAADlv8kAAAEtf+S/dQEnQABAAAAAAAAAAAAAAAAAAAC5wABAAAAAQDFVPgNQF8PPPUAAwQAAAAAANgJvHoAAAAA3R9JVv+S/uIEnQPYAAAABgACAAAAAAAAAAEAAQAIAAIAAAAUAAIAAAAkAAJ3Z2h0AQAAAGl0YWwBEQABABQABAADAAEAAgESAAAAAAABAAAAAwAAAAIBAwGQAAACvAAAAAQCDwGQAAUAAAKaAmYAAABNApoCZgAAAWYAMgECAAAAAAAAAAAAAAAAoAAA/1AA4EsAAAAAAAAAAEZvSGEAwAAA+wIDlv8kAAAD7gEnIAABkwAAAAABrgJLAAAAIAADAAEAAgBWAAAAAAAAABIAAAAAAAEAAgAAACgAAAAMAAIABAKxArkAAAK7AswACQLmAwAAGwMPAx4ANgABAAwCzgLPAtAC0QLTAtQDAgMDAwQDBQMHAwgAAgAVAAEAeAABAHoAoAABAKIAtQABALcBEQABARMBLgABATEBSwABAU0BUgABAVQBZQABAWcBjQABAY8BogABAaQB2AABAdoB2gABAdwB3AACAd4B4AACAmICYgABAqQCpAABAqYCsAABArECuQADArsC2AADAuYDCwADAw8DHgADAAAADACWAAMAAQQJAAAAsgEaAAMAAQQJAAEAFgEEAAMAAQQJAAIADgD2AAMAAQQJAAMAOgC8AAMAAQQJAAQAJgCWAAMAAQQJAAUAGgB8AAMAAQQJAAYAJABYAAMAAQQJAA4ANgAiAAMAAQQJAQAADAAWAAMAAQQJAQMADgD2AAMAAQQJAREADAAKAAMAAQQJARIACgAAAFIAbwBtAGEAbgBJAHQAYQBsAGkAYwBXAGUAaQBnAGgAdABoAHQAdABwAHMAOgAvAC8AcwBjAHIAaQBwAHQAcwAuAHMAaQBsAC4AbwByAGcALwBPAEYATABDAHIAaQBtAHMAbwBuAFAAcgBvAC0AUgBlAGcAdQBsAGEAcgBWAGUAcgBzAGkAbwBuACAAMQAuADAAMAAzAEMAcgBpAG0AcwBvAG4AIABQAHIAbwAgAFIAZQBnAHUAbABhAHIAMQAuADAAMAAzADsARgBvAEgAYQA7AEMAcgBpAG0AcwBvAG4AUAByAG8ALQBSAGUAZwB1AGwAYQByAFIAZQBnAHUAbABhAHIAQwByAGkAbQBzAG8AbgAgAFAAcgBvAEMAbwBwAHkAcgBpAGcAaAB0ACAAMgAwADEAOAAgAFQAaABlACAAQwByAGkAbQBzAG8AbgAgAFAAcgBvACAAUAByAG8AagBlAGMAdAAgAEEAdQB0AGgAbwByAHMAIAAoAGgAdAB0AHAAcwA6AC8ALwBnAGkAdABoAHUAYgAuAGMAbwBtAC8ARgBvAG4AdABoAGEAdQBzAGUAbgAvAEMAcgBpAG0AcwBvAG4AUAByAG8AKQAAAAAAFQBOAFkAZABvAH0AiACTAJ4AqQC0AMIAzQDYAOMA7gD5AQQBDwEaASUBMAE7AZMBngGpAbQCPAJHApYCzALXAuIC7QL7AwYDEQNQA1wDZwNyA30DiAOTA6MECwQWBCEELAQ6BEUEUAReBGkEdAR/BIoElQSgBKsEtgTBBMwE1wTiBO0FaAVzBcwGEgYdBigGMwY+BkkGVAa7BsYG0QbcBucHEwcfBysHNwdDB08HWwdnB3MHfweLB5cHowevB7sIAQgNCEIITgicCKcI4gjuCPoJBQkQCRsJJgk2CUEJTQmaCaUJ6gn2CgEKDAoXCiIKLQqJCpkKpAqvCuAK6wr2CwELDAsaCyULMAs7C0YLUQtcC2cLcgt9C4gLzwvaC+UL8Av7DAYMEQwcDCcMMgw9DIsMlgykDK8MugzFDNANVQ2YDdwOLw6FDpAOmw6mDrEOvA7HDtIPFA8fDy4POQ9ED08PWg9lD3APew+JD/QQKxB0EH8QihCVEKAQqxC2EPcRAhENERgRIxEu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AAIADAAGAdwAAgFUAdsAAgE9AAEAAQEwAAEAAAABAAgAAQCkAAoAAQAAAAEACAABAAb/9gACAAEB8gH7AAAAAQAAAAEACAABAD7/9gAGAAAAAgAmAAoAAwABABIAAQAuAAAAAQAAABsAAgABAgYCDwAAAAMAAQAcAAEAEgAAAAEAAAAaAAIAAQIQAhkAAAABAAECJAABAAAAAQAIAAEABv/vAAEAAQI1AAEAAAABAAgAAQAUAB4AAQAAAAEACAABAAYAKAACAAEB6AHxAAAAAQAAAAEACAABAAYACAABAAEBPQABAAAAAQAIAAIADgAEALIAvAGfAagAAQAEALAAuwGdAacAAQAAAAEACAABACQABgABAAAAAQAIAAEAFgAHAAYAAAABAAgAAQAIAAEADgABAAECMQACABYABgABAGYAAQABAGYAAQAAAA0AAQFUAAEAAQFUAAEAAAAMAAQAAAABAAgAAQA2AAQALAAiABgADgABAAQB2gACAU4AAQAEAeAAAgFOAAEABADsAAIAYgABAAQB3wACAGIAAQAEAFEAUwE9AT8ABAAAAAEACAABAJYABAB0AFIAMAAOAAQAHAAWABAACgMaAAIC9QMZAAIC/QMYAAIC6wMXAAIC7AAEABwAFgAQAAoDHgACAvUDHQACAv0DHAACAusDGwACAuwABAAcABYAEAAKAxIAAgLBAxEAAgLJAxAAAgK2Aw8AAgK3AAQAHAAWABAACgMWAAICwQMVAAICyQMUAAICtgMTAAICtwABAAQCuwK+Au8C8gAEAAAAAQAIAAEA/gAOAOwA4gDYAM4AxACqAJAAfgB0AGoAYABWADwAIgADABQADgAIAvsAAgLrAvoAAgLmAvwAAgLsAAMAFAAOAAgC+AACAvkC9gACAuYC9wACAuwAAQAEAvQAAgLsAAEABALxAAIC6QABAAQC7QACAukAAQAEAuoAAgL5AAIADAAGAugAAgL5AucAAgLsAAMAFAAOAAgCxwACArYCxgACArECyAACArcAAwAUAA4ACALEAAICxQLCAAICsQLDAAICtwABAAQCwAACArcAAQAEAr0AAgK0AAEABAK4AAICtAABAAQCtQACAsUAAgAMAAYCswACAsUCsgACArcAAQAOArECtAK3ArwCvwLBAsUC5gLpAuwC8ALzAvUC+QABAAAAAQAIAAIBoAAu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AQIAAwDvABcBAwAfAQsAIwEPACQBEAAgAQwAKAETACkBFAA/ASoALwEaADoBJQBCAS0AMAEbAEgBNABGATIASgE2AEkBNQBPATsATQE5AGEBTQBfAUsAVAFAAGABTABaAT4AUgFKAGMBUABlAVIBUwBoAVUAagFXAGkBVgBrAVgAbwFcAHQBYAB2AWMAdQFiAWEAeQFmAJUBggB/AWwAkwGAAJ8BjACkAZEApgGTAKUBkgCsAZkAsQGeALABnQCuAZsAuwGnALoBpgC5AaUA1AHBANABvQDBAa4A0wHAAM4BuwDSAb8A2QHGAN8BzADgAOgB1QDqAdcA6QHWAI0BegDIAbUAJgAsARcAZwBtAVoAcwB6AWcARwEzAJgBhQAZAQUAHAEIAJoBhwAPAPsAFQEBADgBIwA+ASkAVwFCAF4BSQCGAXMAlAGBAKcBlACpAZYAwwGwAM8BvACyAZ8AvAGoABEA/QCIAXUAngGLAIkBdgDlAdICqwKoAqcCpgKtAqwC3QLbArACqQKuAqoCrwLaAt8C5ALjAuUC4QK2ArcCuwLBAsUCvgK0ArECyQK/ArkCvAAiAQ4AKgEVACsBFgBBASwAQAErADEBHABLATcAUAE8AE4BOgBZAUQAbAFZAG4BWwBxAV4AdwFkAHgBZQB7AWgAnAGJAJ0BigCXAYQAlgGDAKgBlQCqAZcAswGgALQBoQCtAZoArwGcALUBogC9AaoAvgGrANUBwgDRAb4A2wHIANgBxQDaAccA4QHOAOsB2AASAP4AFAEAAAoA9gAMAPgADQD5AA4A+gALAPcABADwAAYA8gAHAPMACAD0AAUA8QA7ASYAPQEoAEMBLgAzAR4ANQEgADYBIQA3ASIANAEfAF0BSABbAUYAigF3AIwBeQCBAW4AgwFwAIQBcQCFAXIAggFvAI4BewCQAX0AkQF+AJIBfwCPAXwAxQGyAMcBtADJAbYAywG4AMwBuQDNAboAygG3AOMB0ADiAc8A5AHRAOYB0wJVAlcCWgJWAlsCQwJBAkICRAJLAkwCRwJJAkoCSAKhAqMCMgJlAmgCYgJjAmcCbQJmAm8CaQJqAm4ChgKJAosCdwJzAowCfwJ+AAACAAAzAkYAAQJGAAECRgABAkYAAQJGAAECRgABAkYAAQJGAAECRgABAkYAAQJGAAECRgABAkYAAQJGAAECRgABAkYAAQJGAAECRgABAkYAAQJGAAECRgABAkYAAQJGAAECRgABAkYAAQJGAAEDJP/xAyT/8QIwAC0CXAA0AlwANAJcADQCXAA0AlwANAJcADQCXAA0AqoALwS1AC8CqgAmAqoALwKqACYCqgAvAqoALwRcAC8CLAAuAiwALgIsAC4CLAAuAiwALgIsAC4CLAAuAiwALgIsAC4CLAAuAiwALgIsAC4CLAAuAiwALgIsAC4CLAAuAiwALgIsAC4CLAAuAiwALgIsAC4CLAAuAiwALgH6ADACiAAzAogAMwKIADMCiAAzAogAMwKIADMCiAAzAqAALgKgACUCoAAuAqAALgKgAC4BNgAvAmwALwE2AC8BNv/2ATb/8gE2//IBNv/7ATYABQE2AAUBNgAvATYALwE2ABoBNgAvATb/9gE2AAwBNgArATb/0wE2/7MBNv+zAkwALwJMAC8B/wAwAzAAMAH/ADAB/wAwAf8AMAH/ADAB/wAwAvwAMAH/ADAB/wAYA1IAKANSACgCogAvA9MALwKiAC8CogAvAqIALwKiAC8CogAvAqIALwOfAC8CogAvAqIALwKuADMCrgAzAq4AMwKuADMCrgAzAq4AMwKuADMCrgAzAq4AMwKuADMCrgAzAq4AMwKuADMCrgAzAq4AMwKuADMCrgAzAq4AMwKuADMCrgAzAq4AMwKuADMCrgAzAq4AMwKuADMCrgAzAq4AMwKuADMCrgAzAq4AMwKuADMCrgAzAq4AMwKuADMDlQA0AgIALwIBAC4CrgAzAjcALwI3AC8CNwAvAjcALwI3AC8CNwAvAjcALwI3AC8B3wA2Ad8ANgHfADYB3wA2Ad8ANgHfADYB3wA2Ad8ANgHfADYB3wA2Ad8ANgKxACMCiQA2Ai0AEAItABACLQAQAi0AEAItABACLQAQAi0AEAKYACwCmAAsApgALAKYACwCmAAsApgALAKYACwCmAAsApgALAKYACwCmAAsApgALAKYACwCmAAsApgALAKYACwCmAAsApgALAKYACwCmAAsApgALAKYACwCmAAsAkkAAQOtAAcDrQAHA60ABwOtAAcDrQAHAkYADwIdAAACHQAAAh0AAAIdAAACHQAAAh0AAAIdAAACHQAAAh0AAAIdAAACFQAwAhUAMAIVADACFQAwAhUAMAJsAC8B2gA7AdoAOwHaADsB2gA7AdoAOwHaADsB2gA7AdoAOwHaADsB2gA7AdoAOwHaADsB2gA7AdoAOwHaADAB2gA7AdoAOwHaADsB2gA7AdoAOwHaADsB2gA7AdoAOwHaADsB2gA7AdoAOwK6ADwCugA8Ag4AAgGpACkBqQApAakAKQGpACkBqQApAakAKQGpACkCGwAoAfQAKQIbACgCGwAoAhsAKAIbACgDzQAoAcIAKgHCACoBwgAqAcIAKgHCACoBwgAqAcIAKgHCACoBwgAqAcIAKgHCACoBwgAqAcIAKgHCACoBwgAqAcIAKgHCACoBwgAqAcIAKgHCACoBwgAqAcIAKgHCACoBxwAjAS8AFwHvACEB7wAhAe8AIQHvACEB7wAhAe8AIQHvACECJgAQAiYAEAImABACJv/dAiYAEAEMABYBDAAWAQwAFgEM//8BDP/7AQz/zwEMAAQBDAAEAQwAFgEMABYBDP/mAQwAFgEM//8CCQAWAQz/9wENABYBDP/cAP3/+gD9//oA/f/6AekAEAHpABAB6QAYAQ0AEAENABABDQAQAQ0AEAEhABABDQAQAgoAEAEN//gBDQALAzcAGQM3ABkCJgAYAiYAGAImAAECJgAYAiYAGAImABgCJgAYAhcAGAMjABgCJgAYAiYAGAH8ACkB/AApAfwAKQH8ACkB/AApAfwAKQH8ACkB/AApAfwAKQH8ACkB/AApAfwAKQH8ACkB/AApAfwAKQH8ACkB/AApAfwAKQH8ACkB/AApAfwAKQH8ACkB/AApAfwAKQH8ACkB/AApAfwAKQH8ACkB/AApAfwAKQH8ACkB/AApAfwAKQH8ACkDEwAqAhkAFwIMAAQCDAAqAWwAGQFsABkBbAAZAWwAGQFs//QBbAAZAWwAGQFs//kBkgA2AZIANgGSADYBkgA2AZIANgGSADYBkgA2AZIANgGSADYBkgA2AZIANgI6ABYBUwASAVMAEgFTABIBUwASAVMAEgFTABIBUwASAVMAEgIfABACHwAQAh8AEAIfABACHwAQAh8AEAIfABACHwAQAh8AEAIfABACHwAQAh8AEAIfABACHwAQAh8AEAIfABACHwAQAh8AEAIfABACHwAQAh8AEAIfABACHwAQAdj//ALxAAQC8QAEAvEABALxAAQC8QAEAeEAGQHY//wB2P/8Adj//AHY//wB2P/8Adj//AHY//wB2P/8Adj//AHY//wBsgAtAbIALQGyAC0BsgAtAbIALQD9/68CCQAWAiMAFwIsABcCIwAXAiwAFwJYAC8B9wAWAYwALwGkACECgwAIAe4ACgLGAA4CJAAVAn0AEAJDADcBVAAuAegAGwHmADYCCwAoAeMAMAIIAEEB2AAgAicARAIIADcCHAAsAhwAgQIcADECHABMAhwAMAIcAFACHABHAhwAOQIcAD8CHAA8AZAAJAGQAFoBkAAlAZAAOgGQACQBkAA6AZAAMQGQADIBkAArAZAAMQGQACQBkABaAZAAJQGQADoBkAAkAZAAOgGQADEBkAAyAZAAKwGQADEBkAAkAZAAWgGQACUBkAA6AZAAJAGQADoBkAAxAZAAMgGQACsBkAAxAZAAJAGQAFoBkAAlAZAAOgGQACQBkAA6AZAAMQGQADIBkAArAZAAMQBl/5IDhQBaA4UAWgOFADoA6gA2AOoAHADqADYA6gAcAo4ANgEKAEYBCgBGAWYADgFmADAA9gA8AaQANwG4ACgCDwAgAW4AFAFu/+wCWAD2AlgA9gFoAGQBaAAAAXEARgFxADcBRQBpAUQALQF1AFABdQBQAfQAAAPoAAACWAAyA+gAAAF1AFABlAATAPQAIQGnACEBrAA3AawAIQD0ADcA9AAhAi0AUAItAEEBdQBQAXUAQQGjADsA6gA7AhwArAIcAKsCHAAAADIAAADqAAAAwAAAAMAAAACgAAAAAAAAAMAAAAJcADQBqQApAlwANAIcABgB3wA2AhsAKAKOABcBe//vAfoAHAKIADMCTAAcAeoAGgH3AAgCrwAsAqIAHQJIAB0CSAAdAgIAHAHrADQB6gAaA60ABwIdAAACHADPAhwAjQIcAI0CHAA4AhwANQIcAD4CHAA1AhwANQIcADUCHAA1AhwANQIcADUCHAA1AhwANQIcADUCHAA1AhwANQIcAC4C9QAoAhwABwFd/+8CxgAOAoMACAJ5AC0B7gAKAjAADQIkABUCCgAxAvQAIwRgACMCHAAuA7YANQO2ACYDfABkA4kAPQLJACUCFgAhAdgAOgMqADMDKgAzBB8AFgFpACMA6gA7AaMAOwESAGkBEgBpAcwAKwHIABoBzAArBDIALwN+ADICWAD4AlgA+AJYAN4CWACdAlgAjAJYARgCWADJAlgBLAJYARgCWAERAlgBEQAAAKoAAACqAAAAnQAAAPcAAACdAAAAjAAAARgAAADwAAAA3gAAAREAAAChAAAAoQAAAKEAAAClAAAAyQAAAMkAAACCAAAAgQAAAIEAAACBAAAAnQAAAJ0AAACdAAAAnQAAANMAAAB1AAAApQAAAPgAAAFlAAAA9wAAAKoAAADfAAAAuQAAAJAAAAClAAAAnQAAAFkAAP/XAAAAygAAAG4CWAEYAlgApQJYAKECWAC5AlgAoQJYAKoCWAD3AlgAjAJYAN4CWACdAlgAkAJYAMkCWACCAAAAlgCWAIkA9wCJAKsBFwDwAN4AgwCDAIMAhwDJAMkAZACBAIEAgQCdAIkAiQCJANMAjACHAPgBZQD3AKoA3wC5AJAApQCdAGAAnQA+AO8BEQCfAKUApQClAJMAoQChAKEAkwCHAIcAhwCBAIMAgwCDAIEAAAAAAAIAAAAAAAD/nAAyAAAAAAAAAAAAAAAAAAAAAAAAAAADIAAAACQAyQECAQMBBAEFAQYBBwDHAQgBCQEKAQsBDAENAGIBDgEPAK0BEAERARIBEwBjARQArgCQARUAJQAmAP0A/wBkARYBFwEYACcBGQDpARoBGwEcAR0BHgAoAGUBHwEgASEAyAEiASMBJAElASYBJwDKASgBKQDLASoBKwEsAS0BLgEvATAAKQAqAPgBMQEyATMBNAE1ACsBNgE3ATgBOQAsAToAzAE7ATwAzQE9AM4BPgD6AT8AzwFAAUEBQgFDAUQALQFFAC4BRgAvAUcBSAFJAUoBSwFMAU0BTgDiADABTwAxAVABUQFSAVMBVAFVAVYBVwFYAGYAMgDQAVkA0QFaAVsBXAFdAV4BXwBnAWABYQFiANMBYwFkAWUBZgFnAWgBaQFqAWsBbAFtAW4BbwCRAXAArwFxAXIBcwCwADMA7QA0ADUBdAF1AXYBdwF4AXkBegA2AXsBfADkAX0A+wF+AX8BgAGBAYIBgwGEADcBhQGGAYcBiAGJAYoAOADUAYsA1QGMAGgBjQDWAY4BjwGQAZEBkgGTAZQBlQGWAZcBmAGZAZoBmwGcADkAOgGdAZ4BnwGgADsAPADrAaEAuwGiAaMBpAGlAaYBpwA9AagA5gGpAaoBqwBEAGkBrAGtAa4BrwGwAbEAawGyAbMBtAG1AbYBtwBsAbgBuQBqAboBuwG8Ab0AbgG+AG0AoAG/AEUARgD+AQAAbwHAAcEBwgBHAOoBwwEBAcQBxQHGAEgAcAHHAcgByQByAcoBywHMAc0BzgHPAHMB0AHRAHEB0gHTAdQB1QHWAdcB2AHZAEkASgD5AdoB2wHcAd0B3gBLAd8B4AHhAeIATADXAHQB4wB2AeQAdwHlAeYB5wB1AegB6QHqAesB7AHtAE0B7gHvAE4B8AHxAE8B8gHzAfQB9QH2AfcB+ADjAFAB+QBRAfoB+wH8Af0B/gH/AgACAQICAHgAUgB5AgMAewIEAgUCBgIHAggCCQB8AgoCCwIMAHoCDQIOAg8CEAIRAhICEwIUAhUCFgIXAhgCGQChAhoAfQIbAhwCHQCxAFMA7gBUAFUCHgIfAiACIQIiAiMCJABWAiUCJgDlAicA/AIoAikCKgIrAiwAiQBXAi0CLgIvAjACMQIyAjMAWAB+AjQAgAI1AIECNgB/AjcCOAI5AjoCOwI8Aj0CPgI/AkACQQJCAkMCRAJFAFkAWgJGAkcCSAJJAFsAXADsAkoAugJLAkwCTQJOAk8CUABdAlEA5wJSAlMCVAJVAlYCVwDAAMECWAJZAJ0AngJaAlsCXAJdAJsAEwAUABUAFgAXABgAGQAaABsAHAJeAl8CYAJhAmICYwJkAmUCZgJnAmgCaQJqAmsCbAJtAm4CbwJwAnECcgJzAnQCdQJ2AncCeAJ5AnoCewJ8An0CfgJ/AoACgQKCAoMChAKFAoYChwKIAokCigKLAowCjQKOAo8AvAD0APUA9gARAA8AHQAeAKsABACjACIAogDDAIcADQAGABIAPwKQApEACwAMAF4AYAA+AEAAEAKSALIAswKTApQClQBCAMQAxQC0ALUAtgC3AKkAqgC+AL8ABQAKApYClwKYApkCmgADApsCnAKdAp4CnwCEAqAAvQAHAqECogCmAPcCowKkAqUCpgKnAqgCqQKqAqsCrACFAq0AlgKuAq8CsAAOAO8A8AC4ACAAjwAhAB8AlQCUAJMApwBhAKQAQQCSArEAnAKyArMAmgCZAKUCtACYAAgAxgC5ArUCtgK3ACMACQCIAIYAiwCKAIwAgwK4ArkAXwDoAIICugDCArsCvAK9Ar4CvwLAAsECwgLDAsQCxQLGAscCyALJAsoCywLMAs0CzgLPAtAC0QLSAtMC1ALVAtYC1wLYAtkC2gLbAtwC3QLeAt8C4ALhAuIC4wLkAuUC5gLnAugC6QLqAusC7ALtAu4C7wCNANsA4QDeANgAjgDcAEMA3wDaAOAA3QDZAvAC8QLyAvMC9AL1AvYC9wL4AvkC+gL7AvwC/QL+Av8DAAMBAwIDAwMEAwUDBgMHAwgDCQMKAwsDDAMNAw4DDwMQAxEDEgMTAxQDFQMWAxcDGAMZAxoDGwMcAx0DHgMfAyADIQMiAyMDJAMlAyYDJwMoAykGQWJyZXZlB3VuaTFFQUUHdW5pMUVCNgd1bmkxRUIwB3VuaTFFQjIHdW5pMUVCNAd1bmkxRUE0B3VuaTFFQUMHdW5pMUVBNgd1bmkxRUE4B3VuaTFFQUEHdW5pMDIwMAd1bmkwMjI2B3VuaTFFQTAHdW5pMUVBMgd1bmkwMjAyB0FtYWNyb24HQW9nb25lawpBcmluZ2FjdXRlB0FFYWN1dGUHdW5pMUUwOAtDY2lyY3VtZmxleApDZG90YWNjZW50B3VuaTAxQzQGRGNhcm9uBkRjcm9hdAd1bmkxRTBDB3VuaTFFMEUHdW5pMDFDNQZFYnJldmUGRWNhcm9uB3VuaTFFMUMHdW5pMUVCRQd1bmkxRUM2B3VuaTFFQzAHdW5pMUVDMgd1bmkxRUM0B3VuaTAyMDQKRWRvdGFjY2VudAd1bmkxRUI4B3VuaTFFQkEHdW5pMDIwNgdFbWFjcm9uB3VuaTFFMTYHdW5pMUUxNAdFb2dvbmVrB3VuaTFFQkMGR2Nhcm9uC0djaXJjdW1mbGV4B3VuaTAxMjIKR2RvdGFjY2VudAd1bmkxRTIwBEhiYXIHdW5pMUUyQQtIY2lyY3VtZmxleAd1bmkxRTI0AklKBklicmV2ZQd1bmkwMUNGB3VuaTAyMDgHdW5pMUUyRQd1bmkxRUNBB3VuaTFFQzgHdW5pMDIwQQdJbWFjcm9uB0lvZ29uZWsGSXRpbGRlC0pjaXJjdW1mbGV4B3VuaTAxMzYHdW5pMDFDNwZMYWN1dGUGTGNhcm9uB3VuaTAxM0IETGRvdAd1bmkxRTM2B3VuaTAxQzgHdW5pMUUzQQd1bmkxRTQyB3VuaTAxQ0EGTmFjdXRlBk5jYXJvbgd1bmkwMTQ1B3VuaTFFNDQHdW5pMUU0NgNFbmcHdW5pMDFDQgd1bmkxRTQ4Bk9icmV2ZQd1bmkxRUQwB3VuaTFFRDgHdW5pMUVEMgd1bmkxRUQ0B3VuaTFFRDYHdW5pMDIwQwd1bmkwMjJBB3VuaTAyMzAHdW5pMUVDQwd1bmkxRUNFBU9ob3JuB3VuaTFFREEHdW5pMUVFMgd1bmkxRURDB3VuaTFFREUHdW5pMUVFMA1PaHVuZ2FydW1sYXV0B3VuaTAyMEUHT21hY3Jvbgd1bmkxRTUyB3VuaTFFNTAHdW5pMDFFQQtPc2xhc2hhY3V0ZQd1bmkxRTRDB3VuaTFFNEUHdW5pMDIyQwZSYWN1dGUGUmNhcm9uB3VuaTAxNTYHdW5pMDIxMAd1bmkxRTVBB3VuaTAyMTIHdW5pMUU1RQZTYWN1dGUHdW5pMUU2NAd1bmkxRTY2C1NjaXJjdW1mbGV4B3VuaTAyMTgHdW5pMUU2MAd1bmkxRTYyB3VuaTFFNjgHdW5pMUU5RQd1bmkwMThGBFRiYXIGVGNhcm9uB3VuaTAxNjIHdW5pMDIxQQd1bmkxRTZDB3VuaTFFNkUGVWJyZXZlB3VuaTAyMTQHdW5pMUVFNAd1bmkxRUU2BVVob3JuB3VuaTFFRTgHdW5pMUVGMAd1bmkxRUVBB3VuaTFFRUMHdW5pMUVFRQ1VaHVuZ2FydW1sYXV0B3VuaTAyMTYHVW1hY3Jvbgd1bmkxRTdBB1VvZ29uZWsFVXJpbmcGVXRpbGRlB3VuaTFFNzgGV2FjdXRlC1djaXJjdW1mbGV4CVdkaWVyZXNpcwZXZ3JhdmULWWNpcmN1bWZsZXgHdW5pMUU4RQd1bmkxRUY0BllncmF2ZQd1bmkxRUY2B3VuaTAyMzIHdW5pMUVGOAZaYWN1dGUKWmRvdGFjY2VudAd1bmkxRTkyEElhY3V0ZV9KLmxvY2xOTEQGYWJyZXZlB3VuaTFFQUYHdW5pMUVCNwd1bmkxRUIxB3VuaTFFQjMHdW5pMUVCNQd1bmkxRUE1B3VuaTFFQUQHdW5pMUVBNwd1bmkxRUE5B3VuaTFFQUIHdW5pMDIwMQd1bmkwMjI3B3VuaTFFQTEHdW5pMUVBMwd1bmkwMjAzB2FtYWNyb24HYW9nb25lawphcmluZ2FjdXRlB2FlYWN1dGUHdW5pMUUwOQtjY2lyY3VtZmxleApjZG90YWNjZW50BmRjYXJvbgd1bmkxRTBEB3VuaTFFMEYHdW5pMDFDNgZlYnJldmUGZWNhcm9uB3VuaTFFMUQHdW5pMUVCRgd1bmkxRUM3B3VuaTFFQzEHdW5pMUVDMwd1bmkxRUM1B3VuaTAyMDUKZWRvdGFjY2VudAd1bmkxRUI5B3VuaTFFQkIHdW5pMDIwNwdlbWFjcm9uB3VuaTFFMTcHdW5pMUUxNQdlb2dvbmVrB3VuaTFFQkQHdW5pMDI1OQZnY2Fyb24LZ2NpcmN1bWZsZXgHdW5pMDEyMwpnZG90YWNjZW50B3VuaTFFMjEEaGJhcgd1bmkxRTJCC2hjaXJjdW1mbGV4B3VuaTFFMjUGaWJyZXZlB3VuaTAyMDkHdW5pMUUyRglpLmxvY2xUUksHdW5pMUVDQgd1bmkxRUM5B3VuaTAyMEICaWoHaW1hY3Jvbgdpb2dvbmVrBml0aWxkZQd1bmkwMjM3C2pjaXJjdW1mbGV4B3VuaTAxMzcMa2dyZWVubGFuZGljBmxhY3V0ZQZsY2Fyb24HdW5pMDEzQwRsZG90B3VuaTFFMzcHdW5pMDFDOQd1bmkxRTNCB3VuaTFFNDMGbmFjdXRlC25hcG9zdHJvcGhlBm5jYXJvbgd1bmkwMTQ2B3VuaTFFNDUHdW5pMUU0NwNlbmcHdW5pMDFDQwd1bmkxRTQ5Bm9icmV2ZQd1bmkxRUQxB3VuaTFFRDkHdW5pMUVEMwd1bmkxRUQ1B3VuaTFFRDcHdW5pMDIwRAd1bmkwMjJCB3VuaTAyMzEHdW5pMUVDRAd1bmkxRUNGBW9ob3JuB3VuaTFFREIHdW5pMUVFMwd1bmkxRUREB3VuaTFFREYHdW5pMUVFMQ1vaHVuZ2FydW1sYXV0B3VuaTAyMEYHb21hY3Jvbgd1bmkxRTUzB3VuaTFFNTEHdW5pMDFFQgtvc2xhc2hhY3V0ZQd1bmkxRTREB3VuaTFFNEYHdW5pMDIyRAZyYWN1dGUGcmNhcm9uB3VuaTAxNTcHdW5pMDIxMQd1bmkxRTVCB3VuaTAyMTMHdW5pMUU1RgZzYWN1dGUHdW5pMUU2NQd1bmkxRTY3C3NjaXJjdW1mbGV4B3VuaTAyMTkHdW5pMUU2MQd1bmkxRTYzB3VuaTFFNjkEdGJhcgZ0Y2Fyb24HdW5pMDE2Mwd1bmkwMjFCB3VuaTFFOTcHdW5pMUU2RAd1bmkxRTZGBnVicmV2ZQd1bmkwMjE1B3VuaTFFRTUHdW5pMUVFNwV1aG9ybgd1bmkxRUU5B3VuaTFFRjEHdW5pMUVFQgd1bmkxRUVEB3VuaTFFRUYNdWh1bmdhcnVtbGF1dAd1bmkwMjE3B3VtYWNyb24HdW5pMUU3Qgd1b2dvbmVrBXVyaW5nBnV0aWxkZQd1bmkxRTc5BndhY3V0ZQt3Y2lyY3VtZmxleAl3ZGllcmVzaXMGd2dyYXZlC3ljaXJjdW1mbGV4B3VuaTFFOEYHdW5pMUVGNQZ5Z3JhdmUHdW5pMUVGNwd1bmkwMjMzB3VuaTFFRjkGemFjdXRlCnpkb3RhY2NlbnQHdW5pMUU5Mwt1bmkwMjM3LmFsdBBpYWN1dGVfai5sb2NsTkxEA2ZfaQNmX2wLSV9KLmxvY2xOTEQLaV9qLmxvY2xOTEQHdW5pMDM5NAVTaWdtYQd1bmkwM0E5B3VuaTAzQkMHemVyby50ZgZvbmUudGYGdHdvLnRmCHRocmVlLnRmB2ZvdXIudGYHZml2ZS50ZgZzaXgudGYIc2V2ZW4udGYIZWlnaHQudGYHbmluZS50Zgd1bmkyMDgwB3VuaTIwODEHdW5pMjA4Mgd1bmkyMDgzB3VuaTIwODQHdW5pMjA4NQd1bmkyMDg2B3VuaTIwODcHdW5pMjA4OAd1bmkyMDg5CXplcm8uZG5vbQhvbmUuZG5vbQh0d28uZG5vbQp0aHJlZS5kbm9tCWZvdXIuZG5vbQlmaXZlLmRub20Ic2l4LmRub20Kc2V2ZW4uZG5vbQplaWdodC5kbm9tCW5pbmUuZG5vbQl6ZXJvLm51bXIIb25lLm51bXIIdHdvLm51bXIKdGhyZWUubnVtcglmb3VyLm51bXIJZml2ZS5udW1yCHNpeC5udW1yCnNldmVuLm51bXIKZWlnaHQubnVtcgluaW5lLm51bXIHdW5pMjA3MAd1bmkwMEI5B3VuaTAwQjIHdW5pMDBCMwd1bmkyMDc0B3VuaTIwNzUHdW5pMjA3Ngd1bmkyMDc3B3VuaTIwNzgHdW5pMjA3ORtwZXJpb2RjZW50ZXJlZC5sb2NsQ0FULmNhc2UWcGVyaW9kY2VudGVyZWQubG9jbENBVAd1bmkwMEFECmZpZ3VyZWRhc2gHdW5pMjAxNQd1bmkyMDEwB3VuaTI3RTgHdW5pMjdFOQd1bmkyMDA3B3VuaTIwMEEHdW5pMjAwOAd1bmkwMEEwB3VuaTIwMDkHdW5pMjAwQgJDUgd1bmkyMEI1DWNvbG9ubW9uZXRhcnkEZG9uZwRFdXJvB3VuaTIwQjIHdW5pMjBBRARsaXJhB3VuaTIwQkEHdW5pMjBCQwd1bmkyMEE2BnBlc2V0YQd1bmkyMEIxB3VuaTIwQkQHdW5pMjBCOQd1bmkyMEE5B3VuaTIyMTkHdW5pMjA1Mgd1bmkyMjE1CGVtcHR5c2V0B3VuaTIxMjYHdW5pMjIwNgd1bmkwMEI1B3VuaTI2MTkHdW5pMjc2Nwd1bmlGOEZGBm1pbnV0ZQZzZWNvbmQHdW5pMjExMwd1bmkyMTE2CWVzdGltYXRlZAd1bmkwMkJDB3VuaTAyQkIHdW5pMDJCQQd1bmkwMkM5B3VuaTAyQ0IHdW5pMDJCOQd1bmkwMkJGB3VuaTAyQkUHdW5pMDJDQQd1bmkwMkNDB3VuaTAyQzgHdW5pMDMwOAt1bmkwMzA4MDMwMQt1bmkwMzA4MDMwNAd1bmkwMzA3C3VuaTAzMDcwMzA0CWdyYXZlY29tYglhY3V0ZWNvbWILdW5pMDMwMTAzMDcHdW5pMDMwQgt1bmkwMzBDLmFsdAd1bmkwMzAyB3VuaTAzMEMLdW5pMDMwQzAzMDcHdW5pMDMwNgd1bmkwMzBBC3VuaTAzMEEwMzAxCXRpbGRlY29tYgt1bmkwMzAzMDMwOBN0aWxkZWNvbWJfYWN1dGVjb21iC3VuaTAzMDMwMzA0B3VuaTAzMDQLdW5pMDMwNDAzMDgLdW5pMDMwNDAzMDALdW5pMDMwNDAzMDENaG9va2Fib3ZlY29tYgd1bmkwMzBGB3VuaTAzMTEHdW5pMDMxMgd1bmkwMzFCDGRvdGJlbG93Y29tYgd1bmkwMzI0B3VuaTAzMjYHdW5pMDMyNwd1bmkwMzI4B3VuaTAzMkUHdW5pMDMzMQd1bmkwMzM1B3VuaTAzMzYHdW5pMDMzNwd1bmkwMzM4DHVuaTAzMDguY2FzZRB1bmkwMzA4MDMwMS5jYXNlEHVuaTAzMDgwMzA0LmNhc2UMdW5pMDMwNy5jYXNlEHVuaTAzMDcwMzA0LmNhc2UOZ3JhdmVjb21iLmNhc2UOYWN1dGVjb21iLmNhc2UQdW5pMDMwMTAzMDcuY2FzZQx1bmkwMzBCLmNhc2UMdW5pMDMwMi5jYXNlDHVuaTAzMEMuY2FzZRB1bmkwMzBDMDMwNy5jYXNlDHVuaTAzMDYuY2FzZQx1bmkwMzBBLmNhc2UQdW5pMDMwQTAzMDEuY2FzZQ50aWxkZWNvbWIuY2FzZRB1bmkwMzAzMDMwOC5jYXNlGHRpbGRlY29tYl9hY3V0ZWNvbWIuY2FzZRB1bmkwMzAzMDMwNC5jYXNlDHVuaTAzMDQuY2FzZRB1bmkwMzA0MDMwOC5jYXNlEHVuaTAzMDQwMzAwLmNhc2UQdW5pMDMwNDAzMDEuY2FzZRJob29rYWJvdmVjb21iLmNhc2UMdW5pMDMwRi5jYXNlDHVuaTAzMTEuY2FzZQx1bmkwMzEyLmNhc2UMdW5pMDMxQi5jYXNlEWRvdGJlbG93Y29tYi5jYXNlDHVuaTAzMjQuY2FzZQx1bmkwMzI2LmNhc2UMdW5pMDMyNy5jYXNlDHVuaTAzMjguY2FzZQx1bmkwMzJFLmNhc2UMdW5pMDMzMS5jYXNlDHVuaTAzMzUuY2FzZQx1bmkwMzM3LmNhc2UMdW5pMDMzOC5jYXNlCXVuaTAzMDcuaQ11bmkwMzBDLmFsdC50CXVuaTAzMzUudAt1bmkwMzA2MDMwMQt1bmkwMzA2MDMwMAt1bmkwMzA2MDMwOQt1bmkwMzA2MDMwMwt1bmkwMzAyMDMwMQt1bmkwMzAyMDMwMAt1bmkwMzAyMDMwOQt1bmkwMzAyMDMwMxB1bmkwMzA2MDMwMS5jYXNlEHVuaTAzMDYwMzAwLmNhc2UQdW5pMDMwNjAzMDkuY2FzZRB1bmkwMzA2MDMwMy5jYXNlEHVuaTAzMDIwMzAxLmNhc2UQdW5pMDMwMjAzMDAuY2FzZRB1bmkwMzAyMDMwOS5jYXNlEHVuaTAzMDIwMzAzLmNhc2UETlVMTAAAAQAAAAoAKABSAAJERkxUAA5sYXRuAA4ABAAAAAD//wADAAAAAQACAANrZXJuACRtYXJrABxta21rABQAAAACAAMABAAAAAIAAQACAAAAAQAAAAUiYARAAnoB6AAMAAYAEAABAAoAAQABAbYAXAABAJwADAAeGnIachpsGmwabBpsGmwabBpmGmwabBpsGmwabBpyAEoASgBEAEQARAA+AD4ARABEAEQARABEAEQARABKAAEBLANjAAEBLANtAAEBLANaAAEAHgKxArQCtgK3ArkCuwK8Ar4CvwLBAsUCyQLKAssCzALmAukC6wLsAu4C7wLwAvIC8wL1AvkC/QL+Av8DAABGAAAhjAAAIYwAACGMAAAhjAAAIYwAACGMAAAhjAAAIYwAACGMAAAhjAAAIYwAACGMAAAhjAAAIYwAACGMAAAhjAAAIYYAACGGAAAhhgAAIYwAACGMAAAhjAAAIYwAACGMAAAhjAAAIYwAACGMAAAhXAAAIVwAACFcAAAhXAAAIVwAACFcAAAhXAAAIVwAACFcAAAhXAAAIVwAACFcAAAhXAAAIVwAACFcAAAhXAAAIVYAACFcAAAhXAAAIVwAACFcAAAhXAAAIVwAACFcAAAhXAAAIVwAACFcAAAhjAAAIYwAACGMAAAhjAAAIYwAACGMAAAhjAAAIYwAACFcAAAhXAAAIVwAACFcAAAhXAAAIVwAACFcAAAhXAACAAQCsQK5AAACuwLMAAkC5gMAABsDDwMeADYABgAQAAEACgAAAAEAbAAiAAEAOgAMAAoYhBiEGIQYhBiEGIQYhBiEGIQYhAABAAoCzgLPAtAC0wLUAwIDAwMEAwcDCAAMAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAEADALOAs8C0ALRAtMC1AMCAwMDBAMFAwcDCAAFAAAAAQAIAAEBigA4AAIAQAAMAAIAHAAGAAIZwhm8ABAACgABAX3/JAABAYACnAACHHAAAAAKAAAAAQG9AksAAQACAd8B4ABSAAAffAAAH3wAAB98AAAffAAAH3wAAB98AAAffAAAH3wAAB98AAAffAAAH3wAAB98AAAffAAAH3wAAB98AAAffAAAH3YAAB92AAAfdgAAH3wAAB98AAAffAAAH3wAAB98AAAffAAAH3wAAB98AAEfagABH2oAAR9qAAEfagABH2oAAR9qAAAfTAAAH0wAAB9MAAAfTAAAH0wAAB9MAAAfTAAAH0wAAB9MAAAfTAAAH0wAAB9MAAAfTAAAH0wAAB9MAAAfTAAAH0YAAB9MAAAfTAAAH0wAAB9MAAAfTAAAH0wAAB9MAAAfTAAAH0wAAB9MAAEfagABH2oAAR9qAAEfagABH2oAAR9qAAAffAAAH3wAAB98AAAffAAAH3wAAB98AAAffAAAH3wAAB9MAAAfTAAAH0wAAB9MAAAfTAAAH0wAAB9MAAAfTAACAAgCsQK5AAACuwLMAAkCzgLRABsC0wLUAB8C5gMAACEDAgMFADwDBwMIAEADDwMeAEIABAAAAAEACAABHfwb2gAGHDgADAHZG8gAABvCG7wAAAAAG7YAABvCG7wAAAAAG7YAABvCG7wAAAAAG8gAABvCG7wAAAAAG7YAABuwG7wAAAAAG8gAABvCG7wAAAAAG8gAABvCG7wAAAAAG8gAABvCG7wAAAAAG6oAABvCG7wAAAAAG8gAABvCG7wAAAAAG6oAABuwG7wAAAAAG8gAABvCG7wAAAAAG8gAABvCG7wAAAAAG8gAABvCG7wAAAAAG7YAABvCG7wAAAAAG6QAABvCG7wAAAAAG6QAABvCG7wAAAAAG8gAABuwG7wAAAAAG7YAABvCG7wAAAAAG7YAABvCG7wAAAAAG7YAABvCG7wAAAAAG7YAABvCG7wAAAAAG8gAABvCAAAAAAAAG7YAABvCG7wAAAAAG8gAABvCG7wAAAAAG7YAABvCG7wAAAAAG54AABuYAAAAAAAAG5IAABuYAAAAAAAAG4wAABuGAAAAAAAAG4AAABt6AAAAAAAAG3QAABt6AAAAAAAAG24AABt6AAAAAAAAG4AAABt6AAAAAAAAG3QAABt6AAAAAAAAG24AABt6AAAAAAAAG2gAABt6AAAAAAAAG2IAABtcAAAbVhtQAAAAAAAAAAAbVhtQG2IAABtcAAAbVhtQG0oAABtcAAAbVhtQG2IAABtcAAAbVhtQG2IAABtEAAAbVhtQG2IAABtEAAAbVhtQAAAAAAAAAAAbVhtQGz4AABs4GzIAAAAAGywAABs4GzIAAAAAGywAABs4GzIAAAAAGyYAABs4GzIAAAAAGywAABs4GzIAAAAAGyYAABs4GzIAAAAAGz4AABs4GzIAAAAAGyYAABsgGzIAAAAAGz4AABs4GzIAAAAAGz4AABs4GzIAAAAAGz4AABs4GzIAAAAAGywAABs4GzIAAAAAGxoAABs4GzIAAAAAGxoAABs4GzIAAAAAGz4AABsgGzIAAAAAGywAABs4GzIAAAAAGywAABs4GzIAAAAAGywAABs4GzIAAAAAGywAABs4GzIAAAAAGz4AABs4GzIAAAAAGz4AABs4GzIAAAAAGz4AABs4AAAAAAAAGywAABs4GzIAAAAAGxQAABsOAAAAAAAAGwgAABsCAAAAAAAAGvwAABsCAAAAAAAAGvYAABsCAAAAAAAAGvYAABsCAAAAAAAAGwgAABrwAAAAAAAAGuoAABsCAAAAAAAAGvwAABsCAAAAAAAAGuQAABreAAAAABrYGuQAABreAAAAABrYGuQAABrSAAAAABrYGswAABreAAAAABrYGuQAABrSAAAAABrYGsYAABrAGroAAAAAAAAAABrAGroAAAAAGrQAABrAGroAAAAAGrQAABrAGroAAAAAGq4AABrAGroAAAAAGq4AABrAGroAAAAAGrQAABrAGroAAAAAGqgAABrAGroAAAAAGsYAABrAGroAAAAAGqgAABrAGroAAAAAGsYAABqiGroAAAAAGrQAABrAGroAAAAAGrQAABrAGroAAAAAGrQAABrAGroAAAAAGrQAABrAGroAAAAAGpwAAAAAAAAAAAAAGrQAABrAGroAAAAAGsYAAAAAAAAAAAAAGq4AAAAAAAAAAAAAGpYAABqQAAAAAAAAGpYAABqKAAAAAAAAGpwahBp+AAAAABp4AAAahBp+AAAAABp4GnIahBp+AAAAABp4GpwahBp+AAAAABp4GpwahBpsAAAAABp4GpwahBp+AAAAABp4GpwahBpsAAAAABp4AAAahAAAAAAAABp4GpwahBpsAAAAABp4GpwahBp+AAAAABp4GmYAABpgAAAAAAAAGmYAABpaAAAAAAAAGlQAABpOAAAAAAAAAAAAABpOAAAAAAAAGkgAABpOAAAAAAAAGkIAABpOAAAAAAAAGlQAABo8AAAAAAAAGjYAABpOAAAAAAAAGlQAABo8AAAAAAAAGlQAABo8AAAAAAAAGkgAABpOAAAAAAAAGjAaKhokGh4AABoYGhIaKhokGh4AABoYGhIaKhokGh4AABoYGgwaKhokGh4AABoYGjAaKhokGh4AABoYGgwaKhoGGh4AABoYGjAaKhokGh4AABoYGjAaKhokGh4AABoYGjAaKhokGh4AABoYGhIaKhokGh4AABoYGgAaKhokGh4AABoYGjAaKhokGh4AABoYGjAaKhokGh4AABoYGjAaKhoGGh4AABoYGhIaKhokGh4AABoYGhIaKhokGh4AABoYGjAAABokAAAAABoYGhIAABokAAAAABoYGjAAABoGAAAAABoYGhIAABokAAAAABoYGhIAABokAAAAABoYGhIAABokAAAAABoYGhIaKhokGh4AABoYGhIaKhokGh4AABoYGhIaKhokGh4AABoYGjAaKhokGh4AABoYGjAaKhokGh4AABoYGjAaKgAAAAAAABoYGjAaKhokGh4AABoYGhIaKhokGh4AABoYGhIaKhokGh4AABoYGjAaKhokGh4AABoYGjAaKhokGh4AABoYGjAaKhokGh4AABoYGfoAABn0AAAAAAAAGe4AABsOAAAAAAAAGjAAAAAAAAAAAAAAGegAABniAAAAAAAAGdwAABniAAAAAAAAGdYAABniAAAAAAAAGegAABnQAAAAAAAAGdwAABniAAAAAAAAGegAABnQAAAAAAAAGdwAABniAAAAAAAAGegAABnQAAAAAAAAGcoAABnEAAAAAAAAGb4AABnEAAAAAAAAGbgAABnEAAAAAAAAGbIAABnEAAAAAAAAGcoAABnEAAAAAAAAGcoAABnEAAAAAAAAGbIAABnEAAAAAAAAGcoAABmsAAAAAAAAGaYAABnEAAAAAAAAGcoAABmsAAAAAAAAGaYAABmsAAAAAAAAGaAAABmaAAAAAAAAGZQAABp+AAAZjgAAGZQAABp+AAAZjgAAGYgAABp+AAAZjgAAGZQAABp+AAAZjgAAGZQAABpsAAAZjgAAGZQAABpsAAAZjgAAGZQAABpsAAAZjgAAGYIZfBl2GXAAAAAAGWoZfBl2GXAAAAAAGWoZfBl2GXAAAAAAGWQZfBl2GXAAAAAAGWoZfBl2GXAAAAAAGV4ZfBl2GXAAAAAAGYIZfBlYGXAAAAAAGWoZfBl2GXAAAAAAGWoZfBl2GXAAAAAAGYIAABl2AAAAAAAAGWoAABl2AAAAAAAAGYIAABlYAAAAAAAAGWoAABl2AAAAAAAAGWoAABl2AAAAAAAAGWoAABl2AAAAAAAAGWoZfBl2GXAAAAAAGWoZfBl2GXAAAAAAGWoZfBl2GXAAAAAAGYIZfBl2GXAAAAAAGYIZUgAAAAAAAAAAGWoZfBl2GXAAAAAAGWoZfBl2GXAAAAAAGYIZfBl2GXAAAAAAGUwAABlGAAAAAAAAGUAAABk6AAAAAAAAGTQAABk6AAAAAAAAGS4AABk6AAAAAAAAGSgAABk6AAAAAAAAGTQAABk6AAAAAAAAGUwAABlGAAAAAAAAGSIAABkcAAAAAAAAGRYAABkcAAAAAAAAGRAAABkcAAAAAAAAGQoAABkcAAAAAAAAGQoAABkcAAAAAAAAGSIAABkEAAAAAAAAGRYAABkcAAAAAAAAGRYAABkcAAAAAAAAGRYAABkcAAAAAAAAGRYAABkcAAAAAAAAGP4AABj4AAAAAAAAGPIAABj4AAAAAAAAGOwAABj4AAAAAAAAGOYAABj4AAAAAAAAGP4AABjgAAAAAAAAAAAAABrAGroAAAAAGNoAABjUGM4AAAAAGMgAABjUGM4AAAAAGMgAABjUGM4AAAAAGNoAABjUGM4AAAAAGMgAABjCGM4AAAAAGNoAABjUGM4AAAAAGNoAABjUGM4AAAAAGNoAABjUGM4AAAAAGMgAABjUGM4AAAAAGNoAABjUGM4AAAAAGMgAABjCGM4AAAAAGNoAABjUGM4AAAAAGNoAABjUGM4AAAAAGNoAABjUGM4AAAAAGMgAABjUGM4AAAAAGLwAABjUGM4AAAAAGLwAABjUGM4AAAAAGNoAABjCGM4AAAAAGMgAABjUGM4AAAAAGMgAABjUGM4AAAAAGMgAABjUGM4AAAAAGMgAABjUGM4AAAAAGNoAAAAAAAAAAAAAGLYAABjUGM4AAAAAGNoAABjUGM4AAAAAGMgAABjUGM4AAAAAGLAAABiqAAAAAAAAGKQAABiqAAAAAAAAGJ4AABiYAAAAAAAAGJIAABiMAAAAAAAAGIYAABiMAAAAAAAAGIYAABiMAAAAAAAAGJIAABiMAAAAAAAAGIYAABiMAAAAAAAAGIYAABiMAAAAAAAAGIAAABiMAAAAAAAAGHoYdBhuAAAYaBhiGHoYdBhuAAAYaBhiGHoYdBhuAAAYaBhiGHoYdBhcAAAYaBhiGHoYdBhcAAAYaBhiAAAYdAAAAAAYaBhiGFYAABhQGEoAAAAAGEQAABhQGEoAAAAAGEQAABhQGEoAAAAAGEQAABhQGEoAAAAAGEQAABhQGEoAAAAAGEQAABhQGEoAAAAAGFYAABhQGEoAAAAAGEQAABg+GEoAAAAAGFYAABhQGEoAAAAAGFYAABhQGEoAAAAAGFYAABhQGEoAAAAAGEQAABhQGEoAAAAAGDgAABhQGEoAAAAAGDgAABhQGEoAAAAAGFYAABg+GEoAAAAAGEQAABhQGEoAAAAAGEQAABhQGEoAAAAAGEQAABhQGEoAAAAAGEQAABhQGEoAAAAAGFYAABhQGEoAAAAAGFYAABhQGEoAAAAAGFYAAAAAAAAAAAAAGEQAABhQGEoAAAAAGDIAABgsAAAAAAAAGCYAABgsAAAAAAAAGCYAABgsAAAAAAAAGCYAABgsAAAAAAAAGCAAABgsAAAAAAAAGCAAABgsAAAAAAAAGCYAABgsAAAAAAAAGBoAABuGAAAYFAAAGBoAABuGAAAYFAAAGBoAABgOAAAYFAAAGAgAABuGAAAYFAAAGBoAABgOAAAYFAAAGAIAABf8F/YAAAAAF/AAABf8F/YAAAAAF+oAABf8F/YAAAAAF+oAABf8F/YAAAAAF+oAABf8F/YAAAAAF+oAABf8F/YAAAAAGAIAABf8F/YAAAAAF/AAABf8F/YAAAAAGAIAABf8F/YAAAAAGAIAABfkF/YAAAAAF+oAABf8F/YAAAAAF+oAABf8F/YAAAAAF+oAABf8F/YAAAAAAAAAAAAAF/YAAAAAF+oAABf8F/YAAAAAF+oAABf8F/YAAAAAGAIAAAAAAAAAAAAAF/AAAAAAAAAAAAAAF+oAAAAAAAAAAAAAGBoAABfeAAAAAAAAGBoAABfYAAAAAAAAF9IXzBfGAAAAABfAF7oXzBfGAAAAABfAF9IXzBfGAAAAABfAF9IXzBe0AAAAABfAF9IXzBfGAAAAABfAF9IXzBe0AAAAABfAAAAXzAAAAAAAABfAF9IXzBe0AAAAABfAF9IXzBfGAAAAABfAF64AABuYAAAAAAAAF64AABeoAAAAAAAAF6IAABuGAAAAAAAAF5wAABuGAAAAAAAAF6IAABuGAAAAAAAAF5wAABuGAAAAAAAAF6IAABgOAAAAAAAAF5YAABuGAAAAAAAAF6IAABgOAAAAAAAAF6IAABgOAAAAAAAAF5wAABuGAAAAAAAAF5AXiheEF34AABd4F3IXiheEF34AABd4F3IXiheEF34AABd4F3IXiheEF34AABd4F5AXiheEF34AABd4F3IXihdsF34AABd4F5AXiheEF34AABd4F5AXiheEF34AABd4F5AXiheEF34AABd4F3IXiheEF34AABd4F2YXiheEF34AABd4F5AXiheEF34AABd4F5AXiheEF34AABd4F5AXihdsF34AABd4F3IXiheEF34AABd4F3IXiheEF34AABd4F5AAABeEAAAAABd4F3IAABeEAAAAABd4F5AAABdsAAAAABd4F3IAABeEAAAAABd4F3IAABeEAAAAABd4F2AAABeEAAAAABd4F3IXiheEF34AABd4F3IXiheEF34AABd4F3IXiheEF34AABd4F5AXiheEF34AABd4F5AXiheEF34AABd4F5AXigAAAAAAABd4F1oXiheEF34AABd4F1QXiheEF34AABd4F3IXiheEF34AABd4F5AXiheEF34AABd4F5AXiheEF34AABd4F5AXiheEF34AABd4F04AABdIAAAAAAAAF0IAAAAAAAAAAAAAFzwAAAAAAAAAAAAAFzYAABcwAAAAAAAAFyoAABcwAAAAAAAAFyoAABcwAAAAAAAAFzYAABckAAAAAAAAFyoAABcwAAAAAAAAFzYAABckAAAAAAAAFyoAABcwAAAAAAAAFzYAABckAAAAAAAAFx4AABcYAAAAAAAAFxIAABcYAAAAAAAAFx4AABcYAAAAAAAAFxIAABcYAAAAAAAAFx4AABcYAAAAAAAAFx4AABcYAAAAAAAAFxIAABcYAAAAAAAAFx4AABcMAAAAAAAAFwYAABcYAAAAAAAAFx4AABcMAAAAAAAAFwYAABcMAAAAAAAAFwAW+hb0AAAW7gAAFwAW+hb0AAAW7gAAFwAW+hb0AAAW7gAAFwAW+hb0AAAW7gAAFwAW+hboAAAW7gAAFuIW+hb0AAAW7gAAFwAW+hboAAAW7gAAFwAW+hboAAAW7gAAFtwW1hbQF0gAAAAAFsoW1hbQF0gAAAAAFsoW1hbQF0gAAAAAFsoW1hbQF0gAAAAAFsoW1hbQF0gAAAAAFsQW1hbQF0gAAAAAFtwW1ha+F0gAAAAAFsoW1hbQF0gAAAAAFsoW1hbQF0gAAAAAFtwAABbQFrgAAAAAFsoAABbQFrgAAAAAFtwAABa+FrgAAAAAFsoAABbQFrgAAAAAFsoAABbQFrgAAAAAFsoAABbQFrgAAAAAFsoW1hbQF0gAAAAAFsoW1hbQF0gAAAAAFsoW1hbQF0gAAAAAFtwW1hbQF0gAAAAAFtwW1gAAAAAAAAAAFrIW1hbQF0gAAAAAFsoW1hbQF0gAAAAAFtwW1hbQF0gAAAAAFqwAABamAAAAAAAAFqAAABaaAAAAAAAAFpQAABaaAAAAAAAAFpQAABaaAAAAAAAAFo4AABaaAAAAAAAAFpQAABaaAAAAAAAAFogAABaCAAAAAAAAFnwAABZ2AAAAAAAAFnAAABZ2AAAAAAAAFnAAABZ2AAAAAAAAFmoAABZ2AAAAAAAAFmoAABZ2AAAAAAAAFnwAABZkAAAAAAAAFnAAABZ2AAAAAAAAFnAAABZ2AAAAAAAAFnAAABZ2AAAAAAAAFnAAABZ2AAAAAAAAFl4AABZYAAAAAAAAFlIAABZYAAAAAAAAFlIAABZYAAAAAAAAFkwAABZYAAAAAAAAFl4AABZGAAAAAAAAAAAAAAAAF/YAAAAAGHoYdBhuAAAYaBhiGlQAABpOAAAAAAAAFkAAAAAAAAAAAAAAFkAAAAAAAAAAAAAAFjoAAAAAAAAAAAAAFjoAAAAAAAAAAAAAFjoAAAAAAAAAAAAAFjoAAAAAAAAAAAAAFjQAAAAAAAAAAAAAFjQAAAAAAAAAAAAAFjoAAAAAAAAAAAAAAAAAABYuAAAAAAAAFjoAAAAAAAAAAAAAAAEBLP8kAAEBLAKwAAEBLAKvAAEBLAKcAAEA3v8kAAEA3gKcAAEA3gKvAAEA3gAAAAEA3gGuAAEBNv8kAAEA+wKcAAEA+wKvAAEBNgAAAAEA+wGuAAEA8gAAAAEA8gGuAAEBiQKcAAEBiQKvAAEBdwAAAAEBiQGuAAEA7QAAAAEA7QGuAAEBDwKwAAEBpwAAAAEBD/8kAAEBDwKcAAEBDwKvAAEBDwAAAAEBrwGuAAEBDwGuAAEApQLhAAEAwv8kAAEAfAEOAAEAwgAAAAEA3QKwAAEApQHzAAEAzgKcAAEAyv8kAAEAzgKvAAEAygAAAAEAzgGuAAEAiP8kAAEAqwKvAAEAiAAAAAEAqwGuAAEBEAGuAAEBDgGuAAEBqAAAAAEBqAGuAAEBAwKvAAEBAwGuAAEA+gKvAAEA/gKcAAEA/v8kAAEA/gKvAAEA/gDXAAEBRQAAAAEA/gAAAAEB7AGuAAEA/gGuAAEBFgKcAAEBFgKvAAEBFgGuAAEBnv8kAAEBngGuAAEAh/8kAAEAhwNtAAEAhwFeAAEAhwAAAAEA1gKwAAEAhwKUAAEBB/8kAAEBBwAAAAEAhv8kAAEAhgKvAAEAhgGuAAEAwAAAAAEAhgAAAAEAhgKcAAEAhgNjAAEBFv8kAAEAxQIHAAEAhgKUAAEA8QKcAAEA8QKvAAEA9P8kAAEA8QGuAAEA8AKcAAEA8P8kAAEA8AKvAAEBawAAAAEA8AAAAAEA8AGuAAEBHP8kAAEBDwDXAAEBXAIHAAEBHAAAAAEB5QKwAAEBDwKUAAEA9wKcAAEA9wKvAAEA9wAAAAEA9wGuAAEBCAAAAAEBCAKUAAEBXAKvAAEBXAAAAAEBXAGuAAEA5wKwAAEA5wKcAAEA9f8kAAEA5wKvAAEBqQAAAAEA9QAAAAEA5wGuAAEBC/8kAAEBCwMRAAEBCwMaAAEBCwMkAAEBCwAAAAEBCwJLAAEBDv8kAAEBDgMRAAEBDgMaAAEBDgMkAAEBDgAAAAEBDgJLAAEB2AMRAAEB2AMaAAEB2AMkAAEB2AAAAAEB2AJLAAEBIAAAAAEBIAJLAAECagJLAAEBWv8kAAEBWwMRAAEBWwMaAAEBWwMkAAEBmwAAAAEBWgAAAAECgQJLAAEBWwJLAAEBFwMaAAEBFwEvAAEBFwJLAAEBRgAAAAEBRgJLAAEA8wMRAAEA8/8kAAEA8wMaAAEA8wPqAAEA8wMkAAEA8wAAAAEA8wJLAAEBN/8kAAEBDAMaAAEBDAMkAAEBNwAAAAEBDAJLAAEA/gJLAAECCwAAAAECCwJLAAEBVwMRAAEBV/8kAAEBVwMaAAEBVwMkAAEBVwEmAAEBoQAAAAEBVwAAAAECnQJLAAEBVwJLAAEBUgMRAAEBUv8kAAEBUgMaAAEBUgMkAAEBUgAAAAEBUgJLAAEBnf8kAAEBnQAAAAEBnQJLAAEBF/8kAAEAnAMkAAEAwAEvAAEBFwAAAAEBbQJLAAEBPP8kAAEBPAAAAAEBPAJLAAEAnAJLAAEAm/8kAAEAmwMRAAEAmwMaAAEAmwMkAAEA1AAAAAEAmwAAAAEAmwJLAAEBUAMaAAEBUP8kAAEBUAGyAAEBUAAAAAEBUAJLAAEBYAMRAAEBYP8kAAEBYAMaAAEBYAMkAAEBYAAAAAEBYAJLAAEAnAAAAAEBBAJLAAEBGAMRAAEBGP8kAAEBGAMaAAEBGAMkAAEB6AAAAAEBGAAAAAEBGAJLAAEBRP8kAAEBTgMaAAEBWAEmAAEAyAEmAAEBRAAAAAEBTgJLAAEBXQMRAAEBXQMaAAEBXQMkAAEBXQAAAAEBXQJLAAEBFgAAAAEBFgJLAAEBngMkAAEBngAAAAEBngJLAAEBHQMRAAEBHQMaAAEBEv8kAAEBHQMkAAECHwAAAAEBEgAAAAEBHQJLAAIADwABAHgAAAB7AKAAeACiALUAngC3AREAsgETAS4BDQExAUsBKQFNAVIBRAFUAWUBSgFoAY0BXAGPAaIBggGkAdgBlgHaAdoBywJiAmIBzAKkAqQBzQKmArABzgBdAAABvgAAAb4AAAG+AAABvgAAAb4AAAG+AAABvgAAAb4AAAG+AAABvgAAAb4AAAG+AAABvgAAAb4AAAG+AAABvgAAAbgAAAG4AAABuAAAAb4AAAG+AAABvgAAAb4AAAG+AAABvgAAAb4AAAG+AAEBsgACAawAAgGsAAIBrAACAawAAwGmAAIBrAACAawABAGgAAUBoAAFAZoABQGUAAABjgAAAY4AAAGOAAABjgAAAY4AAAGOAAABjgAAAY4AAAGOAAABjgAAAY4AAAGOAAABjgAAAY4AAAGOAAABjgAAAYgAAAGOAAABjgAAAY4AAAGOAAABjgAAAY4AAAGOAAABjgAAAY4AAAGOAAEBggACAawAAgGsAAIBrAACAawAAwGmAAIBrAACAawABAGgAAUBfAAFAXYAAAG+AAABvgAAAb4AAAG+AAABvgAAAb4AAAG+AAABvgAAAY4AAAGOAAABjgAAAY4AAAGOAAABjgAAAY4AAAGOAAEBLAEmAAEBRQFKAAEBdQKKAAEBKgKUAAEBLAKUAAEBLADXAAEBRgFKAAEBAgGWAAEBNAAAAAEBLAAAAAEBdQGmAAEBKgGuAAEBLAGuAAIABAKxArkAAAK7AtgACQLmAwsAJwMPAx4ATQACAAgAAkJOAAoAAjqyAAQAAD5WOzoAXwBPAAAAAAAAAAAAAAAA//sAAAAAAAAAAAAA/+IAAP/2//EAAAAA//v/9v/nAAAABQAAAAAAAP/n//sAAAAAAAAAAAAAAAAAAAAAAAAACv/7//L/+//xAAAAAAAA//b/+wAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/9gAAAAAAAAAAAAAAAP/sAAD/2P/2//b/9v/+AAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/+AAAAAAAAAAAAAAAAAAAAAAAA//EAAAAPAAAAAAAAAAAAAAAAAAAAAAAAAAD/9gAAAAD/5gAKAAAAAAAA/+cAAP/iAAD/9gAAAAoAAAAA//YAAAAAAAAAAP/2AAAAAAAAAAD//AAA//sAAP/2AAAAAAAAAAAAAAAA/90AAP/i/+z/9v/x//QAAAAAAAAAAP/7AAAAAAAA//b/9gAA/+r/+//YAAD/3f/tAAD/9v/7//sABQAA//v/+wAA//sAAQAUAAAAAP/7AAD/8QAAAAAAAP/Y/+L/5v/dAAD/3gAK/+IAAAAA//sABf/dAAD/ygAAAAAAAAAAAAD/+wAAAAAAAP/7AAD/8QAA//sAAAAAAAAAAAAAAAD/0wAA/+L/8f/iAAD/5f/7AAAAAAAA//sAAAAAAAD/+f/7AAD/6gAA//EAAAAA//EAAP/5//b/+wAA//QAAAAAAAD/+wAAAAAAAAAA//sAAAAAAAAAAAAAAAAAAAAA//YAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/7AAAAAAAA//sAAAAAAAAAAAAAAAAAAAAAAAAAAP/2AAD/3QAAAAAAAP/v//sAAAAAAAAAAAAAAAAAAAAAAAAAAP/7AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/7AAAAAAAAAAAAAAAAAAAAAAAAAAD/5v/2AAAAAAAA//YAAP/sAAAAAAAAAAAAAAAA//EAAAAAAAAAAP/2AAAAAAAAAAD/9v/7/+wAAAAAAAAAAAAAAAAAAAAA/80AAP/s/+f/8f/7AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//4AAAAAAAAAAAAAAAAAAAAAAAD/+wAAAAoAAAAAAAAAAAAAAAAAAP/7AAAAAP/2AAAAAP/xAAoAAAAAAAD/7AAA/+wAAP/2AAAABQAAAAD/+//7AAAAAAAA//b/+wAAAAAAAP/8AAD/+wAA//YAAAAAAAAAAAAAAAD/5wAA/+z/5//7/+z/9AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/2AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//sAAAAAAAD/9v/2AAAAAAAA//EAAP/sAAAAAAAAAAAAAAAA//YAAAAAAAAAAAAAAAAAAAAAAAAAAP/7//sAAAAAAAAAAAAAAAAAAAAA//YAAP/sAAAAAP/7AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/2AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/+wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/+H/9gAAAAAAAP/xAAD/7AAAAAAAAAAAAAAAAP/xAAAAAAAAAAAAAAAAAAAAAAAA//v/+//7AAAAAAAAAAAAAAAAAAAAAP/nAAD/7P/2AAD/9gAAAAAAAAAA//QAAAAA//T/8f/5AAAAAP/0AAD/+//qAAD/+wAA//n/6v/7//b/+f/x//YAAP/7/9j/9v/7//sAAP/7//b/9gAAAAAAAAAA//b/9v/7AAD/8QAAAAAAAP/2//H/+wAAAAAAAP/3AAAAAAAAAAAAAAAAAAAAAP/7AAAAAP/7AAAAAAAAAAAAAAAAAAD/9v/J//sAAP/7/+8AAAAAAAD/9wAAAAL/+QAAAAIAAAAAAAkAAAAA//kAAAAAAAcABP/5AAD/3QAA//YAAAAAAAIAAAAAAAAAAP/7AAD/4gAAAAAAAAAFABQAAAAA/+wABf/3//YAAP/7//v/9gAAAAAAD//7//cAAAAA//b/4gAAAAAAAAAA//sAFAAA//YAAAAAAAAAAAAAAAAAAAAA/8T/8QAK//v/9AAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/9AAA//EAAP/7//YAAAAAAAAAAP/7AAAABQAAAAAAAP/2AAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/7//YAAP/7AAD/9gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/7AAAAAAAAP/0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//sAAP/7AAAAAAAAAAAAAAAAAAAAAAAA//b/9gAAAAD/9gAAAAAAAP/7AAAAAAAAAAAAAAAA//sAAAAAAAAAAAAAAAAAAP/7AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//sAAP/sAAAAAP/7AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/+z/+wAAAAAAAAAAAAAAAP/7//sAAP/7//b/+wAAAAD/+wAAAAAAAAAAAAAAAP/7//sAAAAA//4AAAAAAAD/+//2AAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/w//sAAAAAAAAACgAAAAAAAAAAAAAAAAAKAAAAAAAAAAD/+//7AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/8QAAAAAAAP/5AAAAAAAA/7v/4v/g/8L/0//U//sAAP/W//EAAP+7AAD/5//v/9n/tv/7/+j/0f/d/+YAAP/g/4P/xf/2/+cAAP/s/+f/5wAAAAAACgAQ/9P/6P/jAAr/4wAA//YAAP/2/+gAAAAAAAD/4v/YAAAAAP/y/8sAAAAAAAD/8QAAAAAAAP/2AAAAAAAAAAAAAP/2AAD/4v+6/+wACv/7/9T/5wAAAAAAAAAAAAAAAAAAAAAAAAAA//sAAAAAAAAAAAAAAAAAAAAAAAD/+wAAAAAAAAAAAAAAAAAAAAAAAP/7AAD/9v/7AAAAAAAAAAAAAAAAAAD/8QAA/+wAAP/7AAAAAAAAAAAAAAAAAAAAAAAA//v/+wAAAAAAAP/7//v/+wAA//sAAAAAAAAAAAAAAAD/4gAA/+f/9gAA//b/+wAAAAAAAP/5AAAAAP/5//v//gAAAAD/9AAA//v/+QAAAAAAAP/+//QAAP/2//kAAAAAAAD/+//2AAD/+wAAAAD/+//7//YAAAAAAAAAAAAAAAAAAAAAAAAAAP/2//YAAAAAAAAAAAAAAAD/+QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/2AAAAAAAAP/0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/0AAAAAAAAAAAAAAAAAAAAAAAAAAD//gAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//sAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//YAAP/s//v/9gAAAAAAAAAAAAD/9P/2AAD/+f/j//T/8QAA/+3/9v/o//b/6P/sAAD/9P/v//sAAP/7//b/9v/2//T/4wAO//YAAP/5AAD/7AAAAAAAAP/n/+gAAP/oAAD/4//7/+f/6//s//b//P/i//b/3f/h//QAAAAA//H/2AAAAAAAAP/iAAD/8QAA//YAAAAAAAAAAAAA//b/2P/h/+L/8f/i//v/9P/nAAAAAP/7AAAAAAAAAAAAAAAA//sAAAAAAAAAAAAAAAAAAAAA//sAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//kAAP/2AAAAAAAAAAoACgAAAAAAAAAAAAD/9gAAAAAAAAAAAAAAAAAUAAD/+wAAAAD/+//2AAAAAAAAAAAAAAAKAAAAAAAAAAAAAAAAAAAAAP/xAAAAAP/2AAD/+//7AAAAAAAAAAD/+wAAAAAAAP/5//wAAP/o//v/ygAA/8D/zwAA//n//v/7AAD//gAAAAAAAP/7AAAAAP/7AAD/+wAAAAAAAAAAAAD/3v/UAAD//AAK/9oAAP/YAAAAAAAAAAD/4gAA/9kAAAAAAAAAAAAAAAAAAAAAAAD/9gAA/8oAAP/2AAAAAAAAAAAAAAAA/9gAAP/iAAD/zv/7//7/+wAAAAD/1P/x/+//0f/Y/+//9gAA/+//9v/d/88AAAAA//n/7//AAAD/4v/g/+L/8AAA/+r/tv/j//b/6AAA//H/7P/sAAAAAAAKAAr/5//n/9MAFP/JAAD/9v/x//b/8v//AAAACv/x/9oAAAAA//H/2QAAAAAAAP/7AAAAAAAA//EAAAAAAAAAAAAAAAAABf/x/7r/5wAU//v/1P/xAAAAAP/qAAAAAP/sAAAAAAAA//kAAgAAAAD/+QAAAAAAAAAA/+4AAP/s//sAAAAAAAAAAAAAAAAAAAAA//sAAP/n//sAAAAAAAoAFAAAAAD/8QAA//EAAAAA//b/9v/7AAAAAAAU//b/8AAAAAD/+//TAAAAAAAAAAD/8QAKAAD/8QAAAAAAAAAAAAAAAP/7//v/zv/sAAr/+//5AAAAAAAA//kAAAAA//sAAAAAAAAAAP/5AAAAAP/2AAAAAAAAAAD/+QAAAAD/+//7AAAAAP/7AAAAAAAAAAAAAAAA/+wAAAAAAAAAAAAAAAAAAAAA//sAAP/2AAD/+wAA//YAAAAAAAD/+//7AAAAAP/2/9gAAAAAAAD/+//xAAAAAAAAAAAAAAAAAAAAAAAA/+z/+//s//EAAP/x//n/+wAAAAAAAAAAAAAAAAAAAAAAAAAA//sAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/9gAAAAAAAAAAAAAAAAAAAAD/9gAA/+0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/9gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/9gAA/+z/+wAAAAAAAAAAAAAAAP/5AAAAAP/5//v//v/7AAD/9AAA//v/+f/7//sAAP/+//QAAP/2//kAAAAAAAD/+//xAAAAAAAAAAD/+wAA//YAAAAAAAAAAAAA//sAAAAAAAAAAP/2//YAAAAAAAAAAAAAAAD/+QAAAAAAAAAAAAAAAAAAAAD/+wAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/2AAAAAAAAP/0AAAAAAAA/9j/9gAA/93/3v/7AAAAAAAAAAAAAP/YAAAAAAAAAAD/2AAA/9j/8f/t/+sAAP/7/7D/xQAA//IAAP/7//H/7AAAAAAAFAAP/+L/9v/sAAr/6AAA//YAAAAA//IACgAKAB7/+//nAAAAAAAA/8oAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAr/9v+1AAAAFAAA//b/9gAAAAD/+wAAAAD/+wAAAAAAAAAAAAAAAAAA//sAAAAAAAAAAAAAAAD/8QAA//sAAAAAAAAAAAAAAAAAAAAAAAD/9gAAAAAAAAAEAB4AAAAA//sAAAAA/+wAAAAAAAD/+wAAAAAAD//7//sAAAAA//b/7AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/7AAD/7P/7//v/+wAAAAAAAAAA//YAAAAAAAD/9v/7AAD/7wAA//YAAP/7//sAAP/2//sAAAAK//sAAAAAAAD/+//7AAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/7AAAAAAAAAAAAAAAAAAAAAAAA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AAAAAAAAAAAAAP/2AAD/9v/2AAAAAAAAAAAAAAAAAAAAAAAAAAD/8AAAAAoAAAAAAAAAAAAAAAAAAAAAAAAAAP/7AAD/6wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//sAAAAA//sAAP/2AAD/+wAA//YAAAAA//YAAAAAAAAAAAAAAAD/9gAAAAAAAP/2AAAAMQAAAAAAAP/r/80AAAAAAAAAAAAA//YAAP/sAAAAAAAAAAAAAAAA/9b/6wAAAAAAAAAAAAD/9v/sAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/2AAAAAAAAAAAAAAAAAAoABQAAAAUABQAA//EAAP/7AAD/6AAA//L/8gAAAAAAAAAA/9gAAAAA/84AAAAAAAAAAAAAAAAAAAAAAAD/4gAA/9j/4gAAAAAAAAAA/8QAAP/JAAAAAAAAAAD/3QAA/+IAAAAAAAAAAP/xAAoAAAAAAAD/+//2AAAAAAAAAAAAAP+vAAAAAAAA/+cAAP/J/+EAAP/2//sAAAAAAAAAAAAAAAAAAP/iAAD/+wAAAAAAAAAAAAAACv//AAAAAAAAAAD/zwAA/9gAAAAAAAD/zv/YAAD/4gAA/9j/4v/iAAAAAAAAAAAAAAAA/9YAAAAAAAAAAP/W/9b/3QAAAAAAAAAAAAAAAAAAAAD/4gAAAAAAAAAAAAQAAAAA/+wAAAAAAAAAAAAA/+sACgAA/8QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKAAAAAAAAAAAAAP/sAAAAAAAAAAAAAAAA//YAAAAAAAD/6wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/+H/6wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/7AAAAAAAAAAAAAAAAAAAAAD/7AAAAAAAAAAAAAAAAAAA//YAAAAUAAD/0wAKAAAAAAAPAAAADwAAAB4ACgAKAAr/5gAA/8UAAP/iAAAAAAAU/7z/2AAAAAAAAAAA/84AAAAAAAAAAAAAAAD/9gAAAAAAAAAAAAAAAAAA/+IAAAAAAAD/+wAAAAAAAP/7/+MAAAAAAAAACgAUAAAAAAAA/+IAAAAAABUAAAAAAAD/7P9vAAUAAAAKAAUAAAAAAAAAAAAAAAAAAP/7//sAAAAA//EAAP/s//b/9v/xAAD/+wAA//v/9gAAAAD/8QAAAAD/9v/rAAAAAP/7AAAAAAAA//b/8QAA//sAAP/2AAD/8QAA//sAAAAAAAAAAAAAAAD/9gAAAAAAAAAA//EAAAAAAAAAAP/2AAAAAAAA//b/5wAAAAAAAP/2AAD/0wAA/9j/6wAA//v/7AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/sAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/7AAD/9gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//sAAAAAAAD/+wAAAAAAAAAAAAAAAP/2AAD/4v/7AAD/9gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/2AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/9gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/NAAAAAAAAAAAAAP/2AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/7AAD/9v/2AAAAAAAAAAAAAAAA//b/8QAAAAAAAAAAADsAAAAAAAAAAAAAAAAAAP/2AAAAAAAAAAD/9gAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/9gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/7AAAAAAAAAAAAAAAA//v/8gAAAAD/+wAAAAAAAAAA//gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/+//2//YAAAAAAB4APAAAAAAAAAAeAAAAUAAAAAQAE//7AAoAFQAU//sACAAJAAD/9v/dAAAAAAAAAAD/+wAUAAAAMgAAAEUAAAAAAAAABAAK//v/2P/2AFD/+//7AAAAAAAAAAAAAAAAAAD/8f/7AAAAAP/nAAD/7QAA//f/7AAA//sAAP/2//YAAAAA//YAAAAA//b/9gAAAAAAAAAAAAAAAAAA//YAAAAAAAD/8QAA//EAAAAAAAAAAAAAAAAAAAAA//cAAAAAAAAAAP/2AAAAAAAAAAD/8f/7AAAAAP/2//EAAAAAAAAAAAAA/+IAAP/T//EAAP/n//YAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//YAAP/7AAD/+//7AAAAAAAAAAAAAAAAAAD/4gAAAAAAAAAAAAAACgAAAAAAAAAAAAAAAP/xAAAAAP/7AAD/7AAA//YAAAAAAAAAAAAAAAD/9gAAAAAAAAAA//sAAAAAAAAAAP/2AAAAAAAAAAD/9gAAAAAAAP/7AAD/5wAA/+L/9gAA//b/9gAAAAAAAAAAAAAAAAAAAAD/+wAAAAD/7wAAAAAAAAAAAAAAAP/7//sAAAAA//4AAAAAAAD/+wAAAAAAAAAA//sAAAAA//sAAAAA/9j/2AAAAAAAAP/YAAD/4gAA/+z/9gAA//YAAP/YAAAAAAAAAAAAAAAAAAAAAAAA/+wAAP/YAAD/9gAAAAAAAAAAAAAAAP/iAAAAAP/2AAD/9v/5AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/i//YAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/7AAAAAAAAAAAAAAAAAAAAAD/7P/sAAD/4v/i//cAAAAAAAD/4gAA/+IAAP/rAAD/9gAAAAAAAP/XAAAAAAAA/9L/4QAAAAAAAP/EAAEAAAAA/+sAAAAAAAAAAAAAAAD/sP/X/+z/1wAA/+IAAP/XAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/YAAAAAAAAAAAAAAAAAAAAAAAAAAD/4gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/OAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/+wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/7P/sAAAAAAAA/+sAAP/sAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//YAAP/Y//sAAAAAAAAAAAAAAAAAAAAAAAAAAP/3AAAAAAAAAAAAAP/3AAAAAP/7AAAAAAAA//v/5wAAAAD/+wAAAAD/4//sAAAAAAAAAAAAAAAAAAAAAP/7AAAAAP/xAAD/7AAAAAAAAAAAAAAAAAAAAAD/+wAAAAAAAAAA//b/9gAAAAAAAAAAAAAAAAAA//b/3QAAAAAAAP/2AAD/7AAA/87/8QAA//EAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/+wAA//sAAP/7//sAAAAAAAAAAAAAAAAAAP/NAAAAAAAJAAUAAAAAAAAAAAAAAAAAAAAA//b/6wAAAAAAAP/2AAAAAAAAAAAAAAAA//YAAP/nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/rAAAAAAAAAAAAAAAAAAD/2AAAAAAAAP/7AAAAAAAA//b/9gAAAAD/+wAA//sAAP/2AAD/9v/7AAD/8QAAAAAAAAAAAAAAAP/sAAAAAAAo/+sAAABPAAAAAAAA/+3/zQAAAAAAAAAAAAD/9gAA/+wAAAAoAAAAAAAAAAD/7P/sAAD/9gAAAAAAAP/2//EAAAAAAAD/9v/7AAAAAAAAAAAAAAAAAAAAAAAAAAD/9gAA//sAAAAA//b/9gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/6wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/4QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/9gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/7AAAAAAAoAAAAAAAAAAAAAAAAAAAAAP/2AAAAAAAeAB8AKgAAAAAAAAAUAAAAHgAAAAAAAAAAAAAAAAAoAAAAAAAAAAD/9v/xABQAAAAAAAoAAAAeAAAAAAAAAAD/zgAf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AjoCOgBAAjsCOwAsAjwCPAAtAj4CPgAuAj8CQAAWAkUCRQAWAkcCSAAUAkkCSQAkAkoCSgAlAksCSwAkAkwCTAAlAk0CTQAgAk4CTgAhAk8CTwAgAlACUAAhAlECUgAXAl0CXQADAl4CXgACAl8CXwADAmECYQALAmUCZQABAmYCZgADAmcCZwABAmgCaAAiAmkCaQA6AmoCagA7AmsCbgABAm8CbwBFAnACcAAiAnECcQAPAnICcgAMAoUChQA5AogCiAAdAokCiQAbAooCigABAowCjABEAo0CjQAHAo4CjgBBAo8CkAAjApUClQAqApYClgAoApcClwA+ApgCmABGApkCmgAYApsCmwBLApwCnAAyAp0CngAXAqECoQAwAqMCowAxAqQCpAABAqUCpQAYAAIApwABABoAAgAbABwAAwAdAB0AMwAeACQADwAmACYAHgAsACwAGgAtAEMAAwBEAEQAKABFAEsAEwBMAFEABgBSAFIAGwBTAGEABgBiAGMAGwBkAGUAIwBmAGYAFgBoAGwAFgBtAG0ADQBuAG8AFgBwAHEABgByAHIAEgBzAHMAGwB0AHgAEgB5AHkAGwB6AHoADQB7AHwAEgCfAJ8AAwCgAKAAIAChAKEANACjAKoAFACrALYADAC4AL4AHAC/AMcACgDIAM0AHwDOANUACgDWANsAFwDcANwANQDdAOYAEADnAOsAHgDsAOwAGwDtAQYABAEHAQgABQEJAQkAAQEKARAAFQERAREADgESARIAQgETARMAKwEUARYADgEXARcAGgEYAS4ABQEvAS8AAQEwATAARQExATcAHQE4ATwACQE9AUkACAFKAUoADQFLAU0ACAFOAVAADQFRAVMAJQFUAVUADgFWAVYAKwFXAVcADgFZAVkADgFaAVoADQFbAVwADgFdAWUACQFmAWcADQFoAWkACQFqAYsAAQGMAYwABQGNAY4AAQGPAY8AUgGQAZcAGAGYAaIAEQGjAaMASAGkAasAGQGsAcIABwHDAcgACwHJAckAXQHKAdMACwHUAdgAGgHaAdoADQHbAdsACAHcAdwADgHdAd0ACAHeAd4ADgHfAd8AGwHgAeAADQHhAeIAJgHjAeMAJwHlAeUAKQHmAeYABwHoAegAXgHpAekATgHqAeoAXAHrAesAWgHsAewARwHtAe0ARgHuAe4AWAHvAe8AVwHwAfAAQQHxAfEATQIoAigALAIpAikAJAIqAisAKgIsAiwALAItAi0AQwIuAi4ARAIvAi8AUwIwAjAAVAIxAjEAIQIyAjIAPQIzAjMANwI1AjUAWQI2AjYAOQI5AjkATwI6AjoAUAI7AjsAOgI8AjwAOwI9Aj0APAI/AkAAIQJFAkUAIQJHAkgAJAJJAkkAMQJKAkoAMgJLAksAMQJMAkwAMgJNAk0ALQJOAk4ALgJPAk8ALQJQAlAALgJRAlIAIgJdAl0ADwJeAl4AFQJfAl8ADwJhAmEADAJjAmMADwJlAmUAKAJmAmYAEwJnAmcAIwJoAmgALwJpAmkASgJqAmoATAJrAmsAEgJsAm4AIAJvAm8AFAJwAnAALwJxAnEAFwJyAnIAEAKFAoUASQKIAogAKQKJAokAJwKKAooABgKMAowAVQKNAo0ABwKOAo4AUQKPApAAMAKVApUAOAKWApYANgKXApcABgKYApgAVgKbApsAWwKcApwAQAKdAp4AIgKhAqEAPgKiAqIASwKjAqMAPwKkAqQAJgABAwAABAAAAXsQEhASEBIQEhASEBIQEhASEBIQEhASEBIQEhASEBIQEhASEBIQEhASEBIQEg/0EBIQEhASD+oP6g/qD+oP6g/qD+APug+0D64Prg+kD5oPmg+QD4oPfA+0D24PUA9QDz4PtA+0D7QPtA+0D7QPtA+0D7QPtA/qD+oP6g/qD+oP6g/qD+oP6g/qD+oP6g/qD+oP6g/qDtwOhg6GDoYOhg6GD+oP6g/qD+oP6g/qD+oP6g/qD+oP6g/qDoAPtA42DjAOMA4wDjAOMA4wDjAOMA6ADoAOgA6ADoAOgA6ADoAOgA6ADoAOgA/qDhoOGg4aDhoOGg4aDhoOgA6ADoAOgA6ADoAOgA6ADoAOgA6ADoAOgA6ADoAOgA6ADoAOgA6ADoAOgA6ADewN7A3sDewN7A3sDeIN3A3cDdwN3A3cDdwN3A3cDdwN3A+0DdYN1g6ADoAOgA3QDdAN0A3QDdAN0A3QDcoNxA6ADoAOgA6ADoAOgA26DoAOgA2sDoAOgA6ADoAOgA6ADoAOgA6ADoAOgA6ADoAOgA2iDZgNjg2ADYANeg10DWINXA1cDVwNxA+uDOIOgA6ADoAOgAzYDoAOgAzYDoAOgA6ADoAOgA6ADoAOgAzODMQMxAzEDMQMxA6ADoAOgA6ADoAOgA6ADoAOgA6ADoAOgA6ADoAOgA3KDcoNyg3KDcoNyg3KDcoOgA6ADoAOgA6ADoAOgA6ADoAOgA6ADoAN0A3QDG4N0A3QDGQN0A3QDF4MWAxYDFgMWAxYDdwN3A3cDdwN3A3cDdwN3A3cDdwN3A3cDdwN3A3cDdwPtAxSDFIMRA3QDDoMMAwmDoAMGAwKDAAL9gvoC94L0Au6C+gLtAumC5gNygt6C3QLZgtQCw4NygsEC5gLmAuYBhYL3gveBgAF3gYABd4F2AXSBdgF0gXEBcQN0A6ABa4FEA+6D1APtA6ADoAOgA4wDewN3A6ABI4N0AxEBHAF0g6ADdAN0ARmDVwOgARgBdIFxAXEBdIMUgACADoAAQAaAAAAJQAlABoAJwArABsAQgBCACAARABEACEAUgBSACIAVABWACMAWABZACYAXgBfACgAYQBlACoAaQBpAC8AcgB5ADAAewCeADgAoADmAFwA7ADsAKMA9gD2AKQBAwEDAKUBBwEQAKYBEgETALABGAEwALIBPwFAAMsBQwFEAM0BSQFJAM8BSwFLANABTQFNANEBUQFTANIBVgFWANUBWwFcANYBagGOANgBkAGrAP0BtQG6ARkBwwHIAR8BygHTASUB3wHfAS8B4QHjATAB5QHlATMB6AHoATQB6wHxATUCKAIsATwCLwI2AUECOQI7AUkCPwJAAUwCRQJSAU4CXgJeAVwCYQJiAV0CZAJlAV8CZwJnAWECawJvAWICcQJyAWcChQKFAWkChwKJAWoCiwKMAW0CjgKQAW8ClQKWAXICmAKYAXQCmwKeAXUCoQKhAXkCpAKkAXoAAQJGABUAAgJG/+wCZP/xAAcCKAAKAikACgIsAAoCRwAKAkgACgJN//YCT//2ACAB4//xAej/9gHpAAAB6v/2Aev/8QHs/+wB7f/2Ae7/7AHvAAEB8AAAAfEAAQIo/+cCKf/nAir/3QIr/90CLP/nAi8ACgIx/+ICM//iAjYAMgI6ACgCPAAAAj//4gJA/+ICRf/iAkf/5wJI/+cCTf/sAk7/3QJP/+wCUP/dAon/8QAnAeP/5wHo//YB6//2Aez/6AHu//YB7wAFAfD/9gIo/+wCKf/sAir/7AIr/+wCLP/sAi8AKAIx/+cCMwAKAjX/ugI2ADICOgAeAj//5wJA/+cCRf/nAkb/7AJH/+wCSP/sAkkAFAJKABQCSwAUAkwAFAJN/+ICTv/2Ak//4gJQ//YCUQAeAlIAHgKJ/+cClf/dApb/9gKdAB4CngAeAAUB6QAKAe8ABQJGAB4CSgAVAkwAFQADAkb/4gJi/+sCZP/2AAECRv/iAAECZP/sAAgBQgAqAUMABQFEAAUBTQALAkb/2QJi/+wCY//rAmT/4QAFAGEAKAFCADMBRwAVAkb/2AJiAAABOwABAAkAAgAJAAMACQAEAAkABQAJAAYACQAHAAkACAAJAAkACQAKAAkACwAJAAwACQANAAkADgAJAA8ACQAQAAkAEQAJABIACQATAAkAFAAJABUACQAWAAkAFwAJABgACQAZAAkAGgAJABsAFAAcABQAHv/2AB//9gAg//YAIf/2ACL/9gAj//YAJP/2AEX/9gBG//YAR//2AEj/9gBJ//YASv/2AEv/9gBiAFAAYwBQAH3/9gB+//YAf//2AID/9gCB//YAgv/2AIP/9gCE//YAhf/2AIb/9gCH//YAiP/2AIn/9gCK//YAi//2AIz/9gCN//YAjv/2AI//9gCQ//YAkf/2AJL/9gCT//YAlP/2AJX/9gCW//YAl//2AJj/9gCZ//YAmv/2AJv/9gCc//YAnf/2AJ7/9gCf//YAov/2AKsACgCsAAoArQAKAK4ACgCvAAoAsAAKALEACgCyAAoAswAKALQACgC1AAoAt//2ALj/8QC5//EAuv/xALv/8QC8//EAvf/xAL7/8QC///YAwP/2AMH/9gDC//YAw//2AMT/9gDF//YAxv/2AMf/9gDI//YAyf/2AMr/9gDL//YAzP/2AM3/9gDO//YAz//2AND/9gDR//YA0v/2ANP/9gDU//YA1f/2ANb/7ADX/+wA2P/sANn/7ADa/+wA2//sANwACgDd//EA3v/xAN//8QDg//EA4f/xAOL/8QDj//EA5P/xAOX/8QDm//EBCv/2AQv/9gEM//YBDf/2AQ7/9gEP//YBEP/2ARH/9gES//YBE//2ART/9gEV//YBFv/2ARf/9gEY//YBGf/2ARr/9gEb//YBHP/2AR3/9gEe//YBH//2ASD/9gEh//YBIv/2ASP/9gEk//YBJf/2ASb/9gEn//YBKP/2ASn/9gEq//YBK//2ASz/9gEt//YBLv/2AS//9gFq//YBa//2AWz/9gFt//YBbv/2AW//9gFw//YBcf/2AXL/9gFz//YBdP/2AXX/9gF2//YBd//2AXj/9gF5//YBev/2AXv/9gF8//YBff/2AX7/9gF///YBgP/2AYH/9gGC//YBg//2AYT/9gGF//YBhv/2AYf/9gGI//YBif/2AYr/9gGL//YBjP/2AY//9gGk//YBpf/2Aab/9gGn//YBqP/2Aan/9gGq//YBq//2Aaz/9gGt//YBrv/2Aa//9gGw//YBsf/2AbL/9gGz//YBtP/2AbX/9gG2//YBt//2Abj/9gG5//YBuv/2Abv/9gG8//YBvf/2Ab7/9gG///YBwP/2AcH/9gHC//YBw//xAcT/8QHF//EBxv/xAcf/8QHI//EByv/xAcv/8QHM//EBzf/xAc7/8QHP//EB0P/xAdH/8QHS//EB0//xAeMAFAHlAAoB5v/2Aej/9gHqAAoB7P/sAe7/9gHv//YB8P/7AigACgIpAAoCKgAKAisACgIsAAoCMf/2AjL/7AIz/+wCNQAoAjb/jQI5/+wCP//2AkD/9gJF//YCRv/UAkcACgJIAAoCSf/sAkr/7AJL/+wCTP/sAk3/4gJP/+ICUf/iAlL/4gJd//YCXv/2Al//9gJhAAoCY//iAmb/9gJx/+wCcv/xAoX/9gKIAAoCiQAUAoz/4gKN//YCj//sApD/7AKX/+ICm//iApz/4gKd/+ICnv/iAqH/4gACAGEACQKHAAAAEABUAB4AVQAeAFYAHgBYAB4AWQAeAF4AHgBfAB8AYQBGATsAPAFAAAABQgAqAUcAFQFbAB4BqQAPAmQAMgKHACgABQJGACgCYv/iAmP/2AJkAB4ChwAUAAMCRv+NAmL/4gJk/90AAQI1/9gABwFDAAABRAAAAU0AHgJG/+wCYv/WAmP/9gJk/+wAAwJG//YCZP/2Aof/+wADAZcAKAJkACgChwAoAAECRv+wAAUAYgAYAGMAGAJGAAoCZP/sAof/+wADAkYACgJk/+wCh//7AAICRgAPAmP/7AADAkYACgJj/+wCZAAAAAICRv/xAmT/9gACAkb/+wJk//cAAwJG//YCYv/nAmT/7AADAkYAAAJk/+wCh//2AAICRgAKAmQAAQACAkb/9gJk//sAAgJG//YCZP/xAAMCRgAUAmP/9gJkAAoAAQJG/84AAQKcAB4AAQKcABcAAgI6AAACRgAKABUBCQAR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HBgYDhYVGhVdISM+KCQuAQ8vFzQ7TD4yPSEKARIzL0JGJiItPBgRFAcjHyAkAh8hSDYqSDYeG1dERlU3KDUxPUA0LTYcDxMTIGgVEAYJBAotKh02Nz0kHh4OHCMqNywuITxHAAAGAGT/9wMYAp0AUQC3AW0DjwPOBEsAACUWFRQGBiMiJicmJicmJzU0JzQnNTQmNTU0NDU0NjMyFxYWFzY3NDMyNjM3NjYnJiY3NjYzMhYXFhYVFAYHBgYHBgYHFhYXFgcHNzc2NjMyFhcHMDcmJicWFhcmJicWFhcmJicWFyYmJxYWFyYmJxYWFyYmJxYWFyYmJxYWFyYnFhYXJiMmJicGBgcHMDIVNjY3JiYnFzY2NyYmJxYXNjY3JxYWFzcmJicWFhc3JicWFhc2MSYmJxYlFhYXJiYjBxYWFyYjFAYVFhcmJxUWFhcmJicGFRYXJiYnFRYXJiYnBxYWFyYmJxYXJicWFhcmJicWFhcmJicWFhcmJicWFhcmJicWFhcWFhcWFhcmJicWFhcmJicWFhczJiYnFhYXNyYnFhc1JicWFzUmJicWFhc2NSYnFhYXNSYmJxYXNDY1JicWFzcmJicWFzQ3JicWFzY1JicWFhc2NSYnFhc0NyYmJyYHBhQHFhYXJgcUBhMjBgcGBgc2NzYzMhYzFhYXJiMHIgYHIwYGBzY2NzI2FzIyFxYWFyYmByMiBwYjBgYHNjYzNjIzFjIXFhcmJgcjIgYHIgcGBzI2NzMWMhcWFhciJgcjIgcjBgc2MzYWMzIWMxYWFyYmByMiBgcGIwYGBzMyMjMyMhcWFhcmJgcjIgcjBgYHMjYXMxYWFxYWFyYmByMiBgcjBgYHMzIWMxcWFhciJgcjIgYHIwYGBzMWMhcWFjMWFhcmIiMjIgcwIgcGBgcyFjMyFhcyMhcWFhcmIiMjIgcjBgYHFjMWMhcXFhYXIzAwIyIiByMGBgcWMxYyFxcWFhcjMDAjIgcjBgYHIzIWMxcWFhcWFhcjIgYzIwYGByMyFhcXFjIXFhYXIyIGMyMiBgcjFhYXFhYXFhYXFhYXFhYXNhcXFhYXJicmJicmJyYmJxYWFxcWFhciJyYmJyYmJyYmJxYWFxYWFxcwIjUmJyYmJyYmJxYWFxYWFxYWFyYnJicmJxYWFxYWFxYWFyYmJyYnJiYnFxYWFxYWFyYmJyYmJyYm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) format('truetype');
}
</style>

  <style type="text/css">@charset "UTF-8";
:root,
[data-bs-theme=light] {
--bs-blue: #0d6efd;
--bs-indigo: #6610f2;
--bs-purple: #6f42c1;
--bs-pink: #d63384;
--bs-red: #dc3545;
--bs-orange: #fd7e14;
--bs-yellow: #ffc107;
--bs-green: #198754;
--bs-teal: #20c997;
--bs-cyan: #0dcaf0;
--bs-black: #000;
--bs-white: #fff;
--bs-gray: #6c757d;
--bs-gray-dark: #343a40;
--bs-gray-100: #f8f9fa;
--bs-gray-200: #e9ecef;
--bs-gray-300: #dee2e6;
--bs-gray-400: #ced4da;
--bs-gray-500: #adb5bd;
--bs-gray-600: #6c757d;
--bs-gray-700: #495057;
--bs-gray-800: #343a40;
--bs-gray-900: #212529;
--bs-primary: #0d6efd;
--bs-secondary: #6c757d;
--bs-success: #198754;
--bs-info: #0dcaf0;
--bs-warning: #ffc107;
--bs-danger: #dc3545;
--bs-light: #f8f9fa;
--bs-dark: #212529;
--bs-primary-rgb: 13, 110, 253;
--bs-secondary-rgb: 108, 117, 125;
--bs-success-rgb: 25, 135, 84;
--bs-info-rgb: 13, 202, 240;
--bs-warning-rgb: 255, 193, 7;
--bs-danger-rgb: 220, 53, 69;
--bs-light-rgb: 248, 249, 250;
--bs-dark-rgb: 33, 37, 41;
--bs-primary-text-emphasis: #052c65;
--bs-secondary-text-emphasis: #2b2f32;
--bs-success-text-emphasis: #0a3622;
--bs-info-text-emphasis: #055160;
--bs-warning-text-emphasis: #664d03;
--bs-danger-text-emphasis: #58151c;
--bs-light-text-emphasis: #495057;
--bs-dark-text-emphasis: #495057;
--bs-primary-bg-subtle: #cfe2ff;
--bs-secondary-bg-subtle: #e2e3e5;
--bs-success-bg-subtle: #d1e7dd;
--bs-info-bg-subtle: #cff4fc;
--bs-warning-bg-subtle: #fff3cd;
--bs-danger-bg-subtle: #f8d7da;
--bs-light-bg-subtle: #fcfcfd;
--bs-dark-bg-subtle: #ced4da;
--bs-primary-border-subtle: #9ec5fe;
--bs-secondary-border-subtle: #c4c8cb;
--bs-success-border-subtle: #a3cfbb;
--bs-info-border-subtle: #9eeaf9;
--bs-warning-border-subtle: #ffe69c;
--bs-danger-border-subtle: #f1aeb5;
--bs-light-border-subtle: #e9ecef;
--bs-dark-border-subtle: #adb5bd;
--bs-white-rgb: 255, 255, 255;
--bs-black-rgb: 0, 0, 0;
--bs-font-sans-serif: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", "Noto Sans", "Liberation Sans", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
--bs-font-monospace: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
--bs-gradient: linear-gradient(180deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0));
--bs-body-font-family: var(--bs-font-sans-serif);
--bs-body-font-size: 1.25rem;
--bs-body-font-weight: 400;
--bs-body-line-height: 1.75;
--bs-body-color: #212529;
--bs-body-color-rgb: 33, 37, 41;
--bs-body-bg: #fff;
--bs-body-bg-rgb: 255, 255, 255;
--bs-emphasis-color: #000;
--bs-emphasis-color-rgb: 0, 0, 0;
--bs-secondary-color: rgba(33, 37, 41, 0.75);
--bs-secondary-color-rgb: 33, 37, 41;
--bs-secondary-bg: #e9ecef;
--bs-secondary-bg-rgb: 233, 236, 239;
--bs-tertiary-color: rgba(33, 37, 41, 0.5);
--bs-tertiary-color-rgb: 33, 37, 41;
--bs-tertiary-bg: #f8f9fa;
--bs-tertiary-bg-rgb: 248, 249, 250;
--bs-heading-color: inherit;
--bs-link-color: #0d6efd;
--bs-link-color-rgb: 13, 110, 253;
--bs-link-decoration: underline;
--bs-link-hover-color: #0a58ca;
--bs-link-hover-color-rgb: 10, 88, 202;
--bs-code-color: #d63384;
--bs-highlight-color: #212529;
--bs-highlight-bg: #fff3cd;
--bs-border-width: 1px;
--bs-border-style: solid;
--bs-border-color: #dee2e6;
--bs-border-color-translucent: rgba(0, 0, 0, 0.175);
--bs-border-radius: 0.375rem;
--bs-border-radius-sm: 0.25rem;
--bs-border-radius-lg: 0.5rem;
--bs-border-radius-xl: 1rem;
--bs-border-radius-xxl: 2rem;
--bs-border-radius-2xl: var(--bs-border-radius-xxl);
--bs-border-radius-pill: 50rem;
--bs-box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
--bs-box-shadow-sm: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
--bs-box-shadow-lg: 0 1rem 3rem rgba(0, 0, 0, 0.175);
--bs-box-shadow-inset: inset 0 1px 2px rgba(0, 0, 0, 0.075);
--bs-focus-ring-width: 0.25rem;
--bs-focus-ring-opacity: 0.25;
--bs-focus-ring-color: rgba(13, 110, 253, 0.25);
--bs-form-valid-color: #198754;
--bs-form-valid-border-color: #198754;
--bs-form-invalid-color: #dc3545;
--bs-form-invalid-border-color: #dc3545;
}
[data-bs-theme=dark] {
color-scheme: dark;
--bs-body-color: #dee2e6;
--bs-body-color-rgb: 222, 226, 230;
--bs-body-bg: #212529;
--bs-body-bg-rgb: 33, 37, 41;
--bs-emphasis-color: #fff;
--bs-emphasis-color-rgb: 255, 255, 255;
--bs-secondary-color: rgba(222, 226, 230, 0.75);
--bs-secondary-color-rgb: 222, 226, 230;
--bs-secondary-bg: #343a40;
--bs-secondary-bg-rgb: 52, 58, 64;
--bs-tertiary-color: rgba(222, 226, 230, 0.5);
--bs-tertiary-color-rgb: 222, 226, 230;
--bs-tertiary-bg: #2b3035;
--bs-tertiary-bg-rgb: 43, 48, 53;
--bs-primary-text-emphasis: #6ea8fe;
--bs-secondary-text-emphasis: #a7acb1;
--bs-success-text-emphasis: #75b798;
--bs-info-text-emphasis: #6edff6;
--bs-warning-text-emphasis: #ffda6a;
--bs-danger-text-emphasis: #ea868f;
--bs-light-text-emphasis: #f8f9fa;
--bs-dark-text-emphasis: #dee2e6;
--bs-primary-bg-subtle: #031633;
--bs-secondary-bg-subtle: #161719;
--bs-success-bg-subtle: #051b11;
--bs-info-bg-subtle: #032830;
--bs-warning-bg-subtle: #332701;
--bs-danger-bg-subtle: #2c0b0e;
--bs-light-bg-subtle: #343a40;
--bs-dark-bg-subtle: #1a1d20;
--bs-primary-border-subtle: #084298;
--bs-secondary-border-subtle: #41464b;
--bs-success-border-subtle: #0f5132;
--bs-info-border-subtle: #087990;
--bs-warning-border-subtle: #997404;
--bs-danger-border-subtle: #842029;
--bs-light-border-subtle: #495057;
--bs-dark-border-subtle: #343a40;
--bs-heading-color: inherit;
--bs-link-color: #6ea8fe;
--bs-link-hover-color: #8bb9fe;
--bs-link-color-rgb: 110, 168, 254;
--bs-link-hover-color-rgb: 139, 185, 254;
--bs-code-color: #e685b5;
--bs-highlight-color: #dee2e6;
--bs-highlight-bg: #664d03;
--bs-border-color: #495057;
--bs-border-color-translucent: rgba(255, 255, 255, 0.15);
--bs-form-valid-color: #75b798;
--bs-form-valid-border-color: #75b798;
--bs-form-invalid-color: #ea868f;
--bs-form-invalid-border-color: #ea868f;
}
*,
*::before,
*::after {
box-sizing: border-box;
}
@media (prefers-reduced-motion: no-preference) {
:root {
scroll-behavior: smooth;
}
}
body {
margin: 0;
font-family: var(--bs-body-font-family);
font-size: var(--bs-body-font-size);
font-weight: var(--bs-body-font-weight);
line-height: var(--bs-body-line-height);
color: var(--bs-body-color);
text-align: var(--bs-body-text-align);
background-color: var(--bs-body-bg);
-webkit-text-size-adjust: 100%;
-webkit-tap-highlight-color: rgba(0, 0, 0, 0);
}
hr {
margin: 1rem 0;
color: inherit;
border: 0;
border-top: var(--bs-border-width) solid;
opacity: 0.25;
}
h6, .h6, h5, .h5, h4, .h4, h3, .h3, h2, .h2, h1, .h1 {
margin-top: 0;
margin-bottom: 0.5rem;
font-weight: 500;
line-height: 1.75;
color: var(--bs-heading-color);
}
h1, .h1 {
font-size: calc(1.375rem + 1.5vw);
}
@media (min-width: 1200px) {
h1, .h1 {
font-size: 2.5rem;
}
}
h2, .h2 {
font-size: calc(1.325rem + 0.9vw);
}
@media (min-width: 1200px) {
h2, .h2 {
font-size: 2rem;
}
}
h3, .h3 {
font-size: calc(1.3rem + 0.6vw);
}
@media (min-width: 1200px) {
h3, .h3 {
font-size: 1.75rem;
}
}
h4, .h4 {
font-size: calc(1.275rem + 0.3vw);
}
@media (min-width: 1200px) {
h4, .h4 {
font-size: 1.5rem;
}
}
h5, .h5 {
font-size: 1.25rem;
}
h6, .h6 {
font-size: 1rem;
}
p {
margin-top: 0;
margin-bottom: 1rem;
}
abbr[title] {
text-decoration: underline dotted;
cursor: help;
text-decoration-skip-ink: none;
}
address {
margin-bottom: 1rem;
font-style: normal;
line-height: inherit;
}
ol,
ul {
padding-left: 2rem;
}
ol,
ul,
dl {
margin-top: 0;
margin-bottom: 1rem;
}
ol ol,
ul ul,
ol ul,
ul ol {
margin-bottom: 0;
}
dt {
font-weight: 700;
}
dd {
margin-bottom: 0.5rem;
margin-left: 0;
}
blockquote {
margin: 0 0 1rem;
}
b,
strong {
font-weight: bolder;
}
small, .small {
font-size: 0.875em;
}
mark, .mark {
padding: 0.1875em;
color: var(--bs-highlight-color);
background-color: var(--bs-highlight-bg);
}
sub,
sup {
position: relative;
font-size: 0.75em;
line-height: 0;
vertical-align: baseline;
}
sub {
bottom: -0.25em;
}
sup {
top: -0.5em;
}
a {
color: rgba(var(--bs-link-color-rgb), var(--bs-link-opacity, 1));
text-decoration: underline;
}
a:hover {
--bs-link-color-rgb: var(--bs-link-hover-color-rgb);
}
a:not([href]):not([class]), a:not([href]):not([class]):hover {
color: inherit;
text-decoration: none;
}
pre,
code,
kbd,
samp {
font-family: var(--bs-font-monospace);
font-size: 1em;
}
pre {
display: block;
margin-top: 0;
margin-bottom: 1rem;
overflow: auto;
font-size: 0.875em;
}
pre code {
font-size: inherit;
color: inherit;
word-break: normal;
}
code {
font-size: 0.875em;
color: var(--bs-code-color);
word-wrap: break-word;
}
a > code {
color: inherit;
}
kbd {
padding: 0.1875rem 0.375rem;
font-size: 0.875em;
color: var(--bs-body-bg);
background-color: var(--bs-body-color);
border-radius: 0.25rem;
}
kbd kbd {
padding: 0;
font-size: 1em;
}
figure {
margin: 0 0 1rem;
}
img,
svg {
vertical-align: middle;
}
table {
caption-side: bottom;
border-collapse: collapse;
}
caption {
padding-top: 0.5rem;
padding-bottom: 0.5rem;
color: var(--bs-secondary-color);
text-align: left;
}
th {
text-align: inherit;
text-align: -webkit-match-parent;
}
thead,
tbody,
tfoot,
tr,
td,
th {
border-color: inherit;
border-style: solid;
border-width: 0;
}
label {
display: inline-block;
}
button {
border-radius: 0;
}
button:focus:not(:focus-visible) {
outline: 0;
}
input,
button,
select,
optgroup,
textarea {
margin: 0;
font-family: inherit;
font-size: inherit;
line-height: inherit;
}
button,
select {
text-transform: none;
}
[role=button] {
cursor: pointer;
}
select {
word-wrap: normal;
}
select:disabled {
opacity: 1;
}
[list]:not([type=date]):not([type=datetime-local]):not([type=month]):not([type=week]):not([type=time])::-webkit-calendar-picker-indicator {
display: none !important;
}
button,
[type=button],
[type=reset],
[type=submit] {
-webkit-appearance: button;
}
button:not(:disabled),
[type=button]:not(:disabled),
[type=reset]:not(:disabled),
[type=submit]:not(:disabled) {
cursor: pointer;
}
::-moz-focus-inner {
padding: 0;
border-style: none;
}
textarea {
resize: vertical;
}
fieldset {
min-width: 0;
padding: 0;
margin: 0;
border: 0;
}
legend {
float: left;
width: 100%;
padding: 0;
margin-bottom: 0.5rem;
font-size: calc(1.275rem + 0.3vw);
line-height: inherit;
}
@media (min-width: 1200px) {
legend {
font-size: 1.5rem;
}
}
legend + * {
clear: left;
}
::-webkit-datetime-edit-fields-wrapper,
::-webkit-datetime-edit-text,
::-webkit-datetime-edit-minute,
::-webkit-datetime-edit-hour-field,
::-webkit-datetime-edit-day-field,
::-webkit-datetime-edit-month-field,
::-webkit-datetime-edit-year-field {
padding: 0;
}
::-webkit-inner-spin-button {
height: auto;
}
[type=search] {
-webkit-appearance: textfield;
outline-offset: -2px;
}

::-webkit-search-decoration {
-webkit-appearance: none;
}
::-webkit-color-swatch-wrapper {
padding: 0;
}
::file-selector-button {
font: inherit;
-webkit-appearance: button;
}
output {
display: inline-block;
}
iframe {
border: 0;
}
summary {
display: list-item;
cursor: pointer;
}
progress {
vertical-align: baseline;
}
[hidden] {
display: none !important;
}
.lead {
font-size: 1.25rem;
font-weight: 300;
}
.display-1 {
font-size: calc(1.625rem + 4.5vw);
font-weight: 300;
line-height: 1.2;
}
@media (min-width: 1200px) {
.display-1 {
font-size: 5rem;
}
}
.display-2 {
font-size: calc(1.575rem + 3.9vw);
font-weight: 300;
line-height: 1.2;
}
@media (min-width: 1200px) {
.display-2 {
font-size: 4.5rem;
}
}
.display-3 {
font-size: calc(1.525rem + 3.3vw);
font-weight: 300;
line-height: 1.2;
}
@media (min-width: 1200px) {
.display-3 {
font-size: 4rem;
}
}
.display-4 {
font-size: calc(1.475rem + 2.7vw);
font-weight: 300;
line-height: 1.2;
}
@media (min-width: 1200px) {
.display-4 {
font-size: 3.5rem;
}
}
.display-5 {
font-size: calc(1.425rem + 2.1vw);
font-weight: 300;
line-height: 1.2;
}
@media (min-width: 1200px) {
.display-5 {
font-size: 3rem;
}
}
.display-6 {
font-size: calc(1.375rem + 1.5vw);
font-weight: 300;
line-height: 1.2;
}
@media (min-width: 1200px) {
.display-6 {
font-size: 2.5rem;
}
}
.list-unstyled {
padding-left: 0;
list-style: none;
}
.list-inline {
padding-left: 0;
list-style: none;
}
.list-inline-item {
display: inline-block;
}
.list-inline-item:not(:last-child) {
margin-right: 0.5rem;
}
.initialism {
font-size: 0.875em;
text-transform: uppercase;
}
.blockquote {
margin-bottom: 1rem;
font-size: 1.25rem;
}
.blockquote > :last-child {
margin-bottom: 0;
}
.blockquote-footer {
margin-top: -1rem;
margin-bottom: 1rem;
font-size: 0.875em;
color: #6c757d;
}
.blockquote-footer::before {
content: "— ";
}
.img-fluid {
max-width: 100%;
height: auto;
}
.img-thumbnail {
padding: 0.25rem;
background-color: var(--bs-body-bg);
border: var(--bs-border-width) solid var(--bs-border-color);
border-radius: var(--bs-border-radius);
max-width: 100%;
height: auto;
}
.figure {
display: inline-block;
}
.figure-img {
margin-bottom: 0.5rem;
line-height: 1;
}
.figure-caption {
font-size: 0.875em;
color: var(--bs-secondary-color);
}
.container,
.container-fluid,
.container-xxl,
.container-xl,
.container-lg,
.container-md,
.container-sm {
--bs-gutter-x: 1.5rem;
--bs-gutter-y: 0;
width: 100%;
padding-right: calc(var(--bs-gutter-x) * 0.5);
padding-left: calc(var(--bs-gutter-x) * 0.5);
margin-right: auto;
margin-left: auto;
}
@media (min-width: 576px) {
.container-sm, .container {
max-width: 540px;
}
}
@media (min-width: 768px) {
.container-md, .container-sm, .container {
max-width: 720px;
}
}
@media (min-width: 992px) {
.container-lg, .container-md, .container-sm, .container {
max-width: 960px;
}
}
@media (min-width: 1200px) {
.container-xl, .container-lg, .container-md, .container-sm, .container {
max-width: 1140px;
}
}
@media (min-width: 1400px) {
.container-xxl, .container-xl, .container-lg, .container-md, .container-sm, .container {
max-width: 1320px;
}
}
:root {
--bs-breakpoint-xs: 0;
--bs-breakpoint-sm: 576px;
--bs-breakpoint-md: 768px;
--bs-breakpoint-lg: 992px;
--bs-breakpoint-xl: 1200px;
--bs-breakpoint-xxl: 1400px;
}
.row {
--bs-gutter-x: 1.5rem;
--bs-gutter-y: 0;
display: flex;
flex-wrap: wrap;
margin-top: calc(-1 * var(--bs-gutter-y));
margin-right: calc(-0.5 * var(--bs-gutter-x));
margin-left: calc(-0.5 * var(--bs-gutter-x));
}
.row > * {
flex-shrink: 0;
width: 100%;
max-width: 100%;
padding-right: calc(var(--bs-gutter-x) * 0.5);
padding-left: calc(var(--bs-gutter-x) * 0.5);
margin-top: var(--bs-gutter-y);
}
.col {
flex: 1 0 0%;
}
.row-cols-auto > * {
flex: 0 0 auto;
width: auto;
}
.row-cols-1 > * {
flex: 0 0 auto;
width: 100%;
}
.row-cols-2 > * {
flex: 0 0 auto;
width: 50%;
}
.row-cols-3 > * {
flex: 0 0 auto;
width: 33.33333333%;
}
.row-cols-4 > * {
flex: 0 0 auto;
width: 25%;
}
.row-cols-5 > * {
flex: 0 0 auto;
width: 20%;
}
.row-cols-6 > * {
flex: 0 0 auto;
width: 16.66666667%;
}
.col-auto {
flex: 0 0 auto;
width: auto;
}
.col-1 {
flex: 0 0 auto;
width: 8.33333333%;
}
.col-2 {
flex: 0 0 auto;
width: 16.66666667%;
}
.col-3 {
flex: 0 0 auto;
width: 25%;
}
.col-4 {
flex: 0 0 auto;
width: 33.33333333%;
}
.col-5 {
flex: 0 0 auto;
width: 41.66666667%;
}
.col-6 {
flex: 0 0 auto;
width: 50%;
}
.col-7 {
flex: 0 0 auto;
width: 58.33333333%;
}
.col-8 {
flex: 0 0 auto;
width: 66.66666667%;
}
.col-9 {
flex: 0 0 auto;
width: 75%;
}
.col-10 {
flex: 0 0 auto;
width: 83.33333333%;
}
.col-11 {
flex: 0 0 auto;
width: 91.66666667%;
}
.col-12 {
flex: 0 0 auto;
width: 100%;
}
.offset-1 {
margin-left: 8.33333333%;
}
.offset-2 {
margin-left: 16.66666667%;
}
.offset-3 {
margin-left: 25%;
}
.offset-4 {
margin-left: 33.33333333%;
}
.offset-5 {
margin-left: 41.66666667%;
}
.offset-6 {
margin-left: 50%;
}
.offset-7 {
margin-left: 58.33333333%;
}
.offset-8 {
margin-left: 66.66666667%;
}
.offset-9 {
margin-left: 75%;
}
.offset-10 {
margin-left: 83.33333333%;
}
.offset-11 {
margin-left: 91.66666667%;
}
.g-0,
.gx-0 {
--bs-gutter-x: 0;
}
.g-0,
.gy-0 {
--bs-gutter-y: 0;
}
.g-1,
.gx-1 {
--bs-gutter-x: 0.25rem;
}
.g-1,
.gy-1 {
--bs-gutter-y: 0.25rem;
}
.g-2,
.gx-2 {
--bs-gutter-x: 0.5rem;
}
.g-2,
.gy-2 {
--bs-gutter-y: 0.5rem;
}
.g-3,
.gx-3 {
--bs-gutter-x: 1rem;
}
.g-3,
.gy-3 {
--bs-gutter-y: 1rem;
}
.g-4,
.gx-4 {
--bs-gutter-x: 1.5rem;
}
.g-4,
.gy-4 {
--bs-gutter-y: 1.5rem;
}
.g-5,
.gx-5 {
--bs-gutter-x: 3rem;
}
.g-5,
.gy-5 {
--bs-gutter-y: 3rem;
}
@media (min-width: 576px) {
.col-sm {
flex: 1 0 0%;
}
.row-cols-sm-auto > * {
flex: 0 0 auto;
width: auto;
}
.row-cols-sm-1 > * {
flex: 0 0 auto;
width: 100%;
}
.row-cols-sm-2 > * {
flex: 0 0 auto;
width: 50%;
}
.row-cols-sm-3 > * {
flex: 0 0 auto;
width: 33.33333333%;
}
.row-cols-sm-4 > * {
flex: 0 0 auto;
width: 25%;
}
.row-cols-sm-5 > * {
flex: 0 0 auto;
width: 20%;
}
.row-cols-sm-6 > * {
flex: 0 0 auto;
width: 16.66666667%;
}
.col-sm-auto {
flex: 0 0 auto;
width: auto;
}
.col-sm-1 {
flex: 0 0 auto;
width: 8.33333333%;
}
.col-sm-2 {
flex: 0 0 auto;
width: 16.66666667%;
}
.col-sm-3 {
flex: 0 0 auto;
width: 25%;
}
.col-sm-4 {
flex: 0 0 auto;
width: 33.33333333%;
}
.col-sm-5 {
flex: 0 0 auto;
width: 41.66666667%;
}
.col-sm-6 {
flex: 0 0 auto;
width: 50%;
}
.col-sm-7 {
flex: 0 0 auto;
width: 58.33333333%;
}
.col-sm-8 {
flex: 0 0 auto;
width: 66.66666667%;
}
.col-sm-9 {
flex: 0 0 auto;
width: 75%;
}
.col-sm-10 {
flex: 0 0 auto;
width: 83.33333333%;
}
.col-sm-11 {
flex: 0 0 auto;
width: 91.66666667%;
}
.col-sm-12 {
flex: 0 0 auto;
width: 100%;
}
.offset-sm-0 {
margin-left: 0;
}
.offset-sm-1 {
margin-left: 8.33333333%;
}
.offset-sm-2 {
margin-left: 16.66666667%;
}
.offset-sm-3 {
margin-left: 25%;
}
.offset-sm-4 {
margin-left: 33.33333333%;
}
.offset-sm-5 {
margin-left: 41.66666667%;
}
.offset-sm-6 {
margin-left: 50%;
}
.offset-sm-7 {
margin-left: 58.33333333%;
}
.offset-sm-8 {
margin-left: 66.66666667%;
}
.offset-sm-9 {
margin-left: 75%;
}
.offset-sm-10 {
margin-left: 83.33333333%;
}
.offset-sm-11 {
margin-left: 91.66666667%;
}
.g-sm-0,
.gx-sm-0 {
--bs-gutter-x: 0;
}
.g-sm-0,
.gy-sm-0 {
--bs-gutter-y: 0;
}
.g-sm-1,
.gx-sm-1 {
--bs-gutter-x: 0.25rem;
}
.g-sm-1,
.gy-sm-1 {
--bs-gutter-y: 0.25rem;
}
.g-sm-2,
.gx-sm-2 {
--bs-gutter-x: 0.5rem;
}
.g-sm-2,
.gy-sm-2 {
--bs-gutter-y: 0.5rem;
}
.g-sm-3,
.gx-sm-3 {
--bs-gutter-x: 1rem;
}
.g-sm-3,
.gy-sm-3 {
--bs-gutter-y: 1rem;
}
.g-sm-4,
.gx-sm-4 {
--bs-gutter-x: 1.5rem;
}
.g-sm-4,
.gy-sm-4 {
--bs-gutter-y: 1.5rem;
}
.g-sm-5,
.gx-sm-5 {
--bs-gutter-x: 3rem;
}
.g-sm-5,
.gy-sm-5 {
--bs-gutter-y: 3rem;
}
}
@media (min-width: 768px) {
.col-md {
flex: 1 0 0%;
}
.row-cols-md-auto > * {
flex: 0 0 auto;
width: auto;
}
.row-cols-md-1 > * {
flex: 0 0 auto;
width: 100%;
}
.row-cols-md-2 > * {
flex: 0 0 auto;
width: 50%;
}
.row-cols-md-3 > * {
flex: 0 0 auto;
width: 33.33333333%;
}
.row-cols-md-4 > * {
flex: 0 0 auto;
width: 25%;
}
.row-cols-md-5 > * {
flex: 0 0 auto;
width: 20%;
}
.row-cols-md-6 > * {
flex: 0 0 auto;
width: 16.66666667%;
}
.col-md-auto {
flex: 0 0 auto;
width: auto;
}
.col-md-1 {
flex: 0 0 auto;
width: 8.33333333%;
}
.col-md-2 {
flex: 0 0 auto;
width: 16.66666667%;
}
.col-md-3 {
flex: 0 0 auto;
width: 25%;
}
.col-md-4 {
flex: 0 0 auto;
width: 33.33333333%;
}
.col-md-5 {
flex: 0 0 auto;
width: 41.66666667%;
}
.col-md-6 {
flex: 0 0 auto;
width: 50%;
}
.col-md-7 {
flex: 0 0 auto;
width: 58.33333333%;
}
.col-md-8 {
flex: 0 0 auto;
width: 66.66666667%;
}
.col-md-9 {
flex: 0 0 auto;
width: 75%;
}
.col-md-10 {
flex: 0 0 auto;
width: 83.33333333%;
}
.col-md-11 {
flex: 0 0 auto;
width: 91.66666667%;
}
.col-md-12 {
flex: 0 0 auto;
width: 100%;
}
.offset-md-0 {
margin-left: 0;
}
.offset-md-1 {
margin-left: 8.33333333%;
}
.offset-md-2 {
margin-left: 16.66666667%;
}
.offset-md-3 {
margin-left: 25%;
}
.offset-md-4 {
margin-left: 33.33333333%;
}
.offset-md-5 {
margin-left: 41.66666667%;
}
.offset-md-6 {
margin-left: 50%;
}
.offset-md-7 {
margin-left: 58.33333333%;
}
.offset-md-8 {
margin-left: 66.66666667%;
}
.offset-md-9 {
margin-left: 75%;
}
.offset-md-10 {
margin-left: 83.33333333%;
}
.offset-md-11 {
margin-left: 91.66666667%;
}
.g-md-0,
.gx-md-0 {
--bs-gutter-x: 0;
}
.g-md-0,
.gy-md-0 {
--bs-gutter-y: 0;
}
.g-md-1,
.gx-md-1 {
--bs-gutter-x: 0.25rem;
}
.g-md-1,
.gy-md-1 {
--bs-gutter-y: 0.25rem;
}
.g-md-2,
.gx-md-2 {
--bs-gutter-x: 0.5rem;
}
.g-md-2,
.gy-md-2 {
--bs-gutter-y: 0.5rem;
}
.g-md-3,
.gx-md-3 {
--bs-gutter-x: 1rem;
}
.g-md-3,
.gy-md-3 {
--bs-gutter-y: 1rem;
}
.g-md-4,
.gx-md-4 {
--bs-gutter-x: 1.5rem;
}
.g-md-4,
.gy-md-4 {
--bs-gutter-y: 1.5rem;
}
.g-md-5,
.gx-md-5 {
--bs-gutter-x: 3rem;
}
.g-md-5,
.gy-md-5 {
--bs-gutter-y: 3rem;
}
}
@media (min-width: 992px) {
.col-lg {
flex: 1 0 0%;
}
.row-cols-lg-auto > * {
flex: 0 0 auto;
width: auto;
}
.row-cols-lg-1 > * {
flex: 0 0 auto;
width: 100%;
}
.row-cols-lg-2 > * {
flex: 0 0 auto;
width: 50%;
}
.row-cols-lg-3 > * {
flex: 0 0 auto;
width: 33.33333333%;
}
.row-cols-lg-4 > * {
flex: 0 0 auto;
width: 25%;
}
.row-cols-lg-5 > * {
flex: 0 0 auto;
width: 20%;
}
.row-cols-lg-6 > * {
flex: 0 0 auto;
width: 16.66666667%;
}
.col-lg-auto {
flex: 0 0 auto;
width: auto;
}
.col-lg-1 {
flex: 0 0 auto;
width: 8.33333333%;
}
.col-lg-2 {
flex: 0 0 auto;
width: 16.66666667%;
}
.col-lg-3 {
flex: 0 0 auto;
width: 25%;
}
.col-lg-4 {
flex: 0 0 auto;
width: 33.33333333%;
}
.col-lg-5 {
flex: 0 0 auto;
width: 41.66666667%;
}
.col-lg-6 {
flex: 0 0 auto;
width: 50%;
}
.col-lg-7 {
flex: 0 0 auto;
width: 58.33333333%;
}
.col-lg-8 {
flex: 0 0 auto;
width: 66.66666667%;
}
.col-lg-9 {
flex: 0 0 auto;
width: 75%;
}
.col-lg-10 {
flex: 0 0 auto;
width: 83.33333333%;
}
.col-lg-11 {
flex: 0 0 auto;
width: 91.66666667%;
}
.col-lg-12 {
flex: 0 0 auto;
width: 100%;
}
.offset-lg-0 {
margin-left: 0;
}
.offset-lg-1 {
margin-left: 8.33333333%;
}
.offset-lg-2 {
margin-left: 16.66666667%;
}
.offset-lg-3 {
margin-left: 25%;
}
.offset-lg-4 {
margin-left: 33.33333333%;
}
.offset-lg-5 {
margin-left: 41.66666667%;
}
.offset-lg-6 {
margin-left: 50%;
}
.offset-lg-7 {
margin-left: 58.33333333%;
}
.offset-lg-8 {
margin-left: 66.66666667%;
}
.offset-lg-9 {
margin-left: 75%;
}
.offset-lg-10 {
margin-left: 83.33333333%;
}
.offset-lg-11 {
margin-left: 91.66666667%;
}
.g-lg-0,
.gx-lg-0 {
--bs-gutter-x: 0;
}
.g-lg-0,
.gy-lg-0 {
--bs-gutter-y: 0;
}
.g-lg-1,
.gx-lg-1 {
--bs-gutter-x: 0.25rem;
}
.g-lg-1,
.gy-lg-1 {
--bs-gutter-y: 0.25rem;
}
.g-lg-2,
.gx-lg-2 {
--bs-gutter-x: 0.5rem;
}
.g-lg-2,
.gy-lg-2 {
--bs-gutter-y: 0.5rem;
}
.g-lg-3,
.gx-lg-3 {
--bs-gutter-x: 1rem;
}
.g-lg-3,
.gy-lg-3 {
--bs-gutter-y: 1rem;
}
.g-lg-4,
.gx-lg-4 {
--bs-gutter-x: 1.5rem;
}
.g-lg-4,
.gy-lg-4 {
--bs-gutter-y: 1.5rem;
}
.g-lg-5,
.gx-lg-5 {
--bs-gutter-x: 3rem;
}
.g-lg-5,
.gy-lg-5 {
--bs-gutter-y: 3rem;
}
}
@media (min-width: 1200px) {
.col-xl {
flex: 1 0 0%;
}
.row-cols-xl-auto > * {
flex: 0 0 auto;
width: auto;
}
.row-cols-xl-1 > * {
flex: 0 0 auto;
width: 100%;
}
.row-cols-xl-2 > * {
flex: 0 0 auto;
width: 50%;
}
.row-cols-xl-3 > * {
flex: 0 0 auto;
width: 33.33333333%;
}
.row-cols-xl-4 > * {
flex: 0 0 auto;
width: 25%;
}
.row-cols-xl-5 > * {
flex: 0 0 auto;
width: 20%;
}
.row-cols-xl-6 > * {
flex: 0 0 auto;
width: 16.66666667%;
}
.col-xl-auto {
flex: 0 0 auto;
width: auto;
}
.col-xl-1 {
flex: 0 0 auto;
width: 8.33333333%;
}
.col-xl-2 {
flex: 0 0 auto;
width: 16.66666667%;
}
.col-xl-3 {
flex: 0 0 auto;
width: 25%;
}
.col-xl-4 {
flex: 0 0 auto;
width: 33.33333333%;
}
.col-xl-5 {
flex: 0 0 auto;
width: 41.66666667%;
}
.col-xl-6 {
flex: 0 0 auto;
width: 50%;
}
.col-xl-7 {
flex: 0 0 auto;
width: 58.33333333%;
}
.col-xl-8 {
flex: 0 0 auto;
width: 66.66666667%;
}
.col-xl-9 {
flex: 0 0 auto;
width: 75%;
}
.col-xl-10 {
flex: 0 0 auto;
width: 83.33333333%;
}
.col-xl-11 {
flex: 0 0 auto;
width: 91.66666667%;
}
.col-xl-12 {
flex: 0 0 auto;
width: 100%;
}
.offset-xl-0 {
margin-left: 0;
}
.offset-xl-1 {
margin-left: 8.33333333%;
}
.offset-xl-2 {
margin-left: 16.66666667%;
}
.offset-xl-3 {
margin-left: 25%;
}
.offset-xl-4 {
margin-left: 33.33333333%;
}
.offset-xl-5 {
margin-left: 41.66666667%;
}
.offset-xl-6 {
margin-left: 50%;
}
.offset-xl-7 {
margin-left: 58.33333333%;
}
.offset-xl-8 {
margin-left: 66.66666667%;
}
.offset-xl-9 {
margin-left: 75%;
}
.offset-xl-10 {
margin-left: 83.33333333%;
}
.offset-xl-11 {
margin-left: 91.66666667%;
}
.g-xl-0,
.gx-xl-0 {
--bs-gutter-x: 0;
}
.g-xl-0,
.gy-xl-0 {
--bs-gutter-y: 0;
}
.g-xl-1,
.gx-xl-1 {
--bs-gutter-x: 0.25rem;
}
.g-xl-1,
.gy-xl-1 {
--bs-gutter-y: 0.25rem;
}
.g-xl-2,
.gx-xl-2 {
--bs-gutter-x: 0.5rem;
}
.g-xl-2,
.gy-xl-2 {
--bs-gutter-y: 0.5rem;
}
.g-xl-3,
.gx-xl-3 {
--bs-gutter-x: 1rem;
}
.g-xl-3,
.gy-xl-3 {
--bs-gutter-y: 1rem;
}
.g-xl-4,
.gx-xl-4 {
--bs-gutter-x: 1.5rem;
}
.g-xl-4,
.gy-xl-4 {
--bs-gutter-y: 1.5rem;
}
.g-xl-5,
.gx-xl-5 {
--bs-gutter-x: 3rem;
}
.g-xl-5,
.gy-xl-5 {
--bs-gutter-y: 3rem;
}
}
@media (min-width: 1400px) {
.col-xxl {
flex: 1 0 0%;
}
.row-cols-xxl-auto > * {
flex: 0 0 auto;
width: auto;
}
.row-cols-xxl-1 > * {
flex: 0 0 auto;
width: 100%;
}
.row-cols-xxl-2 > * {
flex: 0 0 auto;
width: 50%;
}
.row-cols-xxl-3 > * {
flex: 0 0 auto;
width: 33.33333333%;
}
.row-cols-xxl-4 > * {
flex: 0 0 auto;
width: 25%;
}
.row-cols-xxl-5 > * {
flex: 0 0 auto;
width: 20%;
}
.row-cols-xxl-6 > * {
flex: 0 0 auto;
width: 16.66666667%;
}
.col-xxl-auto {
flex: 0 0 auto;
width: auto;
}
.col-xxl-1 {
flex: 0 0 auto;
width: 8.33333333%;
}
.col-xxl-2 {
flex: 0 0 auto;
width: 16.66666667%;
}
.col-xxl-3 {
flex: 0 0 auto;
width: 25%;
}
.col-xxl-4 {
flex: 0 0 auto;
width: 33.33333333%;
}
.col-xxl-5 {
flex: 0 0 auto;
width: 41.66666667%;
}
.col-xxl-6 {
flex: 0 0 auto;
width: 50%;
}
.col-xxl-7 {
flex: 0 0 auto;
width: 58.33333333%;
}
.col-xxl-8 {
flex: 0 0 auto;
width: 66.66666667%;
}
.col-xxl-9 {
flex: 0 0 auto;
width: 75%;
}
.col-xxl-10 {
flex: 0 0 auto;
width: 83.33333333%;
}
.col-xxl-11 {
flex: 0 0 auto;
width: 91.66666667%;
}
.col-xxl-12 {
flex: 0 0 auto;
width: 100%;
}
.offset-xxl-0 {
margin-left: 0;
}
.offset-xxl-1 {
margin-left: 8.33333333%;
}
.offset-xxl-2 {
margin-left: 16.66666667%;
}
.offset-xxl-3 {
margin-left: 25%;
}
.offset-xxl-4 {
margin-left: 33.33333333%;
}
.offset-xxl-5 {
margin-left: 41.66666667%;
}
.offset-xxl-6 {
margin-left: 50%;
}
.offset-xxl-7 {
margin-left: 58.33333333%;
}
.offset-xxl-8 {
margin-left: 66.66666667%;
}
.offset-xxl-9 {
margin-left: 75%;
}
.offset-xxl-10 {
margin-left: 83.33333333%;
}
.offset-xxl-11 {
margin-left: 91.66666667%;
}
.g-xxl-0,
.gx-xxl-0 {
--bs-gutter-x: 0;
}
.g-xxl-0,
.gy-xxl-0 {
--bs-gutter-y: 0;
}
.g-xxl-1,
.gx-xxl-1 {
--bs-gutter-x: 0.25rem;
}
.g-xxl-1,
.gy-xxl-1 {
--bs-gutter-y: 0.25rem;
}
.g-xxl-2,
.gx-xxl-2 {
--bs-gutter-x: 0.5rem;
}
.g-xxl-2,
.gy-xxl-2 {
--bs-gutter-y: 0.5rem;
}
.g-xxl-3,
.gx-xxl-3 {
--bs-gutter-x: 1rem;
}
.g-xxl-3,
.gy-xxl-3 {
--bs-gutter-y: 1rem;
}
.g-xxl-4,
.gx-xxl-4 {
--bs-gutter-x: 1.5rem;
}
.g-xxl-4,
.gy-xxl-4 {
--bs-gutter-y: 1.5rem;
}
.g-xxl-5,
.gx-xxl-5 {
--bs-gutter-x: 3rem;
}
.g-xxl-5,
.gy-xxl-5 {
--bs-gutter-y: 3rem;
}
}
.clearfix::after {
display: block;
clear: both;
content: "";
}
.text-bg-primary {
color: #fff !important;
background-color: RGBA(var(--bs-primary-rgb), var(--bs-bg-opacity, 1)) !important;
}
.text-bg-secondary {
color: #fff !important;
background-color: RGBA(var(--bs-secondary-rgb), var(--bs-bg-opacity, 1)) !important;
}
.text-bg-success {
color: #fff !important;
background-color: RGBA(var(--bs-success-rgb), var(--bs-bg-opacity, 1)) !important;
}
.text-bg-info {
color: #000 !important;
background-color: RGBA(var(--bs-info-rgb), var(--bs-bg-opacity, 1)) !important;
}
.text-bg-warning {
color: #000 !important;
background-color: RGBA(var(--bs-warning-rgb), var(--bs-bg-opacity, 1)) !important;
}
.text-bg-danger {
color: #fff !important;
background-color: RGBA(var(--bs-danger-rgb), var(--bs-bg-opacity, 1)) !important;
}
.text-bg-light {
color: #000 !important;
background-color: RGBA(var(--bs-light-rgb), var(--bs-bg-opacity, 1)) !important;
}
.text-bg-dark {
color: #fff !important;
background-color: RGBA(var(--bs-dark-rgb), var(--bs-bg-opacity, 1)) !important;
}
.link-primary {
color: RGBA(var(--bs-primary-rgb), var(--bs-link-opacity, 1)) !important;
text-decoration-color: RGBA(var(--bs-primary-rgb), var(--bs-link-underline-opacity, 1)) !important;
}
.link-primary:hover, .link-primary:focus {
color: RGBA(10, 88, 202, var(--bs-link-opacity, 1)) !important;
text-decoration-color: RGBA(10, 88, 202, var(--bs-link-underline-opacity, 1)) !important;
}
.link-secondary {
color: RGBA(var(--bs-secondary-rgb), var(--bs-link-opacity, 1)) !important;
text-decoration-color: RGBA(var(--bs-secondary-rgb), var(--bs-link-underline-opacity, 1)) !important;
}
.link-secondary:hover, .link-secondary:focus {
color: RGBA(86, 94, 100, var(--bs-link-opacity, 1)) !important;
text-decoration-color: RGBA(86, 94, 100, var(--bs-link-underline-opacity, 1)) !important;
}
.link-success {
color: RGBA(var(--bs-success-rgb), var(--bs-link-opacity, 1)) !important;
text-decoration-color: RGBA(var(--bs-success-rgb), var(--bs-link-underline-opacity, 1)) !important;
}
.link-success:hover, .link-success:focus {
color: RGBA(20, 108, 67, var(--bs-link-opacity, 1)) !important;
text-decoration-color: RGBA(20, 108, 67, var(--bs-link-underline-opacity, 1)) !important;
}
.link-info {
color: RGBA(var(--bs-info-rgb), var(--bs-link-opacity, 1)) !important;
text-decoration-color: RGBA(var(--bs-info-rgb), var(--bs-link-underline-opacity, 1)) !important;
}
.link-info:hover, .link-info:focus {
color: RGBA(61, 213, 243, var(--bs-link-opacity, 1)) !important;
text-decoration-color: RGBA(61, 213, 243, var(--bs-link-underline-opacity, 1)) !important;
}
.link-warning {
color: RGBA(var(--bs-warning-rgb), var(--bs-link-opacity, 1)) !important;
text-decoration-color: RGBA(var(--bs-warning-rgb), var(--bs-link-underline-opacity, 1)) !important;
}
.link-warning:hover, .link-warning:focus {
color: RGBA(255, 205, 57, var(--bs-link-opacity, 1)) !important;
text-decoration-color: RGBA(255, 205, 57, var(--bs-link-underline-opacity, 1)) !important;
}
.link-danger {
color: RGBA(var(--bs-danger-rgb), var(--bs-link-opacity, 1)) !important;
text-decoration-color: RGBA(var(--bs-danger-rgb), var(--bs-link-underline-opacity, 1)) !important;
}
.link-danger:hover, .link-danger:focus {
color: RGBA(176, 42, 55, var(--bs-link-opacity, 1)) !important;
text-decoration-color: RGBA(176, 42, 55, var(--bs-link-underline-opacity, 1)) !important;
}
.link-light {
color: RGBA(var(--bs-light-rgb), var(--bs-link-opacity, 1)) !important;
text-decoration-color: RGBA(var(--bs-light-rgb), var(--bs-link-underline-opacity, 1)) !important;
}
.link-light:hover, .link-light:focus {
color: RGBA(249, 250, 251, var(--bs-link-opacity, 1)) !important;
text-decoration-color: RGBA(249, 250, 251, var(--bs-link-underline-opacity, 1)) !important;
}
.link-dark {
color: RGBA(var(--bs-dark-rgb), var(--bs-link-opacity, 1)) !important;
text-decoration-color: RGBA(var(--bs-dark-rgb), var(--bs-link-underline-opacity, 1)) !important;
}
.link-dark:hover, .link-dark:focus {
color: RGBA(26, 30, 33, var(--bs-link-opacity, 1)) !important;
text-decoration-color: RGBA(26, 30, 33, var(--bs-link-underline-opacity, 1)) !important;
}
.link-body-emphasis {
color: RGBA(var(--bs-emphasis-color-rgb), var(--bs-link-opacity, 1)) !important;
text-decoration-color: RGBA(var(--bs-emphasis-color-rgb), var(--bs-link-underline-opacity, 1)) !important;
}
.link-body-emphasis:hover, .link-body-emphasis:focus {
color: RGBA(var(--bs-emphasis-color-rgb), var(--bs-link-opacity, 0.75)) !important;
text-decoration-color: RGBA(var(--bs-emphasis-color-rgb), var(--bs-link-underline-opacity, 0.75)) !important;
}
.focus-ring:focus {
outline: 0;
box-shadow: var(--bs-focus-ring-x, 0) var(--bs-focus-ring-y, 0) var(--bs-focus-ring-blur, 0) var(--bs-focus-ring-width) var(--bs-focus-ring-color);
}
.icon-link {
display: inline-flex;
gap: 0.375rem;
align-items: center;
text-decoration-color: rgba(var(--bs-link-color-rgb), var(--bs-link-opacity, 0.5));
text-underline-offset: 0.25em;
backface-visibility: hidden;
}
.icon-link > .bi {
flex-shrink: 0;
width: 1em;
height: 1em;
fill: currentcolor;
transition: 0.2s ease-in-out transform;
}
@media (prefers-reduced-motion: reduce) {
.icon-link > .bi {
transition: none;
}
}
.icon-link-hover:hover > .bi, .icon-link-hover:focus-visible > .bi {
transform: var(--bs-icon-link-transform, translate3d(0.25em, 0, 0));
}
.ratio {
position: relative;
width: 100%;
}
.ratio::before {
display: block;
padding-top: var(--bs-aspect-ratio);
content: "";
}
.ratio > * {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
}
.ratio-1x1 {
--bs-aspect-ratio: 100%;
}
.ratio-4x3 {
--bs-aspect-ratio: 75%;
}
.ratio-16x9 {
--bs-aspect-ratio: 56.25%;
}
.ratio-21x9 {
--bs-aspect-ratio: 42.8571428571%;
}
.fixed-top {
position: fixed;
top: 0;
right: 0;
left: 0;
z-index: 1030;
}
.fixed-bottom {
position: fixed;
right: 0;
bottom: 0;
left: 0;
z-index: 1030;
}
.sticky-top {
position: sticky;
top: 0;
z-index: 1020;
}
.sticky-bottom {
position: sticky;
bottom: 0;
z-index: 1020;
}
@media (min-width: 576px) {
.sticky-sm-top {
position: sticky;
top: 0;
z-index: 1020;
}
.sticky-sm-bottom {
position: sticky;
bottom: 0;
z-index: 1020;
}
}
@media (min-width: 768px) {
.sticky-md-top {
position: sticky;
top: 0;
z-index: 1020;
}
.sticky-md-bottom {
position: sticky;
bottom: 0;
z-index: 1020;
}
}
@media (min-width: 992px) {
.sticky-lg-top {
position: sticky;
top: 0;
z-index: 1020;
}
.sticky-lg-bottom {
position: sticky;
bottom: 0;
z-index: 1020;
}
}
@media (min-width: 1200px) {
.sticky-xl-top {
position: sticky;
top: 0;
z-index: 1020;
}
.sticky-xl-bottom {
position: sticky;
bottom: 0;
z-index: 1020;
}
}
@media (min-width: 1400px) {
.sticky-xxl-top {
position: sticky;
top: 0;
z-index: 1020;
}
.sticky-xxl-bottom {
position: sticky;
bottom: 0;
z-index: 1020;
}
}
.hstack {
display: flex;
flex-direction: row;
align-items: center;
align-self: stretch;
}
.vstack {
display: flex;
flex: 1 1 auto;
flex-direction: column;
align-self: stretch;
}
.visually-hidden,
.visually-hidden-focusable:not(:focus):not(:focus-within) {
width: 1px !important;
height: 1px !important;
padding: 0 !important;
margin: -1px !important;
overflow: hidden !important;
clip: rect(0, 0, 0, 0) !important;
white-space: nowrap !important;
border: 0 !important;
}
.visually-hidden:not(caption),
.visually-hidden-focusable:not(:focus):not(:focus-within):not(caption) {
position: absolute !important;
}
.stretched-link::after {
position: absolute;
top: 0;
right: 0;
bottom: 0;
left: 0;
z-index: 1;
content: "";
}
.text-truncate {
overflow: hidden;
text-overflow: ellipsis;
white-space: nowrap;
}
.vr {
display: inline-block;
align-self: stretch;
width: var(--bs-border-width);
min-height: 1em;
background-color: currentcolor;
opacity: 0.25;
}
.align-baseline {
vertical-align: baseline !important;
}
.align-top {
vertical-align: top !important;
}
.align-middle {
vertical-align: middle !important;
}
.align-bottom {
vertical-align: bottom !important;
}
.align-text-bottom {
vertical-align: text-bottom !important;
}
.align-text-top {
vertical-align: text-top !important;
}
.float-start {
float: left !important;
}
.float-end {
float: right !important;
}
.float-none {
float: none !important;
}
.object-fit-contain {
object-fit: contain !important;
}
.object-fit-cover {
object-fit: cover !important;
}
.object-fit-fill {
object-fit: fill !important;
}
.object-fit-scale {
object-fit: scale-down !important;
}
.object-fit-none {
object-fit: none !important;
}
.opacity-0 {
opacity: 0 !important;
}
.opacity-25 {
opacity: 0.25 !important;
}
.opacity-50 {
opacity: 0.5 !important;
}
.opacity-75 {
opacity: 0.75 !important;
}
.opacity-100 {
opacity: 1 !important;
}
.overflow-auto {
overflow: auto !important;
}
.overflow-hidden {
overflow: hidden !important;
}
.overflow-visible {
overflow: visible !important;
}
.overflow-scroll {
overflow: scroll !important;
}
.overflow-x-auto {
overflow-x: auto !important;
}
.overflow-x-hidden {
overflow-x: hidden !important;
}
.overflow-x-visible {
overflow-x: visible !important;
}
.overflow-x-scroll {
overflow-x: scroll !important;
}
.overflow-y-auto {
overflow-y: auto !important;
}
.overflow-y-hidden {
overflow-y: hidden !important;
}
.overflow-y-visible {
overflow-y: visible !important;
}
.overflow-y-scroll {
overflow-y: scroll !important;
}
.d-inline {
display: inline !important;
}
.d-inline-block {
display: inline-block !important;
}
.d-block {
display: block !important;
}
.d-grid {
display: grid !important;
}
.d-inline-grid {
display: inline-grid !important;
}
.d-table {
display: table !important;
}
.d-table-row {
display: table-row !important;
}
.d-table-cell {
display: table-cell !important;
}
.d-flex {
display: flex !important;
}
.d-inline-flex {
display: inline-flex !important;
}
.d-none {
display: none !important;
}
.shadow {
box-shadow: var(--bs-box-shadow) !important;
}
.shadow-sm {
box-shadow: var(--bs-box-shadow-sm) !important;
}
.shadow-lg {
box-shadow: var(--bs-box-shadow-lg) !important;
}
.shadow-none {
box-shadow: none !important;
}
.focus-ring-primary {
--bs-focus-ring-color: rgba(var(--bs-primary-rgb), var(--bs-focus-ring-opacity));
}
.focus-ring-secondary {
--bs-focus-ring-color: rgba(var(--bs-secondary-rgb), var(--bs-focus-ring-opacity));
}
.focus-ring-success {
--bs-focus-ring-color: rgba(var(--bs-success-rgb), var(--bs-focus-ring-opacity));
}
.focus-ring-info {
--bs-focus-ring-color: rgba(var(--bs-info-rgb), var(--bs-focus-ring-opacity));
}
.focus-ring-warning {
--bs-focus-ring-color: rgba(var(--bs-warning-rgb), var(--bs-focus-ring-opacity));
}
.focus-ring-danger {
--bs-focus-ring-color: rgba(var(--bs-danger-rgb), var(--bs-focus-ring-opacity));
}
.focus-ring-light {
--bs-focus-ring-color: rgba(var(--bs-light-rgb), var(--bs-focus-ring-opacity));
}
.focus-ring-dark {
--bs-focus-ring-color: rgba(var(--bs-dark-rgb), var(--bs-focus-ring-opacity));
}
.position-static {
position: static !important;
}
.position-relative {
position: relative !important;
}
.position-absolute {
position: absolute !important;
}
.position-fixed {
position: fixed !important;
}
.position-sticky {
position: sticky !important;
}
.top-0 {
top: 0 !important;
}
.top-50 {
top: 50% !important;
}
.top-100 {
top: 100% !important;
}
.bottom-0 {
bottom: 0 !important;
}
.bottom-50 {
bottom: 50% !important;
}
.bottom-100 {
bottom: 100% !important;
}
.start-0 {
left: 0 !important;
}
.start-50 {
left: 50% !important;
}
.start-100 {
left: 100% !important;
}
.end-0 {
right: 0 !important;
}
.end-50 {
right: 50% !important;
}
.end-100 {
right: 100% !important;
}
.translate-middle {
transform: translate(-50%, -50%) !important;
}
.translate-middle-x {
transform: translateX(-50%) !important;
}
.translate-middle-y {
transform: translateY(-50%) !important;
}
.border {
border: var(--bs-border-width) var(--bs-border-style) var(--bs-border-color) !important;
}
.border-0 {
border: 0 !important;
}
.border-top {
border-top: var(--bs-border-width) var(--bs-border-style) var(--bs-border-color) !important;
}
.border-top-0 {
border-top: 0 !important;
}
.border-end {
border-right: var(--bs-border-width) var(--bs-border-style) var(--bs-border-color) !important;
}
.border-end-0 {
border-right: 0 !important;
}
.border-bottom {
border-bottom: var(--bs-border-width) var(--bs-border-style) var(--bs-border-color) !important;
}
.border-bottom-0 {
border-bottom: 0 !important;
}
.border-start {
border-left: var(--bs-border-width) var(--bs-border-style) var(--bs-border-color) !important;
}
.border-start-0 {
border-left: 0 !important;
}
.border-primary {
--bs-border-opacity: 1;
border-color: rgba(var(--bs-primary-rgb), var(--bs-border-opacity)) !important;
}
.border-secondary {
--bs-border-opacity: 1;
border-color: rgba(var(--bs-secondary-rgb), var(--bs-border-opacity)) !important;
}
.border-success {
--bs-border-opacity: 1;
border-color: rgba(var(--bs-success-rgb), var(--bs-border-opacity)) !important;
}
.border-info {
--bs-border-opacity: 1;
border-color: rgba(var(--bs-info-rgb), var(--bs-border-opacity)) !important;
}
.border-warning {
--bs-border-opacity: 1;
border-color: rgba(var(--bs-warning-rgb), var(--bs-border-opacity)) !important;
}
.border-danger {
--bs-border-opacity: 1;
border-color: rgba(var(--bs-danger-rgb), var(--bs-border-opacity)) !important;
}
.border-light {
--bs-border-opacity: 1;
border-color: rgba(var(--bs-light-rgb), var(--bs-border-opacity)) !important;
}
.border-dark {
--bs-border-opacity: 1;
border-color: rgba(var(--bs-dark-rgb), var(--bs-border-opacity)) !important;
}
.border-black {
--bs-border-opacity: 1;
border-color: rgba(var(--bs-black-rgb), var(--bs-border-opacity)) !important;
}
.border-white {
--bs-border-opacity: 1;
border-color: rgba(var(--bs-white-rgb), var(--bs-border-opacity)) !important;
}
.border-primary-subtle {
border-color: var(--bs-primary-border-subtle) !important;
}
.border-secondary-subtle {
border-color: var(--bs-secondary-border-subtle) !important;
}
.border-success-subtle {
border-color: var(--bs-success-border-subtle) !important;
}
.border-info-subtle {
border-color: var(--bs-info-border-subtle) !important;
}
.border-warning-subtle {
border-color: var(--bs-warning-border-subtle) !important;
}
.border-danger-subtle {
border-color: var(--bs-danger-border-subtle) !important;
}
.border-light-subtle {
border-color: var(--bs-light-border-subtle) !important;
}
.border-dark-subtle {
border-color: var(--bs-dark-border-subtle) !important;
}
.border-1 {
border-width: 1px !important;
}
.border-2 {
border-width: 2px !important;
}
.border-3 {
border-width: 3px !important;
}
.border-4 {
border-width: 4px !important;
}
.border-5 {
border-width: 5px !important;
}
.border-opacity-10 {
--bs-border-opacity: 0.1;
}
.border-opacity-25 {
--bs-border-opacity: 0.25;
}
.border-opacity-50 {
--bs-border-opacity: 0.5;
}
.border-opacity-75 {
--bs-border-opacity: 0.75;
}
.border-opacity-100 {
--bs-border-opacity: 1;
}
.w-25 {
width: 25% !important;
}
.w-50 {
width: 50% !important;
}
.w-75 {
width: 75% !important;
}
.w-100 {
width: 100% !important;
}
.w-auto {
width: auto !important;
}
.mw-100 {
max-width: 100% !important;
}
.vw-100 {
width: 100vw !important;
}
.min-vw-100 {
min-width: 100vw !important;
}
.h-25 {
height: 25% !important;
}
.h-50 {
height: 50% !important;
}
.h-75 {
height: 75% !important;
}
.h-100 {
height: 100% !important;
}
.h-auto {
height: auto !important;
}
.mh-100 {
max-height: 100% !important;
}
.vh-100 {
height: 100vh !important;
}
.min-vh-100 {
min-height: 100vh !important;
}
.flex-fill {
flex: 1 1 auto !important;
}
.flex-row {
flex-direction: row !important;
}
.flex-column {
flex-direction: column !important;
}
.flex-row-reverse {
flex-direction: row-reverse !important;
}
.flex-column-reverse {
flex-direction: column-reverse !important;
}
.flex-grow-0 {
flex-grow: 0 !important;
}
.flex-grow-1 {
flex-grow: 1 !important;
}
.flex-shrink-0 {
flex-shrink: 0 !important;
}
.flex-shrink-1 {
flex-shrink: 1 !important;
}
.flex-wrap {
flex-wrap: wrap !important;
}
.flex-nowrap {
flex-wrap: nowrap !important;
}
.flex-wrap-reverse {
flex-wrap: wrap-reverse !important;
}
.justify-content-start {
justify-content: flex-start !important;
}
.justify-content-end {
justify-content: flex-end !important;
}
.justify-content-center {
justify-content: center !important;
}
.justify-content-between {
justify-content: space-between !important;
}
.justify-content-around {
justify-content: space-around !important;
}
.justify-content-evenly {
justify-content: space-evenly !important;
}
.align-items-start {
align-items: flex-start !important;
}
.align-items-end {
align-items: flex-end !important;
}
.align-items-center {
align-items: center !important;
}
.align-items-baseline {
align-items: baseline !important;
}
.align-items-stretch {
align-items: stretch !important;
}
.align-content-start {
align-content: flex-start !important;
}
.align-content-end {
align-content: flex-end !important;
}
.align-content-center {
align-content: center !important;
}
.align-content-between {
align-content: space-between !important;
}
.align-content-around {
align-content: space-around !important;
}
.align-content-stretch {
align-content: stretch !important;
}
.align-self-auto {
align-self: auto !important;
}
.align-self-start {
align-self: flex-start !important;
}
.align-self-end {
align-self: flex-end !important;
}
.align-self-center {
align-self: center !important;
}
.align-self-baseline {
align-self: baseline !important;
}
.align-self-stretch {
align-self: stretch !important;
}
.order-first {
order: -1 !important;
}
.order-0 {
order: 0 !important;
}
.order-1 {
order: 1 !important;
}
.order-2 {
order: 2 !important;
}
.order-3 {
order: 3 !important;
}
.order-4 {
order: 4 !important;
}
.order-5 {
order: 5 !important;
}
.order-last {
order: 6 !important;
}
.m-0 {
margin: 0 !important;
}
.m-1 {
margin: 0.25rem !important;
}
.m-2 {
margin: 0.5rem !important;
}
.m-3 {
margin: 1rem !important;
}
.m-4 {
margin: 1.5rem !important;
}
.m-5 {
margin: 3rem !important;
}
.m-auto {
margin: auto !important;
}
.mx-0 {
margin-right: 0 !important;
margin-left: 0 !important;
}
.mx-1 {
margin-right: 0.25rem !important;
margin-left: 0.25rem !important;
}
.mx-2 {
margin-right: 0.5rem !important;
margin-left: 0.5rem !important;
}
.mx-3 {
margin-right: 1rem !important;
margin-left: 1rem !important;
}
.mx-4 {
margin-right: 1.5rem !important;
margin-left: 1.5rem !important;
}
.mx-5 {
margin-right: 3rem !important;
margin-left: 3rem !important;
}
.mx-auto {
margin-right: auto !important;
margin-left: auto !important;
}
.my-0 {
margin-top: 0 !important;
margin-bottom: 0 !important;
}
.my-1 {
margin-top: 0.25rem !important;
margin-bottom: 0.25rem !important;
}
.my-2 {
margin-top: 0.5rem !important;
margin-bottom: 0.5rem !important;
}
.my-3 {
margin-top: 1rem !important;
margin-bottom: 1rem !important;
}
.my-4 {
margin-top: 1.5rem !important;
margin-bottom: 1.5rem !important;
}
.my-5 {
margin-top: 3rem !important;
margin-bottom: 3rem !important;
}
.my-auto {
margin-top: auto !important;
margin-bottom: auto !important;
}
.mt-0 {
margin-top: 0 !important;
}
.mt-1 {
margin-top: 0.25rem !important;
}
.mt-2 {
margin-top: 0.5rem !important;
}
.mt-3 {
margin-top: 1rem !important;
}
.mt-4 {
margin-top: 1.5rem !important;
}
.mt-5 {
margin-top: 3rem !important;
}
.mt-auto {
margin-top: auto !important;
}
.me-0 {
margin-right: 0 !important;
}
.me-1 {
margin-right: 0.25rem !important;
}
.me-2 {
margin-right: 0.5rem !important;
}
.me-3 {
margin-right: 1rem !important;
}
.me-4 {
margin-right: 1.5rem !important;
}
.me-5 {
margin-right: 3rem !important;
}
.me-auto {
margin-right: auto !important;
}
.mb-0 {
margin-bottom: 0 !important;
}
.mb-1 {
margin-bottom: 0.25rem !important;
}
.mb-2 {
margin-bottom: 0.5rem !important;
}
.mb-3 {
margin-bottom: 1rem !important;
}
.mb-4 {
margin-bottom: 1.5rem !important;
}
.mb-5 {
margin-bottom: 3rem !important;
}
.mb-auto {
margin-bottom: auto !important;
}
.ms-0 {
margin-left: 0 !important;
}
.ms-1 {
margin-left: 0.25rem !important;
}
.ms-2 {
margin-left: 0.5rem !important;
}
.ms-3 {
margin-left: 1rem !important;
}
.ms-4 {
margin-left: 1.5rem !important;
}
.ms-5 {
margin-left: 3rem !important;
}
.ms-auto {
margin-left: auto !important;
}
.p-0 {
padding: 0 !important;
}
.p-1 {
padding: 0.25rem !important;
}
.p-2 {
padding: 0.5rem !important;
}
.p-3 {
padding: 1rem !important;
}
.p-4 {
padding: 1.5rem !important;
}
.p-5 {
padding: 3rem !important;
}
.px-0 {
padding-right: 0 !important;
padding-left: 0 !important;
}
.px-1 {
padding-right: 0.25rem !important;
padding-left: 0.25rem !important;
}
.px-2 {
padding-right: 0.5rem !important;
padding-left: 0.5rem !important;
}
.px-3 {
padding-right: 1rem !important;
padding-left: 1rem !important;
}
.px-4 {
padding-right: 1.5rem !important;
padding-left: 1.5rem !important;
}
.px-5 {
padding-right: 3rem !important;
padding-left: 3rem !important;
}
.py-0 {
padding-top: 0 !important;
padding-bottom: 0 !important;
}
.py-1 {
padding-top: 0.25rem !important;
padding-bottom: 0.25rem !important;
}
.py-2 {
padding-top: 0.5rem !important;
padding-bottom: 0.5rem !important;
}
.py-3 {
padding-top: 1rem !important;
padding-bottom: 1rem !important;
}
.py-4 {
padding-top: 1.5rem !important;
padding-bottom: 1.5rem !important;
}
.py-5 {
padding-top: 3rem !important;
padding-bottom: 3rem !important;
}
.pt-0 {
padding-top: 0 !important;
}
.pt-1 {
padding-top: 0.25rem !important;
}
.pt-2 {
padding-top: 0.5rem !important;
}
.pt-3 {
padding-top: 1rem !important;
}
.pt-4 {
padding-top: 1.5rem !important;
}
.pt-5 {
padding-top: 3rem !important;
}
.pe-0 {
padding-right: 0 !important;
}
.pe-1 {
padding-right: 0.25rem !important;
}
.pe-2 {
padding-right: 0.5rem !important;
}
.pe-3 {
padding-right: 1rem !important;
}
.pe-4 {
padding-right: 1.5rem !important;
}
.pe-5 {
padding-right: 3rem !important;
}
.pb-0 {
padding-bottom: 0 !important;
}
.pb-1 {
padding-bottom: 0.25rem !important;
}
.pb-2 {
padding-bottom: 0.5rem !important;
}
.pb-3 {
padding-bottom: 1rem !important;
}
.pb-4 {
padding-bottom: 1.5rem !important;
}
.pb-5 {
padding-bottom: 3rem !important;
}
.ps-0 {
padding-left: 0 !important;
}
.ps-1 {
padding-left: 0.25rem !important;
}
.ps-2 {
padding-left: 0.5rem !important;
}
.ps-3 {
padding-left: 1rem !important;
}
.ps-4 {
padding-left: 1.5rem !important;
}
.ps-5 {
padding-left: 3rem !important;
}
.gap-0 {
gap: 0 !important;
}
.gap-1 {
gap: 0.25rem !important;
}
.gap-2 {
gap: 0.5rem !important;
}
.gap-3 {
gap: 1rem !important;
}
.gap-4 {
gap: 1.5rem !important;
}
.gap-5 {
gap: 3rem !important;
}
.row-gap-0 {
row-gap: 0 !important;
}
.row-gap-1 {
row-gap: 0.25rem !important;
}
.row-gap-2 {
row-gap: 0.5rem !important;
}
.row-gap-3 {
row-gap: 1rem !important;
}
.row-gap-4 {
row-gap: 1.5rem !important;
}
.row-gap-5 {
row-gap: 3rem !important;
}
.column-gap-0 {
column-gap: 0 !important;
}
.column-gap-1 {
column-gap: 0.25rem !important;
}
.column-gap-2 {
column-gap: 0.5rem !important;
}
.column-gap-3 {
column-gap: 1rem !important;
}
.column-gap-4 {
column-gap: 1.5rem !important;
}
.column-gap-5 {
column-gap: 3rem !important;
}
.font-monospace {
font-family: var(--bs-font-monospace) !important;
}
.fs-1 {
font-size: calc(1.375rem + 1.5vw) !important;
}
.fs-2 {
font-size: calc(1.325rem + 0.9vw) !important;
}
.fs-3 {
font-size: calc(1.3rem + 0.6vw) !important;
}
.fs-4 {
font-size: calc(1.275rem + 0.3vw) !important;
}
.fs-5 {
font-size: 1.25rem !important;
}
.fs-6 {
font-size: 1rem !important;
}
.fst-italic {
font-style: italic !important;
}
.fst-normal {
font-style: normal !important;
}
.fw-lighter {
font-weight: lighter !important;
}
.fw-light {
font-weight: 300 !important;
}
.fw-normal {
font-weight: 400 !important;
}
.fw-medium {
font-weight: 500 !important;
}
.fw-semibold {
font-weight: 600 !important;
}
.fw-bold {
font-weight: 700 !important;
}
.fw-bolder {
font-weight: bolder !important;
}
.lh-1 {
line-height: 1 !important;
}
.lh-sm {
line-height: 1.25 !important;
}
.lh-base {
line-height: 1.75 !important;
}
.lh-lg {
line-height: 2 !important;
}
.text-start {
text-align: left !important;
}
.text-end {
text-align: right !important;
}
.text-center, article .solution .caption, article figure figcaption, article img figcaption {
text-align: center !important;
}
.text-decoration-none {
text-decoration: none !important;
}
.text-decoration-underline {
text-decoration: underline !important;
}
.text-decoration-line-through {
text-decoration: line-through !important;
}
.text-lowercase {
text-transform: lowercase !important;
}
.text-uppercase {
text-transform: uppercase !important;
}
.text-capitalize {
text-transform: capitalize !important;
}
.text-wrap {
white-space: normal !important;
}
.text-nowrap {
white-space: nowrap !important;
}

.text-break {
word-wrap: break-word !important;
word-break: break-word !important;
}

.text-primary {
--bs-text-opacity: 1;
color: rgba(var(--bs-primary-rgb), var(--bs-text-opacity)) !important;
}
.text-secondary {
--bs-text-opacity: 1;
color: rgba(var(--bs-secondary-rgb), var(--bs-text-opacity)) !important;
}
.text-success {
--bs-text-opacity: 1;
color: rgba(var(--bs-success-rgb), var(--bs-text-opacity)) !important;
}
.text-info {
--bs-text-opacity: 1;
color: rgba(var(--bs-info-rgb), var(--bs-text-opacity)) !important;
}
.text-warning {
--bs-text-opacity: 1;
color: rgba(var(--bs-warning-rgb), var(--bs-text-opacity)) !important;
}
.text-danger {
--bs-text-opacity: 1;
color: rgba(var(--bs-danger-rgb), var(--bs-text-opacity)) !important;
}
.text-light {
--bs-text-opacity: 1;
color: rgba(var(--bs-light-rgb), var(--bs-text-opacity)) !important;
}
.text-dark {
--bs-text-opacity: 1;
color: rgba(var(--bs-dark-rgb), var(--bs-text-opacity)) !important;
}
.text-black {
--bs-text-opacity: 1;
color: rgba(var(--bs-black-rgb), var(--bs-text-opacity)) !important;
}
.text-white {
--bs-text-opacity: 1;
color: rgba(var(--bs-white-rgb), var(--bs-text-opacity)) !important;
}
.text-body {
--bs-text-opacity: 1;
color: rgba(var(--bs-body-color-rgb), var(--bs-text-opacity)) !important;
}
.text-muted, article .solution .caption, article figure figcaption, article img figcaption {
--bs-text-opacity: 1;
color: var(--bs-secondary-color) !important;
}
.text-black-50 {
--bs-text-opacity: 1;
color: rgba(0, 0, 0, 0.5) !important;
}
.text-white-50 {
--bs-text-opacity: 1;
color: rgba(255, 255, 255, 0.5) !important;
}
.text-body-secondary {
--bs-text-opacity: 1;
color: var(--bs-secondary-color) !important;
}
.text-body-tertiary {
--bs-text-opacity: 1;
color: var(--bs-tertiary-color) !important;
}
.text-body-emphasis {
--bs-text-opacity: 1;
color: var(--bs-emphasis-color) !important;
}
.text-reset {
--bs-text-opacity: 1;
color: inherit !important;
}
.text-opacity-25 {
--bs-text-opacity: 0.25;
}
.text-opacity-50 {
--bs-text-opacity: 0.5;
}
.text-opacity-75 {
--bs-text-opacity: 0.75;
}
.text-opacity-100 {
--bs-text-opacity: 1;
}
.text-primary-emphasis {
color: var(--bs-primary-text-emphasis) !important;
}
.text-secondary-emphasis {
color: var(--bs-secondary-text-emphasis) !important;
}
.text-success-emphasis {
color: var(--bs-success-text-emphasis) !important;
}
.text-info-emphasis {
color: var(--bs-info-text-emphasis) !important;
}
.text-warning-emphasis {
color: var(--bs-warning-text-emphasis) !important;
}
.text-danger-emphasis {
color: var(--bs-danger-text-emphasis) !important;
}
.text-light-emphasis {
color: var(--bs-light-text-emphasis) !important;
}
.text-dark-emphasis {
color: var(--bs-dark-text-emphasis) !important;
}
.link-opacity-10 {
--bs-link-opacity: 0.1;
}
.link-opacity-10-hover:hover {
--bs-link-opacity: 0.1;
}
.link-opacity-25 {
--bs-link-opacity: 0.25;
}
.link-opacity-25-hover:hover {
--bs-link-opacity: 0.25;
}
.link-opacity-50 {
--bs-link-opacity: 0.5;
}
.link-opacity-50-hover:hover {
--bs-link-opacity: 0.5;
}
.link-opacity-75 {
--bs-link-opacity: 0.75;
}
.link-opacity-75-hover:hover {
--bs-link-opacity: 0.75;
}
.link-opacity-100 {
--bs-link-opacity: 1;
}
.link-opacity-100-hover:hover {
--bs-link-opacity: 1;
}
.link-offset-1 {
text-underline-offset: 0.125em !important;
}
.link-offset-1-hover:hover {
text-underline-offset: 0.125em !important;
}
.link-offset-2 {
text-underline-offset: 0.25em !important;
}
.link-offset-2-hover:hover {
text-underline-offset: 0.25em !important;
}
.link-offset-3 {
text-underline-offset: 0.375em !important;
}
.link-offset-3-hover:hover {
text-underline-offset: 0.375em !important;
}
.link-underline-primary {
--bs-link-underline-opacity: 1;
text-decoration-color: rgba(var(--bs-primary-rgb), var(--bs-link-underline-opacity)) !important;
}
.link-underline-secondary {
--bs-link-underline-opacity: 1;
text-decoration-color: rgba(var(--bs-secondary-rgb), var(--bs-link-underline-opacity)) !important;
}
.link-underline-success {
--bs-link-underline-opacity: 1;
text-decoration-color: rgba(var(--bs-success-rgb), var(--bs-link-underline-opacity)) !important;
}
.link-underline-info {
--bs-link-underline-opacity: 1;
text-decoration-color: rgba(var(--bs-info-rgb), var(--bs-link-underline-opacity)) !important;
}
.link-underline-warning {
--bs-link-underline-opacity: 1;
text-decoration-color: rgba(var(--bs-warning-rgb), var(--bs-link-underline-opacity)) !important;
}
.link-underline-danger {
--bs-link-underline-opacity: 1;
text-decoration-color: rgba(var(--bs-danger-rgb), var(--bs-link-underline-opacity)) !important;
}
.link-underline-light {
--bs-link-underline-opacity: 1;
text-decoration-color: rgba(var(--bs-light-rgb), var(--bs-link-underline-opacity)) !important;
}
.link-underline-dark {
--bs-link-underline-opacity: 1;
text-decoration-color: rgba(var(--bs-dark-rgb), var(--bs-link-underline-opacity)) !important;
}
.link-underline {
--bs-link-underline-opacity: 1;
text-decoration-color: rgba(var(--bs-link-color-rgb), var(--bs-link-underline-opacity, 1)) !important;
}
.link-underline-opacity-0 {
--bs-link-underline-opacity: 0;
}
.link-underline-opacity-0-hover:hover {
--bs-link-underline-opacity: 0;
}
.link-underline-opacity-10 {
--bs-link-underline-opacity: 0.1;
}
.link-underline-opacity-10-hover:hover {
--bs-link-underline-opacity: 0.1;
}
.link-underline-opacity-25 {
--bs-link-underline-opacity: 0.25;
}
.link-underline-opacity-25-hover:hover {
--bs-link-underline-opacity: 0.25;
}
.link-underline-opacity-50 {
--bs-link-underline-opacity: 0.5;
}
.link-underline-opacity-50-hover:hover {
--bs-link-underline-opacity: 0.5;
}
.link-underline-opacity-75 {
--bs-link-underline-opacity: 0.75;
}
.link-underline-opacity-75-hover:hover {
--bs-link-underline-opacity: 0.75;
}
.link-underline-opacity-100 {
--bs-link-underline-opacity: 1;
}
.link-underline-opacity-100-hover:hover {
--bs-link-underline-opacity: 1;
}
.bg-primary {
--bs-bg-opacity: 1;
background-color: rgba(var(--bs-primary-rgb), var(--bs-bg-opacity)) !important;
}
.bg-secondary {
--bs-bg-opacity: 1;
background-color: rgba(var(--bs-secondary-rgb), var(--bs-bg-opacity)) !important;
}
.bg-success {
--bs-bg-opacity: 1;
background-color: rgba(var(--bs-success-rgb), var(--bs-bg-opacity)) !important;
}
.bg-info {
--bs-bg-opacity: 1;
background-color: rgba(var(--bs-info-rgb), var(--bs-bg-opacity)) !important;
}
.bg-warning {
--bs-bg-opacity: 1;
background-color: rgba(var(--bs-warning-rgb), var(--bs-bg-opacity)) !important;
}
.bg-danger {
--bs-bg-opacity: 1;
background-color: rgba(var(--bs-danger-rgb), var(--bs-bg-opacity)) !important;
}
.bg-light {
--bs-bg-opacity: 1;
background-color: rgba(var(--bs-light-rgb), var(--bs-bg-opacity)) !important;
}
.bg-dark {
--bs-bg-opacity: 1;
background-color: rgba(var(--bs-dark-rgb), var(--bs-bg-opacity)) !important;
}
.bg-black {
--bs-bg-opacity: 1;
background-color: rgba(var(--bs-black-rgb), var(--bs-bg-opacity)) !important;
}
.bg-white {
--bs-bg-opacity: 1;
background-color: rgba(var(--bs-white-rgb), var(--bs-bg-opacity)) !important;
}
.bg-body {
--bs-bg-opacity: 1;
background-color: rgba(var(--bs-body-bg-rgb), var(--bs-bg-opacity)) !important;
}
.bg-transparent {
--bs-bg-opacity: 1;
background-color: transparent !important;
}
.bg-body-secondary {
--bs-bg-opacity: 1;
background-color: rgba(var(--bs-secondary-bg-rgb), var(--bs-bg-opacity)) !important;
}
.bg-body-tertiary {
--bs-bg-opacity: 1;
background-color: rgba(var(--bs-tertiary-bg-rgb), var(--bs-bg-opacity)) !important;
}
.bg-opacity-10 {
--bs-bg-opacity: 0.1;
}
.bg-opacity-25 {
--bs-bg-opacity: 0.25;
}
.bg-opacity-50 {
--bs-bg-opacity: 0.5;
}
.bg-opacity-75 {
--bs-bg-opacity: 0.75;
}
.bg-opacity-100 {
--bs-bg-opacity: 1;
}
.bg-primary-subtle {
background-color: var(--bs-primary-bg-subtle) !important;
}
.bg-secondary-subtle {
background-color: var(--bs-secondary-bg-subtle) !important;
}
.bg-success-subtle {
background-color: var(--bs-success-bg-subtle) !important;
}
.bg-info-subtle {
background-color: var(--bs-info-bg-subtle) !important;
}
.bg-warning-subtle {
background-color: var(--bs-warning-bg-subtle) !important;
}
.bg-danger-subtle {
background-color: var(--bs-danger-bg-subtle) !important;
}
.bg-light-subtle {
background-color: var(--bs-light-bg-subtle) !important;
}
.bg-dark-subtle {
background-color: var(--bs-dark-bg-subtle) !important;
}
.bg-gradient {
background-image: var(--bs-gradient) !important;
}
.user-select-all {
user-select: all !important;
}
.user-select-auto {
user-select: auto !important;
}
.user-select-none {
user-select: none !important;
}
.pe-none {
pointer-events: none !important;
}
.pe-auto {
pointer-events: auto !important;
}
.rounded {
border-radius: var(--bs-border-radius) !important;
}
.rounded-0 {
border-radius: 0 !important;
}
.rounded-1 {
border-radius: var(--bs-border-radius-sm) !important;
}
.rounded-2 {
border-radius: var(--bs-border-radius) !important;
}
.rounded-3 {
border-radius: var(--bs-border-radius-lg) !important;
}
.rounded-4 {
border-radius: var(--bs-border-radius-xl) !important;
}
.rounded-5 {
border-radius: var(--bs-border-radius-xxl) !important;
}
.rounded-circle {
border-radius: 50% !important;
}
.rounded-pill {
border-radius: var(--bs-border-radius-pill) !important;
}
.rounded-top {
border-top-left-radius: var(--bs-border-radius) !important;
border-top-right-radius: var(--bs-border-radius) !important;
}
.rounded-top-0 {
border-top-left-radius: 0 !important;
border-top-right-radius: 0 !important;
}
.rounded-top-1 {
border-top-left-radius: var(--bs-border-radius-sm) !important;
border-top-right-radius: var(--bs-border-radius-sm) !important;
}
.rounded-top-2 {
border-top-left-radius: var(--bs-border-radius) !important;
border-top-right-radius: var(--bs-border-radius) !important;
}
.rounded-top-3 {
border-top-left-radius: var(--bs-border-radius-lg) !important;
border-top-right-radius: var(--bs-border-radius-lg) !important;
}
.rounded-top-4 {
border-top-left-radius: var(--bs-border-radius-xl) !important;
border-top-right-radius: var(--bs-border-radius-xl) !important;
}
.rounded-top-5 {
border-top-left-radius: var(--bs-border-radius-xxl) !important;
border-top-right-radius: var(--bs-border-radius-xxl) !important;
}
.rounded-top-circle {
border-top-left-radius: 50% !important;
border-top-right-radius: 50% !important;
}
.rounded-top-pill {
border-top-left-radius: var(--bs-border-radius-pill) !important;
border-top-right-radius: var(--bs-border-radius-pill) !important;
}
.rounded-end {
border-top-right-radius: var(--bs-border-radius) !important;
border-bottom-right-radius: var(--bs-border-radius) !important;
}
.rounded-end-0 {
border-top-right-radius: 0 !important;
border-bottom-right-radius: 0 !important;
}
.rounded-end-1 {
border-top-right-radius: var(--bs-border-radius-sm) !important;
border-bottom-right-radius: var(--bs-border-radius-sm) !important;
}
.rounded-end-2 {
border-top-right-radius: var(--bs-border-radius) !important;
border-bottom-right-radius: var(--bs-border-radius) !important;
}
.rounded-end-3 {
border-top-right-radius: var(--bs-border-radius-lg) !important;
border-bottom-right-radius: var(--bs-border-radius-lg) !important;
}
.rounded-end-4 {
border-top-right-radius: var(--bs-border-radius-xl) !important;
border-bottom-right-radius: var(--bs-border-radius-xl) !important;
}
.rounded-end-5 {
border-top-right-radius: var(--bs-border-radius-xxl) !important;
border-bottom-right-radius: var(--bs-border-radius-xxl) !important;
}
.rounded-end-circle {
border-top-right-radius: 50% !important;
border-bottom-right-radius: 50% !important;
}
.rounded-end-pill {
border-top-right-radius: var(--bs-border-radius-pill) !important;
border-bottom-right-radius: var(--bs-border-radius-pill) !important;
}
.rounded-bottom {
border-bottom-right-radius: var(--bs-border-radius) !important;
border-bottom-left-radius: var(--bs-border-radius) !important;
}
.rounded-bottom-0 {
border-bottom-right-radius: 0 !important;
border-bottom-left-radius: 0 !important;
}
.rounded-bottom-1 {
border-bottom-right-radius: var(--bs-border-radius-sm) !important;
border-bottom-left-radius: var(--bs-border-radius-sm) !important;
}
.rounded-bottom-2 {
border-bottom-right-radius: var(--bs-border-radius) !important;
border-bottom-left-radius: var(--bs-border-radius) !important;
}
.rounded-bottom-3 {
border-bottom-right-radius: var(--bs-border-radius-lg) !important;
border-bottom-left-radius: var(--bs-border-radius-lg) !important;
}
.rounded-bottom-4 {
border-bottom-right-radius: var(--bs-border-radius-xl) !important;
border-bottom-left-radius: var(--bs-border-radius-xl) !important;
}
.rounded-bottom-5 {
border-bottom-right-radius: var(--bs-border-radius-xxl) !important;
border-bottom-left-radius: var(--bs-border-radius-xxl) !important;
}
.rounded-bottom-circle {
border-bottom-right-radius: 50% !important;
border-bottom-left-radius: 50% !important;
}
.rounded-bottom-pill {
border-bottom-right-radius: var(--bs-border-radius-pill) !important;
border-bottom-left-radius: var(--bs-border-radius-pill) !important;
}
.rounded-start {
border-bottom-left-radius: var(--bs-border-radius) !important;
border-top-left-radius: var(--bs-border-radius) !important;
}
.rounded-start-0 {
border-bottom-left-radius: 0 !important;
border-top-left-radius: 0 !important;
}
.rounded-start-1 {
border-bottom-left-radius: var(--bs-border-radius-sm) !important;
border-top-left-radius: var(--bs-border-radius-sm) !important;
}
.rounded-start-2 {
border-bottom-left-radius: var(--bs-border-radius) !important;
border-top-left-radius: var(--bs-border-radius) !important;
}
.rounded-start-3 {
border-bottom-left-radius: var(--bs-border-radius-lg) !important;
border-top-left-radius: var(--bs-border-radius-lg) !important;
}
.rounded-start-4 {
border-bottom-left-radius: var(--bs-border-radius-xl) !important;
border-top-left-radius: var(--bs-border-radius-xl) !important;
}
.rounded-start-5 {
border-bottom-left-radius: var(--bs-border-radius-xxl) !important;
border-top-left-radius: var(--bs-border-radius-xxl) !important;
}
.rounded-start-circle {
border-bottom-left-radius: 50% !important;
border-top-left-radius: 50% !important;
}
.rounded-start-pill {
border-bottom-left-radius: var(--bs-border-radius-pill) !important;
border-top-left-radius: var(--bs-border-radius-pill) !important;
}
.visible {
visibility: visible !important;
}
.invisible {
visibility: hidden !important;
}
.z-n1 {
z-index: -1 !important;
}
.z-0 {
z-index: 0 !important;
}
.z-1 {
z-index: 1 !important;
}
.z-2 {
z-index: 2 !important;
}
.z-3 {
z-index: 3 !important;
}
@media (min-width: 576px) {
.float-sm-start {
float: left !important;
}
.float-sm-end {
float: right !important;
}
.float-sm-none {
float: none !important;
}
.object-fit-sm-contain {
object-fit: contain !important;
}
.object-fit-sm-cover {
object-fit: cover !important;
}
.object-fit-sm-fill {
object-fit: fill !important;
}
.object-fit-sm-scale {
object-fit: scale-down !important;
}
.object-fit-sm-none {
object-fit: none !important;
}
.d-sm-inline {
display: inline !important;
}
.d-sm-inline-block {
display: inline-block !important;
}
.d-sm-block {
display: block !important;
}
.d-sm-grid {
display: grid !important;
}
.d-sm-inline-grid {
display: inline-grid !important;
}
.d-sm-table {
display: table !important;
}
.d-sm-table-row {
display: table-row !important;
}
.d-sm-table-cell {
display: table-cell !important;
}
.d-sm-flex {
display: flex !important;
}
.d-sm-inline-flex {
display: inline-flex !important;
}
.d-sm-none {
display: none !important;
}
.flex-sm-fill {
flex: 1 1 auto !important;
}
.flex-sm-row {
flex-direction: row !important;
}
.flex-sm-column {
flex-direction: column !important;
}
.flex-sm-row-reverse {
flex-direction: row-reverse !important;
}
.flex-sm-column-reverse {
flex-direction: column-reverse !important;
}
.flex-sm-grow-0 {
flex-grow: 0 !important;
}
.flex-sm-grow-1 {
flex-grow: 1 !important;
}
.flex-sm-shrink-0 {
flex-shrink: 0 !important;
}
.flex-sm-shrink-1 {
flex-shrink: 1 !important;
}
.flex-sm-wrap {
flex-wrap: wrap !important;
}
.flex-sm-nowrap {
flex-wrap: nowrap !important;
}
.flex-sm-wrap-reverse {
flex-wrap: wrap-reverse !important;
}
.justify-content-sm-start {
justify-content: flex-start !important;
}
.justify-content-sm-end {
justify-content: flex-end !important;
}
.justify-content-sm-center {
justify-content: center !important;
}
.justify-content-sm-between {
justify-content: space-between !important;
}
.justify-content-sm-around {
justify-content: space-around !important;
}
.justify-content-sm-evenly {
justify-content: space-evenly !important;
}
.align-items-sm-start {
align-items: flex-start !important;
}
.align-items-sm-end {
align-items: flex-end !important;
}
.align-items-sm-center {
align-items: center !important;
}
.align-items-sm-baseline {
align-items: baseline !important;
}
.align-items-sm-stretch {
align-items: stretch !important;
}
.align-content-sm-start {
align-content: flex-start !important;
}
.align-content-sm-end {
align-content: flex-end !important;
}
.align-content-sm-center {
align-content: center !important;
}
.align-content-sm-between {
align-content: space-between !important;
}
.align-content-sm-around {
align-content: space-around !important;
}
.align-content-sm-stretch {
align-content: stretch !important;
}
.align-self-sm-auto {
align-self: auto !important;
}
.align-self-sm-start {
align-self: flex-start !important;
}
.align-self-sm-end {
align-self: flex-end !important;
}
.align-self-sm-center {
align-self: center !important;
}
.align-self-sm-baseline {
align-self: baseline !important;
}
.align-self-sm-stretch {
align-self: stretch !important;
}
.order-sm-first {
order: -1 !important;
}
.order-sm-0 {
order: 0 !important;
}
.order-sm-1 {
order: 1 !important;
}
.order-sm-2 {
order: 2 !important;
}
.order-sm-3 {
order: 3 !important;
}
.order-sm-4 {
order: 4 !important;
}
.order-sm-5 {
order: 5 !important;
}
.order-sm-last {
order: 6 !important;
}
.m-sm-0 {
margin: 0 !important;
}
.m-sm-1 {
margin: 0.25rem !important;
}
.m-sm-2 {
margin: 0.5rem !important;
}
.m-sm-3 {
margin: 1rem !important;
}
.m-sm-4 {
margin: 1.5rem !important;
}
.m-sm-5 {
margin: 3rem !important;
}
.m-sm-auto {
margin: auto !important;
}
.mx-sm-0 {
margin-right: 0 !important;
margin-left: 0 !important;
}
.mx-sm-1 {
margin-right: 0.25rem !important;
margin-left: 0.25rem !important;
}
.mx-sm-2 {
margin-right: 0.5rem !important;
margin-left: 0.5rem !important;
}
.mx-sm-3 {
margin-right: 1rem !important;
margin-left: 1rem !important;
}
.mx-sm-4 {
margin-right: 1.5rem !important;
margin-left: 1.5rem !important;
}
.mx-sm-5 {
margin-right: 3rem !important;
margin-left: 3rem !important;
}
.mx-sm-auto {
margin-right: auto !important;
margin-left: auto !important;
}
.my-sm-0 {
margin-top: 0 !important;
margin-bottom: 0 !important;
}
.my-sm-1 {
margin-top: 0.25rem !important;
margin-bottom: 0.25rem !important;
}
.my-sm-2 {
margin-top: 0.5rem !important;
margin-bottom: 0.5rem !important;
}
.my-sm-3 {
margin-top: 1rem !important;
margin-bottom: 1rem !important;
}
.my-sm-4 {
margin-top: 1.5rem !important;
margin-bottom: 1.5rem !important;
}
.my-sm-5 {
margin-top: 3rem !important;
margin-bottom: 3rem !important;
}
.my-sm-auto {
margin-top: auto !important;
margin-bottom: auto !important;
}
.mt-sm-0 {
margin-top: 0 !important;
}
.mt-sm-1 {
margin-top: 0.25rem !important;
}
.mt-sm-2 {
margin-top: 0.5rem !important;
}
.mt-sm-3 {
margin-top: 1rem !important;
}
.mt-sm-4 {
margin-top: 1.5rem !important;
}
.mt-sm-5 {
margin-top: 3rem !important;
}
.mt-sm-auto {
margin-top: auto !important;
}
.me-sm-0 {
margin-right: 0 !important;
}
.me-sm-1 {
margin-right: 0.25rem !important;
}
.me-sm-2 {
margin-right: 0.5rem !important;
}
.me-sm-3 {
margin-right: 1rem !important;
}
.me-sm-4 {
margin-right: 1.5rem !important;
}
.me-sm-5 {
margin-right: 3rem !important;
}
.me-sm-auto {
margin-right: auto !important;
}
.mb-sm-0 {
margin-bottom: 0 !important;
}
.mb-sm-1 {
margin-bottom: 0.25rem !important;
}
.mb-sm-2 {
margin-bottom: 0.5rem !important;
}
.mb-sm-3 {
margin-bottom: 1rem !important;
}
.mb-sm-4 {
margin-bottom: 1.5rem !important;
}
.mb-sm-5 {
margin-bottom: 3rem !important;
}
.mb-sm-auto {
margin-bottom: auto !important;
}
.ms-sm-0 {
margin-left: 0 !important;
}
.ms-sm-1 {
margin-left: 0.25rem !important;
}
.ms-sm-2 {
margin-left: 0.5rem !important;
}
.ms-sm-3 {
margin-left: 1rem !important;
}
.ms-sm-4 {
margin-left: 1.5rem !important;
}
.ms-sm-5 {
margin-left: 3rem !important;
}
.ms-sm-auto {
margin-left: auto !important;
}
.p-sm-0 {
padding: 0 !important;
}
.p-sm-1 {
padding: 0.25rem !important;
}
.p-sm-2 {
padding: 0.5rem !important;
}
.p-sm-3 {
padding: 1rem !important;
}
.p-sm-4 {
padding: 1.5rem !important;
}
.p-sm-5 {
padding: 3rem !important;
}
.px-sm-0 {
padding-right: 0 !important;
padding-left: 0 !important;
}
.px-sm-1 {
padding-right: 0.25rem !important;
padding-left: 0.25rem !important;
}
.px-sm-2 {
padding-right: 0.5rem !important;
padding-left: 0.5rem !important;
}
.px-sm-3 {
padding-right: 1rem !important;
padding-left: 1rem !important;
}
.px-sm-4 {
padding-right: 1.5rem !important;
padding-left: 1.5rem !important;
}
.px-sm-5 {
padding-right: 3rem !important;
padding-left: 3rem !important;
}
.py-sm-0 {
padding-top: 0 !important;
padding-bottom: 0 !important;
}
.py-sm-1 {
padding-top: 0.25rem !important;
padding-bottom: 0.25rem !important;
}
.py-sm-2 {
padding-top: 0.5rem !important;
padding-bottom: 0.5rem !important;
}
.py-sm-3 {
padding-top: 1rem !important;
padding-bottom: 1rem !important;
}
.py-sm-4 {
padding-top: 1.5rem !important;
padding-bottom: 1.5rem !important;
}
.py-sm-5 {
padding-top: 3rem !important;
padding-bottom: 3rem !important;
}
.pt-sm-0 {
padding-top: 0 !important;
}
.pt-sm-1 {
padding-top: 0.25rem !important;
}
.pt-sm-2 {
padding-top: 0.5rem !important;
}
.pt-sm-3 {
padding-top: 1rem !important;
}
.pt-sm-4 {
padding-top: 1.5rem !important;
}
.pt-sm-5 {
padding-top: 3rem !important;
}
.pe-sm-0 {
padding-right: 0 !important;
}
.pe-sm-1 {
padding-right: 0.25rem !important;
}
.pe-sm-2 {
padding-right: 0.5rem !important;
}
.pe-sm-3 {
padding-right: 1rem !important;
}
.pe-sm-4 {
padding-right: 1.5rem !important;
}
.pe-sm-5 {
padding-right: 3rem !important;
}
.pb-sm-0 {
padding-bottom: 0 !important;
}
.pb-sm-1 {
padding-bottom: 0.25rem !important;
}
.pb-sm-2 {
padding-bottom: 0.5rem !important;
}
.pb-sm-3 {
padding-bottom: 1rem !important;
}
.pb-sm-4 {
padding-bottom: 1.5rem !important;
}
.pb-sm-5 {
padding-bottom: 3rem !important;
}
.ps-sm-0 {
padding-left: 0 !important;
}
.ps-sm-1 {
padding-left: 0.25rem !important;
}
.ps-sm-2 {
padding-left: 0.5rem !important;
}
.ps-sm-3 {
padding-left: 1rem !important;
}
.ps-sm-4 {
padding-left: 1.5rem !important;
}
.ps-sm-5 {
padding-left: 3rem !important;
}
.gap-sm-0 {
gap: 0 !important;
}
.gap-sm-1 {
gap: 0.25rem !important;
}
.gap-sm-2 {
gap: 0.5rem !important;
}
.gap-sm-3 {
gap: 1rem !important;
}
.gap-sm-4 {
gap: 1.5rem !important;
}
.gap-sm-5 {
gap: 3rem !important;
}
.row-gap-sm-0 {
row-gap: 0 !important;
}
.row-gap-sm-1 {
row-gap: 0.25rem !important;
}
.row-gap-sm-2 {
row-gap: 0.5rem !important;
}
.row-gap-sm-3 {
row-gap: 1rem !important;
}
.row-gap-sm-4 {
row-gap: 1.5rem !important;
}
.row-gap-sm-5 {
row-gap: 3rem !important;
}
.column-gap-sm-0 {
column-gap: 0 !important;
}
.column-gap-sm-1 {
column-gap: 0.25rem !important;
}
.column-gap-sm-2 {
column-gap: 0.5rem !important;
}
.column-gap-sm-3 {
column-gap: 1rem !important;
}
.column-gap-sm-4 {
column-gap: 1.5rem !important;
}
.column-gap-sm-5 {
column-gap: 3rem !important;
}
.text-sm-start {
text-align: left !important;
}
.text-sm-end {
text-align: right !important;
}
.text-sm-center {
text-align: center !important;
}
}
@media (min-width: 768px) {
.float-md-start {
float: left !important;
}
.float-md-end {
float: right !important;
}
.float-md-none {
float: none !important;
}
.object-fit-md-contain {
object-fit: contain !important;
}
.object-fit-md-cover {
object-fit: cover !important;
}
.object-fit-md-fill {
object-fit: fill !important;
}
.object-fit-md-scale {
object-fit: scale-down !important;
}
.object-fit-md-none {
object-fit: none !important;
}
.d-md-inline {
display: inline !important;
}
.d-md-inline-block {
display: inline-block !important;
}
.d-md-block {
display: block !important;
}
.d-md-grid {
display: grid !important;
}
.d-md-inline-grid {
display: inline-grid !important;
}
.d-md-table {
display: table !important;
}
.d-md-table-row {
display: table-row !important;
}
.d-md-table-cell {
display: table-cell !important;
}
.d-md-flex {
display: flex !important;
}
.d-md-inline-flex {
display: inline-flex !important;
}
.d-md-none {
display: none !important;
}
.flex-md-fill {
flex: 1 1 auto !important;
}
.flex-md-row {
flex-direction: row !important;
}
.flex-md-column {
flex-direction: column !important;
}
.flex-md-row-reverse {
flex-direction: row-reverse !important;
}
.flex-md-column-reverse {
flex-direction: column-reverse !important;
}
.flex-md-grow-0 {
flex-grow: 0 !important;
}
.flex-md-grow-1 {
flex-grow: 1 !important;
}
.flex-md-shrink-0 {
flex-shrink: 0 !important;
}
.flex-md-shrink-1 {
flex-shrink: 1 !important;
}
.flex-md-wrap {
flex-wrap: wrap !important;
}
.flex-md-nowrap {
flex-wrap: nowrap !important;
}
.flex-md-wrap-reverse {
flex-wrap: wrap-reverse !important;
}
.justify-content-md-start {
justify-content: flex-start !important;
}
.justify-content-md-end {
justify-content: flex-end !important;
}
.justify-content-md-center {
justify-content: center !important;
}
.justify-content-md-between {
justify-content: space-between !important;
}
.justify-content-md-around {
justify-content: space-around !important;
}
.justify-content-md-evenly {
justify-content: space-evenly !important;
}
.align-items-md-start {
align-items: flex-start !important;
}
.align-items-md-end {
align-items: flex-end !important;
}
.align-items-md-center {
align-items: center !important;
}
.align-items-md-baseline {
align-items: baseline !important;
}
.align-items-md-stretch {
align-items: stretch !important;
}
.align-content-md-start {
align-content: flex-start !important;
}
.align-content-md-end {
align-content: flex-end !important;
}
.align-content-md-center {
align-content: center !important;
}
.align-content-md-between {
align-content: space-between !important;
}
.align-content-md-around {
align-content: space-around !important;
}
.align-content-md-stretch {
align-content: stretch !important;
}
.align-self-md-auto {
align-self: auto !important;
}
.align-self-md-start {
align-self: flex-start !important;
}
.align-self-md-end {
align-self: flex-end !important;
}
.align-self-md-center {
align-self: center !important;
}
.align-self-md-baseline {
align-self: baseline !important;
}
.align-self-md-stretch {
align-self: stretch !important;
}
.order-md-first {
order: -1 !important;
}
.order-md-0 {
order: 0 !important;
}
.order-md-1 {
order: 1 !important;
}
.order-md-2 {
order: 2 !important;
}
.order-md-3 {
order: 3 !important;
}
.order-md-4 {
order: 4 !important;
}
.order-md-5 {
order: 5 !important;
}
.order-md-last {
order: 6 !important;
}
.m-md-0 {
margin: 0 !important;
}
.m-md-1 {
margin: 0.25rem !important;
}
.m-md-2 {
margin: 0.5rem !important;
}
.m-md-3 {
margin: 1rem !important;
}
.m-md-4 {
margin: 1.5rem !important;
}
.m-md-5 {
margin: 3rem !important;
}
.m-md-auto {
margin: auto !important;
}
.mx-md-0 {
margin-right: 0 !important;
margin-left: 0 !important;
}
.mx-md-1 {
margin-right: 0.25rem !important;
margin-left: 0.25rem !important;
}
.mx-md-2 {
margin-right: 0.5rem !important;
margin-left: 0.5rem !important;
}
.mx-md-3 {
margin-right: 1rem !important;
margin-left: 1rem !important;
}
.mx-md-4 {
margin-right: 1.5rem !important;
margin-left: 1.5rem !important;
}
.mx-md-5 {
margin-right: 3rem !important;
margin-left: 3rem !important;
}
.mx-md-auto {
margin-right: auto !important;
margin-left: auto !important;
}
.my-md-0 {
margin-top: 0 !important;
margin-bottom: 0 !important;
}
.my-md-1 {
margin-top: 0.25rem !important;
margin-bottom: 0.25rem !important;
}
.my-md-2 {
margin-top: 0.5rem !important;
margin-bottom: 0.5rem !important;
}
.my-md-3 {
margin-top: 1rem !important;
margin-bottom: 1rem !important;
}
.my-md-4 {
margin-top: 1.5rem !important;
margin-bottom: 1.5rem !important;
}
.my-md-5 {
margin-top: 3rem !important;
margin-bottom: 3rem !important;
}
.my-md-auto {
margin-top: auto !important;
margin-bottom: auto !important;
}
.mt-md-0 {
margin-top: 0 !important;
}
.mt-md-1 {
margin-top: 0.25rem !important;
}
.mt-md-2 {
margin-top: 0.5rem !important;
}
.mt-md-3 {
margin-top: 1rem !important;
}
.mt-md-4 {
margin-top: 1.5rem !important;
}
.mt-md-5 {
margin-top: 3rem !important;
}
.mt-md-auto {
margin-top: auto !important;
}
.me-md-0 {
margin-right: 0 !important;
}
.me-md-1 {
margin-right: 0.25rem !important;
}
.me-md-2 {
margin-right: 0.5rem !important;
}
.me-md-3 {
margin-right: 1rem !important;
}
.me-md-4 {
margin-right: 1.5rem !important;
}
.me-md-5 {
margin-right: 3rem !important;
}
.me-md-auto {
margin-right: auto !important;
}
.mb-md-0 {
margin-bottom: 0 !important;
}
.mb-md-1 {
margin-bottom: 0.25rem !important;
}
.mb-md-2 {
margin-bottom: 0.5rem !important;
}
.mb-md-3 {
margin-bottom: 1rem !important;
}
.mb-md-4 {
margin-bottom: 1.5rem !important;
}
.mb-md-5 {
margin-bottom: 3rem !important;
}
.mb-md-auto {
margin-bottom: auto !important;
}
.ms-md-0 {
margin-left: 0 !important;
}
.ms-md-1 {
margin-left: 0.25rem !important;
}
.ms-md-2 {
margin-left: 0.5rem !important;
}
.ms-md-3 {
margin-left: 1rem !important;
}
.ms-md-4 {
margin-left: 1.5rem !important;
}
.ms-md-5 {
margin-left: 3rem !important;
}
.ms-md-auto {
margin-left: auto !important;
}
.p-md-0 {
padding: 0 !important;
}
.p-md-1 {
padding: 0.25rem !important;
}
.p-md-2 {
padding: 0.5rem !important;
}
.p-md-3 {
padding: 1rem !important;
}
.p-md-4 {
padding: 1.5rem !important;
}
.p-md-5 {
padding: 3rem !important;
}
.px-md-0 {
padding-right: 0 !important;
padding-left: 0 !important;
}
.px-md-1 {
padding-right: 0.25rem !important;
padding-left: 0.25rem !important;
}
.px-md-2 {
padding-right: 0.5rem !important;
padding-left: 0.5rem !important;
}
.px-md-3 {
padding-right: 1rem !important;
padding-left: 1rem !important;
}
.px-md-4 {
padding-right: 1.5rem !important;
padding-left: 1.5rem !important;
}
.px-md-5 {
padding-right: 3rem !important;
padding-left: 3rem !important;
}
.py-md-0 {
padding-top: 0 !important;
padding-bottom: 0 !important;
}
.py-md-1 {
padding-top: 0.25rem !important;
padding-bottom: 0.25rem !important;
}
.py-md-2 {
padding-top: 0.5rem !important;
padding-bottom: 0.5rem !important;
}
.py-md-3 {
padding-top: 1rem !important;
padding-bottom: 1rem !important;
}
.py-md-4 {
padding-top: 1.5rem !important;
padding-bottom: 1.5rem !important;
}
.py-md-5 {
padding-top: 3rem !important;
padding-bottom: 3rem !important;
}
.pt-md-0 {
padding-top: 0 !important;
}
.pt-md-1 {
padding-top: 0.25rem !important;
}
.pt-md-2 {
padding-top: 0.5rem !important;
}
.pt-md-3 {
padding-top: 1rem !important;
}
.pt-md-4 {
padding-top: 1.5rem !important;
}
.pt-md-5 {
padding-top: 3rem !important;
}
.pe-md-0 {
padding-right: 0 !important;
}
.pe-md-1 {
padding-right: 0.25rem !important;
}
.pe-md-2 {
padding-right: 0.5rem !important;
}
.pe-md-3 {
padding-right: 1rem !important;
}
.pe-md-4 {
padding-right: 1.5rem !important;
}
.pe-md-5 {
padding-right: 3rem !important;
}
.pb-md-0 {
padding-bottom: 0 !important;
}
.pb-md-1 {
padding-bottom: 0.25rem !important;
}
.pb-md-2 {
padding-bottom: 0.5rem !important;
}
.pb-md-3 {
padding-bottom: 1rem !important;
}
.pb-md-4 {
padding-bottom: 1.5rem !important;
}
.pb-md-5 {
padding-bottom: 3rem !important;
}
.ps-md-0 {
padding-left: 0 !important;
}
.ps-md-1 {
padding-left: 0.25rem !important;
}
.ps-md-2 {
padding-left: 0.5rem !important;
}
.ps-md-3 {
padding-left: 1rem !important;
}
.ps-md-4 {
padding-left: 1.5rem !important;
}
.ps-md-5 {
padding-left: 3rem !important;
}
.gap-md-0 {
gap: 0 !important;
}
.gap-md-1 {
gap: 0.25rem !important;
}
.gap-md-2 {
gap: 0.5rem !important;
}
.gap-md-3 {
gap: 1rem !important;
}
.gap-md-4 {
gap: 1.5rem !important;
}
.gap-md-5 {
gap: 3rem !important;
}
.row-gap-md-0 {
row-gap: 0 !important;
}
.row-gap-md-1 {
row-gap: 0.25rem !important;
}
.row-gap-md-2 {
row-gap: 0.5rem !important;
}
.row-gap-md-3 {
row-gap: 1rem !important;
}
.row-gap-md-4 {
row-gap: 1.5rem !important;
}
.row-gap-md-5 {
row-gap: 3rem !important;
}
.column-gap-md-0 {
column-gap: 0 !important;
}
.column-gap-md-1 {
column-gap: 0.25rem !important;
}
.column-gap-md-2 {
column-gap: 0.5rem !important;
}
.column-gap-md-3 {
column-gap: 1rem !important;
}
.column-gap-md-4 {
column-gap: 1.5rem !important;
}
.column-gap-md-5 {
column-gap: 3rem !important;
}
.text-md-start {
text-align: left !important;
}
.text-md-end {
text-align: right !important;
}
.text-md-center {
text-align: center !important;
}
}
@media (min-width: 992px) {
.float-lg-start {
float: left !important;
}
.float-lg-end {
float: right !important;
}
.float-lg-none {
float: none !important;
}
.object-fit-lg-contain {
object-fit: contain !important;
}
.object-fit-lg-cover {
object-fit: cover !important;
}
.object-fit-lg-fill {
object-fit: fill !important;
}
.object-fit-lg-scale {
object-fit: scale-down !important;
}
.object-fit-lg-none {
object-fit: none !important;
}
.d-lg-inline {
display: inline !important;
}
.d-lg-inline-block {
display: inline-block !important;
}
.d-lg-block {
display: block !important;
}
.d-lg-grid {
display: grid !important;
}
.d-lg-inline-grid {
display: inline-grid !important;
}
.d-lg-table {
display: table !important;
}
.d-lg-table-row {
display: table-row !important;
}
.d-lg-table-cell {
display: table-cell !important;
}
.d-lg-flex {
display: flex !important;
}
.d-lg-inline-flex {
display: inline-flex !important;
}
.d-lg-none {
display: none !important;
}
.flex-lg-fill {
flex: 1 1 auto !important;
}
.flex-lg-row {
flex-direction: row !important;
}
.flex-lg-column {
flex-direction: column !important;
}
.flex-lg-row-reverse {
flex-direction: row-reverse !important;
}
.flex-lg-column-reverse {
flex-direction: column-reverse !important;
}
.flex-lg-grow-0 {
flex-grow: 0 !important;
}
.flex-lg-grow-1 {
flex-grow: 1 !important;
}
.flex-lg-shrink-0 {
flex-shrink: 0 !important;
}
.flex-lg-shrink-1 {
flex-shrink: 1 !important;
}
.flex-lg-wrap {
flex-wrap: wrap !important;
}
.flex-lg-nowrap {
flex-wrap: nowrap !important;
}
.flex-lg-wrap-reverse {
flex-wrap: wrap-reverse !important;
}
.justify-content-lg-start {
justify-content: flex-start !important;
}
.justify-content-lg-end {
justify-content: flex-end !important;
}
.justify-content-lg-center {
justify-content: center !important;
}
.justify-content-lg-between {
justify-content: space-between !important;
}
.justify-content-lg-around {
justify-content: space-around !important;
}
.justify-content-lg-evenly {
justify-content: space-evenly !important;
}
.align-items-lg-start {
align-items: flex-start !important;
}
.align-items-lg-end {
align-items: flex-end !important;
}
.align-items-lg-center {
align-items: center !important;
}
.align-items-lg-baseline {
align-items: baseline !important;
}
.align-items-lg-stretch {
align-items: stretch !important;
}
.align-content-lg-start {
align-content: flex-start !important;
}
.align-content-lg-end {
align-content: flex-end !important;
}
.align-content-lg-center {
align-content: center !important;
}
.align-content-lg-between {
align-content: space-between !important;
}
.align-content-lg-around {
align-content: space-around !important;
}
.align-content-lg-stretch {
align-content: stretch !important;
}
.align-self-lg-auto {
align-self: auto !important;
}
.align-self-lg-start {
align-self: flex-start !important;
}
.align-self-lg-end {
align-self: flex-end !important;
}
.align-self-lg-center {
align-self: center !important;
}
.align-self-lg-baseline {
align-self: baseline !important;
}
.align-self-lg-stretch {
align-self: stretch !important;
}
.order-lg-first {
order: -1 !important;
}
.order-lg-0 {
order: 0 !important;
}
.order-lg-1 {
order: 1 !important;
}
.order-lg-2 {
order: 2 !important;
}
.order-lg-3 {
order: 3 !important;
}
.order-lg-4 {
order: 4 !important;
}
.order-lg-5 {
order: 5 !important;
}
.order-lg-last {
order: 6 !important;
}
.m-lg-0 {
margin: 0 !important;
}
.m-lg-1 {
margin: 0.25rem !important;
}
.m-lg-2 {
margin: 0.5rem !important;
}
.m-lg-3 {
margin: 1rem !important;
}
.m-lg-4 {
margin: 1.5rem !important;
}
.m-lg-5 {
margin: 3rem !important;
}
.m-lg-auto {
margin: auto !important;
}
.mx-lg-0 {
margin-right: 0 !important;
margin-left: 0 !important;
}
.mx-lg-1 {
margin-right: 0.25rem !important;
margin-left: 0.25rem !important;
}
.mx-lg-2 {
margin-right: 0.5rem !important;
margin-left: 0.5rem !important;
}
.mx-lg-3 {
margin-right: 1rem !important;
margin-left: 1rem !important;
}
.mx-lg-4 {
margin-right: 1.5rem !important;
margin-left: 1.5rem !important;
}
.mx-lg-5 {
margin-right: 3rem !important;
margin-left: 3rem !important;
}
.mx-lg-auto {
margin-right: auto !important;
margin-left: auto !important;
}
.my-lg-0 {
margin-top: 0 !important;
margin-bottom: 0 !important;
}
.my-lg-1 {
margin-top: 0.25rem !important;
margin-bottom: 0.25rem !important;
}
.my-lg-2 {
margin-top: 0.5rem !important;
margin-bottom: 0.5rem !important;
}
.my-lg-3 {
margin-top: 1rem !important;
margin-bottom: 1rem !important;
}
.my-lg-4 {
margin-top: 1.5rem !important;
margin-bottom: 1.5rem !important;
}
.my-lg-5 {
margin-top: 3rem !important;
margin-bottom: 3rem !important;
}
.my-lg-auto {
margin-top: auto !important;
margin-bottom: auto !important;
}
.mt-lg-0 {
margin-top: 0 !important;
}
.mt-lg-1 {
margin-top: 0.25rem !important;
}
.mt-lg-2 {
margin-top: 0.5rem !important;
}
.mt-lg-3 {
margin-top: 1rem !important;
}
.mt-lg-4 {
margin-top: 1.5rem !important;
}
.mt-lg-5 {
margin-top: 3rem !important;
}
.mt-lg-auto {
margin-top: auto !important;
}
.me-lg-0 {
margin-right: 0 !important;
}
.me-lg-1 {
margin-right: 0.25rem !important;
}
.me-lg-2 {
margin-right: 0.5rem !important;
}
.me-lg-3 {
margin-right: 1rem !important;
}
.me-lg-4 {
margin-right: 1.5rem !important;
}
.me-lg-5 {
margin-right: 3rem !important;
}
.me-lg-auto {
margin-right: auto !important;
}
.mb-lg-0 {
margin-bottom: 0 !important;
}
.mb-lg-1 {
margin-bottom: 0.25rem !important;
}
.mb-lg-2 {
margin-bottom: 0.5rem !important;
}
.mb-lg-3 {
margin-bottom: 1rem !important;
}
.mb-lg-4 {
margin-bottom: 1.5rem !important;
}
.mb-lg-5 {
margin-bottom: 3rem !important;
}
.mb-lg-auto {
margin-bottom: auto !important;
}
.ms-lg-0 {
margin-left: 0 !important;
}
.ms-lg-1 {
margin-left: 0.25rem !important;
}
.ms-lg-2 {
margin-left: 0.5rem !important;
}
.ms-lg-3 {
margin-left: 1rem !important;
}
.ms-lg-4 {
margin-left: 1.5rem !important;
}
.ms-lg-5 {
margin-left: 3rem !important;
}
.ms-lg-auto {
margin-left: auto !important;
}
.p-lg-0 {
padding: 0 !important;
}
.p-lg-1 {
padding: 0.25rem !important;
}
.p-lg-2 {
padding: 0.5rem !important;
}
.p-lg-3 {
padding: 1rem !important;
}
.p-lg-4 {
padding: 1.5rem !important;
}
.p-lg-5 {
padding: 3rem !important;
}
.px-lg-0 {
padding-right: 0 !important;
padding-left: 0 !important;
}
.px-lg-1 {
padding-right: 0.25rem !important;
padding-left: 0.25rem !important;
}
.px-lg-2 {
padding-right: 0.5rem !important;
padding-left: 0.5rem !important;
}
.px-lg-3 {
padding-right: 1rem !important;
padding-left: 1rem !important;
}
.px-lg-4 {
padding-right: 1.5rem !important;
padding-left: 1.5rem !important;
}
.px-lg-5 {
padding-right: 3rem !important;
padding-left: 3rem !important;
}
.py-lg-0 {
padding-top: 0 !important;
padding-bottom: 0 !important;
}
.py-lg-1 {
padding-top: 0.25rem !important;
padding-bottom: 0.25rem !important;
}
.py-lg-2 {
padding-top: 0.5rem !important;
padding-bottom: 0.5rem !important;
}
.py-lg-3 {
padding-top: 1rem !important;
padding-bottom: 1rem !important;
}
.py-lg-4 {
padding-top: 1.5rem !important;
padding-bottom: 1.5rem !important;
}
.py-lg-5 {
padding-top: 3rem !important;
padding-bottom: 3rem !important;
}
.pt-lg-0 {
padding-top: 0 !important;
}
.pt-lg-1 {
padding-top: 0.25rem !important;
}
.pt-lg-2 {
padding-top: 0.5rem !important;
}
.pt-lg-3 {
padding-top: 1rem !important;
}
.pt-lg-4 {
padding-top: 1.5rem !important;
}
.pt-lg-5 {
padding-top: 3rem !important;
}
.pe-lg-0 {
padding-right: 0 !important;
}
.pe-lg-1 {
padding-right: 0.25rem !important;
}
.pe-lg-2 {
padding-right: 0.5rem !important;
}
.pe-lg-3 {
padding-right: 1rem !important;
}
.pe-lg-4 {
padding-right: 1.5rem !important;
}
.pe-lg-5 {
padding-right: 3rem !important;
}
.pb-lg-0 {
padding-bottom: 0 !important;
}
.pb-lg-1 {
padding-bottom: 0.25rem !important;
}
.pb-lg-2 {
padding-bottom: 0.5rem !important;
}
.pb-lg-3 {
padding-bottom: 1rem !important;
}
.pb-lg-4 {
padding-bottom: 1.5rem !important;
}
.pb-lg-5 {
padding-bottom: 3rem !important;
}
.ps-lg-0 {
padding-left: 0 !important;
}
.ps-lg-1 {
padding-left: 0.25rem !important;
}
.ps-lg-2 {
padding-left: 0.5rem !important;
}
.ps-lg-3 {
padding-left: 1rem !important;
}
.ps-lg-4 {
padding-left: 1.5rem !important;
}
.ps-lg-5 {
padding-left: 3rem !important;
}
.gap-lg-0 {
gap: 0 !important;
}
.gap-lg-1 {
gap: 0.25rem !important;
}
.gap-lg-2 {
gap: 0.5rem !important;
}
.gap-lg-3 {
gap: 1rem !important;
}
.gap-lg-4 {
gap: 1.5rem !important;
}
.gap-lg-5 {
gap: 3rem !important;
}
.row-gap-lg-0 {
row-gap: 0 !important;
}
.row-gap-lg-1 {
row-gap: 0.25rem !important;
}
.row-gap-lg-2 {
row-gap: 0.5rem !important;
}
.row-gap-lg-3 {
row-gap: 1rem !important;
}
.row-gap-lg-4 {
row-gap: 1.5rem !important;
}
.row-gap-lg-5 {
row-gap: 3rem !important;
}
.column-gap-lg-0 {
column-gap: 0 !important;
}
.column-gap-lg-1 {
column-gap: 0.25rem !important;
}
.column-gap-lg-2 {
column-gap: 0.5rem !important;
}
.column-gap-lg-3 {
column-gap: 1rem !important;
}
.column-gap-lg-4 {
column-gap: 1.5rem !important;
}
.column-gap-lg-5 {
column-gap: 3rem !important;
}
.text-lg-start {
text-align: left !important;
}
.text-lg-end {
text-align: right !important;
}
.text-lg-center {
text-align: center !important;
}
}
@media (min-width: 1200px) {
.float-xl-start {
float: left !important;
}
.float-xl-end {
float: right !important;
}
.float-xl-none {
float: none !important;
}
.object-fit-xl-contain {
object-fit: contain !important;
}
.object-fit-xl-cover {
object-fit: cover !important;
}
.object-fit-xl-fill {
object-fit: fill !important;
}
.object-fit-xl-scale {
object-fit: scale-down !important;
}
.object-fit-xl-none {
object-fit: none !important;
}
.d-xl-inline {
display: inline !important;
}
.d-xl-inline-block {
display: inline-block !important;
}
.d-xl-block {
display: block !important;
}
.d-xl-grid {
display: grid !important;
}
.d-xl-inline-grid {
display: inline-grid !important;
}
.d-xl-table {
display: table !important;
}
.d-xl-table-row {
display: table-row !important;
}
.d-xl-table-cell {
display: table-cell !important;
}
.d-xl-flex {
display: flex !important;
}
.d-xl-inline-flex {
display: inline-flex !important;
}
.d-xl-none {
display: none !important;
}
.flex-xl-fill {
flex: 1 1 auto !important;
}
.flex-xl-row {
flex-direction: row !important;
}
.flex-xl-column {
flex-direction: column !important;
}
.flex-xl-row-reverse {
flex-direction: row-reverse !important;
}
.flex-xl-column-reverse {
flex-direction: column-reverse !important;
}
.flex-xl-grow-0 {
flex-grow: 0 !important;
}
.flex-xl-grow-1 {
flex-grow: 1 !important;
}
.flex-xl-shrink-0 {
flex-shrink: 0 !important;
}
.flex-xl-shrink-1 {
flex-shrink: 1 !important;
}
.flex-xl-wrap {
flex-wrap: wrap !important;
}
.flex-xl-nowrap {
flex-wrap: nowrap !important;
}
.flex-xl-wrap-reverse {
flex-wrap: wrap-reverse !important;
}
.justify-content-xl-start {
justify-content: flex-start !important;
}
.justify-content-xl-end {
justify-content: flex-end !important;
}
.justify-content-xl-center {
justify-content: center !important;
}
.justify-content-xl-between {
justify-content: space-between !important;
}
.justify-content-xl-around {
justify-content: space-around !important;
}
.justify-content-xl-evenly {
justify-content: space-evenly !important;
}
.align-items-xl-start {
align-items: flex-start !important;
}
.align-items-xl-end {
align-items: flex-end !important;
}
.align-items-xl-center {
align-items: center !important;
}
.align-items-xl-baseline {
align-items: baseline !important;
}
.align-items-xl-stretch {
align-items: stretch !important;
}
.align-content-xl-start {
align-content: flex-start !important;
}
.align-content-xl-end {
align-content: flex-end !important;
}
.align-content-xl-center {
align-content: center !important;
}
.align-content-xl-between {
align-content: space-between !important;
}
.align-content-xl-around {
align-content: space-around !important;
}
.align-content-xl-stretch {
align-content: stretch !important;
}
.align-self-xl-auto {
align-self: auto !important;
}
.align-self-xl-start {
align-self: flex-start !important;
}
.align-self-xl-end {
align-self: flex-end !important;
}
.align-self-xl-center {
align-self: center !important;
}
.align-self-xl-baseline {
align-self: baseline !important;
}
.align-self-xl-stretch {
align-self: stretch !important;
}
.order-xl-first {
order: -1 !important;
}
.order-xl-0 {
order: 0 !important;
}
.order-xl-1 {
order: 1 !important;
}
.order-xl-2 {
order: 2 !important;
}
.order-xl-3 {
order: 3 !important;
}
.order-xl-4 {
order: 4 !important;
}
.order-xl-5 {
order: 5 !important;
}
.order-xl-last {
order: 6 !important;
}
.m-xl-0 {
margin: 0 !important;
}
.m-xl-1 {
margin: 0.25rem !important;
}
.m-xl-2 {
margin: 0.5rem !important;
}
.m-xl-3 {
margin: 1rem !important;
}
.m-xl-4 {
margin: 1.5rem !important;
}
.m-xl-5 {
margin: 3rem !important;
}
.m-xl-auto {
margin: auto !important;
}
.mx-xl-0 {
margin-right: 0 !important;
margin-left: 0 !important;
}
.mx-xl-1 {
margin-right: 0.25rem !important;
margin-left: 0.25rem !important;
}
.mx-xl-2 {
margin-right: 0.5rem !important;
margin-left: 0.5rem !important;
}
.mx-xl-3 {
margin-right: 1rem !important;
margin-left: 1rem !important;
}
.mx-xl-4 {
margin-right: 1.5rem !important;
margin-left: 1.5rem !important;
}
.mx-xl-5 {
margin-right: 3rem !important;
margin-left: 3rem !important;
}
.mx-xl-auto {
margin-right: auto !important;
margin-left: auto !important;
}
.my-xl-0 {
margin-top: 0 !important;
margin-bottom: 0 !important;
}
.my-xl-1 {
margin-top: 0.25rem !important;
margin-bottom: 0.25rem !important;
}
.my-xl-2 {
margin-top: 0.5rem !important;
margin-bottom: 0.5rem !important;
}
.my-xl-3 {
margin-top: 1rem !important;
margin-bottom: 1rem !important;
}
.my-xl-4 {
margin-top: 1.5rem !important;
margin-bottom: 1.5rem !important;
}
.my-xl-5 {
margin-top: 3rem !important;
margin-bottom: 3rem !important;
}
.my-xl-auto {
margin-top: auto !important;
margin-bottom: auto !important;
}
.mt-xl-0 {
margin-top: 0 !important;
}
.mt-xl-1 {
margin-top: 0.25rem !important;
}
.mt-xl-2 {
margin-top: 0.5rem !important;
}
.mt-xl-3 {
margin-top: 1rem !important;
}
.mt-xl-4 {
margin-top: 1.5rem !important;
}
.mt-xl-5 {
margin-top: 3rem !important;
}
.mt-xl-auto {
margin-top: auto !important;
}
.me-xl-0 {
margin-right: 0 !important;
}
.me-xl-1 {
margin-right: 0.25rem !important;
}
.me-xl-2 {
margin-right: 0.5rem !important;
}
.me-xl-3 {
margin-right: 1rem !important;
}
.me-xl-4 {
margin-right: 1.5rem !important;
}
.me-xl-5 {
margin-right: 3rem !important;
}
.me-xl-auto {
margin-right: auto !important;
}
.mb-xl-0 {
margin-bottom: 0 !important;
}
.mb-xl-1 {
margin-bottom: 0.25rem !important;
}
.mb-xl-2 {
margin-bottom: 0.5rem !important;
}
.mb-xl-3 {
margin-bottom: 1rem !important;
}
.mb-xl-4 {
margin-bottom: 1.5rem !important;
}
.mb-xl-5 {
margin-bottom: 3rem !important;
}
.mb-xl-auto {
margin-bottom: auto !important;
}
.ms-xl-0 {
margin-left: 0 !important;
}
.ms-xl-1 {
margin-left: 0.25rem !important;
}
.ms-xl-2 {
margin-left: 0.5rem !important;
}
.ms-xl-3 {
margin-left: 1rem !important;
}
.ms-xl-4 {
margin-left: 1.5rem !important;
}
.ms-xl-5 {
margin-left: 3rem !important;
}
.ms-xl-auto {
margin-left: auto !important;
}
.p-xl-0 {
padding: 0 !important;
}
.p-xl-1 {
padding: 0.25rem !important;
}
.p-xl-2 {
padding: 0.5rem !important;
}
.p-xl-3 {
padding: 1rem !important;
}
.p-xl-4 {
padding: 1.5rem !important;
}
.p-xl-5 {
padding: 3rem !important;
}
.px-xl-0 {
padding-right: 0 !important;
padding-left: 0 !important;
}
.px-xl-1 {
padding-right: 0.25rem !important;
padding-left: 0.25rem !important;
}
.px-xl-2 {
padding-right: 0.5rem !important;
padding-left: 0.5rem !important;
}
.px-xl-3 {
padding-right: 1rem !important;
padding-left: 1rem !important;
}
.px-xl-4 {
padding-right: 1.5rem !important;
padding-left: 1.5rem !important;
}
.px-xl-5 {
padding-right: 3rem !important;
padding-left: 3rem !important;
}
.py-xl-0 {
padding-top: 0 !important;
padding-bottom: 0 !important;
}
.py-xl-1 {
padding-top: 0.25rem !important;
padding-bottom: 0.25rem !important;
}
.py-xl-2 {
padding-top: 0.5rem !important;
padding-bottom: 0.5rem !important;
}
.py-xl-3 {
padding-top: 1rem !important;
padding-bottom: 1rem !important;
}
.py-xl-4 {
padding-top: 1.5rem !important;
padding-bottom: 1.5rem !important;
}
.py-xl-5 {
padding-top: 3rem !important;
padding-bottom: 3rem !important;
}
.pt-xl-0 {
padding-top: 0 !important;
}
.pt-xl-1 {
padding-top: 0.25rem !important;
}
.pt-xl-2 {
padding-top: 0.5rem !important;
}
.pt-xl-3 {
padding-top: 1rem !important;
}
.pt-xl-4 {
padding-top: 1.5rem !important;
}
.pt-xl-5 {
padding-top: 3rem !important;
}
.pe-xl-0 {
padding-right: 0 !important;
}
.pe-xl-1 {
padding-right: 0.25rem !important;
}
.pe-xl-2 {
padding-right: 0.5rem !important;
}
.pe-xl-3 {
padding-right: 1rem !important;
}
.pe-xl-4 {
padding-right: 1.5rem !important;
}
.pe-xl-5 {
padding-right: 3rem !important;
}
.pb-xl-0 {
padding-bottom: 0 !important;
}
.pb-xl-1 {
padding-bottom: 0.25rem !important;
}
.pb-xl-2 {
padding-bottom: 0.5rem !important;
}
.pb-xl-3 {
padding-bottom: 1rem !important;
}
.pb-xl-4 {
padding-bottom: 1.5rem !important;
}
.pb-xl-5 {
padding-bottom: 3rem !important;
}
.ps-xl-0 {
padding-left: 0 !important;
}
.ps-xl-1 {
padding-left: 0.25rem !important;
}
.ps-xl-2 {
padding-left: 0.5rem !important;
}
.ps-xl-3 {
padding-left: 1rem !important;
}
.ps-xl-4 {
padding-left: 1.5rem !important;
}
.ps-xl-5 {
padding-left: 3rem !important;
}
.gap-xl-0 {
gap: 0 !important;
}
.gap-xl-1 {
gap: 0.25rem !important;
}
.gap-xl-2 {
gap: 0.5rem !important;
}
.gap-xl-3 {
gap: 1rem !important;
}
.gap-xl-4 {
gap: 1.5rem !important;
}
.gap-xl-5 {
gap: 3rem !important;
}
.row-gap-xl-0 {
row-gap: 0 !important;
}
.row-gap-xl-1 {
row-gap: 0.25rem !important;
}
.row-gap-xl-2 {
row-gap: 0.5rem !important;
}
.row-gap-xl-3 {
row-gap: 1rem !important;
}
.row-gap-xl-4 {
row-gap: 1.5rem !important;
}
.row-gap-xl-5 {
row-gap: 3rem !important;
}
.column-gap-xl-0 {
column-gap: 0 !important;
}
.column-gap-xl-1 {
column-gap: 0.25rem !important;
}
.column-gap-xl-2 {
column-gap: 0.5rem !important;
}
.column-gap-xl-3 {
column-gap: 1rem !important;
}
.column-gap-xl-4 {
column-gap: 1.5rem !important;
}
.column-gap-xl-5 {
column-gap: 3rem !important;
}
.text-xl-start {
text-align: left !important;
}
.text-xl-end {
text-align: right !important;
}
.text-xl-center {
text-align: center !important;
}
}
@media (min-width: 1400px) {
.float-xxl-start {
float: left !important;
}
.float-xxl-end {
float: right !important;
}
.float-xxl-none {
float: none !important;
}
.object-fit-xxl-contain {
object-fit: contain !important;
}
.object-fit-xxl-cover {
object-fit: cover !important;
}
.object-fit-xxl-fill {
object-fit: fill !important;
}
.object-fit-xxl-scale {
object-fit: scale-down !important;
}
.object-fit-xxl-none {
object-fit: none !important;
}
.d-xxl-inline {
display: inline !important;
}
.d-xxl-inline-block {
display: inline-block !important;
}
.d-xxl-block {
display: block !important;
}
.d-xxl-grid {
display: grid !important;
}
.d-xxl-inline-grid {
display: inline-grid !important;
}
.d-xxl-table {
display: table !important;
}
.d-xxl-table-row {
display: table-row !important;
}
.d-xxl-table-cell {
display: table-cell !important;
}
.d-xxl-flex {
display: flex !important;
}
.d-xxl-inline-flex {
display: inline-flex !important;
}
.d-xxl-none {
display: none !important;
}
.flex-xxl-fill {
flex: 1 1 auto !important;
}
.flex-xxl-row {
flex-direction: row !important;
}
.flex-xxl-column {
flex-direction: column !important;
}
.flex-xxl-row-reverse {
flex-direction: row-reverse !important;
}
.flex-xxl-column-reverse {
flex-direction: column-reverse !important;
}
.flex-xxl-grow-0 {
flex-grow: 0 !important;
}
.flex-xxl-grow-1 {
flex-grow: 1 !important;
}
.flex-xxl-shrink-0 {
flex-shrink: 0 !important;
}
.flex-xxl-shrink-1 {
flex-shrink: 1 !important;
}
.flex-xxl-wrap {
flex-wrap: wrap !important;
}
.flex-xxl-nowrap {
flex-wrap: nowrap !important;
}
.flex-xxl-wrap-reverse {
flex-wrap: wrap-reverse !important;
}
.justify-content-xxl-start {
justify-content: flex-start !important;
}
.justify-content-xxl-end {
justify-content: flex-end !important;
}
.justify-content-xxl-center {
justify-content: center !important;
}
.justify-content-xxl-between {
justify-content: space-between !important;
}
.justify-content-xxl-around {
justify-content: space-around !important;
}
.justify-content-xxl-evenly {
justify-content: space-evenly !important;
}
.align-items-xxl-start {
align-items: flex-start !important;
}
.align-items-xxl-end {
align-items: flex-end !important;
}
.align-items-xxl-center {
align-items: center !important;
}
.align-items-xxl-baseline {
align-items: baseline !important;
}
.align-items-xxl-stretch {
align-items: stretch !important;
}
.align-content-xxl-start {
align-content: flex-start !important;
}
.align-content-xxl-end {
align-content: flex-end !important;
}
.align-content-xxl-center {
align-content: center !important;
}
.align-content-xxl-between {
align-content: space-between !important;
}
.align-content-xxl-around {
align-content: space-around !important;
}
.align-content-xxl-stretch {
align-content: stretch !important;
}
.align-self-xxl-auto {
align-self: auto !important;
}
.align-self-xxl-start {
align-self: flex-start !important;
}
.align-self-xxl-end {
align-self: flex-end !important;
}
.align-self-xxl-center {
align-self: center !important;
}
.align-self-xxl-baseline {
align-self: baseline !important;
}
.align-self-xxl-stretch {
align-self: stretch !important;
}
.order-xxl-first {
order: -1 !important;
}
.order-xxl-0 {
order: 0 !important;
}
.order-xxl-1 {
order: 1 !important;
}
.order-xxl-2 {
order: 2 !important;
}
.order-xxl-3 {
order: 3 !important;
}
.order-xxl-4 {
order: 4 !important;
}
.order-xxl-5 {
order: 5 !important;
}
.order-xxl-last {
order: 6 !important;
}
.m-xxl-0 {
margin: 0 !important;
}
.m-xxl-1 {
margin: 0.25rem !important;
}
.m-xxl-2 {
margin: 0.5rem !important;
}
.m-xxl-3 {
margin: 1rem !important;
}
.m-xxl-4 {
margin: 1.5rem !important;
}
.m-xxl-5 {
margin: 3rem !important;
}
.m-xxl-auto {
margin: auto !important;
}
.mx-xxl-0 {
margin-right: 0 !important;
margin-left: 0 !important;
}
.mx-xxl-1 {
margin-right: 0.25rem !important;
margin-left: 0.25rem !important;
}
.mx-xxl-2 {
margin-right: 0.5rem !important;
margin-left: 0.5rem !important;
}
.mx-xxl-3 {
margin-right: 1rem !important;
margin-left: 1rem !important;
}
.mx-xxl-4 {
margin-right: 1.5rem !important;
margin-left: 1.5rem !important;
}
.mx-xxl-5 {
margin-right: 3rem !important;
margin-left: 3rem !important;
}
.mx-xxl-auto {
margin-right: auto !important;
margin-left: auto !important;
}
.my-xxl-0 {
margin-top: 0 !important;
margin-bottom: 0 !important;
}
.my-xxl-1 {
margin-top: 0.25rem !important;
margin-bottom: 0.25rem !important;
}
.my-xxl-2 {
margin-top: 0.5rem !important;
margin-bottom: 0.5rem !important;
}
.my-xxl-3 {
margin-top: 1rem !important;
margin-bottom: 1rem !important;
}
.my-xxl-4 {
margin-top: 1.5rem !important;
margin-bottom: 1.5rem !important;
}
.my-xxl-5 {
margin-top: 3rem !important;
margin-bottom: 3rem !important;
}
.my-xxl-auto {
margin-top: auto !important;
margin-bottom: auto !important;
}
.mt-xxl-0 {
margin-top: 0 !important;
}
.mt-xxl-1 {
margin-top: 0.25rem !important;
}
.mt-xxl-2 {
margin-top: 0.5rem !important;
}
.mt-xxl-3 {
margin-top: 1rem !important;
}
.mt-xxl-4 {
margin-top: 1.5rem !important;
}
.mt-xxl-5 {
margin-top: 3rem !important;
}
.mt-xxl-auto {
margin-top: auto !important;
}
.me-xxl-0 {
margin-right: 0 !important;
}
.me-xxl-1 {
margin-right: 0.25rem !important;
}
.me-xxl-2 {
margin-right: 0.5rem !important;
}
.me-xxl-3 {
margin-right: 1rem !important;
}
.me-xxl-4 {
margin-right: 1.5rem !important;
}
.me-xxl-5 {
margin-right: 3rem !important;
}
.me-xxl-auto {
margin-right: auto !important;
}
.mb-xxl-0 {
margin-bottom: 0 !important;
}
.mb-xxl-1 {
margin-bottom: 0.25rem !important;
}
.mb-xxl-2 {
margin-bottom: 0.5rem !important;
}
.mb-xxl-3 {
margin-bottom: 1rem !important;
}
.mb-xxl-4 {
margin-bottom: 1.5rem !important;
}
.mb-xxl-5 {
margin-bottom: 3rem !important;
}
.mb-xxl-auto {
margin-bottom: auto !important;
}
.ms-xxl-0 {
margin-left: 0 !important;
}
.ms-xxl-1 {
margin-left: 0.25rem !important;
}
.ms-xxl-2 {
margin-left: 0.5rem !important;
}
.ms-xxl-3 {
margin-left: 1rem !important;
}
.ms-xxl-4 {
margin-left: 1.5rem !important;
}
.ms-xxl-5 {
margin-left: 3rem !important;
}
.ms-xxl-auto {
margin-left: auto !important;
}
.p-xxl-0 {
padding: 0 !important;
}
.p-xxl-1 {
padding: 0.25rem !important;
}
.p-xxl-2 {
padding: 0.5rem !important;
}
.p-xxl-3 {
padding: 1rem !important;
}
.p-xxl-4 {
padding: 1.5rem !important;
}
.p-xxl-5 {
padding: 3rem !important;
}
.px-xxl-0 {
padding-right: 0 !important;
padding-left: 0 !important;
}
.px-xxl-1 {
padding-right: 0.25rem !important;
padding-left: 0.25rem !important;
}
.px-xxl-2 {
padding-right: 0.5rem !important;
padding-left: 0.5rem !important;
}
.px-xxl-3 {
padding-right: 1rem !important;
padding-left: 1rem !important;
}
.px-xxl-4 {
padding-right: 1.5rem !important;
padding-left: 1.5rem !important;
}
.px-xxl-5 {
padding-right: 3rem !important;
padding-left: 3rem !important;
}
.py-xxl-0 {
padding-top: 0 !important;
padding-bottom: 0 !important;
}
.py-xxl-1 {
padding-top: 0.25rem !important;
padding-bottom: 0.25rem !important;
}
.py-xxl-2 {
padding-top: 0.5rem !important;
padding-bottom: 0.5rem !important;
}
.py-xxl-3 {
padding-top: 1rem !important;
padding-bottom: 1rem !important;
}
.py-xxl-4 {
padding-top: 1.5rem !important;
padding-bottom: 1.5rem !important;
}
.py-xxl-5 {
padding-top: 3rem !important;
padding-bottom: 3rem !important;
}
.pt-xxl-0 {
padding-top: 0 !important;
}
.pt-xxl-1 {
padding-top: 0.25rem !important;
}
.pt-xxl-2 {
padding-top: 0.5rem !important;
}
.pt-xxl-3 {
padding-top: 1rem !important;
}
.pt-xxl-4 {
padding-top: 1.5rem !important;
}
.pt-xxl-5 {
padding-top: 3rem !important;
}
.pe-xxl-0 {
padding-right: 0 !important;
}
.pe-xxl-1 {
padding-right: 0.25rem !important;
}
.pe-xxl-2 {
padding-right: 0.5rem !important;
}
.pe-xxl-3 {
padding-right: 1rem !important;
}
.pe-xxl-4 {
padding-right: 1.5rem !important;
}
.pe-xxl-5 {
padding-right: 3rem !important;
}
.pb-xxl-0 {
padding-bottom: 0 !important;
}
.pb-xxl-1 {
padding-bottom: 0.25rem !important;
}
.pb-xxl-2 {
padding-bottom: 0.5rem !important;
}
.pb-xxl-3 {
padding-bottom: 1rem !important;
}
.pb-xxl-4 {
padding-bottom: 1.5rem !important;
}
.pb-xxl-5 {
padding-bottom: 3rem !important;
}
.ps-xxl-0 {
padding-left: 0 !important;
}
.ps-xxl-1 {
padding-left: 0.25rem !important;
}
.ps-xxl-2 {
padding-left: 0.5rem !important;
}
.ps-xxl-3 {
padding-left: 1rem !important;
}
.ps-xxl-4 {
padding-left: 1.5rem !important;
}
.ps-xxl-5 {
padding-left: 3rem !important;
}
.gap-xxl-0 {
gap: 0 !important;
}
.gap-xxl-1 {
gap: 0.25rem !important;
}
.gap-xxl-2 {
gap: 0.5rem !important;
}
.gap-xxl-3 {
gap: 1rem !important;
}
.gap-xxl-4 {
gap: 1.5rem !important;
}
.gap-xxl-5 {
gap: 3rem !important;
}
.row-gap-xxl-0 {
row-gap: 0 !important;
}
.row-gap-xxl-1 {
row-gap: 0.25rem !important;
}
.row-gap-xxl-2 {
row-gap: 0.5rem !important;
}
.row-gap-xxl-3 {
row-gap: 1rem !important;
}
.row-gap-xxl-4 {
row-gap: 1.5rem !important;
}
.row-gap-xxl-5 {
row-gap: 3rem !important;
}
.column-gap-xxl-0 {
column-gap: 0 !important;
}
.column-gap-xxl-1 {
column-gap: 0.25rem !important;
}
.column-gap-xxl-2 {
column-gap: 0.5rem !important;
}
.column-gap-xxl-3 {
column-gap: 1rem !important;
}
.column-gap-xxl-4 {
column-gap: 1.5rem !important;
}
.column-gap-xxl-5 {
column-gap: 3rem !important;
}
.text-xxl-start {
text-align: left !important;
}
.text-xxl-end {
text-align: right !important;
}
.text-xxl-center {
text-align: center !important;
}
}
@media (min-width: 1200px) {
.fs-1 {
font-size: 2.5rem !important;
}
.fs-2 {
font-size: 2rem !important;
}
.fs-3 {
font-size: 1.75rem !important;
}
.fs-4 {
font-size: 1.5rem !important;
}
}
@media print {
.d-print-inline {
display: inline !important;
}
.d-print-inline-block {
display: inline-block !important;
}
.d-print-block {
display: block !important;
}
.d-print-grid {
display: grid !important;
}
.d-print-inline-grid {
display: inline-grid !important;
}
.d-print-table {
display: table !important;
}
.d-print-table-row {
display: table-row !important;
}
.d-print-table-cell {
display: table-cell !important;
}
.d-print-flex {
display: flex !important;
}
.d-print-inline-flex {
display: inline-flex !important;
}
.d-print-none {
display: none !important;
}
}
div.container-lg {
max-width: 960px;
}
header {
background-color: #2e5943;
color: #fff;
padding-top: 1rem;
padding-bottom: 4rem;
}
header a {
color: #fff;
}
header .title {
font-size: 5rem;
margin-bottom: 1rem;
line-height: 1.2;
}
header .subtitle {
font-size: 3.75rem;
display: block;
}
nav.navbar {
background-color: #fff;
color: #1c3528;
max-height: 100vh;
overflow-y: auto;
border-bottom-width: 1px;
border-bottom-style: solid;
border-bottom-color: #254736;
}
@media screen {
.highlight { 
























































}
.highlight pre {
background: #181818;
color: #F8F8F8;
border: none;
}
.highlight code * {
font-family: Menlo, Monaco, Consolas, "Lucida Console", "Courier New", monospace;
}
.highlight code .hll {
background: #ffffcc;
}
.highlight code .c {
color: #5F5A60;
font-style: italic;
}
.highlight code .err {
border: #B22518;
}
.highlight code .k {
color: #CDA869;
}
.highlight code .cm {
color: #5F5A60;
font-style: italic;
}
.highlight code .cp {
color: #5F5A60;
}
.highlight code .c1 {
color: #5F5A60;
font-style: italic;
}
.highlight code .cs {
color: #5F5A60;
font-style: italic;
}
.highlight code .gd {
background: #420E09;
}
.highlight code .ge {
font-style: italic;
}
.highlight code .gr {
background: #B22518;
}
.highlight code .gh {
color: #000080;
font-weight: bold;
}
.highlight code .gi {
background: #253B22;
}
.highlight code .gp {
font-weight: bold;
}
.highlight code .gs {
font-weight: bold;
}
.highlight code .gu {
color: #800080;
font-weight: bold;
}
.highlight code .kd {
color: #e9df8f;
}
.highlight code .kp {
color: #9B703F;
}
.highlight code .s {
color: #8F9D6A;
}
.highlight code .na {
color: #F9EE98;
}
.highlight code .nb {
color: #CDA869;
}
.highlight code .nc {
color: #9B859D;
font-weight: bold;
}
.highlight code .no {
color: #9B859D;
}
.highlight code .nd {
color: #7587A6;
}
.highlight code .ni {
color: #CF6A4C;
font-weight: bold;
}
.highlight code .nf {
color: #9B703F;
font-weight: bold;
}
.highlight code .nn {
color: #9B859D;
font-weight: bold;
}
.highlight code .nt {
color: #CDA869;
font-weight: bold;
}
.highlight code .nv {
color: #7587A6;
}
.highlight code .ow {
color: #AA22FF;
font-weight: bold;
}
.highlight code .w {
color: #141414;
}
.highlight code .mf {
color: #CF6A4C;
}
.highlight code .mh {
color: #CF6A4C;
}
.highlight code .mi {
color: #CF6A4C;
}
.highlight code .mo {
color: #CF6A4C;
}
.highlight code .sb {
color: #8F9D6A;
}
.highlight code .sc {
color: #8F9D6A;
}
.highlight code .sd {
color: #8F9D6A;
font-style: italic;
}
.highlight code .s2 {
color: #8F9D6A;
}
.highlight code .se {
color: #F9EE98;
font-weight: bold;
}
.highlight code .sh {
color: #8F9D6A;
}
.highlight code .si {
color: #DAEFA3;
font-weight: bold;
}
.highlight code .sx {
color: #8F9D6A;
}
.highlight code .sr {
color: #E9C062;
}
.highlight code .s1 {
color: #8F9D6A;
}
.highlight code .ss {
color: #CF6A4C;
}
.highlight code .bp {
color: #00aaaa;
}
.highlight code .vc {
color: #7587A6;
}
.highlight code .vg {
color: #7587A6;
}
.highlight code .vi {
color: #7587A6;
}
.highlight code .il {
color: #009999;
}
}
@media print {
.highlight { 
























































}
.highlight pre {
background: #181818;
color: #F8F8F8;
border: none;
}
.highlight code * {
font-family: Menlo, Monaco, Consolas, "Lucida Console", "Courier New", monospace;
}
.highlight code .hll {
background: #ffffcc;
}
.highlight code .c {
color: #5F5A60;
font-style: italic;
}
.highlight code .err {
border: #B22518;
}
.highlight code .k {
color: #CDA869;
}
.highlight code .cm {
color: #5F5A60;
font-style: italic;
}
.highlight code .cp {
color: #5F5A60;
}
.highlight code .c1 {
color: #5F5A60;
font-style: italic;
}
.highlight code .cs {
color: #5F5A60;
font-style: italic;
}
.highlight code .gd {
background: #420E09;
}
.highlight code .ge {
font-style: italic;
}
.highlight code .gr {
background: #B22518;
}
.highlight code .gh {
color: #000080;
font-weight: bold;
}
.highlight code .gi {
background: #253B22;
}
.highlight code .gp {
font-weight: bold;
}
.highlight code .gs {
font-weight: bold;
}
.highlight code .gu {
color: #800080;
font-weight: bold;
}
.highlight code .kd {
color: #e9df8f;
}
.highlight code .kp {
color: #9B703F;
}
.highlight code .s {
color: #8F9D6A;
}
.highlight code .na {
color: #F9EE98;
}
.highlight code .nb {
color: #CDA869;
}
.highlight code .nc {
color: #9B859D;
font-weight: bold;
}
.highlight code .no {
color: #9B859D;
}
.highlight code .nd {
color: #7587A6;
}
.highlight code .ni {
color: #CF6A4C;
font-weight: bold;
}
.highlight code .nf {
color: #9B703F;
font-weight: bold;
}
.highlight code .nn {
color: #9B859D;
font-weight: bold;
}
.highlight code .nt {
color: #CDA869;
font-weight: bold;
}
.highlight code .nv {
color: #7587A6;
}
.highlight code .ow {
color: #AA22FF;
font-weight: bold;
}
.highlight code .w {
color: #141414;
}
.highlight code .mf {
color: #CF6A4C;
}
.highlight code .mh {
color: #CF6A4C;
}
.highlight code .mi {
color: #CF6A4C;
}
.highlight code .mo {
color: #CF6A4C;
}
.highlight code .sb {
color: #8F9D6A;
}
.highlight code .sc {
color: #8F9D6A;
}
.highlight code .sd {
color: #8F9D6A;
font-style: italic;
}
.highlight code .s2 {
color: #8F9D6A;
}
.highlight code .se {
color: #F9EE98;
font-weight: bold;
}
.highlight code .sh {
color: #8F9D6A;
}
.highlight code .si {
color: #DAEFA3;
font-weight: bold;
}
.highlight code .sx {
color: #8F9D6A;
}
.highlight code .sr {
color: #E9C062;
}
.highlight code .s1 {
color: #8F9D6A;
}
.highlight code .ss {
color: #CF6A4C;
}
.highlight code .bp {
color: #00aaaa;
}
.highlight code .vc {
color: #7587A6;
}
.highlight code .vg {
color: #7587A6;
}
.highlight code .vi {
color: #7587A6;
}
.highlight code .il {
color: #009999;
}
}
div.sourceCode {
padding: 1.5rem;
}
article figure, article img {
display: block;
margin-left: auto;
margin-right: auto;
max-width: 100%;
}
article figure svg, article img svg {
max-width: 100%;
}
h1, .h1 {
margin-top: 8rem;
}
footer {
margin-top: 2rem;
padding: 4rem 0;
background: #2e5943;
color: #fff;
}
footer a {
color: #fff;
}
footer h1, footer .h1, footer h2, footer .h2, footer h3, footer .h3, footer h4, footer .h4, footer h5, footer .h5, footer h6, footer .h6 {
color: #fff;
}
footer .footer-brand {
margin: 0;
}
footer .sitemap {
margin: 0 0 35px;
font-size: 0.9em;
}
footer .sitemap ul {
margin: 0;
}
footer .sitemap li {
text-align: center;
}
footer .sitemap h5, footer .sitemap .h5 {
margin-top: 35px;
text-align: center;
}
footer .sitemap h5 a, footer .sitemap .h5 a {
font-weight: bold;
}
footer .sitemap a {
display: block;
overflow: hidden;
text-overflow: ellipsis;
white-space: nowrap;
color: #fff;
font-weight: 200;
text-decoration: none;
}
footer .sitemap a:hover {
text-decoration: underline;
}
footer .small {
margin: 0 0 35px;
font-size: 0.8em;
font-weight: 200;
}

</style>
    <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } 
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } 
code span.at { color: #204a87; } 
code span.bn { color: #0000cf; } 
code span.cf { color: #204a87; font-weight: bold; } 
code span.ch { color: #4e9a06; } 
code span.cn { color: #8f5902; } 
code span.co { color: #8f5902; font-style: italic; } 
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } 
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } 
code span.dt { color: #204a87; } 
code span.dv { color: #0000cf; } 
code span.er { color: #a40000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #0000cf; } 
code span.fu { color: #204a87; font-weight: bold; } 
code span.im { } 
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } 
code span.kw { color: #204a87; font-weight: bold; } 
code span.op { color: #ce5c00; font-weight: bold; } 
code span.ot { color: #8f5902; } 
code span.pp { color: #8f5902; font-style: italic; } 
code span.sc { color: #ce5c00; font-weight: bold; } 
code span.ss { color: #4e9a06; } 
code span.st { color: #4e9a06; } 
code span.va { color: #000000; } 
code span.vs { color: #4e9a06; } 
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } 
</style>
  
  
  
  </head>
<body>
  <nav class="navbar navbar-expand-lg sticky-top">
    <div class="container-fluid">
      <details>
        <summary class="nav-item p-2"><h5 class="d-inline-block mb-0">Table of Contents</h5></summary>
        <ul>
        <li><a href="#preface" id="toc-preface">Preface</a>
        <ul>
        <li><a href="#preface-from-scala-with-cats" id="toc-preface-from-scala-with-cats">Preface from Scala with
        Cats</a></li>
        <li><a href="#versions" id="toc-versions">Versions</a></li>
        <li><a href="#conventions-used-in-this-book" id="toc-conventions-used-in-this-book">Conventions Used in This
        Book</a></li>
        <li><a href="#license" id="toc-license">License</a></li>
        </ul></li>
        <li><a href="#functional-programming-strategies" id="toc-functional-programming-strategies"><span class="toc-section-number">1</span> Functional Programming
        Strategies</a>
        <ul>
        <li><a href="#コードを考えるための3つのレベル" id="toc-コードを考えるための3つのレベル"><span class="toc-section-number">1.1</span>
        コードを考えるための3つのレベル</a></li>
        <li><a href="#関数型プログラミング" id="toc-関数型プログラミング"><span class="toc-section-number">1.2</span>
        関数型プログラミング</a></li>
        </ul></li>
        <li><a href="#sec:adt" id="toc-sec:adt"><span class="toc-section-number">2</span> 代数的データ型</a>
        <ul>
        <li><a href="#代数的データ型の構築" id="toc-代数的データ型の構築"><span class="toc-section-number">2.1</span>
        代数的データ型の構築</a></li>
        <li><a href="#scalaにおける代数的データ型" id="toc-scalaにおける代数的データ型"><span class="toc-section-number">2.2</span>
        Scalaにおける代数的データ型</a></li>
        <li><a href="#構造的再帰" id="toc-構造的再帰"><span class="toc-section-number">2.3</span> 構造的再帰</a></li>
        <li><a href="#構造的余再帰" id="toc-構造的余再帰"><span class="toc-section-number">2.4</span> 構造的余再帰</a></li>
        <li><a href="#代数的データ型における代数" id="toc-代数的データ型における代数"><span class="toc-section-number">2.5</span>
        代数的データ型における代数</a></li>
        <li><a href="#conclusions" id="toc-conclusions"><span class="toc-section-number">2.6</span> Conclusions</a></li>
        </ul></li>
        <li><a href="#sec:codata" id="toc-sec:codata"><span class="toc-section-number">3</span>
        余データとしてのオブジェクト</a>
        <ul>
        <li><a href="#データと余データ" id="toc-データと余データ"><span class="toc-section-number">3.1</span> データと余データ</a></li>
        <li><a href="#codata-in-scala" id="toc-codata-in-scala"><span class="toc-section-number">3.2</span> Codata in Scala</a></li>
        <li><a href="#余データの構造的再帰と余再帰" id="toc-余データの構造的再帰と余再帰"><span class="toc-section-number">3.3</span>
        余データの構造的再帰と余再帰</a></li>
        <li><a href="#データと余データの関係-relating-data-and-codata" id="toc-データと余データの関係-relating-data-and-codata"><span class="toc-section-number">3.4</span> データと余データの関係
        Relating Data and Codata</a></li>
        <li><a href="#data-and-codata-extensibility" id="toc-data-and-codata-extensibility"><span class="toc-section-number">3.5</span> Data and Codata
        Extensibility</a></li>
        <li><a href="#exercise-sets" id="toc-exercise-sets"><span class="toc-section-number">3.6</span> Exercise: Sets</a></li>
        <li><a href="#conclusions-1" id="toc-conclusions-1"><span class="toc-section-number">3.7</span> Conclusions</a></li>
        </ul></li>
        <li><a href="#sec:type-classes" id="toc-sec:type-classes"><span class="toc-section-number">4</span> コンテキスト抽象 Contextual
        Abstraction</a>
        <ul>
        <li><a href="#コンテキスト抽象のメカニズム-the-mechanics-of-contextual-abstraction" id="toc-コンテキスト抽象のメカニズム-the-mechanics-of-contextual-abstraction"><span class="toc-section-number">4.1</span>
        コンテキスト抽象のメカニズム The Mechanics of Contextual
        Abstraction</a></li>
        <li><a href="#anatomy-of-a-type-class" id="toc-anatomy-of-a-type-class"><span class="toc-section-number">4.2</span> Anatomy of a Type
        Class</a></li>
        <li><a href="#sec:type-classes:composition" id="toc-sec:type-classes:composition"><span class="toc-section-number">4.3</span> Type Class
        Composition</a></li>
        <li><a href="#what-type-classes-are" id="toc-what-type-classes-are"><span class="toc-section-number">4.4</span> What Type Classes
        Are</a></li>
        <li><a href="#sec:type-classes:display" id="toc-sec:type-classes:display"><span class="toc-section-number">4.5</span> Exercise: Display
        Library</a></li>
        <li><a href="#type-classes-and-variance" id="toc-type-classes-and-variance"><span class="toc-section-number">4.6</span> Type Classes and
        Variance</a></li>
        <li><a href="#conclusions-2" id="toc-conclusions-2"><span class="toc-section-number">4.7</span> Conclusions</a></li>
        </ul></li>
        <li><a href="#sec:interpreters" id="toc-sec:interpreters"><span class="toc-section-number">5</span> Reified Interpreters</a>
        <ul>
        <li><a href="#regular-expressions" id="toc-regular-expressions"><span class="toc-section-number">5.1</span> Regular
        Expressions</a></li>
        <li><a href="#sec:interpreters:reification" id="toc-sec:interpreters:reification"><span class="toc-section-number">5.2</span> Interpreters and
        Reification</a></li>
        <li><a href="#tail-recursive-interpreters" id="toc-tail-recursive-interpreters"><span class="toc-section-number">5.3</span> Tail Recursive
        Interpreters</a></li>
        <li><a href="#conclusions-3" id="toc-conclusions-3"><span class="toc-section-number">5.4</span> Conclusions</a></li>
        </ul></li>
        <li><a href="#sec:cats" id="toc-sec:cats"><span class="toc-section-number">6</span> Using Cats</a>
        <ul>
        <li><a href="#quick-start" id="toc-quick-start"><span class="toc-section-number">6.1</span> Quick Start</a></li>
        <li><a href="#using-cats" id="toc-using-cats"><span class="toc-section-number">6.2</span> Using Cats</a></li>
        <li><a href="#example-eq" id="toc-example-eq"><span class="toc-section-number">6.3</span> Example: Eq</a></li>
        </ul></li>
        <li><a href="#sec:monoids" id="toc-sec:monoids"><span class="toc-section-number">7</span> Monoids and Semigroups</a>
        <ul>
        <li><a href="#definition-of-a-monoid" id="toc-definition-of-a-monoid"><span class="toc-section-number">7.1</span> Definition of a
        Monoid</a></li>
        <li><a href="#definition-of-a-semigroup" id="toc-definition-of-a-semigroup"><span class="toc-section-number">7.2</span> Definition of a
        Semigroup</a></li>
        <li><a href="#monoids-in-cats" id="toc-monoids-in-cats"><span class="toc-section-number">7.3</span> Monoids in Cats</a></li>
        <li><a href="#applications-of-monoids" id="toc-applications-of-monoids"><span class="toc-section-number">7.4</span> Applications of
        Monoids</a></li>
        <li><a href="#summary" id="toc-summary"><span class="toc-section-number">7.5</span> Summary</a></li>
        </ul></li>
        <li><a href="#functors" id="toc-functors"><span class="toc-section-number">8</span> Functors</a>
        <ul>
        <li><a href="#sec:functors:examples" id="toc-sec:functors:examples"><span class="toc-section-number">8.1</span> Examples of
        Functors</a></li>
        <li><a href="#sec:functors:more-examples" id="toc-sec:functors:more-examples"><span class="toc-section-number">8.2</span> More Examples of
        Functors</a></li>
        <li><a href="#definition-of-a-functor" id="toc-definition-of-a-functor"><span class="toc-section-number">8.3</span> Definition of a
        Functor</a></li>
        <li><a href="#aside-higher-kinds-and-type-constructors" id="toc-aside-higher-kinds-and-type-constructors"><span class="toc-section-number">8.4</span> Aside: Higher Kinds and
        Type Constructors</a></li>
        <li><a href="#functors-in-cats" id="toc-functors-in-cats"><span class="toc-section-number">8.5</span> Functors in Cats</a></li>
        <li><a href="#sec:functors:contravariant-invariant" id="toc-sec:functors:contravariant-invariant"><span class="toc-section-number">8.6</span> Contravariant and
        Invariant Functors</a></li>
        <li><a href="#contravariant-and-invariant-in-cats" id="toc-contravariant-and-invariant-in-cats"><span class="toc-section-number">8.7</span> Contravariant and
        Invariant in Cats</a></li>
        <li><a href="#sec:functors:partial-unification" id="toc-sec:functors:partial-unification"><span class="toc-section-number">8.8</span> Aside: Partial
        Unification</a></li>
        <li><a href="#summary-1" id="toc-summary-1"><span class="toc-section-number">8.9</span> Summary</a></li>
        </ul></li>
        <li><a href="#sec:monads" id="toc-sec:monads"><span class="toc-section-number">9</span> Monads</a>
        <ul>
        <li><a href="#what-is-a-monad" id="toc-what-is-a-monad"><span class="toc-section-number">9.1</span> What is a Monad?</a></li>
        <li><a href="#monads-in-cats" id="toc-monads-in-cats"><span class="toc-section-number">9.2</span> Monads in Cats</a></li>
        <li><a href="#sec:monads:identity" id="toc-sec:monads:identity"><span class="toc-section-number">9.3</span> The Identity
        Monad</a></li>
        <li><a href="#either" id="toc-either"><span class="toc-section-number">9.4</span> Either</a></li>
        <li><a href="#aside-error-handling-and-monaderror" id="toc-aside-error-handling-and-monaderror"><span class="toc-section-number">9.5</span> Aside: Error Handling and
        MonadError</a></li>
        <li><a href="#sec:monads:eval" id="toc-sec:monads:eval"><span class="toc-section-number">9.6</span> The Eval Monad</a></li>
        <li><a href="#writer-monad" id="toc-writer-monad"><span class="toc-section-number">9.7</span> The Writer Monad</a></li>
        <li><a href="#sec:monads:reader" id="toc-sec:monads:reader"><span class="toc-section-number">9.8</span> The Reader Monad</a></li>
        <li><a href="#the-state-monad" id="toc-the-state-monad"><span class="toc-section-number">9.9</span> The State Monad</a></li>
        <li><a href="#defining-custom-monads" id="toc-defining-custom-monads"><span class="toc-section-number">9.10</span> Defining Custom
        Monads</a></li>
        <li><a href="#summary-2" id="toc-summary-2"><span class="toc-section-number">9.11</span> Summary</a></li>
        </ul></li>
        <li><a href="#sec:monad-transformers" id="toc-sec:monad-transformers"><span class="toc-section-number">10</span> Monad Transformers</a>
        <ul>
        <li><a href="#exercise-composing-monads" id="toc-exercise-composing-monads"><span class="toc-section-number">10.1</span> Exercise: Composing
        Monads</a></li>
        <li><a href="#a-transformative-example" id="toc-a-transformative-example"><span class="toc-section-number">10.2</span> A Transformative
        Example</a></li>
        <li><a href="#monad-transformers-in-cats" id="toc-monad-transformers-in-cats"><span class="toc-section-number">10.3</span> Monad Transformers in
        Cats</a></li>
        <li><a href="#exercise-monads-transform-and-roll-out" id="toc-exercise-monads-transform-and-roll-out"><span class="toc-section-number">10.4</span> Exercise: Monads:
        Transform and Roll Out</a></li>
        <li><a href="#summary-3" id="toc-summary-3"><span class="toc-section-number">10.5</span> Summary</a></li>
        </ul></li>
        <li><a href="#sec:applicatives" id="toc-sec:applicatives"><span class="toc-section-number">11</span> Semigroupal and
        Applicative</a>
        <ul>
        <li><a href="#sec:semigroupal" id="toc-sec:semigroupal"><span class="toc-section-number">11.1</span> Semigroupal</a></li>
        <li><a href="#apply-syntax" id="toc-apply-syntax"><span class="toc-section-number">11.2</span> Apply Syntax</a></li>
        <li><a href="#semigroupal-applied-to-different-types" id="toc-semigroupal-applied-to-different-types"><span class="toc-section-number">11.3</span> Semigroupal Applied to
        Different Types</a></li>
        <li><a href="#parallel" id="toc-parallel"><span class="toc-section-number">11.4</span> Parallel</a></li>
        <li><a href="#apply-and-applicative" id="toc-apply-and-applicative"><span class="toc-section-number">11.5</span> Apply and
        Applicative</a></li>
        <li><a href="#summary-4" id="toc-summary-4"><span class="toc-section-number">11.6</span> Summary</a></li>
        </ul></li>
        <li><a href="#sec:foldable-traverse" id="toc-sec:foldable-traverse"><span class="toc-section-number">12</span> Foldable and Traverse</a>
        <ul>
        <li><a href="#sec:foldable" id="toc-sec:foldable"><span class="toc-section-number">12.1</span> Foldable</a></li>
        <li><a href="#sec:traverse" id="toc-sec:traverse"><span class="toc-section-number">12.2</span> Traverse</a></li>
        <li><a href="#summary-5" id="toc-summary-5"><span class="toc-section-number">12.3</span> Summary</a></li>
        </ul></li>
        <li><a href="#indexed-types" id="toc-indexed-types"><span class="toc-section-number">13</span> Indexed Types</a>
        <ul>
        <li><a href="#sec:indexed-types:phantom" id="toc-sec:indexed-types:phantom"><span class="toc-section-number">13.1</span> Phantom Types</a></li>
        <li><a href="#indexed-codata" id="toc-indexed-codata"><span class="toc-section-number">13.2</span> Indexed Codata</a></li>
        <li><a href="#indexed-data" id="toc-indexed-data"><span class="toc-section-number">13.3</span> Indexed Data</a></li>
        <li><a href="#conclusions-4" id="toc-conclusions-4"><span class="toc-section-number">13.4</span> Conclusions</a></li>
        </ul></li>
        <li><a href="#optimizing-interpreters-and-compilers" id="toc-optimizing-interpreters-and-compilers"><span class="toc-section-number">14</span> Optimizing Interpreters and
        Compilers</a>
        <ul>
        <li><a href="#algebraic-manipulation" id="toc-algebraic-manipulation"><span class="toc-section-number">14.1</span> Algebraic
        Manipulation</a></li>
        <li><a href="#from-continuations-to-stacks" id="toc-from-continuations-to-stacks"><span class="toc-section-number">14.2</span> From Continuations to
        Stacks</a></li>
        <li><a href="#compilers-and-virtual-machines" id="toc-compilers-and-virtual-machines"><span class="toc-section-number">14.3</span> Compilers and Virtual
        Machines</a></li>
        <li><a href="#from-interpreter-to-stack-machine" id="toc-from-interpreter-to-stack-machine"><span class="toc-section-number">14.4</span> From Interpreter to Stack
        Machine</a></li>
        <li><a href="#conclusions-5" id="toc-conclusions-5"><span class="toc-section-number">14.5</span> Conclusions</a></li>
        </ul></li>
        <li><a href="#sec:usability" id="toc-sec:usability"><span class="toc-section-number">15</span> Creating Usable
        Code</a></li>
        <li><a href="#sec:case-studies:testing" id="toc-sec:case-studies:testing"><span class="toc-section-number">16</span> Case Study: Testing
        Asynchronous Code</a>
        <ul>
        <li><a href="#abstracting-over-type-constructors" id="toc-abstracting-over-type-constructors"><span class="toc-section-number">16.1</span> Abstracting over Type
        Constructors</a></li>
        <li><a href="#abstracting-over-monads" id="toc-abstracting-over-monads"><span class="toc-section-number">16.2</span> Abstracting over
        Monads</a></li>
        <li><a href="#summary-6" id="toc-summary-6"><span class="toc-section-number">16.3</span> Summary</a></li>
        </ul></li>
        <li><a href="#sec:map-reduce" id="toc-sec:map-reduce"><span class="toc-section-number">17</span> Case Study: Map-Reduce</a>
        <ul>
        <li><a href="#parallelizing-map-and-fold" id="toc-parallelizing-map-and-fold"><span class="toc-section-number">17.1</span> Parallelizing
        <em>map</em> and <em>fold</em></a></li>
        <li><a href="#implementing-foldmap" id="toc-implementing-foldmap"><span class="toc-section-number">17.2</span> Implementing
        <em>foldMap</em></a></li>
        <li><a href="#parallelising-foldmap" id="toc-parallelising-foldmap"><span class="toc-section-number">17.3</span> Parallelising
        <em>foldMap</em></a></li>
        <li><a href="#summary-7" id="toc-summary-7"><span class="toc-section-number">17.4</span> Summary</a></li>
        </ul></li>
        <li><a href="#case-study-data-validation" id="toc-case-study-data-validation"><span class="toc-section-number">18</span> Case Study: Data
        Validation</a>
        <ul>
        <li><a href="#sketching-the-library-structure" id="toc-sketching-the-library-structure"><span class="toc-section-number">18.1</span> Sketching the Library
        Structure</a></li>
        <li><a href="#the-check-datatype" id="toc-the-check-datatype"><span class="toc-section-number">18.2</span> The Check
        Datatype</a></li>
        <li><a href="#basic-combinators" id="toc-basic-combinators"><span class="toc-section-number">18.3</span> Basic
        Combinators</a></li>
        <li><a href="#transforming-data" id="toc-transforming-data"><span class="toc-section-number">18.4</span> Transforming
        Data</a></li>
        <li><a href="#kleislis" id="toc-kleislis"><span class="toc-section-number">18.5</span> Kleislis</a></li>
        <li><a href="#summary-8" id="toc-summary-8"><span class="toc-section-number">18.6</span> Summary</a></li>
        </ul></li>
        <li><a href="#case-study-crdts" id="toc-case-study-crdts"><span class="toc-section-number">19</span> Case Study: CRDTs</a>
        <ul>
        <li><a href="#eventual-consistency" id="toc-eventual-consistency"><span class="toc-section-number">19.1</span> Eventual
        Consistency</a></li>
        <li><a href="#the-gcounter" id="toc-the-gcounter"><span class="toc-section-number">19.2</span> The GCounter</a></li>
        <li><a href="#generalisation" id="toc-generalisation"><span class="toc-section-number">19.3</span> Generalisation</a></li>
        <li><a href="#abstracting-gcounter-to-a-type-class" id="toc-abstracting-gcounter-to-a-type-class"><span class="toc-section-number">19.4</span> Abstracting GCounter to a
        Type Class</a></li>
        <li><a href="#abstracting-a-key-value-store" id="toc-abstracting-a-key-value-store"><span class="toc-section-number">19.5</span> Abstracting a Key Value
        Store</a></li>
        <li><a href="#summary-9" id="toc-summary-9"><span class="toc-section-number">19.6</span> Summary</a></li>
        </ul></li>
        <li><a href="#acknowledgements" id="toc-acknowledgements"><span class="toc-section-number">20</span> Acknowledgements</a>
        <ul>
        <li><a href="#acknowledgements-from-scala-with-cats" id="toc-acknowledgements-from-scala-with-cats"><span class="toc-section-number">20.1</span> Acknowledgements from
        Scala with Cats</a></li>
        </ul></li>
        </ul>
      </details>
    </div>
  </nav>
  <header>
    <div class="container-lg title-block">
            <h1 class="title">Functional Programming
Strategies<span class="subtitle">In Scala with Cats</span></h1>
            <h3 class="author">By Noel Welsh</h3>
                  <p class="date">June 2024 Edition</p>
                  <p>Published by <a href="https://inner-product.com/">Inner Product</a></p>
    </div>
  </header>

<div class="container-lg">
  <article>
    <h1 class="unnumbered" id="preface">Preface</h1>
    <p>Some twenty years ago I started my first job in the UK. This job
    involved a commute by train, giving me about an hour a day to read
    without distraction. Around about the same time I first heard about
    <em>Structure and Interpretation of Computer Programs</em>, referred
    to as the “wizard book” and spoken of in reverential terms. It
    sounded like the just the thing for a recent graduate looking to
    become a better developer. I purchased a copy and spent the journey
    reading it, doing most of the exercises in my head. <em>Structure
    and Interpretation of Computer Programs</em> was already an old book
    at this time, and it’s programming style was archaic. However it’s
    core concepts were timeless and it’s fair to say it absolutely blew
    my mind, putting me on a path I’m still on today.</p>
    <p>Another notable stop on this path occured some ten years ago when
    Dave and I started writing <em>Scala with Cats</em>. In <em>Scala
    with Cats</em> we attempted to explain the core type classes found
    in the Cats library, and their use in building software. I’m proud
    of the book we wrote together, but time and experience showed that
    type classes are only a small piece of the puzzle of building
    software in a functional programming style. We needed a much wider
    scope if we were to show people how to effectively build software
    with all the tools that functional programming provides. Still,
    writing a book is a lot of work, and we were busy with other
    projects, so <em>Scala with Cats</em> remained largely untouched for
    many years.</p>
    <p>Around 2020 I got the itch to return to <em>Scala with Cats</em>.
    My initial plan was simply to update the book for Scala 3. Dave was
    busy with other projects so I decided to go alone. As the writing
    got underway I realized I really wanted to cover the additional
    topics I thought were missing. If <em>Scala with Cats</em> was a
    good book, I wanted to aim to write a great book; one that would
    contain almost everything I had learned about building software. The
    title <em>Scala with Cats</em> no longer fit the content, and hence
    I adopted a new name for what is largely a new book. The result,
    <em>Functional Programming Strategies in Scala with Cats</em>, is
    what you are reading now. I hope you find it useful, and I hope that
    just maybe some young developer will find this book inspiring the
    same way I found <em>Structure and Interpretation of Computer
    Programs</em> inspiring all those years ago.</p>
    <h2 class="unnumbered" id="preface-from-scala-with-cats">Preface
    from Scala with Cats</h2>
    <p>The aims of this book are two-fold: to introduce monads,
    functors, and other functional programming patterns as a way to
    structure program design, and to explain how these concepts are
    implemented in <a href="http://typelevel.org/cats">Cats</a>.</p>
    <p>Monads, and related concepts, are the functional programming
    equivalent of object-oriented design patterns—architectural building
    blocks that turn up over and over again in code. They differ from
    object-oriented patterns in two main ways:</p>
    <ul>
    <li>they are formally, and thus precisely, defined; and</li>
    <li>they are extremely (extremely) general.</li>
    </ul>
    <p>This generality means they can be difficult to understand.
    <em>Everyone</em> finds abstraction difficult. However, it is
    generality that allows concepts like monads to be applied in such a
    wide variety of situations.</p>
    <p>In this book we aim to show the concepts in a number of different
    ways, to help you build a mental model of how they work and where
    they are appropriate. We have extended case studies, a simple
    graphical notation, many smaller examples, and of course the
    mathematical definitions. Between them we hope you’ll find something
    that works for you.</p>
    <p>Ok, let’s get started!</p>
    <h2 class="unnumbered" id="versions">Versions</h2>
    <p>This book is written for Scala 3.3.3 and Cats 2.10.0. Here is a
    minimal <code>build.sbt</code> containing the relevant dependencies
    and settings<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>:</p>
    <div class="sourceCode" id="cb1"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>scalaVersion <span class="op">:=</span> <span class="st">&quot;3.3.3&quot;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>libraryDependencies <span class="op">+=</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;org.typelevel&quot;</span> <span class="op">%%</span> <span class="st">&quot;cats-core&quot;</span> <span class="op">%</span> <span class="st">&quot;2.10.0&quot;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>scalacOptions <span class="op">++=</span> <span class="bu">Seq</span><span class="op">(</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;-Xfatal-warnings&quot;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span></code></pre></div>
    <h3 class="unnumbered" id="template-projects">Template Projects</h3>
    <p>For convenience, we have created a Giter8 template to get you
    started. To clone the template type the following:</p>
    <div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sbt new scalawithcats/cats-seed.g8</span></code></pre></div>
    <p>This will generate a sandbox project with Cats as a dependency.
    See the generated <code>README.md</code> for instructions on how to
    run the sample code and/or start an interactive Scala console.</p>
    <p>The <code>cats-seed</code> template is very minimal. If you’d
    prefer a more batteries-included starting point, check out
    Typelevel’s <code>sbt-catalysts</code> template:</p>
    <div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sbt new typelevel/sbt-catalysts.g8</span></code></pre></div>
    <p>This will generate a project with a suite of library dependencies
    and compiler plugins, together with templates for unit tests and
    documentation. See the project pages for <a href="https://github.com/typelevel/catalysts">catalysts</a> and <a href="https://github.com/typelevel/sbt-catalysts">sbt-catalysts</a>
    for more information.</p>
    <h2 class="unnumbered" id="conventions-used-in-this-book">Conventions Used in This
    Book</h2>
    <p>This book contains a lot of technical information and program
    code. We use the following typographical conventions to reduce
    ambiguity and highlight important concepts:</p>
    <h3 class="unnumbered" id="typographical-conventions">Typographical
    Conventions</h3>
    <p>New terms and phrases are introduced in <em>italics</em>. After
    their initial introduction they are written in normal roman
    font.</p>
    <p>Terms from program code, filenames, and file contents, are
    written in <code>monospace font</code>. Note that we do not
    distinguish between singular and plural forms. For example, we might
    write <code>String</code> or <code>Strings</code> to refer to
    <code>java.lang.String</code>.</p>
    <p>References to external resources are written as <a href="https://underscore.io">hyperlinks</a>. References to API
    documentation are written using a combination of hyperlinks and
    monospace font, for example: <a href="http://www.scala-lang.org/api/current/scala/Option.html"><code>scala.Option</code></a>.</p>
    <h3 class="unnumbered" id="source-code">Source Code</h3>
    <p>Source code blocks are written as follows. Syntax is highlighted
    appropriately where applicable:</p>
    <div class="sourceCode" id="cb4"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> MyApp <span class="kw">extends</span> App <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">println</span><span class="op">(</span><span class="st">&quot;Hello world!&quot;</span><span class="op">)</span> <span class="co">// Print a fine message to the user!</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Most code passes through <a href="https://github.com/scalameta/mdoc">mdoc</a> to ensure it
    compiles. mdoc uses the Scala console behind the scenes, so we
    sometimes show console-style output as comments:</p>
    <div class="sourceCode" id="cb5"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;Hello Cats!&quot;</span><span class="op">.</span>toUpperCase</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res0: String = &quot;HELLO CATS!&quot;</span></span></code></pre></div>
    <h3 class="unnumbered" id="callout-boxes">Callout Boxes</h3>
    <p>We use two types of <em>callout box</em> to highlight particular
    content:</p>
    <div class="callout callout-info">
    <p>Tip callouts indicate handy summaries, recipes, or best
    practices.</p>
    </div>
    <div class="callout callout-warning">
    <p>Advanced callouts provide additional information on corner cases
    or underlying mechanisms. Feel free to skip these on your first
    read-through—come back to them later for extra information.</p>
    </div>
    <h2 class="unnumbered" id="license">License</h2>
    <p>This work is licensed under CC BY-SA 4.0. To view a copy of this
    license, visit <a href="http://creativecommons.org/licenses/by-sa/4.0/">http://creativecommons.org/licenses/by-sa/4.0/</a></p>
    <p>Portions of this work are based on <em>Scala with Cats</em> by
    Dave Pereira-Gurnell and Noel Welsh, which is licensed under CC
    BY-SA 3.0.</p>
    <h1 data-number="1" id="functional-programming-strategies"><span class="header-section-number">1</span> Functional Programming
    Strategies</h1>
    <p>これは、関数型プログラミングの流儀でコードを書くための戦略について、Scalaを通して捉え、解説した本である。もし、Scalaについてほぼ理解しているものの、この言語を効果的に用いる方法に何か不足を感じているのであれば、この本はあなたに最適だろう。また、Scalaについてあまり知らない場合でも、関数型プログラミングの学習の一環としてScalaを学ぶ準備ができているなら、そんなあなたにもこの本は適している。この本では、モナドやモノイドといった一般的な関数型プログラミングの抽象概念を扱うが、それ以上に、関数型プログラマらしい思考方法について教えることを目指している。思考の結果としてのコードだけでなく、思考過程について記述しており、特に私がメタ認知的プログラミング戦略と呼ぶものに焦点を当てている。</p>
    <p>ほとんどのプログラマは、自分がコードを発想し記述するプロセスを説明せよと言われても戸惑うのではないだろうか。一部の人は「テスト駆動開発」や「ペアプログラミング」を挙げるかもしれないが、一般的なプログラマからそれ以上の説明を期待するのは難しいだろう。それらのテクニックはどちらも90年代後半に登場したエクストリームプログラミングに由来している。その後、この分野に新たな知見が積み重ねられていることを期待したが、現実はそうではなかったようだ。とはいえ、これは開発者の責任というより、彼らの多くが明示的な手法を教えられていないことに原因がある。IT業界は確かにアジャイルやカンバンボードなどの形でプロセスについて語ることが好きだし、近年ではプログラミング教育の対象を拡げるために大変な努力が費やされている。しかし、実際のプログラミング、つまりシステム開発の要であるコードを生み出す部分は、いまだに魔法のように扱われることが多い。</p>
    <p>関数型プログラマは単純なアイデアに対して難解な言葉を使うのを好む。だから、私が「メタ認知的プログラミング戦略」に惹かれるのも当然かもしれない。このフレーズの意味を解き明かしてみよう。「メタ認知」とは「考えることについて考える」という意味である。多くの研究が、学習におけるメタ認知の有益性と、それが専門性を高めるための重要な要素であることを示している。ただし、メタ認知を「自分の考えについて考える」というひとつの事柄として大雑把に捉えるだけでは不十分である。解像度を上げれば、メタ認知されるのはさまざまな戦略の集合であり、一般的なものもあれば、特定の分野に特化したものもある。ここから「メタ認知的プログラミング戦略」という概念が生まれる。つまり、熟練したプログラマが使用するさまざまな思考戦略に明確な名前と説明をつけようということである。</p>
    <p>メタ認知的プログラミング戦略は、初心者にも熟練者にも有益だと私は考えている。初心者に対しては、プログラミングをより体系的で再現可能なプロセスにすることができる。ほとんどの場合、コードを生み出すのに魔法は不要となり、明確に定義された手順を適用すればよくなる。その利点はそのまま熟練者にも当てはまる。少なくとも私の経験ではそうだった（私は専門家を名乗るに十分な期間プログラムを書いてきたと思っている）。明確なプロセスがあれば、毎日それを同じ方法で実行すればよい。コードの読み書きはシンプルになり、脳のリソースをもっと重要な問題に集中させることが可能となる。ある意味、これは製造業、特に「トヨタ方式」がもたらしたプロセスや標準化の利点をプログラミングに持ち込もうとする試みだと言える。トヨタのプロセスでは、作業者が自分の仕事の進め方を考え、それをどう改善できるかを思考することが求められる。これは実質的に、組み立てラインにおけるメタ認知である。これは、作業者が日々の実際の作業に全ての注意を向ける必要がなく、思考に余裕があってはじめて可能となる。トヨタが先駆けた自動車製造における生産性と品質の劇的な向上は、このアプローチの有効性を示している。ソフトウェア開発は自動車製造ほど一様ではないが、それでも同様の恩恵が期待できるだろう。特に、現在の業界がまだ未熟な状態であることを考えればなおさらである。</p>
    <p>次に、プログラマがどのようなメタ認知的戦略を使えるかが問題となる。その答えを考えるのに関数型プログラミングが特に適していると私は考えている。関数型プログラミングの研究では、役立つコード構造を発見し、名前を付けることが主要なテーマである。役立つ抽象概念が発見され普及すれば、プログラマは直面する課題をその抽象概念で解決できるかどうかと考えることが可能になる。これは90年代にデザインパターンのコミュニティが行ったことと本質的には同じだが、重要な違いがある。それは、関数型プログラミングの学術的コミュニティが形式的なモデルを非常に重視しているため、関数型プログラミングの構成要素はデザインパターンが欠いている精密さを持っていることである。とはいえ、プログラミングのプロセスは単に完成したコード構造の分類にとどまらず、コードがどのように発想されてくるかという現実的な過程が含まれる。コードは通常、完全な形でキーボードから生まれるわけではなく、反復的な精緻化の中で構造を見出される。この点に関して関数型プログラミングの学術コミュニティはあまり語っていないが、「型駆動開発」などの技法に関する強い実践的な知恵がある。</p>
    <p>過去10年ほどのプログラミングおよびプログラミング教育の中で、私は幅広い戦略を集めてきた。いくつかは他者から学んだものだが（たとえば、『<a href="http://htdp.org/">How to Design
    Programs</a>』やその多くの派生書から大きな影響を受けている）、自分自身で発見したものもある。だが、突き詰めると、ここで紹介する内容に真新しいものはない。私の貢献は、これらの戦略を一か所にまとめて提示することにある。</p>
    <h2 data-number="1.1" id="コードを考えるための3つのレベル"><span class="header-section-number">1.1</span>
    コードを考えるための3つのレベル</h2>
    <p>プログラミングについての思考を始めよう。ここでは、コードを考えるための三つの異なるレベルを示すモデルを紹介する。これらのレベルを、上から順にパラダイム（paradigm）、理論（theory）、そして技能（craft）と呼ぶ。各レベルは、それより下位のレベルに対して指針を提供してくれる。</p>
    <!-- TODO: craftの訳語「技能」は仮。再検討する -->
    <p>パラダイムレベルとは、オブジェクト指向や関数型プログラミングといったプログラミングパラダイムのことを指す。これらの用語には馴染みのある方も多いと思うが、プログラミングパラダイムとは一体何だろうか。私にとって、プログラミングパラダイムの核心は、よいコードとはどういうものかを緩やかに定める一連の原則である。また、「これらの原則に従ったコードは、そうでないコードよりも優れている」という暗黙の主張もパラダイムには含まれている。関数型プログラミングにおける原則は合成（composition）と推論（reasoning）であると私は考えている。この二つの原則については改めて説明する。一方、オブジェクト指向プログラマは、たとえばSOLID原則をコーディングにおける意思決定の指針として挙げるかもしれない。</p>
    <p>パラダイムは、それが異なる実装戦略の中からいずれかを選ぶための基準を示してくれるという点で重要である。プログラミングの課題には多くの解決策が存在するが、どのアプローチを取るべきかを、パラダイムによって示される原則にもとづいて判断することができる。たとえば、関数型プログラマであれば、特定の実装についてどれだけ簡単に理解し実行結果を予測できるか、それがどれだけ合成可能であるかを検討するだろう。パラダイムがないというのは、そういった選択を行うための基準がないということである。</p>
    <p>理論レベルでは、パラダイムの広範な原則が具体的で明確に定義されたテクニックに翻訳される。それらのテクニックは、パラダイム内の多くの言語に適用できるが、この段階でもまだコードレベルの具体性はもたない。オブジェクト指向の世界では、デザインパターンがその一例であり、関数型プログラミングにおいては、代数的データ型がその一例である。多くの関数型プログラミング言語、たとえばHaskellやO’Camlは代数的データ型をサポートしているし、複数のパラダイムをまたぐRust、Scala、Swiftといった言語も同様にサポートしている。</p>
    <p>理論レベルは、私たちがプログラミング戦略の大部分を見出す場所となる。</p>
    <p>At the craft level we get to actual code, and the language
    specific nuance that goes into it. An example in Scala is the
    implementation of algebraic data types in terms of
    <code>sealed trait</code> and <code>final case class</code> in Scala
    2, or <code>enum</code> in Scala 3. There are many concerns at this
    level that are important for writing idiomatic code, such as placing
    constructors on companion objects in Scala, that are not relevant at
    the higher levels.</p>
    <p>技能レベルでは、具体的なコードや、それと関連する言語固有のニュアンスを取り扱う。Scalaにおける例として、代数的データ型はScala2では
    <code>sealed trait</code> と <code>final case class</code>
    を使って実装され、Scala3では <code>enum</code>
    で実装される。このレベルには、Scalaでコンパニオンオブジェクトにコンストラクタを配置するなど、上位レベルには存在しなかった、慣用的なコードを書くための多くの考慮事項が存在する。</p>
    <p>In the next section I’ll describe the functional programming
    paradigm. The remainder of this book is primarily concerned with
    theory and craft. The theory is language agnostic but the craft is
    firmly in the world of Scala. Before we move onto the functional
    programming paradigm are two points I want to emphasize:</p>
    <p>次節では関数型プログラミングのパラダイムについて説明し、本書の残りの部分では主に理論と技能に焦点を当てる。理論は特定の言語に依存しないが、技能はScalaに特化したものとなる。関数型プログラミングのパラダイムへと進む前に、二つの点を強調しておきたい。</p>
    <ol type="1">
    <li><p>Paradigms are social constructs. They change over time.
    Object-oriented programming as practiced todays differs from the
    style originally used in Simula and Smalltalk, and functional
    programming todays is very different from the original LISP
    code.</p></li>
    <li><p>パラダイムは社会的構築物であり、時間とともに変化する。現在のオブジェクト指向プログラミングは、元々SimulaやSmalltalkで使用されていた流儀とは異なるし、今日の関数型プログラミングも、初期のLISPコードとは大きく異なる。</p></li>
    <li><p>The three level organization is just a tool for thought. In
    real world is more complicated.</p></li>
    <li><p>この三層構造は、あくまで思考のためのツールに過ぎない。現実の世界はもっと複雑である。</p></li>
    </ol>
    <h2 data-number="1.2" id="関数型プログラミング"><span class="header-section-number">1.2</span> 関数型プログラミング</h2>
    <p>This is a book about the techniques and practices of functional
    programming (FP). This naturally leads to the question: what is FP
    and what does it mean to write code in a functional style? It’s
    common to view functional programming as a collection of language
    features, such as first class functions, or to define it as a
    programming style using immutable data and pure functions. (Pure
    functions always return the same output given the same input.) This
    was my view when I started down the FP route, but I now believe the
    true goals of FP are enabling local reasoning and composition.
    Language features and programming style are in service of these
    goals. Let me attempt to explain the meaning and value of local
    reasoning and composition.</p>
    <p>この本では、関数型プログラミングの技法と実践について解説している。ここで、関数型プログラミングとは何か、そして関数型の流儀でコードを書くとはどういうことか、という疑問が当然に生じる。関数型プログラミングを、ファーストクラス関数のような言語機能の集合として捉えたり、不変データと純粋関数を使うプログラミングスタイルとして定義したりするのは一般的で（純粋関数とは、同じ入力に対して常に同じ出力を返す関数のこと）、私も当初はそのように考えていた。だが、今では、関数型プログラミングの核心は局所推論（local
    reasoning）と合成（composition）であると考えている。言語機能やプログラミングスタイルは、これらの目標を達成するための手段に過ぎない。次に、局所推論と合成の意味と価値について説明しよう。</p>
    <h3 data-number="1.2.1" id="関数型プログラミングとは何か"><span class="header-section-number">1.2.1</span>
    関数型プログラミングとは何か</h3>
    <p>I believe that functional programming is a hypothesis about
    software quality: that it is easier to write and maintain software
    that can be understood before it is run, and is built of small
    reusable components. The first property is known as local reasoning,
    and the second as composition. Let’s address each in turn.</p>
    <p>関数型プログラミングはソフトウェア品質に関する仮説だと私は考えている。実行する前に理解できるソフトウェア、そして小さく再利用可能なコンポーネントで構築されたソフトウェアの方が、書くことも保守することも容易だという考え方である。前者の特性は「局所推論」として知られており、後者は「合成」と呼ばれている。</p>
    <p>Local reasoning means we can understand pieces of code in
    isolation. When we see the expression <code>1 + 1</code> we know
    what it means regardless of the weather, the database, or the
    current status of our Kubernetes cluster. None of these external
    events can change it. This is a trivial and slightly silly example,
    but it illustrates the point. A goal of functional programming is to
    extend this ability across our code base.</p>
    <p>局所推論とは、コードの一部を他から切り離して理解できるということを意味する。たとえば、<code>1 + 1</code>
    という式は、天気やデータベースの状態、現在のKubernetesクラスタの状況に関係なく、その意味を理解可能である。外部要因が式の意味を変えることはない。この例は単純で少し滑稽だが、要点をよく表している。関数型プログラミングの目標のひとつは、この特性をコード全体に拡げることである。</p>
    <p>It can help to understand local reasoning by looking at what it
    is not. Shared mutable state is out because relying on shared state
    means that other code can change what our code does without our
    knowledge. It means no global mutable configuration, as found in
    many web frameworks and graphics libraries for example, as any
    random code can change that configuration. Metaprogramming has to be
    carefully controlled. No <a href="https://ja.wikipedia.org/wiki/%E3%83%A2%E3%83%B3%E3%82%AD%E3%83%BC%E3%83%91%E3%83%83%E3%83%81">monkey
    patching</a>, for example, as again it allows other code to change
    our code in non-obvious ways. As we can see, adapting code to enable
    local reasoning can mean quite some sweeping changes. However if we
    work in a language that embraces functional programming this style
    of programming is the default.</p>
    <p>局所推論について理解しようとするなら、それが何でないかを考えることが役立つかもしれない。可変状態を共有していると局所推論はできなくなる。なぜなら、共有された状態に依存すると、そのコードの動作を他のコードが知らないうちに変えてしまう可能性があるからである。敷衍すると、多くのウェブフレームワークやグラフィックスライブラリに見られるような、グローバルな可変の設定オブジェクトも使うことができない。使えば、任意のコードがその設定を変更できてしまう。また、メタプログラミングも慎重に管理する必要がある。<a href="https://ja.wikipedia.org/wiki/%E3%83%A2%E3%83%B3%E3%82%AD%E3%83%BC%E3%83%91%E3%83%83%E3%83%81">モンキーパッチ</a>も他のコードが明示的でない方法でコードを変更できてしまうので、避けるべきである。このように、局所推論が可能となるようコードを適応させるには、かなり大きな変更が必要になることがある。しかし、関数型プログラミングを取り入れた言語で作業するのであれば、このプログラミングスタイルが基本となる。</p>
    <p>Composition means building big things out of smaller things.
    Numbers are compositional. We can take any number and add one,
    giving us a new number. Lego is also compositional. We compose Lego
    by sticking it together. In the particular sense we’re using
    composition we also require the original elements we combine don’t
    change in any way when they are composed. When we create by
    <code>2</code> by adding <code>1</code> and <code>1</code> we get a
    new result that doesn’t change what <code>1</code> means.</p>
    <p>合成とは、小さなものを組み合わせて大きなものを作ることを指す。たとえば、数は合成可能である。どんな数でも、1を足せば新しい数が得られる。レゴもまた合成可能である。ブロック同士をくっつけることで組み立てることができる。ここで私たちが指している合成という概念では、組み合わせる元となる要素が、合成をしたあとも変化しないことが求められる。たとえば、<code>1</code>
    と <code>1</code> を足して <code>2</code>
    を作るとき、その結果として新しい数が得られるが、この操作は1そのものの意味を変えるわけではない。</p>
    <p>We can find compositional ways to model common programming tasks
    once we start looking for them. React components are one example
    familiar to many front-end developers: a component can consist of
    many components. HTTP routes can be modelled in a compositional way.
    A route is a function from an HTTP request to either a handler
    function or a value indicating the route did not match. We can
    combine routes as a logical or: try this route or, if it doesn’t
    match, try this other route. Processing pipelines are another
    example that often use sequential composition: perform this pipeline
    stage and then this other pipeline stage.</p>
    <p>よくあるプログラミングのタスクをモデル化する合成的手法は、探してみると結構見つかる。多くのフロントエンド開発者に馴染みのある例としては、Reactコンポーネントがある。Reactコンポーネントは、複数のコンポーネントを組み合わせて作成することができる。また、HTTPルートも合成的手法でモデル化される。ひとつのルートとは、HTTPリクエストからハンドラ関数、もしくはルートが一致しなかったことを示す値へとマッピングする関数で、そして、ルートを論理和として組み合わせることで、特定のルートが一致しなければ別のルートを試す、という挙動を実現する。パイプライン処理にも順次的な合成がよく利用される。パイプラインのあるステージを最初に実行し、その後に別のステージを実行する、というものである。</p>
    <h4 data-number="1.2.1.1" id="型"><span class="header-section-number">1.2.1.1</span> 型</h4>
    <p>Types are not strictly part of functional programming but
    statically typed FP is the most popular form of FP and sufficiently
    important to warrant a mention. Types help compilers generate
    efficient code but types in FP are as much for the programmer as
    they are the compiler. Types express properties of programs, and the
    type checker automatically ensures that these properties hold. They
    can tell us, for example, what a function accepts and what it
    returns, or that a value is optional. We can also use types to
    express our beliefs about a program and the type checker will tell
    us if those beliefs are correct. For example, we can use types to
    tell the compiler we do not expect an error at a particular point in
    our code and the type checker will let us know if this is the case.
    In this way types are another tool for reasoning about code.</p>
    <p>型は厳密には関数型プログラミングの一部ではないが、関数型言語の中でも静的型付けされたものが最もよく用いられているので、言及しておく価値がある。型はコンパイラが効率的なコードを生成するのを助けるが、関数型プログラミングにおける型はコンパイラだけでなくプログラマのためのものでもある。型はプログラムの特性を表現し、型チェッカーはそれらの特性が守られていることを自動的に保証してくれる。たとえば、関数が何を受け取り、何を返すかや、ある値がオプションであるといったことを型が示してくれる。さらに、型を使ってプログラムに対する自分の仮定を表現し、型チェッカーにそれが正しいかどうかを確認してもらうこともできる。たとえば、コードのある場所において、そこでエラーは発生しないと想定していることを型でコンパイラに伝えることができ、型チェッカーがそれが正しいかどうかを教えてくれる。このように、型はコードに対する推論を行うためのもうひとつのツールとなる。</p>
    <p>Type systems push programs towards particular designs, as to work
    effectively with the type checker requires designing code in a way
    the type checker can understand. As modern type systems come to more
    languages they naturally tend to shift programmers in those
    languages towards a FP style of coding.</p>
    <p>型システムはプログラムを特定の設計へと導く。型チェッカーと効果的に連携するためには、型チェッカーが理解できる作法でコードを設計することが要求されるからである。現代の型システムが多くの言語に導入されるにつれて、その言語のプログラマは自然と関数型プログラミングのスタイルへと移行する傾向がある。</p>
    <h3 data-number="1.2.2" id="関数型プログラミングは何でないか"><span class="header-section-number">1.2.2</span>
    関数型プログラミングは何でないか</h3>
    <p>In my view functional programming is not about immutability, or
    keeping to “the substitution model of evaluation”, and so on. These
    are tools in service of the goals of enabling local reasoning and
    composition, but they are not the goals themselves. Code that is
    immutable always allows local reasoning, for example, but it is not
    necessary to avoid mutation to still have local reasoning. Here is
    an example of summing a collection of numbers.</p>
    <p>私の考えでは、関数型プログラミングの本質は不変性や「評価の置換モデル」などではない。これらは、局所推論と合成を可能にするための手段に過ぎず、目的ではないのである。たとえば、不変なコードは常に局所推論を可能にするが、可変性を避けなくても局所推論を行うことはできる。整数のコレクションを合計する例を考えてみよう。</p>
    <div class="sourceCode" id="cb6"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">sum</span><span class="op">(</span>numbers<span class="op">:</span> <span class="ex">List</span><span class="op">[</span><span class="bu">Int</span><span class="op">]):</span> <span class="bu">Int</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> total <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  numbers<span class="op">.</span><span class="fu">foreach</span><span class="op">(</span>x <span class="op">=&gt;</span> total <span class="op">=</span> total <span class="op">+</span> x<span class="op">)</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  total</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>In the implementation we mutate <code>total</code>. This is ok
    though! We cannot tell from the outside that this is done, and
    therefore all users of <code>sum</code> can still use local
    reasoning. Inside <code>sum</code> we have to be careful when we
    reason about <code>total</code> but this block of code is small
    enough that it shouldn’t cause any problems.</p>
    <p>この実装では <code>total</code>
    変数の値を変更しているが、問題はない。そのような操作が行われていることは外部からは分からないし、<code>sum</code>
    の利用者は引き続き局所推論を行うことができる。<code>sum</code>
    の内部では <code>total</code>
    に関して慎重に考察する必要があるが、このコードブロックは十分に小さいため、特に問題を引き起こすことはないだろう。</p>
    <p>In this case we can reason about our code despite the mutation,
    but the Scala compiler can determine that this is ok. Scala allows
    mutation but it’s up to us to use it appropriately. A more
    expressive type system, perhaps with features like Rust’s, would be
    able to tell that <code>sum</code> doesn’t allow mutation to be
    observed by other parts of the system<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>. Another approach, which is the
    one taken by Haskell, is to disallow all mutation and thus guarantee
    it cannot cause problems.</p>
    <p>この場合、可変変数を使いながらも、私たちはコードについて推論できるし、Scalaコンパイラもこれを問題なしと判断できる。Scalaは可変性を許容しており、可変性を適切に使用するかどうかは私たち次第となる。より表現力のある型システム、たとえばRustのような機能を持つ型システムであれば、<code>sum</code>
    がシステムの他の部分から観測される変更を認めていないことを保証できるだろう<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>。すべての可変性を禁止することによって、問題が生じないことを保証するアプローチもある。Haskellはこの方法を採用している。</p>
    <p>Mutation also interferes with composition. For example, if a
    value relies on internal state then composing it may produce
    unexpected results. Consider Scala’s <code>Iterator</code>. It
    maintains internal state that is used to generate the next value. If
    we have two <code>Iterators</code> we might want to combine them
    into one <code>Iterator</code> that yields values from the two
    inputs. The <code>zip</code> method does this.</p>
    <p>This works if we pass two distinct generators to
    <code>zip</code>.</p>
    <p>可変性は合成にも影響を与える。たとえば、ある値が内部状態に依存している場合、それを合成すると予期しない結果を生む可能性がある。Scalaの
    <code>Iterator</code> を考えてみよう。<code>Iterator</code>
    は次の値を生成するために内部状態を保持している。二つの
    <code>Iterator</code>
    があり、それらを組み合わせて二つの入力から値を返す
    <code>Iterator</code>
    を作りたいと思ったとする。このような合成をするには <code>zip</code>
    メソッドを使う。</p>
    <p>この合成は、二つの別々のジェネレータを <code>zip</code>
    に渡せば、正しく動作する。</p>
    <div class="sourceCode" id="cb7"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> it <span class="op">=</span> <span class="ex">Iterator</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> it2 <span class="op">=</span> <span class="ex">Iterator</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb8"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>it<span class="op">.</span><span class="fu">zip</span><span class="op">(</span>it2<span class="op">).</span><span class="fu">next</span><span class="op">()</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res0: Tuple2[Int, Int] = (1, 1)</span></span></code></pre></div>
    <p>However if we pass the same generator twice we get a surprising
    result.</p>
    <p>だが、同じジェネレータを二度使用すると、期待と異なる結果になる。</p>
    <div class="sourceCode" id="cb9"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> it3 <span class="op">=</span> <span class="ex">Iterator</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb10"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>it3<span class="op">.</span><span class="fu">zip</span><span class="op">(</span>it3<span class="op">).</span><span class="fu">next</span><span class="op">()</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: Tuple2[Int, Int] = (1, 2)</span></span></code></pre></div>
    <p>The usual functional programming solution is to avoid mutable
    state but we can envisage other possibilities. For example, an <a href="https://en.wikipedia.org/wiki/Effect_system">effect tracking
    system</a> would allow us to avoid combining two generators that use
    the same memory region. These systems are still research projects,
    however.</p>
    <p>関数型プログラミングにおける一般的な解決策は可変状態を避けることだが、他の方法も考えられる。たとえば、<a href="https://en.wikipedia.org/wiki/Effect_system">エフェクト追跡システム</a>を使用すれば、同じメモリ領域を使用する二つのジェネレータの組み合わせを避けることができる。しかし、これらのシステムはまだ研究段階にある。</p>
    <p>So in my opinion immutability (and purity, referential
    transparency, and no doubt more fancy words that I have forgotten)
    have become associated with functional programming because they
    guarantee local reasoning and composition, and until recently we
    didn’t have the language tools to automatically distinguish safe
    uses of mutation from those that cause problems. Restricting
    ourselves to immutability is the easiest way to ensure the desirable
    properties of functional programming, but as languages evolve this
    might come to be regarded as a historical artifact.</p>
    <p>私の考えでは、不変性（および純粋性や参照透過性、そして覚えていないが何とかというもっと難解な概念）が関数型プログラミングと結びついているのは、それらが局所推論と合成を保証するからである。そして、最近まで、可変性の安全な使い方と問題を引き起こす使い方を自動的に区別できる言語ツールは存在しなかった。不変性の制約を受け入れることは、関数型プログラミングの望ましい特性を確保するための最も簡単な方法だが、言語が進化するにつれて、これが過去の遺物と見なされる可能性もある。</p>
    <h3 data-number="1.2.3" id="なぜ重要なのか"><span class="header-section-number">1.2.3</span> なぜ重要なのか</h3>
    <p>I have described local reasoning and composition but have not
    discussed their benefits. Why are they are desirable? The answer is
    that they make efficient use of knowledge. Let me expand on
    this.</p>
    <p>局所推論と合成について述べてきたが、その利点についてはまだ触れていない。これらが望ましいとされる理由は、それによって知識を効率的に活用できるからである。この点について詳しく説明しよう。</p>
    <p>We care about local reasoning because it allows our ability to
    understand code to scale with the size of the code base. We can
    understand module A and module B in isolation, and our understanding
    does not change when we bring them together in the same program. By
    definition if both A and B allow local reasoning there is no way
    that B (or any other code) can change our understanding of A, and
    vice versa. If we don’t have local reasoning every new line of code
    can force us to revisit the rest of the code base to understand what
    has changed. This means it becomes exponentially harder to
    understand code as it grows in size as the number of interactions
    (and hence possible behaviours) grows exponentially. We can say that
    local reasoning is compositional. Our understanding of module A
    calling module B is just our understanding of A, our understanding
    of B, and whatever calls A makes to B.</p>
    <p>局所推論が重要なのは、コードベースの規模が大きくなっても、コードを理解する能力がスケールするからである。モジュールAとモジュールBをそれぞれ単独で理解できるなら、それらをひとつのプログラム中で一緒に用いたとしても、その理解が変わることはない。定義上、AとBの両方が局所推論を可能とする場合、B（または他のコード）がAについての理解を変えることはないし、その逆も同じことが言える。もし局所推論ができなければ、新しいコードを1行追加するごとに、既存のコード全体を再確認して何が変わったのかを理解する必要が生じる。コードは、サイズが大きくなり、相互作用の数（およびそれに伴うかもしれない挙動）が急増するにつれて、理解するのが指数関数的に難しくなる。局所推論は合成的であると言える。モジュールAによるモジュールB呼び出しを理解したいなら、AおよびB、そしてAがBに対して行う呼び出しの内容を理解するだけでよい。</p>
    <p>We introduced numbers and Lego as examples of composition. They
    have an interesting property in common: the operations that we can
    use to combine them (for example, addition, subtraction, and so on
    for numbers; for Lego the operation is “sticking bricks together”)
    give us back the same kind of thing. A number multiplied by a number
    is a number. Two bits of Lego stuck together is still Lego. This
    property is called closure: when you combine things you end up with
    the same kind of thing. Closure means you can apply the combining
    operations (sometimes called combinators) an arbitrary number of
    times. No matter how many times you add one to a number you still
    have a number and can still add or subtract or multiply or…you get
    the idea. If we understand module A, and the combinators that A
    provides are closed, we can build very complex structures using A
    without having to learn new concepts! This is also one reason
    functional programmers tend to like abstractions such a monads
    (beyond liking fancy words): they allow us to use one mental model
    in lots of different contexts.</p>
    <p>数とレゴを合成の例として見てきたが、これらには共通する興味深い性質がある。それらを組み合わせる操作（たとえば、数の場合は加算や減算、レゴの場合は「ブロックをくっつける」操作）を行うと、操作前と同じ種類のものが得られるという点である。数に数を掛ければ結果は数になるし、二つのレゴをくっつけたものも依然としてレゴである。この性質は閉包性と呼ばれ、ものを組み合わせたときに同じ種類のものが得られることを意味する。閉包性があるということは、合成操作（時にはコンビネータとも呼ばれる）を任意の回数適用できることを意味する。どれだけ1を足しても結果は数であり、さらに加算や減算、乗算を行うことができる。モジュールAについて理解しており、Aによって提供されるコンビネータが閉包性を持っていれば、新しい概念を学ばなくとも、Aを使って非常に複雑な構造を作ることができる。これは、関数型プログラマがモナドのような抽象概念を好む理由のひとつでもある（単に難しい言葉が好きだからではない）。これらの抽象概念は、ひとつのメンタルモデルをさまざまなコンテキストで使うことを可能にしてくれる。</p>
    <p>In a sense local reasoning and composition are two sides of the
    same coin. Local reasoning is compositional; composition allows
    local reasoning. Both make code easier to understand.</p>
    <p>ある意味、局所推論と合成は同じコインの裏表のような関係にある。局所推論は合成的であり、合成は局所推論を可能にする。どちらもコードを理解しやすくしてくれる。</p>
    <h3 data-number="1.2.4" id="the-evidence-for-functional-programming"><span class="header-section-number">1.2.4</span> The Evidence for
    Functional Programming</h3>
    <p>I’ve made arguments in favour of functional programming and I
    admit I am biased—I do believe it is a better way to develop code
    than imperative programming. However, is there any evidence to back
    up my claim? There has not been much research on the effectiveness
    of functional programming, but there has been a reasonable amount
    done on static typing. I feel static typing, particularly using
    modern type systems, serves as a good proxy for functional
    programming so let’s look at the evidence there.</p>
    <p>In the corners of the Internet I frequent the common refrain is
    that <a href="https://danluu.com/empirical-pl/">static typing has
    neglible effect on productivity</a>. I decided to look into this and
    was surprised that the majority of the results I found support the
    claim that static typing increases productivity. For example, the
    literature review in <a href="https://web.cs.unlv.edu/stefika/documents/MerlinDissertation.pdf">this
    dissertation</a> (section 2.3, p16–19) shows a majority of results
    in favour of static typing, in particular the most recent studies.
    However the majority of these studies are very small and use
    relatively inexperienced developers—which is noted in the review by
    Dan Luu that I linked. My belief is that functional programming
    comes into its own on larger systems. Furthermore, programming
    languages, like all tools, require proficiency to use effectively.
    I’m not convinced very junior developers have sufficient skill to
    demonstrate a significant difference between languages.</p>
    <p>To me the most useful evidence of the effectiveness of functional
    programming is that industry is adopting functional programming en
    masse. Consider, say, the widespread and growing adoption of
    Typescript and React. If we are to argue that FP as embodied by
    Typescript or React has no value we are also arguing that the
    thousands of Javascript developers who have switched to using them
    are deluded. At some point this argument becomes untenable.</p>
    <p>This doesn’t mean we’ll all be using Haskell in five years. More
    likely we’ll see something like the shift to object-oriented
    programming of the nineties: Smalltalk was the paradigmatic example
    of OO, but it was more familiar languages like C++ and Java that
    brought OO to the mainstream. In the case of FP this probably means
    languages like Scala, Swift, Kotlin, or Rust, and mainstream
    languages like Javascript and Java continuing to adopt more FP
    features.</p>
    <h3 data-number="1.2.5" id="final-words"><span class="header-section-number">1.2.5</span> Final Words</h3>
    <p>I’ve given my opinion on functional programming—that the real
    goals are local reasoning and composition, and programming practices
    like immutability are in service of these. Other people may disagree
    with this definition, and that’s ok. Words are defined by the
    community that uses them, and meanings change over time.</p>
    <p>Functional programming emphasises formal reasoning, and there are
    some implications that I want to briefly touch on.</p>
    <p>Firstly, I find that FP is most valuable in the large. For a
    small system it is possible to keep all the details in our head.
    It’s when a program becomes too large for anyone to understand all
    of it that local reasoning really shows its value. This is not to
    say that FP should not be used for small projects, but rather that
    if you are, say, switching from an imperative style of programming
    you shouldn’t expect to see the benefit when working on toy
    projects.</p>
    <p>The formal models that underlie functional programming allow
    systematic construction of code. This is in some ways the reverse of
    reasoning: instead of taking code and deriving properties, we start
    from some properties and derive code. This sounds very academic but
    is in fact very practical, and how I develop most of my code.</p>
    <p>Finally, reasoning is not the only way to understand code. It’s
    valuable to appreciate the limitations of reasoning, other methods
    for gaining understanding, and using a variety of strategies
    depending on the situation.</p>
    <p>In this first part of the book we’re building the foundational
    strategies on which the rest of the book will build and elaborate.
    In Chapter 2 we look at algebraic data types, which are our main way
    of modelling data. We turn to codata in Chapter 3, which is the
    opposite, or dual, or algebraic data. Type classes are the focus on
    Chapter 4, while fundamentals of interpreters are discussed in
    Chapter 5. These four strategies all describe code artifacts. For
    example, we can label part of code as an algebraic data type or a
    type class. We’ll also see strategies that help us write code but
    don’t necessarily end up directly reflected in it, such as following
    the types.</p>
    <p>本書の最初の部分では、基盤となる戦略を構築していきます。本書の残りの部分はこの基盤の上に構築し、発展させます。
    2章ではデータモデリングの主要な手段である代数的データ型について見ていきます。
    3章では余データ型について取り扱います。これは、代数的データ型の対極、もしくは双対となるものです。
    型クラスについては4章で、そしてインタプリタの基礎については5章で議論します。以上4つの戦略はすべてコードの構造を記述するものです。たとえば、コードの一部を代数的データ型や型クラスとしてラベル付けすることができます。また、型に従うといった、コードを書く上で役立つが直接コードに反映されるわけではない戦略も登場します。</p>
    <h1 data-number="2" id="sec:adt"><span class="header-section-number">2</span> 代数的データ型</h1>
    <p>This chapter has our first example of a programming strategy:
    <strong>algebraic data types</strong>. Any data we can describe
    using logical ands and logical ors is an algebraic data type. Once
    we recognize an algebraic data type we get three things for
    free:</p>
    <p>この章では、プログラミング戦略の最初の例として
    <strong>代数的データ型</strong>
    を取り上げる。論理積と論理和を使って表現できるデータはすべて代数的データ型である。代数的データ型をただ認識するだけで、以下の三つのものが手に入る。</p>
    <ul>
    <li><p>the Scala representation of the data;</p></li>
    <li><p>a <strong>structural recursion</strong> skeleton to transform
    the algebraic data type into any other type; and</p></li>
    <li><p>a <strong>structural corecursion</strong> skeleton to
    construct the algebraic data type from any other type.</p></li>
    <li><p>Scalaにおけるデータ表現</p></li>
    <li><p>代数的データ型を他の型に変換するための<strong>構造的再帰</strong>の骨組み</p></li>
    <li><p>他の型から代数的データ型を構築するための<strong>構造的余再帰</strong>の骨組み</p></li>
    </ul>
    <p>The key point is this: from an implementation independent
    representation of data we can automatically derive most of the
    interesting implementation specific parts of working with that
    data.</p>
    <p>重要なのは、実装非依存のデータ表現から、そのデータを扱うための実装固有の興味深い部分の多くを自動的に導き出すことができるという点である。</p>
    <p>We’ll start with some examples of data, from which we’ll extract
    the common structure that motivates algebraic data types. We will
    then look at their representation in Scala 2 and Scala 3. Next we’ll
    turn to structural recursion for transforming algebraic data types,
    followed by structural corecursion for constructing them. We’ll
    finish by looking at the algebra of algebraic data types, which is
    interesting but not essential.</p>
    <p>まず、データの例をいくつか紹介し、そこから、代数的データ型を導く共通の構造を抽出する。その後、Scala2とScala3での代数的データ型の表現を見ていく。次に、代数的データ型を変換するための構造的再帰に触れ、続いて、代数的データ型を構築するための構造的余再帰について説明する。最後に、代数的データ型の代数について見る。これは本書の内容にとって必須ではないが、興味深いテーマである。</p>
    <h2 data-number="2.1" id="代数的データ型の構築"><span class="header-section-number">2.1</span> 代数的データ型の構築</h2>
    <p>Let’s start with some examples of data from a few different
    domains. These are simplified description but they are all
    representative of real applications.</p>
    <p>まず、いくつかの異なる分野からデータ例を挙げてみよう。これらは簡略化されてはいるが、いずれも実際のアプリケーションにおける典型と言えるものである。</p>
    <p>A user in a discussion forum will typically have a screen name,
    an email address, and a password. Users also typically have a
    specific role: normal user, moderator, or administrator, for
    example. From this we get the following data:</p>
    <p>ディスカッションフォーラムのユーザは通常、表示名、メールアドレス、そしてパスワードといった情報をもつ。また、ユーザには通常、特定のロールが割り当てられる。たとえば、一般ユーザ、モデレータ、管理者など。これを以下に整理しておく。</p>
    <ul>
    <li><p>a user is a screen name, an email address, a password, and a
    role; and</p></li>
    <li><p>a role is normal, moderator, or administrator.</p></li>
    <li><p>ユーザは、表示名、メールアドレス、パスワード、ロールから構成される</p></li>
    <li><p>ロールは、一般ユーザ、モデレータ、管理者のうちのいずれかである</p></li>
    </ul>
    <p>A product in an e-commerce store might have a stock keeping unit
    (a unique identifier for each variant of a product), a name, a
    description, a price, and a discount.</p>
    <p>eコマースストアの製品は、在庫管理単位（製品の各バリエーションに対する一意の識別子）、名前、説明、価格、割引率といった情報をもっている。</p>
    <p>In two-dimensional vector graphics it’s typical to represent
    shapes as a path, which is a sequence of actions of a virtual pen.
    The possible actions are usually straight lines, Bezier curves, or
    movement that doesn’t result in visible output. A straight line has
    an end point (the starting point is implicit), a Bezier curve has
    two control points and an end point, and a move has an end
    point.</p>
    <p>二次元ベクターグラフィックスでは、図形をパスとして表現することが一般的に行われる。パスは、仮想ペンの一連の動作で構成される。よくある動作として、直線、ベジエ曲線、または目に見える結果を伴わない移動が挙げられる。直線には終点があり（始点は暗黙的に決まる）、ベジエ曲線には二つの制御点と終点があり、移動には終点がある。</p>
    <p>What is common between all the examples above is that the
    individual elements—the atoms, if you like—are connected by either a
    logical and or a logical or. For example, a user is a screen name
    <em>and</em> an email address <em>and</em> a password <em>and</em> a
    role. A 2D action is a straight line <em>or</em> a Bezier curve
    <em>or</em> a move. This is the core of algebraic data types: an
    algebraic data type is data that is combined using logical ands or
    logical ors. Conversely, whenever we can describe data in terms of
    logical ands and logical ors we have an algebraic data type.</p>
    <p>上記すべての例に共通しているのは、個々の要素、いわば「原子」が論理積または論理和で結びつけられているという点である。たとえば、ユーザは表示名<em>および</em>メールアドレス<em>および</em>パスワード<em>および</em>ロールから構成されている。2Dアクションは、直線<em>または</em>ベジエ曲線<em>または</em>移動である。これが代数的データ型の核となる考え方で、代数的データ型とは、論理積や論理和で結びつけられたデータのことをいう。逆に言えば、データを論理積や論理和で表現できる場合、それは代数的データ型であると言える。</p>
    <h3 data-number="2.1.1" id="直和と直積"><span class="header-section-number">2.1.1</span> 直和と直積</h3>
    <p>関数型プログラマとしては、単純な概念にちょっと難しそうな専門用語をつけずにはいられないものである。</p>
    <ul>
    <li><p>a <strong>product type</strong> means a logical and;
    and</p></li>
    <li><p>a <strong>sum type</strong> means a logical or.</p></li>
    <li><p><strong>直積型</strong>は論理積を意味し、</p></li>
    <li><p><strong>直和型</strong>は論理和を意味する</p></li>
    </ul>
    <p>代数的データ型は直和型と直積型で構成される。</p>
    <h3 data-number="2.1.2" id="閉じた世界"><span class="header-section-number">2.1.2</span> 閉じた世界</h3>
    <p>Algebraic data types are closed worlds, which means they cannot
    be extended after they have been defined. In practical terms this
    means we have to modify the source code where we define the
    algebraic data type if we want to add or remove elements.</p>
    <p>代数的データ型は閉じた世界であり、一度定義されると、それが拡張されることはない。要素を追加または削除したい場合、代数的データ型を定義した元のソースコードを変更する必要がある。</p>
    <p>The closed world property is important because it gives us
    guarantees we would not otherwise have. In particular, it allows the
    compiler to check that we handle all possible cases when we use an
    algebraic data type. This is known as <strong>exhaustivity
    checking</strong>. This is an example of how functional programming
    prioritizes reasoning about code—in this case automated reasoning by
    the compiler—over other properties such as extensibility. We’ll
    learn more about exhaustivity checking soon.</p>
    <p>この閉じた世界の性質は重要である。これによって通常は得られない保証を得ることができる。特に、代数的データ型を使用する際に、すべてのありうるケースを処理しているかどうかをコンパイラがチェック可能となる。これを<strong>網羅性チェック</strong>と呼ぶ。このように、関数型プログラミングは、拡張性などの特性よりも、コードに対する推論――この場合はコンパイラによる自動的な推論――を優先する傾向がある。網羅性チェックについては、今後さらに学んでいく。</p>
    <h2 data-number="2.2" id="scalaにおける代数的データ型"><span class="header-section-number">2.2</span>
    Scalaにおける代数的データ型</h2>
    <p>Now we know what algebraic data types are, we will turn to their
    representation in Scala. The important point here is that the
    translation to Scala is entirely determined by the structure of the
    data; no thinking is required! This means the work is in finding the
    structure of the data that best represents the problem at hand. Work
    out the structure of the data and the code directly follows from
    it.</p>
    <p>代数的データ型が何であるかを理解したところで、次にそれがScalaでどのように表現されるかを見ていこう。ここで重要なのは、Scalaへの翻訳がデータの構造によって完全に決定され、特別な考察は必要ないということである。そのため、取り組んでいる課題に最適なデータの構造を見つけることが主な作業となる。データ構造を考え出し、それに従ってコードを書けばよい。</p>
    <p>As algebraic data types are defined in terms of logical ands and
    logical ors, to represent algebraic data types in Scala we must know
    how to represent these two concepts. Scala 3 simplifies the
    representation of algebraic data types compared to Scala 2, so we’ll
    look at each language version separately.</p>
    <p>代数的データ型は論理積と論理和で定義されるため、Scalaで代数的データ型を表現するためには、これら二つの概念がどのように表現されるかを知っておく必要がある。Scala3では、Scala2に比べて代数的データ型の表現が簡素化されているため、それぞれの言語バージョンを別々に見ていく。</p>
    <p>I’m assuming that you’re familiar with the language features we
    use to represent algebraic data types in Scala, so I won’t be going
    over them.</p>
    <p>なお、代数的データ型をScalaで表現するために使用する言語機能についてはすでに知っているものとし、その説明は割愛する。</p>
    <h3 data-number="2.2.1" id="scala3における代数的データ型"><span class="header-section-number">2.2.1</span>
    Scala3における代数的データ型</h3>
    <p>In Scala 3 a logical and (a product type) is represented by a
    <code>final case class</code>. If we define a product type
    <code>A</code> is <code>B</code> <em>and</em> <code>C</code>, the
    representation in Scala 3 is</p>
    <p>Scala3では、論理積（直積型）は <code>final case class</code>
    で表現される。直積型 <code>A</code> が <code>B</code> <em>と</em>
    <code>C</code>
    の集まりであると定義する場合、そのScala3での表現は次のようになる。</p>
    <div class="sourceCode" id="cb11"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">A</span><span class="op">(</span>b<span class="op">:</span> B<span class="op">,</span> c<span class="op">:</span> C<span class="op">)</span></span></code></pre></div>
    <p>Not everyone makes their case classes <code>final</code>, but
    they should. A non-<code>final</code> case class can still be
    extended by a class, which breaks the closed world criteria for
    algebraic data types.</p>
    <p>この case class を <code>final</code>
    にしない人もいるが、するべきである。<code>final</code> でない case
    class
    は他のクラスによって拡張される可能性があり、これは代数的データ型の閉じた世界を実現する条件を壊してしまう。</p>
    <p>A logical or (a sum type) is represented by an <code>enum</code>.
    For the sum type <code>A</code> is <code>B</code> <em>or</em>
    <code>C</code>, the Scala 3 representation is</p>
    <p>論理和（直和型）は enum で表現される。直和型 <code>A</code> が
    <code>B</code> <em>または</em> <code>C</code>
    である場合、そのScala3での表現は次のようになる。</p>
    <div class="sourceCode" id="cb12"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>enum A <span class="op">{</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> B</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> C</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>There are a few wrinkles to be aware of. If we have a sum of
    products, such as:</p>
    <p>注意すべき点がいくつかある。データが積の和である場合、たとえば次のようなデータであれば、</p>
    <ul>
    <li><p><code>A</code> is <code>B</code> or <code>C</code>;
    and</p></li>
    <li><p><code>B</code> is <code>D</code> and <code>E</code>;
    and</p></li>
    <li><p><code>C</code> is <code>F</code> and <code>G</code></p></li>
    <li><p><code>A</code> は <code>B</code> または
    <code>C</code></p></li>
    <li><p><code>B</code> は <code>D</code> および
    <code>E</code></p></li>
    <li><p><code>C</code> は <code>F</code> および
    <code>G</code></p></li>
    </ul>
    <p>コード表現は次のようになる。</p>
    <div class="sourceCode" id="cb13"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>enum A <span class="op">{</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">B</span><span class="op">(</span>d<span class="op">:</span> D<span class="op">,</span> e<span class="op">:</span> E<span class="op">)</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">C</span><span class="op">(</span>f<span class="op">:</span> F<span class="op">,</span> g<span class="op">:</span> G<span class="op">)</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>In other words we don’t write <code>final case class</code>
    inside an <code>enum</code>. You also can’t nest <code>enum</code>
    inside <code>enum</code>. Nested logical ors can be rewritten into a
    single logical or containing only logical ands (known as disjunctive
    normal form) so this is not a limitation in practice. However the
    Scala 2 representation is still available in Scala 3 should you want
    more expressivity.</p>
    <p>つまり、<code>enum</code> の中には <code>final case class</code>
    とは書かない。また、<code>enum</code> の中に <code>enum</code>
    をネストすることもできない。ネストされた論理和は、論理積の論理和（これを選言標準形と呼ぶ）に書き換えることができるので、実用にあたってこれが制約になることはない。ただし、ネストされた論理和を表すことのできるScala2の表現はScala3でも引き続き利用可能である。</p>
    <h3 data-number="2.2.2" id="scala2における代数的データ型"><span class="header-section-number">2.2.2</span>
    Scala2における代数的データ型</h3>
    <p>A logical and (product type) has the same representation in Scala
    2 as in Scala 3. If we define a product type <code>A</code> is
    <code>B</code> <em>and</em> <code>C</code>, the representation in
    Scala 2 is</p>
    <p>論理積（直積型）は、Scala2でもScala3でも同じ表現をもつ。直積型
    <code>A</code> が <code>B</code> <em>と</em> <code>C</code>
    の集まりであると定義する場合、Scala2での表現は次のようになる。</p>
    <div class="sourceCode" id="cb14"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">A</span><span class="op">(</span>b<span class="op">:</span> B<span class="op">,</span> c<span class="op">:</span> C<span class="op">)</span></span></code></pre></div>
    <p>A logical or (a sum type) is represented by a
    <code>sealed abstract class</code>. For the sum type <code>A</code>
    is a <code>B</code> <em>or</em> <code>C</code> the Scala 2
    representation is</p>
    <p>論理和（直和型）は <code>sealed abstract class</code>
    で表現される。直和型 <code>A</code> が <code>B</code>
    <em>または</em> <code>C</code>
    である場合、Scala2での表現は以下のとおりである。</p>
    <div class="sourceCode" id="cb15"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">abstract</span> <span class="kw">class</span> A</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">B</span><span class="op">()</span> <span class="kw">extends</span> A</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">C</span><span class="op">()</span> <span class="kw">extends</span> A</span></code></pre></div>
    <p>Scala 2 has several little tricks to defining algebraic data
    types.</p>
    <p>Scala2で代数的データ型を定義するにあたっては小さなテクニックがいくつかある。</p>
    <p>Firstly, instead of using a <code>sealed abstract class</code>
    you can use a <code>sealed trait</code>. There isn’t much practical
    difference between the two. When teaching beginners I’ll often use
    <code>sealed trait</code> to avoid having to introduce
    <code>abstract class</code>. I believe
    <code>sealed abstract class</code> has slightly better performance
    and Java interoperability, but I haven’t tested this. I also think
    <code>sealed abstract class</code> is closer, semantically, to the
    meaning of a sum type.</p>
    <p>まず、<code>sealed abstract class</code> の代わりに
    <code>sealed trait</code>
    を使用することができる。この二つの間には大きな実用的差異はない。私の場合、初心者に教える際には
    <code>sealed trait</code> を用いることが多い。そうすることで
    <code>abstract class</code>
    を紹介する手間を避けることができる。<code>sealed abstract class</code>
    の方が若干パフォーマンスが良く、Javaとの互換性が高いと思われるが、テストをして確認したわけではない。また、<code>sealed abstract class</code>
    の方が意味的に直和型に近いとも考えられる。</p>
    <p>For extra style points we can
    <code>extend Product with Serializable</code> from
    <code>sealed abstract class</code>. Compare the reported types below
    with and without this little addition.</p>
    <p>コードをさらに洗練させるために、<code>sealed abstract class</code>
    を <code>Product</code> と <code>Serializable</code>
    を継承した型として定義することもできる。このちょっとした追加がある場合とない場合で、推論される型を比較してみてほしい。</p>
    <p>Let’s first see the code without extending <code>Product</code>
    and <code>Serializable</code>.</p>
    <p>まずは <code>Product</code> と <code>Serializable</code>
    を拡張しないコードを見てみよう。</p>
    <div class="sourceCode" id="cb16"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">abstract</span> <span class="kw">class</span> A</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">B</span><span class="op">()</span> <span class="kw">extends</span> A</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">C</span><span class="op">()</span> <span class="kw">extends</span> A</span></code></pre></div>
    <div class="sourceCode" id="cb17"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> list <span class="op">=</span> <span class="ex">List</span><span class="op">(</span><span class="fu">B</span><span class="op">(),</span> <span class="fu">C</span><span class="op">())</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co">// list: List[A extends Product with Serializable] = List(B(), C())</span></span></code></pre></div>
    <p>Notice how the type of <code>list</code> includes
    <code>Product</code> and <code>Serializable</code>.</p>
    <p><code>list</code> 変数の型に <code>Product</code> と
    <code>Serializable</code> が含まれている点に注目してほしい。</p>
    <p>Now we have extending <code>Product</code> and
    <code>Serializable</code>.</p>
    <p>そこで <code>A</code> に <code>Product</code> と
    <code>Serializable</code> を継承させる。</p>
    <div class="sourceCode" id="cb18"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">abstract</span> <span class="kw">class</span> A <span class="kw">extends</span> Product <span class="kw">with</span> <span class="ex">Serializable</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">B</span><span class="op">()</span> <span class="kw">extends</span> A</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">C</span><span class="op">()</span> <span class="kw">extends</span> A</span></code></pre></div>
    <div class="sourceCode" id="cb19"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> list <span class="op">=</span> <span class="ex">List</span><span class="op">(</span><span class="fu">B</span><span class="op">(),</span> <span class="fu">C</span><span class="op">())</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co">// list: List[A] = List(B(), C())</span></span></code></pre></div>
    <p>Much easier to read!</p>
    <p>これで推論される型がシンプルに読みやすくなる。</p>
    <p>You’ll only see this in Scala 2. Scala 3 has the concept of
    <strong>transparent traits</strong>, which aren’t reported in
    inferred types, so you’ll see the same output in Scala 3 no matter
    whether you add <code>Product</code> and <code>Serializable</code>
    or not.</p>
    <p>この事情はScala2でのみ確認できる。Scala3には<strong>transparentトレイト</strong>という概念があり、このトレイトは型推論で報告される型には反映されない。そのため、Scala3では
    <code>Product</code> と <code>Serializable</code>
    を追加してもしなくても同じ結果が得られる。</p>
    <p>Finally, if a logical and holds no data we can use a
    <code>case object</code> instead of a <code>case class</code>. For
    example, if we’re defining some type <code>A</code> that holds no
    data we can just write</p>
    <p>最後に、論理積がデータをひとつも保持しない場合、<code>case class</code>
    の代わりに <code>case object</code>
    を使用することができる。たとえば、データを保持しない型
    <code>A</code> は次のように定義できる。</p>
    <div class="sourceCode" id="cb20"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">object</span> A</span></code></pre></div>
    <p>There is no need to mark the <code>case object</code> as
    <code>final</code>, as objects cannot be extended.</p>
    <p>オブジェクトは拡張できないので、<code>case object</code> を
    <code>final</code> としてマークする必要はない。</p>
    <h3 data-number="2.2.3" id="例"><span class="header-section-number">2.2.3</span> 例</h3>
    <p>Let’s make the discussion above more concrete with some
    examples.</p>
    <p>いくつか例を挙げて、ここまでの議論をもっと具体的に考えてみよう。</p>
    <h4 data-number="2.2.3.1" id="roleとuser"><span class="header-section-number">2.2.3.1</span> RoleとUser</h4>
    <p>In the discussion forum example, we said a role is normal,
    moderator, or administrator. This is a logical or, so we can
    directly translate it to Scala using the appropriate pattern. In
    Scala 3 we write</p>
    <p>ディスカッションフォーラムの例では、ロールは一般ユーザ・モデレータ・管理者のいずれかであるとした。これは論理和であり、適切なパターンを用いて機械的にScalaに翻訳することができる。Scala3であれば次のようになる。</p>
    <div class="sourceCode" id="cb21"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>enum <span class="ex">Role</span> <span class="op">{</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> Normal</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> Moderator</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> Administrator</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Scala2の場合は以下のように書ける。</p>
    <div class="sourceCode" id="cb22"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">abstract</span> <span class="kw">class</span> <span class="ex">Role</span> <span class="kw">extends</span> Product <span class="kw">with</span> <span class="ex">Serializable</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">object</span> Normal <span class="kw">extends</span> <span class="ex">Role</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">object</span> Moderator <span class="kw">extends</span> <span class="ex">Role</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">object</span> Administrator <span class="kw">extends</span> <span class="ex">Role</span></span></code></pre></div>
    <p>The cases within a role don’t hold any data, so we used a
    <code>case object</code> in the Scala 2 code.</p>
    <p>各ロールはデータをひとつも保持しないため、Scala2のコードでは
    <code>case class</code> ではなく <code>case object</code>
    を使っている。</p>
    <p>We defined a user as a screen name, an email address, a password,
    and a role. In both Scala 3 and Scala 2 this becomes</p>
    <p>ユーザは、表示名とメールアドレスとパスワードとロールから構成されると定義した。これはScala3とScala2のどちらにおいても次のようになる。</p>
    <div class="sourceCode" id="cb23"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">User</span><span class="op">(</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  screenName<span class="op">:</span> <span class="ex">String</span><span class="op">,</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  emailAddress<span class="op">:</span> <span class="ex">String</span><span class="op">,</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  password<span class="op">:</span> <span class="ex">String</span><span class="op">,</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  role<span class="op">:</span> <span class="ex">Role</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span></code></pre></div>
    <p>I’ve used <code>String</code> to represent most of the data
    within a <code>User</code>, but in real code we might want to define
    distinct types for each field.</p>
    <p><code>User</code> が保持するデータを主に <code>String</code>
    型で表現しているが、実際のコードでは各フィールドに対して個別の型を定義したほうがよいかもしれない。</p>
    <h4 data-number="2.2.3.2" id="path"><span class="header-section-number">2.2.3.2</span> Path</h4>
    <p>We defined a path as a sequence of actions of a virtual pen. The
    possible actions are straight lines, Bezier curves, or movement that
    doesn’t result in visible output. A straight line has an end point
    (the starting point is implicit), a Bezier curve has two control
    points and an end point, and a move has an end point.</p>
    <p>前述のデータ例で、パスを仮想ペンの一連の動作として定義した。それによると、可能な動作には、直線、ベジエ曲線、または目に見える出力を伴わない移動がある。また、直線には終点があり（始点は自動的に決まる）、ベジエ曲線には二つの制御点と終点があり、移動には終点がある。</p>
    <p>This has a straightforward translation to Scala. We can represent
    paths as the following in both Scala 3 and Scala 2.</p>
    <p>これらはストレートにScalaでの表現に置き換えることができる。Scala3とScala2、どちらにおいてもパスは次のように表現できる。</p>
    <div class="sourceCode" id="cb24"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">Path</span><span class="op">(</span>actions<span class="op">:</span> <span class="bu">Seq</span><span class="op">[</span><span class="ex">Action</span><span class="op">])</span></span></code></pre></div>
    <p>An action is a logical or, so we have different representations
    in Scala 3 and Scala 2. In Scala 3 we’d write</p>
    <p>ペンの動作は論理和なので、Scala3とScala2で表現の仕方が異なる。Scala3では次のように記述できる。</p>
    <div class="sourceCode" id="cb25"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>enum <span class="ex">Action</span> <span class="op">{</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="ex">Line</span><span class="op">(</span>end<span class="op">:</span> <span class="ex">Point</span><span class="op">)</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Curve</span><span class="op">(</span>cp1<span class="op">:</span> <span class="ex">Point</span><span class="op">,</span> cp2<span class="op">:</span> <span class="ex">Point</span><span class="op">,</span> end<span class="op">:</span> <span class="ex">Point</span><span class="op">)</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Move</span><span class="op">(</span>end<span class="op">:</span> <span class="ex">Point</span><span class="op">)</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>where <code>Point</code> is a suitable representation of a
    two-dimensional point.</p>
    <p>なお、ここで用いている <code>Point</code>
    は二次元座標を表現したクラスであるとする。</p>
    <p>In Scala 2 we have to go with the more verbose</p>
    <p>Scala2ではもっと冗長な表現方法を用いる必要がある。</p>
    <div class="sourceCode" id="cb26"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">abstract</span> <span class="kw">class</span> <span class="ex">Action</span> <span class="kw">extends</span> Product <span class="kw">with</span> <span class="ex">Serializable</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="ex">Line</span><span class="op">(</span>end<span class="op">:</span> <span class="ex">Point</span><span class="op">)</span> <span class="kw">extends</span> <span class="ex">Action</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">Curve</span><span class="op">(</span>cp1<span class="op">:</span> <span class="ex">Point</span><span class="op">,</span> cp2<span class="op">:</span> <span class="ex">Point</span><span class="op">,</span> end<span class="op">:</span> <span class="ex">Point</span><span class="op">)</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">extends</span> <span class="ex">Action</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">Move</span><span class="op">(</span>end<span class="op">:</span> <span class="ex">Point</span><span class="op">)</span> <span class="kw">extends</span> <span class="ex">Action</span></span></code></pre></div>
    <h3 data-number="2.2.4" id="scala3における代数的データ型の表現"><span class="header-section-number">2.2.4</span>
    Scala3における代数的データ型の表現</h3>
    <p>We’ve seen that the Scala 3 representation of algebraic data
    types, using <code>enum</code>, is more compact than the Scala 2
    representation. However the Scala 2 representation is still
    available. Should you ever use the Scala 2 representation in Scala
    3? There are a few cases where you may want to:</p>
    <p>Scala3の <code>enum</code>
    を使用した代数的データ型の表現が、Scala2のそれよりもコンパクトであることを見てきたが、Scala2の表現は依然として使用可能である。では、Scala3であえてScala2の表現を使うべき場面はあるのかというと、いくつか考慮すべきケースがある。</p>
    <ul>
    <li><p>Scala 3’s doesn’t currently support nested <code>enums</code>
    (<code>enums</code> within <code>enums</code>). This may change in
    the future, but right now it can be more convenient to use the Scala
    2 representation to express this without having to convert to
    disjunctive normal form.</p></li>
    <li><p>現在のところ、Scala3ではネストされた
    <code>enum</code>（<code>enum</code> 内の
    <code>enum</code>）をサポートしていない。これは今後変更されるかもしれないが、現時点では、これを選言標準形に変換することなく表現するために、Scala2の方法を使用する方が便利な場合がある。</p></li>
    <li><p>Scala 2’s representation can express things that are almost,
    but not quite, algebraic data types. For example, if you define a
    method on an <code>enum</code> you must be able to define it for all
    the members of the <code>enum</code>. Sometimes you want a case of
    an <code>enum</code> to have methods that are only defined for that
    case. To implement this you’ll need to use the Scala 2
    representation instead.</p></li>
    </ul>
    <p>Scala2の表現方法では、代数的データ型に近いが完全にそうとは言えないものを表現することができる。たとえば、<code>enum</code>
    にメソッドを定義する場合、そのメソッドは <code>enum</code>
    のすべてのメンバーに対して意味をなさなくてはならないが、特定のメンバーのみにメソッドを定義したいことがある。このような場合、Scala2の表現方法を使用する必要がある。</p>
    <h4 class="unnumbered" id="演習-木構造">演習: 木構造</h4>
    <p>To gain a bit of practice defining algebraic data types, code the
    following description in Scala (your choice of version, or do
    both.)</p>
    <p>代数的データ型の定義に慣れるため、以下の記述をScalaのコードで表せ。なお、Scalaのバージョンは自由に選んでよい。両方を試してもかまわない。</p>
    <p>A <code>Tree</code> with elements of type <code>A</code> is:</p>
    <p><code>A</code> 型の要素をもつ <code>Tree</code>
    は以下のいずれかとして定義される。</p>
    <ul>
    <li><p>a <code>Leaf</code> with a value of type <code>A</code>;
    or</p></li>
    <li><p>a <code>Node</code> with a left and right child, which are
    both <code>Trees</code> with elements of type
    <code>A</code>.</p></li>
    <li><p><code>A</code> 型の値を保持する
    <code>Leaf</code>、もしくは</p></li>
    <li><p><code>A</code> 型の要素をもつ <code>Tree</code>
    を左右の子として保持する <code>Node</code></p></li>
    </ul>
    <div class="solution">
    <p>We can directly translate this binary tree into Scala. Here’s the
    Scala 3 version.</p>
    <p>このような二分木は機械的にScalaのコードに落とし込むことができる。以下はScala3で書いたコードである。</p>
    <div class="sourceCode" id="cb27"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>enum Tree<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">:</span> A<span class="op">)</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="ex">Node</span><span class="op">(</span>left<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">],</span> right<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>In the Scala 2 encoding we write</p>
    <p>Scala2なら次のようになる。</p>
    <div class="sourceCode" id="cb28"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">abstract</span> <span class="kw">class</span> Tree<span class="op">[</span>A<span class="op">]</span> <span class="kw">extends</span> Product <span class="kw">with</span> <span class="ex">Serializable</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> Leaf<span class="op">[</span>A<span class="op">](</span>value<span class="op">:</span> A<span class="op">)</span> <span class="kw">extends</span> Tree<span class="op">[</span>A<span class="op">]</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="ex">Node</span><span class="op">[</span>A<span class="op">](</span>left<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">],</span> right<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">])</span> <span class="kw">extends</span> Tree<span class="op">[</span>A<span class="op">]</span></span></code></pre></div>
    </div>
    <h2 data-number="2.3" id="構造的再帰"><span class="header-section-number">2.3</span> 構造的再帰</h2>
    <p>Structural recursion is our second programming strategy.
    Algebraic data types tell us how to create data given a certain
    structure. Structural recursion tells us how to transform an
    algebraic data types into any other type. Given an algebraic data
    type, the transformation can be implemented using structural
    recursion.</p>
    <p>二つ目のプログラミング戦略は構造的再帰である。代数的データ型は、特定の構造に基づいたデータをどのように定義するかを示してくれた。構造的再帰は代数的データ型を他の任意の型に変換する方法を教えてくれる。代数的データ型が与えられた場合、その変換は構造的再帰を使って実装することができる。</p>
    <p>As with algebraic data types, there is distinction between the
    concept of structural recursion and the implementation in Scala.
    This is more obvious because there are two ways to implement
    structural recursion in Scala: via pattern matching or via dynamic
    dispatch. We’ll look at each in turn.</p>
    <p>代数的データ型と同様、構造的再帰の概念とScalaにおける実装は区別して考える必要がある。そのことは、Scalaには構造的再帰を実装する方法が二つあることからも分かるだろう。その二つとは、パターンマッチングを使う方法と動的ディスパッチを使う方法である。これらを順に見ていこう。</p>
    <h3 data-number="2.3.1" id="パターンマッチング"><span class="header-section-number">2.3.1</span> パターンマッチング</h3>
    <p>I’m assuming you’re familiar with pattern matching in Scala, so
    I’ll only talk about how to implement structural recursion using
    pattern matching. Remember there are two kinds of algebraic data
    types: sum types (logical ors) and product types (logical ands). We
    have corresponding rules for structural recursion implemented using
    pattern matching:</p>
    <p>Scalaにおけるパターンマッチングについては基本的な知識があることを前提としているので、ここではパターンマッチングを使って構造的再帰をどのように実装するかについてのみ解説する。代数的データ型には直和型（論理和）と直積型（論理積）の二種類があったことを思い出そう。構造的再帰をパターンマッチングで実装する際には、この二種類それぞれに対応するルールがある。</p>
    <ol type="1">
    <li><p>For each branch in a sum type we have a distinct
    <code>case</code> in the pattern match; and</p></li>
    <li><p>Each <code>case</code> corresponds to a product type with the
    pattern written in the usual way.</p></li>
    <li><p>直和型の各分岐は、パターンマッチ内で別々の <code>case</code>
    となる</p></li>
    <li><p>各 <code>case</code>
    は直積型に対応し、通常の方法でパターンが書かれる</p></li>
    </ol>
    <p>Let’s see this in code, using an example ADT that includes both
    sum and product types:</p>
    <p>これをコードで見てみよう。以下のような直和型と直積型の両方を組み合わせた代数的データ型の例を用いる。</p>
    <ul>
    <li><p><code>A</code> is <code>B</code> or <code>C</code>;
    and</p></li>
    <li><p><code>B</code> is <code>D</code> and <code>E</code>;
    and</p></li>
    <li><p><code>C</code> is <code>F</code> and <code>G</code></p></li>
    <li><p><code>A</code> は <code>B</code> または <code>C</code>
    の直和型</p></li>
    <li><p><code>B</code> は <code>D</code> および <code>E</code>
    の直積型</p></li>
    <li><p><code>C</code> は <code>F</code> および <code>G</code>
    の直積型</p></li>
    </ul>
    <p>which we represent (in Scala 3) as</p>
    <p>Scala3ではこれは次のように表現される。</p>
    <div class="sourceCode" id="cb29"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>enum A <span class="op">{</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">B</span><span class="op">(</span>d<span class="op">:</span> D<span class="op">,</span> e<span class="op">:</span> E<span class="op">)</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">C</span><span class="op">(</span>f<span class="op">:</span> F<span class="op">,</span> g<span class="op">:</span> G<span class="op">)</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Following the rules above means a structural recursion would look
    like</p>
    <p>先ほど示したルールに従うと、構造的再帰は以下のようになる。</p>
    <div class="sourceCode" id="cb30"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>anA <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">B</span><span class="op">(</span>d<span class="op">,</span> e<span class="op">)</span> <span class="op">=&gt;</span> <span class="op">???</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">C</span><span class="op">(</span>f<span class="op">,</span> g<span class="op">)</span> <span class="op">=&gt;</span> <span class="op">???</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>The <code>???</code> bits are problem specific, and we cannot
    give a general solution for them. However we’ll soon see strategies
    to help create them.</p>
    <p><code>???</code>
    の部分をどう書くかは何をやりたいか次第であり、一般的な解決策を示すことはできないが、それらを実装するのに役立つ戦略についてはこの後に見ていく。</p>
    <h3 data-number="2.3.2" id="構造的再帰における再帰"><span class="header-section-number">2.3.2</span>
    構造的再帰における再帰</h3>
    <p>At this point you might be wondering where the recursion in
    structural recursion comes from. This is an additional rule for
    recursion: whenever the data is recursive the method is recursive in
    the same place.</p>
    <p>この時点では、構造的再帰における「再帰」という言葉がどこから来ているのか疑問に思うかもしれない。再帰には追加のルールがある。データが再帰的である場合、そのメソッドも同じ箇所で再帰的になる、というものである。</p>
    <p>Let’s see this in action for a real data type.</p>
    <p>これを実際のデータ型で見てみよう。</p>
    <p>We can define a list with elements of type <code>A</code> as:</p>
    <p><code>A</code> 型の要素をもつリストは以下のように定義できる。</p>
    <ul>
    <li><p>the empty list; or</p></li>
    <li><p>a pair containing an <code>A</code> and a tail, which is a
    list of <code>A</code>.</p></li>
    <li><p>リストは空であるか、もしくは</p></li>
    <li><p>ひとつの <code>A</code> 型の値と、それ自体が <code>A</code>
    のリストである残りの部分のペア</p></li>
    </ul>
    <p>This is exactly the definition of <code>List</code> in the
    standard library. Notice it’s an algebraic data type as it consists
    of sums and products. It is also recursive: in the pair case the
    tail is itself a list.</p>
    <p>これは標準ライブラリにおける <code>List</code>
    の定義そのものである。直和型と直積型から構成された代数的データ型である点に注目してほしい。また、この構造は再帰的でもある。ペアのケースでは、末尾の部分自体がひとつのリストになっている。</p>
    <p>We can directly translate this to code, using the strategy for
    algebraic data types we saw previously. In Scala 3 we write</p>
    <p>すでに学んだ代数的データ型の戦略を使えば、これを直接コードに置き換えることができる。Scala3では次のようになる。</p>
    <div class="sourceCode" id="cb31"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>enum MyList<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">:</span> A<span class="op">,</span> tail<span class="op">:</span> MyList<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Let’s implement <code>map</code> for <code>MyList</code>. We
    start with the method skeleton specifying just the name and
    types.</p>
    <p>試しに <code>MyList</code> に <code>map</code>
    を実装してみよう。まずは名前と型のみを指定したメソッドの骨組みからスタートする。</p>
    <div class="sourceCode" id="cb32"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>enum MyList<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">:</span> A<span class="op">,</span> tail<span class="op">:</span> MyList<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>B<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> MyList<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> </span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Our first step is to recognize that <code>map</code> can be
    written using a structural recursion. <code>MyList</code> is an
    algebraic data type, <code>map</code> is transforming this algebraic
    data type, and therefore structural recursion is applicable. We now
    apply the structural recursion strategy, giving us</p>
    <p>最初のステップは、<code>map</code>
    が構造的再帰を使って記述可能であると認識することである。<code>MyList</code>
    は代数的データ型であり、<code>map</code>
    はこの代数的データ型を変換するものなので、構造的再帰が適用できる。実際に構造的再帰の戦略を適用すると、次のようになる。</p>
    <div class="sourceCode" id="cb33"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>enum MyList<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">:</span> A<span class="op">,</span> tail<span class="op">:</span> MyList<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>B<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> MyList<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> </span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span> <span class="op">=&gt;</span> <span class="op">???</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">,</span> tail<span class="op">)</span> <span class="op">=&gt;</span> <span class="op">???</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>I forgot the recursion rule! The data is recursive in the
    <code>tail</code> of <code>Pair</code>, so <code>map</code> is
    recursive there as well.</p>
    <p>再帰のルールについても考慮しておこう。データが再帰的構造をもつ場合、それと同じ場所でメソッドも再帰呼び出しされる。このデータは
    <code>Pair</code> の <code>tail</code>
    の部分が再帰的なので、<code>map</code> もそこで再帰的になる。</p>
    <div class="sourceCode" id="cb34"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>enum MyList<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">:</span> A<span class="op">,</span> tail<span class="op">:</span> MyList<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>B<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> MyList<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> </span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span> <span class="op">=&gt;</span> <span class="op">???</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">,</span> tail<span class="op">)</span> <span class="op">=&gt;</span> <span class="op">???</span> tail<span class="op">.</span><span class="fu">map</span><span class="op">(</span>f<span class="op">)</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>I left the <code>???</code> to indicate that we haven’t finished
    with that case.</p>
    <p>なお、<code>???</code>
    は、その部分のコードがまだ完成していないことを示している。</p>
    <p>Now we can move on to the problem specific parts. Here we have
    three strategies to help us:</p>
    <p>骨組みが完成したら、取り組んでいる課題に固有の部分に進むことができる。ここでは、以下の三つの戦略が役に立つ。</p>
    <ol type="1">
    <li><p>reasoning independently by case;</p></li>
    <li><p>assuming recursion the is correct; and</p></li>
    <li><p>following the types</p></li>
    <li><p>各ケースを独立して考えること</p></li>
    <li><p>再帰呼び出しの結果は正しいと仮定すること</p></li>
    <li><p>型に従うこと</p></li>
    </ol>
    <p>The first two are specific to structural recursion, while the
    final one is a general strategy we can use in many situations. Let’s
    briefly discuss each and then see how they apply to our example.</p>
    <p>最初の二つは構造的再帰に特有のもので、最後のひとつは多くの状況で使える一般的な戦略である。それぞれについて簡単に検討し、今回の例にどのように適用するか見ていこう。</p>
    <p>The first strategy is relatively simple: when we consider the
    problem specific code on the right hand side of a pattern matching
    <code>case</code>, we can ignore the code in any other pattern match
    cases. So, for example, when considering the case for
    <code>Empty</code> above we don’t need to worry about the case for
    <code>Pair</code>, and vice versa.</p>
    <p>最初の戦略は比較的シンプルである。パターンマッチングにおいて、ある
    <code>case</code>
    の右側にある問題固有のコードを考える際、他のケースにあるコードは無視してかまわない。たとえば、上の
    <code>Empty</code> のケースを考えるとき、<code>Pair</code>
    のケースを気にする必要はないし、逆も同じことが言える。</p>
    <p>The next strategy is a little bit more complicated, and has to do
    with recursion. Remember that the structural recursion strategy
    tells us where to place any recursive calls. This means we don’t
    have to think through the recursion. Instead we assume the recursive
    call will correctly compute what it claims, and only consider how to
    further process the result of the recursion. The result is
    guaranteed to be correct so long as we get the non-recursive parts
    correct.</p>
    <p>次の戦略は少し複雑で、再帰に関係している。構造的再帰の戦略は、再帰呼び出しをどこに配置すればよいか示してくれることを思い出してほしい。このとき、再帰呼び出しの処理内容について深く考える必要はない。代わりに、再帰呼び出しが正しく計算されると仮定し、再帰の結果をどう処理するかだけを考えればよい。再帰以外の部分さえ正確であれば、結果が正しいことは保証される。</p>
    <p>In the example above we have the recursion
    <code>tail.map(f)</code>. We can assume this correctly computes
    <code>map</code> on the tail of the list, and we only need to think
    about what we should do with the remaining data: the
    <code>head</code> and the result of the recursive call.</p>
    <p>上の例には、<code>tail.map(f)</code>
    という再帰呼び出しがある。この再帰呼び出しがリストの
    <code>tail</code> に対する <code>map</code>
    を正しく計算してくれると仮定し、残りのデータ、つまり
    <code>head</code>
    と再帰呼び出しの結果をどう扱うかだけを考えればよい。</p>
    <p>It’s this property that allows us to consider cases
    independently. Recursive calls are the only thing that connect the
    different cases, and they are given to us by the structural
    recursion strategy.</p>
    <p>各ケースを独立して考えることができるのはこの特性による。再帰呼び出しは異なるケースをつなぐ唯一のものであり、その書き方は構造的再帰戦略によって与えられる。</p>
    <p>Our final strategy is <strong>following the types</strong>. It
    can be used in many situations, not just structural recursion, so I
    consider it a separate strategy. The core idea is to use the
    information in the types to restrict the possible implementations.
    We can look at the types of inputs and outputs to help us.</p>
    <p>最後の戦略は、<strong>型に従うこと</strong>である。これは構造的再帰に限らず、多くの状況で使えるため、別の戦略として扱おうと思う。コアとなる考え方は、入出力の型情報を活用して、ありうる実装を限定していくというものである。</p>
    <p>Now let’s use these strategies to finish the implementation of
    <code>map</code>. We start with</p>
    <p>それでは、これらの戦略を使って <code>map</code>
    の実装を完成させよう。すでに実装した部分を以下に再掲し、この続きを考えていく。</p>
    <div class="sourceCode" id="cb35"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>enum MyList<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">:</span> A<span class="op">,</span> tail<span class="op">:</span> MyList<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>B<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> MyList<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> </span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span> <span class="op">=&gt;</span> <span class="op">???</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">,</span> tail<span class="op">)</span> <span class="op">=&gt;</span> <span class="op">???</span> tail<span class="op">.</span><span class="fu">map</span><span class="op">(</span>f<span class="op">)</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Our first strategy is to consider the cases independently. Let’s
    start with the <code>Empty</code> case. There is no recursive call
    here, so reasoning about recursion doesn’t come into play. Let’s
    instead use the types. There is no input here other than the
    <code>Empty</code> case we have already matched, so we cannot use
    the input types to further restrict the code. Let’s instead consider
    the output type. We’re trying to create a <code>MyList[B]</code>.
    There are only two ways to create a <code>MyList[B]</code>: an
    <code>Empty</code> or a <code>Pair</code>. To create a
    <code>Pair</code> we need a <code>head</code> of type
    <code>B</code>, which we don’t have. So we can only use
    <code>Empty</code>. <em>This is the only possible code we can
    write</em>. The types are sufficiently restrictive that we cannot
    write incorrect code for this case.</p>
    <p>最初の戦略は、各ケースを独立に考えることである。まずは
    <code>Empty</code>
    のケースから始めよう。このケースには再帰呼び出しがないため、再帰について考える必要はない。代わりに型情報を利用しよう。<code>Empty</code>
    ケースにマッチしたということ以外に入力はないため、入力の型を使ってコードを制約することはできない。一方で、出力の型について考えてみると、<code>map</code>
    は <code>MyList[B]</code>
    を作成しようとしていることが分かる。<code>MyList[B]</code>
    を作成する方法は <code>Empty</code> か <code>Pair</code>
    の二通りだけである。そして、<code>Pair</code>
    を作成するには、<code>B</code> 型 の <code>head</code>
    が必要だが、それに相当する情報は与えられていないので、<code>Empty</code>
    を使うしかない。<em>これが書くことのできる唯一のコードである</em>。型が十分に制約を与えているため、このケースで誤ったコードを書くことはできない。</p>
    <div class="sourceCode" id="cb36"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>enum MyList<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">:</span> A<span class="op">,</span> tail<span class="op">:</span> MyList<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>B<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> MyList<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> </span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span> <span class="op">=&gt;</span> <span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">,</span> tail<span class="op">)</span> <span class="op">=&gt;</span> <span class="op">???</span> tail<span class="op">.</span><span class="fu">map</span><span class="op">(</span>f<span class="op">)</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Now let’s move to the <code>Pair</code> case. We can apply both
    the structural recursion reasoning strategy and following the types.
    Let’s use each in turn.</p>
    <p>次に <code>Pair</code>
    のケースに移ろう。ここでは構造的再帰の戦略と、型に従うこと、両方を適用することができる。以下に
    <code>Pair</code> のケースを再掲する。</p>
    <div class="sourceCode" id="cb37"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">,</span> tail<span class="op">)</span> <span class="op">=&gt;</span> <span class="op">???</span> tail<span class="op">.</span><span class="fu">map</span><span class="op">(</span>f<span class="op">)</span></span></code></pre></div>
    <p>Remember we can consider this independently of the other case. We
    assume the recursion is correct. This means we only need to think
    about what we should do with the <code>head</code>, and how we
    should combine this result with <code>tail.map(f)</code>. Let’s now
    follow the types to finish the code. Our goal is to produce a
    <code>MyList[B]</code>. We already the following available:</p>
    <p>他のケースとは独立に考えることができること、そして再帰呼び出しの結果は正しいと仮定することを思い出してほしい。そうすると、ここでは
    <code>head</code> をどう処理し、 <code>tail.map(f)</code>
    の結果とどう結合するかだけを考えればよい、ということになる。あとは型に従ってコードを完成させよう。ゴールは
    <code>MyList[B]</code>
    型の値を生成することで、そのために利用できる情報として以下のものがある。</p>
    <ul>
    <li><p><code>tail.map(f)</code>, which has type
    <code>MyList[B]</code>;</p></li>
    <li><p><code>head</code>, with type <code>A</code>;</p></li>
    <li><p><code>f</code>, with type <code>A =&gt; B</code>;
    and</p></li>
    <li><p>the constructors <code>Empty</code> and
    <code>Pair</code>.</p></li>
    <li><p><code>tail.map(f)</code>
    の呼び出し結果（<code>MyList[B]</code> 型）</p></li>
    <li><p><code>A</code> 型の値 <code>head</code></p></li>
    <li><p><code>A</code> を受けとり <code>B</code> を返す関数
    <code>f</code></p></li>
    <li><p><code>Empty</code> と <code>Pair</code>
    のコンストラクタ</p></li>
    </ul>
    <p>We could return just <code>Empty</code>, matching the case we’ve
    already written. This has the correct type but we might expect it is
    not the correct answer because it does not use the result of the
    recursion, <code>head</code>, or <code>f</code> in any way.</p>
    <p>すでに記述した <code>Empty</code> ケースと同じように、単に
    <code>Empty</code>
    を返すこともできる。これは型的には正しいが、再帰呼び出しの結果や
    <code>head</code>、関数 <code>f</code>
    をまったく使用していないし、正しい答えではないだろうと予想できる。</p>
    <p>We could return just <code>tail.map(f)</code>. This has the
    correct type but we might expect it is not correct because we don’t
    use <code>head</code> or <code>f</code> in any way.</p>
    <p>また、単に <code>tail.map(f)</code>
    を返すこともでき、これも型的には正しいが、<code>head</code>
    を使用していないので、やはり正しい答えではないだろう。</p>
    <p>We can call <code>f</code> on <code>head</code>, producing a
    value of type <code>B</code>, and then combine this value and the
    result of the recursive call using <code>Pair</code> to produce a
    <code>MyList[B]</code>. This is the correct solution.</p>
    <p><code>head</code> に対して <code>f</code> を呼び出して
    <code>B</code> 型の値を生成し、その値と再帰呼び出しの結果を
    <code>Pair</code> を使って組み合わせて <code>MyList[B]</code>
    型の値を作成することができる。これが正しい解決策である。</p>
    <div class="sourceCode" id="cb38"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>enum MyList<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">:</span> A<span class="op">,</span> tail<span class="op">:</span> MyList<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>B<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> MyList<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> </span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span> <span class="op">=&gt;</span> <span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">,</span> tail<span class="op">)</span> <span class="op">=&gt;</span> <span class="bu">Pair</span><span class="op">(</span><span class="fu">f</span><span class="op">(</span>head<span class="op">),</span> tail<span class="op">.</span><span class="fu">map</span><span class="op">(</span>f<span class="op">))</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>If you’ve followed this example you’ve hopefully see how we can
    use the three strategies to systematically find the correct
    implementation. Notice how we interleaved the recursion strategy and
    following the types to guide us to a solution for the
    <code>Pair</code> case. Also note how following the types alone gave
    us three possible implementations for the <code>Pair</code> case. In
    this code, and as is usually the case, the solution was the
    implementation that used all of the available inputs.</p>
    <p>この例題についてここまで読み進めてきたなら、三つの戦略を使って体系的に正しい実装を見つける方法について理解していただけたと思う。再帰戦略と型に従う戦略を交互に用いることで、<code>Pair</code>
    ケースの解決策へと導かれたことに注目してほしい。また、ただ型に従うだけでも
    <code>Pair</code>
    ケースの実装方法が三つに絞り込まれた点にも留意してほしい。今回のコードでは、そして大抵の場合もそうだが、利用できるすべての入力を使用する実装が正しい解決策となる。</p>
    <h3 data-number="2.3.3" id="網羅性チェック"><span class="header-section-number">2.3.3</span> 網羅性チェック</h3>
    <p>Remember that algebraic data types are a closed world: they
    cannot be extended once defined. The Scala compiler can use this to
    check that we handle all possible cases in a pattern match, so long
    as we write the pattern match in a way the compiler can work with.
    This is known as exhaustivity checking.</p>
    <p>代数的データ型は閉じた世界であり、一旦定義されると拡張できないということを思い出そう。Scalaコンパイラは、この性質を利用し、パターンマッチングにおいてすべてのケースが処理されているかどうかをチェックすることができる。ただし、パターンマッチをコンパイラが処理できる形式で記述する必要がある。これは網羅性チェックと呼ばれている。</p>
    <p>Here’s a simple example. We start by defining a straight-forward
    algebraic data type.</p>
    <p>次にシンプルな例を挙げる。まずは素直に代数的データ型を定義するところから始める。</p>
    <div class="sourceCode" id="cb39"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Some of the possible units for lengths in CSS</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="co">// CSSにおいて用いられる可能性のある長さの単位</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>enum CssLength <span class="op">{</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Em</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">Double</span><span class="op">)</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Rem</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">Double</span><span class="op">)</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Pt</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">Double</span><span class="op">)</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>If we write a pattern match using the structural recursion
    strategy, the compiler will complain if we’re missing a case.</p>
    <p>構造的再帰の戦略を使ってパターンマッチを書いていれば、ありうるケースが欠けているときにコンパイラが警告を出してくれる。</p>
    <div class="sourceCode" id="cb40"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> CssLength<span class="op">.*</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>CssLength<span class="op">.</span><span class="fu">Em</span><span class="op">(</span><span class="fl">2.0</span><span class="op">)</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Em</span><span class="op">(</span>value<span class="op">)</span> <span class="op">=&gt;</span> value</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Rem</span><span class="op">(</span>value<span class="op">)</span> <span class="op">=&gt;</span> value</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co">// -- [E029] Pattern Match Exhaustivity Warning: ----------------------------------</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="co">// 1 |CssLength.Em(2.0) match {</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="co">//   |^^^^^^^^^^^^^^^^^</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="co">//   |match may not be exhaustive.</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="co">//   |</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="co">//   |It would fail on pattern case: CssLength.Pt(_)</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="co">//   |</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="co">//   | longer explanation available when compiling with `-explain`</span></span></code></pre></div>
    <p>Exhaustivity checking is incredibly useful. For example, if we
    add or remove a case from an algebraic data type, the compiler will
    tell us all the pattern matches that need to be updated.</p>
    <p>網羅性チェックは非常に有用である。たとえば、代数的データ型に新しいケースを追加したり、ケースを削除したりしたときに、どのパターンマッチを更新する必要があるかをコンパイラが教えてくれる。</p>
    <h3 data-number="2.3.4" id="動的ディスパッチ"><span class="header-section-number">2.3.4</span> 動的ディスパッチ</h3>
    <p>Using dynamic dispatch to implement structural recursion is an
    implementation technique that may feel more natural to people with a
    background in object-oriented programming.</p>
    <p>構造的再帰の実装として動的ディスパッチを使用する方法は、オブジェクト指向プログラミングの経験がある人にとって、より自然に感じられる実装テクニックかもしれない。</p>
    <p>The dynamic dispatch approach consists of:</p>
    <p>動的ディスパッチのアプローチは、以下の手順で構成される。</p>
    <ol type="1">
    <li><p>defining an <em>abstract method</em> at the root of the
    algebraic data types; and</p></li>
    <li><p>implementing that abstract method at every leaf of the
    algebraic data type.</p></li>
    <li><p>代数的データ型のルートに<em>抽象メソッド</em>を定義すること</p></li>
    <li><p>代数的データ型の各リーフでその抽象メソッドを実装すること</p></li>
    </ol>
    <p>This implementation technique is only available if we use the
    Scala 2 encoding of algebraic data types.</p>
    <p>この実装テクニックは、Scala2における代数的データ型の表現方法を用いている場合にのみ利用可能である。</p>
    <p>Let’s see it in the <code>MyList</code> example we just looked
    at. Our first step is to rewrite the definition of
    <code>MyList</code> to the Scala 2 style.</p>
    <p>これを、先ほど使った <code>MyList</code>
    の例で見ていこう。最初のステップは <code>MyList</code>
    の定義をScala2のスタイルに書き換えることである。</p>
    <div class="sourceCode" id="cb41"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">abstract</span> <span class="kw">class</span> MyList<span class="op">[</span>A<span class="op">]</span> <span class="kw">extends</span> Product <span class="kw">with</span> <span class="ex">Serializable</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> Empty<span class="op">[</span>A<span class="op">]()</span> <span class="kw">extends</span> MyList<span class="op">[</span>A<span class="op">]</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="bu">Pair</span><span class="op">[</span>A<span class="op">](</span>head<span class="op">:</span> A<span class="op">,</span> tail<span class="op">:</span> MyList<span class="op">[</span>A<span class="op">])</span> <span class="kw">extends</span> MyList<span class="op">[</span>A<span class="op">]</span></span></code></pre></div>
    <p>Next we define an abstract method for <code>map</code> on
    <code>MyList</code>.</p>
    <p>次に、<code>MyList</code> に抽象メソッドとして <code>map</code>
    を定義する。</p>
    <div class="sourceCode" id="cb42"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">abstract</span> <span class="kw">class</span> MyList<span class="op">[</span>A<span class="op">]</span> <span class="kw">extends</span> Product <span class="kw">with</span> <span class="ex">Serializable</span> <span class="op">{</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>B<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> MyList<span class="op">[</span>B<span class="op">]</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> Empty<span class="op">[</span>A<span class="op">]()</span> <span class="kw">extends</span> MyList<span class="op">[</span>A<span class="op">]</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="bu">Pair</span><span class="op">[</span>A<span class="op">](</span>head<span class="op">:</span> A<span class="op">,</span> tail<span class="op">:</span> MyList<span class="op">[</span>A<span class="op">])</span> <span class="kw">extends</span> MyList<span class="op">[</span>A<span class="op">]</span></span></code></pre></div>
    <p>Then we implement <code>map</code> on the concrete subtypes
    <code>Empty</code> and <code>Pair</code>.</p>
    <p>続いて、具象サブタイプである <code>Empty</code> と
    <code>Pair</code> に、<code>map</code> メソッドを実装する。</p>
    <div class="sourceCode" id="cb43"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">abstract</span> <span class="kw">class</span> MyList<span class="op">[</span>A<span class="op">]</span> <span class="kw">extends</span> Product <span class="kw">with</span> <span class="ex">Serializable</span> <span class="op">{</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>B<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> MyList<span class="op">[</span>B<span class="op">]</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> Empty<span class="op">[</span>A<span class="op">]()</span> <span class="kw">extends</span> MyList<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>B<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> MyList<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> </span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="bu">Pair</span><span class="op">[</span>A<span class="op">](</span>head<span class="op">:</span> A<span class="op">,</span> tail<span class="op">:</span> MyList<span class="op">[</span>A<span class="op">])</span> <span class="kw">extends</span> MyList<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>B<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> MyList<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Pair</span><span class="op">(</span><span class="fu">f</span><span class="op">(</span>head<span class="op">),</span> tail<span class="op">.</span><span class="fu">map</span><span class="op">(</span>f<span class="op">))</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>We can use exactly the same strategies we used in the pattern
    matching case to create this code. The implementation technique is
    different but the underlying concept is the same.</p>
    <p>この <code>map</code>
    の実装を考える際には、パターンマッチングの場合とまったく同じ戦略を使用することができる。実装テクニックは違っても、基礎的な概念は同じである。</p>
    <p>Given we have two implementation strategies, which should we use?
    If we’re using <code>enum</code> in Scala 3 we don’t have a choice;
    we must use pattern matching. In other situations we can choose
    between the two. I prefer to use pattern matching when I can, as it
    puts the entire method definition in one place. However, Scala 2 in
    particular has problems inferring types in some pattern matches. In
    these situations we can use dynamic dispatch instead. We’ll learn
    more about this when we look at generalized algebraic data
    types.</p>
    <p>これら二つの実装戦略のうち、どちらを使うべきだろうか。Scala3で
    <code>enum</code>
    を使用している場合、選択肢はなく、パターンマッチングを使うしかない。他の状況では、どちらを使うか選択できる。私は、可能であればパターンマッチングを使うほうが好みである。そうすることでメソッド定義全体を一か所にまとめることができる。だが、特にScala2では、一部のパターンマッチで型推論に問題が生じることがあり、そのような場合には、動的ディスパッチを使用することもできる。これについては、一般化された代数的データ型について見ていく際にさらに詳しく学ぶ予定である。</p>
    <h4 data-number="2.3.4.1" id="演習-tree-へのメソッド定義"><span class="header-section-number">2.3.4.1</span> 演習: <code>Tree</code>
    へのメソッド定義</h4>
    <p>In a previous exercise we created a <code>Tree</code> algebraic
    data type:</p>
    <p>ひとつ前の演習では代数的データ型 <code>Tree</code>
    を作成した。</p>
    <div class="sourceCode" id="cb44"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>enum Tree<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">:</span> A<span class="op">)</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="ex">Node</span><span class="op">(</span>left<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">],</span> right<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Or, in the Scala 2 encoding:</p>
    <p>Scala2の表現方法であれば以下のとおり。</p>
    <div class="sourceCode" id="cb45"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">abstract</span> <span class="kw">class</span> Tree<span class="op">[</span>A<span class="op">]</span> <span class="kw">extends</span> Product <span class="kw">with</span> <span class="ex">Serializable</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> Leaf<span class="op">[</span>A<span class="op">](</span>value<span class="op">:</span> A<span class="op">)</span> <span class="kw">extends</span> Tree<span class="op">[</span>A<span class="op">]</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="ex">Node</span><span class="op">[</span>A<span class="op">](</span>left<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">],</span> right<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">])</span> <span class="kw">extends</span> Tree<span class="op">[</span>A<span class="op">]</span></span></code></pre></div>
    <p>Let’s get some practice with structural recursion and write some
    methods for <code>Tree</code>. Implement</p>
    <p>構造的再帰の練習として、この <code>Tree</code>
    に対して以下のメソッドを実装せよ。</p>
    <ul>
    <li><p><code>size</code>, which returns the number of values
    (<code>Leafs</code>) stored in the <code>Tree</code>;</p></li>
    <li><p><code>contains</code>, which returns <code>true</code> if the
    <code>Tree</code> contains a given element of type <code>A</code>,
    and <code>false</code> otherwise; and</p></li>
    <li><p><code>map</code>, which creates a <code>Tree[B]</code> given
    a function <code>A =&gt; B</code></p></li>
    <li><p><code>size</code> メソッド: <code>Tree</code>
    に格納されている値（<code>Leafs</code>）の件数を返す</p></li>
    <li><p><code>contains</code> メソッド: <code>Tree</code>
    が指定された要素を含んでいる場合 <code>true</code>
    を返し、そうでなければ <code>false</code> を返す</p></li>
    <li><p><code>map</code> メソッド: <code>A</code> を <code>B</code>
    に変換する関数を受け取って、<code>Tree[B]</code> を返す</p></li>
    </ul>
    <p>Use whichever you prefer of pattern matching or dynamic dispatch
    to implement the methods.</p>
    <p>実装にはパターンマッチングと動的ディスパッチどちらでも好きな方を使ってかまわない。</p>
    <div class="solution">
    <!-- 
    TODO: ここまで "strategy" という言葉を当てていた概念に "reasoning rule" などの別の言葉が使われている。
    まぎらわしいので統一を検討する。
    -->
    <p>I chose to use pattern matching to implement these methods. I’m
    using the Scala 3 encoding so I have no choice.</p>
    <p>この解答では、<code>Tree</code> における論理和の表現として
    <code>enum</code>
    を使い、メソッドの実装にパターンマッチングを用いている。</p>
    <p>I start by creating the method declarations with empty
    bodies.</p>
    <p>まずは、ボディは空のままメソッドを宣言するところから始めよう。</p>
    <div class="sourceCode" id="cb46"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>enum Tree<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">:</span> A<span class="op">)</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="ex">Node</span><span class="op">(</span>left<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">],</span> right<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> size<span class="op">:</span> <span class="bu">Int</span> <span class="op">=</span> </span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">contains</span><span class="op">(</span>element<span class="op">:</span> A<span class="op">):</span> <span class="ex">Boolean</span> <span class="op">=</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>B<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> Tree<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Now these methods all transform an algebraic data type so I can
    implement them using structural recursion. I write down the
    structural recursion skeleton for <code>Tree</code>, remembering to
    apply the recursion rule.</p>
    <p>これらのメソッドはすべて代数的データ型を変換するので、構造的再帰を使って実装することができる。<code>Tree</code>
    に対する構造的再帰の骨組みを以下のように記述する。再帰呼び出しはデータが再帰的である場所で行われる、というルールも適用済である。</p>
    <div class="sourceCode" id="cb47"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>enum Tree<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">:</span> A<span class="op">)</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="ex">Node</span><span class="op">(</span>left<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">],</span> right<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> size<span class="op">:</span> <span class="bu">Int</span> <span class="op">=</span> </span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span> </span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">)</span>       <span class="op">=&gt;</span> <span class="op">???</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="ex">Node</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span> left<span class="op">.</span>size <span class="op">???</span> right<span class="op">.</span>size</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">contains</span><span class="op">(</span>element<span class="op">:</span> A<span class="op">):</span> <span class="ex">Boolean</span> <span class="op">=</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span> </span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">)</span>       <span class="op">=&gt;</span> <span class="op">???</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="ex">Node</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span> left<span class="op">.</span><span class="fu">contains</span><span class="op">(</span>element<span class="op">)</span> <span class="op">???</span> right<span class="op">.</span><span class="fu">contains</span><span class="op">(</span>element<span class="op">)</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>B<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> Tree<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span> </span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">)</span>       <span class="op">=&gt;</span> <span class="op">???</span></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="ex">Node</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span> left<span class="op">.</span><span class="fu">map</span><span class="op">(</span>f<span class="op">)</span> <span class="op">???</span> right<span class="op">.</span><span class="fu">map</span><span class="op">(</span>f<span class="op">)</span></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Now I can use the other reasoning techniques to complete the
    method declarations. Let’s work through <code>size</code>.</p>
    <p>ここまで書けば、次の推論テクニックを使ってメソッドの定義を完成させることができる。では
    <code>size</code> を実装していこう。</p>
    <div class="sourceCode" id="cb48"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> size<span class="op">:</span> <span class="bu">Int</span> <span class="op">=</span> </span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span> </span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">)</span>       <span class="op">=&gt;</span> <span class="dv">1</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="ex">Node</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span> left<span class="op">.</span>size <span class="op">???</span> right<span class="op">.</span>size</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>I can reason independently by case. The size of a
    <code>Leaf</code> is, by definition, 1.</p>
    <p>ケースはそれぞれ独立に考えることができる。<code>Leaf</code>
    から見ていこう。 <code>Leaf</code>
    のサイズは、定義により常に1である。</p>
    <div class="sourceCode" id="cb49"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> size<span class="op">:</span> <span class="bu">Int</span> <span class="op">=</span> </span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span> </span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">)</span>       <span class="op">=&gt;</span> <span class="dv">1</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="ex">Node</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span> left<span class="op">.</span>size <span class="op">???</span> right<span class="op">.</span>size</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>Now I can use the rule for reasoning about recursion: I assume
    the recursive calls successfully compute the size of the left and
    right children. What is the size then of the combined tree? It must
    be the sum of the size of the children. With this, I’m done.</p>
    <p><code>Node</code>
    ケースには、再帰呼び出しの結果を正しいと仮定する考え方を利用することができる。再帰呼び出しが左右の子のサイズを正しく計算していると仮定すると、結合された木のサイズは、左右の子のサイズの合計になるはずである。<code>size</code>
    の実装はこれで完成となる。</p>
    <div class="sourceCode" id="cb50"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> size<span class="op">:</span> <span class="bu">Int</span> <span class="op">=</span> </span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span> </span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">)</span>       <span class="op">=&gt;</span> <span class="dv">1</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="ex">Node</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span> left<span class="op">.</span>size <span class="op">+</span> right<span class="op">.</span>size</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>I can use the same process to work through the other two methods,
    giving me the complete solution shown below.</p>
    <p>残りの二つのメソッドも同じプロセスを使って実装できる。以下に、完成した解答を示す。</p>
    <div class="sourceCode" id="cb51"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>enum Tree<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">:</span> A<span class="op">)</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="ex">Node</span><span class="op">(</span>left<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">],</span> right<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> size<span class="op">:</span> <span class="bu">Int</span> <span class="op">=</span> </span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span> </span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">)</span>       <span class="op">=&gt;</span> <span class="dv">1</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="ex">Node</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span> left<span class="op">.</span>size <span class="op">+</span> right<span class="op">.</span>size</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">contains</span><span class="op">(</span>element<span class="op">:</span> A<span class="op">):</span> <span class="ex">Boolean</span> <span class="op">=</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span> </span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">)</span>       <span class="op">=&gt;</span> element <span class="op">==</span> value</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="ex">Node</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span> left<span class="op">.</span><span class="fu">contains</span><span class="op">(</span>element<span class="op">)</span> <span class="op">||</span> right<span class="op">.</span><span class="fu">contains</span><span class="op">(</span>element<span class="op">)</span></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>B<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> Tree<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span> </span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">)</span>       <span class="op">=&gt;</span> <span class="fu">Leaf</span><span class="op">(</span><span class="fu">f</span><span class="op">(</span>value<span class="op">))</span></span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="ex">Node</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span> <span class="ex">Node</span><span class="op">(</span>left<span class="op">.</span><span class="fu">map</span><span class="op">(</span>f<span class="op">),</span> right<span class="op">.</span><span class="fu">map</span><span class="op">(</span>f<span class="op">))</span></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    </div>
    <h3 data-number="2.3.5" id="構造的再帰としての畳み込み"><span class="header-section-number">2.3.5</span>
    構造的再帰としての畳み込み</h3>
    <p>Let’s finish by looking at the fold method as an abstraction over
    structural recursion. If you did the <code>Tree</code> exercise
    above, you will have noticed that we wrote the same kind of code
    again and again. Here are the methods we wrote. Notice the left-hand
    sides of the pattern matches are all the same, and the right-hand
    sides are very similar.</p>
    <p>最後に、構造的再帰をさらに抽象化したものとして畳み込みメソッドについて見ていこう。先ほどの
    <code>Tree</code>
    の演習を行ったなら、同じパターンのコードを何度も書いたことに気付いたはずである。演習で作成したメソッドを以下に再掲する。パターンマッチの左側はすべて同じだし、右側も非常に似ていることに注目してほしい。</p>
    <div class="sourceCode" id="cb52"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> size<span class="op">:</span> <span class="bu">Int</span> <span class="op">=</span> </span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span> </span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">)</span>       <span class="op">=&gt;</span> <span class="dv">1</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="ex">Node</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span> left<span class="op">.</span>size <span class="op">+</span> right<span class="op">.</span>size</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">contains</span><span class="op">(</span>element<span class="op">:</span> A<span class="op">):</span> <span class="ex">Boolean</span> <span class="op">=</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span> </span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">)</span>       <span class="op">=&gt;</span> element <span class="op">==</span> value</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="ex">Node</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span> left<span class="op">.</span><span class="fu">contains</span><span class="op">(</span>element<span class="op">)</span> <span class="op">||</span> right<span class="op">.</span><span class="fu">contains</span><span class="op">(</span>element<span class="op">)</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> map<span class="op">[</span>B<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> Tree<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span> </span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">)</span>       <span class="op">=&gt;</span> <span class="fu">Leaf</span><span class="op">(</span><span class="fu">f</span><span class="op">(</span>value<span class="op">))</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="ex">Node</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span> <span class="ex">Node</span><span class="op">(</span>left<span class="op">.</span><span class="fu">map</span><span class="op">(</span>f<span class="op">),</span> right<span class="op">.</span><span class="fu">map</span><span class="op">(</span>f<span class="op">))</span></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>This is the point of structural recursion: to recognize and
    formalize this similarity. However, as programmers we might want to
    abstract over this repetition. Can we write a method that captures
    everything that doesn’t change in a structural recursion, and allows
    the caller to pass arguments for everything that does change? It
    turns out we can. For any algebraic data type we can define at least
    one method, called a fold, that captures all the parts of structural
    recursion that don’t change and allows the caller to specify all the
    problem specific parts.</p>
    <p>この類似性を認識し戦略として公式化することが、構造的再帰のポイントである。だが、プログラマとしては、この繰り返しを抽象化したくなるかもしれない。構造的再帰の中で変わらない部分をすべて抽出し、変わる部分については呼び出し側が引数として渡せるようなメソッドを作ることはできるだろうか。これは実は可能である。任意の代数的データ型に対して、そういうメソッドを少なくともひとつは定義できる。畳み込みと呼ばれるそのメソッドが構造的再帰の変わらない部分をすべてキャプチャし、個別のやりたいことに特化した部分を呼び出し側が指定できるようにしてくれる。</p>
    <p>Let’s see how this is done using the example of
    <code>MyList</code>. Recall the definition of <code>MyList</code>
    is</p>
    <p>どのように定義されるのか <code>MyList</code>
    の例を使って見ていこう。<code>MyList</code> の定義を再掲する。</p>
    <div class="sourceCode" id="cb53"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>enum MyList<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">:</span> A<span class="op">,</span> tail<span class="op">:</span> MyList<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>We know the structural recursion skeleton for <code>MyList</code>
    is</p>
    <p><code>MyList</code>
    で使われる構造的再帰の骨組みは、すでに理解しているとおり、以下のようになる。</p>
    <div class="sourceCode" id="cb54"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> doSomething<span class="op">[</span>A<span class="op">](</span>list<span class="op">:</span> MyList<span class="op">[</span>A<span class="op">])</span> <span class="op">=</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  list <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span>          <span class="op">=&gt;</span> <span class="op">???</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">,</span> tail<span class="op">)</span> <span class="op">=&gt;</span> <span class="op">???</span> <span class="fu">doSomething</span><span class="op">(</span>tail<span class="op">)</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> </span></code></pre></div>
    <p>Implementing fold for <code>MyList</code> means defining a
    method</p>
    <p><code>MyList</code> に畳み込みを実装するとは、次のような
    <code>fold</code> メソッドを定義するということである。</p>
    <div class="sourceCode" id="cb55"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fold<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>list<span class="op">:</span> MyList<span class="op">[</span>A<span class="op">]):</span> B <span class="op">=</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  list <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span> <span class="op">=&gt;</span> <span class="op">???</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">,</span> tail<span class="op">)</span> <span class="op">=&gt;</span> <span class="op">???</span> <span class="fu">fold</span><span class="op">(</span>tail<span class="op">)</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>where <code>B</code> is the type the caller wants to create.</p>
    <p>ここで <code>B</code>
    は、呼び出し元が生成したい値の型とする。</p>
    <p>To complete <code>fold</code> we add method parameters for the
    problem specific (<code>???</code>) parts. In the case for
    <code>Empty</code>, we need a value of type <code>B</code> (notice
    that I’m following the types here).</p>
    <p><code>fold</code>
    メソッドを完成させるには、都度のやりたいことに固有の
    <code>???</code>
    の部分を埋めるために引数を加える必要がある。<code>Empty</code>
    のケースには <code>B</code>
    型の値が必要である（型に従って考えていることに注目してほしい）。</p>
    <div class="sourceCode" id="cb56"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fold<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>list<span class="op">:</span> MyList<span class="op">[</span>A<span class="op">],</span> empty<span class="op">:</span> B<span class="op">):</span> B <span class="op">=</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  list <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span> <span class="op">=&gt;</span> empty</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">,</span> tail<span class="op">)</span> <span class="op">=&gt;</span> <span class="op">???</span> <span class="fu">fold</span><span class="op">(</span>tail<span class="op">,</span> empty<span class="op">)</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>For the <code>Pair</code> case, we have the head of type
    <code>A</code> and the recursion producing a value of type
    <code>B</code>. This means we need a function to combine these two
    values.</p>
    <p><code>Pair</code> のケースでは、 <code>A</code> 型の
    <code>head</code> と、 <code>B</code>
    型の値を生成する再帰処理がすでにあるので、必要なのはそれら二つを結合する関数ということになる。</p>
    <div class="sourceCode" id="cb57"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> foldRight<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>list<span class="op">:</span> MyList<span class="op">[</span>A<span class="op">],</span> empty<span class="op">:</span> B<span class="op">,</span> f<span class="op">:</span> <span class="op">(</span>A<span class="op">,</span> B<span class="op">)</span> <span class="op">=&gt;</span> B<span class="op">):</span> B <span class="op">=</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  list <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span> <span class="op">=&gt;</span> empty</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">,</span> tail<span class="op">)</span> <span class="op">=&gt;</span> <span class="fu">f</span><span class="op">(</span>head<span class="op">,</span> <span class="fu">foldRight</span><span class="op">(</span>tail<span class="op">,</span> empty<span class="op">,</span> f<span class="op">))</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>This is <code>foldRight</code> (and I’ve renamed the method to
    indicate this). You might have noticed there is another valid
    solution. Both <code>empty</code> and the recursion produce values
    of type <code>B</code>. If we follow the types we can come up
    with</p>
    <p>これが <code>foldRight</code>
    メソッドである（この後に見せるもうひとつの解法と区別できるよう名前を変更した）。これを見て、もうひとつの有効な解があることに気付いたかもしれない。
    <code>empty</code> も再帰呼び出しも <code>B</code>
    の値を生成する。型に従って考えれば、次のような結論に至ることもできるだろう。</p>
    <div class="sourceCode" id="cb58"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> foldLeft<span class="op">[</span>A<span class="op">,</span>B<span class="op">](</span>list<span class="op">:</span> MyList<span class="op">[</span>A<span class="op">],</span> empty<span class="op">:</span> B<span class="op">,</span> f<span class="op">:</span> <span class="op">(</span>A<span class="op">,</span> B<span class="op">)</span> <span class="op">=&gt;</span> B<span class="op">):</span> B <span class="op">=</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  list <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span> <span class="op">=&gt;</span> empty</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">,</span> tail<span class="op">)</span> <span class="op">=&gt;</span> <span class="fu">foldLeft</span><span class="op">(</span>tail<span class="op">,</span> <span class="fu">f</span><span class="op">(</span>head<span class="op">,</span> empty<span class="op">),</span> f<span class="op">)</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>which is <code>foldLeft</code>, the tail-recursive variant of
    fold for a list. (We’ll talk about tail-recursion in a later
    chapter.)</p>
    <p>これが <code>foldLeft</code>
    メソッドで、リストに対する末尾再帰型の畳み込みの変種である。末尾再帰については後の章で解説する。</p>
    <p>We can follow the same process for any algebraic data type to
    create its folds. The rules are:</p>
    <p>決まった手順をたどることで、任意の代数的データ型に対してその畳み込みメソッドを作成することができる。そのルールは以下の通りである。</p>
    <ul>
    <li><p>a fold is a function from the algebraic data type and
    additional parameters to some generic type that I’ll call
    <code>B</code> below for simplicity;</p></li>
    <li><p>the fold has one additional parameter for each case in a
    logical or;</p></li>
    <li><p>each parameter is a function, with result of type
    <code>B</code> and parameters that have the same type as the
    corresponding constructor arguments <em>except</em> recursive values
    are replaced with <code>B</code>; and</p></li>
    <li><p>if the constructor has no arguments (for example,
    <code>Empty</code>) we can use a value of type <code>B</code>
    instead of a function with no arguments.</p></li>
    <li><p>畳み込みは、代数的データ型と追加のパラメータを取り、何らかの汎用型（以下では便宜上
    <code>B</code> と呼ぶ）に変換する関数である</p></li>
    <li><p>畳み込みには、論理和の各ケースに対してひとつの追加パラメータがある</p></li>
    <li><p>各パラメータは関数で、結果の型は
    <code>B</code>、対応するコンストラクタの引数と同じ型のパラメータを取る。ただし、再帰的な値は
    <code>B</code> に置き換えられる</p></li>
    <li><p>コンストラクタに引数がない場合（たとえば
    <code>Empty</code>）、引数のない関数の代わりに、型 <code>B</code>
    の値を使用できる</p></li>
    </ul>
    <p>Returning to <code>MyList</code>, it has:</p>
    <p><code>MyList</code> に当てはめると次のようになる。</p>
    <ul>
    <li><p>two cases, and hence two parameters to fold (other than the
    parameter that is the list itself);</p></li>
    <li><p><code>Empty</code> is a constructor with no arguments and
    hence we use a parameter of type <code>B</code>; and</p></li>
    <li><p><code>Pair</code> is a constructor with one parameter of type
    <code>A</code> and one recursive parameter, and hence the
    corresponding function has type
    <code>(A, B) =&gt; B</code>.</p></li>
    <li><p>二つのケースがあるので、畳み込みには二つのパラメータが必要（リストそれ自体以外に）</p></li>
    <li><p><code>Empty</code>
    は引数なしコンストラクタなので、<code>B</code>
    型のパラメータをひとつ</p></li>
    <li><p><code>Pair</code> は <code>A</code>
    型の引数をひとつと、再帰的な引数をひとつもったコンストラクタなので、対応する関数の型は
    <code>(A, B) =&gt; B</code> となる</p></li>
    </ul>
    <h4 class="unnumbered" id="演習-tree-の畳み込み">演習:
    <code>Tree</code> の畳み込み</h4>
    <p>Implement a fold for <code>Tree</code> defined earlier. There are
    several different ways to traverse a tree (pre-order, post-order,
    and in-order). Just choose whichever seems easiest.</p>
    <p>以前定義した <code>Tree</code>
    に対して畳み込みを実装せよ。二分木の走査には、先行順、後行順、中間順などいくつかの方法があるが、最も簡単だと思うものを選んで実装してかまわない。</p>
    <div class="solution">
    <p>I start by add the method declaration without a body.</p>
    <p>まずはボディのないメソッド宣言を追加することから始める。</p>
    <div class="sourceCode" id="cb59"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>enum Tree<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">:</span> A<span class="op">)</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="ex">Node</span><span class="op">(</span>left<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">],</span> right<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> fold<span class="op">[</span>B<span class="op">]:</span> B <span class="op">=</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Next step is to add the structural recursion skeleton.</p>
    <p>次に、構造的再帰の骨組みを追加する。</p>
    <div class="sourceCode" id="cb60"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>enum Tree<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">:</span> A<span class="op">)</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="ex">Node</span><span class="op">(</span>left<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">],</span> right<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> fold<span class="op">[</span>B<span class="op">]:</span> B <span class="op">=</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">)</span>       <span class="op">=&gt;</span> <span class="op">???</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="ex">Node</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span> left<span class="op">.</span>fold <span class="op">???</span> right<span class="op">.</span>fold</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Now I follow the types to add the method parameters. For the
    <code>Leaf</code> case we want a function of type
    <code>A =&gt; B</code>.</p>
    <p>これで、型に従ってメソッドにパラメータを追加する準備が整った。<code>Leaf</code>
    のケースには <code>A =&gt; B</code>
    型の関数が必要であることが分かる。</p>
    <div class="sourceCode" id="cb61"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>enum Tree<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">)</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="ex">Node</span><span class="op">(</span>left<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">],</span> right<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> fold<span class="op">[</span>B<span class="op">](</span>leaf<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> B <span class="op">=</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">)</span>       <span class="op">=&gt;</span> <span class="fu">leaf</span><span class="op">(</span>value<span class="op">)</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="ex">Node</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span> left<span class="op">.</span>fold <span class="op">???</span> right<span class="op">.</span>fold</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>For the <code>Node</code> case we want a function that combines
    the two recursive results, and therefore has type
    <code>(B, B) =&gt; B</code>.</p>
    <p><code>Node</code>
    のケースには二つの再帰呼び出しの結果を結合する関数が必要なので、追加するパラメータは
    <code>(B, B) =&gt; B</code> という型をもつことになる。</p>
    <div class="sourceCode" id="cb62"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>enum Tree<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">:</span> A<span class="op">)</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="ex">Node</span><span class="op">(</span>left<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">],</span> right<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> fold<span class="op">[</span>B<span class="op">](</span>leaf<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">)(</span>node<span class="op">:</span> <span class="op">(</span>B<span class="op">,</span> B<span class="op">)</span> <span class="op">=&gt;</span> B<span class="op">):</span> B <span class="op">=</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">)</span>       <span class="op">=&gt;</span> <span class="fu">leaf</span><span class="op">(</span>value<span class="op">)</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="ex">Node</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span> <span class="fu">node</span><span class="op">(</span>left<span class="op">.</span><span class="fu">fold</span><span class="op">(</span>leaf<span class="op">)(</span>node<span class="op">),</span> right<span class="op">.</span><span class="fu">fold</span><span class="op">(</span>leaf<span class="op">)(</span>node<span class="op">))</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    </div>
    <h4 class="unnumbered" id="演習-畳み込みの利用">演習:
    畳み込みの利用</h4>
    <p>Prove to yourself that you can replace structural recursion with
    calls to fold, by redefining <code>size</code>,
    <code>contains</code>, and <code>map</code> for <code>Tree</code>
    using only fold.</p>
    <p>構造的再帰が畳み込みの呼び出しに置き換えられることを確認するため、<code>Tree</code>
    の <code>size</code>、<code>contains</code>、<code>map</code>
    を、<code>fold</code> だけを使って再定義せよ。</p>
    <div class="solution">
    <div class="sourceCode" id="cb63"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>enum Tree<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">:</span> A<span class="op">)</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="ex">Node</span><span class="op">(</span>left<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">],</span> right<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> fold<span class="op">[</span>B<span class="op">](</span>leaf<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">)(</span>node<span class="op">:</span> <span class="op">(</span>B<span class="op">,</span> B<span class="op">)</span> <span class="op">=&gt;</span> B<span class="op">):</span> B <span class="op">=</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">)</span>       <span class="op">=&gt;</span> <span class="fu">leaf</span><span class="op">(</span>value<span class="op">)</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="ex">Node</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span> <span class="fu">node</span><span class="op">(</span>left<span class="op">.</span><span class="fu">fold</span><span class="op">(</span>leaf<span class="op">)(</span>node<span class="op">),</span> right<span class="op">.</span><span class="fu">fold</span><span class="op">(</span>leaf<span class="op">)(</span>node<span class="op">))</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> size<span class="op">:</span> <span class="bu">Int</span> <span class="op">=</span> </span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">fold</span><span class="op">(</span>_ <span class="op">=&gt;</span> <span class="dv">1</span><span class="op">)(</span>_ <span class="op">+</span> _<span class="op">)</span></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">contains</span><span class="op">(</span>element<span class="op">:</span> A<span class="op">):</span> <span class="ex">Boolean</span> <span class="op">=</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">fold</span><span class="op">(</span>_ <span class="op">==</span> element<span class="op">)(</span>_ <span class="op">||</span> _<span class="op">)</span></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>B<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> Tree<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">fold</span><span class="op">(</span>v <span class="op">=&gt;</span> <span class="fu">Leaf</span><span class="op">(</span><span class="fu">f</span><span class="op">(</span>v<span class="op">)))((</span>l<span class="op">,</span> r<span class="op">)</span> <span class="op">=&gt;</span> <span class="ex">Node</span><span class="op">(</span>l<span class="op">,</span> r<span class="op">))</span></span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    </div>
    <h2 data-number="2.4" id="構造的余再帰"><span class="header-section-number">2.4</span> 構造的余再帰</h2>
    <p>Structural corecursion is the opposite—more correctly, the
    dual—of structural recursion. Whereas structural recursion tells us
    how to take apart an algebraic data type, structural corecursion
    tells us how to build up, or construct, an algebraic data type.
    Whereas we can use structural recursion whenever the input of a
    method or function is an algebraic data type, we can use structural
    corecursion whenever the output of a method or function is an
    algebraic data type.</p>
    <p>構造的余再帰は、構造的再帰の反対、より正確な用語を使うなら、双対である。構造的再帰が代数的データ型をどのように分解するかを教えてくれるのに対して、構造的余再帰は代数的データ型をどのように構築するかを教えてくれる。構造的再帰は、メソッドや関数の入力が代数的データ型である場合に使用できるが、構造的余再帰はメソッドや関数の出力が代数的データ型である場合に使用できる。</p>
    <section id="関数型プログラミングにおける双対性" class="unnumbered callout callout-info">
    <h4 class="unnumbered">関数型プログラミングにおける双対性</h4>
    <p>Two concepts or structures are duals if one can be translated in
    a one-to-one fashion to the other. Duality is one of the main themes
    of this book. By relating concepts as duals we can transfer
    knowledge from one domain to another.</p>
    <p>Duality is often indicated by attaching the co- prefix to one of
    the structures or concepts. For example, corecursion is the dual of
    recursion, and sum types, also known as coproducts, are the dual of
    product types.</p>
    <p>二つの概念や構造が一対一で対応付けられる場合、それらを双対であると言う。双対性は本書の主要なテーマのひとつである。概念同士を双対として関連付けることで、ある領域の知識を別の領域に流用することができるようになる。</p>
    <p>双対性は、しばしば構造や概念に co-
    という接頭辞を付けることで示される。たとえば、英語でcorecursionと呼ばれる余再帰は再帰の双対であり、coproduct（余積）は積の双対である。</p>
    </section>
    <p>Structural recursion works by considering all the possible inputs
    (which we usually represent as patterns), and then working out what
    we do with each input case. Structural corecursion works by
    considering all the possible outputs, which are the constructors of
    the algebraic data type, and then working out the conditions under
    which we’d call each constructor.</p>
    <p>構造的再帰は、すべてのありうる入力（通常はパターンとして表現されるもの）を考慮し、それぞれの入力ケースに対して何を行うかを決定することで機能する。一方、構造的余再帰は、すべてのありうる出力、すなわち代数的データ型のコンストラクタについて考慮し、それぞれのコンストラクタを呼び出す条件を決定することで機能する。</p>
    <p>Let’s return to the list with elements of type <code>A</code>,
    defined as:</p>
    <p><code>A</code>
    型の要素を持つリストの話に戻ろう。これは次のように定義することができた。</p>
    <ul>
    <li><p>the empty list; or</p></li>
    <li><p>a pair containing an <code>A</code> and a tail, which is a
    list of <code>A</code>.</p></li>
    <li><p>リストは空であるか、もしくは</p></li>
    <li><p>ひとつの <code>A</code> 型の値と、それ自体が <code>A</code>
    のリストである残りの部分のペア</p></li>
    </ul>
    <p>In Scala 3 we write</p>
    <p>Scala3では次のように書かれる。</p>
    <div class="sourceCode" id="cb64"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>enum MyList<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">:</span> A<span class="op">,</span> tail<span class="op">:</span> MyList<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>We can use structural corecursion if we’re writing a method that
    produces a <code>MyList</code>. A good example is
    <code>map</code>:</p>
    <p><code>MyList</code>
    オブジェクトを生成するメソッドを書きたいときに、構造的余再帰を利用することができる。そのよい例として
    <code>map</code> がある。</p>
    <div class="sourceCode" id="cb65"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>enum MyList<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">:</span> A<span class="op">,</span> tail<span class="op">:</span> MyList<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>B<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> MyList<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> </span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>The output of this method is a <code>MyList</code>, which is an
    algebraic data type. Since we need to construct a
    <code>MyList</code> we can use structural corecursion. The
    structural corecursion strategy says we write down all the
    constructors and then consider the conditions that will cause us to
    call each constructor. So our starting point is to just write down
    the two constructors, and put in dummy conditions.</p>
    <p>このメソッドの出力は代数的データ型である <code>MyList</code>
    である。<code>MyList</code>
    インスタンスを構築したいのだから、構造的余再帰を利用することができる。構造的余再帰の戦略では、まずすべてのコンストラクタを書き出し、それぞれのコンストラクタを呼び出す条件を考える。したがって、最初のステップは、二つのコンストラクタを書き出し、仮の条件を入れることである。</p>
    <div class="sourceCode" id="cb66"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>enum MyList<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">:</span> A<span class="op">,</span> tail<span class="op">:</span> MyList<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>B<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> MyList<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> </span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">???</span> then <span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="bu">Pair</span><span class="op">(???,</span> <span class="op">???)</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>We can also apply the recursion rule: where the data is recursive
    so is the method.</p>
    <p>データが再帰的である場所で再帰呼び出しを行うというルールを適用すると、メソッドは以下のようになる。</p>
    <div class="sourceCode" id="cb67"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>enum MyList<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">:</span> A<span class="op">,</span> tail<span class="op">:</span> MyList<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>B<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> MyList<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> </span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">???</span> then <span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="bu">Pair</span><span class="op">(???,</span> <span class="op">???.</span><span class="fu">map</span><span class="op">(</span>f<span class="op">))</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>To complete the left-hand side we can use the strategies we’ve
    already seen:</p>
    <p>これまでに学んだ戦略を使って、<code>if</code>
    式の条件部、あるいは書き方によってはパターンマッチングとなる左側部分を完成させることができる。</p>
    <ul>
    <li><p>we can use structural recursion to tell us there are two
    possible conditions; and</p></li>
    <li><p>we can follow the types to align these conditions with the
    code we have already written.</p></li>
    <li><p>構造的再帰を使って、ありうる条件が二つあることを確認する</p></li>
    <li><p>型に従って、これらの条件を既に書いたコードに合わせる</p></li>
    </ul>
    <p>In short order we arrive at the correct solution</p>
    <p>この手順に従えば、短時間で正しい解決策にたどり着くことができる。</p>
    <div class="sourceCode" id="cb68"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>enum MyList<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">:</span> A<span class="op">,</span> tail<span class="op">:</span> MyList<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>B<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> MyList<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> </span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span> <span class="op">=&gt;</span> <span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">,</span> tail<span class="op">)</span> <span class="op">=&gt;</span> <span class="bu">Pair</span><span class="op">(</span><span class="fu">f</span><span class="op">(</span>head<span class="op">),</span> tail<span class="op">.</span><span class="fu">map</span><span class="op">(</span>f<span class="op">))</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>There are a few interesting points here.</p>
    <p>ここにはいくつか興味深いポイントがある。</p>
    <p>Firstly, we should acknowledge that <code>map</code> is both a
    structural recursion and a structural corecursion. This is not
    always the case. For example, <code>foldLeft</code> and
    <code>foldRight</code> are not structural corecursions because they
    are not constrained to only produce an algebraic data type.</p>
    <p>まず、<code>map</code>
    は構造的再帰であり、同時に構造的余再帰でもあるということを認識しておく必要がある。これはいつも成り立つわけではない。たとえば、<code>foldLeft</code>
    と <code>foldRight</code>
    は、必ずしも代数的データ型を生成するとは限らないし、構造的余再帰ではない。</p>
    <p>Secondly, note that when we walked through the process of
    creating <code>map</code> as a structural recursion we implicitly
    used the structural corecursion pattern, as part of following the
    types. We recognised that we were producing a <code>List</code>,
    that there were two possibilities for producing a <code>List</code>,
    and then worked out the correct conditions for each case.
    Formalizing structural corecursion as a separate strategy allows us
    to be more conscious of where we apply it.</p>
    <p>次に、<code>map</code>
    を構造的再帰として実装するプロセスを進めた際に、型に従う一環として、暗黙的に構造的余再帰のパターンを使用していたことに注目してほしい。我々は
    <code>List</code>
    を生成しようとしていることに気づき、<code>List</code>
    を生成する方法として二つの可能性を認識し、それぞれに適した条件を見出した。構造的余再帰を別の戦略として明示的に定義することで、それを適用しているということを、より意識的に認識できるようになる。</p>
    <p>Finally, notice how I switched from an <code>if</code> expression
    to a pattern match expression as we progressed through defining
    <code>map</code>. This is perfectly fine. Both kinds of expression
    achieve the same effect. Pattern matching is a little bit safer due
    to exhaustivity checking. If we wanted to continue using an
    <code>if</code> we’d have to define a method (for example,
    <code>isEmpty</code>) that allows us to distinguish an
    <code>Empty</code> element from a <code>Pair</code>. This method
    would have to use pattern matching in its implementation, so
    avoiding pattern matching directly is just pushing it elsewhere.</p>
    <p>最後に、<code>map</code> を定義していく過程で、<code>if</code>
    式からパターンマッチ式に切り替えたことに留意してほしい。これはまったく問題ない。どちらの式でも同じ効果を得ることができる。ただし、パターンマッチングは網羅性チェックがあるので少し安全である。また、もし
    <code>if</code> 式を使い続けるのであれば、<code>Empty</code> と
    <code>Pair</code> を区別するためのメソッド（たとえば
    <code>isEmpty</code>）を定義しなくてはならないが、そのメソッドの実装にあたってパターンマッチングを使用する必要があるため、パターンマッチングの直接的な利用を避けても、それを別の場所に押し込めてしまうだけである。</p>
    <h3 data-number="2.4.1" id="構造的余再帰としての展開unfold"><span class="header-section-number">2.4.1</span>
    構造的余再帰としての展開（unfold）</h3>
    <p>Just as we could abstract structural recursion as a fold, for any
    given algebraic data type we can abstract structural corecursion as
    an unfold. Unfolds are much less commonly used than folds, but they
    are still a nice tool to have.</p>
    <p>構造的再帰を <code>fold</code>
    として抽象化できたように、任意の代数的データ型に対して構造的余再帰を
    <code>unfold</code>
    として抽象化することができる。<code>unfold</code> は
    <code>fold</code>
    ほど一般的に使われるものではないが、有用なツールである。</p>
    <p>Let’s work through the process of deriving unfold, using
    <code>MyList</code> as our example again.</p>
    <p>もう一度 <code>MyList</code>
    を例として使いながら、<code>unfold</code>
    を導き出すプロセスを見ていこう。</p>
    <div class="sourceCode" id="cb69"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>enum MyList<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">:</span> A<span class="op">,</span> tail<span class="op">:</span> MyList<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>The corecursion skeleton is</p>
    <p>構造的余再帰の骨組みは以下のとおりだった。</p>
    <div class="sourceCode" id="cb70"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">???</span> then MyList<span class="op">.</span><span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span> MyList<span class="op">.</span><span class="bu">Pair</span><span class="op">(???,</span> <span class="fu">recursion</span><span class="op">(???))</span></span></code></pre></div>
    <p>Our starting point is writing the skeleton for
    <code>unfold</code>. It’s a little bit unusual in that I’ve added a
    parameter <code>seed</code>. This is the information we use to
    create an element. We’ll need this, but we cannot derive it from our
    strategies, so I’ve added it in here as a starting assumption.</p>
    <p>まず <code>unfold</code>
    の骨格を書き出すことから始める。少し変わっているのは、<code>seed</code>
    というパラメータを追加していることである。これはデータを作成するために必要なものだが、戦略から導き出せるものではないため、初期の仮定としてここに追加されている。</p>
    <div class="sourceCode" id="cb71"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> unfold<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>seed<span class="op">:</span> A<span class="op">):</span> MyList<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">???</span></span></code></pre></div>
    <p>Now we start using our strategies to fill in the missing pieces.
    I’m using the corecursion skeleton and I’ve applied the recursion
    rule immediately in the code below, to save a bit of time in the
    derivation.</p>
    <p>ここからは、いつもの戦略を使って不足部分を埋めていく。以下のコードでは、余再帰の骨格を用いるとともに、導出のステップを省くため、再帰呼び出しの記述まで行っている。</p>
    <div class="sourceCode" id="cb72"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> unfold<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>seed<span class="op">:</span> A<span class="op">):</span> MyList<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">???</span> then MyList<span class="op">.</span><span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> MyList<span class="op">.</span><span class="bu">Pair</span><span class="op">(???,</span> <span class="fu">unfold</span><span class="op">(</span>seed<span class="op">))</span></span></code></pre></div>
    <p>We can abstract the condition using a function from
    <code>A =&gt; Boolean</code>.</p>
    <p>条件部は <code>A =&gt; Boolean</code>
    型の関数を使って抽象化できる。</p>
    <div class="sourceCode" id="cb73"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> unfold<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>seed<span class="op">:</span> A<span class="op">,</span> stop<span class="op">:</span> A <span class="op">=&gt;</span> <span class="ex">Boolean</span><span class="op">):</span> MyList<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="fu">stop</span><span class="op">(</span>seed<span class="op">)</span> then MyList<span class="op">.</span><span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> MyList<span class="op">.</span><span class="bu">Pair</span><span class="op">(???,</span> <span class="fu">unfold</span><span class="op">(</span>seed<span class="op">,</span> stop<span class="op">))</span></span></code></pre></div>
    <p>Now we need to handle the case for <code>Pair</code>. We have a
    value of type <code>A</code> (<code>seed</code>), so to create the
    <code>head</code> element of <code>Pair</code> we can ask for a
    function <code>A =&gt; B</code></p>
    <p>次に必要なのは <code>Pair</code>
    を生成するケースのハンドリングである。 <code>A</code> 型の値として
    <code>seed</code> がすでにあるので、<code>Pair</code> の
    <code>head</code> 要素を作成するには <code>A =&gt; B</code>
    型の関数があればよいだろう。</p>
    <div class="sourceCode" id="cb74"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> unfold<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>seed<span class="op">:</span> A<span class="op">,</span> stop<span class="op">:</span> A <span class="op">=&gt;</span> <span class="ex">Boolean</span><span class="op">,</span> f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> MyList<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="fu">stop</span><span class="op">(</span>seed<span class="op">)</span> then MyList<span class="op">.</span><span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> MyList<span class="op">.</span><span class="bu">Pair</span><span class="op">(</span><span class="fu">f</span><span class="op">(</span>seed<span class="op">),</span> <span class="fu">unfold</span><span class="op">(???,</span> stop<span class="op">,</span> f<span class="op">))</span></span></code></pre></div>
    <p>Finally we need to update the current value of <code>seed</code>
    to the next value. That’s a function <code>A =&gt; A</code>.</p>
    <p>最後に、現在の <code>seed</code>
    値から、次の再帰呼び出しで使う値を導かなくてはならない。そのために
    <code>A =&gt; A</code> 型の関数が必要となる。</p>
    <div class="sourceCode" id="cb75"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> unfold<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>seed<span class="op">:</span> A<span class="op">,</span> stop<span class="op">:</span> A <span class="op">=&gt;</span> <span class="ex">Boolean</span><span class="op">,</span> f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">,</span> next<span class="op">:</span> A <span class="op">=&gt;</span> A<span class="op">):</span> MyList<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="fu">stop</span><span class="op">(</span>seed<span class="op">)</span> then MyList<span class="op">.</span><span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> MyList<span class="op">.</span><span class="bu">Pair</span><span class="op">(</span><span class="fu">f</span><span class="op">(</span>seed<span class="op">),</span> <span class="fu">unfold</span><span class="op">(</span><span class="fu">next</span><span class="op">(</span>seed<span class="op">),</span> stop<span class="op">,</span> f<span class="op">,</span> next<span class="op">))</span></span></code></pre></div>
    <p>At this point we’re done. Let’s see that <code>unfold</code> is
    useful by declaring some other methods in terms of it. We’re going
    to declare <code>map</code>, which we’ve already seen is a
    structural corecursion, using <code>unfold</code>. We will also
    define <code>fill</code> and <code>iterate</code>, which are methods
    that construct lists and correspond to the methods with the same
    names on <code>List</code> in the Scala standard library.</p>
    <p>これで <code>unfold</code>
    の定義は完成である。<code>unfold</code>
    がどのように役立つかを確認するため、これを使って他のメソッドを定義してみよう。すでに見たように、<code>map</code>
    は構造的余再帰なので、これを <code>unfold</code>
    で定義しなおす。さらに、リストを構築するメソッドである
    <code>fill</code> と <code>iterate</code>
    も定義することにする。これらは、Scala標準ライブラリの
    <code>List</code> にある同名のメソッドに対応している。</p>
    <p>To make this easier to work with I’m going to declare
    <code>unfold</code> as a method on the <code>MyList</code> companion
    object. I have made a slight tweak to the definition to make type
    inference work a bit better. In Scala, types inferred for one method
    parameter cannot be used for other method parameters in the same
    parameter list. However, types inferred for one method parameter
    list can be used in subsequent lists. Separating the function
    parameters from the <code>seed</code> parameter means that the value
    inferred for <code>A</code> from <code>seed</code> can be used for
    inference of the function parameters’ input parameters.</p>
    <p>次に示すコードでは、作業を簡単にするため、<code>unfold</code> を
    <code>MyList</code>
    のコンパニオンオブジェクトのメソッドとして宣言している。また、型推論を改善するために定義に少し調整を加えている。Scalaでは、あるメソッドパラメータについて推論された型を、同じパラメータリスト内にある他のパラメータの型推論で使うことはできない。だが、異なるパラメータリストにおいては、先行するパラメータリストで推論された型を後続のパラメータリストで利用することができる。関数パラメータを
    <code>seed</code>
    とは別のパラメータリストに分けることで、<code>seed</code>
    から推論された <code>A</code>
    の型を、関数パラメータの入力型の推論に使用できるようにしている。</p>
    <p>I have also declared some <strong>destructor</strong> methods,
    which are methods that take apart an algebraic data type. For
    <code>MyList</code> these are <code>head</code>, <code>tail</code>,
    and the predicate <code>isEmpty</code>. We’ll talk more about these
    a bit later.</p>
    <p>さらに、代数的データ型を分解するメソッドであるデストラクタもいくつか宣言した。今回の
    <code>MyList</code>
    では、<code>head</code>、<code>tail</code>、そして述語
    <code>isEmpty</code>
    がデストラクタである。これらについては後ほど詳しく説明する。</p>
    <!--
    訳注: オブジェクト指向言語の文脈で使う「デストラクタ」と異なり、分解関数とでも言うべきものであること、余データの章を読めばこの用語のもつ含意がつかめるだろうことを述べる
    -->
    <p>Here’s our starting point.</p>
    <p>以下のコードから始めよう。</p>
    <div class="sourceCode" id="cb76"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>enum MyList<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>_head<span class="op">:</span> A<span class="op">,</span> _tail<span class="op">:</span> MyList<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> isEmpty<span class="op">:</span> <span class="ex">Boolean</span> <span class="op">=</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span> <span class="op">=&gt;</span> <span class="kw">true</span></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> _       <span class="op">=&gt;</span> <span class="kw">false</span></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> head<span class="op">:</span> A <span class="op">=</span></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">,</span> _<span class="op">)</span> <span class="op">=&gt;</span> head</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> tail<span class="op">:</span> MyList<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>_<span class="op">,</span> tail<span class="op">)</span> <span class="op">=&gt;</span> tail</span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> MyList <span class="op">{</span></span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> unfold<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>seed<span class="op">:</span> A<span class="op">)(</span>stop<span class="op">:</span> A <span class="op">=&gt;</span> <span class="ex">Boolean</span><span class="op">,</span> f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">,</span> next<span class="op">:</span> A <span class="op">=&gt;</span> A<span class="op">):</span> MyList<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="fu">stop</span><span class="op">(</span>seed<span class="op">)</span> then MyList<span class="op">.</span><span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> MyList<span class="op">.</span><span class="bu">Pair</span><span class="op">(</span><span class="fu">f</span><span class="op">(</span>seed<span class="op">),</span> <span class="fu">unfold</span><span class="op">(</span><span class="fu">next</span><span class="op">(</span>seed<span class="op">))(</span>stop<span class="op">,</span> f<span class="op">,</span> next<span class="op">))</span></span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Now let’s define the constructors <code>fill</code> and
    <code>iterate</code>, and <code>map</code>, in terms of
    <code>unfold</code>. I think the constructors are a bit simpler, so
    I’ll do those first.</p>
    <p>まずはリストを生成する <code>fill</code> と
    <code>iterate</code>、そして <code>map</code>
    を、<code>unfold</code>
    を使って定義する。生成メソッドのほうが分解と比べて簡単なので、まずはそちらから取り組もうという意図である。</p>
    <!-- TODO: 「分解と比べて」という補足は多分間違っている。何と比較しているのか文脈を確認する　-->
    <div class="sourceCode" id="cb77"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> MyList <span class="op">{</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> unfold<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>seed<span class="op">:</span> A<span class="op">)(</span>stop<span class="op">:</span> A <span class="op">=&gt;</span> <span class="ex">Boolean</span><span class="op">,</span> f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">,</span> next<span class="op">:</span> A <span class="op">=&gt;</span> A<span class="op">):</span> MyList<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="fu">stop</span><span class="op">(</span>seed<span class="op">)</span> then MyList<span class="op">.</span><span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> MyList<span class="op">.</span><span class="bu">Pair</span><span class="op">(</span><span class="fu">f</span><span class="op">(</span>seed<span class="op">),</span> <span class="fu">unfold</span><span class="op">(</span><span class="fu">next</span><span class="op">(</span>seed<span class="op">))(</span>stop<span class="op">,</span> f<span class="op">,</span> next<span class="op">))</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> fill<span class="op">[</span>A<span class="op">](</span>n<span class="op">:</span> <span class="bu">Int</span><span class="op">)(</span>elem<span class="op">:</span> <span class="op">=&gt;</span> A<span class="op">):</span> MyList<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> iterate<span class="op">[</span>A<span class="op">](</span>start<span class="op">:</span> A<span class="op">,</span> len<span class="op">:</span> <span class="bu">Int</span><span class="op">)(</span>f<span class="op">:</span> A <span class="op">=&gt;</span> A<span class="op">):</span> MyList<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Here I’ve just added the method skeletons, which are taken
    straight from the <code>List</code> documentation. To implement
    these methods we can use one of two strategies:</p>
    <p>ここでは、<code>List</code>
    のドキュメントからそのまま取ってきたメソッドの骨格だけを追加している。これらのメソッドを実装するにあたっては、次の二つの戦略のいずれかが利用可能である。</p>
    <ul>
    <li><p>reasoning about loops in the way we might in an imperative
    language; or</p></li>
    <li><p>reasoning about structural recursion over the natural
    numbers.</p></li>
    <li><p>命令型言語における方法でループについて考えること</p></li>
    <li><p>自然数に対する構造的再帰について考えること</p></li>
    </ul>
    <p>Let’s talk about each in turn.</p>
    <p>順に見ていこう。</p>
    <p>You might have noticed that the parameters to <code>unfold</code>
    are almost exactly those you need to create a for-loop in a language
    like Java. A classic for-loop, of the
    <code>for(i = 0; i &lt; n; i++)</code> kind, has four
    components:</p>
    <p><code>unfold</code>
    のパラメータが、Javaなどの言語でforループを作る際に必要なものとほぼ一致していることに気づいた人もいるかもしれない。典型的な
    <code>for(i = 0; i &lt; n; i++)</code>
    形式のforループには、次の4つの要素がある。</p>
    <ol type="1">
    <li><p>the initial value of the loop counter;</p></li>
    <li><p>the stopping condition of the loop;</p></li>
    <li><p>the statement that advances the counter; and</p></li>
    <li><p>the body of the loop that uses the counter.</p></li>
    <li><p>ループカウンタの初期値</p></li>
    <li><p>ループの停止条件</p></li>
    <li><p>カウンタを進めるためのステートメント</p></li>
    <li><p>カウンタを使用するループの本体</p></li>
    </ol>
    <p>These correspond to the <code>seed</code>, <code>stop</code>,
    <code>next</code>, and <code>f</code> parameters of
    <code>unfold</code> respectively.</p>
    <p>これらはそれぞれ <code>unfold</code> のパラメータである
    <code>seed</code>、<code>stop</code>、<code>next</code>、<code>f</code>
    に対応している。</p>
    <p>Loop variants and invariants are the standard way of reasoning
    about imperative loops. I’m not going to describe them here, as you
    have probably already learned how to reason about loops (though
    perhaps not using these terms). Instead I’m going to discuss the
    second reasoning strategy, which relates writing <code>unfold</code>
    to something we’ve already discussed: structural recursion.</p>
    <p>ループの変化と不変条件について意識することは、命令型ループが何を行っているのかを把握するための標準的な方法である。ループの処理内容を読み解く方法についてはすでに知っているものとし（ここで使っている用語には馴染みがないかもしれないが）、ここでは詳しく説明しない。代わりに、二つ目の推論戦略について説明する。それは、<code>unfold</code>
    の書き方を、すでに話した構造的再帰と関連づける方法である。</p>
    <p>Our first step is to note that natural numbers (the integers 0
    and larger) are conceptually algebraic data types even though the
    implementation in Scala—using <code>Int</code>—is not. A natural
    number is either:</p>
    <p>最初に注目すべき点は、自然数（ここでは0以上の整数と定義する）が概念的には代数的データ型であるということである。もっとも、Scalaにおいては自然数は
    <code>Int</code>
    を使って表現されるし、代数的データ型とは言えないが。自然数は次のいずれかであると定義できる。</p>
    <ul>
    <li>ゼロ</li>
    <li>ある自然数に1を足した数</li>
    </ul>
    <p>It’s the simplest possible algebraic data type that is both a sum
    and a product type.</p>
    <p>これは直和型と直積型の両方をもつ最もシンプルな代数的データ型である。</p>
    <p>Once we see this, we can use the reasoning tools for structural
    recursion for creating the parameters to <code>unfold</code>. Let’s
    show how this works with <code>fill</code>. The <code>n</code>
    parameter tells us how many elements there are in the
    <code>List</code> we’re creating. The <code>elem</code> parameter
    creates those elements, and is called once for each element. So our
    starting point is to consider this as a structural recursion over
    the natural numbers. We can take <code>n</code> as
    <code>seed</code>, and <code>stop</code> as the function
    <code>x =&gt; x == 0</code>. These are the standard conditions for a
    structural recursion over the natural numbers. What about
    <code>next</code>? Well, the definition of natural numbers tells us
    we should subtract one in the recursive case, so <code>next</code>
    becomes <code>x =&gt; x - 1</code>. We only need <code>f</code>, and
    that comes from the definition of how <code>fill</code> is supposed
    to work. We create the value from <code>elem</code>, so
    <code>f</code> is just <code>_ =&gt; elem</code></p>
    <p>これを理解すると、構造的再帰の推論ツールを使って、<code>unfold</code>
    に渡すパラメータを作成することができる。これがどのように機能するか、<code>fill</code>
    の例で説明しよう。パラメータ <code>n</code>
    は作成するリストの要素数を示している。パラメータ <code>elem</code>
    はリストの要素を生成するため、各要素に対して一度ずつ呼び出される。ここでは、これを自然数に対する構造的再帰として考える。<code>n</code>
    を <code>seed</code> とし、<code>stop</code> には
    <code>x =&gt; x == 0</code>
    という関数を渡す。これらは自然数に対する構造的再帰における標準的な条件である。<code>next</code>
    はどうすればよいだろうか。自然数の定義に従い再帰的に1を引けばよいので、<code>next</code>
    は <code>x =&gt; x - 1</code> となる。最後に <code>f</code>
    だが、これは <code>fill</code>
    がどのように動作すべきかという定義から導かれる。<code>fill</code> は
    <code>elem</code> を使って値を作成するので、<code>f</code>
    はシンプルに <code>_ =&gt; elem</code> となる。</p>
    <div class="sourceCode" id="cb78"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> MyList <span class="op">{</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> unfold<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>seed<span class="op">:</span> A<span class="op">)(</span>stop<span class="op">:</span> A <span class="op">=&gt;</span> <span class="ex">Boolean</span><span class="op">,</span> f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">,</span> next<span class="op">:</span> A <span class="op">=&gt;</span> A<span class="op">):</span> MyList<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="fu">stop</span><span class="op">(</span>seed<span class="op">)</span> then MyList<span class="op">.</span><span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> MyList<span class="op">.</span><span class="bu">Pair</span><span class="op">(</span><span class="fu">f</span><span class="op">(</span>seed<span class="op">),</span> <span class="fu">unfold</span><span class="op">(</span><span class="fu">next</span><span class="op">(</span>seed<span class="op">))(</span>stop<span class="op">,</span> f<span class="op">,</span> next<span class="op">))</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> fill<span class="op">[</span>A<span class="op">](</span>n<span class="op">:</span> <span class="bu">Int</span><span class="op">)(</span>elem<span class="op">:</span> <span class="op">=&gt;</span> A<span class="op">):</span> MyList<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unfold</span><span class="op">(</span>n<span class="op">)(</span>_ <span class="op">==</span> <span class="dv">0</span><span class="op">,</span> _ <span class="op">=&gt;</span> elem<span class="op">,</span> _ <span class="op">-</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> iterate<span class="op">[</span>A<span class="op">](</span>start<span class="op">:</span> A<span class="op">,</span> len<span class="op">:</span> <span class="bu">Int</span><span class="op">)(</span>f<span class="op">:</span> A <span class="op">=&gt;</span> A<span class="op">):</span> MyList<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>We should check that our implementation works as intended. We can
    do this by comparing it to <code>List.fill</code>.</p>
    <p>この実装が意図通りに動作するか確認しておくほうがよいだろう。<code>List.fill</code>
    と比較することで確認が可能である。</p>
    <div class="sourceCode" id="cb79"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="ex">List</span><span class="op">.</span><span class="fu">fill</span><span class="op">(</span><span class="dv">5</span><span class="op">)(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res6: List[Int] = List(1, 1, 1, 1, 1)</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>MyList<span class="op">.</span><span class="fu">fill</span><span class="op">(</span><span class="dv">5</span><span class="op">)(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res7: MyList[Int] = MyList(1, 1, 1, 1, 1)</span></span></code></pre></div>
    <p>Here’s a slightly more complex example, using a stateful method
    to create a list of ascending numbers. First we define the state and
    method that uses it.</p>
    <p>次に示すのは、状態をもつ関数を <code>elem</code>
    として使用し、昇順の数値リストを作成する、もう少し複雑な確認例である。まず、状態を定義し、それを使用する関数を定義する。</p>
    <div class="sourceCode" id="cb80"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> counter <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">getAndInc</span><span class="op">():</span> <span class="bu">Int</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> temp <span class="op">=</span> counter</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>  counter <span class="op">=</span> counter <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>  temp </span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>これを <code>fill</code>
    メソッドに渡せば、昇順の数値リストが得られるはずである。</p>
    <div class="sourceCode" id="cb81"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="ex">List</span><span class="op">.</span><span class="fu">fill</span><span class="op">(</span><span class="dv">5</span><span class="op">)(</span><span class="fu">getAndInc</span><span class="op">())</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res8: List[Int] = List(0, 1, 2, 3, 4)</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>counter <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>MyList<span class="op">.</span><span class="fu">fill</span><span class="op">(</span><span class="dv">5</span><span class="op">)(</span><span class="fu">getAndInc</span><span class="op">())</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="co">// res10: MyList[Int] = MyList(0, 1, 2, 3, 4)</span></span></code></pre></div>
    <h4 class="unnumbered" id="演習-mylist-への-iterate-の実装">演習:
    <code>MyList</code> への <code>iterate</code> の実装</h4>
    <p>Implement <code>iterate</code> using the same reasoning as we did
    for <code>fill</code>. This is slightly more complex than
    <code>fill</code> as we need to keep two bits of information: the
    value of the counter and the value of type <code>A</code>.</p>
    <p><code>fill</code> の時と同じ考え方を使って <code>iterate</code>
    を実装せよ。<code>iterate</code> は、カウンタの値と型 <code>A</code>
    の値という二つの情報を保持する必要があるため、<code>fill</code>
    よりもすこし複雑になる。</p>
    <div class="solution">
    <div class="sourceCode" id="cb82"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> MyList <span class="op">{</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> unfold<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>seed<span class="op">:</span> A<span class="op">)(</span>stop<span class="op">:</span> A <span class="op">=&gt;</span> <span class="ex">Boolean</span><span class="op">,</span> f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">,</span> next<span class="op">:</span> A <span class="op">=&gt;</span> A<span class="op">):</span> MyList<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="fu">stop</span><span class="op">(</span>seed<span class="op">)</span> then MyList<span class="op">.</span><span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> MyList<span class="op">.</span><span class="bu">Pair</span><span class="op">(</span><span class="fu">f</span><span class="op">(</span>seed<span class="op">),</span> <span class="fu">unfold</span><span class="op">(</span><span class="fu">next</span><span class="op">(</span>seed<span class="op">))(</span>stop<span class="op">,</span> f<span class="op">,</span> next<span class="op">))</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> fill<span class="op">[</span>A<span class="op">](</span>n<span class="op">:</span> <span class="bu">Int</span><span class="op">)(</span>elem<span class="op">:</span> <span class="op">=&gt;</span> A<span class="op">):</span> MyList<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unfold</span><span class="op">(</span>n<span class="op">)(</span>_ <span class="op">==</span> <span class="dv">0</span><span class="op">)(</span>_ <span class="op">=&gt;</span> elem<span class="op">,</span> _ <span class="op">-</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> iterate<span class="op">[</span>A<span class="op">](</span>start<span class="op">:</span> A<span class="op">,</span> len<span class="op">:</span> <span class="bu">Int</span><span class="op">)(</span>f<span class="op">:</span> A <span class="op">=&gt;</span> A<span class="op">):</span> MyList<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unfold</span><span class="op">((</span>len<span class="op">,</span> start<span class="op">)){</span></span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>len<span class="op">,</span> _<span class="op">)</span> <span class="op">=&gt;</span> len <span class="op">==</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>_<span class="op">,</span> start<span class="op">)</span> <span class="op">=&gt;</span> start<span class="op">,</span></span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>len<span class="op">,</span> start<span class="op">)</span> <span class="op">=&gt;</span> <span class="op">(</span>len <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> <span class="fu">f</span><span class="op">(</span>start<span class="op">))</span></span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>解答は以上である。これも動作確認をしておこう。</p>
    <div class="sourceCode" id="cb83"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="ex">List</span><span class="op">.</span><span class="fu">iterate</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">5</span><span class="op">)(</span>x <span class="op">=&gt;</span> x <span class="op">-</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res11: List[Int] = List(0, -1, -2, -3, -4)</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>MyList<span class="op">.</span><span class="fu">iterate</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">5</span><span class="op">)(</span>x <span class="op">=&gt;</span> x <span class="op">-</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res12: MyList[Int] = MyList(0, -1, -2, -3, -4)</span></span></code></pre></div>
    </div>
    <h4 class="unnumbered" id="演習-mylist-への-map-の実装">演習:
    <code>MyList</code> への <code>map</code> の実装</h4>
    <p>Once you’ve completed <code>iterate</code>, try to implement
    <code>map</code> in terms of <code>unfold</code>. You’ll need to use
    the destructors to implement it.</p>
    <p><code>map</code> を <code>unfold</code>
    を用いて再実装せよ。なお、これを実装するにはデストラクタを利用する必要がある。</p>
    <div class="solution">
    <div class="sourceCode" id="cb84"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> map<span class="op">[</span>B<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> MyList<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>  MyList<span class="op">.</span><span class="fu">unfold</span><span class="op">(</span><span class="kw">this</span><span class="op">)(</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>    _<span class="op">.</span>isEmpty<span class="op">,</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>    pair <span class="op">=&gt;</span> <span class="fu">f</span><span class="op">(</span>pair<span class="op">.</span>head<span class="op">),</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>    pair <span class="op">=&gt;</span> pair<span class="op">.</span>tail</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb85"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="ex">List</span><span class="op">.</span><span class="fu">iterate</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">5</span><span class="op">)(</span>x <span class="op">=&gt;</span> x <span class="op">+</span> <span class="dv">1</span><span class="op">).</span><span class="fu">map</span><span class="op">(</span>x <span class="op">=&gt;</span> x <span class="op">*</span> <span class="dv">2</span><span class="op">)</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res13: List[Int] = List(0, 2, 4, 6, 8)</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>MyList<span class="op">.</span><span class="fu">iterate</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">5</span><span class="op">)(</span>x <span class="op">=&gt;</span> x <span class="op">+</span> <span class="dv">1</span><span class="op">).</span><span class="fu">map</span><span class="op">(</span>x <span class="op">=&gt;</span> x <span class="op">*</span> <span class="dv">2</span><span class="op">)</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res14: MyList[Int] = MyList(0, 2, 4, 6, 8)</span></span></code></pre></div>
    </div>
    <p>Now a quick discussion on destructors. The destructors do two
    things:</p>
    <p>ここで、デストラクタについて簡単に見ておこう。デストラクタは二つのことを行う。</p>
    <ol type="1">
    <li><p>distinguish the different cases within a sum type;
    and</p></li>
    <li><p>extract elements from each product type.</p></li>
    <li><p>直和型の複数のケースを区別し、そして</p></li>
    <li><p>区別したそれぞれの直積型からプロパティを取り出す</p></li>
    </ol>
    <p>So for <code>MyList</code> the minimal set of destructors is
    <code>isEmpty</code>, which distinguishes <code>Empty</code> from
    <code>Pair</code>, and <code>head</code> and <code>tail</code>. The
    extractors are partial functions in the conceptual, not Scala,
    sense; they are only defined for a particular product type and throw
    an exception if used on a different case. You may have also noticed
    that the functions we passed to <code>fill</code> are exactly the
    destructors for natural numbers.</p>
    <p><code>MyList</code> の場合、最小限のデストラクタは、
    <code>Pair</code> から <code>Empty</code> を区別する
    <code>isEmpty</code> と、そして <code>head</code> と
    <code>tail</code>
    である。プロパティを取り出すメソッド（extractor）は部分関数になる。これはScalaとは無関係な概念上の話である。それらは特定の直積型に対してだけ定義されており、それ以外のケースで用いると例外をスローする。また、先ほど
    <code>fill</code>
    に渡した関数が、まさに自然数に対するデストラクタであったことにも留意してほしい。</p>
    <p>The destructors are another part of the duality between
    structural recursion and corecursion. Structural recursion is:</p>
    <p>デストラクタは構造的再帰と構造的余再帰の間にある双対性のもうひとつの側面である。構造的再帰がやることは以下のとおりだが、</p>
    <ul>
    <li><p>defined by pattern matching on the constructors; and</p></li>
    <li><p>takes apart an algebraic data type into smaller
    pieces.</p></li>
    <li><p>コンストラクタに対するパターンマッチングによって定義され、そして</p></li>
    <li><p>代数的データ型を小さな部分に分解する</p></li>
    </ul>
    <p>Structural corecursion instead is:</p>
    <p>一方、構造的余再帰は以下のことを行う。</p>
    <ul>
    <li><p>defined by conditions on the input, which may use
    destructors; and</p></li>
    <li><p>build up an algebraic data type from smaller pieces.</p></li>
    <li><p>入力に対する条件によって定義され、そして</p></li>
    <li><p>小さな部分から代数的データ型の値を組み立てる</p></li>
    </ul>
    <!-- TODO: which may use destructors を訳す -->
    <p>One last thing before we leave <code>unfold</code>. If we look at
    the usual definition of <code>unfold</code> we’ll probably find the
    following definition.</p>
    <p><code>unfold</code>
    の話を終える前にもうひとつだけ述べておきたい。一般的な
    <code>unfold</code>
    の定義を見ると、おそらく以下のような定義が見つかるだろう。</p>
    <div class="sourceCode" id="cb86"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> unfold<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>in<span class="op">:</span> A<span class="op">)(</span>f<span class="op">:</span> A <span class="op">=&gt;</span> <span class="ex">Option</span><span class="op">[(</span>A<span class="op">,</span> B<span class="op">)]):</span> <span class="ex">List</span><span class="op">[</span>B<span class="op">]</span></span></code></pre></div>
    <p>This is equivalent to the definition we used, but a bit more
    compact in terms of the interface it presents. We used a more
    explicit definition that makes the structure of the method
    clearer.</p>
    <p>これは、我々が用いた定義と等価だが、インターフェースはややコンパクトである。我々の定義は、メソッドの構造を明確にするために、より明示的なものとなっている。</p>
    <h2 data-number="2.5" id="代数的データ型における代数"><span class="header-section-number">2.5</span>
    代数的データ型における代数</h2>
    <p>A question that sometimes comes up is where the “algebra” in
    algebraic data types comes from. I want to talk about this a little
    bit and show some of the algebraic manipulations that can be done on
    algebraic data types.</p>
    <p>ときどき出てくる質問に、代数的データ型の「代数」とは何なのか、というものがある。この点について少し触れ、代数的データ型で行える代数的な操作をいくつか紹介したい。</p>
    <p>The term algebra is used in the sense of abstract algebra, an
    area of mathematics. Abstract algebra deals with algebraic
    structures. An algebraic structure consists of a set of values,
    operations on that set, and properties that those operations must
    maintain.</p>
    <p>ここで使われる「代数」という用語は、数学の一分野である抽象代数学の意味で使われている。抽象代数学は、代数的構造を扱う分野である。代数的構造とは、ある値の集合、その集合に対する操作、およびそれらの操作が満たすべき性質を指している。</p>
    <p>An example is the set of integers, the operations addition and
    multiplication, and the familiar properties of these operations such
    as associativity, which says that <span class="math inline"><em>a</em> + (<em>b</em>+<em>c</em>) = (<em>a</em>+<em>b</em>) + <em>c</em></span>.
    The abstract in abstract algebra means that it doesn’t deal with
    concrete values like integers—that would be far too easy to
    understand—and instead with abstractions with wacky names like
    semigroup, monoid, and ring. The example of integers above is an
    instance of a ring. We’ll see a lot more of these soon enough!</p>
    <p>具体例としては、整数の集合と、加法や乗法といった操作、そして結合法則
    <span class="math inline"><em>a</em> + (<em>b</em>+<em>c</em>) = (<em>a</em>+<em>b</em>) + <em>c</em></span>
    などといった操作の性質が挙げられる。抽象代数学の「抽象」とは、整数のような具体的な集合（そうであれば理解するのは極めて簡単なのだが）を扱うのではなく、代わりに半群、モノイド、環といった奇妙な名前のついた抽象的な概念を扱うことを意味している。上記の整数の例は、環の一例である。これから、そのような概念をたくさん見ていくことになるだろう。</p>
    <p>Algebraic data types also correspond to the algebraic structure
    called a ring. A ring has two operations, which are conventionally
    written <span class="math inline">+</span> and <span class="math inline">×</span>. You’ll perhaps guess that these
    correspond to sum and product types respectively, and you’d be
    absolutely correct. What about the properties of these operations?
    We’ll they are similar to what we know from basic algebra:</p>
    <p>代数的データ型も、環と呼ばれる代数的構造に対応している。環には、二つの演算があり、通常それらは
    <span class="math inline">+</span> および <span class="math inline">×</span>
    と記述される。これらがそれぞれ直和型と直積型に対応していると推測したなら、それはまさにその通りである。では、環におけるこれらの演算の性質はどのようなものだろうか。それらは、基本的な代数について私たちが知っているものと似ている。</p>
    <ul>
    <li><p><span class="math inline">+</span> and <span class="math inline">×</span> are associative, so <span class="math inline"><em>a</em> + (<em>b</em>+<em>c</em>) = (<em>a</em>+<em>b</em>) + <em>c</em></span>
    and likewise for <span class="math inline">×</span>;</p></li>
    <li><p><span class="math inline"><em>a</em> + <em>b</em> = <em>b</em> + <em>a</em></span>,
    known as commutivitiy;</p></li>
    <li><p>there is an identity <span class="math inline">0</span> such
    that <span class="math inline"><em>a</em> + 0 = <em>a</em></span>;</p></li>
    <li><p>there is an identity <span class="math inline">1</span> such
    that <span class="math inline"><em>a</em> × 1 = <em>a</em></span>;</p></li>
    <li><p>there is distribution, so that <span class="math inline"><em>a</em> × (<em>b</em>+<em>c</em>) = (<em>a</em>×<em>b</em>) + (<em>a</em>×<em>c</em>)</span></p></li>
    <li><p><span class="math inline">+</span> と <span class="math inline">×</span> は結合法則を満たす。つまり <span class="math inline"><em>a</em> + (<em>b</em>+<em>c</em>) = (<em>a</em>+<em>b</em>) + <em>c</em></span>
    であり、<span class="math inline">×</span> についても同様</p></li>
    <li><p><span class="math inline"><em>a</em> + <em>b</em> = <em>b</em> + <em>a</em></span>
    です。これは交換法則として知られている</p></li>
    <li><p><span class="math inline"><em>a</em> + 0 = <em>a</em></span>
    となる単位元 <span class="math inline">0</span> が存在する</p></li>
    <li><p><span class="math inline"><em>a</em> × 1 = <em>a</em></span>
    となる単位元 <span class="math inline">1</span> が存在する</p></li>
    <li><p>分配法則が成り立つ。つまり <span class="math inline"><em>a</em> × (<em>b</em>+<em>c</em>) = (<em>a</em>×<em>b</em>) + (<em>a</em>×<em>c</em>)</span>
    である</p></li>
    </ul>
    <p>So far, so abstract. Let’s make it concrete by looking at actual
    examples in Scala.</p>
    <p>かなり抽象的な話になってしまったので、ここからは実際の例をScalaで見て具体化してみよう。</p>
    <p>Remember the algebraic data types work with types, so the
    operations <span class="math inline">+</span> and <span class="math inline">×</span> take types as parameters. So <span class="math inline"><em>I</em><em>n</em><em>t</em> × <em>S</em><em>t</em><em>r</em><em>i</em><em>n</em><em>g</em></span>
    is equivalent to</p>
    <p>代数的データ型は型を扱うので、演算 <span class="math inline">+</span> と <span class="math inline">×</span>
    も型を引数として受け取る。たとえば、<span class="math inline"><em>I</em><em>n</em><em>t</em> × <em>S</em><em>t</em><em>r</em><em>i</em><em>n</em><em>g</em></span>
    は次のように表される。</p>
    <div class="sourceCode" id="cb87"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">IntAndString</span><span class="op">(</span><span class="dt">int</span><span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> string<span class="op">:</span> <span class="ex">String</span><span class="op">)</span></span></code></pre></div>
    <p>We can use tuples to avoid creating lots of names.</p>
    <p>いちいち命名しなくてもよいようにタプルを使うという手もある。</p>
    <div class="sourceCode" id="cb88"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> IntAndString <span class="op">=</span> <span class="op">(</span><span class="bu">Int</span><span class="op">,</span> <span class="ex">String</span><span class="op">)</span></span></code></pre></div>
    <p>We can do the same thing for <span class="math inline">+</span>.
    <span class="math inline"><em>I</em><em>n</em><em>t</em> + <em>S</em><em>t</em><em>r</em><em>i</em><em>n</em><em>g</em></span>
    is</p>
    <p><span class="math inline">+</span>
    という演算に対しても同じような表現が可能である。 <span class="math inline"><em>I</em><em>n</em><em>t</em> + <em>S</em><em>t</em><em>r</em><em>i</em><em>n</em><em>g</em></span>
    は次のように表される。</p>
    <div class="sourceCode" id="cb89"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>enum IntOrString <span class="op">{</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">IsInt</span><span class="op">(</span><span class="dt">int</span><span class="op">:</span> <span class="bu">Int</span><span class="op">)</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">IsString</span><span class="op">(</span>string<span class="op">:</span> <span class="ex">String</span><span class="op">)</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>もしくは単に以下のように表現してもかまわない。</p>
    <div class="sourceCode" id="cb90"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> IntOrString <span class="op">=</span> Either<span class="op">[</span><span class="bu">Int</span><span class="op">,</span> <span class="ex">String</span><span class="op">]</span></span></code></pre></div>
    <h4 class="unnumbered" id="演習-単位元">演習: 単位元</h4>
    <p>Can you work out which Scala type corresponds to the identity
    <span class="math inline">1</span> for product types?</p>
    <p>直積型における単位元 <span class="math inline">1</span>
    に対応する Scala の型は何か考察せよ。</p>
    <div class="solution">
    <p>It’s <code>Unit</code>, because adding <code>Unit</code> to any
    product doesn’t add any more information. So, <code>Int</code>
    contains exactly as much information as <span class="math inline"><em>I</em><em>n</em><em>t</em> × <em>U</em><em>n</em><em>i</em><em>t</em></span>
    (written as the tuple <code>(Int, Unit)</code> in Scala).</p>
    <p>直積型の単位元は <code>Unit</code> 型である。ある直積型に
    <code>Unit</code>
    型のフィールドを追加しても、何も情報を追加したことにはならない。
    <code>Int</code> 型がもつ情報量は、 <span class="math inline"><em>I</em><em>n</em><em>t</em> × <em>U</em><em>n</em><em>i</em><em>t</em></span>
    （Scalaでタプルとして書くなら
    <code>(Int, Unit)</code>）型と同じである。</p>
    </div>
    <p>What about the Scala type corresponding to the identity <span class="math inline">0</span> for sum types?</p>
    <p>また、直和型における単位元 <span class="math inline">0</span>
    に対応するScalaの型は何か、考察せよ。</p>
    <div class="solution">
    <p>It’s <code>Nothing</code>, following the same reasoning as
    products: a case of <code>Nothing</code> adds no further information
    (and we cannot even create a value with this type.)</p>
    <p>直和型の単位元は <code>Nothing</code>
    型である。直積型のときと同様に、 <code>Nothing</code>
    というケースは何の情報ももたない。この型の値を生成することすらできない。</p>
    </div>
    <p>What about the distribution law? This allows us to manipulate
    algebraic data types to form equivalent, but perhaps more useful,
    representations. Consider this example of a user data type.</p>
    <p>代数的データ型における分配法則はどのようなものだろうか。この法則を使うと、代数的データ型を操作して、等価だがより使いやすい表現を作成することができる。その例として、ユーザを表すデータ型を考えてみよう。</p>
    <div class="sourceCode" id="cb91"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">Person</span><span class="op">(</span>name<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> permissions<span class="op">:</span> <span class="ex">Permissions</span><span class="op">)</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>enum <span class="ex">Permissions</span> <span class="op">{</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> User</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> Moderator</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Written in mathematical notation, this is</p>
    <p>これを数学的に表記すると次のようになる。</p>
    <p><span class="math display"><em>P</em><em>e</em><em>r</em><em>s</em><em>o</em><em>n</em> = <em>S</em><em>t</em><em>r</em><em>i</em><em>n</em><em>g</em> × <em>P</em><em>e</em><em>r</em><em>m</em><em>i</em><em>s</em><em>s</em><em>i</em><em>o</em><em>n</em><em>s</em></span>
    <span class="math display"><em>P</em><em>e</em><em>r</em><em>m</em><em>i</em><em>s</em><em>s</em><em>i</em><em>o</em><em>n</em><em>s</em> = <em>U</em><em>s</em><em>e</em><em>r</em> + <em>M</em><em>o</em><em>d</em><em>e</em><em>r</em><em>a</em><em>t</em><em>o</em><em>r</em></span></p>
    <p>Performing substitution gets us</p>
    <p><code>Permissions</code>
    をその定義に置き換えると次のようになり、</p>
    <p><span class="math display"><em>P</em><em>e</em><em>r</em><em>s</em><em>o</em><em>n</em> = <em>S</em><em>t</em><em>r</em><em>i</em><em>n</em><em>g</em> × (<em>U</em><em>s</em><em>e</em><em>r</em>+<em>M</em><em>o</em><em>d</em><em>e</em><em>r</em><em>a</em><em>t</em><em>o</em><em>r</em>)</span></p>
    <p>Applying distribution results in</p>
    <p>さらに分配法則を適用すると結果は次のようになる。</p>
    <p><span class="math display"><em>P</em><em>e</em><em>r</em><em>s</em><em>o</em><em>n</em> = (<em>S</em><em>t</em><em>r</em><em>i</em><em>n</em><em>g</em>×<em>U</em><em>s</em><em>e</em><em>r</em>) + (<em>S</em><em>t</em><em>r</em><em>i</em><em>n</em><em>g</em>×<em>M</em><em>o</em><em>d</em><em>e</em><em>r</em><em>a</em><em>t</em><em>o</em><em>r</em>)</span></p>
    <p>which in Scala we can represent as</p>
    <p>これはScalaでは次のように表現される。</p>
    <div class="sourceCode" id="cb92"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>enum Person <span class="op">{</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">User</span><span class="op">(</span>name<span class="op">:</span> <span class="ex">String</span><span class="op">)</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Moderator</span><span class="op">(</span>name<span class="op">:</span> <span class="ex">String</span><span class="op">)</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Is this representation more useful? I can’t say without the
    context of where the data is being used. However I can say that
    knowing this manipulation is possible, and correct, is useful.</p>
    <p>これが元の定義よりも有用かどうかは、データがどういうコンテキストで使われるのか分からなければ何とも言えないが、このような操作が可能であり、正しいものであり、役に立つことは間違いないだろう。</p>
    <p>There is a lot more that could be said about algebraic data
    types, but at this point I feel we’re really getting into the weeds.
    I’ll finish up with a few pointers to other interesting facts:</p>
    <p>代数的データ型について言えることは他にもたくさんあるが、やや深入りしすぎてしまったようである。最後にいくつか興味深いトピックを簡単に紹介して締めくくりたい。</p>
    <ul>
    <li><p>Exponential types exist. They are functions! A function
    <code>A =&gt; B</code> is equivalent to <span class="math inline"><em>b</em><sup><em>a</em></sup></span>.</p></li>
    <li><p>Quotient types also exist, but they are a bit weird. Read up
    about them if you’re interested.</p></li>
    <li><p>Another interesting algebraic manipulation is taking the
    derivative of an algebraic data type. This gives us a kind of
    iterator, known as a zipper, for that type.</p></li>
    <li><p>指数型というものが存在する。それは関数である。関数
    <code>A =&gt; B</code> は、数学的に <span class="math inline"><em>b</em><sup><em>a</em></sup></span>
    に相当する</p></li>
    <li><p>商型も存在するが、少し変わっている。興味があれば調べてみてほしい</p></li>
    <li><p>もうひとつの興味深い代数的操作として、代数的データ型の微分がある。これにより、その型に対するイテレータの一種である
    zipper が得られる</p></li>
    </ul>
    <h2 data-number="2.6" id="conclusions"><span class="header-section-number">2.6</span> Conclusions</h2>
    <p>We have covered a lot of material in this chapter. Let’s recap
    the key points.</p>
    <p>この章では多くの内容を扱った。ここで重要なポイントを振り返っておこう。</p>
    <p>Algebraic data types allow us to express data types by combining
    existing data types with logical and and logical or. A logical and
    constructs a product type while a logical or constructs a sum type.
    Algebraic data types are the main way to represent data in
    Scala.</p>
    <p>代数的データ型は、既存の型を論理積と論理和で組み合わせることによって作られるデータ型でである。論理積は直積型を構築し、論理和は直和型を構築する。代数的データ型はScalaでデータを表現する主要な方法である。</p>
    <p>Structural recursion gives us a skeleton for transforming any
    given algebraic data type into any other type. Structural recursion
    can be abstracted into a <code>fold</code> method.</p>
    <p>構造的再帰は、与えられた代数的データ型を他の任意の型に変換するための骨組みを提供する。構造的再帰は
    <code>fold</code> メソッドとして抽象化することができる。</p>
    <p>We use several reasoning principles to help us complete the
    problem specific parts of a structural recursion:</p>
    <p>構造的再帰において問題固有の部分を完成させる助けとなる考え方の原則がいくつかある。</p>
    <ol type="1">
    <li><p>reasoning independently by case;</p></li>
    <li><p>assuming recursion is correct; and</p></li>
    <li><p>following the types.</p></li>
    <li><p>各ケースを独立して推論すること</p></li>
    <li><p>再帰呼び出しの結果は正しいと仮定すること</p></li>
    <li><p>型に従うこと</p></li>
    </ol>
    <p>Following the types is a very general strategy that is can be
    used in many other situations.</p>
    <p>型に従うことは他の多くの状況で利用できる極めて汎用的な戦略である。</p>
    <p>Structural corecursion gives us a skeleton for creating any given
    algebraic data type from any other type. Structural corecursion can
    be abstracted into an <code>unfold</code> method. When reasoning
    about structural corecursion we can reason as we would for an
    imperative loop, or, if the input is an algebraic data type, use the
    principles for reasoning about structural recursion.</p>
    <p>構造的余再帰は、任意の型から代数的データ型を作成するための骨組みを提供する。構造的余再帰は
    <code>unfold</code>
    メソッドとして抽象化できる。構造的余再帰について推論する際は、命令型のループの処理手順を考えるのと同じように進めるか、あるいは入力が代数的データ型である場合は、構造的再帰についての推論の原則を利用することができる。</p>
    <p>Notice that the two main themes of functional
    programming—composition and reasoning—are both already apparent.
    Algebraic data types are compositional: we compose algebraic data
    types using sum and product. We’ve seen many reasoning principles in
    this chapter.</p>
    <p>関数型プログラミングの二つの主要なテーマである合成と推論がすでにはっきり認識できる形で示されている点に注目してほしい。代数的データ型は合成的である。私たちは直和型と直積型を使って代数的データ型を合成する。また、この章では多くの推論原則も見てきた。</p>
    <p>I haven’t covered everything there is to know about algebraic
    data types; I think doing so would be a book in its own right. Below
    are some references that you might find useful if you want to dig in
    further, as well as some biographical remarks.</p>
    <p>代数的データ型について知っておくべきすべてのことを説明したわけではない。これを完全に網羅すれば、それだけで一冊の本になるだろう。さらに掘り下げたい場合に役立つ参考文献や、著者の経歴に関するいくつかの補足を以下に示しておく。</p>
    <p>Algebraic data types are standard in introductory material on
    functional programming. Structural recursion is certainly extremely
    common in functional programming, but strangely seems to rarely be
    explicitly defined as I’ve done here. I learned about both from
    <em>How to Design Programs</em> <span class="citation" data-cites="felleisen18:htdp">[Felleisen et al. 2018]</span>.</p>
    <p>代数的データ型は、関数型プログラミングの入門資料では標準的に取り扱われている。構造的再帰も関数型プログラミングで非常によく使われるが、ここで私が行ったように明確に定義されることは珍しいようである。私はこれらの概念を
    <em>How to Design Programs</em> <span class="citation" data-cites="felleisen18:htdp">[Felleisen et al. 2018]</span>
    から学んだ。</p>
    <p>I’m not aware of any approachable yet thorough treatment of
    either algebraic data types or structural recursion. Both seem to
    have become assumed background of any researcher in the field of
    programming languages, and relatively recent work is caked in layers
    of mathematics and obtuse notation that I find difficult reading.
    The infamous <em>Functional Programming with Bananas, Lenses,
    Envelopes and Barbed Wire</em> <span class="citation" data-cites="10.1007/3540543961_7">[Meijer et al. 1991]</span> is an
    example of such work. I suspect the core ideas of both date back to
    at least the emergence of computability theory in the 1930s, well
    before any digital computers existed.</p>
    <p>代数的データ型や構造的再帰について、手軽にアクセスできつつも詳細に扱った資料は私の知る限り存在しない。これらの概念は、プログラミング言語研究の分野ではもはや前提知識とされているようで、最近の研究は数学的で難解な表記に覆われており、私にとっては読みづらいものが多い。悪名高い
    <em>Functional Programming with Bananas, Lenses, Envelopes and
    Barbed Wire</em> <span class="citation" data-cites="10.1007/3540543961_7">[Meijer et al. 1991]</span>
    はその一例である。両アイデアの核となる発想は、少なくとも計算可能性理論が登場した1930年代、デジタルコンピュータが存在するはるか以前にまで遡るのではないかと思われる。</p>
    <p>The earliest reference I’ve found to structural recursion is
    <em>Proving Properties of Programs by Structural Induction</em>
    <span class="citation" data-cites="10.1093/comjnl/12.1.41">[Burstall
    1969]</span>. Algebraic data types don’t seem to have been fully
    developed, along with pattern matching, until <a href="https://en.wikipedia.org/wiki/NPL_(programming_language)">NPL</a>
    in 1977. NPL was quickly followed by the more influential language
    <a href="https://en.wikipedia.org/wiki/Hope_(programming_language)">Hope</a>,
    which spread the concept to other programming languages.</p>
    <p>構造的再帰に関する最も古い参考文献として私が見つけたのは、<em>Proving
    Properties of Programs by Structural Induction</em> <span class="citation" data-cites="10.1093/comjnl/12.1.41">[Burstall
    1969]</span>
    である。代数的データ型とパターンマッチングの発展は、1977年の <a href="https://en.wikipedia.org/wiki/NPL_(programming_language)">NPL</a>
    までは完全ではなかったようだが、その後すぐに、より影響力のある言語である
    <a href="https://en.wikipedia.org/wiki/Hope_(programming_language)">Hope</a>
    が登場し、この概念が他のプログラミング言語にも広まった。</p>
    <p>Corecursion is a bit better documented in the contemporary
    literature. <em>How to Design Co-Programs</em> <span class="citation" data-cites="GIBBONS_2021">[Gibbons 2021]</span>
    covers the main ideas we have looked at here, while <span class="citation" data-cites="10.1145/291251.289455">Gibbons and
    Jones [1998]</span> discusses uses of <code>unfold</code>.</p>
    <p>余再帰については現代の文献ですこしくわしく記録されている。<em>How
    to Design Co-Programs</em> <span class="citation" data-cites="GIBBONS_2021">[Gibbons 2021]</span>
    では、ここで取り上げた主なアイデアが説明されているし、<span class="citation" data-cites="10.1145/291251.289455">[Gibbons and
    Jones 1998]</span> では <code>unfold</code>
    の使い方について議論されている。</p>
    <p><em>The Derivative of a Regular Type is its Type of One-Hole
    Contexts</em> <span class="citation" data-cites="mcbride01:deriv">[McBride 2001]</span> describes the
    derivative of algebraic data types.</p>
    <p><em>The Derivative of a Regular Type is its Type of One-Hole
    Contexts</em> <span class="citation" data-cites="mcbride01:deriv">[McBride 2001]</span>
    は代数的データ型の微分について記述している。</p>
    <h1 data-number="3" id="sec:codata"><span class="header-section-number">3</span>
    余データとしてのオブジェクト</h1>
    <p>In this chapter we will look at <strong>codata</strong>, the dual
    of algebraic data types. Algebraic data types focus on how things
    are constructed. Codata, in contrast, focuses on how things are
    used. We define codata by specifying the operations that can be
    performed on the type. This is very similar to the use of interfaces
    in object-oriented programming, and this is the first reason that we
    are interested in codata: codata puts object-oriented programming
    into a coherent conceptual framework with the other strategies we
    are discussing.</p>
    <p>この章では、代数的データ型の双対である余データについて見ていく。代数的データ型はモノがどのように構築されるかに焦点を当てているが、それに対して余データはモノの利用方法に焦点を当てている。余データは、型に対して実行できる操作を指定することで定義される。これはオブジェクト指向プログラミングにおけるインターフェースの使い方と非常に似ており、これが余データに注目する理由のひとつである。オブジェクト指向プログラミングは、余データという概念によって、私たちが今議論している戦略と整合性のある概念的枠組みの中に位置づけられる。</p>
    <p>We’re not only interested in codata as a lens to view
    object-oriented programming. Codata also has properties that
    algebraic data does not. Codata allows us to create structures with
    an infinite number of elements, such as a list that never ends or a
    server loop that runs indefinitely. Codata has a different form of
    extensibility to algebraic data. Whereas we can easily write new
    functions that transform algebraic data, we cannot add new cases to
    the definition of an algebraic data type without changing the
    existing code. The reverse is true for codata. We can easily create
    new implementations of codata, but functions that transform codata
    are limited by the interface the codata defines.</p>
    <p>しかし、余データに注目するのはオブジェクト指向プログラミングを捉えるためだけではない。余データには、代数的データにはない特性がある。たとえば、余データを使うことで、無限の要素を持つ構造、終わりのないリストや永遠に実行されるサーバーループのようなものを作成することができる。また、余データは拡張性の点でも代数的データとは異なる形をもっている。代数的データ型では、新しい変換関数を簡単に作成できるが、新しいケースを定義に追加するには既存のコードを変更する必要があります。余データはその逆で、新しい実装を簡単に作成できるが、余データを変換する関数は余データが定義するインターフェースに制約される。</p>
    <p>In the previous chapter we saw structural recursion and
    structural corecursion as strategies to guide us in writing programs
    using algebraic data types. The same holds for codata. We can use
    codata forms of structural recursion and corecursion to guide us in
    writing programs that consume and produce codata respectively.</p>
    <p>前章では、代数的データ型を使用してプログラムを記述するための戦略として、構造的再帰と構造的余再帰を取り上げた。余データについても同様で、余データを消費するプログラムを書く際には構造的再帰を、余データを生成するプログラムを書く際には構造的余再帰を使用することができる。</p>
    <p>We’ll begin our exploration of codata by more precisely defining
    it and seeing some examples. We’ll then talk about representing
    codata in Scala, and the relationship to object-oriented
    programming. Once we can create codata, we’ll see how to work with
    it using structural recursion and corecursion, using an example of
    an infinite structure. Next we will look at transforming algebraic
    data to codata, and vice versa. We will finish by examining
    differences in extensibility.</p>
    <p>まず、余データをより正確に定義し、いくつかの例を見ていこうと思う。次に、Scalaにおける余データの表現方法とオブジェクト指向プログラミングとの関係について説明する。余データの作成方法を理解した後は、無限構造の例を使って、構造的再帰や構造的余再帰を用いた余データの操作方法を学ぶ。その後、代数的データ型と余データの相互変換について考察し、最後に拡張性の違いを検証する。</p>
    <p>A quick note about terminology before we proceed. We might expect
    to use the term algebraic codata for the dual of algebraic data, but
    conventionally just codata is used. I assume this is because data is
    usually understood to have a wider meaning than just algebraic data,
    but codata is not used outside of programming language theory. For
    simplicity and symmetry, within this chapter I’ll just use the term
    data to refer to algebraic data types.</p>
    <p>進める前に用語について簡単に触れておきたい。代数的データの双対としては「代数的余データ」という用語を期待されるかもしれないが、慣例的に単に「余データ」という用語が使われる。これは、データという言葉が、一般的に代数的データに限定されず、より広い意味を持つのに対して、余データはプログラミング言語理論の外では使われないからだと考えられる。この章では、簡潔さと対称性のために、代数的データ型を指す際に「データ」という用語を使用する。</p>
    <h2 data-number="3.1" id="データと余データ"><span class="header-section-number">3.1</span> データと余データ</h2>
    <p>Data describes what things are, while codata describes what
    things can do.</p>
    <p>データはモノが何であるのかを記述し、余データはモノが何をすることができるかを記述する。</p>
    <p>We have seen that data is defined in terms of constructors
    producing elements of the data type. Let’s take a very simple
    example: a <code>Bool</code> is either <code>True</code> or
    <code>False</code>. We know we can represent this in Scala as</p>
    <p>これまで、データは、そのデータ型の直和型バリアントを生成するコンストラクタによって定義されることを見てきた。非常に単純な例として、<code>Bool</code>
    は <code>True</code> または <code>False</code>
    のいずれかで、Scalaでは次のように表現できる。</p>
    <div class="sourceCode" id="cb93"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>enum Bool <span class="op">{</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> True</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> False</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>The definition tells us there are two ways to construct an
    element of type <code>Bool</code>. Furthermore, if we have such an
    element we can tell exactly which case it is, by using a pattern
    match for example. Similarly, if the instances themselves hold data,
    as in <code>List</code> for example, we can always extract all the
    data within them. Again, we can use pattern matching to achieve
    this.</p>
    <p>この定義は、<code>Bool</code>
    型の値を構築する方法が二つあることを示している。さらに、そのような直和型バリアントがあるときに、たとえばパターンマッチを使用することで、正確にどちらのケースであるかを判断することができる。同様に、たとえば
    <code>List</code>
    のようにインスタンス自体がデータを保持している場合、その中のすべてのデータを取り出すことが常に可能である。ここでも、パターンマッチを使用してこれを実現することができる。</p>
    <p>Codata, in contrast, is defined in terms of operations we can
    perform on the elements of the type. These operations are sometimes
    called <strong>destructors</strong> (which we’ve already
    encountered), <strong>observations</strong>, or
    <strong>eliminators</strong>. A common example of codata is a data
    structures such as a set. We might define the operations on a
    <code>Set</code> with elements of type <code>A</code> as:</p>
    <p>対照的に、余データは、その型の値に対して行える操作によって定義される。これらの操作は、<strong>デストラクタ（destructor）</strong>（既出）、<strong>観察（observation）</strong>、または<strong>エリミネータ（eliminator）</strong>と呼ばれることがある。余データの一般的な例として、集合のようなデータ構造がある。たとえば、
    <code>A</code> 型の要素をもつ <code>Set</code>
    の操作は次のように定義できる。</p>
    <ul>
    <li><code>contains</code> which takes a <code>Set[A]</code> and an
    element <code>A</code> and returns a <code>Boolean</code> indicating
    if the set contains the element;</li>
    <li><code>insert</code> which takes a <code>Set[A]</code> and an
    element <code>A</code> and returns a <code>Set[A]</code> containing
    all the elements from the original set and the new element; and</li>
    <li><code>union</code> which takes a <code>Set[A]</code> and a set
    <code>Set[A]</code> and returns a <code>Set[A]</code> containing all
    the elements of both sets.</li>
    </ul>
    <p><code>contains</code>: <code>Set[A]</code> と要素 <code>A</code>
    を受け取り、集合にその要素が含まれているかどうかを示す
    <code>Boolean</code> を返す <code>insert</code>: <code>Set[A]</code>
    と要素 <code>A</code>
    を受け取り、元の集合のすべての要素と新しい要素を含む
    <code>Set[A]</code> を返す <code>union</code>: <code>Set[A]</code>
    ともうひとつの集合 <code>Set[A]</code>
    を受け取り、両方の集合のすべての要素を含む <code>Set[A]</code>
    を返す</p>
    <p>In Scala we could implement this definition as</p>
    <p>Scalaではこの定義を次のように記述できる。</p>
    <div class="sourceCode" id="cb94"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">/**</span> <span class="co">与えられた要素がこの集合に含まれていれば</span>True <span class="co">*/</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">contains</span><span class="op">(</span>elt<span class="op">:</span> A<span class="op">):</span> <span class="ex">Boolean</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">/**</span> <span class="co">この集合のすべての要素と与えられた要素を含む新しい集合を構築する</span> <span class="co">*/</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">insert</span><span class="op">(</span>elt<span class="op">:</span> A<span class="op">):</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">/**</span> Construct the union of this and that set <span class="co">*/</span></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">/**</span> <span class="co">この集合と指定された集合の和集合を構築する</span> <span class="co">*/</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">union</span><span class="op">(</span>that<span class="op">:</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]):</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>This definition does not tell us anything about the internal
    representation of the elements in the set. It could use a hash
    table, a tree, or something more exotic. It does, however, tell us
    what we can do with the set. We know we can take the union but not
    the intersection, for example.</p>
    <p>この定義は、集合内の要素が内部的にどのように表現されているかついて何も述べていない。ハッシュテーブルが使われるかもしれないし、木構造やあるいはもっと特殊な何かが使われるかもしれない。だが、集合に対してどういう操作が可能であるかをこの定義は教えてくれる。たとえば、和集合を取ることはできても、積集合をとることはできない、ということは分かるのである。</p>
    <p>If you come from the object-oriented world you might recognize
    the description of codata above as programming to an interface. In
    some ways codata is just taking concepts from the object-oriented
    world and presenting them in a way that is consistent with the rest
    of the functional programming paradigm. However, this does not mean
    adopting all the features of object-oriented programming. We won’t
    use state, which is difficult to reason about. We also won’t use
    implementation inheritance either, for the same reason. In our
    subset of object-oriented programming we’ll either be defining
    interfaces (which may have default implementations of some methods)
    or final classes that implement those interfaces. Interestingly,
    this subset of object-oriented programming is often recommended by
    advocates of object-oriented programming.</p>
    <p>オブジェクト指向の世界から来た人であれば、前述の余データの説明をインターフェースを利用したプログラミングと認識するかもしれない。ある意味、余データとはオブジェクト指向の世界から概念を取り入れ、それを関数型プログラミングのパラダイムと一貫した形で提示するものと言える。しかし、これはオブジェクト指向プログラミングのすべての機能を採用するという意味ではない。私たちは、推論の難しい状態を使用しないし、同じ理由で実装の継承も使わない。私たちのオブジェクト指向プログラミングのサブセットでは、インターフェースを定義し（いくつかのメソッドにデフォルト実装を持たせてもよい）、そのインターフェースを実装するfinalクラスを定義する。興味深いことに、このようなオブジェクト指向プログラミングのサブセットは、オブジェクト指向プログラミングの支持者によってもしばしば勧められている。</p>
    <p>Let’s now be a little more precise in our definition of codata,
    which will make the duality between data and codata clearer.
    Remember the definition of data: it is defined in terms of sums
    (logical ors) and products (logical ands). We can transform any data
    into a sum of products. Each product in the sum is a constructor,
    and the product itself is the parameters that the constructor
    accepts. Finally, we can think of constructors as functions which
    take some arbitrary input and produce an element of data. Our end
    point is a sum of functions from arbitrary input to data.</p>
    <p>それでは、余データをもうすこし正確に定義していこう。そうすることで、データと余データの双対性がより明確になるはずである。データの定義を思い出してほしい。データは論理和と論理積を使って定義される。我々は、任意のデータを「積の和」として表現することができる。この和の中の各積がコンストラクタであり、積を構成する各要素がコンストラクタの受け取るパラメータとなる。コンストラクタは任意の入力を受け取りデータの直和型バリアントを生成する関数と考えることができ、最終的な形は、任意の入力からデータを生成する関数の直和となる。</p>
    <p>More abstractly, if we are constructing an element of some data
    type <code>A</code> we call one of the constructors</p>
    <p>より抽象的に言うと、あるデータ型 <code>A</code>
    の値を構築するときは、複数あるコンストラクタのうちのひとつを呼び出す。</p>
    <ul>
    <li><p><code>A1: (B, C, ...) =&gt; A</code>; or</p></li>
    <li><p><code>A2: (D, E, ...) =&gt; A</code>; or</p></li>
    <li><p><code>A3: (F, G, ...) =&gt; A</code>; and so on.</p></li>
    <li><p><code>A1: (B, C, ...) =&gt; A</code> または</p></li>
    <li><p><code>A2: (D, E, ...) =&gt; A</code> または</p></li>
    <li><p><code>A3: (F, G, ...) =&gt; A</code> など</p></li>
    </ul>
    <p>Now we’ll turn to codata. Codata is defined as a product of
    functions, these functions being the destructors. The input to a
    destructor is always an element of the codata type and possibly some
    other parameters. The output is usually something that is not of the
    codata type. Thus constructing an element of some codata type
    <code>A</code> means defining</p>
    <p>一方、余データは関数の積として定義される。これらの関数はデストラクタである。デストラクタへの入力には常に余データ型が含まれ、場合によって他のパラメータも存在する。出力は通常、余データ型ではない何かになる。したがって、余データ型
    <code>A</code>
    の要素を構築するということは、以下のような定義を意味する。</p>
    <ul>
    <li><code>A1: (A, B, ...) =&gt; C</code> および</li>
    <li><code>A2: (A, D, ...) =&gt; E</code> および</li>
    <li><code>A3: (A, F, ...) =&gt; G</code> など</li>
    </ul>
    <p>This hopefully makes the duality between the two clearer. Now we
    understand what codata is, we will turn to representing codata in
    Scala.</p>
    <p>これで、両者の双対性がより明確になることを期待したい。余データが何であるかは理解できたので、次にScalaにおける余データの表現に移ろう。</p>
    <h2 data-number="3.2" id="codata-in-scala"><span class="header-section-number">3.2</span> Codata in Scala</h2>
    <p>We have already seen an example of codata, which I have repeated
    below.</p>
    <p>前節で見た余データの例を以下に再掲する。</p>
    <div class="sourceCode" id="cb95"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">contains</span><span class="op">(</span>elt<span class="op">:</span> A<span class="op">):</span> <span class="ex">Boolean</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">insert</span><span class="op">(</span>elt<span class="op">:</span> A<span class="op">):</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">union</span><span class="op">(</span>that<span class="op">:</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]):</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>The abstract definition of this, which is a product of functions,
    defines a <code>Set</code> with elements of type <code>A</code>
    as:</p>
    <p>関数の関数の集まりであるこの抽象的な定義は、<code>A</code>
    型の要素をもつ <code>Set</code>
    を次のような操作をもつものであると示している。</p>
    <ul>
    <li><code>Set[A]</code> と <code>A</code>
    型の要素を受け取り、<code>Boolean</code> を返す関数
    <code>contains</code></li>
    <li><code>Set[A]</code> と <code>A</code>
    型の要素を受け取り、<code>Set[A]</code> を返す関数
    <code>insert</code></li>
    <li><code>Set[A]</code> ともうひとつの <code>Set[A]</code>
    を受け取り、<code>Set[A]</code> を返す関数 <code>union</code></li>
    </ul>
    <p>Notice that the first parameter of each function is the type we
    are defining, <code>Set[A]</code>.</p>
    <p>どの関数も最初のパラメータの型は <code>Set[A]</code>
    である点に注目してほしい。</p>
    <p>The translation to Scala is:</p>
    <p>Scalaに翻訳する際は以下のようになり、</p>
    <ul>
    <li><p>the overall type becomes a <code>trait</code>; and</p></li>
    <li><p>each function becomes a method on that <code>trait</code>.
    The first parameter is the hidden <code>this</code> parameter, and
    other parameters become normal parameters to the method.</p></li>
    <li><p>全体の型を <code>trait</code> とする</p></li>
    <li><p>各関数をそのトレイトのメソッドとして、最初のパラメータの代わりに
    <code>this</code>
    を用い、残りをそのメソッドの普通のパラメータとする</p></li>
    </ul>
    <p>This gives us the Scala representation we started with.</p>
    <p>これにより、上に再掲したScalaの表現が得られる。</p>
    <p>This is only half the story for codata. We also need to actually
    implement the interface we’ve just defined. There are three
    approaches we can use:</p>
    <p>以上は余データに関する話の半分に過ぎない。先ほど定義したインターフェースを実際に実装する必要がある。実装のアプローチは三つある。</p>
    <ol type="1">
    <li><p>a <code>final</code> subclass, in the case where we want to
    name the implementation;</p></li>
    <li><p>an anonymous subclass; or</p></li>
    <li><p>more rarely, an <code>object</code>.</p></li>
    <li><p><code>final</code>
    サブクラス。これは実装に名前を付けたい場合に用いる</p></li>
    <li><p>匿名のサブクラス</p></li>
    <li><p>稀なケースだが、<code>object</code></p></li>
    </ol>
    <p>Neither <code>final</code> nor anonymous subclasses can be
    further extended, meaning we cannot create deep inheritance
    hierarchies. This in turn avoids the difficulties that come from
    reasoning about deep hierarchies. Using a <code>class</code> rather
    than a <code>case class</code> means we don’t expose implementation
    details like constructor arguments.</p>
    <p><code>final</code>
    サブクラスも匿名サブクラスもそれ以上拡張できないため、深い継承階層を作成することはできない。これにより、深い階層について推論する際に生じる困難を回避できる。また、<code>case class</code>
    ではなく <code>class</code>
    を使用することで、コンストラクタ引数などの実装の詳細を公開せずにすむ。</p>
    <p>Some examples are in order. Here’s a simple example of
    <code>Set</code>, which uses a <code>List</code> to hold the
    elements in the set.</p>
    <p>いくつか例を挙げるのがよいだろう。ここでは、集合の要素を保持する実装として
    <code>List</code> を使用する <code>Set</code> の単純な例を示す。</p>
    <div class="sourceCode" id="cb96"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="kw">class</span> ListSet<span class="op">[</span>A<span class="op">](</span>elements<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">])</span> <span class="kw">extends</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">contains</span><span class="op">(</span>elt<span class="op">:</span> A<span class="op">):</span> <span class="ex">Boolean</span> <span class="op">=</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>    elements<span class="op">.</span><span class="fu">contains</span><span class="op">(</span>elt<span class="op">)</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">insert</span><span class="op">(</span>elt<span class="op">:</span> A<span class="op">):</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ListSet</span><span class="op">(</span>elt <span class="op">::</span> elements<span class="op">)</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">union</span><span class="op">(</span>that<span class="op">:</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]):</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>    elements<span class="op">.</span><span class="fu">foldLeft</span><span class="op">(</span>that<span class="op">)</span> <span class="op">{</span> <span class="op">(</span>set<span class="op">,</span> elt<span class="op">)</span> <span class="op">=&gt;</span> set<span class="op">.</span><span class="fu">insert</span><span class="op">(</span>elt<span class="op">)</span> <span class="op">}</span></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> ListSet <span class="op">{</span></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> empty<span class="op">[</span>A<span class="op">]:</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> <span class="fu">ListSet</span><span class="op">(</span><span class="ex">List</span><span class="op">.</span>empty<span class="op">)</span></span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>This uses the first implementation approach, a <code>final</code>
    subclass. Where would we use an anonymous subclass? They are most
    useful when implementing methods that return our codata type. Let’s
    take <code>union</code> as an example. It returns our codata type,
    <code>Set</code>, and we could implement it as shown below.</p>
    <p>この例ではひとつ目の実装アプローチとして紹介した
    <code>final</code>
    サブクラスを用いている。余データ型を返すメソッドを実装するときに最も便利なのが匿名サブクラスである。<code>union</code>
    メソッドを例に考えてみよう。このメソッドは余データ自体の型である
    <code>Set</code>
    を返す。これは以下のように実装することができる。</p>
    <div class="sourceCode" id="cb97"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">contains</span><span class="op">(</span>elt<span class="op">:</span> A<span class="op">):</span> <span class="ex">Boolean</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">insert</span><span class="op">(</span>elt<span class="op">:</span> A<span class="op">):</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">union</span><span class="op">(</span>that<span class="op">:</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]):</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> self <span class="op">=</span> <span class="kw">this</span></span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> <span class="fu">contains</span><span class="op">(</span>elt<span class="op">:</span> A<span class="op">):</span> <span class="ex">Boolean</span> <span class="op">=</span></span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>        self<span class="op">.</span><span class="fu">contains</span><span class="op">(</span>elt<span class="op">)</span> <span class="op">||</span> that<span class="op">.</span><span class="fu">contains</span><span class="op">(</span>elt<span class="op">)</span></span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> <span class="fu">insert</span><span class="op">(</span>elt<span class="op">:</span> A<span class="op">):</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Arbitrary choice to insert into self</span></span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>        self<span class="op">.</span><span class="fu">insert</span><span class="op">(</span>elt<span class="op">).</span><span class="fu">union</span><span class="op">(</span>that<span class="op">)</span></span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>This uses an anonymous subclass to implement <code>union</code>
    on the <code>Set</code> trait, and hence defines the method for all
    subclasses. I haven’t made the method <code>final</code> so that
    subclasses can override it with a more efficient implementation.
    This does open up the danger of implementation inheritance. This is
    an example of where theory and craft diverge. In theory we never
    want implementation inheritance, but in practice it can be useful as
    an optimization.</p>
    <p>この例では、匿名サブクラスを使用し、<code>Set</code> トレイト上で
    <code>union</code>
    メソッドを実装している。この定義はすべてのサブクラスで利用可能である。メソッドを
    <code>final</code>
    にしていないのは、サブクラスがより効率的な実装でそれをオーバーライドできるようにするためであるが、これにより、実装の継承に伴う危険性が生じる。これは理論と実践が乖離する一例である。理論上、実装継承は好まれないが、実際には最適化として有用である場合がある。</p>
    <p>It can also be useful to implement utility methods defined purely
    in terms of the destructors. Let’s say we wanted to implement a
    method <code>containsAll</code> that checks if a <code>Set</code>
    <code>contains</code> all the elements in an <code>Iterable</code>
    collection.</p>
    <p>デストラクタのみを用いて定義されたユーティリティメソッドを実装することも有用である。たとえば、<code>Set</code>
    が <code>Iterable</code> コレクション内のすべての要素を
    <code>contains</code> しているかを確認する <code>containsAll</code>
    メソッドを実装したいとする。</p>
    <div class="sourceCode" id="cb98"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">containsAll</span><span class="op">(</span>elements<span class="op">:</span> <span class="ex">Iterable</span><span class="op">[</span>A<span class="op">]):</span> <span class="ex">Boolean</span></span></code></pre></div>
    <p>We can implement this purely in terms of <code>contains</code> on
    <code>Set</code> and <code>forall</code> on
    <code>Iterable</code>.</p>
    <div class="sourceCode" id="cb99"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">contains</span><span class="op">(</span>elt<span class="op">:</span> A<span class="op">):</span> <span class="ex">Boolean</span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">insert</span><span class="op">(</span>elt<span class="op">:</span> A<span class="op">):</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">union</span><span class="op">(</span>that<span class="op">:</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]):</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span></span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">containsAll</span><span class="op">(</span>elements<span class="op">:</span> <span class="ex">Iterable</span><span class="op">[</span>A<span class="op">]):</span> <span class="ex">Boolean</span> <span class="op">=</span></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>    elements<span class="op">.</span><span class="fu">forall</span><span class="op">(</span>elt <span class="op">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">contains</span><span class="op">(</span>elt<span class="op">))</span></span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Once again we could make this a <code>final</code> method. In
    this case it’s probably more justified as it’s difficult to imagine
    a more efficient implementation.</p>
    <p>ここでも、メソッドを <code>final</code>
    にするという選択肢がある。このケースでは、より効率的な実装を想像するのは難しいため、<code>final</code>
    にすることがより正当化される。</p>
    <p>Data and codata are both realized in Scala as variations of the
    same language features of classes and objects. This means we can
    define types that have properties of both data and codata. We have
    actually already done this. When we define data we must define names
    for the fields within the data, thus defining destructors. This is
    the same in most languages, which don’t make a hard distinction
    between data and codata.</p>
    <p>データと余データは、Scalaにおいてクラスとオブジェクトという同じ言語機能の変種として実現されている。これは、データと余データ両方の特性をもつ型を定義できることを意味する。実際、我々はすでにこれを行っている。データを定義する際には、データ内のフィールドの名前を定義しなければならず、それによってデストラクタが定義される。これは、データと余データの間に明確な区別を設けていないほとんどの言語と同じである。</p>
    <!-- TODO:
    「それによってデストラクタが定義される」はおそらくcase classの仕様を前提としている
    そのことについて補足的な訳文にするか、訳注をつけるか、したほうがよいかもしれない
    -->
    <p>Part of the appeal, I think, of classes and objects is that they
    can express so many conceptually different abstractions with the
    same language constructs. This gives them a surface appearance of
    simplicity; it seems we need to learn only one abstraction to solve
    a huge of number of coding problems. However this apparent
    simplicity hides real complexity, as this variety of uses forces us
    to reverse engineer the conceptual intention from the code.</p>
    <p>クラスとオブジェクトの魅力の一部は、同じ言語構造を用いて非常に多くの概念的に異なる抽象を表現できる点にあると考えている。このことは、クラスやオブジェクトを表面的には単純に見せ、ひとつの抽象さえ学べば多くのコーディングに関する問題を解決できるかのように感じさせる。だが、この見かけ上の単純さは実際の複雑さを隠している。同じ言語構造がさまざまな用途に使われるせいで、コードから概念的な意図を逆解析する必要が生じるのである。</p>
    <h2 data-number="3.3" id="余データの構造的再帰と余再帰"><span class="header-section-number">3.3</span>
    余データの構造的再帰と余再帰</h2>
    <p>In this section we’ll build a library for streams, also known as
    lazy lists. These are the codata equivalent of lists. Whereas a list
    must have a finite length, streams have an infinite length. We’ll
    use this example to explore structural recursion and structural
    corecursion as applied to codata.</p>
    <p>この節ではストリームあるいは遅延リストとして知られるライブラリを作成する。これらはリストの余データに相当する。リストの長さが有限でなくてはならないのに対して、ストリームは無限の長さをもっている。この例を用いて、余データに適用される構造的再帰と構造的余再帰について考察する。</p>
    <p>Let’s start by reviewing structural recursion and corecursion.
    The key idea is to use the input or output type, respectively, to
    drive the process of writing the method. We’ve already seen how this
    works with data, where we emphasized structural recursion. With
    codata it’s more often the case that structural corecursion is used.
    The steps for using structural corecursion are:</p>
    <p>構造的再帰と構造的余再帰について復習することから始めよう。鍵となるアイデアは、それぞれ入力型または出力型を利用して、メソッドの記述プロセスを</p>
    <p>このセクションでは、構造的再帰と構造的余再帰を復習する。鍵となるアイデアは、それぞれ入力型または出力型を利用してメソッドを考えながら書き進めることである。データにおいて構造的再帰にフォーカスした手法がどのように機能するかは既に見てきた。余データにおいては、構造的余再帰がより頻繁に使用される。構造的余再帰を使用するためのステップは以下の通りである。</p>
    <ol type="1">
    <li><p>recognize the output of the method or function is
    codata;</p></li>
    <li><p>write down the skeleton to construct an instance of the
    codata type, usually using an anonymous subclass; and</p></li>
    <li><p>fill in the methods, using strategies such as structural
    recursion or following the types to help.</p></li>
    <li><p>メソッドまたは関数の出力が余データであることを認識する</p></li>
    <li><p>余データ型のインスタンスを構築する骨組みを記述する。通常は匿名サブクラスを使用する</p></li>
    <li><p>構造的再帰などの戦略を用いるか、型に従って、メソッドの本体を完成させる</p></li>
    </ol>
    <p>It’s important that any computation takes places within the
    methods, and so only runs when the methods are called. Once we start
    creating streams the importance of this will become clear.</p>
    <p>どの計算もメソッド内で行われ、メソッドが呼び出されたときにのみ実行されることが重要である。ストリームを作成し始めると、この重要性が明確になるだろう。</p>
    <p>For structural recursion the steps are:</p>
    <p>構造的再帰の手順は以下の通りである。</p>
    <ol type="1">
    <li><p>recognize the input of the method or function is
    codata;</p></li>
    <li><p>note the codata’s destructors as possible sources of values
    in writing the method; and</p></li>
    <li><p>complete the method, using strategies such as following the
    types or structural corecursion and the methods identified
    above.</p></li>
    <li><p>メソッドまたは関数の入力が余データであることを認識する</p></li>
    <li><p>メソッドを書く際に、余データのデストラクタが値の供給源であることに留意する</p></li>
    <li><p>型に従ったり、構造的余再帰などの戦略を用いたりして、上記で特定したメソッドを使いながらメソッドを完成させる</p></li>
    </ol>
    <!-- TODO: 上記で特定したメソッドとはデストラクタのこと？ -->
    <p>Our first step is to define our stream type. As this is codata,
    it is defined in terms of its destructors. The destructors that
    define a <code>Stream</code> of elements of type <code>A</code>
    are:</p>
    <p>最初のステップはストリーム型を定義することである。ストリームは余データなので、デストラクタの集まりとして定義される。<code>A</code>
    型の要素をもつ <code>Stream</code>
    を定義するデストラクタは以下のとおりである。</p>
    <ul>
    <li><p>a <code>head</code> of type <code>A</code>; and</p></li>
    <li><p>a <code>tail</code> of type <code>Stream[A]</code>.</p></li>
    <li><p><code>A</code> 型の <code>head</code></p></li>
    <li><p><code>Stream[A]</code> 型の <code>tail</code></p></li>
    </ul>
    <p>Note these are almost the destructors of <code>List</code>. We
    haven’t defined <code>isEmpty</code> as a destructor because our
    streams never end and thus this method would always return
    <code>false</code>. (A lot of real implementations, such as the
    <code>LazyList</code> in the Scala standard library, do define such
    a method which allows them to represent finite and infinite lists in
    the same structure. We’re not doing this for simplicity and because
    we want to work with codata in its purest form.)</p>
    <p>これらが <code>List</code>
    のデストラクタとほぼ同じである点に注目しよう。デストラクタとして
    <code>isEmpty</code>
    を定義していないのは、ここで作成しようとしているストリームに終わりがなく、<code>isEmpty</code>
    があったとしてもそれは常に <code>false</code>
    を返すことになるからである。なお、Scala標準ライブラリの
    <code>LasyList</code> など多くの実例において <code>isEmpty</code>
    のようなメソッドが定義されているが、これは、それらが有限と無限両方のリストを表現可能であるという理由による。ここでは、余データを最も端的な形で定義したいので、シンプルさを優先し、そのようなことはしない。</p>
    <p>We can translate this to Scala, as we’ve previously seen, giving
    us</p>
    <p>これをScalaに翻訳すると、これまでに見てきたように、次のようになる。</p>
    <div class="sourceCode" id="cb100"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> head<span class="op">:</span> A</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> tail<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Now we can create an instance of <code>Stream</code>. Let’s
    create a never-ending stream of ones. We will start with the
    skeleton below and apply strategies to complete the code.</p>
    <p>これで、<code>Stream</code>
    インスタンスを作成できる。ここでは、永遠に1という数を返し続けるストリームを作成してみよう。以下の骨組みから始め、コードを完成させるための戦略を適用する。</p>
    <div class="sourceCode" id="cb101"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> ones<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span> <span class="op">???</span></span></code></pre></div>
    <p>The first strategy is structural corecursion. We’re returning an
    instance of codata, so we can insert the skeleton to construct a
    <code>Stream</code>.</p>
    <p>最初の戦略は構造的余再帰である。余データのインスタンスを返したいのだから、
    <code>Stream</code> インスタンスを構築する骨組みを挿入する。</p>
    <div class="sourceCode" id="cb102"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> ones<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> <span class="bu">Stream</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">{</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> head<span class="op">:</span> <span class="bu">Int</span> <span class="op">=</span> <span class="op">???</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> tail<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span> <span class="op">???</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>Here I’ve used the anonymous subclass approach, so I can just
    write all the code in one place.</p>
    <p>ここでは、匿名サブクラスを使うことで、すべてのコードを一か所にまとめて書けるようにしている。</p>
    <p>The next step is to fill in the method bodies. The first method,
    <code>head</code>, is trivial. The answer is <code>1</code> by
    definition.</p>
    <p>次のステップはメソッド本体を埋めることである。最初のメソッドである
    <code>head</code> は簡単で、定義により答えは <code>1</code>
    である。</p>
    <div class="sourceCode" id="cb103"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> ones<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> <span class="bu">Stream</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">{</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> head<span class="op">:</span> <span class="bu">Int</span> <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> tail<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span> <span class="op">???</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>It’s not so obvious what to do with <code>tail</code>. We want to
    return a <code>Stream[Int]</code> so we could apply structural
    corecursion again.</p>
    <p><code>tail</code>
    をどのように実装すればよいかは自明とは言えない。<code>Stream[Int]</code>
    型の値を返したいのだから、もう一度構造的余再帰を適用することが考えられる。</p>
    <div class="sourceCode" id="cb104"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> ones<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> <span class="bu">Stream</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">{</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> head<span class="op">:</span> <span class="bu">Int</span> <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> tail<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">new</span> <span class="bu">Stream</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">{</span></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> head<span class="op">:</span> <span class="bu">Int</span> <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> tail<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span> <span class="op">???</span></span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>This approach doesn’t seem like it’s going to work. We’ll have to
    write this out an infinite number of times to correctly implement
    the method, which might be a problem.</p>
    <p>だが、このアプローチがうまく行くとは思えない。この方法でメソッドを正しく実装するには同じことを無限に書き続けなくてはならない。</p>
    <p>Instead we can follow the types. We need to return a
    <code>Stream[Int]</code>. We have one in scope: <code>ones</code>.
    This is exactly the <code>Stream</code> we need to return: the
    infinite stream of ones!</p>
    <p>代わりに、型に従って考えてみよう。<code>Stream[Int]</code>
    型を返す必要があるが、スコープ内にはその型の変数である
    <code>ones</code>
    がすでに存在する。これこそがまさに、返すべき無限の1のストリームである。</p>
    <div class="sourceCode" id="cb105"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> ones<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> <span class="bu">Stream</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">{</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> head<span class="op">:</span> <span class="bu">Int</span> <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> tail<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span> ones</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>You might be alarmed to see the circular reference to
    <code>ones</code> in <code>tail</code>. This works because it is
    within a method, and so is only evaluated when that method is
    called. This delaying of evaluation is what allows us to represent
    an infinite number of elements, as we only ever evaluate a finite
    portion of them. This is a core difference from data, which is fully
    evaluated when it is constructed.</p>
    <p><code>tail</code> で <code>ones</code>
    への循環参照を見て驚くかもしれないが、これは問題ない。この参照はメソッド内にあり、メソッドが呼び出されたときにのみ評価される。この評価の遅延こそが、無限の要素を表現できる理由であり、実際には有限の部分だけが評価される。これは、データのように構築時にすべてが評価されるものとは根本的に異なる点である。</p>
    <p>Let’s check that our definition of <code>ones</code> does indeed
    work. We can’t extract all the elements from an infinite
    <code>Stream</code> (at least, not in finite time) so in general
    we’ll have to resort to checking a finite sequence of elements.</p>
    <p>この <code>ones</code>
    の定義が確かに動作することを確認しておこう。無限のストリームからすべての要素を取り出すことは（少なくとも有限の時間内には）できない。したがって、通常は有限の要素列を確認することに頼らざるを得ない。</p>
    <div class="sourceCode" id="cb106"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>ones<span class="op">.</span>head</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res0: Int = 1</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>ones<span class="op">.</span>tail<span class="op">.</span>head</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: Int = 1</span></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>ones<span class="op">.</span>tail<span class="op">.</span>tail<span class="op">.</span>head</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: Int = 1</span></span></code></pre></div>
    <p>This all looks correct. We’ll often want to check our
    implementation in this way, so let’s implement a method,
    <code>take</code>, to make this easier.</p>
    <p>すべて正しいようである。動作確認にはこの方法を使うことが多いので、これをもっと簡単にしてくれるメソッド
    <code>take</code> を実装しよう。</p>
    <div class="sourceCode" id="cb107"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> head<span class="op">:</span> A</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> tail<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">take</span><span class="op">(</span>count<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>    count <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="dv">0</span> <span class="op">=&gt;</span> Nil</span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> n <span class="op">=&gt;</span> head <span class="op">::</span> tail<span class="op">.</span><span class="fu">take</span><span class="op">(</span>n <span class="op">-</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>We can use either the structural recursion or structural
    corecursion strategies for data to implement <code>take</code>.
    Since we’ve already covered these in detail I won’t go through them
    here. The important point is that <code>take</code> only uses the
    destructors when interacting with the <code>Stream</code>.</p>
    <p><code>take</code>
    の実装には、データに対する構造的再帰か構造的余再帰いずれかの戦略を利用できる。それらについては既に詳しく説明しているので、ここでは触れない。重要なのは、<code>take</code>
    がデストラクタのみを通じて <code>Stream</code>
    とやり取りしているということである。</p>
    <p>Now we can more easily check our implementations are correct.</p>
    <p>これで、実装が正しいことをより簡単に確認できるようになる。</p>
    <div class="sourceCode" id="cb108"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>ones<span class="op">.</span><span class="fu">take</span><span class="op">(</span><span class="dv">5</span><span class="op">)</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: List[Int] = List(1, 1, 1, 1, 1)</span></span></code></pre></div>
    <p>For our next task we’ll implement <code>map</code>. Implementing
    a method on <code>Stream</code> allows us to see both structural
    recursion and corecursion for codata in action. As usual we begin by
    writing out the method skeleton.</p>
    <p>次の課題として <code>map</code> を実装する。<code>Stream</code>
    にメソッドを実装することで、余データにおける構造的再帰と構造的余再帰の両方を実際に確認することができる。いつものようにメソッドの骨組みを書き出すところから始める。</p>
    <div class="sourceCode" id="cb109"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> head<span class="op">:</span> A</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> tail<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>B<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> <span class="bu">Stream</span><span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> </span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Now we have a choice of strategy to use. Since we haven’t used
    structural recursion yet, let’s start with that. The input is
    codata, a <code>Stream</code>, and the structural recursion strategy
    tells us we should consider using the destructors. Let’s write them
    down to remind us of them.</p>
    <p>利用する戦略を決めなくてはならない。まだ構造的再帰を使っていないので、まずはそれを試してみよう。入力は余データ
    <code>Stream</code>
    である。構造的再帰戦略ではデストラクタを用いることを検討すべきとされているので、リマインドの意味でデストラクタ呼び出しを書き出しておこう。</p>
    <div class="sourceCode" id="cb110"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> head<span class="op">:</span> A</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> tail<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>B<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> <span class="bu">Stream</span><span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span>head <span class="op">???</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span>tail <span class="op">???</span></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>To make progress we can follow the types or use structural
    corecursion. Let’s choose corecursion to see another example of it
    in use.</p>
    <p>さらに実装を進めるために、型に従う手法か構造的余再帰を利用できる。構造的余再帰の使用例をもうひとつ見てみたいので、そちらを選択することにしよう。</p>
    <div class="sourceCode" id="cb111"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> head<span class="op">:</span> A</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> tail<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>B<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> <span class="bu">Stream</span><span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span>head <span class="op">???</span></span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span>tail <span class="op">???</span></span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="bu">Stream</span><span class="op">[</span>B<span class="op">]</span> <span class="op">{</span></span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> head<span class="op">:</span> B <span class="op">=</span> <span class="op">???</span></span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> tail<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> <span class="op">???</span></span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Now we’ve used structural recursion and structural corecursion, a
    bit of following the types is in order. This quickly arrives at the
    correct solution.</p>
    <p>これで構造的再帰と構造的余再帰を使ったので、次は型に従う方法をすこし試してみよう。迅速に正しい解答にたどり着くことができる。</p>
    <div class="sourceCode" id="cb112"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> head<span class="op">:</span> A</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> tail<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>B<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> <span class="bu">Stream</span><span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> self <span class="op">=</span> <span class="kw">this</span> </span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="bu">Stream</span><span class="op">[</span>B<span class="op">]</span> <span class="op">{</span></span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> head<span class="op">:</span> B <span class="op">=</span> <span class="fu">f</span><span class="op">(</span>self<span class="op">.</span>head<span class="op">)</span></span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> tail<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> self<span class="op">.</span>tail<span class="op">.</span><span class="fu">map</span><span class="op">(</span>f<span class="op">)</span></span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>There are two important points. Firstly, notice how I gave the
    name <code>self</code> to <code>this</code>. This is so I can access
    the value inside the new <code>Stream</code> we are creating, where
    <code>this</code> would be bound to this new <code>Stream</code>.
    Next, notice that we access <code>self.head</code> and
    <code>self.tail</code> inside the methods on the new
    <code>Stream</code>. This maintains the correct semantics of only
    performing computation when it has been asked for. If we performed
    the computation outside of the methods that we would do it too
    early, which is some cases can lead to an infinite loop.</p>
    <p>重要な点が二つある。まず注目してほしいのは、<code>this</code> に
    <code>self</code>
    という名前を与えたことである。作成しようとしている新しい
    <code>Stream</code> オブジェクトの中では <code>this</code>
    はその新しいストリーム自体を指すので、その中で元の
    <code>Stream</code>
    オブジェクトを参照するにはこれが必要となる。次に、<code>self.head</code>
    と <code>self.tail</code> へのアクセスが、新しい <code>Stream</code>
    に定義されたメソッドの中で行われている点に注目してほしい。これによって、必要とされたときにのみ計算を行うという適切なセマンティクスが維持される。メソッド外で計算を行うと、必要以上に早く評価されてしまい、場合によっては無限ループにつながることもある。</p>
    <p>As our final example, let’s return to constructing
    <code>Stream</code>, and implement the universal constructor
    <code>unfold</code>. We start with the skeleton for
    <code>unfold</code>, remembering the <code>seed</code>
    parameter.</p>
    <p>最後の例として、再び <code>Stream</code>
    の構築に戻り、汎用的なコンストラクタである <code>unfold</code>
    を実装しよう。<code>seed</code> パラメータについて考慮しつつ、まずは
    <code>unfold</code> の骨組みから始める。</p>
    <div class="sourceCode" id="cb113"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> head<span class="op">:</span> A</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> tail<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> <span class="bu">Stream</span> <span class="op">{</span></span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> unfold<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>seed<span class="op">:</span> A<span class="op">):</span> <span class="bu">Stream</span><span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>It’s natural to apply structural corecursion to make
    progress.</p>
    <p>構造的余再帰を適用して実装を進めるのが自然だろう。</p>
    <div class="sourceCode" id="cb114"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> head<span class="op">:</span> A</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> tail<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> <span class="bu">Stream</span> <span class="op">{</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> unfold<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>seed<span class="op">:</span> A<span class="op">):</span> <span class="bu">Stream</span><span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="bu">Stream</span><span class="op">[</span>B<span class="op">]{</span></span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> head<span class="op">:</span> B <span class="op">=</span> <span class="op">???</span></span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> tail<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> <span class="op">???</span></span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Now we can follow the types, adding parameters as we need them.
    This gives us the complete method shown below.</p>
    <p>次に、型に従って、必要に応じたパラメータを追加する。これにより、メソッドは以下のとおり完成する。</p>
    <div class="sourceCode" id="cb115"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> head<span class="op">:</span> A</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> tail<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> <span class="bu">Stream</span> <span class="op">{</span></span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> unfold<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>seed<span class="op">:</span> A<span class="op">,</span> f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">,</span> next<span class="op">:</span> A <span class="op">=&gt;</span> A<span class="op">):</span> <span class="bu">Stream</span><span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="bu">Stream</span><span class="op">[</span>B<span class="op">]{</span></span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> head<span class="op">:</span> B <span class="op">=</span> </span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">f</span><span class="op">(</span>seed<span class="op">)</span></span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> tail<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> </span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">unfold</span><span class="op">(</span><span class="fu">next</span><span class="op">(</span>seed<span class="op">),</span> f<span class="op">,</span> next<span class="op">)</span></span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>We can use this to implement some interesting streams. Here’s a
    stream that alternates between <code>1</code> and
    <code>-1</code>.</p>
    <p>これを使って、おもしろいストリームを実装できる。以下に示すのは
    <code>1</code> と <code>-1</code>
    が交互に現れるストリームである。</p>
    <div class="sourceCode" id="cb116"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> alternating <span class="op">=</span> <span class="bu">Stream</span><span class="op">.</span><span class="fu">unfold</span><span class="op">(</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">true</span><span class="op">,</span> </span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>  x <span class="op">=&gt;</span> <span class="cf">if</span> x then <span class="dv">1</span> <span class="cf">else</span> <span class="op">-</span><span class="dv">1</span><span class="op">,</span> </span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>  x <span class="op">=&gt;</span> <span class="op">!</span>x</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span></code></pre></div>
    <p>We can check it works.</p>
    <p>動作を確認しておこう。</p>
    <div class="sourceCode" id="cb117"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>alternating<span class="op">.</span><span class="fu">take</span><span class="op">(</span><span class="dv">5</span><span class="op">)</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res11: List[Int] = List(1, -1, 1, -1, 1)</span></span></code></pre></div>
    <h4 class="unnumbered" id="演習-stream-のコンビネータ実装">演習:
    <code>Stream</code> のコンビネータ実装</h4>
    <p>It’s time for you to get some practice with structural recursion
    and structural corecursion using codata. Implement
    <code>filter</code>, <code>zip</code>, and <code>scanLeft</code> on
    <code>Stream</code>. They have the same semantics as the same
    methods on <code>List</code>, and the signatures shown below.</p>
    <p>そろそろ、余データを用いた構造的再帰と構造的余再帰について練習をしておこう。<code>Stream</code>
    に <code>filter</code>、<code>zip</code>、および
    <code>scanLeft</code> メソッドを実装せよ。いずれも <code>List</code>
    における同名のメソッドと同じ意味をもっているものとし、シグネチャは以下のとおりとする。</p>
    <div class="sourceCode" id="cb118"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> head<span class="op">:</span> A</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> tail<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">filter</span><span class="op">(</span>pred<span class="op">:</span> A <span class="op">=&gt;</span> <span class="ex">Boolean</span><span class="op">):</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> zip<span class="op">[</span>B<span class="op">](</span>that<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span>B<span class="op">]):</span> <span class="bu">Stream</span><span class="op">[(</span>A<span class="op">,</span> B<span class="op">)]</span></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> scanLeft<span class="op">[</span>B<span class="op">](</span>zero<span class="op">:</span> B<span class="op">)(</span>f<span class="op">:</span> <span class="op">(</span>B<span class="op">,</span> A<span class="op">)</span> <span class="op">=&gt;</span> B<span class="op">):</span> <span class="bu">Stream</span><span class="op">[</span>B<span class="op">]</span></span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <div class="solution">
    <p>For all of these methods I found that structural corecursion was
    the most natural way to tackle them. You could start with structural
    recursion, though.</p>
    <p>いずれのメソッドの実装においても、構造的余再帰がもっとも自然なアプローチだろう。構造的再帰から始めることも可能ではあるが。</p>
    <p>You might be worried about the inefficiency of
    <code>filter</code>. That’s something we’ll discuss a bit later.</p>
    <p><code>filter</code>
    の非効率さが気になるかもしれないが、それについては後ほどすこし説明する。</p>
    <div class="sourceCode" id="cb119"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> head<span class="op">:</span> A</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> tail<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">filter</span><span class="op">(</span>pred<span class="op">:</span> A <span class="op">=&gt;</span> <span class="ex">Boolean</span><span class="op">):</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> self <span class="op">=</span> <span class="kw">this</span></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> head<span class="op">:</span> A <span class="op">=</span> <span class="op">{</span></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> <span class="fu">loop</span><span class="op">(</span>stream<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]):</span> A <span class="op">=</span></span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> <span class="fu">pred</span><span class="op">(</span>stream<span class="op">.</span>head<span class="op">)</span> then stream<span class="op">.</span>head</span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span> <span class="fu">loop</span><span class="op">(</span>stream<span class="op">.</span>tail<span class="op">)</span></span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">loop</span><span class="op">(</span>self<span class="op">)</span></span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb119-15"><a href="#cb119-15" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb119-16"><a href="#cb119-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> tail<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb119-17"><a href="#cb119-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> <span class="fu">loop</span><span class="op">(</span>stream<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]):</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb119-18"><a href="#cb119-18" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> <span class="fu">pred</span><span class="op">(</span>stream<span class="op">.</span>head<span class="op">)</span> then stream<span class="op">.</span>tail</span>
<span id="cb119-19"><a href="#cb119-19" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span> <span class="fu">loop</span><span class="op">(</span>stream<span class="op">.</span>tail<span class="op">)</span></span>
<span id="cb119-20"><a href="#cb119-20" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb119-21"><a href="#cb119-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">loop</span><span class="op">(</span>self<span class="op">)</span></span>
<span id="cb119-22"><a href="#cb119-22" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb119-23"><a href="#cb119-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb119-24"><a href="#cb119-24" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb119-25"><a href="#cb119-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-26"><a href="#cb119-26" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> zip<span class="op">[</span>B<span class="op">](</span>that<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span>B<span class="op">]):</span> <span class="bu">Stream</span><span class="op">[(</span>A<span class="op">,</span> B<span class="op">)]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb119-27"><a href="#cb119-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> self <span class="op">=</span> <span class="kw">this</span> </span>
<span id="cb119-28"><a href="#cb119-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="bu">Stream</span><span class="op">[(</span>A<span class="op">,</span> B<span class="op">)]</span> <span class="op">{</span></span>
<span id="cb119-29"><a href="#cb119-29" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> head<span class="op">:</span> <span class="op">(</span>A<span class="op">,</span> B<span class="op">)</span> <span class="op">=</span> <span class="op">(</span>self<span class="op">.</span>head<span class="op">,</span> that<span class="op">.</span>head<span class="op">)</span></span>
<span id="cb119-30"><a href="#cb119-30" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb119-31"><a href="#cb119-31" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> tail<span class="op">:</span> <span class="bu">Stream</span><span class="op">[(</span>A<span class="op">,</span> B<span class="op">)]</span> <span class="op">=</span></span>
<span id="cb119-32"><a href="#cb119-32" aria-hidden="true" tabindex="-1"></a>        self<span class="op">.</span>tail<span class="op">.</span><span class="fu">zip</span><span class="op">(</span>that<span class="op">.</span>tail<span class="op">)</span></span>
<span id="cb119-33"><a href="#cb119-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb119-34"><a href="#cb119-34" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb119-35"><a href="#cb119-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-36"><a href="#cb119-36" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> scanLeft<span class="op">[</span>B<span class="op">](</span>zero<span class="op">:</span> B<span class="op">)(</span>f<span class="op">:</span> <span class="op">(</span>B<span class="op">,</span> A<span class="op">)</span> <span class="op">=&gt;</span> B<span class="op">):</span> <span class="bu">Stream</span><span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb119-37"><a href="#cb119-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> self <span class="op">=</span> <span class="kw">this</span></span>
<span id="cb119-38"><a href="#cb119-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="bu">Stream</span><span class="op">[</span>B<span class="op">]</span> <span class="op">{</span></span>
<span id="cb119-39"><a href="#cb119-39" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> head<span class="op">:</span> B <span class="op">=</span> <span class="fu">f</span><span class="op">(</span>zero<span class="op">,</span> self<span class="op">.</span>head<span class="op">)</span></span>
<span id="cb119-40"><a href="#cb119-40" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb119-41"><a href="#cb119-41" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> tail<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb119-42"><a href="#cb119-42" aria-hidden="true" tabindex="-1"></a>        self<span class="op">.</span>tail<span class="op">.</span><span class="fu">scanLeft</span><span class="op">(</span><span class="kw">this</span><span class="op">.</span>head<span class="op">)(</span>f<span class="op">)</span></span>
<span id="cb119-43"><a href="#cb119-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb119-44"><a href="#cb119-44" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb119-45"><a href="#cb119-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    </div>
    <p>We can do some neat things with the methods defined above. For
    example, here is the stream of natural numbers.</p>
    <p>上記で定義したメソッドを使うと、クールなことができる。たとえば、自然数のストリームは次のようになる。</p>
    <div class="sourceCode" id="cb120"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> naturals <span class="op">=</span> <span class="bu">Stream</span><span class="op">.</span>ones<span class="op">.</span><span class="fu">scanLeft</span><span class="op">(</span><span class="dv">0</span><span class="op">)((</span>b<span class="op">,</span> a<span class="op">)</span> <span class="op">=&gt;</span> b <span class="op">+</span> a<span class="op">)</span></span></code></pre></div>
    <p>As usual, we should check it works.</p>
    <p>いつもどおり、動作確認をしておこう。</p>
    <div class="sourceCode" id="cb121"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>naturals<span class="op">.</span><span class="fu">take</span><span class="op">(</span><span class="dv">5</span><span class="op">)</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res15: List[Int] = List(1, 2, 3, 4, 5)</span></span></code></pre></div>
    <p>We could also define <code>naturals</code> using
    <code>unfold</code>. More interesting is defining it in terms of
    itself.</p>
    <p><code>unfold</code> を用いて <code>naturals</code>
    を定義することもできる。もっと興味深いのは、<code>naturals</code>
    を使って <code>naturals</code> を定義できることである。</p>
    <div class="sourceCode" id="cb122"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> naturals<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> <span class="bu">Stream</span> <span class="op">{</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> head <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> tail <span class="op">=</span> naturals<span class="op">.</span><span class="fu">map</span><span class="op">(</span>_ <span class="op">+</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>This might be confusing. If so, spend a bit of time thinking
    about it. It really does work!</p>
    <p>これはややこしいかもしれないが、もしそう思ったらすこし時間をとって考えてみてほしい。この実装はちゃんと動作するのである。</p>
    <div class="sourceCode" id="cb123"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>naturals<span class="op">.</span><span class="fu">take</span><span class="op">(</span><span class="dv">5</span><span class="op">)</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res17: List[Int] = List(1, 2, 3, 4, 5)</span></span></code></pre></div>
    <h3 data-number="3.3.1" id="efficiency-and-effects-効率と副作用"><span class="header-section-number">3.3.1</span> Efficiency and Effects
    効率と副作用</h3>
    <p>You may have noticed that our implement recomputes values,
    possibly many times. A good example is the implementation of
    <code>filter</code>. This recalculates the <code>head</code> and
    <code>tail</code> on each call, which could be a very expensive
    operation.</p>
    <p>上記の実装において、値を場合によっては何度も繰り返し再計算していることに気付いたかもしれない。<code>filter</code>
    の実装がそのよい例である。<code>filter</code> は呼び出すたびに
    <code>head</code> と <code>tail</code>
    を再計算するため、非常にコストの高い操作になる可能性がある。</p>
    <div class="sourceCode" id="cb124"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">filter</span><span class="op">(</span>pred<span class="op">:</span> A <span class="op">=&gt;</span> <span class="ex">Boolean</span><span class="op">):</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> self <span class="op">=</span> <span class="kw">this</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> head<span class="op">:</span> A <span class="op">=</span> <span class="op">{</span></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> <span class="fu">loop</span><span class="op">(</span>stream<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]):</span> A <span class="op">=</span></span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="fu">pred</span><span class="op">(</span>stream<span class="op">.</span>head<span class="op">)</span> then stream<span class="op">.</span>head</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="fu">loop</span><span class="op">(</span>stream<span class="op">.</span>tail<span class="op">)</span></span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">loop</span><span class="op">(</span>self<span class="op">)</span></span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> tail<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> <span class="fu">loop</span><span class="op">(</span>stream<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]):</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="fu">pred</span><span class="op">(</span>stream<span class="op">.</span>head<span class="op">)</span> then stream<span class="op">.</span>tail</span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="fu">loop</span><span class="op">(</span>stream<span class="op">.</span>tail<span class="op">)</span></span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb124-17"><a href="#cb124-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">loop</span><span class="op">(</span>self<span class="op">)</span></span>
<span id="cb124-18"><a href="#cb124-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb124-19"><a href="#cb124-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb124-20"><a href="#cb124-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>We know that delaying the computation until the method is called
    is important, because that is how we can handle infinite and
    self-referential data. However we don’t need to redo this
    computation on succesive calls. We can instead cache the result from
    the first call and use that next time. Scala makes this easy with
    <code>lazy val</code>, which is a <code>val</code> that is not
    computed until its first call. Additionally, Scala’s use of the
    <em>uniform access principle</em> means we can implement a method
    with no parameters using a <code>lazy val</code>. Here’s a quick
    example demonstrating it in use.</p>
    <p>メソッドが呼び出されるまで計算を遅延することの重要性はすでに述べた。それによって無限の、そして自己参照的なデータを扱うことができるからである。だが、そのメソッドが連続して呼び出されるときに、同じ計算を再実行する必要はない。最初の呼び出し時に結果をキャッシュしておけば、次回からはそれを使用できる。Scalaでは
    <code>lazy val</code>
    を使うことでこれを簡単に実現できる。<code>lazy val</code>
    は、最初に呼び出されるまで評価されない <code>val</code> である。</p>
    <div class="sourceCode" id="cb125"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> always<span class="op">[</span>A<span class="op">](</span>elt<span class="op">:</span> <span class="op">=&gt;</span> A<span class="op">):</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lazy</span> <span class="kw">val</span> head<span class="op">:</span> A <span class="op">=</span> elt</span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lazy</span> <span class="kw">val</span> tail<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> <span class="fu">always</span><span class="op">(</span>head<span class="op">)</span></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> twos <span class="op">=</span> <span class="fu">always</span><span class="op">(</span><span class="dv">2</span><span class="op">)</span></span></code></pre></div>
    <p>As usual we should check our work.</p>
    <p>いつもどおり動作確認をしておこう。</p>
    <div class="sourceCode" id="cb126"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>twos<span class="op">.</span><span class="fu">take</span><span class="op">(</span><span class="dv">5</span><span class="op">)</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res18: List[Int] = List(2, 2, 2, 2, 2)</span></span></code></pre></div>
    <p>We get the same result whether we use a method or a
    <code>lazy val</code>, because we are assuming that we are only
    dealing with pure computations that have no dependency on state that
    might change. In this case a <code>lazy val</code> simply consumes
    additional space to save on time.</p>
    <p>メソッドと <code>lazy val</code>
    どちらを使っても得られる結果は同じになる。可変状態に依存しない純粋な計算のみを扱っている想定だからである。そのような場合においては、<code>lazy val</code>
    はメモリを追加で消費し、時間を節約する役割を果たす。</p>
    <!-- TODO: ここより下、評価戦略に関する原文の記述はちょっと混乱していると思う。訳注するか？ -->
    <p>Recomputing a result every time it is needed is known as
    <strong>call by name</strong>, while caching the result the first
    time it is computed is known as <strong>call by need</strong>. These
    two different <strong>evaluation strategies</strong> can be applied
    to individual values, as we’ve done here, or across an entire
    programming. Haskell, for example, uses call by need. All values in
    Haskell are only computed the first time they are need. This is
    approach is sometimes known as <strong>lazy evaluation</strong>.
    Another alternative, called <strong>call by value</strong>, computes
    results when they are defined instead of waiting until they are
    needed. This is the default in Scala.</p>
    <p>必要になるたびに結果を再計算する方式は<strong>名前渡し（call by
    name）</strong>と呼ばれ、最初に計算された結果をキャッシュしておく方式は<strong>必要渡し（call
    by
    need）</strong>と呼ばれる。この二つの異なる<strong>評価戦略（evaluation
    strategy）</strong>は、今回のように個々の値に適用することもできるし、プログラム全体にわたって適用することもできる。例として、Haskellでは必要渡しが使われており、すべての値はそれが必要となる最初のタイミングでのみ計算される。このアプローチは<strong>遅延評価</strong>と呼ばれることもある。<strong>値渡し（call
    by
    value）</strong>と呼ばれる別の方式では、結果が必要とされるのを待たず、定義された時点で計算される。この方式がScalaでのデフォルトである。</p>
    <p>We can illustrate the difference between call by name and call by
    need if we use an impure computation. For example, we can define a
    stream of random numbers. Random number generators depend on some
    internal state.</p>
    <p>純粋でない計算を使って、名前渡しと必要渡しの違いを示すことができる。たとえば、乱数のストリームを定義してみよう。乱数生成器は内部状態に依存している。</p>
    <p>Here’s the call by name implementation, using the methods we have
    already defined.</p>
    <p>以下は、名前渡しを用いた実装である。</p>
    <div class="sourceCode" id="cb127"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>util<span class="op">.</span><span class="ex">Random</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> randoms<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span><span class="ex">Double</span><span class="op">]</span> <span class="op">=</span> </span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Stream</span><span class="op">.</span><span class="fu">unfold</span><span class="op">(</span><span class="ex">Random</span><span class="op">,</span> r <span class="op">=&gt;</span> r<span class="op">.</span><span class="fu">nextDouble</span><span class="op">(),</span> r <span class="op">=&gt;</span> r<span class="op">)</span></span></code></pre></div>
    <p>Notice that we get <em>different</em> results each time we
    <code>take</code> a section of the <code>Stream</code>. We would
    expect these results to be the same.</p>
    <p><code>Stream</code> の一部を <code>take</code>
    するたびに、<em>異なる</em>結果が得られることに注目してほしい。これらの結果は本来同じであることが期待される。</p>
    <div class="sourceCode" id="cb128"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>randoms<span class="op">.</span><span class="fu">take</span><span class="op">(</span><span class="dv">5</span><span class="op">)</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res19: List[Double] = List(</span></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.39514684236641207,</span></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.10668926358381603,</span></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.5533908607167473,</span></span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.8800170998729099,</span></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.575147565735072</span></span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>randoms<span class="op">.</span><span class="fu">take</span><span class="op">(</span><span class="dv">5</span><span class="op">)</span></span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a><span class="co">// res20: List[Double] = List(</span></span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.9280852422570531,</span></span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.6041973215390425,</span></span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.18764044483697095,</span></span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.006593511994209211,</span></span>
<span id="cb128-15"><a href="#cb128-15" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.8670410632061455</span></span>
<span id="cb128-16"><a href="#cb128-16" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>Now let’s define the same stream in a call by need style, using
    <code>lazy val</code>.</p>
    <p>次に、<code>lazy val</code>
    を使い、必要渡しのスタイルで同じストリームを定義してみよう。</p>
    <div class="sourceCode" id="cb129"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> randomsByNeed<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span><span class="ex">Double</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> <span class="bu">Stream</span><span class="op">[</span><span class="ex">Double</span><span class="op">]</span> <span class="op">{</span></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lazy</span> <span class="kw">val</span> head<span class="op">:</span> <span class="ex">Double</span> <span class="op">=</span> <span class="ex">Random</span><span class="op">.</span><span class="fu">nextDouble</span><span class="op">()</span></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lazy</span> <span class="kw">val</span> tail<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span><span class="ex">Double</span><span class="op">]</span> <span class="op">=</span> randomsByNeed</span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>This time we get the <em>same</em> result when we
    <code>take</code> a section, and each number is the same.</p>
    <p>今回は、ストリームの一部を <code>take</code>
    したときに得られる結果は同じになる。また、得られる数はどれも同じである。</p>
    <div class="sourceCode" id="cb130"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>randomsByNeed<span class="op">.</span><span class="fu">take</span><span class="op">(</span><span class="dv">5</span><span class="op">)</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res21: List[Double] = List(</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.6447596873301127,</span></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.6447596873301127,</span></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.6447596873301127,</span></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.6447596873301127,</span></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.6447596873301127</span></span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a>randomsByNeed<span class="op">.</span><span class="fu">take</span><span class="op">(</span><span class="dv">5</span><span class="op">)</span></span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a><span class="co">// res22: List[Double] = List(</span></span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.6447596873301127,</span></span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.6447596873301127,</span></span>
<span id="cb130-13"><a href="#cb130-13" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.6447596873301127,</span></span>
<span id="cb130-14"><a href="#cb130-14" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.6447596873301127,</span></span>
<span id="cb130-15"><a href="#cb130-15" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.6447596873301127</span></span>
<span id="cb130-16"><a href="#cb130-16" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>If we wanted a stream that had a different random number for each
    element but those numbers were constant, we could redefine
    <code>unfold</code> to use call by need.</p>
    <div class="sourceCode" id="cb131"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> unfoldByNeed<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>seed<span class="op">:</span> A<span class="op">,</span> f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">,</span> next<span class="op">:</span> A <span class="op">=&gt;</span> A<span class="op">):</span> <span class="bu">Stream</span><span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> <span class="bu">Stream</span><span class="op">[</span>B<span class="op">]{</span></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lazy</span> <span class="kw">val</span> head<span class="op">:</span> B <span class="op">=</span> </span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">f</span><span class="op">(</span>seed<span class="op">)</span></span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lazy</span> <span class="kw">val</span> tail<span class="op">:</span> <span class="bu">Stream</span><span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> </span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unfoldByNeed</span><span class="op">(</span><span class="fu">next</span><span class="op">(</span>seed<span class="op">),</span> f<span class="op">,</span> next<span class="op">)</span></span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>Now redefining <code>randomsByNeed</code> using
    <code>unfoldByNeed</code> gives us the result we are after. First,
    redefine it.</p>
    <div class="sourceCode" id="cb132"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> randomsByNeed2 <span class="op">=</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unfoldByNeed</span><span class="op">(</span><span class="ex">Random</span><span class="op">,</span> r <span class="op">=&gt;</span> r<span class="op">.</span><span class="fu">nextDouble</span><span class="op">(),</span> r <span class="op">=&gt;</span> r<span class="op">)</span></span></code></pre></div>
    <p>Then check it works.</p>
    <div class="sourceCode" id="cb133"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>randomsByNeed2<span class="op">.</span><span class="fu">take</span><span class="op">(</span><span class="dv">5</span><span class="op">)</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res23: List[Double] = List(</span></span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.5692185341804312,</span></span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.270750368403484,</span></span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.9549853615848954,</span></span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.6618916506823809,</span></span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.31709975339582475</span></span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span>
<span id="cb133-9"><a href="#cb133-9" aria-hidden="true" tabindex="-1"></a>randomsByNeed2<span class="op">.</span><span class="fu">take</span><span class="op">(</span><span class="dv">5</span><span class="op">)</span></span>
<span id="cb133-10"><a href="#cb133-10" aria-hidden="true" tabindex="-1"></a><span class="co">// res24: List[Double] = List(</span></span>
<span id="cb133-11"><a href="#cb133-11" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.5692185341804312,</span></span>
<span id="cb133-12"><a href="#cb133-12" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.270750368403484,</span></span>
<span id="cb133-13"><a href="#cb133-13" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.9549853615848954,</span></span>
<span id="cb133-14"><a href="#cb133-14" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.6618916506823809,</span></span>
<span id="cb133-15"><a href="#cb133-15" aria-hidden="true" tabindex="-1"></a><span class="co">//   0.31709975339582475</span></span>
<span id="cb133-16"><a href="#cb133-16" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>These subtleties are one of the reasons that functional
    programmers try to avoid using state as far as possible.</p>
    <h2 data-number="3.4" id="データと余データの関係-relating-data-and-codata"><span class="header-section-number">3.4</span> データと余データの関係
    Relating Data and Codata</h2>
    <p>In this section we’ll explore the relationship between data and
    codata, and in paritcular converting one to the other. We’ll look at
    it in two ways: firstly a very surface-level relationship between
    the two, and then a deep connection via <code>fold</code>.</p>
    <p>この節では、データと余データの関係、特にそれらの相互変換について探求する。まずは両者の表面的な関係を確認し、その後、<code>fold</code>
    を通じた深い結びつきを見ていく。</p>
    <p>Remember that data is a sum of products, where the products are
    constructors and we can view constructors as functions. So we can
    view data as a sum of functions. Meanwhile, codata is a product of
    functions. We can easily make a direct correspondence between the
    functions-as-constructors and the functions in codata. What about
    the difference between the sum and the product that remains. Well,
    when we have a product of functions we only call one at any point in
    our code. So the logical or is in the choice of function to
    call.</p>
    <p>データは積の和で構成されており、その積の部分がコンストラクタとなることを思い出してほしい。コンストラクタは関数として見ることができるため、データは関数の和として捉えることもできる。一方、余データは関数の積として表現される。コンストラクタとしての関数と余データにおける関数の間には、直接的な対応関係を簡単に見出すことができる。では、和と積の違いはどうだろうか。関数の積があるとき、コードのある場所において呼び出すことのできる関数はどれかひとつだけである。つまり、論理和はどの関数を呼び出すかの選択において表現されている。</p>
    <p>Let’s see how this works with a familiar example of data,
    <code>List</code>. As an algebraic data type we can define</p>
    <p>データの代表例である <code>List</code>
    を使ってこれがどのように機能するのか見てみよう。<code>List</code>
    は代数的データ型として次のように定義できる。</p>
    <div class="sourceCode" id="cb134"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>enum <span class="ex">List</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">:</span> A<span class="op">,</span> tail<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">])</span></span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>The codata equivalent is</p>
    <p>余データに相当するものは以下のとおりである。</p>
    <div class="sourceCode" id="cb135"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">pair</span><span class="op">(</span>head<span class="op">:</span> A<span class="op">,</span> tail<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">]):</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">]</span></span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> empty<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">]</span></span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>In the codata implementation we are explicitly representing the
    constructors as methods, and pushing the choice of constructor to
    the caller. In a few chapters we’ll see a use for this relationship,
    but for now we’ll leave it and move on.</p>
    <p>この余データの定義では、コンストラクタを明示的にメソッドとして表現し、コンストラクタの選択を呼び出し側に委ねている。この関係性が役立つ場面をいくつか先の章で見ることになるが、ここではこの話題を一旦終え、次に進むことにする。</p>
    <p>The other way to view the relationship is a connection via
    <code>fold</code>. We’ve already learned how to derive the
    <code>fold</code> for any algebraic data type. For
    <code>Bool</code>, defined as</p>
    <p>両者の関係を見るもうひとつの方法は <code>fold</code>
    を通じたつながりである。代数的データ型に対して <code>fold</code>
    を導出する方法についてはすでに学んできた。たとえば、次のように定義される
    <code>Bool</code> の場合を考えてみよう。</p>
    <div class="sourceCode" id="cb136"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>enum Bool <span class="op">{</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> True</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> False</span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p><code>fold</code> メソッドは以下のように実装される。</p>
    <div class="sourceCode" id="cb137"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>enum Bool <span class="op">{</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> True</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> False</span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> fold<span class="op">[</span>A<span class="op">](</span>t<span class="op">:</span> A<span class="op">)(</span>f<span class="op">:</span> A<span class="op">):</span> A <span class="op">=</span></span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> True <span class="op">=&gt;</span> t</span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> False <span class="op">=&gt;</span> f</span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb137-10"><a href="#cb137-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>We know that <code>fold</code> is universal: we can write any
    other method in terms of it. It therefore provides a universal
    destructor and is the key to treating data as codata. In this case
    the <code>fold</code> is something we use all the time, except we
    usually call it <code>if</code>.</p>
    <p><code>fold</code>
    は汎用的であり、これを用いればどんなメソッドでも記述することができる。それゆえ提供されるデストラクタも汎用的であり、データを余データとして扱うための鍵となる。<code>Bool</code>
    において <code>fold</code> は、我々が普段は <code>if</code>
    式と呼び、頻繁に使っているものである。</p>
    <!-- TODO: It therefore provides a universal destructor and is the key to treating data as codata の意味がよくわからない -->
    <p>Here’s the codata version of <code>Bool</code>, with
    <code>fold</code> renamed to <code>if</code>. (Note that Scala
    allows us to define methods with the same name as key words, in this
    case <code>if</code>, but we have to surround them in backticks to
    use them.)</p>
    <p>以下は、<code>Bool</code>
    の余データバージョンであり、<code>fold</code> を <code>if</code>
    にリネームしたものである（Scalaでは、<code>if</code>
    のようなキーワードと同名のメソッドを定義できるが、キーワードを識別子として利用する際にはバッククォートで囲む必要がある）。</p>
    <div class="sourceCode" id="cb138"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Bool <span class="op">{</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> `if`<span class="op">[</span>A<span class="op">](</span>t<span class="op">:</span> A<span class="op">)(</span>f<span class="op">:</span> A<span class="op">):</span> A</span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Now we can define the two instances of <code>Bool</code> purely
    as codata.</p>
    <p>次に、<code>Bool</code>
    の二つのインスタンスを純粋に余データとして定義してみよう。</p>
    <div class="sourceCode" id="cb139"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> True <span class="op">=</span> <span class="kw">new</span> Bool <span class="op">{</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> `if`<span class="op">[</span>A<span class="op">](</span>t<span class="op">:</span> A<span class="op">)(</span>f<span class="op">:</span> A<span class="op">):</span> A <span class="op">=</span> t</span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> False <span class="op">=</span> <span class="kw">new</span> Bool <span class="op">{</span></span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> `if`<span class="op">[</span>A<span class="op">](</span>t<span class="op">:</span> A<span class="op">)(</span>f<span class="op">:</span> A<span class="op">):</span> A <span class="op">=</span> f</span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Let’s see this in use by defining <code>and</code> in terms of
    <code>if</code>, and then creating some examples. First the
    definition of <code>and</code>.</p>
    <p>この <code>if</code>
    メソッドの実際の使用例を見てみよう。<code>if</code> を用いて
    <code>and</code> を定義し、その後それらを使用する例を挙げる。</p>
    <div class="sourceCode" id="cb140"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">and</span><span class="op">(</span>l<span class="op">:</span> Bool<span class="op">,</span> r<span class="op">:</span> Bool<span class="op">):</span> Bool <span class="op">=</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> Bool <span class="op">{</span></span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> `if`<span class="op">[</span>A<span class="op">](</span>t<span class="op">:</span> A<span class="op">)(</span>f<span class="op">:</span> A<span class="op">):</span> A <span class="op">=</span></span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>      l<span class="op">.</span>`if`<span class="op">(</span>r<span class="op">)(</span>False<span class="op">).</span>`if`<span class="op">(</span>t<span class="op">)(</span>f<span class="op">)</span></span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>Now the examples. This is simple enough that we can try the
    entire truth table.</p>
    <p>では、例を見てみよう。<code>and</code>
    は単純なので、真理値表の全ての組み合わせを試すことができる。</p>
    <div class="sourceCode" id="cb141"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="fu">and</span><span class="op">(</span>True<span class="op">,</span> True<span class="op">).</span>`if`<span class="op">(</span><span class="st">&quot;yes&quot;</span><span class="op">)(</span><span class="st">&quot;no&quot;</span><span class="op">)</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: String = &quot;yes&quot;</span></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a><span class="fu">and</span><span class="op">(</span>True<span class="op">,</span> False<span class="op">).</span>`if`<span class="op">(</span><span class="st">&quot;yes&quot;</span><span class="op">)(</span><span class="st">&quot;no&quot;</span><span class="op">)</span></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: String = &quot;no&quot;</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a><span class="fu">and</span><span class="op">(</span>False<span class="op">,</span> True<span class="op">).</span>`if`<span class="op">(</span><span class="st">&quot;yes&quot;</span><span class="op">)(</span><span class="st">&quot;no&quot;</span><span class="op">)</span></span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: String = &quot;no&quot;</span></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a><span class="fu">and</span><span class="op">(</span>False<span class="op">,</span> False<span class="op">).</span>`if`<span class="op">(</span><span class="st">&quot;yes&quot;</span><span class="op">)(</span><span class="st">&quot;no&quot;</span><span class="op">)</span></span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: String = &quot;no&quot;</span></span></code></pre></div>
    <h4 class="unnumbered" id="演習-bool-余データへの-or-と-not-の実装">演習: <code>Bool</code>
    余データへの <code>or</code> と <code>not</code>　の実装</h4>
    <p>Test your understanding of <code>Bool</code> by implementing
    <code>or</code> and <code>not</code> in the same way we implemented
    <code>and</code> above.</p>
    <p><code>Bool</code> 余データについての理解度を確認するため、上記の
    <code>and</code> を実装したのと同じ方法で <code>or</code> と
    <code>not</code> を実装せよ。</p>
    <div class="solution">
    <p>We can follow the same structure as <code>and</code>.</p>
    <p><code>and</code> と同じ構造に従って実装することができる。</p>
    <div class="sourceCode" id="cb142"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">or</span><span class="op">(</span>l<span class="op">:</span> Bool<span class="op">,</span> r<span class="op">:</span> Bool<span class="op">):</span> Bool <span class="op">=</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> Bool <span class="op">{</span></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> `if`<span class="op">[</span>A<span class="op">](</span>t<span class="op">:</span> A<span class="op">)(</span>f<span class="op">:</span> A<span class="op">):</span> A <span class="op">=</span></span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>      l<span class="op">.</span>`if`<span class="op">(</span>True<span class="op">)(</span>r<span class="op">).</span>`if`<span class="op">(</span>t<span class="op">)(</span>f<span class="op">)</span></span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">not</span><span class="op">(</span>b<span class="op">:</span> Bool<span class="op">):</span> Bool <span class="op">=</span></span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> Bool <span class="op">{</span></span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> `if`<span class="op">[</span>A<span class="op">](</span>t<span class="op">:</span> A<span class="op">)(</span>f<span class="op">:</span> A<span class="op">):</span> A <span class="op">=</span></span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a>      b<span class="op">.</span>`if`<span class="op">(</span>False<span class="op">)(</span>True<span class="op">).</span>`if`<span class="op">(</span>t<span class="op">)(</span>f<span class="op">)</span></span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>Once again, we can test the entire truth table.</p>
    <p>これらについても、真理値表の全ての組み合わせを確認しておこう。</p>
    <div class="sourceCode" id="cb143"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="fu">or</span><span class="op">(</span>True<span class="op">,</span> True<span class="op">).</span>`if`<span class="op">(</span><span class="st">&quot;yes&quot;</span><span class="op">)(</span><span class="st">&quot;no&quot;</span><span class="op">)</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: String = &quot;yes&quot;</span></span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a><span class="fu">or</span><span class="op">(</span>True<span class="op">,</span> False<span class="op">).</span>`if`<span class="op">(</span><span class="st">&quot;yes&quot;</span><span class="op">)(</span><span class="st">&quot;no&quot;</span><span class="op">)</span></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res6: String = &quot;yes&quot;</span></span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a><span class="fu">or</span><span class="op">(</span>False<span class="op">,</span> True<span class="op">).</span>`if`<span class="op">(</span><span class="st">&quot;yes&quot;</span><span class="op">)(</span><span class="st">&quot;no&quot;</span><span class="op">)</span></span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a><span class="co">// res7: String = &quot;yes&quot;</span></span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a><span class="fu">or</span><span class="op">(</span>False<span class="op">,</span> False<span class="op">).</span>`if`<span class="op">(</span><span class="st">&quot;yes&quot;</span><span class="op">)(</span><span class="st">&quot;no&quot;</span><span class="op">)</span></span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a><span class="co">// res8: String = &quot;no&quot;</span></span>
<span id="cb143-9"><a href="#cb143-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-10"><a href="#cb143-10" aria-hidden="true" tabindex="-1"></a><span class="fu">not</span><span class="op">(</span>True<span class="op">).</span>`if`<span class="op">(</span><span class="st">&quot;yes&quot;</span><span class="op">)(</span><span class="st">&quot;no&quot;</span><span class="op">)</span></span>
<span id="cb143-11"><a href="#cb143-11" aria-hidden="true" tabindex="-1"></a><span class="co">// res9: String = &quot;no&quot;</span></span>
<span id="cb143-12"><a href="#cb143-12" aria-hidden="true" tabindex="-1"></a><span class="fu">not</span><span class="op">(</span>False<span class="op">).</span>`if`<span class="op">(</span><span class="st">&quot;yes&quot;</span><span class="op">)(</span><span class="st">&quot;no&quot;</span><span class="op">)</span></span>
<span id="cb143-13"><a href="#cb143-13" aria-hidden="true" tabindex="-1"></a><span class="co">// res10: String = &quot;yes&quot;</span></span></code></pre></div>
    </div>
    <p>Notice that, once again, computation only happens on demand. In
    this case, nothing happens until <code>if</code> is actually called.
    Until that point we’re just building up a representation of what we
    want to happen. This again points to how codata can handle infinite
    data, by only computing the finite amount required by the actual
    computation.</p>
    <p>ここでもやはり、計算は要求されたときにだけ実行されるという点に注目してほしい。これらの例では、<code>if</code>
    が実際に呼び出されるまで何も起こらない。その時点までは、実行したい処理の表現を組み立てているだけである。余データがいかにして無限のデータを扱うか、実際に必要な有限の量だけが計算される仕組みによってそれが実現されている、ということが、ここでも示されている。</p>
    <p>The rules here for converting from data to codata are:</p>
    <p>データから余データに変換する際のルールを以下に挙げる。</p>
    <ol type="1">
    <li><p>On the interface (<code>trait</code>) defining the codata,
    define a method with the same signature as
    <code>fold</code>.</p></li>
    <li><p>Define an implementation of the interface for each product
    case in the data. The data’s constructor arguments become
    constructor arguments on the codata <code>classes</code>. If there
    are no constructor arguments, as in <code>Bool</code>, we can define
    values instead of classes.</p></li>
    <li><p>Each implementation implements the case of <code>fold</code>
    that it corresponds to.</p></li>
    <li><p>余データを定義するインターフェース（<code>trait</code>）上に、<code>fold</code>
    と同シグネチャのメソッドを定義する</p></li>
    <li><p>データにおける積のそれぞれについて、上記インターフェースの実装を定義する。データのコンストラクタ引数は、余データ
    <code>class</code>
    におけるコンストラクタ引数となる。<code>Bool</code>
    のようにコンストラクタが引数をもたない場合は、クラスの代わりに値を定義すればよい</p></li>
    <li><p>各実装クラスは、対応する <code>fold</code>
    のケースを実装する</p></li>
    </ol>
    <p>Let’s apply this to a slightly more complex example:
    <code>List</code>. We’ll start by defining it as data and
    implementing <code>fold</code>. I’ve chosen to implement
    <code>foldRight</code> but <code>foldLeft</code> would be just as
    good.</p>
    <div class="sourceCode" id="cb144"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>enum <span class="ex">List</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">:</span> A<span class="op">,</span> tail<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">])</span></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> foldRight<span class="op">[</span>B<span class="op">](</span>empty<span class="op">:</span> B<span class="op">)(</span>f<span class="op">:</span> <span class="op">(</span>A<span class="op">,</span> B<span class="op">)</span> <span class="op">=&gt;</span> B<span class="op">):</span> B <span class="op">=</span></span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span> </span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">,</span> tail<span class="op">)</span> <span class="op">=&gt;</span> <span class="fu">f</span><span class="op">(</span>head<span class="op">,</span> tail<span class="op">.</span><span class="fu">foldRight</span><span class="op">(</span>empty<span class="op">)(</span>f<span class="op">))</span></span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span> <span class="op">=&gt;</span> empty</span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Now let’s implement it as codata. We start by defining the
    interface with the <code>fold</code> method. In this case I’m
    calling it <code>foldRight</code> as it’s going to exactly mirror
    the <code>foldRight</code> we just defined.</p>
    <div class="sourceCode" id="cb145"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> foldRight<span class="op">[</span>B<span class="op">](</span>empty<span class="op">:</span> B<span class="op">)(</span>f<span class="op">:</span> <span class="op">(</span>A<span class="op">,</span> B<span class="op">)</span> <span class="op">=&gt;</span> B<span class="op">):</span> B</span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Now we define the implementations. There is one for
    <code>Pair</code> and one for <code>Empty</code>, which are the two
    cases in data definition of <code>List</code>. Notice that in this
    case the classes have constructor arguments, which correspond to the
    constructor arguments on the correspnding product types.</p>
    <div class="sourceCode" id="cb146"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="kw">class</span> <span class="bu">Pair</span><span class="op">[</span>A<span class="op">](</span>head<span class="op">:</span> A<span class="op">,</span> tail<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">])</span> <span class="kw">extends</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> foldRight<span class="op">[</span>B<span class="op">](</span>empty<span class="op">:</span> B<span class="op">)(</span>f<span class="op">:</span> <span class="op">(</span>A<span class="op">,</span> B<span class="op">)</span> <span class="op">=&gt;</span> B<span class="op">):</span> B <span class="op">=</span></span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="kw">class</span> Empty<span class="op">[</span>A<span class="op">]()</span> <span class="kw">extends</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> foldRight<span class="op">[</span>B<span class="op">](</span>empty<span class="op">:</span> B<span class="op">)(</span>f<span class="op">:</span> <span class="op">(</span>A<span class="op">,</span> B<span class="op">)</span> <span class="op">=&gt;</span> B<span class="op">):</span> B <span class="op">=</span></span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>I didn’t implement the bodies of<code>foldRight</code> so I could
    show this as a separate step. The implementation here directly
    mirrors <code>foldRight</code> on the data implementation, and we
    can use the same strategies to implement the codata equivalents.
    That is to say, we can use the recursion rule, reasoning by case,
    and following the types. I’m going to skip these details as we’ve
    already gone through them in depth. The final code is shown
    below.</p>
    <div class="sourceCode" id="cb147"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="kw">class</span> <span class="bu">Pair</span><span class="op">[</span>A<span class="op">](</span>head<span class="op">:</span> A<span class="op">,</span> tail<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">])</span> <span class="kw">extends</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> foldRight<span class="op">[</span>B<span class="op">](</span>empty<span class="op">:</span> B<span class="op">)(</span>f<span class="op">:</span> <span class="op">(</span>A<span class="op">,</span> B<span class="op">)</span> <span class="op">=&gt;</span> B<span class="op">):</span> B <span class="op">=</span></span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">f</span><span class="op">(</span>head<span class="op">,</span> tail<span class="op">.</span><span class="fu">foldRight</span><span class="op">(</span>empty<span class="op">)(</span>f<span class="op">))</span></span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="kw">class</span> Empty<span class="op">[</span>A<span class="op">]()</span> <span class="kw">extends</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> foldRight<span class="op">[</span>B<span class="op">](</span>empty<span class="op">:</span> B<span class="op">)(</span>f<span class="op">:</span> <span class="op">(</span>A<span class="op">,</span> B<span class="op">)</span> <span class="op">=&gt;</span> B<span class="op">):</span> B <span class="op">=</span></span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a>    empty</span>
<span id="cb147-9"><a href="#cb147-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>This code is almost the same as the dynamic dispatch
    implementation, which again shows the relationship between codata
    and object-oriented code.</p>
    <p>The transformation from data to codata goes under several names:
    <strong>refunctionalization</strong>, <strong>Church
    encoding</strong>, and <strong>Böhm-Berarducci encoding</strong>.
    The latter two terms specifically refer to transformations into the
    untyped and typed lambda calculus respectively. The lambda calculus
    is a simple model programming language that contains only functions.
    We’re going to take a quick detour to show that we can, indeed,
    encode lists using just functions. This demonstrates that objects
    and functions have equivalent power.</p>
    <p>The starting point is creating a type alias <code>List</code>,
    which defines a list as a fold. This uses a polymorphic function
    type, which is new in Scala 3. Inspect the type signature and you’ll
    see it is the same as <code>foldRight</code> above.</p>
    <div class="sourceCode" id="cb148"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">,</span> B<span class="op">]</span> <span class="op">=</span> <span class="op">(</span>B<span class="op">,</span> <span class="op">(</span>A<span class="op">,</span> B<span class="op">)</span> <span class="op">=&gt;</span> B<span class="op">)</span> <span class="op">=&gt;</span> B</span></code></pre></div>
    <p>Now we can define <code>Pair</code> and <code>Empty</code> as
    functions. The first parameter list is the constructor arguments,
    and the second parameter list is the parameters for
    <code>foldRight</code>.</p>
    <div class="sourceCode" id="cb149"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> Empty<span class="op">:</span> <span class="op">[</span>A<span class="op">,</span> B<span class="op">]</span> <span class="op">=&gt;</span> <span class="op">()</span> <span class="op">=&gt;</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">,</span> B<span class="op">]</span> <span class="op">=</span> </span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>A<span class="op">,</span> B<span class="op">]</span> <span class="op">=&gt;</span> <span class="op">()</span> <span class="op">=&gt;</span> <span class="op">(</span>empty<span class="op">,</span> f<span class="op">)</span> <span class="op">=&gt;</span> empty</span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="bu">Pair</span><span class="op">:</span> <span class="op">[</span>A<span class="op">,</span> B<span class="op">]</span> <span class="op">=&gt;</span> <span class="op">(</span>A<span class="op">,</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">,</span> B<span class="op">])</span> <span class="op">=&gt;</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">,</span> B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>A<span class="op">,</span> B<span class="op">]</span> <span class="op">=&gt;</span> <span class="op">(</span>head<span class="op">:</span> A<span class="op">,</span> tail<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">,</span> B<span class="op">])</span> <span class="op">=&gt;</span> <span class="op">(</span>empty<span class="op">,</span> f<span class="op">)</span> <span class="op">=&gt;</span> </span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">f</span><span class="op">(</span>head<span class="op">,</span> <span class="fu">tail</span><span class="op">(</span>empty<span class="op">,</span> f<span class="op">))</span></span></code></pre></div>
    <p>Finally, let’s see an example to show it working. We will first
    define the list containing <code>1</code>, <code>2</code>,
    <code>3</code>. Due to a restriction in polymorphic function types,
    I have to add the useless empty parameter.</p>
    <div class="sourceCode" id="cb150"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> list<span class="op">:</span> <span class="op">[</span>B<span class="op">]</span> <span class="op">=&gt;</span> <span class="op">()</span> <span class="op">=&gt;</span> <span class="ex">List</span><span class="op">[</span><span class="bu">Int</span><span class="op">,</span> B<span class="op">]</span> <span class="op">=</span> </span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">[</span>B<span class="op">]</span> <span class="op">=&gt;</span> <span class="op">()</span> <span class="op">=&gt;</span> <span class="bu">Pair</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="bu">Pair</span><span class="op">(</span><span class="dv">2</span><span class="op">,</span> <span class="bu">Pair</span><span class="op">(</span><span class="dv">3</span><span class="op">,</span> <span class="fu">Empty</span><span class="op">())))</span></span></code></pre></div>
    <p>Now we can compute the sum and product of the elements in this
    list.</p>
    <div class="sourceCode" id="cb151"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> sum <span class="op">=</span> <span class="fu">list</span><span class="op">()(</span><span class="dv">0</span><span class="op">,</span> <span class="op">(</span>a<span class="op">,</span> b<span class="op">)</span> <span class="op">=&gt;</span> a <span class="op">+</span> b<span class="op">)</span></span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a><span class="co">// sum: Int = 6</span></span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> product <span class="op">=</span> <span class="fu">list</span><span class="op">()(</span><span class="dv">1</span><span class="op">,</span> <span class="op">(</span>a<span class="op">,</span> b<span class="op">)</span> <span class="op">=&gt;</span> a <span class="op">*</span> b<span class="op">)</span></span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a><span class="co">// product: Int = 6</span></span></code></pre></div>
    <p>It works!</p>
    <p>The purpose of this little demonstration is to show that
    functions are just objects (in the codata sense) with a single
    method. Scala this makes apparent, as functions <em>are</em> objects
    with an <code>apply</code> method.</p>
    <p>We’ve seen that data can be translated to codata. The reverse is
    also possible: we simply tabulate the results of each possible
    method call. In other words, the data representation is memoisation,
    a lookup table, or a cache.</p>
    <p>Although we can convert data to codata and vice versa, there are
    good reasons to choose one over the other. We’ve already seen one
    reason: with codata we can represent infinite structures. In this
    next section we’ll see another difference: the extensibility that
    data and codata permit.</p>
    <h2 data-number="3.5" id="data-and-codata-extensibility"><span class="header-section-number">3.5</span> Data and Codata
    Extensibility</h2>
    <p>We have seen that codata can represent types with an infinite
    number of elements, such as <code>Stream</code>. This is one
    expressive difference from data, which must always be finite. We’ll
    now look at another, which is the type of extensibility we get from
    data and from codata. Together these gives use guidelines to choose
    between the two.</p>
    <p>Firstly, let’s define extensibility. It means the ability to add
    new features without modifying existing code. (If we allow
    modification of existing code then any extension becomes trivial.)
    In particular there are two dimension along which we can extend
    code: adding new functions or adding new elements. We will see that
    data and codata have orthogonal extensibility: it’s easy to add new
    functions to data but adding new elements is impossible without
    modifying existing code, while adding new elements to codata is
    straight-forward but adding new functions is not.</p>
    <p>Let’s start with a concrete example of both data and codata. For
    data we’ll use the familiar <code>List</code> type.</p>
    <div class="sourceCode" id="cb152"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>enum <span class="ex">List</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">:</span> A<span class="op">,</span> tail<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">])</span></span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>For codata, we’ll use <code>Set</code> as our exemplar.</p>
    <div class="sourceCode" id="cb153"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">contains</span><span class="op">(</span>elt<span class="op">:</span> A<span class="op">):</span> <span class="ex">Boolean</span></span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">insert</span><span class="op">(</span>elt<span class="op">:</span> A<span class="op">):</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span></span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">union</span><span class="op">(</span>that<span class="op">:</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]):</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span></span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>We know there are lots of methods we can define on
    <code>List</code>. The standard library is full of them! We also
    know that any method we care to write can be written using
    structural recursion. Finally, we can write these methods without
    modifying existing code.</p>
    <p>Imagine <code>filter</code> was not defined on <code>List</code>.
    We can easily implement it as</p>
    <div class="sourceCode" id="cb154"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="ex">List</span><span class="op">.*</span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> filter<span class="op">[</span>A<span class="op">](</span>list<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">],</span> pred<span class="op">:</span> A <span class="op">=&gt;</span> <span class="ex">Boolean</span><span class="op">):</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> </span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>  list <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span> <span class="op">=&gt;</span> <span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">,</span> tail<span class="op">)</span> <span class="op">=&gt;</span> </span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="fu">pred</span><span class="op">(</span>head<span class="op">)</span> then <span class="bu">Pair</span><span class="op">(</span>head<span class="op">,</span> <span class="fu">filter</span><span class="op">(</span>tail<span class="op">,</span> pred<span class="op">))</span></span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> <span class="fu">filter</span><span class="op">(</span>tail<span class="op">,</span> pred<span class="op">)</span></span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>We could even use an extension method to make it appear as a
    normal method.</p>
    <div class="sourceCode" id="cb155"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>extension <span class="op">[</span>A<span class="op">](</span>list<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">])</span> <span class="op">{</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">filter</span><span class="op">(</span>pred<span class="op">:</span> A <span class="op">=&gt;</span> <span class="ex">Boolean</span><span class="op">):</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> </span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>    list <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Empty</span><span class="op">()</span> <span class="op">=&gt;</span> <span class="fu">Empty</span><span class="op">()</span></span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="bu">Pair</span><span class="op">(</span>head<span class="op">,</span> tail<span class="op">)</span> <span class="op">=&gt;</span> </span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="fu">pred</span><span class="op">(</span>head<span class="op">)</span> then <span class="bu">Pair</span><span class="op">(</span>head<span class="op">,</span> tail<span class="op">.</span><span class="fu">filter</span><span class="op">(</span>pred<span class="op">))</span></span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> tail<span class="op">.</span><span class="fu">filter</span><span class="op">(</span>pred<span class="op">)</span></span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>This shows we can add new functions to data without issue.</p>
    <p>What about adding new elements to data? Perhaps we want to add a
    special case to optimize single-element lists. This is impossible
    without changing existing code. By definition, we cannot add a new
    element to an <code>enum</code> without changing the
    <code>enum</code>. Adding such a new element would break all
    existing pattern matches, and so require they all change. So in
    summary we can add new functions to data, but not new elements.</p>
    <p>Now let’s look at codata. This has the opposite extensibility;
    duality strikes again! In the codata case we can easily add new
    elements. We simply implement the <code>trait</code> that defines
    the codata interface. We saw this when we defined, for example,
    <code>ListSet</code>.</p>
    <div class="sourceCode" id="cb156"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="kw">class</span> ListSet<span class="op">[</span>A<span class="op">](</span>elements<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">])</span> <span class="kw">extends</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">contains</span><span class="op">(</span>elt<span class="op">:</span> A<span class="op">):</span> <span class="ex">Boolean</span> <span class="op">=</span></span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a>    elements<span class="op">.</span><span class="fu">contains</span><span class="op">(</span>elt<span class="op">)</span></span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">insert</span><span class="op">(</span>elt<span class="op">:</span> A<span class="op">):</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ListSet</span><span class="op">(</span>elt <span class="op">::</span> elements<span class="op">)</span></span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-9"><a href="#cb156-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">union</span><span class="op">(</span>that<span class="op">:</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]):</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb156-10"><a href="#cb156-10" aria-hidden="true" tabindex="-1"></a>    elements<span class="op">.</span><span class="fu">foldLeft</span><span class="op">(</span>that<span class="op">)</span> <span class="op">{</span> <span class="op">(</span>set<span class="op">,</span> elt<span class="op">)</span> <span class="op">=&gt;</span> set<span class="op">.</span><span class="fu">insert</span><span class="op">(</span>elt<span class="op">)</span> <span class="op">}</span></span>
<span id="cb156-11"><a href="#cb156-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb156-12"><a href="#cb156-12" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> ListSet <span class="op">{</span></span>
<span id="cb156-13"><a href="#cb156-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> empty<span class="op">[</span>A<span class="op">]:</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> <span class="fu">ListSet</span><span class="op">(</span><span class="ex">List</span><span class="op">.</span>empty<span class="op">)</span></span>
<span id="cb156-14"><a href="#cb156-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>What about adding new functionality? If the functionality can be
    defined in terms of existing functionality then we’re ok. We can
    easily define this functionality, and we can use the extension
    method trick to make it appear like a built-in. However, if we want
    to define a function that cannot be expressed in terms of existing
    functions we are out of luck. Let’s saw we want to define some kind
    of iterator over the elements of a <code>Set</code>. We might use a
    <code>LazyList</code>, the standard library’s equivalent of
    <code>Stream</code> we defined earlier, because we know some sets
    have an infinite number of elements. Well, we can’t do this without
    changing the definition of <code>Set</code>, which in turn breaks
    all existing implementations. We cannot define it in a different way
    because we don’t know all the possible implementations of
    <code>Set</code>.</p>
    <p>So in summary we can add new elements to codata, but not new
    functions.</p>
    <p>If we tabulate this we clearly see that data and codata have
    orthogonal extensibility.</p>
    <div class="table-responsive">
    <table style="width:44%;">
    <colgroup>
    <col style="width: 22%" />
    <col style="width: 9%" />
    <col style="width: 12%" />
    </colgroup>
    <thead>
    <tr class="header">
    <th>Extension</th>
    <th>Data</th>
    <th>Codata</th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td>Add elements</td>
    <td>No</td>
    <td>Yes</td>
    </tr>
    <tr class="even">
    <td>Add functions</td>
    <td>Yes</td>
    <td>No</td>
    </tr>
    </tbody>
    </table>
    </div>
    <p>This difference in extensibility gives us another rule for
    choosing between data and codata as an implementation strategy, in
    addition to the finite vs infinite distinction we saw earlier. If we
    want extensibilty of functions but not elements we should use data.
    If we have a fixed interface but an unknown number of possible
    implementations we should use codata.</p>
    <p>You might wonder if we can have both forms of extensibility.
    Achieving this is called the <strong>expression problem</strong>.
    There are various ways to solve the expression problem, and we’ll
    see one that works particularly well in Scala in a later
    chapter.</p>
    <h2 data-number="3.6" id="exercise-sets"><span class="header-section-number">3.6</span> Exercise: Sets</h2>
    <p>In this extended exercise we’ll explore the <code>Set</code>
    interface we have already used in several examples, reproduced
    below.</p>
    <div class="sourceCode" id="cb157"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">/**</span> True if this set contains the given element <span class="co">*/</span></span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">contains</span><span class="op">(</span>elt<span class="op">:</span> A<span class="op">):</span> <span class="ex">Boolean</span></span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">/**</span> Construct a new set containing the given element <span class="co">*/</span></span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">insert</span><span class="op">(</span>elt<span class="op">:</span> A<span class="op">):</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span></span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">/**</span> Construct the union of this and that set <span class="co">*/</span></span>
<span id="cb157-10"><a href="#cb157-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">union</span><span class="op">(</span>that<span class="op">:</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]):</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span></span>
<span id="cb157-11"><a href="#cb157-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>We also saw a simple implementation, storing the elements in the
    set in a <code>List</code>.</p>
    <div class="sourceCode" id="cb158"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="kw">class</span> ListSet<span class="op">[</span>A<span class="op">](</span>elements<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">])</span> <span class="kw">extends</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">contains</span><span class="op">(</span>elt<span class="op">:</span> A<span class="op">):</span> <span class="ex">Boolean</span> <span class="op">=</span></span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a>    elements<span class="op">.</span><span class="fu">contains</span><span class="op">(</span>elt<span class="op">)</span></span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">insert</span><span class="op">(</span>elt<span class="op">:</span> A<span class="op">):</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ListSet</span><span class="op">(</span>elt <span class="op">::</span> elements<span class="op">)</span></span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-9"><a href="#cb158-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">union</span><span class="op">(</span>that<span class="op">:</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]):</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb158-10"><a href="#cb158-10" aria-hidden="true" tabindex="-1"></a>    elements<span class="op">.</span><span class="fu">foldLeft</span><span class="op">(</span>that<span class="op">)</span> <span class="op">{</span> <span class="op">(</span>set<span class="op">,</span> elt<span class="op">)</span> <span class="op">=&gt;</span> set<span class="op">.</span><span class="fu">insert</span><span class="op">(</span>elt<span class="op">)</span> <span class="op">}</span></span>
<span id="cb158-11"><a href="#cb158-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb158-12"><a href="#cb158-12" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> ListSet <span class="op">{</span></span>
<span id="cb158-13"><a href="#cb158-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> empty<span class="op">[</span>A<span class="op">]:</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> <span class="fu">ListSet</span><span class="op">(</span><span class="ex">List</span><span class="op">.</span>empty<span class="op">)</span></span>
<span id="cb158-14"><a href="#cb158-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>The implementation for <code>union</code> is a bit
    unsatisfactory; it’s doesn’t use any of our strategies for writing
    code. We can implement both <code>union</code> and
    <code>insert</code> in a generic way that works for <em>all</em>
    sets (in other words, is implemented on the <code>Set</code> trait)
    and uses the strategies we’ve seen in this chapter. Go ahead and do
    this.</p>
    <div class="solution">
    <p>I used structural corecursion to implement these methods. I
    decided to name the subclasses, as I think it’s a little bit clearer
    what’s going on in this case.</p>
    <div class="sourceCode" id="cb159"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">contains</span><span class="op">(</span>elt<span class="op">:</span> A<span class="op">):</span> <span class="ex">Boolean</span></span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">insert</span><span class="op">(</span>elt<span class="op">:</span> A<span class="op">):</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">InsertOneSet</span><span class="op">(</span>elt<span class="op">,</span> <span class="kw">this</span><span class="op">)</span></span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">union</span><span class="op">(</span>that<span class="op">:</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]):</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">UnionSet</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb159-10"><a href="#cb159-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb159-11"><a href="#cb159-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-12"><a href="#cb159-12" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="kw">class</span> InsertOneSet<span class="op">[</span>A<span class="op">](</span>element<span class="op">:</span> A<span class="op">,</span> source<span class="op">:</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">])</span> </span>
<span id="cb159-13"><a href="#cb159-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">extends</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb159-14"><a href="#cb159-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-15"><a href="#cb159-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">contains</span><span class="op">(</span>elt<span class="op">:</span> A<span class="op">):</span> <span class="ex">Boolean</span> <span class="op">=</span></span>
<span id="cb159-16"><a href="#cb159-16" aria-hidden="true" tabindex="-1"></a>    elt <span class="op">==</span> element <span class="op">||</span> source<span class="op">.</span><span class="fu">contains</span><span class="op">(</span>elt<span class="op">)</span></span>
<span id="cb159-17"><a href="#cb159-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb159-18"><a href="#cb159-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-19"><a href="#cb159-19" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="kw">class</span> UnionSet<span class="op">[</span>A<span class="op">](</span>first<span class="op">:</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">],</span> second<span class="op">:</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">])</span></span>
<span id="cb159-20"><a href="#cb159-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">extends</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb159-21"><a href="#cb159-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-22"><a href="#cb159-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">contains</span><span class="op">(</span>elt<span class="op">:</span> A<span class="op">):</span> <span class="ex">Boolean</span> <span class="op">=</span></span>
<span id="cb159-23"><a href="#cb159-23" aria-hidden="true" tabindex="-1"></a>    first<span class="op">.</span><span class="fu">contains</span><span class="op">(</span>elt<span class="op">)</span> <span class="op">||</span> second<span class="op">.</span><span class="fu">contains</span><span class="op">(</span>elt<span class="op">)</span></span>
<span id="cb159-24"><a href="#cb159-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    </div>
    <p>Your next challenge is to implement <code>Evens</code>, the set
    of all even integers, which we’ll represent as a
    <code>Set[Int]</code>. This is an infinite set; we cannot directly
    enumerate all the elements in this set. (We actually could enumerate
    all the even elements that are 32-bit <code>Ints</code>, but we
    don’t want to as this would use excessive amounts of space.)</p>
    <div class="solution">
    <p>I implemented <code>Evens</code> using an <code>object</code>.
    This is possible because all possible instances of this set are the
    same, so we only need one instance.</p>
    <div class="sourceCode" id="cb160"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Evens <span class="kw">extends</span> <span class="ex">Set</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">{</span></span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">contains</span><span class="op">(</span>elt<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="ex">Boolean</span> <span class="op">=</span></span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span>elt <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>It turns out, perhaps surprisingly, that this works. Let’s define
    a few sets using <code>Evens</code> and <code>ListSet</code>.</p>
    <div class="sourceCode" id="cb161"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> evensAndOne <span class="op">=</span> Evens<span class="op">.</span><span class="fu">insert</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> evensAndOthers <span class="op">=</span> </span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>  Evens<span class="op">.</span><span class="fu">union</span><span class="op">(</span>ListSet<span class="op">.</span>empty<span class="op">.</span><span class="fu">insert</span><span class="op">(</span><span class="dv">1</span><span class="op">).</span><span class="fu">insert</span><span class="op">(</span><span class="dv">3</span><span class="op">))</span></span></code></pre></div>
    <p>Now show that they work as expected.</p>
    <div class="sourceCode" id="cb162"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>evensAndOne<span class="op">.</span><span class="fu">contains</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: Boolean = true</span></span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>evensAndOthers<span class="op">.</span><span class="fu">contains</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: Boolean = true</span></span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a>evensAndOne<span class="op">.</span><span class="fu">contains</span><span class="op">(</span><span class="dv">2</span><span class="op">)</span></span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: Boolean = true</span></span>
<span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a>evensAndOthers<span class="op">.</span><span class="fu">contains</span><span class="op">(</span><span class="dv">2</span><span class="op">)</span></span>
<span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: Boolean = true</span></span>
<span id="cb162-9"><a href="#cb162-9" aria-hidden="true" tabindex="-1"></a>evensAndOne<span class="op">.</span><span class="fu">contains</span><span class="op">(</span><span class="dv">3</span><span class="op">)</span></span>
<span id="cb162-10"><a href="#cb162-10" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: Boolean = false</span></span>
<span id="cb162-11"><a href="#cb162-11" aria-hidden="true" tabindex="-1"></a>evensAndOthers<span class="op">.</span><span class="fu">contains</span><span class="op">(</span><span class="dv">3</span><span class="op">)</span></span>
<span id="cb162-12"><a href="#cb162-12" aria-hidden="true" tabindex="-1"></a><span class="co">// res6: Boolean = true</span></span></code></pre></div>
    </div>
    <p>We can generalize this idea to defining sets in terms of
    <strong>indicator functions</strong>, which is a function of type
    <code>A =&gt; Boolean</code>, returning returns true if the input
    belows to the set. Implement <code>IndicatorSet</code>, which is
    constructed with a single indicator function parameter.</p>
    <div class="solution">
    <div class="sourceCode" id="cb163"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="kw">class</span> IndicatorSet<span class="op">[</span>A<span class="op">](</span>indicator<span class="op">:</span> A <span class="op">=&gt;</span> <span class="ex">Boolean</span><span class="op">)</span></span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">extends</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">contains</span><span class="op">(</span>elt<span class="op">:</span> A<span class="op">):</span> <span class="ex">Boolean</span> <span class="op">=</span></span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">indicator</span><span class="op">(</span>elt<span class="op">)</span></span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>To test this, let’s define the infinite set of odd integers.</p>
    <div class="sourceCode" id="cb164"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> odds <span class="op">=</span> IndicatorSet<span class="op">[</span><span class="bu">Int</span><span class="op">](</span>_ <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">1</span><span class="op">)</span></span></code></pre></div>
    <p>Now we’ll show it works as expected.</p>
    <div class="sourceCode" id="cb165"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>odds<span class="op">.</span><span class="fu">contains</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res7: Boolean = true</span></span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>odds<span class="op">.</span><span class="fu">contains</span><span class="op">(</span><span class="dv">2</span><span class="op">)</span></span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res8: Boolean = false</span></span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a>odds<span class="op">.</span><span class="fu">contains</span><span class="op">(</span><span class="dv">3</span><span class="op">)</span></span>
<span id="cb165-6"><a href="#cb165-6" aria-hidden="true" tabindex="-1"></a><span class="co">// res9: Boolean = true</span></span></code></pre></div>
    <p>Taking the union of even and odd integers gives us a set that
    contains all integers.</p>
    <div class="sourceCode" id="cb166"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> integers <span class="op">=</span> Evens<span class="op">.</span><span class="fu">union</span><span class="op">(</span>odds<span class="op">)</span></span></code></pre></div>
    <p>It has the expected behaviour.</p>
    <div class="sourceCode" id="cb167"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a>integers<span class="op">.</span><span class="fu">contains</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res10: Boolean = true</span></span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a>integers<span class="op">.</span><span class="fu">contains</span><span class="op">(</span><span class="dv">2</span><span class="op">)</span></span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res11: Boolean = true</span></span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a>integers<span class="op">.</span><span class="fu">contains</span><span class="op">(</span><span class="dv">3</span><span class="op">)</span></span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a><span class="co">// res12: Boolean = true</span></span></code></pre></div>
    </div>
    <h2 data-number="3.7" id="conclusions-1"><span class="header-section-number">3.7</span> Conclusions</h2>
    <p>In this chapter we’ve explored codata, the dual of data. Codata
    is defined by its interface—what we can do with it—as opposed to
    data, which is defined by what it is. More formally, codata is a
    product of destructors, where destructors are functions from the
    codata type (and, optionally, some other inputs) to some type. By
    avoiding the elements of object-oriented programming that make it
    hard to reason about—state and implementation inheritance—codata
    brings elements of object-oriented programming that accord with the
    other functional programming strategies. In Scala we define codata
    as a <code>trait</code>, and implement it as a
    <code>final class</code>, anonymous subclass, or an object.</p>
    <p>We have two strategies for implementing methods using codata:
    structural corecursion, which we can use when the result is codata,
    and structural recursion, which we can use when an input is codata.
    Structural corecursion is usually the more useful of the two, as it
    gives more structure (pun intended) to the method we are
    implementing. The reverse is true for data.</p>
    <p>We saw that data is connected to codata via fold: any data can
    instead be implemented as codata with a single destructor that is
    the fold for that data. The reverse is also: we can enumerate all
    potential pairs of inputs and outputs of destructors to represent
    codata as data. However this does not mean that data and codata are
    equivalent. We have seen many examples of codata representing
    infinite structures, such as sets of all even numbers and streams of
    all natural numbers. We have also seen that data and codata offer
    different forms of extensibility: data makes it easy to add new
    functions, but adding new elements requires changing existing code,
    while it is easy to add new elements to codata but we change
    existing code if we add new functions.</p>
    <p>The earliest reference I could find to codata in programming
    languages is <span class="citation" data-cites="HAGINO1989629">Hagino [1989]</span>. This is much more
    recent than algebraic data, which I think explains why codata is
    relatively unknown. There are some excellent recent papers that deal
    with codata. I highly recommend <em>Codata in Action</em> <span class="citation" data-cites="downen2019codata">[Downen et al.
    2019]</span>, which inspired large portions of this chapter.
    <em>Exploring Codata: The Relation to Object-Orientation</em> <span class="citation" data-cites="DRP-201905-Sullivan">[Sullivan
    2019]</span> is also worthwhile. <em>How to Add Laziness to a Strict
    Language Without Even Being Odd</em> <span class="citation" data-cites="wadler1998add">[Wadler et al. 1998]</span> is an older
    paper that discusses the implementation of streams, and in
    particular the difference between a not-quite-lazy-enough
    implementation they label odd and the version we saw, which they
    call even. These correspond to <code>Stream</code> and
    <code>LazyList</code> in the Scala standard library respectively.
    <em>Classical (Co)Recursion: Programming</em> <span class="citation" data-cites="DBLP:journals/corr/abs-2103-06913">[Downen and Ariola
    2021]</span> is an interesting survey of corecursion in different
    languages, and covers many of the same examples that I used here.
    Finally, if you really want to get into the weeds of the
    relationship between data and codata, <em>Beyond Church encoding:
    Boehm-Berarducci isomorphism of algebraic data types and polymorphic
    lambda-terms</em> <span class="citation" data-cites="kiselyov05:beyond">[Kiselyov 2005]</span> is for
    you.</p>
    <h1 data-number="4" id="sec:type-classes"><span class="header-section-number">4</span> コンテキスト抽象 Contextual
    Abstraction</h1>
    <p>All but the simplest programs depend on the
    <strong>context</strong> in which they run. The number of available
    CPU cores is an example of context provided by the computer, which a
    program might adapt to by changing how work is distributed. Other
    forms of context include configuration read from files and
    environment variables, and (and we’ll see at lot of this later)
    values created at compile-time, such as serialization formats, in
    response to the type of some method parameters.</p>
    <p>あらゆるプログラムは、もっとも単純なものを除き、それが実行される<strong>コンテキスト</strong>に依存する。利用可能なCPUコア数は、コンピュータが提供するコンテキストの一例であり、プログラムはそれに応じてタスクの分配方法を調整するかもしれない。コンテキストの他の形式としては、ファイルや環境変数から読み取られる設定、そしてシリアライズ形式のようにメソッドパラメータの型に応じてコンパイル時に生成される値などがある。後者については後ほど詳しく述べるつもりである。</p>
    <p>Scala is one of the few languages that provides features for
    <strong>contextual abstraction</strong>, known as
    <strong>implicits</strong> in Scala 2 or <strong>given
    instances</strong> in Scala 3. In Scala these features are
    intimately related to types; types are used to select between
    different available given instances and drive construction of given
    instances at compile-time.</p>
    <p>Scalaは<strong>コンテキスト抽象</strong>のための機能を提供する数少ない言語のひとつである。それはScala2では<strong>implicits</strong>、Scala3では<strong>givenインスタンス</strong>として知られている。Scalaにおけるこれらの機能は型と密接に関連しており、利用可能なgivenインスタンスの選択や、コンパイル時におけるgivenインスタンスの構築は、型を使用して行われる。</p>
    <p>Most Scala programmers are less confident with the features for
    contextual abstraction than with other parts of the language, and
    they are often entirely novel to programmers coming from other
    languages. Hence this chapter will start by reviewing the
    abstractions formely known as implicits: given instances and using
    clauses. We will then look at one of their major uses, <strong>type
    classes</strong><a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>. Type classes allow us to extend
    existing types with new functionality, without using traditional
    inheritance, and without altering the original source code. Type
    classes are the core of Cats, which we will be exploring in the next
    part of this book.</p>
    <p>多くのScalaプログラマは、コンテキスト抽象の機能に関しては、他の言語機能ほど自信を持っていない場合が多く、他の言語から来たプログラマにとっては完全に新しい概念であることも多い。そのため、この章では、以前
    <code>implicit</code>
    と呼ばれていた抽象化や、givenインスタンス、そして <code>using</code>
    句について振り返ることから始める。そして、これらの主要な用途のひとつである<strong>型クラス</strong><a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>について見ていく。
    型クラスを使うと、従来の継承を使わず、元のソースコードを変更することもなく、既存の型を拡張し、新しい機能を追加することができる。型クラスは、この本の次のパートで学んでいくCatsの中心的な要素である。</p>
    <!--
    Type classes work well with another programming pattern: *algebraic data types*.
    These are closed systems of types that we use to represent data or concepts.
    Because the systems are closed (and therefore cannot be extended by other users),
    we can process them using pattern matching
    and the compiler will check the exhaustiveness of our case clauses.

    There are two other patterns we need to cover in this chapter.
    *Value classes* provide a way to wrap up
    generic data types like `Strings` and `Ints`
    and give them specific meanings in a given context.
    The extra type information is useful when type classes.
    *Type aliases* are another pattern that
    provide aliases for large, complex types.
    -->
    <h2 data-number="4.1" id="コンテキスト抽象のメカニズム-the-mechanics-of-contextual-abstraction"><span class="header-section-number">4.1</span>
    コンテキスト抽象のメカニズム The Mechanics of Contextual
    Abstraction</h2>
    <p>In section we’ll go through the main Scala language features for
    contextual abstraction. Once we have a firm understanding of the
    mechanics of contextual abstraction we’ll move on to their use.</p>
    <p>この節では、コンテキスト抽象に関するScalaの主要な言語機能について説明する。コンテキスト抽象のメカニズムをしっかり理解した上で、その具体的な使用方法へと移る。</p>
    <p>The language features for contextual abstraction have changed
    name from Scala 2 to Scala 3, but they work in largely the same way.
    In the table below I show the Scala 3 features, and their Scala 2
    equivalents. If you use Scala 2 you’ll find that most of the code
    works simply by replacing <code>given</code> with
    <code>implicit val</code> and <code>using</code> with
    <code>implicit</code>.</p>
    <p>コンテキスト抽象に関する言語機能の名称はScala2からScala3で変更されているが、動作はほぼ同じである。以下の表にScala3の機能と、それに対応するScala2の機能を示している。Scala2を使用している場合、<code>given</code>
    を <code>implicit val</code> に、<code>using</code> を
    <code>implicit</code>
    に置き換えるだけで多くのコードが動作するだろう。</p>
    <div class="table-responsive">
    <table style="width:57%;">
    <colgroup>
    <col style="width: 26%" />
    <col style="width: 30%" />
    </colgroup>
    <thead>
    <tr class="header">
    <th>Scala3</th>
    <th>Scala2</th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td colspan="2">givenインスタンス | implicit value</td>
    </tr>
    <tr class="even">
    <td>using句</td>
    <td>implicitパラメータ</td>
    </tr>
    </tbody>
    </table>
    </div>
    <p>Let’s now explain how these language features work.</p>
    <p>これらの言語機能がどのように動作するか説明しよう。</p>
    <h3 data-number="4.1.1" id="using-句"><span class="header-section-number">4.1.1</span> <code>using</code>
    句</h3>
    <p>We’ll start with <strong>using clauses</strong>. A using clause
    is a method parameter list that starts with the <code>using</code>
    keyword. We use the term <strong>context parameters</strong> for the
    parameters in a using clause.</p>
    <p>まずは <strong>using 句</strong>から始める。using句とは
    <code>using</code>
    キーワードで始まるメソッドパラメータリストのことをいう。using句内のパラメータのことは<strong>コンテキストパラメータ</strong>という用語で呼ぶ。</p>
    <div class="sourceCode" id="cb168"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="dt">double</span><span class="op">(</span>using x<span class="op">:</span> <span class="bu">Int</span><span class="op">)</span> <span class="op">=</span> x <span class="op">+</span> x</span></code></pre></div>
    <p>The <code>using</code> keyword applies to all parameters in the
    list, so in <code>add</code> below both <code>x</code> and
    <code>y</code> are context parameters.</p>
    <p><code>using</code>
    キーワードは、そのパラメータリスト内にあるすべてのパラメータに効果を及ぼす。次の
    <code>add</code> 関数では、<code>x</code> と <code>y</code>
    の両方がコンテキストパラメータである。</p>
    <div class="sourceCode" id="cb169"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">add</span><span class="op">(</span>using x<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> y<span class="op">:</span> <span class="bu">Int</span><span class="op">)</span> <span class="op">=</span> x <span class="op">+</span> y</span></code></pre></div>
    <p>We can have normal parameter lists, and multiple using clauses,
    in the same method.</p>
    <p>同じメソッドに通常のパラメータリストが存在していてもよいし、using句が複数あってもかまわない。</p>
    <div class="sourceCode" id="cb170"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">addAll</span><span class="op">(</span>x<span class="op">:</span> <span class="bu">Int</span><span class="op">)(</span>using y<span class="op">:</span> <span class="bu">Int</span><span class="op">)(</span>using z<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="bu">Int</span> <span class="op">=</span></span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a>  x <span class="op">+</span> y <span class="op">+</span> z</span></code></pre></div>
    <p>We cannot pass parameters to a using clause in the normal way. We
    must proceed the parameters with the <code>using</code> keyword as
    shown below.</p>
    <p>通常の方法でusing句にパラメータを渡すことはできない。以下に示すように、パラメータの前に
    <code>using</code> キーワードを付けなくてはならない。</p>
    <div class="sourceCode" id="cb171"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span><span class="op">(</span>using <span class="dv">1</span><span class="op">)</span></span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res0: Int = 2</span></span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a><span class="fu">add</span><span class="op">(</span>using <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">)</span></span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: Int = 3</span></span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a><span class="fu">addAll</span><span class="op">(</span><span class="dv">1</span><span class="op">)(</span>using <span class="dv">2</span><span class="op">)(</span>using <span class="dv">3</span><span class="op">)</span></span>
<span id="cb171-6"><a href="#cb171-6" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: Int = 6</span></span></code></pre></div>
    <p>However this is not the typical way to pass parameters. In fact
    we don’t usually explicit pass parameters to using clause at all. We
    usually use given instances instead, so let’s turn to them.</p>
    <p>だが、これはusing句にパラメータを渡す標準的な方法ではない。実際には、using句にパラメータを明示的に渡すことはほとんどない。通常はgivenインスタンスを使用する。次にそれについて説明する。</p>
    <h3 data-number="4.1.2" id="givenインスタンス"><span class="header-section-number">4.1.2</span> givenインスタンス</h3>
    <p>A given instance is a value that is defined with the
    <code>given</code> keyword. Here’s a simple example.</p>
    <p>givenインスタンスは <code>given</code>
    キーワードを使って定義される値である。簡単な例を示そう。</p>
    <div class="sourceCode" id="cb172"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>given theMagicNumber<span class="op">:</span> <span class="bu">Int</span> <span class="op">=</span> <span class="dv">3</span></span></code></pre></div>
    <p>We can use a given instance like a normal value.</p>
    <p>givenインスタンスは普通の値のように使うことができる。</p>
    <div class="sourceCode" id="cb173"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a>theMagicNumber <span class="op">*</span> <span class="dv">2</span></span></code></pre></div>
    <p>However, it’s more common to use them with a using clause. When
    we call a method that has a using clause, and we do not explicitly
    supply values for the context parameters, the compiler will look for
    given instances of the required type. If it finds a given instance
    it will automatically use it to complete the method call.</p>
    <p>だが、using句と組み合わせて使うほうがより一般的である。コンテキストパラメータを明示的に与えないでusing句をもつメソッドを呼び出した場合、要求される型のgivenインスタンスをコンパイラが探してくれる。givenインスタンスが見つかれば、それが自動的にパラメータとして使用され、メソッド呼び出しは完成する。</p>
    <p>For example, we defined <code>double</code> above with a single
    <code>Int</code> context parameter. The given instance we just
    defined, <code>theMagicNumber</code>, also has type
    <code>Int</code>. So if we call <code>double</code> without
    providing any value for the context parameter the compiler will
    provide the value <code>theMagicNumber</code> for us.</p>
    <div class="sourceCode" id="cb174"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span></span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: Int = 6</span></span></code></pre></div>
    <p>The same given instance will be used for multiple parameters in a
    using clause with the same type, as in <code>add</code> defined
    above.</p>
    <div class="sourceCode" id="cb175"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>add</span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: Int = 6</span></span></code></pre></div>
    <p>The above are the most important points for using clauses and
    given instances. We’ll now turn to some of the details of their
    semantics.</p>
    <h3 data-number="4.1.3" id="given-scope-and-imports"><span class="header-section-number">4.1.3</span> Given Scope and
    Imports</h3>
    <p>Given instances are usually not explicitly passed to using
    clauses. Their whole reason for existence is to get the compiler to
    do this for us. This could make code hard to understand, so we need
    to be very clear about which given instances are candidates to be
    supplied to a using clause. In this section we’ll look at the
    <strong>given scope</strong>, which is all the places that the
    compiler will look for given instances, and the special syntax for
    importing given instances.</p>
    <p>The first rule we should know about the given scope is that it
    starts at the <strong>call site</strong>, where the method with a
    using clause is called, not at the <strong>definition site</strong>
    where the method is defined. This means the following code does not
    compile, because the given instance is not in scope at the call
    site, even though it is in scope at the definition site.</p>
    <div class="sourceCode" id="cb176"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> A <span class="op">{</span></span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a>  given a<span class="op">:</span> <span class="bu">Int</span> <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">whichInt</span><span class="op">(</span>using <span class="dt">int</span><span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="bu">Int</span> <span class="op">=</span> <span class="dt">int</span></span>
<span id="cb176-4"><a href="#cb176-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb176-5"><a href="#cb176-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-6"><a href="#cb176-6" aria-hidden="true" tabindex="-1"></a>A<span class="op">.</span>whichInt</span>
<span id="cb176-7"><a href="#cb176-7" aria-hidden="true" tabindex="-1"></a><span class="co">// error:</span></span>
<span id="cb176-8"><a href="#cb176-8" aria-hidden="true" tabindex="-1"></a><span class="co">// No given instance of type Int was found for parameter int of method whichInt in object A</span></span>
<span id="cb176-9"><a href="#cb176-9" aria-hidden="true" tabindex="-1"></a><span class="co">// A.whichInt</span></span>
<span id="cb176-10"><a href="#cb176-10" aria-hidden="true" tabindex="-1"></a><span class="co">//   ^^^^^^^^</span></span></code></pre></div>
    <p>The second rule, which we have been relying on in all our
    examples so far, is that the given scope includes the
    <strong>lexical scope</strong> at the call site. The lexical scope
    is where we usually look up the values associated with names (like
    the names of method parameters or <code>val</code> declarations).
    This means the following code works, as <code>a</code> is defined in
    a scope that includes the call site.</p>
    <div class="sourceCode" id="cb177"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> A <span class="op">{</span></span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a>  given a<span class="op">:</span> <span class="bu">Int</span> <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb177-3"><a href="#cb177-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-4"><a href="#cb177-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">object</span> B <span class="op">{</span></span>
<span id="cb177-5"><a href="#cb177-5" aria-hidden="true" tabindex="-1"></a>    C<span class="op">.</span>whichInt </span>
<span id="cb177-6"><a href="#cb177-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb177-7"><a href="#cb177-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb177-8"><a href="#cb177-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">object</span> C <span class="op">{</span></span>
<span id="cb177-9"><a href="#cb177-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">whichInt</span><span class="op">(</span>using <span class="dt">int</span><span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="bu">Int</span> <span class="op">=</span> <span class="dt">int</span></span>
<span id="cb177-10"><a href="#cb177-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb177-11"><a href="#cb177-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>However, if there are multiple given instances in the same scope
    the compiler will not arbitrarily choose one. Instead it fails with
    an error telling us the choice is ambiguous.</p>
    <div class="sourceCode" id="cb178"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> A <span class="op">{</span></span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a>  given a<span class="op">:</span> <span class="bu">Int</span> <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a>  given b<span class="op">:</span> <span class="bu">Int</span> <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb178-5"><a href="#cb178-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">whichInt</span><span class="op">(</span>using <span class="dt">int</span><span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="bu">Int</span> <span class="op">=</span> <span class="dt">int</span></span>
<span id="cb178-6"><a href="#cb178-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb178-7"><a href="#cb178-7" aria-hidden="true" tabindex="-1"></a>  whichInt</span>
<span id="cb178-8"><a href="#cb178-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb178-9"><a href="#cb178-9" aria-hidden="true" tabindex="-1"></a><span class="co">// error:</span></span>
<span id="cb178-10"><a href="#cb178-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Ambiguous given instances: both given instance a in object A and</span></span>
<span id="cb178-11"><a href="#cb178-11" aria-hidden="true" tabindex="-1"></a><span class="co">// given instance b in object A match type Int of parameter int of </span></span>
<span id="cb178-12"><a href="#cb178-12" aria-hidden="true" tabindex="-1"></a><span class="co">// method whichInt in object A</span></span></code></pre></div>
    <p>We can import given instances from other scopes, just like we can
    import normal declarations, but we must explicitly say we want to
    import given instances. The following code does not work because we
    have not explicitly imported the given instances.</p>
    <div class="sourceCode" id="cb179"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> A <span class="op">{</span></span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>  given a<span class="op">:</span> <span class="bu">Int</span> <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">whichInt</span><span class="op">(</span>using <span class="dt">int</span><span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="bu">Int</span> <span class="op">=</span> <span class="dt">int</span></span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb179-6"><a href="#cb179-6" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> B <span class="op">{</span></span>
<span id="cb179-7"><a href="#cb179-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">import</span> A<span class="op">.*</span></span>
<span id="cb179-8"><a href="#cb179-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb179-9"><a href="#cb179-9" aria-hidden="true" tabindex="-1"></a>  whichInt</span>
<span id="cb179-10"><a href="#cb179-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb179-11"><a href="#cb179-11" aria-hidden="true" tabindex="-1"></a><span class="co">// error:</span></span>
<span id="cb179-12"><a href="#cb179-12" aria-hidden="true" tabindex="-1"></a><span class="co">// No given instance of type Int was found for parameter int of method whichInt in object A</span></span>
<span id="cb179-13"><a href="#cb179-13" aria-hidden="true" tabindex="-1"></a><span class="co">// </span></span>
<span id="cb179-14"><a href="#cb179-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Note: given instance a in object A was not considered because it was not imported with `import given`.</span></span>
<span id="cb179-15"><a href="#cb179-15" aria-hidden="true" tabindex="-1"></a><span class="co">//   whichInt</span></span>
<span id="cb179-16"><a href="#cb179-16" aria-hidden="true" tabindex="-1"></a><span class="co">//           ^</span></span></code></pre></div>
    <p>It works when we do explicitly import them using
    <code>import A.given</code>.</p>
    <div class="sourceCode" id="cb180"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> A <span class="op">{</span></span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a>  given a<span class="op">:</span> <span class="bu">Int</span> <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-4"><a href="#cb180-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">whichInt</span><span class="op">(</span>using <span class="dt">int</span><span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="bu">Int</span> <span class="op">=</span> <span class="dt">int</span></span>
<span id="cb180-5"><a href="#cb180-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb180-6"><a href="#cb180-6" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> B <span class="op">{</span></span>
<span id="cb180-7"><a href="#cb180-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">import</span> A<span class="op">.{</span>given<span class="op">,</span> <span class="op">*}</span></span>
<span id="cb180-8"><a href="#cb180-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb180-9"><a href="#cb180-9" aria-hidden="true" tabindex="-1"></a>  whichInt</span>
<span id="cb180-10"><a href="#cb180-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>One final wrinkle: the given scope includes the companion objects
    of any type involved in the type of the using clause. This is best
    illustrated with an example. We’ll start by defining a type
    <code>Sound</code> that represents the sound made by its type
    variable <code>A</code>, and a method <code>soundOf</code> to access
    that sound.</p>
    <div class="sourceCode" id="cb181"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Sound<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> sound<span class="op">:</span> <span class="ex">String</span></span>
<span id="cb181-3"><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb181-4"><a href="#cb181-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-5"><a href="#cb181-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> soundOf<span class="op">[</span>A<span class="op">](</span>using s<span class="op">:</span> Sound<span class="op">[</span>A<span class="op">]):</span> <span class="ex">String</span> <span class="op">=</span></span>
<span id="cb181-6"><a href="#cb181-6" aria-hidden="true" tabindex="-1"></a>  s<span class="op">.</span>sound</span></code></pre></div>
    <p>Now we’ll define some given instances. Notice that they are
    defined on the relevant companion objects.</p>
    <div class="sourceCode" id="cb182"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Cat</span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Cat <span class="op">{</span></span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a>  given catSound<span class="op">:</span> Sound<span class="op">[</span>Cat<span class="op">]</span> <span class="op">=</span></span>
<span id="cb182-4"><a href="#cb182-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> Sound<span class="op">[</span>Cat<span class="op">]{</span></span>
<span id="cb182-5"><a href="#cb182-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> sound<span class="op">:</span> <span class="ex">String</span> <span class="op">=</span> <span class="st">&quot;meow&quot;</span></span>
<span id="cb182-6"><a href="#cb182-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb182-7"><a href="#cb182-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb182-8"><a href="#cb182-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-9"><a href="#cb182-9" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Dog</span>
<span id="cb182-10"><a href="#cb182-10" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Dog <span class="op">{</span></span>
<span id="cb182-11"><a href="#cb182-11" aria-hidden="true" tabindex="-1"></a>  given dogSound<span class="op">:</span> Sound<span class="op">[</span>Dog<span class="op">]</span> <span class="op">=</span> </span>
<span id="cb182-12"><a href="#cb182-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> Sound<span class="op">[</span>Dog<span class="op">]{</span></span>
<span id="cb182-13"><a href="#cb182-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> sound<span class="op">:</span> <span class="ex">String</span> <span class="op">=</span> <span class="st">&quot;woof&quot;</span></span>
<span id="cb182-14"><a href="#cb182-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb182-15"><a href="#cb182-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>When we call <code>soundOf</code> we don’t have to explicitly
    bring the instances into scope. They are automatically in the given
    scope by virtue of being defined on the companion objects of the
    types we use (<code>Cat</code> and <code>Dog</code>). If we had
    defined these instances on the <code>Sound</code> companion object
    they would also be in the given scope; when looking for a
    <code>Sound[A]</code> both the companion objects of
    <code>Sound</code> and <code>A</code> are in scope.</p>
    <div class="sourceCode" id="cb183"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a>soundOf<span class="op">[</span>Cat<span class="op">]</span></span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res12: String = &quot;meow&quot;</span></span>
<span id="cb183-3"><a href="#cb183-3" aria-hidden="true" tabindex="-1"></a>soundOf<span class="op">[</span>Dog<span class="op">]</span></span>
<span id="cb183-4"><a href="#cb183-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res13: String = &quot;woof&quot;</span></span></code></pre></div>
    <p>We should almost always be defining given instances on companion
    objects. This simple organization scheme means that users do not
    have to explicitly import them but can easily find the
    implementations if they wish to inspect them.</p>
    <h4 data-number="4.1.3.1" id="given-instance-priority"><span class="header-section-number">4.1.3.1</span> Given Instance
    Priority</h4>
    <p>Notice that given instance selection is based entirely on types.
    We don’t even pass any values to <code>soundOf</code>! This means
    given instances are easiest to use when there is only one instance
    for each type. In this case we can just put the instances on a
    relevant companion object and everything works out.</p>
    <p>However, this is not always possible (though it’s often an
    indication of a bad design if it is not). For cases where we need
    multiple instances for a type, we can use the instance priority
    rules to select between them. We’ll look at the three most important
    rules below.</p>
    <p>The first rule is that explicitly passing an instance takes
    priority over everything else.</p>
    <div class="sourceCode" id="cb184"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>given a<span class="op">:</span> <span class="bu">Int</span> <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">whichInt</span><span class="op">(</span>using <span class="dt">int</span><span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="bu">Int</span> <span class="op">=</span> <span class="dt">int</span></span></code></pre></div>
    <div class="sourceCode" id="cb185"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="fu">whichInt</span><span class="op">(</span>using <span class="dv">2</span><span class="op">)</span></span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res15: Int = 2</span></span></code></pre></div>
    <p>The second rule is that instances in the lexical scope take
    priority over instances in a companion object</p>
    <div class="sourceCode" id="cb186"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Sound<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> sound<span class="op">:</span> <span class="ex">String</span></span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Cat</span>
<span id="cb186-5"><a href="#cb186-5" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Cat <span class="op">{</span></span>
<span id="cb186-6"><a href="#cb186-6" aria-hidden="true" tabindex="-1"></a>  given catSound<span class="op">:</span> Sound<span class="op">[</span>Cat<span class="op">]</span> <span class="op">=</span></span>
<span id="cb186-7"><a href="#cb186-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> Sound<span class="op">[</span>Cat<span class="op">]{</span></span>
<span id="cb186-8"><a href="#cb186-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> sound<span class="op">:</span> <span class="ex">String</span> <span class="op">=</span> <span class="st">&quot;meow&quot;</span></span>
<span id="cb186-9"><a href="#cb186-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb186-10"><a href="#cb186-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb186-11"><a href="#cb186-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-12"><a href="#cb186-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> soundOf<span class="op">[</span>A<span class="op">](</span>using s<span class="op">:</span> Sound<span class="op">[</span>A<span class="op">]):</span> <span class="ex">String</span> <span class="op">=</span></span>
<span id="cb186-13"><a href="#cb186-13" aria-hidden="true" tabindex="-1"></a>  s<span class="op">.</span>sound</span></code></pre></div>
    <div class="sourceCode" id="cb187"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a>given purr<span class="op">:</span> Sound<span class="op">[</span>Cat<span class="op">]</span>  <span class="op">=</span></span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> Sound<span class="op">[</span>Cat<span class="op">]{</span></span>
<span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> sound<span class="op">:</span> <span class="ex">String</span> <span class="op">=</span> <span class="st">&quot;purr&quot;</span></span>
<span id="cb187-4"><a href="#cb187-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb187-5"><a href="#cb187-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-6"><a href="#cb187-6" aria-hidden="true" tabindex="-1"></a>soundOf<span class="op">[</span>Cat<span class="op">]</span></span>
<span id="cb187-7"><a href="#cb187-7" aria-hidden="true" tabindex="-1"></a><span class="co">// res17: String = &quot;purr&quot;</span></span></code></pre></div>
    <p>The final rule is that instances in a closer lexical scope take
    preference over those further away.</p>
    <div class="sourceCode" id="cb188"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>  given growl<span class="op">:</span> Sound<span class="op">[</span>Cat<span class="op">]</span> <span class="op">=</span></span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a>   <span class="kw">new</span> Sound<span class="op">[</span>Cat<span class="op">]{</span></span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a>     <span class="kw">def</span> sound<span class="op">:</span> <span class="ex">String</span> <span class="op">=</span> <span class="st">&quot;growl&quot;</span></span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a>   <span class="op">}</span></span>
<span id="cb188-6"><a href="#cb188-6" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb188-7"><a href="#cb188-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb188-8"><a href="#cb188-8" aria-hidden="true" tabindex="-1"></a>    given mew<span class="op">:</span> Sound<span class="op">[</span>Cat<span class="op">]</span> <span class="op">=</span></span>
<span id="cb188-9"><a href="#cb188-9" aria-hidden="true" tabindex="-1"></a>     <span class="kw">new</span> Sound<span class="op">[</span>Cat<span class="op">]{</span></span>
<span id="cb188-10"><a href="#cb188-10" aria-hidden="true" tabindex="-1"></a>       <span class="kw">def</span> sound<span class="op">:</span> <span class="ex">String</span> <span class="op">=</span> <span class="st">&quot;mew&quot;</span></span>
<span id="cb188-11"><a href="#cb188-11" aria-hidden="true" tabindex="-1"></a>     <span class="op">}</span></span>
<span id="cb188-12"><a href="#cb188-12" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb188-13"><a href="#cb188-13" aria-hidden="true" tabindex="-1"></a>    soundOf<span class="op">[</span>Cat<span class="op">]</span></span>
<span id="cb188-14"><a href="#cb188-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb188-15"><a href="#cb188-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb188-16"><a href="#cb188-16" aria-hidden="true" tabindex="-1"></a><span class="co">// res18: String = &quot;mew&quot;</span></span></code></pre></div>
    <p>We’re now seen most of the details of how given instances and
    using clauses work. This is a craft level explanation, and it
    naturally leads to the question: where would use these tools? This
    is what we’ll address next, where we look at type classes and their
    implementation in Scala.</p>
    <h2 data-number="4.2" id="anatomy-of-a-type-class"><span class="header-section-number">4.2</span> Anatomy of a Type
    Class</h2>
    <p>Let’s now look at how type classes are implemented. There are
    three important components to a type class: the type class itself,
    which defines an interface, type class instances, which implement
    the type class for particular types, and the methods that use type
    classes. The table below shows the language features that correspond
    to each component.</p>
    <div class="table-responsive">
    <table style="width:57%;">
    <colgroup>
    <col style="width: 30%" />
    <col style="width: 26%" />
    </colgroup>
    <thead>
    <tr class="header">
    <th>Type Class Concept</th>
    <th>Language Feature</th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td>Type class</td>
    <td>trait</td>
    </tr>
    <tr class="even">
    <td>Type class instance</td>
    <td>given instance</td>
    </tr>
    <tr class="odd">
    <td>Type class use</td>
    <td>using clause</td>
    </tr>
    </tbody>
    </table>
    </div>
    <p>Let’s see how this works in detail.</p>
    <h3 data-number="4.2.1" id="the-type-class"><span class="header-section-number">4.2.1</span> The Type Class</h3>
    <p>A type class is an interface or API that represents some
    functionality we want implemented. In Scala a type class is
    represented by a trait with at least one type parameter. For
    example, we can represent generic “serialize to JSON” behaviour as
    follows:</p>
    <div class="sourceCode" id="cb189"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Define a very simple JSON AST</span></span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> Json</span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">JsObject</span><span class="op">(</span>get<span class="op">:</span> <span class="ex">Map</span><span class="op">[</span><span class="ex">String</span><span class="op">,</span> Json<span class="op">])</span> <span class="kw">extends</span> Json</span>
<span id="cb189-4"><a href="#cb189-4" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">JsString</span><span class="op">(</span>get<span class="op">:</span> <span class="ex">String</span><span class="op">)</span> <span class="kw">extends</span> Json</span>
<span id="cb189-5"><a href="#cb189-5" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">JsNumber</span><span class="op">(</span>get<span class="op">:</span> <span class="ex">Double</span><span class="op">)</span> <span class="kw">extends</span> Json</span>
<span id="cb189-6"><a href="#cb189-6" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">object</span> JsNull <span class="kw">extends</span> Json</span>
<span id="cb189-7"><a href="#cb189-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-8"><a href="#cb189-8" aria-hidden="true" tabindex="-1"></a><span class="co">// The &quot;serialize to JSON&quot; behaviour is encoded in this trait</span></span>
<span id="cb189-9"><a href="#cb189-9" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> JsonWriter<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb189-10"><a href="#cb189-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">write</span><span class="op">(</span>value<span class="op">:</span> A<span class="op">):</span> Json</span>
<span id="cb189-11"><a href="#cb189-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p><code>JsonWriter</code> is our type class in this example, with
    <code>Json</code> and its subtypes providing supporting code. When
    we come to implement instances of <code>JsonWriter</code>, the type
    parameter <code>A</code> will be the concrete type of data we are
    writing.</p>
    <h3 data-number="4.2.2" id="type-class-instances"><span class="header-section-number">4.2.2</span> Type Class Instances</h3>
    <p>The instances of a type class provide implementations of the type
    class for specific types we care about, which can include types from
    the Scala standard library and types from our domain model.</p>
    <p>In Scala we create type class instances by defining given
    instances implementing the type class.</p>
    <div class="sourceCode" id="cb190"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> JsonWriterInstances <span class="op">{</span></span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a>  given stringWriter<span class="op">:</span> JsonWriter<span class="op">[</span><span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> JsonWriter<span class="op">[</span><span class="ex">String</span><span class="op">]</span> <span class="op">{</span></span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> <span class="fu">write</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> Json <span class="op">=</span></span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">JsString</span><span class="op">(</span>value<span class="op">)</span></span>
<span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb190-7"><a href="#cb190-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb190-8"><a href="#cb190-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">Person</span><span class="op">(</span>name<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> email<span class="op">:</span> <span class="ex">String</span><span class="op">)</span></span>
<span id="cb190-9"><a href="#cb190-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb190-10"><a href="#cb190-10" aria-hidden="true" tabindex="-1"></a>  given JsonWriter<span class="op">[</span>Person<span class="op">]</span> <span class="kw">with</span></span>
<span id="cb190-11"><a href="#cb190-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">write</span><span class="op">(</span>value<span class="op">:</span> Person<span class="op">):</span> Json <span class="op">=</span></span>
<span id="cb190-12"><a href="#cb190-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">JsObject</span><span class="op">(</span><span class="ex">Map</span><span class="op">(</span></span>
<span id="cb190-13"><a href="#cb190-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;name&quot;</span> <span class="op">-&gt;</span> <span class="fu">JsString</span><span class="op">(</span>value<span class="op">.</span>name<span class="op">),</span></span>
<span id="cb190-14"><a href="#cb190-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;email&quot;</span> <span class="op">-&gt;</span> <span class="fu">JsString</span><span class="op">(</span>value<span class="op">.</span>email<span class="op">)</span></span>
<span id="cb190-15"><a href="#cb190-15" aria-hidden="true" tabindex="-1"></a>      <span class="op">))</span></span>
<span id="cb190-16"><a href="#cb190-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb190-17"><a href="#cb190-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// etc...</span></span>
<span id="cb190-18"><a href="#cb190-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>In this example we define two type class instances of
    <code>JsonWriter</code>, one for <code>String</code> and one for
    <code>Person</code>. The definition for <code>String</code> uses the
    syntax we saw in the previous section. The definition for
    <code>Person</code> uses two bits of syntax that are new in Scala 3.
    Firstly, writing <code>given JsonWriter[Person]</code> creates an
    anonymous given instance. We declare just the type and don’t need to
    name the instance. This is fine because we don’t usually need to
    refer to given instances by name. The second bit of syntax is the
    use of <code>with</code> to implement a trait directly without
    having to write out <code>new JsonWriter[Person]</code> and so
    on.</p>
    <p>In a real implementation we’d usually want to define the
    instances on a companion object: the instance for
    <code>String</code> on the <code>JsonWriter</code> companion object
    (because we cannot define it on the <code>String</code> companion
    object) and the instance for <code>Person</code> on the
    <code>Person</code> companion object. I haven’t done this here
    because I would need to redeclare <code>JsonWriter</code>, as a type
    and it’s companion object must be declared at the same time.</p>
    <h3 data-number="4.2.3" id="type-class-use"><span class="header-section-number">4.2.3</span> Type Class Use</h3>
    <p>A type class use is any functionality that requires a type class
    instance to work. In Scala this means any method that accepts
    instances of the type class as part of a using clause.</p>
    <p>We’re going to look at two patterns of type class usage, which we
    call <strong>interface objects</strong> and <strong>interface
    syntax</strong>. You’ll find these in Cats and other libraries.</p>
    <h4 data-number="4.2.3.1" id="interface-objects"><span class="header-section-number">4.2.3.1</span> Interface Objects</h4>
    <p>The simplest way of creating an interface that uses a type class
    is to place methods in a singleton object:</p>
    <div class="sourceCode" id="cb191"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Json <span class="op">{</span></span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> toJson<span class="op">[</span>A<span class="op">](</span>value<span class="op">:</span> A<span class="op">)(</span>using w<span class="op">:</span> JsonWriter<span class="op">[</span>A<span class="op">]):</span> Json <span class="op">=</span></span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>    w<span class="op">.</span><span class="fu">write</span><span class="op">(</span>value<span class="op">)</span></span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>To use this object, we import any type class instances we care
    about and call the relevant method:</p>
    <div class="sourceCode" id="cb192"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> JsonWriterInstances<span class="op">.{*,</span> given<span class="op">}</span></span></code></pre></div>
    <div class="sourceCode" id="cb193"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a>Json<span class="op">.</span><span class="fu">toJson</span><span class="op">(</span><span class="fu">Person</span><span class="op">(</span><span class="st">&quot;Dave&quot;</span><span class="op">,</span> <span class="st">&quot;dave@example.com&quot;</span><span class="op">))</span></span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: Json = JsObject(</span></span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   get = Map(</span></span>
<span id="cb193-4"><a href="#cb193-4" aria-hidden="true" tabindex="-1"></a><span class="co">//     &quot;name&quot; -&gt; JsString(get = &quot;Dave&quot;),</span></span>
<span id="cb193-5"><a href="#cb193-5" aria-hidden="true" tabindex="-1"></a><span class="co">//     &quot;email&quot; -&gt; JsString(get = &quot;dave@example.com&quot;)</span></span>
<span id="cb193-6"><a href="#cb193-6" aria-hidden="true" tabindex="-1"></a><span class="co">//   )</span></span>
<span id="cb193-7"><a href="#cb193-7" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>The compiler spots that we’ve called the <code>toJson</code>
    method without providing the given instances. It tries to fix this
    by searching for given instances of the relevant types and inserting
    them at the call site.</p>
    <h4 data-number="4.2.3.2" id="interface-syntax"><span class="header-section-number">4.2.3.2</span> Interface Syntax</h4>
    <p>We can alternatively use <strong>extension methods</strong> to
    extend existing types with interface methods<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>. This is sometimes referred to
    as as <strong>syntax</strong> for the type class, which is the term
    used by Cats. Scala 2 has an equivalent to extension methods known
    as <strong>implicit classes</strong>.</p>
    <p>Here’s an example defining an extension method to add a
    <code>toJson</code> method to any type for which we have a
    <code>JsonWriter</code> instance.</p>
    <div class="sourceCode" id="cb194"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> JsonSyntax <span class="op">{</span></span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a>  extension <span class="op">[</span>A<span class="op">](</span>value<span class="op">:</span> A<span class="op">)</span> <span class="op">{</span></span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">toJson</span><span class="op">(</span>using w<span class="op">:</span> JsonWriter<span class="op">[</span>A<span class="op">]):</span> Json <span class="op">=</span></span>
<span id="cb194-4"><a href="#cb194-4" aria-hidden="true" tabindex="-1"></a>      w<span class="op">.</span><span class="fu">write</span><span class="op">(</span>value<span class="op">)</span></span>
<span id="cb194-5"><a href="#cb194-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb194-6"><a href="#cb194-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>We use interface syntax by importing it alongside the instances
    for the types we need:</p>
    <div class="sourceCode" id="cb195"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> JsonWriterInstances<span class="op">.</span>given</span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> JsonSyntax<span class="op">.*</span></span></code></pre></div>
    <div class="sourceCode" id="cb196"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Person</span><span class="op">(</span><span class="st">&quot;Dave&quot;</span><span class="op">,</span> <span class="st">&quot;dave@example.com&quot;</span><span class="op">).</span>toJson</span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: Json = JsObject(</span></span>
<span id="cb196-3"><a href="#cb196-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   get = Map(</span></span>
<span id="cb196-4"><a href="#cb196-4" aria-hidden="true" tabindex="-1"></a><span class="co">//     &quot;name&quot; -&gt; JsString(get = &quot;Dave&quot;),</span></span>
<span id="cb196-5"><a href="#cb196-5" aria-hidden="true" tabindex="-1"></a><span class="co">//     &quot;email&quot; -&gt; JsString(get = &quot;dave@example.com&quot;)</span></span>
<span id="cb196-6"><a href="#cb196-6" aria-hidden="true" tabindex="-1"></a><span class="co">//   )</span></span>
<span id="cb196-7"><a href="#cb196-7" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <section id="extension-methods-on-traits" class="unnumbered callout callout-info">
    <h4 class="unnumbered">Extension Methods on Traits</h4>
    <p>In Scala 3 we can define extension methods directly on a type
    class trait. Since we’re defining <code>toJson</code> as just
    calling <code>write</code> on <code>JsonWriter</code>, we could
    instead define <code>toJson</code> directly on
    <code>JsonWriter</code> and avoid creating an separate extension
    method.</p>
    <div class="sourceCode" id="cb197"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> JsonWriter<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extension</span> <span class="op">(</span>value<span class="op">:</span> A<span class="op">)</span> <span class="kw">def</span> toJson<span class="op">:</span> Json</span>
<span id="cb197-3"><a href="#cb197-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb197-4"><a href="#cb197-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-5"><a href="#cb197-5" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> JsonWriter <span class="op">{</span></span>
<span id="cb197-6"><a href="#cb197-6" aria-hidden="true" tabindex="-1"></a>  given stringWriter<span class="op">:</span> JsonWriter<span class="op">[</span><span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb197-7"><a href="#cb197-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> JsonWriter<span class="op">[</span><span class="ex">String</span><span class="op">]</span> <span class="op">{</span></span>
<span id="cb197-8"><a href="#cb197-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">extension</span> <span class="op">(</span>value<span class="op">:</span> <span class="ex">String</span><span class="op">)</span> </span>
<span id="cb197-9"><a href="#cb197-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> toJson<span class="op">:</span> Json <span class="op">=</span> <span class="fu">JsString</span><span class="op">(</span>value<span class="op">)</span></span>
<span id="cb197-10"><a href="#cb197-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb197-11"><a href="#cb197-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb197-12"><a href="#cb197-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// etc...</span></span>
<span id="cb197-13"><a href="#cb197-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>We do <em>not</em> advocate this approach, because of a
    limitation in how Scala searches for extension methods. The
    following code fails because Scala only looks within the
    <code>String</code> companion object for extension methods, and
    consequently does not find the extension method on the instance in
    the <code>JsonWriter</code> companion object.</p>
    <div class="sourceCode" id="cb198"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;A string&quot;</span><span class="op">.</span>toJson</span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a><span class="co">// error:</span></span>
<span id="cb198-3"><a href="#cb198-3" aria-hidden="true" tabindex="-1"></a><span class="co">// value toJson is not a member of String</span></span>
<span id="cb198-4"><a href="#cb198-4" aria-hidden="true" tabindex="-1"></a><span class="co">// &quot;A string&quot;.toJson</span></span>
<span id="cb198-5"><a href="#cb198-5" aria-hidden="true" tabindex="-1"></a><span class="co">// ^^^^^^^^^^^^^^^^^</span></span></code></pre></div>
    <p>This means that users will have to explicitly import at least the
    instances for the built-in types (for which we cannot modify the
    companion objects).</p>
    <div class="sourceCode" id="cb199"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> JsonWriter<span class="op">.</span>given</span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;A string&quot;</span><span class="op">.</span>toJson</span>
<span id="cb199-4"><a href="#cb199-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: Json = JsString(get = &quot;A string&quot;)</span></span></code></pre></div>
    <p>For consistency we recommend separating the syntax from the type
    class instances and always explicitly importing it, rather than
    requiring explicit imports for only some extension methods.</p>
    </section>
    <h4 data-number="4.2.3.3" id="the-summon-method"><span class="header-section-number">4.2.3.3</span> The <code>summon</code>
    Method</h4>
    <p>The Scala standard library provides a generic type class
    interface called <code>summon</code>. Its definition is very
    simple:</p>
    <div class="sourceCode" id="cb200"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> summon<span class="op">[</span>A<span class="op">](</span>using value<span class="op">:</span> A<span class="op">):</span> A <span class="op">=</span></span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a>  value</span></code></pre></div>
    <p>We can use <code>summon</code> to summon any value in the given
    scope. We provide the type we want and <code>summon</code> does the
    rest:</p>
    <div class="sourceCode" id="cb201"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>summon<span class="op">[</span>JsonWriter<span class="op">[</span><span class="ex">String</span><span class="op">]]</span></span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res6: JsonWriter[String] = repl.MdocSession$MdocApp3$JsonWriter$$anon$7@fa82d5f</span></span></code></pre></div>
    <p>Most type classes in Cats provide other means to summon
    instances. However, <code>summon</code> is a good fallback for
    debugging purposes. We can insert a call to <code>summon</code>
    within the general flow of our code to ensure the compiler can find
    an instance of a type class and ensure that there are no ambiguity
    errors.</p>
    <h2 data-number="4.3" id="sec:type-classes:composition"><span class="header-section-number">4.3</span> Type Class Composition</h2>
    <p>So far we’ve seen type classes as a way to get the compiler to
    pass values to methods. This is nice but it does seem like we’ve
    introduced a lot of new concepts for a small gain. The real power of
    type classes lies in the compiler’s ability to combine given
    instances to construct new given instances. This is known as
    <strong>type class composition</strong>.</p>
    <p>Type class composition works by a feature of given instances we
    have not yet seen: given instances can themselves have context
    parameters. However, before we go into this let’s see a motivational
    example.</p>
    <p>Consider defining a <code>JsonWriter</code> for
    <code>Option</code>. We would need a
    <code>JsonWriter[Option[A]]</code> for every <code>A</code> we care
    about in our application. We could try to brute force the problem by
    creating a library of given instances:</p>
    <div class="sourceCode" id="cb202"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a>given optionIntWriter<span class="op">:</span> JsonWriter<span class="op">[</span><span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">]]</span> <span class="op">=</span></span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">???</span></span>
<span id="cb202-3"><a href="#cb202-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-4"><a href="#cb202-4" aria-hidden="true" tabindex="-1"></a>given optionPersonWriter<span class="op">:</span> JsonWriter<span class="op">[</span><span class="ex">Option</span><span class="op">[</span>Person<span class="op">]]</span> <span class="op">=</span></span>
<span id="cb202-5"><a href="#cb202-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">???</span></span>
<span id="cb202-6"><a href="#cb202-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-7"><a href="#cb202-7" aria-hidden="true" tabindex="-1"></a><span class="co">// and so on...</span></span></code></pre></div>
    <p>However, this approach clearly doesn’t scale. We end up requiring
    two given instances for every type <code>A</code> in our
    application: one for <code>A</code> and one for
    <code>Option[A]</code>.</p>
    <p>Fortunately, we can abstract the code for handling
    <code>Option[A]</code> into a common constructor based on the
    instance for <code>A</code>:</p>
    <ul>
    <li><p>if the option is <code>Some(aValue)</code>, write
    <code>aValue</code> using the writer for <code>A</code>;</p></li>
    <li><p>if the option is <code>None</code>, return
    <code>JsNull</code>.</p></li>
    </ul>
    <p>Here is the same code written out using a parameterized given
    instance:</p>
    <div class="sourceCode" id="cb203"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a>given optionWriter<span class="op">[</span>A<span class="op">](</span>using writer<span class="op">:</span> JsonWriter<span class="op">[</span>A<span class="op">]):</span> JsonWriter<span class="op">[</span><span class="ex">Option</span><span class="op">[</span>A<span class="op">]]</span> <span class="op">=</span></span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> JsonWriter<span class="op">[</span><span class="ex">Option</span><span class="op">[</span>A<span class="op">]]</span> <span class="op">{</span></span>
<span id="cb203-3"><a href="#cb203-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">write</span><span class="op">(</span>option<span class="op">:</span> <span class="ex">Option</span><span class="op">[</span>A<span class="op">]):</span> Json <span class="op">=</span></span>
<span id="cb203-4"><a href="#cb203-4" aria-hidden="true" tabindex="-1"></a>      option <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb203-5"><a href="#cb203-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="bu">Some</span><span class="op">(</span>aValue<span class="op">)</span> <span class="op">=&gt;</span> writer<span class="op">.</span><span class="fu">write</span><span class="op">(</span>aValue<span class="op">)</span></span>
<span id="cb203-6"><a href="#cb203-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="bu">None</span>         <span class="op">=&gt;</span> JsNull</span>
<span id="cb203-7"><a href="#cb203-7" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb203-8"><a href="#cb203-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>This method constructs a <code>JsonWriter</code> for
    <code>Option[A]</code> by relying on a context parameter to fill in
    the <code>A</code>-specific functionality. When the compiler sees an
    expression like this:</p>
    <div class="sourceCode" id="cb204"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a>Json<span class="op">.</span><span class="fu">toJson</span><span class="op">(</span><span class="ex">Option</span><span class="op">(</span><span class="st">&quot;A string&quot;</span><span class="op">))</span></span></code></pre></div>
    <p>it searches for an given instance
    <code>JsonWriter[Option[String]]</code>. It finds the given instance
    for <code>JsonWriter[Option[A]]</code>:</p>
    <div class="sourceCode" id="cb205"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a>Json<span class="op">.</span><span class="fu">toJson</span><span class="op">(</span><span class="ex">Option</span><span class="op">(</span><span class="st">&quot;A string&quot;</span><span class="op">))(</span>using optionWriter<span class="op">[</span><span class="ex">String</span><span class="op">])</span></span></code></pre></div>
    <p>and recursively searches for a <code>JsonWriter[String]</code> to
    use as the context parameter to <code>optionWriter</code>:</p>
    <div class="sourceCode" id="cb206"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a>Json<span class="op">.</span><span class="fu">toJson</span><span class="op">(</span><span class="ex">Option</span><span class="op">(</span><span class="st">&quot;A string&quot;</span><span class="op">))(</span>using <span class="fu">optionWriter</span><span class="op">(</span>using stringWriter<span class="op">))</span></span></code></pre></div>
    <p>In this way, given instance resolution becomes a search through
    the space of possible combinations of given instance, to find a
    combination that creates a type class instance of the correct
    overall type.</p>
    <h3 data-number="4.3.1" id="type-class-composition-in-scala-2"><span class="header-section-number">4.3.1</span> Type Class Composition in
    Scala 2</h3>
    <p>In Scala 2 we can achieve the same effect with an
    <code>implicit</code> method with <code>implicit</code> parameters.
    Here’s the Scala 2 equivalent of <code>optionWriter</code>
    above.</p>
    <div class="sourceCode" id="cb207"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="kw">implicit</span> <span class="kw">def</span> scala2OptionWriter<span class="op">[</span>A<span class="op">]</span></span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span><span class="kw">implicit</span> writer<span class="op">:</span> JsonWriter<span class="op">[</span>A<span class="op">]):</span> JsonWriter<span class="op">[</span><span class="ex">Option</span><span class="op">[</span>A<span class="op">]]</span> <span class="op">=</span></span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> JsonWriter<span class="op">[</span><span class="ex">Option</span><span class="op">[</span>A<span class="op">]]</span> <span class="op">{</span></span>
<span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">write</span><span class="op">(</span>option<span class="op">:</span> <span class="ex">Option</span><span class="op">[</span>A<span class="op">]):</span> Json <span class="op">=</span></span>
<span id="cb207-5"><a href="#cb207-5" aria-hidden="true" tabindex="-1"></a>      option <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb207-6"><a href="#cb207-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="bu">Some</span><span class="op">(</span>aValue<span class="op">)</span> <span class="op">=&gt;</span> writer<span class="op">.</span><span class="fu">write</span><span class="op">(</span>aValue<span class="op">)</span></span>
<span id="cb207-7"><a href="#cb207-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="bu">None</span>         <span class="op">=&gt;</span> JsNull</span>
<span id="cb207-8"><a href="#cb207-8" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb207-9"><a href="#cb207-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>Make sure you make the method’s parameter implicit! If you don’t,
    you’ll end up defining an <strong>implicit conversion</strong>.
    Implicit conversion is an older programming pattern that is frowned
    upon in modern Scala code. Fortunately, the compiler will warn you
    should you do this.</p>
    <h2 data-number="4.4" id="what-type-classes-are"><span class="header-section-number">4.4</span> What Type Classes Are</h2>
    <p>We’ve have now seen the mechanics of type classes: they are a
    specific arrangement of trait, given instances, and using clauses.
    This is a very craft-level explanation. Let’s now raise the level of
    the explanation with three different views of type classes.</p>
    <p>The first view goes back Chapter 3, where we looked at codata.
    The type class itself—the trait—is an example of codata with the
    usual advantages of codata (we can easily add implementations) and
    disadvantages (we cannot easily change the interface). Given
    instances and using clauses add the ability to chose the codata
    implementation based on the type of the context parameter and the
    instances in the given scope, and to compose instances from smaller
    components.</p>
    <p>Raising the level of abstraction again, we can say that type
    classes allow us to implement functionality (the type class
    instance) separately from the type to which it applies, so that the
    implementation only needs to be defined at the point of the use—the
    call site—not at the point of declaration.</p>
    <p>Raising the level again, we can say type classes allow us to
    implement <strong>ad-hoc polymorphism</strong>. I find it easiest to
    understand ad-hoc polymorphism in contrast to <strong>parametric
    polymorphism</strong>. Parametric polymorphism is what we get with
    type parameters, also known as generic types. It allows us to treat
    all types in a uniform way. For example, the following function
    calculates the length of any list of an arbitrary type
    <code>A</code>.</p>
    <div class="sourceCode" id="cb208"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> length<span class="op">[</span>A<span class="op">](</span>list<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">]):</span> <span class="bu">Int</span> <span class="op">=</span></span>
<span id="cb208-2"><a href="#cb208-2" aria-hidden="true" tabindex="-1"></a>  list <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb208-3"><a href="#cb208-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> Nil <span class="op">=&gt;</span> <span class="dv">0</span></span>
<span id="cb208-4"><a href="#cb208-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> x <span class="op">::</span> xs <span class="op">=&gt;</span> <span class="dv">1</span> <span class="op">+</span> <span class="fu">length</span><span class="op">(</span>xs<span class="op">)</span></span>
<span id="cb208-5"><a href="#cb208-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>We can implement <code>length</code> because we don’t require any
    particular functionality from the values of type <code>A</code> that
    make up the elements of the list. We don’t call any methods on them,
    and indeed we cannot call any methods on them because we don’t know
    what concrete type <code>A</code> will be at the point where
    <code>length</code> is defined<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>.</p>
    <p>Ad-hoc polymorphism allows us to call methods on values with a
    generic type. The methods we can call are exactly those defined by
    the type class. For example, we can use the <code>Numeric</code>
    type class from the standard library to write a method that adds
    together elements of any type that implements that type class.</p>
    <div class="sourceCode" id="cb209"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>math<span class="op">.</span>Numeric</span>
<span id="cb209-2"><a href="#cb209-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-3"><a href="#cb209-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add<span class="op">[</span>A<span class="op">](</span>x<span class="op">:</span> A<span class="op">,</span> y<span class="op">:</span> A<span class="op">)(</span>using n<span class="op">:</span> Numeric<span class="op">[</span>A<span class="op">]):</span> A <span class="op">=</span> <span class="op">{</span></span>
<span id="cb209-4"><a href="#cb209-4" aria-hidden="true" tabindex="-1"></a>  n<span class="op">.</span><span class="fu">plus</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">)</span></span>
<span id="cb209-5"><a href="#cb209-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>So parametric polymorphism can be understood as meaning any type,
    while ad-hoc polymorphism means any type <em>that also implements
    this functionality</em>. In ad-hoc polymorphism there doesn’t have
    to be any particular type relationship between the concrete types
    that implement the functionality of interest. This is in contast to
    object-oriented style polymorphism (i.e. codata) where all concrete
    types must be subtypes of the type that defines the functionality of
    interest.</p>
    <h2 data-number="4.5" id="sec:type-classes:display"><span class="header-section-number">4.5</span> Exercise: Display
    Library</h2>
    <p>Scala provides a <code>toString</code> method to let us convert
    any value to a <code>String</code>. This method comes with a few
    disadvantages:</p>
    <ol type="1">
    <li><p>It is implemented for <em>every</em> type in the language.
    There are situations where we don’t want to be able to view data.
    For example, we may want to ensure we don’t log sensitive
    information, such as passwords, in plain text.</p></li>
    <li><p>We can’t customize <code>toString</code> for types we don’t
    control.</p></li>
    </ol>
    <p>Let’s define a <code>Display</code> type class to work around
    these problems:</p>
    <ol type="1">
    <li><p>Define a type class <code>Display[A]</code> containing a
    single method <code>display</code>. <code>display</code> should
    accept a value of type <code>A</code> and return a
    <code>String</code>.</p></li>
    <li><p>Create instances of <code>Display</code> for
    <code>String</code> and <code>Int</code> on the <code>Display</code>
    companion object.</p></li>
    <li><p>On the <code>Display</code> companion object create two
    generic interface methods:</p>
    <ul>
    <li><p><code>display</code> accepts a value of type <code>A</code>
    and a <code>Display</code> of the corresponding type. It uses the
    relevant <code>Display</code> to convert the <code>A</code> to a
    <code>String</code>.</p></li>
    <li><p><code>print</code> accepts the same parameters as
    <code>display</code> and returns <code>Unit</code>. It prints the
    displayed <code>A</code> value to the console using
    <code>println</code>.</p></li>
    </ul></li>
    </ol>
    <div class="solution">
    <p>These steps define the three main components of our type class.
    First we define <code>Display</code>—the type class itself:</p>
    <div class="sourceCode" id="cb210"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Display<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">display</span><span class="op">(</span>value<span class="op">:</span> A<span class="op">):</span> <span class="ex">String</span></span>
<span id="cb210-3"><a href="#cb210-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Then we define some default instances of <code>Display</code> and
    package them in the <code>Display</code> companion object:</p>
    <div class="sourceCode" id="cb211"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Display <span class="op">{</span></span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a>  given stringDisplay<span class="op">:</span> Display<span class="op">[</span><span class="ex">String</span><span class="op">]</span> <span class="kw">with</span> <span class="op">{</span></span>
<span id="cb211-3"><a href="#cb211-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">display</span><span class="op">(</span>input<span class="op">:</span> <span class="ex">String</span><span class="op">)</span> <span class="op">=</span> input</span>
<span id="cb211-4"><a href="#cb211-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb211-5"><a href="#cb211-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-6"><a href="#cb211-6" aria-hidden="true" tabindex="-1"></a>  given intDisplay<span class="op">:</span> Display<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="kw">with</span> <span class="op">{</span></span>
<span id="cb211-7"><a href="#cb211-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">display</span><span class="op">(</span>input<span class="op">:</span> <span class="bu">Int</span><span class="op">)</span> <span class="op">=</span> input<span class="op">.</span>toString</span>
<span id="cb211-8"><a href="#cb211-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb211-9"><a href="#cb211-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Finally we extend the <code>Display</code> companion object to
    provide a basic interface:</p>
    <div class="sourceCode" id="cb212"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Display <span class="op">{</span></span>
<span id="cb212-2"><a href="#cb212-2" aria-hidden="true" tabindex="-1"></a>  given stringDisplay<span class="op">:</span> Display<span class="op">[</span><span class="ex">String</span><span class="op">]</span> <span class="kw">with</span> <span class="op">{</span></span>
<span id="cb212-3"><a href="#cb212-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">display</span><span class="op">(</span>input<span class="op">:</span> <span class="ex">String</span><span class="op">)</span> <span class="op">=</span> input</span>
<span id="cb212-4"><a href="#cb212-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb212-5"><a href="#cb212-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-6"><a href="#cb212-6" aria-hidden="true" tabindex="-1"></a>  given intDisplay<span class="op">:</span> Display<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="kw">with</span> <span class="op">{</span></span>
<span id="cb212-7"><a href="#cb212-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">display</span><span class="op">(</span>input<span class="op">:</span> <span class="bu">Int</span><span class="op">)</span> <span class="op">=</span> input<span class="op">.</span>toString</span>
<span id="cb212-8"><a href="#cb212-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb212-9"><a href="#cb212-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-10"><a href="#cb212-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> display<span class="op">[</span>A<span class="op">](</span>input<span class="op">:</span> A<span class="op">)(</span>using p<span class="op">:</span> Display<span class="op">[</span>A<span class="op">]):</span> <span class="ex">String</span> <span class="op">=</span></span>
<span id="cb212-11"><a href="#cb212-11" aria-hidden="true" tabindex="-1"></a>    p<span class="op">.</span><span class="fu">display</span><span class="op">(</span>input<span class="op">)</span></span>
<span id="cb212-12"><a href="#cb212-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-13"><a href="#cb212-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> print<span class="op">[</span>A<span class="op">](</span>input<span class="op">:</span> A<span class="op">)(</span>using Display<span class="op">[</span>A<span class="op">]):</span> <span class="bu">Unit</span> <span class="op">=</span></span>
<span id="cb212-14"><a href="#cb212-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span><span class="op">(</span><span class="fu">display</span><span class="op">(</span>input<span class="op">))</span></span>
<span id="cb212-15"><a href="#cb212-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Notice that the <code>Display</code> instance on
    <code>print</code> is anonymous. This is allowed in Scala 3, and
    works because we only pass it to <code>display</code>.</p>
    </div>
    <h3 data-number="4.5.1" id="sec:type-classes:cat"><span class="header-section-number">4.5.1</span> Using the Library</h3>
    <p>The code above forms a general purpose printing library that we
    can use in multiple applications. Let’s define an “application” now
    that uses the library.</p>
    <p>First we’ll define a data type to represent a well-known type of
    furry animal:</p>
    <div class="sourceCode" id="cb213"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">Cat</span><span class="op">(</span>name<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> age<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> color<span class="op">:</span> <span class="ex">String</span><span class="op">)</span></span></code></pre></div>
    <p>Next we’ll create an implementation of <code>Display</code> for
    <code>Cat</code> that returns content in the following format:</p>
    <div class="sourceCode" id="cb214"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="cn">NAME</span> is a <span class="cn">AGE</span> year<span class="kw">-</span>old <span class="cn">COLOR</span> cat<span class="kw">.</span></span></code></pre></div>
    <p>Finally, use the type class on the console or in a short demo
    app: create a <code>Cat</code> and print it to the console:</p>
    <div class="sourceCode" id="cb215"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Define a cat:</span></span>
<span id="cb215-2"><a href="#cb215-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> cat <span class="op">=</span> <span class="fu">Cat</span><span class="op">(</span><span class="co">/* ... */</span><span class="op">)</span></span>
<span id="cb215-3"><a href="#cb215-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-4"><a href="#cb215-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Print the cat!</span></span></code></pre></div>
    <div class="solution">
    <p>This is a standard use of the type class pattern. First we define
    custom data type for our application:</p>
    <div class="sourceCode" id="cb216"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">Cat</span><span class="op">(</span>name<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> age<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> color<span class="op">:</span> <span class="ex">String</span><span class="op">)</span></span></code></pre></div>
    <p>Then we define type class instances for the types we care about.
    These either go into the companion object of <code>Cat</code> or a
    separate object to act as a namespace:</p>
    <div class="sourceCode" id="cb217"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a>given catDisplay<span class="op">:</span> Display<span class="op">[</span>Cat<span class="op">]</span> <span class="op">=</span> <span class="kw">new</span> Display<span class="op">[</span>Cat<span class="op">]</span> <span class="op">{</span></span>
<span id="cb217-2"><a href="#cb217-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">display</span><span class="op">(</span>cat<span class="op">:</span> Cat<span class="op">)</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb217-3"><a href="#cb217-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> name  <span class="op">=</span> Display<span class="op">.</span><span class="fu">display</span><span class="op">(</span>cat<span class="op">.</span>name<span class="op">)</span></span>
<span id="cb217-4"><a href="#cb217-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> age   <span class="op">=</span> Display<span class="op">.</span><span class="fu">display</span><span class="op">(</span>cat<span class="op">.</span>age<span class="op">)</span></span>
<span id="cb217-5"><a href="#cb217-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> color <span class="op">=</span> Display<span class="op">.</span><span class="fu">display</span><span class="op">(</span>cat<span class="op">.</span>color<span class="op">)</span></span>
<span id="cb217-6"><a href="#cb217-6" aria-hidden="true" tabindex="-1"></a>    <span class="ss">s&quot;$name</span><span class="st"> is a </span><span class="ss">$age</span><span class="st"> year-old </span><span class="ss">$color</span><span class="st"> cat.</span><span class="ss">&quot;</span></span>
<span id="cb217-7"><a href="#cb217-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb217-8"><a href="#cb217-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Finally, we use the type class by bringing the relevant instances
    into scope and using interface object/syntax. If we defined the
    instances in companion objects Scala brings them into scope for us
    automatically. Otherwise we use an <code>import</code> to access
    them:</p>
    <div class="sourceCode" id="cb218"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> cat <span class="op">=</span> <span class="fu">Cat</span><span class="op">(</span><span class="st">&quot;Garfield&quot;</span><span class="op">,</span> <span class="dv">41</span><span class="op">,</span> <span class="st">&quot;ginger and black&quot;</span><span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb219"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a>Display<span class="op">.</span><span class="fu">print</span><span class="op">(</span>cat<span class="op">)</span></span>
<span id="cb219-2"><a href="#cb219-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Garfield is a 41 year-old ginger and black cat.</span></span></code></pre></div>
    </div>
    <h3 data-number="4.5.2" id="better-syntax"><span class="header-section-number">4.5.2</span> Better Syntax</h3>
    <p>Let’s make our printing library easier to use by adding extension
    methods for its functionality:</p>
    <ol type="1">
    <li><p>Create an object <code>DisplaySyntax</code>.</p></li>
    <li><p>Define <code>display</code> and <code>print</code> as
    extension methods on <code>DisplaySyntax</code>.</p></li>
    <li><p>Use the extension methods to print the example
    <code>Cat</code> you created in the previous exercise.</p></li>
    </ol>
    <div class="solution">
    <p>First we define <code>DisplaySyntax</code> with the extension
    methods we want.</p>
    <div class="sourceCode" id="cb220"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> DisplaySyntax <span class="op">{</span></span>
<span id="cb220-2"><a href="#cb220-2" aria-hidden="true" tabindex="-1"></a>  extension <span class="op">[</span>A<span class="op">](</span>value<span class="op">:</span> A<span class="op">)(</span>using p<span class="op">:</span> Display<span class="op">[</span>A<span class="op">])</span> <span class="op">{</span></span>
<span id="cb220-3"><a href="#cb220-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> display<span class="op">:</span> <span class="ex">String</span> <span class="op">=</span> p<span class="op">.</span><span class="fu">display</span><span class="op">(</span>value<span class="op">)</span></span>
<span id="cb220-4"><a href="#cb220-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> print<span class="op">:</span> <span class="bu">Unit</span> <span class="op">=</span> p<span class="op">.</span><span class="fu">print</span><span class="op">(</span>value<span class="op">)</span></span>
<span id="cb220-5"><a href="#cb220-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb220-6"><a href="#cb220-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Now we can show everything working by calling <code>print</code>
    on a <code>Cat</code>.</p>
    <div class="sourceCode" id="cb221"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> DisplaySyntax<span class="op">.*</span></span>
<span id="cb221-2"><a href="#cb221-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-3"><a href="#cb221-3" aria-hidden="true" tabindex="-1"></a>given Display<span class="op">[</span>Cat<span class="op">]</span> <span class="kw">with</span> <span class="op">{</span></span>
<span id="cb221-4"><a href="#cb221-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">display</span><span class="op">(</span>cat<span class="op">:</span> Cat<span class="op">):</span> <span class="ex">String</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb221-5"><a href="#cb221-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> name  <span class="op">=</span> cat<span class="op">.</span>name<span class="op">.</span>display</span>
<span id="cb221-6"><a href="#cb221-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> age   <span class="op">=</span> cat<span class="op">.</span>age<span class="op">.</span>display</span>
<span id="cb221-7"><a href="#cb221-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> color <span class="op">=</span> cat<span class="op">.</span>color<span class="op">.</span>display</span>
<span id="cb221-8"><a href="#cb221-8" aria-hidden="true" tabindex="-1"></a>    <span class="ss">s&quot;$name</span><span class="st"> is a </span><span class="ss">$age</span><span class="st"> year-old </span><span class="ss">$color</span><span class="st"> cat.</span><span class="ss">&quot;</span></span>
<span id="cb221-9"><a href="#cb221-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb221-10"><a href="#cb221-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb221-11"><a href="#cb221-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-12"><a href="#cb221-12" aria-hidden="true" tabindex="-1"></a><span class="fu">Cat</span><span class="op">(</span><span class="st">&quot;Garfield&quot;</span><span class="op">,</span> <span class="dv">41</span><span class="op">,</span> <span class="st">&quot;ginger and black&quot;</span><span class="op">).</span>print</span>
<span id="cb221-13"><a href="#cb221-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Garfield is a 41 year-old ginger and black cat.</span></span></code></pre></div>
    <p>We get a compile error if we haven’t defined an instance of
    <code>Display</code> for the relevant type:</p>
    <div class="sourceCode" id="cb222"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> java<span class="op">.</span>util<span class="op">.</span><span class="ex">Date</span></span>
<span id="cb222-2"><a href="#cb222-2" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="ex">Date</span><span class="op">().</span>print</span>
<span id="cb222-3"><a href="#cb222-3" aria-hidden="true" tabindex="-1"></a><span class="co">// error:</span></span>
<span id="cb222-4"><a href="#cb222-4" aria-hidden="true" tabindex="-1"></a><span class="co">// value print is not a member of java.util.Date.</span></span>
<span id="cb222-5"><a href="#cb222-5" aria-hidden="true" tabindex="-1"></a><span class="co">// An extension method was tried, but could not be fully constructed:</span></span>
<span id="cb222-6"><a href="#cb222-6" aria-hidden="true" tabindex="-1"></a><span class="co">// </span></span>
<span id="cb222-7"><a href="#cb222-7" aria-hidden="true" tabindex="-1"></a><span class="co">//     this.DisplaySyntax.print[java.util.Date](new java.util.Date())(</span></span>
<span id="cb222-8"><a href="#cb222-8" aria-hidden="true" tabindex="-1"></a><span class="co">//       /* missing */summon[MdocApp3.this.Display[java.util.Date]])</span></span>
<span id="cb222-9"><a href="#cb222-9" aria-hidden="true" tabindex="-1"></a><span class="co">// </span></span>
<span id="cb222-10"><a href="#cb222-10" aria-hidden="true" tabindex="-1"></a><span class="co">//     failed with:</span></span>
<span id="cb222-11"><a href="#cb222-11" aria-hidden="true" tabindex="-1"></a><span class="co">// </span></span>
<span id="cb222-12"><a href="#cb222-12" aria-hidden="true" tabindex="-1"></a><span class="co">//         No given instance of type MdocApp3.this.Display[java.util.Date] was found for parameter p of method print in object DisplaySyntax</span></span>
<span id="cb222-13"><a href="#cb222-13" aria-hidden="true" tabindex="-1"></a><span class="co">// new Date().print</span></span>
<span id="cb222-14"><a href="#cb222-14" aria-hidden="true" tabindex="-1"></a><span class="co">// ^^^^^^^^^^^^^^^^</span></span></code></pre></div>
    </div>
    <h2 data-number="4.6" id="type-classes-and-variance"><span class="header-section-number">4.6</span> Type Classes and
    Variance</h2>
    <p>In this section we’ll discuss how variance interacts with type
    class instance selection. Variance is one of the darker corners of
    Scala’s type system, so we start by reviewing it before moving on to
    its interaction with type classes.</p>
    <h3 data-number="4.6.1" id="sec:variance"><span class="header-section-number">4.6.1</span> Variance</h3>
    <p>Variance concerns the relationship between an instance defined on
    a type and its subtypes. For example, if we define a
    <code>JsonWriter[Option[Int]]</code>, will the expression
    <code>Json.toJson(Some(1))</code> select this instance? (Remember
    that <code>Some</code> is a subtype of <code>Option</code>).</p>
    <p>We need two concepts to explain variance: type constructors, and
    subtyping.</p>
    <p>Variance applies to any <strong>type constructor</strong>, which
    is the <code>F</code> in a type <code>F[A]</code>. So, for example,
    <code>List</code>, <code>Option</code>, and <code>JsonWriter</code>
    are all type constructors. A type constructor must have at least one
    type parameter, and may have more. So <code>Either</code>, with two
    type parameters, is also a type constructor.</p>
    <p>Subtyping is a relationship between types. We say that
    <code>B</code> is a subtype of <code>A</code> if we can use a value
    of type <code>B</code> anywhere we expect a value of type
    <code>A</code>. We may sometimes use the shorthand
    <code>B &lt;: A</code> to indicate that <code>B</code> is a subtype
    of <code>A</code>.</p>
    <p>Variance concerns the subtyping relationship between types
    <code>F[A]</code> and <code>F[B]</code>, given a subtyping
    relationship between <code>A</code> and <code>B</code>. If
    <code>B</code> is a subtype of <code>A</code> then</p>
    <ol type="1">
    <li>if <code>F[B] &lt;: F[A]</code> we say <code>F</code> is
    <strong>covariant</strong> in <code>A</code>; else</li>
    <li>if <code>F[B] &gt;: F[A]</code> we say <code>F</code> is
    <strong>contravariant</strong> in <code>A</code>; else</li>
    <li>if there is no subtyping relationship between <code>F[B]</code>
    and <code>F[A]</code> we say <code>F</code> is
    <strong>invariant</strong> in <code>A</code>.</li>
    </ol>
    <p>When we define a type constructor we can also add variance
    annotations to its type parameters. For example, we denote
    covariance with a <code>+</code> symbol:</p>
    <div class="sourceCode" id="cb223"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> F<span class="op">[+</span>A<span class="op">]</span> <span class="co">// the &quot;+&quot; means &quot;covariant&quot;</span></span></code></pre></div>
    <p>If we don’t add a variance annotation, the type parameter is
    invariant. Let’s now look at covariance, contravariance, and
    invariance in detail.</p>
    <h3 data-number="4.6.2" id="covariance"><span class="header-section-number">4.6.2</span> Covariance</h3>
    <p>Covariance means that the type <code>F[B]</code> is a subtype of
    the type <code>F[A]</code> if <code>B</code> is a subtype of
    <code>A</code>. This is useful for modelling many types, including
    collections like <code>List</code> and <code>Option</code>:</p>
    <div class="sourceCode" id="cb224"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> <span class="ex">List</span><span class="op">[+</span>A<span class="op">]</span></span>
<span id="cb224-2"><a href="#cb224-2" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> <span class="ex">Option</span><span class="op">[+</span>A<span class="op">]</span></span></code></pre></div>
    <p>The covariance of Scala collections allows us to substitute
    collections of one type with a collection of a subtype in our code.
    For example, we can use a <code>List[Circle]</code> anywhere we
    expect a <code>List[Shape]</code> because <code>Circle</code> is a
    subtype of <code>Shape</code>:</p>
    <div class="sourceCode" id="cb225"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> <span class="ex">Shape</span></span>
<span id="cb225-2"><a href="#cb225-2" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">Circle</span><span class="op">(</span>radius<span class="op">:</span> <span class="ex">Double</span><span class="op">)</span> <span class="kw">extends</span> <span class="ex">Shape</span></span></code></pre></div>
    <div class="sourceCode" id="cb226"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> circles<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>Circle<span class="op">]</span> <span class="op">=</span> <span class="op">???</span></span>
<span id="cb226-2"><a href="#cb226-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> shapes<span class="op">:</span> <span class="ex">List</span><span class="op">[</span><span class="ex">Shape</span><span class="op">]</span> <span class="op">=</span> circles</span></code></pre></div>
    <p>Generally speaking, covariance is used for outputs: data that we
    can later get out of a container type such as <code>List</code>, or
    otherwise returned by some method.</p>
    <h3 data-number="4.6.3" id="contravariance"><span class="header-section-number">4.6.3</span> Contravariance</h3>
    <p>What about contravariance? We write contravariant type
    constructors with a <code>-</code> symbol like this:</p>
    <div class="sourceCode" id="cb227"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> F<span class="op">[-</span>A<span class="op">]</span></span></code></pre></div>
    <p>Perhaps confusingly, contravariance means that the type
    <code>F[B]</code> is a subtype of <code>F[A]</code> if
    <code>A</code> is a subtype of <code>B</code>. This is useful for
    modelling types that represent inputs, like our
    <code>JsonWriter</code> type class above:</p>
    <div class="sourceCode" id="cb228"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb228-1"><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> JsonWriter<span class="op">[-</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb228-2"><a href="#cb228-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">write</span><span class="op">(</span>value<span class="op">:</span> A<span class="op">):</span> Json</span>
<span id="cb228-3"><a href="#cb228-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Let’s unpack this a bit further. Remember that variance is all
    about the ability to substitute one value for another. Consider a
    scenario where we have two values, one of type <code>Shape</code>
    and one of type <code>Circle</code>, and two
    <code>JsonWriters</code>, one for <code>Shape</code> and one for
    <code>Circle</code>:</p>
    <div class="sourceCode" id="cb229"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> shape<span class="op">:</span> <span class="ex">Shape</span> <span class="op">=</span> <span class="op">???</span></span>
<span id="cb229-2"><a href="#cb229-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> circle<span class="op">:</span> Circle <span class="op">=</span> <span class="op">???</span></span>
<span id="cb229-3"><a href="#cb229-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb229-4"><a href="#cb229-4" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> shapeWriter<span class="op">:</span> JsonWriter<span class="op">[</span><span class="ex">Shape</span><span class="op">]</span> <span class="op">=</span> <span class="op">???</span></span>
<span id="cb229-5"><a href="#cb229-5" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> circleWriter<span class="op">:</span> JsonWriter<span class="op">[</span>Circle<span class="op">]</span> <span class="op">=</span> <span class="op">???</span></span></code></pre></div>
    <div class="sourceCode" id="cb230"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> format<span class="op">[</span>A<span class="op">](</span>value<span class="op">:</span> A<span class="op">,</span> writer<span class="op">:</span> JsonWriter<span class="op">[</span>A<span class="op">]):</span> Json <span class="op">=</span></span>
<span id="cb230-2"><a href="#cb230-2" aria-hidden="true" tabindex="-1"></a>  writer<span class="op">.</span><span class="fu">write</span><span class="op">(</span>value<span class="op">)</span></span></code></pre></div>
    <p>Now ask yourself the question: “Which combinations of value and
    writer can I pass to <code>format</code>?” We can <code>write</code>
    a <code>Circle</code> with either writer because all
    <code>Circles</code> are <code>Shapes</code>. Conversely, we can’t
    write a <code>Shape</code> with <code>circleWriter</code> because
    not all <code>Shapes</code> are <code>Circles</code>.</p>
    <p>This relationship is what we formally model using contravariance.
    <code>JsonWriter[Shape]</code> is a subtype of
    <code>JsonWriter[Circle]</code> because <code>Circle</code> is a
    subtype of <code>Shape</code>. This means we can use
    <code>shapeWriter</code> anywhere we expect to see a
    <code>JsonWriter[Circle]</code>.</p>
    <h3 data-number="4.6.4" id="invariance"><span class="header-section-number">4.6.4</span> Invariance</h3>
    <p>Invariance is the easiest situation to describe. It’s what we get
    when we don’t write a <code>+</code> or <code>-</code> in a type
    constructor:</p>
    <div class="sourceCode" id="cb231"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb231-1"><a href="#cb231-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> F<span class="op">[</span>A<span class="op">]</span></span></code></pre></div>
    <p>This means the types <code>F[A]</code> and <code>F[B]</code> are
    never subtypes of one another, no matter what the relationship
    between <code>A</code> and <code>B</code>. This is the default
    semantics for Scala type constructors.</p>
    <h3 data-number="4.6.5" id="variance-and-instance-selection"><span class="header-section-number">4.6.5</span> Variance and Instance
    Selection</h3>
    <p>When the compiler searches for a given instnace it looks for one
    matching the type <em>or subtype</em>. Thus we can use variance
    annotations to control type class instance selection to some
    extent.</p>
    <p>There are two issues that tend to arise. Let’s imagine we have an
    algebraic data type like:</p>
    <div class="sourceCode" id="cb232"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a>enum A <span class="op">{</span></span>
<span id="cb232-2"><a href="#cb232-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> B</span>
<span id="cb232-3"><a href="#cb232-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> C</span>
<span id="cb232-4"><a href="#cb232-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>The issues are:</p>
    <ol type="1">
    <li><p>Will an instance defined on a supertype be selected if one is
    available? For example, can we define an instance for <code>A</code>
    and have it work for values of type <code>B</code> and
    <code>C</code>?</p></li>
    <li><p>Will an instance for a subtype be selected in preference to
    that of a supertype. For instance, if we define an instance for
    <code>A</code> and <code>B</code>, and we have a value of type
    <code>B</code>, will the instance for <code>B</code> be selected in
    preference to <code>A</code>?</p></li>
    </ol>
    <p>It turns out we can’t have both at once. The three choices give
    us behaviour as follows:</p>
    <div class="table-responsive">
    <table style="width:100%;">
    <colgroup>
    <col style="width: 44%" />
    <col style="width: 16%" />
    <col style="width: 16%" />
    <col style="width: 22%" />
    </colgroup>
    <thead>
    <tr class="header">
    <th style="text-align: left;">Type Class Variance</th>
    <th style="text-align: left;">Invariant</th>
    <th style="text-align: left;">Covariant</th>
    <th style="text-align: left;">Contravariant</th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td style="text-align: left;">Supertype instance used?</td>
    <td style="text-align: left;">No</td>
    <td style="text-align: left;">No</td>
    <td style="text-align: left;">Yes</td>
    </tr>
    <tr class="even">
    <td style="text-align: left;">More specific type preferred?</td>
    <td style="text-align: left;">No</td>
    <td style="text-align: left;">Yes</td>
    <td style="text-align: left;">No</td>
    </tr>
    </tbody>
    </table>
    </div>
    <p>Let’s see some examples, using the following types to show the
    subtyping relationship.</p>
    <div class="sourceCode" id="cb233"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb233-1"><a href="#cb233-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Animal</span>
<span id="cb233-2"><a href="#cb233-2" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Cat <span class="kw">extends</span> Animal</span>
<span id="cb233-3"><a href="#cb233-3" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> DomesticShorthair <span class="kw">extends</span> Cat</span></code></pre></div>
    <p>Now we’ll define three different type classes for the three types
    of variance, and define an instance of each for the <code>Cat</code>
    type.</p>
    <div class="sourceCode" id="cb234"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Inv<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb234-2"><a href="#cb234-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> result<span class="op">:</span> <span class="ex">String</span></span>
<span id="cb234-3"><a href="#cb234-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb234-4"><a href="#cb234-4" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Inv <span class="op">{</span></span>
<span id="cb234-5"><a href="#cb234-5" aria-hidden="true" tabindex="-1"></a>  given Inv<span class="op">[</span>Cat<span class="op">]</span> <span class="kw">with</span></span>
<span id="cb234-6"><a href="#cb234-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> result <span class="op">=</span> <span class="st">&quot;Invariant&quot;</span></span>
<span id="cb234-7"><a href="#cb234-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb234-8"><a href="#cb234-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> apply<span class="op">[</span>A<span class="op">](</span>using instance<span class="op">:</span> Inv<span class="op">[</span>A<span class="op">]):</span> <span class="ex">String</span> <span class="op">=</span></span>
<span id="cb234-9"><a href="#cb234-9" aria-hidden="true" tabindex="-1"></a>    instance<span class="op">.</span>result</span>
<span id="cb234-10"><a href="#cb234-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb234-11"><a href="#cb234-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-12"><a href="#cb234-12" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Co<span class="op">[+</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb234-13"><a href="#cb234-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> result<span class="op">:</span> <span class="ex">String</span></span>
<span id="cb234-14"><a href="#cb234-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb234-15"><a href="#cb234-15" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Co <span class="op">{</span></span>
<span id="cb234-16"><a href="#cb234-16" aria-hidden="true" tabindex="-1"></a>  given Co<span class="op">[</span>Cat<span class="op">]</span> <span class="kw">with</span></span>
<span id="cb234-17"><a href="#cb234-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> result <span class="op">=</span> <span class="st">&quot;Covariant&quot;</span></span>
<span id="cb234-18"><a href="#cb234-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-19"><a href="#cb234-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> apply<span class="op">[</span>A<span class="op">](</span>using instance<span class="op">:</span> Co<span class="op">[</span>A<span class="op">]):</span> <span class="ex">String</span> <span class="op">=</span></span>
<span id="cb234-20"><a href="#cb234-20" aria-hidden="true" tabindex="-1"></a>    instance<span class="op">.</span>result</span>
<span id="cb234-21"><a href="#cb234-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb234-22"><a href="#cb234-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-23"><a href="#cb234-23" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Contra<span class="op">[-</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb234-24"><a href="#cb234-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> result<span class="op">:</span> <span class="ex">String</span></span>
<span id="cb234-25"><a href="#cb234-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb234-26"><a href="#cb234-26" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Contra <span class="op">{</span></span>
<span id="cb234-27"><a href="#cb234-27" aria-hidden="true" tabindex="-1"></a>  given Contra<span class="op">[</span>Cat<span class="op">]</span> <span class="kw">with</span></span>
<span id="cb234-28"><a href="#cb234-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> result <span class="op">=</span> <span class="st">&quot;Contravariant&quot;</span></span>
<span id="cb234-29"><a href="#cb234-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-30"><a href="#cb234-30" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> apply<span class="op">[</span>A<span class="op">](</span>using instance<span class="op">:</span> Contra<span class="op">[</span>A<span class="op">]):</span> <span class="ex">String</span> <span class="op">=</span></span>
<span id="cb234-31"><a href="#cb234-31" aria-hidden="true" tabindex="-1"></a>    instance<span class="op">.</span>result</span>
<span id="cb234-32"><a href="#cb234-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Now the cases that work, all of which select the <code>Cat</code>
    instance. For the invariant case we must ask for exactly the
    <code>Cat</code> type. For the covariant case we can ask for a
    supertype of <code>Cat</code>. For contravariance we can ask for a
    subtype of <code>Cat</code>.</p>
    <div class="sourceCode" id="cb235"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a>Inv<span class="op">[</span>Cat<span class="op">]</span></span>
<span id="cb235-2"><a href="#cb235-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: String = &quot;Invariant&quot;</span></span>
<span id="cb235-3"><a href="#cb235-3" aria-hidden="true" tabindex="-1"></a>Co<span class="op">[</span>Animal<span class="op">]</span></span>
<span id="cb235-4"><a href="#cb235-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: String = &quot;Covariant&quot;</span></span>
<span id="cb235-5"><a href="#cb235-5" aria-hidden="true" tabindex="-1"></a>Co<span class="op">[</span>Cat<span class="op">]</span></span>
<span id="cb235-6"><a href="#cb235-6" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: String = &quot;Covariant&quot;</span></span>
<span id="cb235-7"><a href="#cb235-7" aria-hidden="true" tabindex="-1"></a>Contra<span class="op">[</span>DomesticShorthair<span class="op">]</span></span>
<span id="cb235-8"><a href="#cb235-8" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: String = &quot;Contravariant&quot;</span></span>
<span id="cb235-9"><a href="#cb235-9" aria-hidden="true" tabindex="-1"></a>Contra<span class="op">[</span>Cat<span class="op">]</span></span>
<span id="cb235-10"><a href="#cb235-10" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: String = &quot;Contravariant&quot;</span></span></code></pre></div>
    <p>Now cases that fail. With invariance any type that is not
    <code>Cat</code> will fail. So the supertype fails</p>
    <div class="sourceCode" id="cb236"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a>Inv<span class="op">[</span>Animal<span class="op">]</span></span>
<span id="cb236-2"><a href="#cb236-2" aria-hidden="true" tabindex="-1"></a><span class="co">// error: </span></span>
<span id="cb236-3"><a href="#cb236-3" aria-hidden="true" tabindex="-1"></a><span class="co">// No given instance of type MdocApp0.this.Inv[MdocApp0.this.Animal] was found for parameter instance of method apply in object Inv</span></span></code></pre></div>
    <p>as does the subtype.</p>
    <div class="sourceCode" id="cb237"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a>Inv<span class="op">[</span>DomesticShorthair<span class="op">]</span></span>
<span id="cb237-2"><a href="#cb237-2" aria-hidden="true" tabindex="-1"></a><span class="co">// error: </span></span>
<span id="cb237-3"><a href="#cb237-3" aria-hidden="true" tabindex="-1"></a><span class="co">// No given instance of type MdocApp0.this.Inv[MdocApp0.this.DomesticShorthair] was found for parameter instance of method apply in object Inv</span></span></code></pre></div>
    <p>Covariance fails for any subtype of the type for which the
    instance is declared.</p>
    <div class="sourceCode" id="cb238"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a>Co<span class="op">[</span>DomesticShorthair<span class="op">]</span></span>
<span id="cb238-2"><a href="#cb238-2" aria-hidden="true" tabindex="-1"></a><span class="co">// error: </span></span>
<span id="cb238-3"><a href="#cb238-3" aria-hidden="true" tabindex="-1"></a><span class="co">// No given instance of type MdocApp0.this.Co[MdocApp0.this.DomesticShorthair] was found for parameter instance of method apply in object Co</span></span></code></pre></div>
    <p>Contravariance fails for any supertype of the type for which the
    instance is declared.</p>
    <div class="sourceCode" id="cb239"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a>Contra<span class="op">[</span>Animal<span class="op">]</span></span>
<span id="cb239-2"><a href="#cb239-2" aria-hidden="true" tabindex="-1"></a><span class="co">// error: </span></span>
<span id="cb239-3"><a href="#cb239-3" aria-hidden="true" tabindex="-1"></a><span class="co">// No given instance of type MdocApp0.this.Contra[MdocApp0.this.Animal] was found for parameter instance of method apply in object Contra</span></span></code></pre></div>
    <p>It’s clear there is no perfect system. The most choice is to use
    invariant type classes. This allows us to specify more specific
    instances for subtypes if we want. It does mean that if we have, for
    example, a value of type <code>Some[Int]</code>, our type class
    instance for <code>Option</code> will not be used. We can solve this
    problem with a type annotation like
    <code>Some(1) : Option[Int]</code> or by using “smart constructors”
    like the <code>Option.apply</code>, <code>Option.empty</code>,
    <code>some</code>, and <code>none</code> methods we saw in Section
    6.3.3.</p>
    <h2 data-number="4.7" id="conclusions-2"><span class="header-section-number">4.7</span> Conclusions</h2>
    <p>In this chapter we took a first look at type classes. We saw the
    components that make up a type class:</p>
    <ul>
    <li><p>A <code>trait</code>, which is the type class</p></li>
    <li><p>Type class instances, which are given instances.</p></li>
    <li><p>Type class usage, which uses using clauses.</p></li>
    </ul>
    <p>We saw that type classes can be composed from components using
    type class composition. This is one form of metaprogramming in
    Scala, where we can get the compiler to do work for us based on our
    program’s types.</p>
    <p>We can view type classes as marrying codata with tools to select
    and compose implementations based on type. We can also view type
    classes as shifting implementation from the definition site to the
    call site. Finally, can see type classes as a mechanism for ad-hoc
    polymorphism, allowing us to define common functionality for
    otherwise unrelated types.</p>
    <p>Type classes were first described in <span class="citation" data-cites="10.1007/3-540-19027-9_9">Kaes [1988]</span> and <span class="citation" data-cites="10.1145/75277.75283">Wadler and Blott
    [1989]</span>. <span class="citation" data-cites="10.1145/1869459.1869489">Oliveira et al. [2010]</span>
    details the encoding of type classes in Scala 2, and compares
    Scala’s and Haskell’s approach to type classes. Note that type
    classes are not restricted to Haskell and Scala. For examples,
    Rust’s traits are essentially type classes.</p>
    <p>As we have seen, Scala’s support for type classes is based on
    implicit parameters (known as using clauses in Scala 3). Implicit
    parameters <span class="citation" data-cites="10.1145/325694.325708">[Lewis et al. 2000]</span> were
    motivated by a desire to decompose type classes into smaller
    orthogonal language features, but they have been shown to be useful
    for other tasks. <span class="citation" data-cites="10.1145/3360589">Křikava et al. [2019]</span> surveys
    different uses of implicits in Scala. See <span class="citation" data-cites="OLIVEIRA_GIBBONS_2010">Oliveira and Gibbons
    [2010]</span> for a particularly mind-bending example. We’ll see
    some of these different uses in later chapters.</p>
    <p>Scala 3 has a few language features related to contextual
    abstraction that we haven’t mentioned in this chapter. Context
    functions <span class="citation" data-cites="10.1145/3158130">[Odersky et al. 2017]</span> allow
    functions to have using clauses. They are something the community is
    still exploring, and well defined use cases have yet to emerge.
    Generic derivation allows us to write code that generates type
    classes instances. Although this is extremely useful I think it’s
    conceptually quite simple and doesn’t warrant space in this
    book.</p>
    <h1 data-number="5" id="sec:interpreters"><span class="header-section-number">5</span> Reified Interpreters</h1>
    <p>The interpreter strategy is perhaps the most important in all of
    functional programming. The central idea is to <strong>separate
    description from action</strong>. When we use the interpreter
    strategy our program consists of two parts: the description,
    instructions, or program that describes what we want to do, and the
    interpreter that carries the actions in the description. In this
    chapter we’ll start exploring the design and implementation of
    interpreters, focusing on implementations using algebraic data
    types.</p>
    <p>Interpreters arise whenever there is this distinction between
    description and action. You may think an interpreter is a complex
    piece requiring a lot of development effort, but I hope to show you
    this is not the case. You probably already use lots of interpreters
    in your daily coding without realizing it. For example, consider the
    code below which is taken from a web framework called <a href="https://github.com/creativescala/krop">Krop</a></p>
    <div class="sourceCode" id="cb240"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> route <span class="op">=</span></span>
<span id="cb240-2"><a href="#cb240-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Route</span><span class="op">(</span></span>
<span id="cb240-3"><a href="#cb240-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Request</span><span class="op">.</span><span class="fu">get</span><span class="op">(</span>Path<span class="op">.</span>root <span class="op">/</span> <span class="st">&quot;user&quot;</span> <span class="op">/</span> Param<span class="op">.</span><span class="dt">int</span><span class="op">),</span></span>
<span id="cb240-4"><a href="#cb240-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Response</span><span class="op">.</span><span class="fu">ok</span><span class="op">(</span><span class="ex">Entity</span><span class="op">.</span>text<span class="op">)</span></span>
<span id="cb240-5"><a href="#cb240-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">).</span><span class="fu">handle</span><span class="op">(</span>userId <span class="op">=&gt;</span> <span class="ss">s&quot;</span><span class="st">You asked for the user </span><span class="ss">${</span>userId<span class="op">.</span>toString<span class="ss">}&quot;</span><span class="op">)</span></span></code></pre></div>
    <p>This defines a route, which matches <code>GET</code> requests for
    the path <code>&quot;/user/&lt;int&gt;&quot;</code>, and responds with an
    <code>Ok</code> containing text. This kind of routing library is
    ubiquitous in web frameworks, is simple to write, and yet contains
    everything we need for the interpreter strategy.</p>
    <p>Interpreters are so important because they are the key to
    enabling compositionality and reasoning, particularly while allowing
    effects. For example, imagine implementing a graphics library using
    the interpreter strategy. A program simply describes what we want to
    draw on the screen, but critically it does not draw anything. The
    interpreter takes this description and creates the drawing described
    by it. We can freely compose descriptions only because they do not
    carry out any effects. For example, if we have a description that
    describes a circle, and one for a square, we can compose them by
    saying we should draw the circle next to the square thereby creating
    a new description. If we immediately drew pictures there would be
    nothing to compose with. Similarly, it’s easier to reason about
    pictures in this system because a program describes exactly what
    will appear on the screen, and there is no state from prior drawing
    that we need to worry about.</p>
    <p>Throughout this chapter we will explore the interpreter strategy
    by building a series of interpreters for regular expressions. We’ve
    chosen to use regular expressions because they are already familiar
    to many and they are simple to work with. This means we can focus on
    the details of the interpreter strategy without getting caught up in
    problem specific details, but we still end up with a realistic and
    useful result.</p>
    <p>We’ll start with a basic implementation strategy that uses
    algebraic data types and structural recursion. We’ll then look at
    transformations to turn our interpreter into a version that avoids
    using the stack and hence avoids the possibility of stack
    overflow.</p>
    <h2 data-number="5.1" id="regular-expressions"><span class="header-section-number">5.1</span> Regular Expressions</h2>
    <p>We’ll start this case study by briefly describing the usual task
    for regular expressions—matching text—and then take a more
    theoretical view. We’ll then move on to implementation.</p>
    <p>We most commonly use regular expressions to determine if a string
    matches a particular pattern. The simplest regular expression is one
    that matches only one string. In Scala we can create a regular
    expression by calling the <code>r</code> method on
    <code>String</code>. Here’s a regular expression that matches
    exactly the string <code>&quot;Scala&quot;</code>.</p>
    <div class="sourceCode" id="cb241"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> regexp <span class="op">=</span> <span class="st">&quot;Scala&quot;</span><span class="op">.</span>r</span></code></pre></div>
    <p>We can see that it matches only <code>&quot;Scala&quot;</code> and fails if
    we give it a shorter or longer input.</p>
    <div class="sourceCode" id="cb242"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a>regexp<span class="op">.</span><span class="fu">matches</span><span class="op">(</span><span class="st">&quot;Scala&quot;</span><span class="op">)</span></span>
<span id="cb242-2"><a href="#cb242-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res0: Boolean = true</span></span>
<span id="cb242-3"><a href="#cb242-3" aria-hidden="true" tabindex="-1"></a>regexp<span class="op">.</span><span class="fu">matches</span><span class="op">(</span><span class="st">&quot;Sca&quot;</span><span class="op">)</span></span>
<span id="cb242-4"><a href="#cb242-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: Boolean = false</span></span>
<span id="cb242-5"><a href="#cb242-5" aria-hidden="true" tabindex="-1"></a>regexp<span class="op">.</span><span class="fu">matches</span><span class="op">(</span><span class="st">&quot;Scalaland&quot;</span><span class="op">)</span></span>
<span id="cb242-6"><a href="#cb242-6" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: Boolean = false</span></span></code></pre></div>
    <p>Notice we already have a separation between description and
    action. The description is the regular expression itself, created by
    calling the <code>r</code> method, and the action is calling the
    <code>matches</code> method on the regular expression.</p>
    <p>There are some characters that have a special meaning within the
    <code>String</code> describing a regular expression. For example,
    the character <code>*</code> matches the preceding character zero or
    more times.</p>
    <div class="sourceCode" id="cb243"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> regexp <span class="op">=</span> <span class="st">&quot;Scala*&quot;</span><span class="op">.</span>r</span></code></pre></div>
    <div class="sourceCode" id="cb244"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a>regexp<span class="op">.</span><span class="fu">matches</span><span class="op">(</span><span class="st">&quot;Scal&quot;</span><span class="op">)</span></span>
<span id="cb244-2"><a href="#cb244-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: Boolean = true</span></span>
<span id="cb244-3"><a href="#cb244-3" aria-hidden="true" tabindex="-1"></a>regexp<span class="op">.</span><span class="fu">matches</span><span class="op">(</span><span class="st">&quot;Scala&quot;</span><span class="op">)</span></span>
<span id="cb244-4"><a href="#cb244-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: Boolean = true</span></span>
<span id="cb244-5"><a href="#cb244-5" aria-hidden="true" tabindex="-1"></a>regexp<span class="op">.</span><span class="fu">matches</span><span class="op">(</span><span class="st">&quot;Scalaaaa&quot;</span><span class="op">)</span></span>
<span id="cb244-6"><a href="#cb244-6" aria-hidden="true" tabindex="-1"></a><span class="co">// res6: Boolean = true</span></span></code></pre></div>
    <p>We can also use parentheses to group sequences of characters. For
    example, if we wanted to match all the strings like
    <code>&quot;Scala&quot;</code>, <code>&quot;Scalala&quot;</code>,
    <code>&quot;Scalalala&quot;</code> and so on, we could use the following
    regular expression.</p>
    <div class="sourceCode" id="cb245"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb245-1"><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> regexp <span class="op">=</span> <span class="st">&quot;Scala(la)*&quot;</span><span class="op">.</span>r</span></code></pre></div>
    <p>Let’s check it matches what we’re looking for.</p>
    <div class="sourceCode" id="cb246"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a>regexp<span class="op">.</span><span class="fu">matches</span><span class="op">(</span><span class="st">&quot;Scala&quot;</span><span class="op">)</span></span>
<span id="cb246-2"><a href="#cb246-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res8: Boolean = true</span></span>
<span id="cb246-3"><a href="#cb246-3" aria-hidden="true" tabindex="-1"></a>regexp<span class="op">.</span><span class="fu">matches</span><span class="op">(</span><span class="st">&quot;Scalalalala&quot;</span><span class="op">)</span></span>
<span id="cb246-4"><a href="#cb246-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res9: Boolean = true</span></span></code></pre></div>
    <p>We should also check it fails to match as expected.</p>
    <div class="sourceCode" id="cb247"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb247-1"><a href="#cb247-1" aria-hidden="true" tabindex="-1"></a>regexp<span class="op">.</span><span class="fu">matches</span><span class="op">(</span><span class="st">&quot;Sca&quot;</span><span class="op">)</span></span>
<span id="cb247-2"><a href="#cb247-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res10: Boolean = false</span></span>
<span id="cb247-3"><a href="#cb247-3" aria-hidden="true" tabindex="-1"></a>regexp<span class="op">.</span><span class="fu">matches</span><span class="op">(</span><span class="st">&quot;Scalal&quot;</span><span class="op">)</span></span>
<span id="cb247-4"><a href="#cb247-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res11: Boolean = false</span></span>
<span id="cb247-5"><a href="#cb247-5" aria-hidden="true" tabindex="-1"></a>regexp<span class="op">.</span><span class="fu">matches</span><span class="op">(</span><span class="st">&quot;Scalaland&quot;</span><span class="op">)</span></span>
<span id="cb247-6"><a href="#cb247-6" aria-hidden="true" tabindex="-1"></a><span class="co">// res12: Boolean = false</span></span></code></pre></div>
    <p>That’s all I’m going to say about Scala’s built-in regular
    expressions. If you’d like to learn more there are many resources
    online. The <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/regex/Pattern.html">JDK
    documentation</a> is one example, which describes all the features
    available in the JVM implementation of regular expressions.</p>
    <p>Let’s turn to the theoretical description, such as we might find
    in a textbook. A regular expression is:</p>
    <ol type="1">
    <li>the empty regular expression that matches nothing;</li>
    <li>a string, which matches exactly that string (including the empty
    string);</li>
    <li>the concatenation of two regular expressions, which matches the
    first regular expression and then the second;</li>
    <li>the union of two regular expressions, which matches if either
    expression matches; and</li>
    <li>the repetition of a regular expression (often known as the
    Kleene star), which matches zero or more repetitions of the
    underlying expression.</li>
    </ol>
    <p>This kind of description may seem very abstract if you’re not
    used to it. It is very useful for our purposes because it defines a
    minimal API that we can easily implement. Let’s walk through the
    description and see how each part relates to code.</p>
    <p>The empty regular expression is defining a constructor with type
    <code>() =&gt; Regexp</code>, which we can simplify to a value of
    type <code>Regexp</code>. In Scala we put constructors on the
    companion object, so this tells us we need</p>
    <div class="sourceCode" id="cb248"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Regexp <span class="op">{</span></span>
<span id="cb248-2"><a href="#cb248-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> empty<span class="op">:</span> Regexp <span class="op">=</span></span>
<span id="cb248-3"><a href="#cb248-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb248-4"><a href="#cb248-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>The second part tells us we need another constructor, this one
    with type <code>String =&gt; Regexp</code>.</p>
    <div class="sourceCode" id="cb249"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb249-1"><a href="#cb249-1" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Regexp <span class="op">{</span></span>
<span id="cb249-2"><a href="#cb249-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> empty<span class="op">:</span> Regexp <span class="op">=</span></span>
<span id="cb249-3"><a href="#cb249-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb249-4"><a href="#cb249-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-5"><a href="#cb249-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>string<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> Regexp <span class="op">=</span></span>
<span id="cb249-6"><a href="#cb249-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb249-7"><a href="#cb249-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>The other three components all take a regular expression and
    produce a regular expression. In Scala these will become methods on
    the <code>Regexp</code> type. Let’s model this as a
    <code>trait</code> for now, and define these methods.</p>
    <p>The first method, the concatenation of two regular expressions,
    is conventionally called <code>++</code> in Scala.</p>
    <div class="sourceCode" id="cb250"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Regexp <span class="op">{</span></span>
<span id="cb250-2"><a href="#cb250-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">++(</span>that<span class="op">:</span> Regexp<span class="op">):</span> Regexp</span>
<span id="cb250-3"><a href="#cb250-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Union is conventionally called <code>orElse</code>.</p>
    <div class="sourceCode" id="cb251"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Regexp <span class="op">{</span></span>
<span id="cb251-2"><a href="#cb251-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">++(</span>that<span class="op">:</span> Regexp<span class="op">):</span> Regexp</span>
<span id="cb251-3"><a href="#cb251-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">orElse</span><span class="op">(</span>that<span class="op">:</span> Regexp<span class="op">):</span> Regexp</span>
<span id="cb251-4"><a href="#cb251-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Repetition we’ll call <code>repeat</code>, and define an alias
    <code>*</code> that matches how this operation is written in
    conventional regular expressions.</p>
    <div class="sourceCode" id="cb252"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Regexp <span class="op">{</span></span>
<span id="cb252-2"><a href="#cb252-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">++(</span>that<span class="op">:</span> Regexp<span class="op">):</span> Regexp</span>
<span id="cb252-3"><a href="#cb252-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">orElse</span><span class="op">(</span>that<span class="op">:</span> Regexp<span class="op">):</span> Regexp</span>
<span id="cb252-4"><a href="#cb252-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> repeat<span class="op">:</span> Regexp</span>
<span id="cb252-5"><a href="#cb252-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> `<span class="op">*</span>`<span class="op">:</span> Regexp <span class="op">=</span> <span class="kw">this</span><span class="op">.</span>repeat</span>
<span id="cb252-6"><a href="#cb252-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>We’re missing one thing: a method to actually match our regular
    expression against some input. Let’s call this method
    <code>matches</code>.</p>
    <div class="sourceCode" id="cb253"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Regexp <span class="op">{</span></span>
<span id="cb253-2"><a href="#cb253-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">++(</span>that<span class="op">:</span> Regexp<span class="op">):</span> Regexp</span>
<span id="cb253-3"><a href="#cb253-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">orElse</span><span class="op">(</span>that<span class="op">:</span> Regexp<span class="op">):</span> Regexp</span>
<span id="cb253-4"><a href="#cb253-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> repeat<span class="op">:</span> Regexp</span>
<span id="cb253-5"><a href="#cb253-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> `<span class="op">*</span>`<span class="op">:</span> Regexp <span class="op">=</span> <span class="kw">this</span><span class="op">.</span>repeat</span>
<span id="cb253-6"><a href="#cb253-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb253-7"><a href="#cb253-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">matches</span><span class="op">(</span>input<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Boolean</span></span>
<span id="cb253-8"><a href="#cb253-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>This completes our API. Now we can turn to implementation. We’re
    going to represent <code>Regexp</code> as an algebraic data type,
    and each method that returns a <code>Regexp</code> will return an
    instance of this algebraic data type. What should be the elements
    that make up the algebraic data type? There will be one element for
    each method, and the constructor arguments will be exactly the
    parameters passed to the method <em>including the hidden
    <code>this</code> parameter for methods on the trait</em>.</p>
    <p>Here’s the resulting code.</p>
    <div class="sourceCode" id="cb254"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a>enum Regexp <span class="op">{</span></span>
<span id="cb254-2"><a href="#cb254-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">++(</span>that<span class="op">:</span> Regexp<span class="op">):</span> Regexp <span class="op">=</span></span>
<span id="cb254-3"><a href="#cb254-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Append</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb254-4"><a href="#cb254-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-5"><a href="#cb254-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">orElse</span><span class="op">(</span>that<span class="op">:</span> Regexp<span class="op">):</span> Regexp <span class="op">=</span></span>
<span id="cb254-6"><a href="#cb254-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">OrElse</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb254-7"><a href="#cb254-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-8"><a href="#cb254-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> repeat<span class="op">:</span> Regexp <span class="op">=</span></span>
<span id="cb254-9"><a href="#cb254-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Repeat</span><span class="op">(</span><span class="kw">this</span><span class="op">)</span></span>
<span id="cb254-10"><a href="#cb254-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-11"><a href="#cb254-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> `<span class="op">*</span>`<span class="op">:</span> Regexp <span class="op">=</span> <span class="kw">this</span><span class="op">.</span>repeat</span>
<span id="cb254-12"><a href="#cb254-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb254-13"><a href="#cb254-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">matches</span><span class="op">(</span>input<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Boolean</span> <span class="op">=</span></span>
<span id="cb254-14"><a href="#cb254-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb254-15"><a href="#cb254-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb254-16"><a href="#cb254-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Append</span><span class="op">(</span>left<span class="op">:</span> Regexp<span class="op">,</span> right<span class="op">:</span> Regexp<span class="op">)</span></span>
<span id="cb254-17"><a href="#cb254-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">OrElse</span><span class="op">(</span>first<span class="op">:</span> Regexp<span class="op">,</span> second<span class="op">:</span> Regexp<span class="op">)</span></span>
<span id="cb254-18"><a href="#cb254-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Repeat</span><span class="op">(</span>source<span class="op">:</span> Regexp<span class="op">)</span></span>
<span id="cb254-19"><a href="#cb254-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Apply</span><span class="op">(</span>string<span class="op">:</span> <span class="ex">String</span><span class="op">)</span></span>
<span id="cb254-20"><a href="#cb254-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> Empty</span>
<span id="cb254-21"><a href="#cb254-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb254-22"><a href="#cb254-22" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Regexp <span class="op">{</span></span>
<span id="cb254-23"><a href="#cb254-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> empty<span class="op">:</span> Regexp <span class="op">=</span> Empty</span>
<span id="cb254-24"><a href="#cb254-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb254-25"><a href="#cb254-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>string<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> Regexp <span class="op">=</span></span>
<span id="cb254-26"><a href="#cb254-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Apply</span><span class="op">(</span>string<span class="op">)</span></span>
<span id="cb254-27"><a href="#cb254-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>A quick note about <code>this</code>. We can think of every
    method on an object as accepting a hidden parameter that is the
    object itself. This is <code>this</code>. (If you have used Python,
    it makes this explicit as the <code>self</code> parameter.) As we
    consider <code>this</code> to be a parameter to a method call, and
    our implementation strategy is to capture all the method parameters
    in a data structure, we must make sure we capture <code>this</code>
    when it is available. The only case where we don’t capture
    <code>this</code> is when we are defining a constructor on a
    companion object.</p>
    <p>Notice that we haven’t implemented <code>matches</code>. It
    doesn’t return a <code>Regexp</code> so we cannot return an element
    of our algebraic data type. What should we do here?
    <code>Regexp</code> is an algebraic data type and
    <code>matches</code> transforms an algebraic data type into a
    <code>Boolean</code>. Therefore we can use structural recursion!
    Let’s write out the skeleton, including the recursion rule.</p>
    <div class="sourceCode" id="cb255"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">matches</span><span class="op">(</span>input<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Boolean</span> <span class="op">=</span></span>
<span id="cb255-2"><a href="#cb255-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb255-3"><a href="#cb255-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Append</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span>   <span class="op">=&gt;</span> left<span class="op">.</span><span class="fu">matches</span><span class="op">(???)</span> <span class="op">???</span> right<span class="op">.</span><span class="fu">matches</span><span class="op">(???)</span></span>
<span id="cb255-4"><a href="#cb255-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">OrElse</span><span class="op">(</span>first<span class="op">,</span> second<span class="op">)</span> <span class="op">=&gt;</span> first<span class="op">.</span><span class="fu">matches</span><span class="op">(???)</span> <span class="op">???</span> second<span class="op">.</span><span class="fu">matches</span><span class="op">(???)</span></span>
<span id="cb255-5"><a href="#cb255-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Repeat</span><span class="op">(</span>source<span class="op">)</span>        <span class="op">=&gt;</span> source<span class="op">.</span><span class="fu">matches</span><span class="op">(???)</span> <span class="op">???</span></span>
<span id="cb255-6"><a href="#cb255-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Apply</span><span class="op">(</span>string<span class="op">)</span>         <span class="op">=&gt;</span> <span class="op">???</span></span>
<span id="cb255-7"><a href="#cb255-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> Empty                 <span class="op">=&gt;</span> <span class="op">???</span></span>
<span id="cb255-8"><a href="#cb255-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>Now we can apply the usual strategies to complete the
    implementation. Let’s reason independently by case, starting with
    the case for <code>Empty</code>. This case is trivial as it always
    fails to match, so we just return <code>false</code>.</p>
    <div class="sourceCode" id="cb256"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">matches</span><span class="op">(</span>input<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Boolean</span> <span class="op">=</span></span>
<span id="cb256-2"><a href="#cb256-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb256-3"><a href="#cb256-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Append</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span>   <span class="op">=&gt;</span> left<span class="op">.</span><span class="fu">matches</span><span class="op">(???)</span> <span class="op">???</span> right<span class="op">.</span><span class="fu">matches</span><span class="op">(???)</span></span>
<span id="cb256-4"><a href="#cb256-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">OrElse</span><span class="op">(</span>first<span class="op">,</span> second<span class="op">)</span> <span class="op">=&gt;</span> first<span class="op">.</span><span class="fu">matches</span><span class="op">(???)</span> <span class="op">???</span> second<span class="op">.</span><span class="fu">matches</span><span class="op">(???)</span></span>
<span id="cb256-5"><a href="#cb256-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Repeat</span><span class="op">(</span>source<span class="op">)</span>        <span class="op">=&gt;</span> source<span class="op">.</span><span class="fu">matches</span><span class="op">(???)</span> <span class="op">???</span></span>
<span id="cb256-6"><a href="#cb256-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Apply</span><span class="op">(</span>string<span class="op">)</span>         <span class="op">=&gt;</span> <span class="op">???</span></span>
<span id="cb256-7"><a href="#cb256-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> Empty                 <span class="op">=&gt;</span> <span class="kw">false</span></span>
<span id="cb256-8"><a href="#cb256-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>Let’s move on to the <code>Append</code> case. This should match
    if the <code>left</code> regular expression matches the start of the
    <code>input</code>, and the <code>right</code> regular expression
    matches starting where the <code>left</code> regular expression
    stopped. This has uncovered a hidden requirement: we need to keep an
    index into the <code>input</code> that tells us where we should
    start matching from. Using a nested method is the easiest way to
    keep around additional information that we need. Here I’ve created a
    nested method that returns an <code>Option[Int]</code>. The
    <code>Int</code> is the new index to use, and we return an
    <code>Option</code> to indicate if the regular expression matched or
    not.</p>
    <div class="sourceCode" id="cb257"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">matches</span><span class="op">(</span>input<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Boolean</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb257-2"><a href="#cb257-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">loop</span><span class="op">(</span>regexp<span class="op">:</span> Regexp<span class="op">,</span> idx<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb257-3"><a href="#cb257-3" aria-hidden="true" tabindex="-1"></a>    regexp <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb257-4"><a href="#cb257-4" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Append</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb257-5"><a href="#cb257-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">loop</span><span class="op">(</span>left<span class="op">,</span> idx<span class="op">).</span><span class="fu">flatMap</span><span class="op">(</span>idx <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>right<span class="op">,</span> idx<span class="op">))</span></span>
<span id="cb257-6"><a href="#cb257-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">OrElse</span><span class="op">(</span>first<span class="op">,</span> second<span class="op">)</span> <span class="op">=&gt;</span> </span>
<span id="cb257-7"><a href="#cb257-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">loop</span><span class="op">(</span>first<span class="op">,</span> idx<span class="op">)</span> <span class="op">???</span> <span class="fu">loop</span><span class="op">(</span>second<span class="op">,</span> <span class="op">???)</span></span>
<span id="cb257-8"><a href="#cb257-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Repeat</span><span class="op">(</span>source<span class="op">)</span> <span class="op">=&gt;</span> </span>
<span id="cb257-9"><a href="#cb257-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">loop</span><span class="op">(</span>source<span class="op">,</span> idx<span class="op">)</span> <span class="op">???</span></span>
<span id="cb257-10"><a href="#cb257-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Apply</span><span class="op">(</span>string<span class="op">)</span> <span class="op">=&gt;</span> </span>
<span id="cb257-11"><a href="#cb257-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">???</span></span>
<span id="cb257-12"><a href="#cb257-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> Empty <span class="op">=&gt;</span></span>
<span id="cb257-13"><a href="#cb257-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">None</span></span>
<span id="cb257-14"><a href="#cb257-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb257-15"><a href="#cb257-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-16"><a href="#cb257-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check we matched the entire input</span></span>
<span id="cb257-17"><a href="#cb257-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loop</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> <span class="dv">0</span><span class="op">).</span><span class="fu">map</span><span class="op">(</span>idx <span class="op">=&gt;</span> idx <span class="op">==</span> input<span class="op">.</span>size<span class="op">).</span><span class="fu">getOrElse</span><span class="op">(</span><span class="kw">false</span><span class="op">)</span></span>
<span id="cb257-18"><a href="#cb257-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Now we can go ahead and complete the implementation.</p>
    <div class="sourceCode" id="cb258"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">matches</span><span class="op">(</span>input<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Boolean</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb258-2"><a href="#cb258-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">loop</span><span class="op">(</span>regexp<span class="op">:</span> Regexp<span class="op">,</span> idx<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb258-3"><a href="#cb258-3" aria-hidden="true" tabindex="-1"></a>    regexp <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb258-4"><a href="#cb258-4" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Append</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb258-5"><a href="#cb258-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">loop</span><span class="op">(</span>left<span class="op">,</span> idx<span class="op">).</span><span class="fu">flatMap</span><span class="op">(</span>i <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>right<span class="op">,</span> i<span class="op">))</span></span>
<span id="cb258-6"><a href="#cb258-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">OrElse</span><span class="op">(</span>first<span class="op">,</span> second<span class="op">)</span> <span class="op">=&gt;</span> </span>
<span id="cb258-7"><a href="#cb258-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">loop</span><span class="op">(</span>first<span class="op">,</span> idx<span class="op">).</span><span class="fu">orElse</span><span class="op">(</span><span class="fu">loop</span><span class="op">(</span>second<span class="op">,</span> idx<span class="op">))</span></span>
<span id="cb258-8"><a href="#cb258-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Repeat</span><span class="op">(</span>source<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb258-9"><a href="#cb258-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">loop</span><span class="op">(</span>source<span class="op">,</span> idx<span class="op">)</span></span>
<span id="cb258-10"><a href="#cb258-10" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">flatMap</span><span class="op">(</span>i <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>regexp<span class="op">,</span> i<span class="op">))</span></span>
<span id="cb258-11"><a href="#cb258-11" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">orElse</span><span class="op">(</span><span class="bu">Some</span><span class="op">(</span>idx<span class="op">))</span></span>
<span id="cb258-12"><a href="#cb258-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Apply</span><span class="op">(</span>string<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb258-13"><a href="#cb258-13" aria-hidden="true" tabindex="-1"></a>        <span class="ex">Option</span><span class="op">.</span><span class="fu">when</span><span class="op">(</span>input<span class="op">.</span><span class="fu">startsWith</span><span class="op">(</span>string<span class="op">,</span> idx<span class="op">))(</span>idx <span class="op">+</span> string<span class="op">.</span>size<span class="op">)</span></span>
<span id="cb258-14"><a href="#cb258-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb258-15"><a href="#cb258-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb258-16"><a href="#cb258-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check we matched the entire input</span></span>
<span id="cb258-17"><a href="#cb258-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loop</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> <span class="dv">0</span><span class="op">).</span><span class="fu">map</span><span class="op">(</span>idx <span class="op">=&gt;</span> idx <span class="op">==</span> input<span class="op">.</span>size<span class="op">).</span><span class="fu">getOrElse</span><span class="op">(</span><span class="kw">false</span><span class="op">)</span></span>
<span id="cb258-18"><a href="#cb258-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>The implementation for <code>Repeat</code> is a little tricky, so
    I’ll walk through the code.</p>
    <div class="sourceCode" id="cb259"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb259-1"><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="fu">Repeat</span><span class="op">(</span>source<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb259-2"><a href="#cb259-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loop</span><span class="op">(</span>source<span class="op">,</span> idx<span class="op">)</span></span>
<span id="cb259-3"><a href="#cb259-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">flatMap</span><span class="op">(</span>i <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>regexp<span class="op">,</span> i<span class="op">))</span></span>
<span id="cb259-4"><a href="#cb259-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">orElse</span><span class="op">(</span><span class="bu">Some</span><span class="op">(</span>idx<span class="op">))</span></span></code></pre></div>
    <p>The first line (<code>loop(source, index)</code>) is seeing if
    the <code>source</code> regular expression matches. If it does we
    loop again, but on <code>regexp</code> (which is
    <code>Repeat(source)</code>), not <code>source</code>. This is
    because we want to repeat an indefinite number of times. If we
    looped on <code>source</code> we would only try twice. Remember that
    failing to match is still a success; repeat matches zero or more
    times. This condition is handled by the <code>orElse</code>
    clause.</p>
    <p>We should test that our implementation works.</p>
    <p>Here’s the example regular expression we started the chapter
    with.</p>
    <div class="sourceCode" id="cb260"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> regexp <span class="op">=</span> <span class="fu">Regexp</span><span class="op">(</span><span class="st">&quot;Sca&quot;</span><span class="op">)</span> <span class="op">++</span> <span class="fu">Regexp</span><span class="op">(</span><span class="st">&quot;la&quot;</span><span class="op">)</span> <span class="op">++</span> <span class="fu">Regexp</span><span class="op">(</span><span class="st">&quot;la&quot;</span><span class="op">).</span>repeat</span></code></pre></div>
    <p>Here are cases that should succeed.</p>
    <div class="sourceCode" id="cb261"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a>regexp<span class="op">.</span><span class="fu">matches</span><span class="op">(</span><span class="st">&quot;Scala&quot;</span><span class="op">)</span></span>
<span id="cb261-2"><a href="#cb261-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res14: Boolean = true</span></span>
<span id="cb261-3"><a href="#cb261-3" aria-hidden="true" tabindex="-1"></a>regexp<span class="op">.</span><span class="fu">matches</span><span class="op">(</span><span class="st">&quot;Scalalalala&quot;</span><span class="op">)</span></span>
<span id="cb261-4"><a href="#cb261-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res15: Boolean = true</span></span></code></pre></div>
    <p>Here are cases that should fail.</p>
    <div class="sourceCode" id="cb262"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb262-1"><a href="#cb262-1" aria-hidden="true" tabindex="-1"></a>regexp<span class="op">.</span><span class="fu">matches</span><span class="op">(</span><span class="st">&quot;Sca&quot;</span><span class="op">)</span></span>
<span id="cb262-2"><a href="#cb262-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res16: Boolean = false</span></span>
<span id="cb262-3"><a href="#cb262-3" aria-hidden="true" tabindex="-1"></a>regexp<span class="op">.</span><span class="fu">matches</span><span class="op">(</span><span class="st">&quot;Scalal&quot;</span><span class="op">)</span></span>
<span id="cb262-4"><a href="#cb262-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res17: Boolean = false</span></span>
<span id="cb262-5"><a href="#cb262-5" aria-hidden="true" tabindex="-1"></a>regexp<span class="op">.</span><span class="fu">matches</span><span class="op">(</span><span class="st">&quot;Scalaland&quot;</span><span class="op">)</span></span>
<span id="cb262-6"><a href="#cb262-6" aria-hidden="true" tabindex="-1"></a><span class="co">// res18: Boolean = false</span></span></code></pre></div>
    <p>Success! At this point we could add many extensions to our
    library. For example, regular expressions usually have a method (by
    convention denoted <code>+</code>) that matches one or more times,
    and one that matches zero or once (usually denoted <code>?</code>).
    These are both conveniences we can build on our existing API.
    However, our goal at the moment is to fully understand interpreters
    and the implementation technique we’ve used here. So in the next
    section we’ll discuss these in detail.</p>
    <section id="regular-expression-semantics" class="unnumbered callout callout-info">
    <h4 class="unnumbered">Regular Expression Semantics</h4>
    <p>Our regular expression implementation handles union differently
    to Scala’s built-in regular expressions. Look at the following
    example comparing the two.</p>
    <div class="sourceCode" id="cb263"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb263-1"><a href="#cb263-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> r1 <span class="op">=</span> <span class="st">&quot;(z|zxy)ab&quot;</span><span class="op">.</span>r</span>
<span id="cb263-2"><a href="#cb263-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> r2 <span class="op">=</span> <span class="fu">Regexp</span><span class="op">(</span><span class="st">&quot;z&quot;</span><span class="op">).</span><span class="fu">orElse</span><span class="op">(</span><span class="fu">Regexp</span><span class="op">(</span><span class="st">&quot;zxy&quot;</span><span class="op">))</span> <span class="op">++</span> <span class="fu">Regexp</span><span class="op">(</span><span class="st">&quot;ab&quot;</span><span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb264"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb264-1"><a href="#cb264-1" aria-hidden="true" tabindex="-1"></a>r1<span class="op">.</span><span class="fu">matches</span><span class="op">(</span><span class="st">&quot;zxyab&quot;</span><span class="op">)</span></span>
<span id="cb264-2"><a href="#cb264-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res19: Boolean = true</span></span>
<span id="cb264-3"><a href="#cb264-3" aria-hidden="true" tabindex="-1"></a>r2<span class="op">.</span><span class="fu">matches</span><span class="op">(</span><span class="st">&quot;zxyab&quot;</span><span class="op">)</span></span>
<span id="cb264-4"><a href="#cb264-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res20: Boolean = false</span></span></code></pre></div>
    <p>The reason for this difference is that our implementation commits
    to the first branch in a union that successfully matches some of the
    input, regardless of how that affects later matching. We should
    instead try both branches, but doing so makes the implementation
    more complex. The semantics of regular expressions are not essential
    to what we’re trying to do here; we’re just using them as an example
    to motivate the programming strategies we’re learning. I decided the
    extra complexity of implementing union in the usual way outweighed
    the benefits, and so kept the simpler implementation. Don’t worry,
    we’ll see how to do it properly in the next chapter!</p>
    </section>
    <h2 data-number="5.2" id="sec:interpreters:reification"><span class="header-section-number">5.2</span> Interpreters and
    Reification</h2>
    <p>There are two different programming strategies at play in the
    regular expression code we’ve just written:</p>
    <ol type="1">
    <li>the interpreter strategy; and</li>
    <li>the interpreter’s implementation strategy of reification.</li>
    </ol>
    <p>Remember the essence of the <strong>interpreter strategy</strong>
    is to separate description and action. Therefore, whenever we use
    the interpreter strategy we need at least two things: a description
    and an interpreter. Descriptions are programs; things that we want
    to happen. The interpreter runs the programs, carrying out the
    actions described within them.</p>
    <p>In the regular expression example, a <code>Regexp</code> value is
    a program. It is a description of a pattern we are looking for
    within a <code>String</code>. The <code>matches</code> method is an
    interpreter. It carries out the instructions in the description,
    checking the pattern matches the entire input. We could have other
    interpreters, such as one that matches if at least some part of the
    input matches the pattern.</p>
    <h3 data-number="5.2.1" id="the-structure-of-interpreters"><span class="header-section-number">5.2.1</span> The Structure of
    Interpreters</h3>
    <p>All uses of the interpreter strategy have a particular structure
    to their methods. There are three different kinds of methods:</p>
    <ol type="1">
    <li><p><strong>constructors</strong>, or <strong>introduction
    forms</strong>, with type <code>A =&gt; Program</code>. Here
    <code>A</code> is any type that isn’t a program, and
    <code>Program</code> is the type of programs. Constructors
    conventionally live on the <code>Program</code> companion object in
    Scala. We see that <code>apply</code> is a constructor of
    <code>Regexp</code>. It has type <code>String =&gt; Regexp</code>,
    which matches the pattern <code>A =&gt; Program</code> for a
    constructor. The other constructor, <code>empty</code>, is just a
    value of type <code>Regexp</code>. This is equivalent to a method
    with type <code>() =&gt; Regexp</code> and so it also matches the
    pattern for a constructor.</p></li>
    <li><p><strong>combinators</strong> have at least one program input
    and a program output. The type is similar to
    <code>Program =&gt; Program</code> but there are often additional
    parameters. All of <code>++</code>, <code>orElse</code>, and
    <code>repeat</code> are combinators in our regular expression
    example. They all have a <code>Regexp</code> input (the
    <code>this</code> parameter) and produce a <code>Regexp</code>. Some
    of them have additional parameters, such as <code>++</code> or
    <code>orElse</code>. For both these methods the single additional
    parameter is a <code>Regexp</code>, but it is not the case that
    additional parameters to a combinator must be of the program type.
    Conventionally these methods live on the <code>Program</code>
    type.</p></li>
    <li><p><strong>destructors</strong>, <strong>interpreters</strong>,
    or <strong>elimination forms</strong>, have type
    <code>Program =&gt; A</code>. In our regular expression example we
    have a single interpreter, <code>matches</code>, but we could easily
    add more. For example, we often want to extract elements from the
    input or find a match at any location in the input.</p></li>
    </ol>
    <p>This structure is often called an <strong>algebra</strong> or
    <strong>combinator library</strong> in the functional programming
    world. When we talk about constructors and destructors in an algebra
    we’re talking at a more abstract level then when we talk about
    constructors and destructors on algebraic data types. A constructor
    of an algebra is an abstract concept, at the theory level in my
    taxonomy, that we can choose to concretely implement at the craft
    level with the constructor of an algebraic data type. There are
    other possible implementations. We’ll see one later.</p>
    <h3 data-number="5.2.2" id="implementing-interpreters-with-reification"><span class="header-section-number">5.2.2</span> Implementing Interpreters
    with Reification</h3>
    <p>Now that we understand the components of an interpreter we can
    talk more clearly about the implementation strategy we used. We used
    a strategy called <strong>reification</strong>,
    <strong>defunctionalization</strong>, <strong>deep
    embedding</strong>, or an <strong>initial algebra</strong>.</p>
    <p>Reification, in an abstract sense, means to make concrete what is
    abstract. Concretely, reification in the programming sense means to
    turn methods or functions into data. When using reification in the
    interpreter strategy we reify all the components that produce the
    <code>Program</code> type. This means reifying constructors and
    combinators.</p>
    <p>Here are the rules for reification:</p>
    <ol type="1">
    <li>We define some type, which we’ll call <code>Program</code>, to
    represent programs.</li>
    <li>We implement <code>Program</code> as an algebraic data
    type.</li>
    <li>All constructors and combinators become product types within the
    <code>Program</code> algebraic data type.</li>
    <li>Each product type holds exactly the parameters to the
    constructor or combinator, including the <code>this</code> parameter
    for combinators.</li>
    </ol>
    <p>Once we’ve defined the <code>Program</code> algebraic data type,
    the interpreter becomes a structural recursion on
    <code>Program</code>.</p>
    <h4 class="unnumbered" id="exercise-arithmetic">Exercise:
    Arithmetic</h4>
    <p>Now it’s your turn to practice using reification. Your task is to
    implement an interpreter for arithmetic expressions. An expression
    is:</p>
    <ul>
    <li>a literal number, which takes a <code>Double</code> and produces
    an <code>Expression</code>;</li>
    <li>an addition of two expressions;</li>
    <li>a substraction of two expressions;</li>
    <li>a multiplication of two expressions; or</li>
    <li>a division of two expressions;</li>
    </ul>
    <p>Reify this description as a type <code>Expression</code>.</p>
    <div class="solution">
    <p>The trick here is to recognize how the textual description
    relates to code, and to apply reification correctly.</p>
    <div class="sourceCode" id="cb265"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb265-1"><a href="#cb265-1" aria-hidden="true" tabindex="-1"></a>enum <span class="ex">Expression</span> <span class="op">{</span></span>
<span id="cb265-2"><a href="#cb265-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Literal</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">Double</span><span class="op">)</span></span>
<span id="cb265-3"><a href="#cb265-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Addition</span><span class="op">(</span>left<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> right<span class="op">:</span> <span class="ex">Expression</span><span class="op">)</span></span>
<span id="cb265-4"><a href="#cb265-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Subtraction</span><span class="op">(</span>left<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> right<span class="op">:</span> <span class="ex">Expression</span><span class="op">)</span></span>
<span id="cb265-5"><a href="#cb265-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Multiplication</span><span class="op">(</span>left<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> right<span class="op">:</span> <span class="ex">Expression</span><span class="op">)</span></span>
<span id="cb265-6"><a href="#cb265-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Division</span><span class="op">(</span>left<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> right<span class="op">:</span> <span class="ex">Expression</span><span class="op">)</span></span>
<span id="cb265-7"><a href="#cb265-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb265-8"><a href="#cb265-8" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> <span class="ex">Expression</span> <span class="op">{</span></span>
<span id="cb265-9"><a href="#cb265-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">Double</span><span class="op">):</span> <span class="ex">Expression</span> <span class="op">=</span></span>
<span id="cb265-10"><a href="#cb265-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Literal</span><span class="op">(</span>value<span class="op">)</span></span>
<span id="cb265-11"><a href="#cb265-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    </div>
    <p>Now implement an interpreter <code>eval</code> that produces a
    <code>Double</code>. This interpreter should interpret the
    expression using the usual rules of arithmetic.</p>
    <div class="solution">
    <p>Our interpreter is a structural recursion.</p>
    <div class="sourceCode" id="cb266"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb266-1"><a href="#cb266-1" aria-hidden="true" tabindex="-1"></a>enum <span class="ex">Expression</span> <span class="op">{</span></span>
<span id="cb266-2"><a href="#cb266-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Literal</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">Double</span><span class="op">)</span></span>
<span id="cb266-3"><a href="#cb266-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Addition</span><span class="op">(</span>left<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> right<span class="op">:</span> <span class="ex">Expression</span><span class="op">)</span></span>
<span id="cb266-4"><a href="#cb266-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Subtraction</span><span class="op">(</span>left<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> right<span class="op">:</span> <span class="ex">Expression</span><span class="op">)</span></span>
<span id="cb266-5"><a href="#cb266-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Multiplication</span><span class="op">(</span>left<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> right<span class="op">:</span> <span class="ex">Expression</span><span class="op">)</span></span>
<span id="cb266-6"><a href="#cb266-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Division</span><span class="op">(</span>left<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> right<span class="op">:</span> <span class="ex">Expression</span><span class="op">)</span></span>
<span id="cb266-7"><a href="#cb266-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb266-8"><a href="#cb266-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> eval<span class="op">:</span> <span class="ex">Double</span> <span class="op">=</span></span>
<span id="cb266-9"><a href="#cb266-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb266-10"><a href="#cb266-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Literal</span><span class="op">(</span>value<span class="op">)</span>              <span class="op">=&gt;</span> value</span>
<span id="cb266-11"><a href="#cb266-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Addition</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span>       <span class="op">=&gt;</span> left<span class="op">.</span>eval <span class="op">+</span> right<span class="op">.</span>eval</span>
<span id="cb266-12"><a href="#cb266-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Subtraction</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span>    <span class="op">=&gt;</span> left<span class="op">.</span>eval <span class="op">-</span> right<span class="op">.</span>eval</span>
<span id="cb266-13"><a href="#cb266-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Multiplication</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span> left<span class="op">.</span>eval <span class="op">*</span> right<span class="op">.</span>eval</span>
<span id="cb266-14"><a href="#cb266-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Division</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span>       <span class="op">=&gt;</span> left<span class="op">.</span>eval <span class="op">/</span> right<span class="op">.</span>eval</span>
<span id="cb266-15"><a href="#cb266-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb266-16"><a href="#cb266-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb266-17"><a href="#cb266-17" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> <span class="ex">Expression</span> <span class="op">{</span></span>
<span id="cb266-18"><a href="#cb266-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">Double</span><span class="op">):</span> <span class="ex">Expression</span> <span class="op">=</span></span>
<span id="cb266-19"><a href="#cb266-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Literal</span><span class="op">(</span>value<span class="op">)</span></span>
<span id="cb266-20"><a href="#cb266-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    </div>
    <p>Add methods <code>+</code>, <code>-</code> and so on that make
    your system a bit nicer to use. Then write some expressions and show
    that it works as expected.</p>
    <div class="solution">
    <p>Here’s the complete code.</p>
    <div class="sourceCode" id="cb267"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb267-1"><a href="#cb267-1" aria-hidden="true" tabindex="-1"></a>enum <span class="ex">Expression</span> <span class="op">{</span></span>
<span id="cb267-2"><a href="#cb267-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Literal</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">Double</span><span class="op">)</span></span>
<span id="cb267-3"><a href="#cb267-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Addition</span><span class="op">(</span>left<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> right<span class="op">:</span> <span class="ex">Expression</span><span class="op">)</span></span>
<span id="cb267-4"><a href="#cb267-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Subtraction</span><span class="op">(</span>left<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> right<span class="op">:</span> <span class="ex">Expression</span><span class="op">)</span></span>
<span id="cb267-5"><a href="#cb267-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Multiplication</span><span class="op">(</span>left<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> right<span class="op">:</span> <span class="ex">Expression</span><span class="op">)</span></span>
<span id="cb267-6"><a href="#cb267-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Division</span><span class="op">(</span>left<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> right<span class="op">:</span> <span class="ex">Expression</span><span class="op">)</span></span>
<span id="cb267-7"><a href="#cb267-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-8"><a href="#cb267-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">+(</span>that<span class="op">:</span> <span class="ex">Expression</span><span class="op">):</span> <span class="ex">Expression</span> <span class="op">=</span></span>
<span id="cb267-9"><a href="#cb267-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Addition</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb267-10"><a href="#cb267-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-11"><a href="#cb267-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">-(</span>that<span class="op">:</span> <span class="ex">Expression</span><span class="op">):</span> <span class="ex">Expression</span> <span class="op">=</span></span>
<span id="cb267-12"><a href="#cb267-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Subtraction</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb267-13"><a href="#cb267-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-14"><a href="#cb267-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">*(</span>that<span class="op">:</span> <span class="ex">Expression</span><span class="op">):</span> <span class="ex">Expression</span> <span class="op">=</span></span>
<span id="cb267-15"><a href="#cb267-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Multiplication</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb267-16"><a href="#cb267-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-17"><a href="#cb267-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">/(</span>that<span class="op">:</span> <span class="ex">Expression</span><span class="op">):</span> <span class="ex">Expression</span> <span class="op">=</span></span>
<span id="cb267-18"><a href="#cb267-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Division</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb267-19"><a href="#cb267-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-20"><a href="#cb267-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> eval<span class="op">:</span> <span class="ex">Double</span> <span class="op">=</span></span>
<span id="cb267-21"><a href="#cb267-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb267-22"><a href="#cb267-22" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Literal</span><span class="op">(</span>value<span class="op">)</span>              <span class="op">=&gt;</span> value</span>
<span id="cb267-23"><a href="#cb267-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Addition</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span>       <span class="op">=&gt;</span> left<span class="op">.</span>eval <span class="op">+</span> right<span class="op">.</span>eval</span>
<span id="cb267-24"><a href="#cb267-24" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Subtraction</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span>    <span class="op">=&gt;</span> left<span class="op">.</span>eval <span class="op">-</span> right<span class="op">.</span>eval</span>
<span id="cb267-25"><a href="#cb267-25" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Multiplication</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span> left<span class="op">.</span>eval <span class="op">*</span> right<span class="op">.</span>eval</span>
<span id="cb267-26"><a href="#cb267-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Division</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span>       <span class="op">=&gt;</span> left<span class="op">.</span>eval <span class="op">/</span> right<span class="op">.</span>eval</span>
<span id="cb267-27"><a href="#cb267-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb267-28"><a href="#cb267-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb267-29"><a href="#cb267-29" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> <span class="ex">Expression</span> <span class="op">{</span></span>
<span id="cb267-30"><a href="#cb267-30" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">Double</span><span class="op">):</span> <span class="ex">Expression</span> <span class="op">=</span></span>
<span id="cb267-31"><a href="#cb267-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Literal</span><span class="op">(</span>value<span class="op">)</span></span>
<span id="cb267-32"><a href="#cb267-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Here’s an example showing use, and that the code is correct.</p>
    <div class="sourceCode" id="cb268"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb268-1"><a href="#cb268-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> fortyTwo <span class="op">=</span> <span class="op">((</span><span class="ex">Expression</span><span class="op">(</span><span class="fl">15.0</span><span class="op">)</span> <span class="op">+</span> <span class="ex">Expression</span><span class="op">(</span><span class="fl">5.0</span><span class="op">))</span> <span class="op">*</span> <span class="ex">Expression</span><span class="op">(</span><span class="fl">2.0</span><span class="op">)</span> <span class="op">+</span> <span class="ex">Expression</span><span class="op">(</span><span class="fl">2.0</span><span class="op">))</span> <span class="op">/</span> <span class="ex">Expression</span><span class="op">(</span><span class="fl">1.0</span><span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb269"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb269-1"><a href="#cb269-1" aria-hidden="true" tabindex="-1"></a>fortyTwo<span class="op">.</span>eval</span>
<span id="cb269-2"><a href="#cb269-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: Double = 42.0</span></span></code></pre></div>
    </div>
    <h2 data-number="5.3" id="tail-recursive-interpreters"><span class="header-section-number">5.3</span> Tail Recursive
    Interpreters</h2>
    <p>Structural recursion, as we have written it, uses the stack. This
    is not often a problem, but particularly deep recursions can lead to
    the stack running out of space. A solution is to write a
    <strong>tail recursive</strong> program. A tail recursive program
    does not need to use any stack space, and so is sometimes known as
    <strong>stack safe</strong>. Any program can be turned into a tail
    recursive version, which does not use the stack and therefore cannot
    run out of stack space.</p>
    <section id="the-call-stack" class="unnumbered callout callout-info">
    <h4 class="unnumbered">The Call Stack</h4>
    <p>Method and function calls are usually implemented using an area
    of memory known as the call stack, or just the stack for short.
    Every method or function call uses a small amount of memory on the
    stack, called a stack frame. When the method or function returns,
    this memory is freed and becomes available for future calls to
    use.</p>
    <p>A large number of method calls, without corresponding returns,
    can require more stack frames than the stack can accommodate. When
    there is no more memory available on the stack we say we have
    overflowed the stack. In Scala a <code>StackOverflowError</code> is
    raised when this happens.</p>
    </section>
    <p>In this section we will discuss tail recursion, converting
    programs to tail recursive form, and limitations and workarounds for
    the Scala’s runtimes.</p>
    <h3 data-number="5.3.1" id="the-problem-of-stack-safety"><span class="header-section-number">5.3.1</span> The Problem of Stack
    Safety</h3>
    <p>Let’s start by seeing the problem. In Scala we can create a
    repeated <code>String</code> using the <code>*</code> method.</p>
    <div class="sourceCode" id="cb270"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb270-1"><a href="#cb270-1" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;a&quot;</span> <span class="op">*</span> <span class="dv">4</span></span>
<span id="cb270-2"><a href="#cb270-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res0: String = &quot;aaaa&quot;</span></span></code></pre></div>
    <p>We can match such a <code>String</code> with a regular expression
    and <code>repeat</code>.</p>
    <div class="sourceCode" id="cb271"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb271-1"><a href="#cb271-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Regexp</span><span class="op">(</span><span class="st">&quot;a&quot;</span><span class="op">).</span>repeat<span class="op">.</span><span class="fu">matches</span><span class="op">(</span><span class="st">&quot;a&quot;</span> <span class="op">*</span> <span class="dv">4</span><span class="op">)</span></span>
<span id="cb271-2"><a href="#cb271-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: Boolean = true</span></span></code></pre></div>
    <p>However, if we make the input very long the interpreter will fail
    with a stack overflow exception.</p>
    <div class="sourceCode" id="cb272"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb272-1"><a href="#cb272-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Regexp</span><span class="op">(</span><span class="st">&quot;a&quot;</span><span class="op">).</span>repeat<span class="op">.</span><span class="fu">matches</span><span class="op">(</span><span class="st">&quot;a&quot;</span> <span class="op">*</span> <span class="dv">20000</span><span class="op">)</span></span>
<span id="cb272-2"><a href="#cb272-2" aria-hidden="true" tabindex="-1"></a><span class="co">// java.lang.StackOverflowError</span></span></code></pre></div>
    <p>This is because the interpreter calls <code>loop</code> for each
    instance of a repeat, without returning. However, all is not lost.
    We can rewrite the interpreter in a way that consumes a fixed amount
    of stack space, and therefore match input that is as large as we
    like.</p>
    <h3 data-number="5.3.2" id="tail-calls-and-tail-position"><span class="header-section-number">5.3.2</span> Tail Calls and Tail
    Position</h3>
    <p>Our starting point is <strong>tail calls</strong>. A tail call is
    a method call that does not take any additional stack space. Only
    method calls that are in <strong>tail position</strong> are
    candidates to be turned into tail calls. Even then, runtime
    limitations mean that not all calls in tail position will be
    converted to tail calls.</p>
    <p>A method call in tail position is a call that immediately returns
    the value returned by the call. Let’s see an example. Below are two
    versions of a method to calculate the sum of the integers from 0 to
    <code>count</code>.</p>
    <div class="sourceCode" id="cb273"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb273-1"><a href="#cb273-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">isntTailRecursive</span><span class="op">(</span>count<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="bu">Int</span> <span class="op">=</span></span>
<span id="cb273-2"><a href="#cb273-2" aria-hidden="true" tabindex="-1"></a>  count <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb273-3"><a href="#cb273-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="dv">0</span> <span class="op">=&gt;</span> <span class="dv">0</span></span>
<span id="cb273-4"><a href="#cb273-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> n <span class="op">=&gt;</span> n <span class="op">+</span> <span class="fu">isntTailRecursive</span><span class="op">(</span>n <span class="op">-</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb273-5"><a href="#cb273-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb273-6"><a href="#cb273-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-7"><a href="#cb273-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">isTailRecursive</span><span class="op">(</span>count<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="bu">Int</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb273-8"><a href="#cb273-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">loop</span><span class="op">(</span>count<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> accum<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="bu">Int</span> <span class="op">=</span></span>
<span id="cb273-9"><a href="#cb273-9" aria-hidden="true" tabindex="-1"></a>    count <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb273-10"><a href="#cb273-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="dv">0</span> <span class="op">=&gt;</span> accum</span>
<span id="cb273-11"><a href="#cb273-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> n <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>n <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> accum <span class="op">+</span> n<span class="op">)</span></span>
<span id="cb273-12"><a href="#cb273-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb273-13"><a href="#cb273-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb273-14"><a href="#cb273-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loop</span><span class="op">(</span>count<span class="op">,</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb273-15"><a href="#cb273-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>The method call to <code>isntTailRecursive</code> in</p>
    <div class="sourceCode" id="cb274"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb274-1"><a href="#cb274-1" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> n <span class="op">=&gt;</span> n <span class="op">+</span> <span class="fu">isntTailRecursive</span><span class="op">(</span>n <span class="op">-</span> <span class="dv">1</span><span class="op">)</span></span></code></pre></div>
    <p>is not in tail position, because the value returned by the call
    is then used in the addition. However, the call to <code>loop</code>
    in</p>
    <div class="sourceCode" id="cb275"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb275-1"><a href="#cb275-1" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> n <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>n <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> accum <span class="op">+</span> n<span class="op">)</span></span></code></pre></div>
    <p>is in tail position because the value returned by the call to
    <code>loop</code> is itself immediately returned. Similarly, the
    call to <code>loop</code> in</p>
    <div class="sourceCode" id="cb276"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb276-1"><a href="#cb276-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loop</span><span class="op">(</span>count<span class="op">,</span> <span class="dv">0</span><span class="op">)</span></span></code></pre></div>
    <p>is also in tail position.</p>
    <p>A method call in tail position is a candidate to be turned into a
    tail call. Limitations of Scala’s runtimes mean that not all calls
    in tail position can be made tail calls. Currently, only calls from
    a method to itself that are also in tail position will be converted
    to tail calls. This means</p>
    <div class="sourceCode" id="cb277"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb277-1"><a href="#cb277-1" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> n <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>n <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> accum <span class="op">+</span> n<span class="op">)</span></span></code></pre></div>
    <p>is converted to a tail call, because <code>loop</code> is calling
    itself. However, the call</p>
    <div class="sourceCode" id="cb278"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loop</span><span class="op">(</span>count<span class="op">,</span> <span class="dv">0</span><span class="op">)</span></span></code></pre></div>
    <p>is not converted to a tail call, because the call is from
    <code>isTailRecursive</code> to <code>loop</code>. This will not
    cause issues with stack consumption, however, because this call only
    happens once.</p>
    <section id="runtimes-and-tail-calls" class="unnumbered callout callout-info">
    <h4 class="unnumbered">Runtimes and Tail Calls</h4>
    <p>Scala supports three different platforms: the JVM, Javascript via
    Scala.js, and native code via Scala Native. Each platform provides
    what is known as a runtime, which is code that supports our Scala
    code when it is running. The garbage collector, for example, is part
    of the runtime.</p>
    <p>At the time of writing none of Scala’s runtimes support full tail
    calls. However, there is reason to think this may change in the
    future. <a href="https://wiki.openjdk.org/display/loom/Main">Project
    Loom</a> should eventually add support for tail calls to the JVM.
    Scala Native is likely to support tail calls soon, as part of other
    work to implement continuations. Tail calls have been part of the
    Javascript specification for a long time, but remain unimplemented
    by the majority of Javascript runtimes. However, WebAssembly does
    support tail calls and will probably replace compiling Scala to
    Javascript in the medium term.</p>
    </section>
    <p>We can ask the Scala compiler to check that all self calls are in
    tail position by adding the <code>@tailrec</code> annotation to a
    method. The code will fail to compile if any calls from the method
    to itself are not in tail position.</p>
    <div class="sourceCode" id="cb279"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb279-1"><a href="#cb279-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>annotation<span class="op">.</span>tailrec</span>
<span id="cb279-2"><a href="#cb279-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-3"><a href="#cb279-3" aria-hidden="true" tabindex="-1"></a>@tailrec</span>
<span id="cb279-4"><a href="#cb279-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">isntTailRecursive</span><span class="op">(</span>count<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="bu">Int</span> <span class="op">=</span></span>
<span id="cb279-5"><a href="#cb279-5" aria-hidden="true" tabindex="-1"></a>  count <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb279-6"><a href="#cb279-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="dv">0</span> <span class="op">=&gt;</span> <span class="dv">0</span></span>
<span id="cb279-7"><a href="#cb279-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> n <span class="op">=&gt;</span> n <span class="op">+</span> <span class="fu">isntTailRecursive</span><span class="op">(</span>n <span class="op">-</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb279-8"><a href="#cb279-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb279-9"><a href="#cb279-9" aria-hidden="true" tabindex="-1"></a><span class="co">// error:</span></span>
<span id="cb279-10"><a href="#cb279-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Cannot rewrite recursive call: it is not in tail position</span></span>
<span id="cb279-11"><a href="#cb279-11" aria-hidden="true" tabindex="-1"></a><span class="co">//     case n =&gt; n + isntTailRecursive(n - 1)</span></span>
<span id="cb279-12"><a href="#cb279-12" aria-hidden="true" tabindex="-1"></a><span class="co">//                   ^^^^^^^^^^^^^^^^^^^^^^^^</span></span></code></pre></div>
    <p>We can check the tail recursive version is truly tail recursive
    by passing it a very large input. The non-tail recursive version
    crashes.</p>
    <div class="sourceCode" id="cb280"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb280-1"><a href="#cb280-1" aria-hidden="true" tabindex="-1"></a><span class="fu">isntTailRecursive</span><span class="op">(</span><span class="dv">100000</span><span class="op">)</span></span>
<span id="cb280-2"><a href="#cb280-2" aria-hidden="true" tabindex="-1"></a><span class="co">// java.lang.StackOverflowError</span></span></code></pre></div>
    <p>The tail recursive version runs just fine.</p>
    <div class="sourceCode" id="cb281"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb281-1"><a href="#cb281-1" aria-hidden="true" tabindex="-1"></a><span class="fu">isTailRecursive</span><span class="op">(</span><span class="dv">100000</span><span class="op">)</span></span>
<span id="cb281-2"><a href="#cb281-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: Int = 705082704</span></span></code></pre></div>
    <h3 data-number="5.3.3" id="continuation-passing-style"><span class="header-section-number">5.3.3</span> Continuation-Passing
    Style</h3>
    <p>Now that we know about tail calls, how do we convert the regular
    expression interpreter to use them? Any program can be converted to
    an equivalent program with all calls in tail position. This
    conversion is known as <strong>continuation-passing style</strong>
    or CPS for short. Our first step to understanding CPS is to
    understand <strong>continuations</strong>.</p>
    <p>A continuation is an encapsulation of “what happens next”. Let’s
    return to our <code>Regexp</code> example. Here’s the full code for
    reference.</p>
    <div class="sourceCode" id="cb282"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb282-1"><a href="#cb282-1" aria-hidden="true" tabindex="-1"></a>enum Regexp <span class="op">{</span></span>
<span id="cb282-2"><a href="#cb282-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">++(</span>that<span class="op">:</span> Regexp<span class="op">):</span> Regexp <span class="op">=</span></span>
<span id="cb282-3"><a href="#cb282-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Append</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb282-4"><a href="#cb282-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb282-5"><a href="#cb282-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">orElse</span><span class="op">(</span>that<span class="op">:</span> Regexp<span class="op">):</span> Regexp <span class="op">=</span></span>
<span id="cb282-6"><a href="#cb282-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">OrElse</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb282-7"><a href="#cb282-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb282-8"><a href="#cb282-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> repeat<span class="op">:</span> Regexp <span class="op">=</span></span>
<span id="cb282-9"><a href="#cb282-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Repeat</span><span class="op">(</span><span class="kw">this</span><span class="op">)</span></span>
<span id="cb282-10"><a href="#cb282-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb282-11"><a href="#cb282-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> `<span class="op">*</span>` <span class="op">:</span> Regexp <span class="op">=</span> <span class="kw">this</span><span class="op">.</span>repeat</span>
<span id="cb282-12"><a href="#cb282-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb282-13"><a href="#cb282-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">matches</span><span class="op">(</span>input<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Boolean</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb282-14"><a href="#cb282-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">loop</span><span class="op">(</span>regexp<span class="op">:</span> Regexp<span class="op">,</span> idx<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb282-15"><a href="#cb282-15" aria-hidden="true" tabindex="-1"></a>      regexp <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb282-16"><a href="#cb282-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">Append</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb282-17"><a href="#cb282-17" aria-hidden="true" tabindex="-1"></a>          <span class="fu">loop</span><span class="op">(</span>left<span class="op">,</span> idx<span class="op">).</span><span class="fu">flatMap</span><span class="op">(</span>i <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>right<span class="op">,</span> i<span class="op">))</span></span>
<span id="cb282-18"><a href="#cb282-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">OrElse</span><span class="op">(</span>first<span class="op">,</span> second<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb282-19"><a href="#cb282-19" aria-hidden="true" tabindex="-1"></a>          <span class="fu">loop</span><span class="op">(</span>first<span class="op">,</span> idx<span class="op">).</span><span class="fu">orElse</span><span class="op">(</span><span class="fu">loop</span><span class="op">(</span>second<span class="op">,</span> idx<span class="op">))</span></span>
<span id="cb282-20"><a href="#cb282-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">Repeat</span><span class="op">(</span>source<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb282-21"><a href="#cb282-21" aria-hidden="true" tabindex="-1"></a>          <span class="fu">loop</span><span class="op">(</span>source<span class="op">,</span> idx<span class="op">)</span></span>
<span id="cb282-22"><a href="#cb282-22" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">flatMap</span><span class="op">(</span>i <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>regexp<span class="op">,</span> i<span class="op">))</span></span>
<span id="cb282-23"><a href="#cb282-23" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">orElse</span><span class="op">(</span><span class="bu">Some</span><span class="op">(</span>idx<span class="op">))</span></span>
<span id="cb282-24"><a href="#cb282-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">Apply</span><span class="op">(</span>string<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb282-25"><a href="#cb282-25" aria-hidden="true" tabindex="-1"></a>          <span class="ex">Option</span><span class="op">.</span><span class="fu">when</span><span class="op">(</span>input<span class="op">.</span><span class="fu">startsWith</span><span class="op">(</span>string<span class="op">,</span> idx<span class="op">))(</span>idx <span class="op">+</span> string<span class="op">.</span>size<span class="op">)</span></span>
<span id="cb282-26"><a href="#cb282-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> Empty <span class="op">=&gt;</span></span>
<span id="cb282-27"><a href="#cb282-27" aria-hidden="true" tabindex="-1"></a>          <span class="bu">None</span></span>
<span id="cb282-28"><a href="#cb282-28" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb282-29"><a href="#cb282-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb282-30"><a href="#cb282-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check we matched the entire input</span></span>
<span id="cb282-31"><a href="#cb282-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">loop</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> <span class="dv">0</span><span class="op">).</span><span class="fu">map</span><span class="op">(</span>idx <span class="op">=&gt;</span> idx <span class="op">==</span> input<span class="op">.</span>size<span class="op">).</span><span class="fu">getOrElse</span><span class="op">(</span><span class="kw">false</span><span class="op">)</span></span>
<span id="cb282-32"><a href="#cb282-32" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb282-33"><a href="#cb282-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb282-34"><a href="#cb282-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Append</span><span class="op">(</span>left<span class="op">:</span> Regexp<span class="op">,</span> right<span class="op">:</span> Regexp<span class="op">)</span></span>
<span id="cb282-35"><a href="#cb282-35" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">OrElse</span><span class="op">(</span>first<span class="op">:</span> Regexp<span class="op">,</span> second<span class="op">:</span> Regexp<span class="op">)</span></span>
<span id="cb282-36"><a href="#cb282-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Repeat</span><span class="op">(</span>source<span class="op">:</span> Regexp<span class="op">)</span></span>
<span id="cb282-37"><a href="#cb282-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Apply</span><span class="op">(</span>string<span class="op">:</span> <span class="ex">String</span><span class="op">)</span></span>
<span id="cb282-38"><a href="#cb282-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> Empty</span>
<span id="cb282-39"><a href="#cb282-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb282-40"><a href="#cb282-40" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Regexp <span class="op">{</span></span>
<span id="cb282-41"><a href="#cb282-41" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> empty<span class="op">:</span> Regexp <span class="op">=</span> Empty</span>
<span id="cb282-42"><a href="#cb282-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb282-43"><a href="#cb282-43" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>string<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> Regexp <span class="op">=</span></span>
<span id="cb282-44"><a href="#cb282-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Apply</span><span class="op">(</span>string<span class="op">)</span></span>
<span id="cb282-45"><a href="#cb282-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Let’s consider the case for <code>Append</code> in
    <code>matches</code>.</p>
    <div class="sourceCode" id="cb283"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb283-1"><a href="#cb283-1" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="fu">Append</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb283-2"><a href="#cb283-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loop</span><span class="op">(</span>left<span class="op">,</span> idx<span class="op">).</span><span class="fu">flatMap</span><span class="op">(</span>i <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>right<span class="op">,</span> i<span class="op">))</span></span></code></pre></div>
    <p>What happens next when we call <code>loop(left, idx)</code>?
    Let’s give the name <code>result</code> to the value returned by the
    call to <code>loop</code>. The answer is we run
    <code>result.flatMap(i =&gt; loop(right, i))</code>. We can
    represent this as a function, to which we pass
    <code>result</code>:</p>
    <div class="sourceCode" id="cb284"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb284-1"><a href="#cb284-1" aria-hidden="true" tabindex="-1"></a><span class="op">(</span>result<span class="op">:</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">])</span> <span class="op">=&gt;</span> result<span class="op">.</span><span class="fu">flatMap</span><span class="op">(</span>i <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>right<span class="op">,</span> i<span class="op">))</span></span></code></pre></div>
    <p>This is exactly the continuation, reified as a value.</p>
    <p>As is often the case, there is a distinction between the concept
    and the representation. The concept of continuations always exists
    in code. A continuation means “what happens next”. In other words,
    it is the program’s control flow. There is always some concept of
    control flow, even if it is just “the program halts”. We can
    represent continuations as functions in code. This transforms the
    abstract concept of continuations into concrete values in our
    program, and hence reifies them.</p>
    <p>Now that we know about continuations, and their reification as
    functions, we can move on to continuation-passing style. In CPS we,
    as the name suggests, pass around continuations. Specifically, each
    function or method takes an extra parameter that is a continuation.
    Instead of returning a value it calls that continuation with the
    value. This is another example of duality, in this case between
    returning a value and calling a continuation.</p>
    <p>Let’s see how this works. We’ll start with a simple example
    written in the normal style, also known as <strong>direct
    style</strong>.</p>
    <div class="sourceCode" id="cb285"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb285-1"><a href="#cb285-1" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="dv">1</span> <span class="op">+</span> <span class="dv">2</span><span class="op">)</span> <span class="op">*</span> <span class="dv">3</span></span>
<span id="cb285-2"><a href="#cb285-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: Int = 9</span></span></code></pre></div>
    <p>To rewrite this in CPS style we need to create replacements for
    <code>+</code> and <code>*</code> with the extra continuation
    parameter.</p>
    <div class="sourceCode" id="cb286"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb286-1"><a href="#cb286-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Continuation <span class="op">=</span> <span class="bu">Int</span> <span class="op">=&gt;</span> <span class="bu">Int</span></span>
<span id="cb286-2"><a href="#cb286-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb286-3"><a href="#cb286-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">add</span><span class="op">(</span>x<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> y<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> k<span class="op">:</span> Continuation<span class="op">)</span> <span class="op">=</span> <span class="fu">k</span><span class="op">(</span>x <span class="op">+</span> y<span class="op">)</span></span>
<span id="cb286-4"><a href="#cb286-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">mul</span><span class="op">(</span>x<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> y<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> k<span class="op">:</span> Continuation<span class="op">)</span> <span class="op">=</span> <span class="fu">k</span><span class="op">(</span>x <span class="op">*</span> y<span class="op">)</span></span></code></pre></div>
    <p>Now we can rewrite our example in CPS. <code>(1 + 2)</code>
    becomes <code>add(1, 2, k)</code>, but what is <code>k</code>, the
    continuation? What we do next is multiply the result by
    <code>3</code>. Thus the continuation is
    <code>a =&gt; mul(a, 3, k2)</code>. What is the next continuation,
    <code>k2</code>? Here the program finishes, so we just return the
    value with the identity continuation <code>b =&gt; b</code>. Put it
    all together and we get</p>
    <div class="sourceCode" id="cb287"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb287-1"><a href="#cb287-1" aria-hidden="true" tabindex="-1"></a><span class="fu">add</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> a <span class="op">=&gt;</span> <span class="fu">mul</span><span class="op">(</span>a<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> b <span class="op">=&gt;</span> b<span class="op">))</span></span>
<span id="cb287-2"><a href="#cb287-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res6: Int = 9</span></span></code></pre></div>
    <p>Notice that every continuation call is in tail position in the
    CPS code. This means that code written in CPS can potentially
    consume no stack space.</p>
    <p>Now we can return to the interpreter loop for
    <code>Regexp</code>. We are going to CPS it, so we need to add an
    extra parameter for the continuation. In this case the contination
    accepts and returns the result type of <code>loop</code>:
    <code>Option[Int]</code>.</p>
    <div class="sourceCode" id="cb288"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb288-1"><a href="#cb288-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">matches</span><span class="op">(</span>input<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Boolean</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb288-2"><a href="#cb288-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Define a type alias so we can easily write continuations</span></span>
<span id="cb288-3"><a href="#cb288-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">type</span> Continuation <span class="op">=</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=&gt;</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span></span>
<span id="cb288-4"><a href="#cb288-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-5"><a href="#cb288-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">loop</span><span class="op">(</span>regexp<span class="op">:</span> Regexp<span class="op">,</span> idx<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> cont<span class="op">:</span> Continuation<span class="op">):</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb288-6"><a href="#cb288-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// etc...</span></span>
<span id="cb288-7"><a href="#cb288-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Now we go through each case and convert it to CPS. Each
    continuation we construct must call <code>cont</code> as its final
    step. This is tedious and a bit error-prone, so good tests are
    helpful.</p>
    <div class="sourceCode" id="cb289"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb289-1"><a href="#cb289-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">matches</span><span class="op">(</span>input<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Boolean</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb289-2"><a href="#cb289-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Define a type alias so we can easily write continuations</span></span>
<span id="cb289-3"><a href="#cb289-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">type</span> Continuation <span class="op">=</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=&gt;</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span></span>
<span id="cb289-4"><a href="#cb289-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb289-5"><a href="#cb289-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">loop</span><span class="op">(</span></span>
<span id="cb289-6"><a href="#cb289-6" aria-hidden="true" tabindex="-1"></a>      regexp<span class="op">:</span> Regexp<span class="op">,</span></span>
<span id="cb289-7"><a href="#cb289-7" aria-hidden="true" tabindex="-1"></a>      idx<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span></span>
<span id="cb289-8"><a href="#cb289-8" aria-hidden="true" tabindex="-1"></a>      cont<span class="op">:</span> Continuation</span>
<span id="cb289-9"><a href="#cb289-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">):</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb289-10"><a href="#cb289-10" aria-hidden="true" tabindex="-1"></a>    regexp <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb289-11"><a href="#cb289-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Append</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb289-12"><a href="#cb289-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">val</span> k<span class="op">:</span> Continuation <span class="op">=</span> _ <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb289-13"><a href="#cb289-13" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> <span class="bu">None</span>    <span class="op">=&gt;</span> <span class="fu">cont</span><span class="op">(</span><span class="bu">None</span><span class="op">)</span></span>
<span id="cb289-14"><a href="#cb289-14" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> <span class="bu">Some</span><span class="op">(</span>i<span class="op">)</span> <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>right<span class="op">,</span> i<span class="op">,</span> cont<span class="op">)</span></span>
<span id="cb289-15"><a href="#cb289-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb289-16"><a href="#cb289-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">loop</span><span class="op">(</span>left<span class="op">,</span> idx<span class="op">,</span> k<span class="op">)</span></span>
<span id="cb289-17"><a href="#cb289-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb289-18"><a href="#cb289-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">OrElse</span><span class="op">(</span>first<span class="op">,</span> second<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb289-19"><a href="#cb289-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">val</span> k<span class="op">:</span> Continuation <span class="op">=</span> _ <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb289-20"><a href="#cb289-20" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> <span class="bu">None</span> <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>second<span class="op">,</span> idx<span class="op">,</span> cont<span class="op">)</span></span>
<span id="cb289-21"><a href="#cb289-21" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> some <span class="op">=&gt;</span> <span class="fu">cont</span><span class="op">(</span>some<span class="op">)</span></span>
<span id="cb289-22"><a href="#cb289-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb289-23"><a href="#cb289-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">loop</span><span class="op">(</span>first<span class="op">,</span> idx<span class="op">,</span> k<span class="op">)</span></span>
<span id="cb289-24"><a href="#cb289-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb289-25"><a href="#cb289-25" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Repeat</span><span class="op">(</span>source<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb289-26"><a href="#cb289-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">val</span> k<span class="op">:</span> Continuation <span class="op">=</span></span>
<span id="cb289-27"><a href="#cb289-27" aria-hidden="true" tabindex="-1"></a>          _ <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb289-28"><a href="#cb289-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="bu">None</span>    <span class="op">=&gt;</span> <span class="fu">cont</span><span class="op">(</span><span class="bu">Some</span><span class="op">(</span>idx<span class="op">))</span></span>
<span id="cb289-29"><a href="#cb289-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="bu">Some</span><span class="op">(</span>i<span class="op">)</span> <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>regexp<span class="op">,</span> i<span class="op">,</span> cont<span class="op">)</span></span>
<span id="cb289-30"><a href="#cb289-30" aria-hidden="true" tabindex="-1"></a>          <span class="op">}</span></span>
<span id="cb289-31"><a href="#cb289-31" aria-hidden="true" tabindex="-1"></a>        <span class="fu">loop</span><span class="op">(</span>source<span class="op">,</span> idx<span class="op">,</span> k<span class="op">)</span></span>
<span id="cb289-32"><a href="#cb289-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb289-33"><a href="#cb289-33" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Apply</span><span class="op">(</span>string<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb289-34"><a href="#cb289-34" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cont</span><span class="op">(</span><span class="ex">Option</span><span class="op">.</span><span class="fu">when</span><span class="op">(</span>input<span class="op">.</span><span class="fu">startsWith</span><span class="op">(</span>string<span class="op">,</span> idx<span class="op">))(</span>idx <span class="op">+</span> string<span class="op">.</span>size<span class="op">))</span></span>
<span id="cb289-35"><a href="#cb289-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb289-36"><a href="#cb289-36" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> Empty <span class="op">=&gt;</span></span>
<span id="cb289-37"><a href="#cb289-37" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cont</span><span class="op">(</span><span class="bu">None</span><span class="op">)</span></span>
<span id="cb289-38"><a href="#cb289-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb289-39"><a href="#cb289-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb289-40"><a href="#cb289-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check we matched the entire input</span></span>
<span id="cb289-41"><a href="#cb289-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loop</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> identity<span class="op">).</span><span class="fu">map</span><span class="op">(</span>idx <span class="op">=&gt;</span> idx <span class="op">==</span> input<span class="op">.</span>size<span class="op">).</span><span class="fu">getOrElse</span><span class="op">(</span><span class="kw">false</span><span class="op">)</span></span>
<span id="cb289-42"><a href="#cb289-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Every call in this interpreter loop is in tail position. However
    Scala cannot convert these to tail calls because the calls go from
    <code>loop</code> to a continuation and vice versa. To make the
    interpreter fully stack safe we need to add
    <strong>trampolining</strong>.</p>
    <h4 class="unnumbered" id="exercise-cps-arithmetic">Exercise: CPS
    Arithmetic</h4>
    <p>In a previous exercise we wrote an interpreter for arithmetic
    expressions. Your task now is to CPS this interpreter. For
    reference, the definition of an arithmetic expression is:</p>
    <ul>
    <li>a literal number, which takes a <code>Double</code> and produces
    an <code>Expression</code>;</li>
    <li>an addition of two expressions;</li>
    <li>a substraction of two expressions;</li>
    <li>a multiplication of two expressions; or</li>
    <li>a division of two expressions;</li>
    </ul>
    <div class="solution">
    <p>The continuations have a slightly different structure to the
    regular expression example. In the regular expression example, all
    the information needs by a continuation is either found in the
    parameter to the continuation (the index) or values extracted via
    pattern matching. In the arithmetic code we need values from
    previous continuations that are not passed as parameters. This is to
    compute binary operations like additions. The solution is to capture
    these values within the environment of the closure that represents
    the continuation.</p>
    <div class="sourceCode" id="cb290"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb290-1"><a href="#cb290-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Continuation <span class="op">=</span> <span class="ex">Double</span> <span class="op">=&gt;</span> <span class="ex">Double</span></span>
<span id="cb290-2"><a href="#cb290-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-3"><a href="#cb290-3" aria-hidden="true" tabindex="-1"></a>enum <span class="ex">Expression</span> <span class="op">{</span></span>
<span id="cb290-4"><a href="#cb290-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Literal</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">Double</span><span class="op">)</span></span>
<span id="cb290-5"><a href="#cb290-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Addition</span><span class="op">(</span>left<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> right<span class="op">:</span> <span class="ex">Expression</span><span class="op">)</span></span>
<span id="cb290-6"><a href="#cb290-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Subtraction</span><span class="op">(</span>left<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> right<span class="op">:</span> <span class="ex">Expression</span><span class="op">)</span></span>
<span id="cb290-7"><a href="#cb290-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Multiplication</span><span class="op">(</span>left<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> right<span class="op">:</span> <span class="ex">Expression</span><span class="op">)</span></span>
<span id="cb290-8"><a href="#cb290-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Division</span><span class="op">(</span>left<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> right<span class="op">:</span> <span class="ex">Expression</span><span class="op">)</span></span>
<span id="cb290-9"><a href="#cb290-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-10"><a href="#cb290-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> eval<span class="op">:</span> <span class="ex">Double</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb290-11"><a href="#cb290-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">loop</span><span class="op">(</span>expr<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> cont<span class="op">:</span> Continuation<span class="op">):</span> <span class="ex">Double</span> <span class="op">=</span></span>
<span id="cb290-12"><a href="#cb290-12" aria-hidden="true" tabindex="-1"></a>      expr <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb290-13"><a href="#cb290-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">Literal</span><span class="op">(</span>value<span class="op">)</span> <span class="op">=&gt;</span> <span class="fu">cont</span><span class="op">(</span>value<span class="op">)</span></span>
<span id="cb290-14"><a href="#cb290-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">Addition</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb290-15"><a href="#cb290-15" aria-hidden="true" tabindex="-1"></a>          <span class="fu">loop</span><span class="op">(</span>left<span class="op">,</span> l <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>right<span class="op">,</span> r <span class="op">=&gt;</span> <span class="fu">cont</span><span class="op">(</span>l <span class="op">+</span> r<span class="op">)))</span></span>
<span id="cb290-16"><a href="#cb290-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">Subtraction</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb290-17"><a href="#cb290-17" aria-hidden="true" tabindex="-1"></a>          <span class="fu">loop</span><span class="op">(</span>left<span class="op">,</span> l <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>right<span class="op">,</span> r <span class="op">=&gt;</span> <span class="fu">cont</span><span class="op">(</span>l <span class="op">-</span> r<span class="op">)))</span></span>
<span id="cb290-18"><a href="#cb290-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">Multiplication</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb290-19"><a href="#cb290-19" aria-hidden="true" tabindex="-1"></a>          <span class="fu">loop</span><span class="op">(</span>left<span class="op">,</span> l <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>right<span class="op">,</span> r <span class="op">=&gt;</span> <span class="fu">cont</span><span class="op">(</span>l <span class="op">*</span> r<span class="op">)))</span></span>
<span id="cb290-20"><a href="#cb290-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">Division</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb290-21"><a href="#cb290-21" aria-hidden="true" tabindex="-1"></a>          <span class="fu">loop</span><span class="op">(</span>left<span class="op">,</span> l <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>right<span class="op">,</span> r <span class="op">=&gt;</span> <span class="fu">cont</span><span class="op">(</span>l <span class="op">/</span> r<span class="op">)))</span></span>
<span id="cb290-22"><a href="#cb290-22" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb290-23"><a href="#cb290-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-24"><a href="#cb290-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">loop</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> identity<span class="op">)</span></span>
<span id="cb290-25"><a href="#cb290-25" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb290-26"><a href="#cb290-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb290-27"><a href="#cb290-27" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">+(</span>that<span class="op">:</span> <span class="ex">Expression</span><span class="op">):</span> <span class="ex">Expression</span> <span class="op">=</span></span>
<span id="cb290-28"><a href="#cb290-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Addition</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb290-29"><a href="#cb290-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-30"><a href="#cb290-30" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">-(</span>that<span class="op">:</span> <span class="ex">Expression</span><span class="op">):</span> <span class="ex">Expression</span> <span class="op">=</span></span>
<span id="cb290-31"><a href="#cb290-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Subtraction</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb290-32"><a href="#cb290-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-33"><a href="#cb290-33" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">*(</span>that<span class="op">:</span> <span class="ex">Expression</span><span class="op">):</span> <span class="ex">Expression</span> <span class="op">=</span></span>
<span id="cb290-34"><a href="#cb290-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Multiplication</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb290-35"><a href="#cb290-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-36"><a href="#cb290-36" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">/(</span>that<span class="op">:</span> <span class="ex">Expression</span><span class="op">):</span> <span class="ex">Expression</span> <span class="op">=</span></span>
<span id="cb290-37"><a href="#cb290-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Division</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb290-38"><a href="#cb290-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb290-39"><a href="#cb290-39" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> <span class="ex">Expression</span> <span class="op">{</span></span>
<span id="cb290-40"><a href="#cb290-40" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">Double</span><span class="op">):</span> <span class="ex">Expression</span> <span class="op">=</span></span>
<span id="cb290-41"><a href="#cb290-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Literal</span><span class="op">(</span>value<span class="op">)</span></span>
<span id="cb290-42"><a href="#cb290-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    </div>
    <h3 data-number="5.3.4" id="trampolining"><span class="header-section-number">5.3.4</span> Trampolining</h3>
    <p>Earlier we said that CPS utilizes the duality between function
    calls and returns: instead of returning a value we call a function
    with a value. This allows us to transform our code so it only has
    calls in tail positions. However, we still have a problem with stack
    safety. Scala’s runtimes don’t support full tail calls, so calls
    from a continuation to <code>loop</code> or from <code>loop</code>
    to a continuation will use a stack frame. We can use this same
    duality to avoid using the stack by, instead of making a call,
    returning a value that reifies the call we want to make. This idea
    is the core of trampolining. Let’s see it in action, which will help
    clear up what exactly this all means.</p>
    <p>Our first step is to reify all the method calls made by the
    interpreter loop and the continuations. There are three cases: calls
    to <code>loop</code>, calls to a continuation, and, to avoid an
    infinite loop, the case when we’re done.</p>
    <div class="sourceCode" id="cb291"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb291-1"><a href="#cb291-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Continuation <span class="op">=</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=&gt;</span> Call</span>
<span id="cb291-2"><a href="#cb291-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-3"><a href="#cb291-3" aria-hidden="true" tabindex="-1"></a>enum Call <span class="op">{</span></span>
<span id="cb291-4"><a href="#cb291-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Loop</span><span class="op">(</span>regexp<span class="op">:</span> Regexp<span class="op">,</span> index<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> continuation<span class="op">:</span> Continuation<span class="op">)</span></span>
<span id="cb291-5"><a href="#cb291-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Continue</span><span class="op">(</span>index<span class="op">:</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">],</span> continuation<span class="op">:</span> Continuation<span class="op">)</span></span>
<span id="cb291-6"><a href="#cb291-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Done</span><span class="op">(</span>index<span class="op">:</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">])</span></span>
<span id="cb291-7"><a href="#cb291-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Now we update <code>loop</code> to return instances of
    <code>Call</code> instead of making the calls directly.</p>
    <div class="sourceCode" id="cb292"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb292-1"><a href="#cb292-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">loop</span><span class="op">(</span>regexp<span class="op">:</span> Regexp<span class="op">,</span> idx<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> cont<span class="op">:</span> Continuation<span class="op">):</span> Call <span class="op">=</span></span>
<span id="cb292-2"><a href="#cb292-2" aria-hidden="true" tabindex="-1"></a>  regexp <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb292-3"><a href="#cb292-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Append</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb292-4"><a href="#cb292-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">val</span> k<span class="op">:</span> Continuation <span class="op">=</span> _ <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb292-5"><a href="#cb292-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="bu">None</span>    <span class="op">=&gt;</span> Call<span class="op">.</span><span class="fu">Continue</span><span class="op">(</span><span class="bu">None</span><span class="op">,</span> cont<span class="op">)</span></span>
<span id="cb292-6"><a href="#cb292-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="bu">Some</span><span class="op">(</span>i<span class="op">)</span> <span class="op">=&gt;</span> Call<span class="op">.</span><span class="fu">Loop</span><span class="op">(</span>right<span class="op">,</span> i<span class="op">,</span> cont<span class="op">)</span></span>
<span id="cb292-7"><a href="#cb292-7" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb292-8"><a href="#cb292-8" aria-hidden="true" tabindex="-1"></a>      Call<span class="op">.</span><span class="fu">Loop</span><span class="op">(</span>left<span class="op">,</span> idx<span class="op">,</span> k<span class="op">)</span></span>
<span id="cb292-9"><a href="#cb292-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb292-10"><a href="#cb292-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">OrElse</span><span class="op">(</span>first<span class="op">,</span> second<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb292-11"><a href="#cb292-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">val</span> k<span class="op">:</span> Continuation <span class="op">=</span> _ <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb292-12"><a href="#cb292-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="bu">None</span> <span class="op">=&gt;</span> Call<span class="op">.</span><span class="fu">Loop</span><span class="op">(</span>second<span class="op">,</span> idx<span class="op">,</span> cont<span class="op">)</span></span>
<span id="cb292-13"><a href="#cb292-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> some <span class="op">=&gt;</span> Call<span class="op">.</span><span class="fu">Continue</span><span class="op">(</span>some<span class="op">,</span> cont<span class="op">)</span></span>
<span id="cb292-14"><a href="#cb292-14" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb292-15"><a href="#cb292-15" aria-hidden="true" tabindex="-1"></a>      Call<span class="op">.</span><span class="fu">Loop</span><span class="op">(</span>first<span class="op">,</span> idx<span class="op">,</span> k<span class="op">)</span></span>
<span id="cb292-16"><a href="#cb292-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb292-17"><a href="#cb292-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Repeat</span><span class="op">(</span>source<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb292-18"><a href="#cb292-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">val</span> k<span class="op">:</span> Continuation <span class="op">=</span></span>
<span id="cb292-19"><a href="#cb292-19" aria-hidden="true" tabindex="-1"></a>        _ <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb292-20"><a href="#cb292-20" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> <span class="bu">None</span>    <span class="op">=&gt;</span> Call<span class="op">.</span><span class="fu">Continue</span><span class="op">(</span><span class="bu">Some</span><span class="op">(</span>idx<span class="op">),</span> cont<span class="op">)</span></span>
<span id="cb292-21"><a href="#cb292-21" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> <span class="bu">Some</span><span class="op">(</span>i<span class="op">)</span> <span class="op">=&gt;</span> Call<span class="op">.</span><span class="fu">Loop</span><span class="op">(</span>regexp<span class="op">,</span> i<span class="op">,</span> cont<span class="op">)</span></span>
<span id="cb292-22"><a href="#cb292-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb292-23"><a href="#cb292-23" aria-hidden="true" tabindex="-1"></a>      Call<span class="op">.</span><span class="fu">Loop</span><span class="op">(</span>source<span class="op">,</span> idx<span class="op">,</span> k<span class="op">)</span></span>
<span id="cb292-24"><a href="#cb292-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb292-25"><a href="#cb292-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Apply</span><span class="op">(</span>string<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb292-26"><a href="#cb292-26" aria-hidden="true" tabindex="-1"></a>      Call<span class="op">.</span><span class="fu">Continue</span><span class="op">(</span></span>
<span id="cb292-27"><a href="#cb292-27" aria-hidden="true" tabindex="-1"></a>        <span class="ex">Option</span><span class="op">.</span><span class="fu">when</span><span class="op">(</span>input<span class="op">.</span><span class="fu">startsWith</span><span class="op">(</span>string<span class="op">,</span> idx<span class="op">))(</span>idx <span class="op">+</span> string<span class="op">.</span>size<span class="op">),</span></span>
<span id="cb292-28"><a href="#cb292-28" aria-hidden="true" tabindex="-1"></a>        cont</span>
<span id="cb292-29"><a href="#cb292-29" aria-hidden="true" tabindex="-1"></a>      <span class="op">)</span></span>
<span id="cb292-30"><a href="#cb292-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb292-31"><a href="#cb292-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> Empty <span class="op">=&gt;</span></span>
<span id="cb292-32"><a href="#cb292-32" aria-hidden="true" tabindex="-1"></a>      Call<span class="op">.</span><span class="fu">Continue</span><span class="op">(</span><span class="bu">None</span><span class="op">,</span> cont<span class="op">)</span></span>
<span id="cb292-33"><a href="#cb292-33" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>This gives us an interpreter loop that returns values instead of
    making calls, and so does not consume stack space. However, we need
    to actually make these calls at some point, and doing this is the
    job of the trampoline. The trampoline is simply a tail recursive
    loop that makes calls until it reaches <code>Done</code>.</p>
    <div class="sourceCode" id="cb293"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb293-1"><a href="#cb293-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">trampoline</span><span class="op">(</span>next<span class="op">:</span> Call<span class="op">):</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb293-2"><a href="#cb293-2" aria-hidden="true" tabindex="-1"></a>  next <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb293-3"><a href="#cb293-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> Call<span class="op">.</span><span class="fu">Loop</span><span class="op">(</span>regexp<span class="op">,</span> index<span class="op">,</span> continuation<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb293-4"><a href="#cb293-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">trampoline</span><span class="op">(</span><span class="fu">loop</span><span class="op">(</span>regexp<span class="op">,</span> index<span class="op">,</span> continuation<span class="op">))</span></span>
<span id="cb293-5"><a href="#cb293-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> Call<span class="op">.</span><span class="fu">Continue</span><span class="op">(</span>index<span class="op">,</span> continuation<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb293-6"><a href="#cb293-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">trampoline</span><span class="op">(</span><span class="fu">continuation</span><span class="op">(</span>index<span class="op">))</span></span>
<span id="cb293-7"><a href="#cb293-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> Call<span class="op">.</span><span class="fu">Done</span><span class="op">(</span>index<span class="op">)</span> <span class="op">=&gt;</span> index</span>
<span id="cb293-8"><a href="#cb293-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>Now every call has a corresponding return, so the stack usage is
    limited. Our interpreter can handle input of any size, up to the
    limits of available memory.</p>
    <p>Here’s the complete code for reference.</p>
    <div class="sourceCode" id="cb294"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb294-1"><a href="#cb294-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Define a type alias so we can easily write continuations</span></span>
<span id="cb294-2"><a href="#cb294-2" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Continuation <span class="op">=</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=&gt;</span> Call</span>
<span id="cb294-3"><a href="#cb294-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-4"><a href="#cb294-4" aria-hidden="true" tabindex="-1"></a>enum Call <span class="op">{</span></span>
<span id="cb294-5"><a href="#cb294-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Loop</span><span class="op">(</span>regexp<span class="op">:</span> Regexp<span class="op">,</span> index<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> continuation<span class="op">:</span> Continuation<span class="op">)</span></span>
<span id="cb294-6"><a href="#cb294-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Continue</span><span class="op">(</span>index<span class="op">:</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">],</span> continuation<span class="op">:</span> Continuation<span class="op">)</span></span>
<span id="cb294-7"><a href="#cb294-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Done</span><span class="op">(</span>index<span class="op">:</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">])</span></span>
<span id="cb294-8"><a href="#cb294-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb294-9"><a href="#cb294-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-10"><a href="#cb294-10" aria-hidden="true" tabindex="-1"></a>enum Regexp <span class="op">{</span></span>
<span id="cb294-11"><a href="#cb294-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">++(</span>that<span class="op">:</span> Regexp<span class="op">):</span> Regexp <span class="op">=</span></span>
<span id="cb294-12"><a href="#cb294-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Append</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb294-13"><a href="#cb294-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-14"><a href="#cb294-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">orElse</span><span class="op">(</span>that<span class="op">:</span> Regexp<span class="op">):</span> Regexp <span class="op">=</span></span>
<span id="cb294-15"><a href="#cb294-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">OrElse</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb294-16"><a href="#cb294-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-17"><a href="#cb294-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> repeat<span class="op">:</span> Regexp <span class="op">=</span></span>
<span id="cb294-18"><a href="#cb294-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Repeat</span><span class="op">(</span><span class="kw">this</span><span class="op">)</span></span>
<span id="cb294-19"><a href="#cb294-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-20"><a href="#cb294-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> `<span class="op">*</span>` <span class="op">:</span> Regexp <span class="op">=</span> <span class="kw">this</span><span class="op">.</span>repeat</span>
<span id="cb294-21"><a href="#cb294-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-22"><a href="#cb294-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">matches</span><span class="op">(</span>input<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Boolean</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb294-23"><a href="#cb294-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">loop</span><span class="op">(</span>regexp<span class="op">:</span> Regexp<span class="op">,</span> idx<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> cont<span class="op">:</span> Continuation<span class="op">):</span> Call <span class="op">=</span></span>
<span id="cb294-24"><a href="#cb294-24" aria-hidden="true" tabindex="-1"></a>      regexp <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb294-25"><a href="#cb294-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">Append</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb294-26"><a href="#cb294-26" aria-hidden="true" tabindex="-1"></a>          <span class="kw">val</span> k<span class="op">:</span> Continuation <span class="op">=</span> _ <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb294-27"><a href="#cb294-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="bu">None</span>    <span class="op">=&gt;</span> Call<span class="op">.</span><span class="fu">Continue</span><span class="op">(</span><span class="bu">None</span><span class="op">,</span> cont<span class="op">)</span></span>
<span id="cb294-28"><a href="#cb294-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="bu">Some</span><span class="op">(</span>i<span class="op">)</span> <span class="op">=&gt;</span> Call<span class="op">.</span><span class="fu">Loop</span><span class="op">(</span>right<span class="op">,</span> i<span class="op">,</span> cont<span class="op">)</span></span>
<span id="cb294-29"><a href="#cb294-29" aria-hidden="true" tabindex="-1"></a>          <span class="op">}</span></span>
<span id="cb294-30"><a href="#cb294-30" aria-hidden="true" tabindex="-1"></a>          Call<span class="op">.</span><span class="fu">Loop</span><span class="op">(</span>left<span class="op">,</span> idx<span class="op">,</span> k<span class="op">)</span></span>
<span id="cb294-31"><a href="#cb294-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-32"><a href="#cb294-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">OrElse</span><span class="op">(</span>first<span class="op">,</span> second<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb294-33"><a href="#cb294-33" aria-hidden="true" tabindex="-1"></a>          <span class="kw">val</span> k<span class="op">:</span> Continuation <span class="op">=</span> _ <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb294-34"><a href="#cb294-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="bu">None</span> <span class="op">=&gt;</span> Call<span class="op">.</span><span class="fu">Loop</span><span class="op">(</span>second<span class="op">,</span> idx<span class="op">,</span> cont<span class="op">)</span></span>
<span id="cb294-35"><a href="#cb294-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> some <span class="op">=&gt;</span> Call<span class="op">.</span><span class="fu">Continue</span><span class="op">(</span>some<span class="op">,</span> cont<span class="op">)</span></span>
<span id="cb294-36"><a href="#cb294-36" aria-hidden="true" tabindex="-1"></a>          <span class="op">}</span></span>
<span id="cb294-37"><a href="#cb294-37" aria-hidden="true" tabindex="-1"></a>          Call<span class="op">.</span><span class="fu">Loop</span><span class="op">(</span>first<span class="op">,</span> idx<span class="op">,</span> k<span class="op">)</span></span>
<span id="cb294-38"><a href="#cb294-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-39"><a href="#cb294-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">Repeat</span><span class="op">(</span>source<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb294-40"><a href="#cb294-40" aria-hidden="true" tabindex="-1"></a>          <span class="kw">val</span> k<span class="op">:</span> Continuation <span class="op">=</span></span>
<span id="cb294-41"><a href="#cb294-41" aria-hidden="true" tabindex="-1"></a>            _ <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb294-42"><a href="#cb294-42" aria-hidden="true" tabindex="-1"></a>              <span class="cf">case</span> <span class="bu">None</span>    <span class="op">=&gt;</span> Call<span class="op">.</span><span class="fu">Continue</span><span class="op">(</span><span class="bu">Some</span><span class="op">(</span>idx<span class="op">),</span> cont<span class="op">)</span></span>
<span id="cb294-43"><a href="#cb294-43" aria-hidden="true" tabindex="-1"></a>              <span class="cf">case</span> <span class="bu">Some</span><span class="op">(</span>i<span class="op">)</span> <span class="op">=&gt;</span> Call<span class="op">.</span><span class="fu">Loop</span><span class="op">(</span>regexp<span class="op">,</span> i<span class="op">,</span> cont<span class="op">)</span></span>
<span id="cb294-44"><a href="#cb294-44" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb294-45"><a href="#cb294-45" aria-hidden="true" tabindex="-1"></a>          Call<span class="op">.</span><span class="fu">Loop</span><span class="op">(</span>source<span class="op">,</span> idx<span class="op">,</span> k<span class="op">)</span></span>
<span id="cb294-46"><a href="#cb294-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-47"><a href="#cb294-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">Apply</span><span class="op">(</span>string<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb294-48"><a href="#cb294-48" aria-hidden="true" tabindex="-1"></a>          Call<span class="op">.</span><span class="fu">Continue</span><span class="op">(</span></span>
<span id="cb294-49"><a href="#cb294-49" aria-hidden="true" tabindex="-1"></a>            <span class="ex">Option</span><span class="op">.</span><span class="fu">when</span><span class="op">(</span>input<span class="op">.</span><span class="fu">startsWith</span><span class="op">(</span>string<span class="op">,</span> idx<span class="op">))(</span>idx <span class="op">+</span> string<span class="op">.</span>size<span class="op">),</span></span>
<span id="cb294-50"><a href="#cb294-50" aria-hidden="true" tabindex="-1"></a>            cont</span>
<span id="cb294-51"><a href="#cb294-51" aria-hidden="true" tabindex="-1"></a>          <span class="op">)</span></span>
<span id="cb294-52"><a href="#cb294-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-53"><a href="#cb294-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> Empty <span class="op">=&gt;</span></span>
<span id="cb294-54"><a href="#cb294-54" aria-hidden="true" tabindex="-1"></a>          Call<span class="op">.</span><span class="fu">Continue</span><span class="op">(</span><span class="bu">None</span><span class="op">,</span> cont<span class="op">)</span></span>
<span id="cb294-55"><a href="#cb294-55" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb294-56"><a href="#cb294-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-57"><a href="#cb294-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">trampoline</span><span class="op">(</span>next<span class="op">:</span> Call<span class="op">):</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb294-58"><a href="#cb294-58" aria-hidden="true" tabindex="-1"></a>      next <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb294-59"><a href="#cb294-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> Call<span class="op">.</span><span class="fu">Loop</span><span class="op">(</span>regexp<span class="op">,</span> index<span class="op">,</span> continuation<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb294-60"><a href="#cb294-60" aria-hidden="true" tabindex="-1"></a>          <span class="fu">trampoline</span><span class="op">(</span><span class="fu">loop</span><span class="op">(</span>regexp<span class="op">,</span> index<span class="op">,</span> continuation<span class="op">))</span></span>
<span id="cb294-61"><a href="#cb294-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> Call<span class="op">.</span><span class="fu">Continue</span><span class="op">(</span>index<span class="op">,</span> continuation<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb294-62"><a href="#cb294-62" aria-hidden="true" tabindex="-1"></a>          <span class="fu">trampoline</span><span class="op">(</span><span class="fu">continuation</span><span class="op">(</span>index<span class="op">))</span></span>
<span id="cb294-63"><a href="#cb294-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> Call<span class="op">.</span><span class="fu">Done</span><span class="op">(</span>index<span class="op">)</span> <span class="op">=&gt;</span> index</span>
<span id="cb294-64"><a href="#cb294-64" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb294-65"><a href="#cb294-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-66"><a href="#cb294-66" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check we matched the entire input</span></span>
<span id="cb294-67"><a href="#cb294-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">trampoline</span><span class="op">(</span><span class="fu">loop</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> opt <span class="op">=&gt;</span> Call<span class="op">.</span><span class="fu">Done</span><span class="op">(</span>opt<span class="op">)))</span></span>
<span id="cb294-68"><a href="#cb294-68" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">map</span><span class="op">(</span>idx <span class="op">=&gt;</span> idx <span class="op">==</span> input<span class="op">.</span>size<span class="op">)</span></span>
<span id="cb294-69"><a href="#cb294-69" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">getOrElse</span><span class="op">(</span><span class="kw">false</span><span class="op">)</span></span>
<span id="cb294-70"><a href="#cb294-70" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb294-71"><a href="#cb294-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-72"><a href="#cb294-72" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Append</span><span class="op">(</span>left<span class="op">:</span> Regexp<span class="op">,</span> right<span class="op">:</span> Regexp<span class="op">)</span></span>
<span id="cb294-73"><a href="#cb294-73" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">OrElse</span><span class="op">(</span>first<span class="op">:</span> Regexp<span class="op">,</span> second<span class="op">:</span> Regexp<span class="op">)</span></span>
<span id="cb294-74"><a href="#cb294-74" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Repeat</span><span class="op">(</span>source<span class="op">:</span> Regexp<span class="op">)</span></span>
<span id="cb294-75"><a href="#cb294-75" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Apply</span><span class="op">(</span>string<span class="op">:</span> <span class="ex">String</span><span class="op">)</span></span>
<span id="cb294-76"><a href="#cb294-76" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> Empty</span>
<span id="cb294-77"><a href="#cb294-77" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb294-78"><a href="#cb294-78" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Regexp <span class="op">{</span></span>
<span id="cb294-79"><a href="#cb294-79" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> empty<span class="op">:</span> Regexp <span class="op">=</span> Empty</span>
<span id="cb294-80"><a href="#cb294-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-81"><a href="#cb294-81" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>string<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> Regexp <span class="op">=</span></span>
<span id="cb294-82"><a href="#cb294-82" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Apply</span><span class="op">(</span>string<span class="op">)</span></span>
<span id="cb294-83"><a href="#cb294-83" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <h4 class="unnumbered" id="exericse-trampolined-arithmetic">Exericse: Trampolined
    Arithmetic</h4>
    <p>Convert the CPSed arithmetic interpreter we wrote earlier to a
    trampolined version.</p>
    <div class="solution">
    <p>The process to produce this code is very similar to the regular
    expression example. We just identify all the different types of
    calls (which are the same as the regular expression example) and
    reify them.</p>
    <div class="sourceCode" id="cb295"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb295-1"><a href="#cb295-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Continuation <span class="op">=</span> <span class="ex">Double</span> <span class="op">=&gt;</span> Call</span>
<span id="cb295-2"><a href="#cb295-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-3"><a href="#cb295-3" aria-hidden="true" tabindex="-1"></a>enum Call <span class="op">{</span></span>
<span id="cb295-4"><a href="#cb295-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Continue</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">Double</span><span class="op">,</span> k<span class="op">:</span> Continuation<span class="op">)</span></span>
<span id="cb295-5"><a href="#cb295-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Loop</span><span class="op">(</span>expr<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> k<span class="op">:</span> Continuation<span class="op">)</span></span>
<span id="cb295-6"><a href="#cb295-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Done</span><span class="op">(</span>result<span class="op">:</span> <span class="ex">Double</span><span class="op">)</span></span>
<span id="cb295-7"><a href="#cb295-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb295-8"><a href="#cb295-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-9"><a href="#cb295-9" aria-hidden="true" tabindex="-1"></a>enum <span class="ex">Expression</span> <span class="op">{</span></span>
<span id="cb295-10"><a href="#cb295-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Literal</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">Double</span><span class="op">)</span></span>
<span id="cb295-11"><a href="#cb295-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Addition</span><span class="op">(</span>left<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> right<span class="op">:</span> <span class="ex">Expression</span><span class="op">)</span></span>
<span id="cb295-12"><a href="#cb295-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Subtraction</span><span class="op">(</span>left<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> right<span class="op">:</span> <span class="ex">Expression</span><span class="op">)</span></span>
<span id="cb295-13"><a href="#cb295-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Multiplication</span><span class="op">(</span>left<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> right<span class="op">:</span> <span class="ex">Expression</span><span class="op">)</span></span>
<span id="cb295-14"><a href="#cb295-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Division</span><span class="op">(</span>left<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> right<span class="op">:</span> <span class="ex">Expression</span><span class="op">)</span></span>
<span id="cb295-15"><a href="#cb295-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-16"><a href="#cb295-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> eval<span class="op">:</span> <span class="ex">Double</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb295-17"><a href="#cb295-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">loop</span><span class="op">(</span>expr<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> cont<span class="op">:</span> Continuation<span class="op">):</span> Call <span class="op">=</span></span>
<span id="cb295-18"><a href="#cb295-18" aria-hidden="true" tabindex="-1"></a>      expr <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb295-19"><a href="#cb295-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">Literal</span><span class="op">(</span>value<span class="op">)</span> <span class="op">=&gt;</span> Call<span class="op">.</span><span class="fu">Continue</span><span class="op">(</span>value<span class="op">,</span> cont<span class="op">)</span></span>
<span id="cb295-20"><a href="#cb295-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">Addition</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb295-21"><a href="#cb295-21" aria-hidden="true" tabindex="-1"></a>          Call<span class="op">.</span><span class="fu">Loop</span><span class="op">(</span></span>
<span id="cb295-22"><a href="#cb295-22" aria-hidden="true" tabindex="-1"></a>            left<span class="op">,</span></span>
<span id="cb295-23"><a href="#cb295-23" aria-hidden="true" tabindex="-1"></a>            l <span class="op">=&gt;</span> Call<span class="op">.</span><span class="fu">Loop</span><span class="op">(</span>right<span class="op">,</span> r <span class="op">=&gt;</span> Call<span class="op">.</span><span class="fu">Continue</span><span class="op">(</span>l <span class="op">+</span> r<span class="op">,</span> cont<span class="op">))</span></span>
<span id="cb295-24"><a href="#cb295-24" aria-hidden="true" tabindex="-1"></a>          <span class="op">)</span></span>
<span id="cb295-25"><a href="#cb295-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">Subtraction</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb295-26"><a href="#cb295-26" aria-hidden="true" tabindex="-1"></a>          Call<span class="op">.</span><span class="fu">Loop</span><span class="op">(</span></span>
<span id="cb295-27"><a href="#cb295-27" aria-hidden="true" tabindex="-1"></a>            left<span class="op">,</span></span>
<span id="cb295-28"><a href="#cb295-28" aria-hidden="true" tabindex="-1"></a>            l <span class="op">=&gt;</span> Call<span class="op">.</span><span class="fu">Loop</span><span class="op">(</span>right<span class="op">,</span> r <span class="op">=&gt;</span> Call<span class="op">.</span><span class="fu">Continue</span><span class="op">(</span>l <span class="op">-</span> r<span class="op">,</span> cont<span class="op">))</span></span>
<span id="cb295-29"><a href="#cb295-29" aria-hidden="true" tabindex="-1"></a>          <span class="op">)</span></span>
<span id="cb295-30"><a href="#cb295-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">Multiplication</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb295-31"><a href="#cb295-31" aria-hidden="true" tabindex="-1"></a>          Call<span class="op">.</span><span class="fu">Loop</span><span class="op">(</span></span>
<span id="cb295-32"><a href="#cb295-32" aria-hidden="true" tabindex="-1"></a>            left<span class="op">,</span></span>
<span id="cb295-33"><a href="#cb295-33" aria-hidden="true" tabindex="-1"></a>            l <span class="op">=&gt;</span> Call<span class="op">.</span><span class="fu">Loop</span><span class="op">(</span>right<span class="op">,</span> r <span class="op">=&gt;</span> Call<span class="op">.</span><span class="fu">Continue</span><span class="op">(</span>l <span class="op">*</span> r<span class="op">,</span> cont<span class="op">))</span></span>
<span id="cb295-34"><a href="#cb295-34" aria-hidden="true" tabindex="-1"></a>          <span class="op">)</span></span>
<span id="cb295-35"><a href="#cb295-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">Division</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb295-36"><a href="#cb295-36" aria-hidden="true" tabindex="-1"></a>          Call<span class="op">.</span><span class="fu">Loop</span><span class="op">(</span></span>
<span id="cb295-37"><a href="#cb295-37" aria-hidden="true" tabindex="-1"></a>            left<span class="op">,</span></span>
<span id="cb295-38"><a href="#cb295-38" aria-hidden="true" tabindex="-1"></a>            l <span class="op">=&gt;</span> Call<span class="op">.</span><span class="fu">Loop</span><span class="op">(</span>right<span class="op">,</span> r <span class="op">=&gt;</span> Call<span class="op">.</span><span class="fu">Continue</span><span class="op">(</span>l <span class="op">/</span> r<span class="op">,</span> cont<span class="op">))</span></span>
<span id="cb295-39"><a href="#cb295-39" aria-hidden="true" tabindex="-1"></a>          <span class="op">)</span></span>
<span id="cb295-40"><a href="#cb295-40" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb295-41"><a href="#cb295-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-42"><a href="#cb295-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">trampoline</span><span class="op">(</span>call<span class="op">:</span> Call<span class="op">):</span> <span class="ex">Double</span> <span class="op">=</span></span>
<span id="cb295-43"><a href="#cb295-43" aria-hidden="true" tabindex="-1"></a>      call <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb295-44"><a href="#cb295-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> Call<span class="op">.</span><span class="fu">Continue</span><span class="op">(</span>value<span class="op">,</span> k<span class="op">)</span> <span class="op">=&gt;</span> <span class="fu">trampoline</span><span class="op">(</span><span class="fu">k</span><span class="op">(</span>value<span class="op">))</span></span>
<span id="cb295-45"><a href="#cb295-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> Call<span class="op">.</span><span class="fu">Loop</span><span class="op">(</span>expr<span class="op">,</span> k<span class="op">)</span>      <span class="op">=&gt;</span> <span class="fu">trampoline</span><span class="op">(</span><span class="fu">loop</span><span class="op">(</span>expr<span class="op">,</span> k<span class="op">))</span></span>
<span id="cb295-46"><a href="#cb295-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> Call<span class="op">.</span><span class="fu">Done</span><span class="op">(</span>result<span class="op">)</span>       <span class="op">=&gt;</span> result</span>
<span id="cb295-47"><a href="#cb295-47" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb295-48"><a href="#cb295-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-49"><a href="#cb295-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">trampoline</span><span class="op">(</span><span class="fu">loop</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> x <span class="op">=&gt;</span> Call<span class="op">.</span><span class="fu">Done</span><span class="op">(</span>x<span class="op">)))</span></span>
<span id="cb295-50"><a href="#cb295-50" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb295-51"><a href="#cb295-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-52"><a href="#cb295-52" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">+(</span>that<span class="op">:</span> <span class="ex">Expression</span><span class="op">):</span> <span class="ex">Expression</span> <span class="op">=</span></span>
<span id="cb295-53"><a href="#cb295-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Addition</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb295-54"><a href="#cb295-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-55"><a href="#cb295-55" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">-(</span>that<span class="op">:</span> <span class="ex">Expression</span><span class="op">):</span> <span class="ex">Expression</span> <span class="op">=</span></span>
<span id="cb295-56"><a href="#cb295-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Subtraction</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb295-57"><a href="#cb295-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-58"><a href="#cb295-58" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">*(</span>that<span class="op">:</span> <span class="ex">Expression</span><span class="op">):</span> <span class="ex">Expression</span> <span class="op">=</span></span>
<span id="cb295-59"><a href="#cb295-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Multiplication</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb295-60"><a href="#cb295-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-61"><a href="#cb295-61" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">/(</span>that<span class="op">:</span> <span class="ex">Expression</span><span class="op">):</span> <span class="ex">Expression</span> <span class="op">=</span></span>
<span id="cb295-62"><a href="#cb295-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Division</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb295-63"><a href="#cb295-63" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb295-64"><a href="#cb295-64" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> <span class="ex">Expression</span> <span class="op">{</span></span>
<span id="cb295-65"><a href="#cb295-65" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">Double</span><span class="op">):</span> <span class="ex">Expression</span> <span class="op">=</span></span>
<span id="cb295-66"><a href="#cb295-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Literal</span><span class="op">(</span>value<span class="op">)</span></span>
<span id="cb295-67"><a href="#cb295-67" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    </div>
    <h3 data-number="5.3.5" id="when-tail-recursion-is-easy"><span class="header-section-number">5.3.5</span> When Tail Recursion is
    Easy</h3>
    <p>Doing a full CPS conversion and trampoline can be quite involved.
    Some methods can made tail recursive without so large a change.
    Remember these examples we looked at earlier?</p>
    <div class="sourceCode" id="cb296"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb296-1"><a href="#cb296-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">isntTailRecursive</span><span class="op">(</span>count<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="bu">Int</span> <span class="op">=</span></span>
<span id="cb296-2"><a href="#cb296-2" aria-hidden="true" tabindex="-1"></a>  count <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb296-3"><a href="#cb296-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="dv">0</span> <span class="op">=&gt;</span> <span class="dv">0</span></span>
<span id="cb296-4"><a href="#cb296-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> n <span class="op">=&gt;</span> n <span class="op">+</span> <span class="fu">isntTailRecursive</span><span class="op">(</span>n <span class="op">-</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb296-5"><a href="#cb296-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb296-6"><a href="#cb296-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb296-7"><a href="#cb296-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">isTailRecursive</span><span class="op">(</span>count<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="bu">Int</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb296-8"><a href="#cb296-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">loop</span><span class="op">(</span>count<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> accum<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="bu">Int</span> <span class="op">=</span></span>
<span id="cb296-9"><a href="#cb296-9" aria-hidden="true" tabindex="-1"></a>    count <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb296-10"><a href="#cb296-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="dv">0</span> <span class="op">=&gt;</span> accum</span>
<span id="cb296-11"><a href="#cb296-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> n <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>n <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> accum <span class="op">+</span> n<span class="op">)</span></span>
<span id="cb296-12"><a href="#cb296-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb296-13"><a href="#cb296-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb296-14"><a href="#cb296-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loop</span><span class="op">(</span>count<span class="op">,</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb296-15"><a href="#cb296-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>The tail recursive version doesn’t seem to involve the complexity
    of CPS. How can we relate this to what we’ve just learned, and when
    can we avoid the work of CPS and trampolining?</p>
    <p>Let’s use substitution to show how the stack is used by each
    method, for a small value of <code>count</code>.</p>
    <div class="sourceCode" id="cb297"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb297-1"><a href="#cb297-1" aria-hidden="true" tabindex="-1"></a><span class="fu">isntTailRecursive</span><span class="op">(</span><span class="dv">2</span><span class="op">)</span></span>
<span id="cb297-2"><a href="#cb297-2" aria-hidden="true" tabindex="-1"></a><span class="co">// expands to</span></span>
<span id="cb297-3"><a href="#cb297-3" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="dv">2</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb297-4"><a href="#cb297-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="dv">0</span> <span class="op">=&gt;</span> <span class="dv">0</span></span>
<span id="cb297-5"><a href="#cb297-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> n <span class="op">=&gt;</span> n <span class="op">+</span> <span class="fu">isntTailRecursive</span><span class="op">(</span>n <span class="op">-</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb297-6"><a href="#cb297-6" aria-hidden="true" tabindex="-1"></a><span class="op">})</span></span>
<span id="cb297-7"><a href="#cb297-7" aria-hidden="true" tabindex="-1"></a><span class="co">// expands to</span></span>
<span id="cb297-8"><a href="#cb297-8" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="dv">2</span> <span class="op">+</span> <span class="fu">isntTailRecursive</span><span class="op">(</span><span class="dv">1</span><span class="op">))</span></span>
<span id="cb297-9"><a href="#cb297-9" aria-hidden="true" tabindex="-1"></a><span class="co">// expands to</span></span>
<span id="cb297-10"><a href="#cb297-10" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="dv">2</span> <span class="op">+</span> <span class="op">(</span><span class="dv">1</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb297-11"><a href="#cb297-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="dv">0</span> <span class="op">=&gt;</span> <span class="dv">0</span></span>
<span id="cb297-12"><a href="#cb297-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> n <span class="op">=&gt;</span> n <span class="op">+</span> <span class="fu">isntTailRecursive</span><span class="op">(</span>n <span class="op">-</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb297-13"><a href="#cb297-13" aria-hidden="true" tabindex="-1"></a>      <span class="op">}))</span></span>
<span id="cb297-14"><a href="#cb297-14" aria-hidden="true" tabindex="-1"></a><span class="co">// expands to</span></span>
<span id="cb297-15"><a href="#cb297-15" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="dv">2</span> <span class="op">+</span> <span class="op">(</span><span class="dv">1</span> <span class="op">+</span> <span class="fu">isntTailRecursive</span><span class="op">(</span>n <span class="op">-</span> <span class="dv">1</span><span class="op">)))</span></span>
<span id="cb297-16"><a href="#cb297-16" aria-hidden="true" tabindex="-1"></a><span class="co">// expands to</span></span>
<span id="cb297-17"><a href="#cb297-17" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="dv">2</span> <span class="op">+</span> <span class="op">(</span><span class="dv">1</span> <span class="op">+</span> <span class="op">(</span><span class="dv">0</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb297-18"><a href="#cb297-18" aria-hidden="true" tabindex="-1"></a>             <span class="cf">case</span> <span class="dv">0</span> <span class="op">=&gt;</span> <span class="dv">0</span></span>
<span id="cb297-19"><a href="#cb297-19" aria-hidden="true" tabindex="-1"></a>             <span class="cf">case</span> n <span class="op">=&gt;</span> n <span class="op">+</span> <span class="fu">isntTailRecursive</span><span class="op">(</span>n <span class="op">-</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb297-20"><a href="#cb297-20" aria-hidden="true" tabindex="-1"></a>           <span class="op">})))</span></span>
<span id="cb297-21"><a href="#cb297-21" aria-hidden="true" tabindex="-1"></a><span class="co">// expands to</span></span>
<span id="cb297-22"><a href="#cb297-22" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="dv">2</span> <span class="op">+</span> <span class="op">(</span><span class="dv">1</span> <span class="op">+</span> <span class="op">(</span><span class="dv">0</span><span class="op">)))</span></span>
<span id="cb297-23"><a href="#cb297-23" aria-hidden="true" tabindex="-1"></a><span class="co">// expands to</span></span>
<span id="cb297-24"><a href="#cb297-24" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span></span></code></pre></div>
    <p>Here each set of brackets indicates a new method call and hence a
    stack frame allocation.</p>
    <p>Now let’s do the same for <code>isTailRecursive</code>.</p>
    <div class="sourceCode" id="cb298"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb298-1"><a href="#cb298-1" aria-hidden="true" tabindex="-1"></a><span class="fu">isTailRecursive</span><span class="op">(</span><span class="dv">2</span><span class="op">)</span></span>
<span id="cb298-2"><a href="#cb298-2" aria-hidden="true" tabindex="-1"></a><span class="co">// expands to</span></span>
<span id="cb298-3"><a href="#cb298-3" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="fu">loop</span><span class="op">(</span><span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">))</span></span>
<span id="cb298-4"><a href="#cb298-4" aria-hidden="true" tabindex="-1"></a><span class="co">// expands to</span></span>
<span id="cb298-5"><a href="#cb298-5" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="dv">2</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb298-6"><a href="#cb298-6" aria-hidden="true" tabindex="-1"></a>   <span class="cf">case</span> <span class="dv">0</span> <span class="op">=&gt;</span> <span class="dv">0</span></span>
<span id="cb298-7"><a href="#cb298-7" aria-hidden="true" tabindex="-1"></a>   <span class="cf">case</span> n <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>n <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span> <span class="op">+</span> n<span class="op">)</span></span>
<span id="cb298-8"><a href="#cb298-8" aria-hidden="true" tabindex="-1"></a> <span class="op">})</span></span>
<span id="cb298-9"><a href="#cb298-9" aria-hidden="true" tabindex="-1"></a><span class="co">// expands to</span></span>
<span id="cb298-10"><a href="#cb298-10" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="fu">loop</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">))</span></span>
<span id="cb298-11"><a href="#cb298-11" aria-hidden="true" tabindex="-1"></a><span class="co">// call to loop is a tail call, so no stack frame is allocated </span></span>
<span id="cb298-12"><a href="#cb298-12" aria-hidden="true" tabindex="-1"></a><span class="co">// expands to</span></span>
<span id="cb298-13"><a href="#cb298-13" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="dv">1</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb298-14"><a href="#cb298-14" aria-hidden="true" tabindex="-1"></a>   <span class="cf">case</span> <span class="dv">0</span> <span class="op">=&gt;</span> <span class="dv">2</span></span>
<span id="cb298-15"><a href="#cb298-15" aria-hidden="true" tabindex="-1"></a>   <span class="cf">case</span> n <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>n <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span> <span class="op">+</span> n<span class="op">)</span></span>
<span id="cb298-16"><a href="#cb298-16" aria-hidden="true" tabindex="-1"></a> <span class="op">})</span></span>
<span id="cb298-17"><a href="#cb298-17" aria-hidden="true" tabindex="-1"></a><span class="co">// expands to</span></span>
<span id="cb298-18"><a href="#cb298-18" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="fu">loop</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">3</span><span class="op">))</span></span>
<span id="cb298-19"><a href="#cb298-19" aria-hidden="true" tabindex="-1"></a><span class="co">// call to loop is a tail call, so no stack frame is allocated </span></span>
<span id="cb298-20"><a href="#cb298-20" aria-hidden="true" tabindex="-1"></a><span class="co">// expands to</span></span>
<span id="cb298-21"><a href="#cb298-21" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="dv">0</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb298-22"><a href="#cb298-22" aria-hidden="true" tabindex="-1"></a>   <span class="cf">case</span> <span class="dv">0</span> <span class="op">=&gt;</span> <span class="dv">3</span></span>
<span id="cb298-23"><a href="#cb298-23" aria-hidden="true" tabindex="-1"></a>   <span class="cf">case</span> n <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>n <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">3</span> <span class="op">+</span> n<span class="op">)</span></span>
<span id="cb298-24"><a href="#cb298-24" aria-hidden="true" tabindex="-1"></a> <span class="op">})</span></span>
<span id="cb298-25"><a href="#cb298-25" aria-hidden="true" tabindex="-1"></a><span class="co">// expands to</span></span>
<span id="cb298-26"><a href="#cb298-26" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="dv">3</span><span class="op">)</span></span>
<span id="cb298-27"><a href="#cb298-27" aria-hidden="true" tabindex="-1"></a><span class="co">// expands to</span></span>
<span id="cb298-28"><a href="#cb298-28" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span></span></code></pre></div>
    <p>The non-tail recursive function computes the result
    <code>(2 + (1 + (0)))</code> If we look closely, we’ll see that the
    tail recursive version computes <code>(((2) + 1) + 0)</code>, which
    simply accumulates the result in the reverse order. This works
    because addition is associative, meaning
    <code>(a + b) + c == a + (b + c)</code>. This is our first criteria
    for using the “easy” method for converting to a tail recursive form:
    the operation that accumulates results must be associative.</p>
    <p>This doesn’t explain, though, how we come to realize that
    addition is the correct operation to use. The second criteria is
    that we don’t need any memory beyond the partial result calculated
    from the data we’ve already seen. Some implications of this are that
    we can stop at any time and have a usable result, and that we are
    only applying a single operation to the data. This is not the case
    in the regular expression example. For example, we have the
    following code in the <code>Append</code> case:</p>
    <div class="sourceCode" id="cb299"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb299-1"><a href="#cb299-1" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="fu">Append</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb299-2"><a href="#cb299-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loop</span><span class="op">(</span>left<span class="op">,</span> idx<span class="op">).</span><span class="fu">flatMap</span><span class="op">(</span>i <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>right<span class="op">,</span> i<span class="op">))</span></span></code></pre></div>
    <p>To compute the result for the <code>Append</code> we need to
    compute and combine results from both <code>left</code> and
    <code>right</code>. So when we have computed the result for
    <code>right</code> we need to remember both the result from
    <code>left</code> and that we’re combining the two results using the
    rule for <code>Append</code> rather than, say, <code>OrElse</code>.
    It’s remembering this that is exactly what the continuation does,
    and what stops us from using the easy method we saw when summing the
    elements of a list.</p>
    <p>So, in summary, if we are applying only a single associative
    operation to data we can use the simple method for writing a tail
    recursive method:</p>
    <ol type="1">
    <li>define an structurally recursive loop with an additional
    parameter that is the partial result or accumulator;</li>
    <li>in the base cases return the accumulator; and</li>
    <li>in the recursive cases update the accumulator and call the loop
    in tail position.</li>
    </ol>
    <p>You might be wondering how we handle tree-shaped data with this
    technique. One consequence of an associative operation is that we
    can transform any sequence of operations into a list-shaped
    sequence. If, for example, we have an expression tree that suggests
    we should call operations in the order
    <code>(1 + 2) + (3 + 4)</code> (where I’m using <code>+</code> to
    indicate the operation) we can rewrite that to
    <code>(((1 + 2) + 3) + 4)</code> via associativity. So we can
    transform our tree into a list and then apply the recipe above.</p>
    <h2 data-number="5.4" id="conclusions-3"><span class="header-section-number">5.4</span> Conclusions</h2>
    <p>In this chapter we’ve discussed why we might want to build
    interpreters, and seen techniques for building them. To recap, the
    core of the interpreter strategy is a separation between description
    and action. The description is the program, and the interpreter is
    the action that carries out the program. This separation is allows
    for composition of programs, and managing effects by delaying them
    till the time the program is run. We sometimes call this structure
    an algebra, with constructs and combinators defining programs and
    destructors defining interpreters. Although the name of the strategy
    focuses on the interpreter, the design of the program is just as
    important as it is the user interface through which the programmer
    interacts with the system.</p>
    <p>Our starting implementation strategy is reification of the
    algebra’s constructors and compositional methods as an algebraic
    data type. The interpreter is then a structural recursion over this
    ADT. We saw that the straightforward implementation is not
    stack-safe, and which caused us to introduction the idea of tail
    recursion and continuations. We reified continuations as functions,
    and saw that we can convert any program into continuation-passing
    style which has every method call in tail position. Due to Scala
    runtime limitations not all calls in tail position can be converted
    to tail calls, so we reified calls and returns into data structures
    used by a recursive loop called a trampoline. Underlying all these
    strategies in the concept of duality. We have seen a duality between
    functions and data, which we utilize in reification, and a duality
    between calling functions and returning data, which we use in
    continuations and trampolines.</p>
    <p>Stack-safe interpreters are important in many situations, but the
    code is harder to read than the basic structural recursion. In some
    contexts a basic interpreter may be just fine. It’s unlikely to run
    out of stack space when evaluating a straightforward expression
    tree, as in the arithmetic example. The depth of such a tree grows
    logarithmically with the number of elements, so only extremely large
    trees will have sufficient depth that stack safety becomes relevant.
    However, in the regular expression example the stack consumption is
    determined not by the depth of the regular expression tree, but by
    the length of the input being matched. In this situation stack
    safety is more important. There may still be other constraints that
    allow a simpler implementation. For example, if we know the library
    will only used in situations where inputs were guaranteed to be
    small. As always, only use coding techniques where they make
    sense.</p>
    <p>These ideas are classics in programming language theory.
    <em>Definitional Interpreters for Higher-Order Programming
    Languages</em> <span class="citation" data-cites="10.1145/800194.805852">[Reynolds 1972]</span> details
    defunctionalization, a limited form of reification and continuation
    passing style. (If you want to read this paper, I suggest the <a href="https://homepages.inf.ed.ac.uk/wadler/papers/papers-we-love/reynolds-definitional-interpreters-1998.pdf">re-typeset
    version from 1998</a>, which is much more readable than the original
    typewriter version.) These ideas are expanded on in
    <em>Defunctionalization at Work</em> <span class="citation" data-cites="10.1145/773184.773202">[Danvy and Nielsen 2001]</span>.
    <em>Continuation-Passing Style, Defunctionalization, Accumulations,
    and Associativity</em> <span class="citation" data-cites="gibbons22:cps">[Gibbons 2022]</span> is a very readable
    and elegant paper that highlights the importance of associativity in
    these transformations.</p>
    <p>{#sec:part:two}</p>
    <p>In this part of the book we move on to type classes. We looked at
    the implementation of type classes in Chapter 4. Our focus here is
    on a handful of specific type classes, that are both very useful for
    day-to-day programming tasks and as conceptual models that can drive
    program design. In this part we’ll be looking more at their use for
    day-to-day programming, while the case studies will focus on their
    role in design.</p>
    <p>In Chapter 6 we introduce the <a href="https://typelevel.org/cats">Cats</a> library. Cats provides
    implementation of the type classes we’re interested in, and so it
    saves a lot of time and typing to use it.</p>
    <p><strong>TODO: complete description</strong></p>
    <h1 data-number="6" id="sec:cats"><span class="header-section-number">6</span> Using Cats</h1>
    <p>In this Chapter we’ll learn how to use the <a href="https://typelevel.org/cats">Cats</a> library. Cats provides
    two main things: type classes and their instances, and some useful
    data structures. Our focus will mostly be on the type classes,
    though we will touch on the data structures where appropriate.</p>
    <h2 data-number="6.1" id="quick-start"><span class="header-section-number">6.1</span> Quick Start</h2>
    <p>The easiest, and recommended, way to use Cats is to add the
    following imports:</p>
    <div class="sourceCode" id="cb300"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb300-1"><a href="#cb300-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.*</span></span>
<span id="cb300-2"><a href="#cb300-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>all<span class="op">.*</span></span></code></pre></div>
    <p>The first import adds all the type classes (and makes their
    instances available, as they are found in the companion objects.)
    The second import adds the syntax helpers, which makes the type
    classes easier to work with. Note we don’t need to
    <code>import cats.{*, given}</code> as, at the time of writing, Cats
    is written in Scala 2 style (using <code>implicits</code>) and these
    are imported by the wildcard import.</p>
    <p>If we want use some of Cats’ datastructures, we also need to
    add</p>
    <div class="sourceCode" id="cb301"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb301-1"><a href="#cb301-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>data<span class="op">.*</span></span></code></pre></div>
    <h2 data-number="6.2" id="using-cats"><span class="header-section-number">6.2</span> Using Cats</h2>
    <p>Let’s now see how we work with Cats, using <a href="http://typelevel.org/cats/api/cats/Show.html"><code>cats.Show</code></a>
    as an example.</p>
    <p><code>Show</code> is Cats’ equivalent of the <code>Display</code>
    type class we defined in Section 4.5. It provides a mechanism for
    producing developer-friendly console output without using
    <code>toString</code>. Here’s an abbreviated definition:</p>
    <div class="sourceCode" id="cb302"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb302-1"><a href="#cb302-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> cats</span>
<span id="cb302-2"><a href="#cb302-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb302-3"><a href="#cb302-3" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Show<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb302-4"><a href="#cb302-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">show</span><span class="op">(</span>value<span class="op">:</span> A<span class="op">):</span> <span class="ex">String</span></span>
<span id="cb302-5"><a href="#cb302-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>The easiest way to use <code>Show</code> is with the wildcard
    import above. However, we can also import <code>Show</code> directly
    from the <a href="http://typelevel.org/cats/api/cats/">cats</a>
    package:</p>
    <div class="sourceCode" id="cb303"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb303-1"><a href="#cb303-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Show</span></code></pre></div>
    <p>The companion object of every Cats type class has an
    <code>apply</code> method that locates an instance for any type we
    specify:</p>
    <div class="sourceCode" id="cb304"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb304-1"><a href="#cb304-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> showInt <span class="op">=</span> Show<span class="op">.</span>apply<span class="op">[</span><span class="bu">Int</span><span class="op">]</span></span></code></pre></div>
    <p>Once we have an instance we can call methods on it.</p>
    <div class="sourceCode" id="cb305"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb305-1"><a href="#cb305-1" aria-hidden="true" tabindex="-1"></a>showInt<span class="op">.</span><span class="fu">show</span><span class="op">(</span><span class="dv">42</span><span class="op">)</span></span>
<span id="cb305-2"><a href="#cb305-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res0: String = &quot;42&quot;</span></span></code></pre></div>
    <p>More common, however, is to use the syntax or extension methods,
    which we imported with <code>import cats.syntax.all.*</code>. In the
    case of <code>Show</code>, an extension method <code>show</code> is
    defined.</p>
    <div class="sourceCode" id="cb306"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb306-1"><a href="#cb306-1" aria-hidden="true" tabindex="-1"></a><span class="fl">42.</span>show</span>
<span id="cb306-2"><a href="#cb306-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: String = &quot;42&quot;</span></span></code></pre></div>
    <p>If, for some reason, we wanted just the syntax for
    <code>show</code>, we could import <a href="http://typelevel.org/cats/api/cats/syntax/package$$show$"><code>cats.syntax.show</code></a>.</p>
    <div class="sourceCode" id="cb307"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb307-1"><a href="#cb307-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>show<span class="op">.*</span> <span class="co">// for show</span></span></code></pre></div>
    <h3 data-number="6.2.1" id="defining-custom-instances"><span class="header-section-number">6.2.1</span> Defining Custom
    Instances</h3>
    <p>We can define an instance of <code>Show</code> simply by
    implementing the trait for a given type:</p>
    <div class="sourceCode" id="cb308"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb308-1"><a href="#cb308-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> java<span class="op">.</span>util<span class="op">.</span><span class="ex">Date</span></span>
<span id="cb308-2"><a href="#cb308-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb308-3"><a href="#cb308-3" aria-hidden="true" tabindex="-1"></a>given dateShow<span class="op">:</span> Show<span class="op">[</span><span class="ex">Date</span><span class="op">]</span> <span class="kw">with</span> </span>
<span id="cb308-4"><a href="#cb308-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">show</span><span class="op">(</span>date<span class="op">:</span> <span class="ex">Date</span><span class="op">):</span> <span class="ex">String</span> <span class="op">=</span></span>
<span id="cb308-5"><a href="#cb308-5" aria-hidden="true" tabindex="-1"></a>    <span class="ss">s&quot;${</span>date<span class="op">.</span>getTime<span class="ss">}</span><span class="st">ms since the epoch.</span><span class="ss">&quot;</span></span></code></pre></div>
    <div class="sourceCode" id="cb309"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb309-1"><a href="#cb309-1" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="ex">Date</span><span class="op">().</span>show</span>
<span id="cb309-2"><a href="#cb309-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: String = &quot;1728318739572ms since the epoch.&quot;</span></span></code></pre></div>
    <p>However, Cats also provides a couple of convenient methods to
    simplify the process. There are two construction methods on the
    companion object of <code>Show</code> that we can use to define
    instances for our own types:</p>
    <div class="sourceCode" id="cb310"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb310-1"><a href="#cb310-1" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Show <span class="op">{</span></span>
<span id="cb310-2"><a href="#cb310-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Convert a function to a `Show` instance:</span></span>
<span id="cb310-3"><a href="#cb310-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> show<span class="op">[</span>A<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> <span class="ex">String</span><span class="op">):</span> Show<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb310-4"><a href="#cb310-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb310-5"><a href="#cb310-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb310-6"><a href="#cb310-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create a `Show` instance from a `toString` method:</span></span>
<span id="cb310-7"><a href="#cb310-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> fromToString<span class="op">[</span>A<span class="op">]:</span> Show<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb310-8"><a href="#cb310-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb310-9"><a href="#cb310-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>These allow us to quickly construct instances with less ceremony
    than defining them from scratch:</p>
    <div class="sourceCode" id="cb311"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb311-1"><a href="#cb311-1" aria-hidden="true" tabindex="-1"></a>given dateShow<span class="op">:</span> Show<span class="op">[</span><span class="ex">Date</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb311-2"><a href="#cb311-2" aria-hidden="true" tabindex="-1"></a>  Show<span class="op">.</span><span class="fu">show</span><span class="op">(</span>date <span class="op">=&gt;</span> <span class="ss">s&quot;${</span>date<span class="op">.</span>getTime<span class="ss">}</span><span class="st">ms since the epoch.</span><span class="ss">&quot;</span><span class="op">)</span></span></code></pre></div>
    <p>As you can see, the code using construction methods is much
    terser than the code without. Many type classes in Cats provide
    helper methods like these for constructing instances, either from
    scratch or by transforming existing instances for other types.</p>
    <h4 data-number="6.2.1.1" id="exercise-cat-show"><span class="header-section-number">6.2.1.1</span> Exercise: Cat Show</h4>
    <p>Re-implement the <code>Cat</code> application from Section 4.5.1
    using <code>Show</code> instead of <code>Display</code>.</p>
    <p>Using this data type to represent a well-known type of furry
    animal:</p>
    <div class="sourceCode" id="cb312"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb312-1"><a href="#cb312-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">Cat</span><span class="op">(</span>name<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> age<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> color<span class="op">:</span> <span class="ex">String</span><span class="op">)</span></span></code></pre></div>
    <p>create an implementation of <code>Display</code> for
    <code>Cat</code> that returns content in the following format:</p>
    <div class="sourceCode" id="cb313"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb313-1"><a href="#cb313-1" aria-hidden="true" tabindex="-1"></a><span class="cn">NAME</span> is a <span class="cn">AGE</span> year<span class="kw">-</span>old <span class="cn">COLOR</span> cat<span class="kw">.</span></span></code></pre></div>
    <p>Then use the type class on the console or in a short demo app:
    create a <code>Cat</code> and print it to the console:</p>
    <div class="sourceCode" id="cb314"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb314-1"><a href="#cb314-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Define a cat:</span></span>
<span id="cb314-2"><a href="#cb314-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> cat <span class="op">=</span> <span class="fu">Cat</span><span class="op">(</span><span class="co">/* ... */</span><span class="op">)</span></span>
<span id="cb314-3"><a href="#cb314-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-4"><a href="#cb314-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Print the cat!</span></span></code></pre></div>
    <div class="solution">
    <p>First let’s import everything we need from Cats.</p>
    <div class="sourceCode" id="cb315"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb315-1"><a href="#cb315-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.*</span></span>
<span id="cb315-2"><a href="#cb315-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>all<span class="op">.*</span></span></code></pre></div>
    <p>Our definition of <code>Cat</code> remains the same:</p>
    <div class="sourceCode" id="cb316"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb316-1"><a href="#cb316-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">Cat</span><span class="op">(</span>name<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> age<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> color<span class="op">:</span> <span class="ex">String</span><span class="op">)</span></span></code></pre></div>
    <p>In the companion object we replace our <code>Display</code>
    instance with an instance of <code>Show</code> using one of the
    definition helpers discussed above:</p>
    <div class="sourceCode" id="cb317"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb317-1"><a href="#cb317-1" aria-hidden="true" tabindex="-1"></a>given catShow<span class="op">:</span> Show<span class="op">[</span>Cat<span class="op">]</span> <span class="op">=</span> Show<span class="op">.</span>show<span class="op">[</span>Cat<span class="op">]</span> <span class="op">{</span> cat <span class="op">=&gt;</span></span>
<span id="cb317-2"><a href="#cb317-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> name  <span class="op">=</span> cat<span class="op">.</span>name<span class="op">.</span>show</span>
<span id="cb317-3"><a href="#cb317-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> age   <span class="op">=</span> cat<span class="op">.</span>age<span class="op">.</span>show</span>
<span id="cb317-4"><a href="#cb317-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> color <span class="op">=</span> cat<span class="op">.</span>color<span class="op">.</span>show</span>
<span id="cb317-5"><a href="#cb317-5" aria-hidden="true" tabindex="-1"></a>  <span class="ss">s&quot;$name</span><span class="st"> is a </span><span class="ss">$age</span><span class="st"> year-old </span><span class="ss">$color</span><span class="st"> cat.</span><span class="ss">&quot;</span></span>
<span id="cb317-6"><a href="#cb317-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Finally, we use the <code>Show</code> interface syntax to print
    our instance of <code>Cat</code>:</p>
    <div class="sourceCode" id="cb318"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb318-1"><a href="#cb318-1" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span><span class="op">(</span><span class="fu">Cat</span><span class="op">(</span><span class="st">&quot;Garfield&quot;</span><span class="op">,</span> <span class="dv">38</span><span class="op">,</span> <span class="st">&quot;ginger and black&quot;</span><span class="op">).</span>show<span class="op">)</span></span>
<span id="cb318-2"><a href="#cb318-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Garfield is a 38 year-old ginger and black cat.</span></span></code></pre></div>
    </div>
    <h2 data-number="6.3" id="example-eq"><span class="header-section-number">6.3</span> Example: Eq</h2>
    <p>We will finish off this chapter by looking at another useful type
    class: <a href="http://typelevel.org/cats/api/cats/kernel/Eq.html"><code>cats.Eq</code></a>.
    <code>Eq</code> is designed to support <em>type-safe equality</em>
    and address annoyances using Scala’s built-in <code>==</code>
    operator.</p>
    <p>Almost every Scala developer has written code like this
    before:</p>
    <div class="sourceCode" id="cb319"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb319-1"><a href="#cb319-1" aria-hidden="true" tabindex="-1"></a><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">).</span><span class="fu">map</span><span class="op">(</span><span class="ex">Option</span><span class="op">(</span>_<span class="op">)).</span><span class="fu">filter</span><span class="op">(</span>item <span class="op">=&gt;</span> item <span class="op">==</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb319-2"><a href="#cb319-2" aria-hidden="true" tabindex="-1"></a><span class="co">// warning: Option[Int] and Int are unrelated: they will most likely never compare equal</span></span>
<span id="cb319-3"><a href="#cb319-3" aria-hidden="true" tabindex="-1"></a><span class="co">// res: List[Option[Int]] = List()</span></span></code></pre></div>
    <p>Ok, many of you won’t have made such a simple mistake as this,
    but the principle is sound. The predicate in the <code>filter</code>
    clause always returns <code>false</code> because it is comparing an
    <code>Int</code> to an <code>Option[Int]</code>.</p>
    <p>This is programmer error—we should have compared
    <code>item</code> to <code>Some(1)</code> instead of <code>1</code>.
    However, it’s not technically a type error because <code>==</code>
    works for any pair of objects, no matter what types we compare.
    <code>Eq</code> is designed to add some type safety to equality
    checks and work around this problem.</p>
    <h3 data-number="6.3.1" id="equality-liberty-and-fraternity"><span class="header-section-number">6.3.1</span> Equality, Liberty, and
    Fraternity</h3>
    <p>We can use <code>Eq</code> to define type-safe equality between
    instances of any given type:</p>
    <div class="sourceCode" id="cb320"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb320-1"><a href="#cb320-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> cats</span>
<span id="cb320-2"><a href="#cb320-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb320-3"><a href="#cb320-3" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Eq<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb320-4"><a href="#cb320-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">eqv</span><span class="op">(</span>a<span class="op">:</span> A<span class="op">,</span> b<span class="op">:</span> A<span class="op">):</span> <span class="ex">Boolean</span></span>
<span id="cb320-5"><a href="#cb320-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// other concrete methods based on eqv...</span></span>
<span id="cb320-6"><a href="#cb320-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>The interface syntax, defined in <a href="http://typelevel.org/cats/api/cats/syntax/package$$eq$"><code>cats.syntax.eq</code></a>,
    provides two methods for performing equality checks provided there
    is an instance <code>Eq[A]</code> in scope:</p>
    <ul>
    <li><code>===</code> compares two objects for equality;</li>
    <li><code>=!=</code> compares two objects for inequality.</li>
    </ul>
    <h3 data-number="6.3.2" id="comparing-ints"><span class="header-section-number">6.3.2</span> Comparing Ints</h3>
    <p>Let’s look at a few examples. First we import the type class:</p>
    <div class="sourceCode" id="cb321"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb321-1"><a href="#cb321-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.*</span></span></code></pre></div>
    <p>Now let’s grab an instance for <code>Int</code>:</p>
    <div class="sourceCode" id="cb322"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb322-1"><a href="#cb322-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> eqInt <span class="op">=</span> Eq<span class="op">[</span><span class="bu">Int</span><span class="op">]</span></span></code></pre></div>
    <p>We can use <code>eqInt</code> directly to test for equality:</p>
    <div class="sourceCode" id="cb323"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb323-1"><a href="#cb323-1" aria-hidden="true" tabindex="-1"></a>eqInt<span class="op">.</span><span class="fu">eqv</span><span class="op">(</span><span class="dv">123</span><span class="op">,</span> <span class="dv">123</span><span class="op">)</span></span>
<span id="cb323-2"><a href="#cb323-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: Boolean = true</span></span>
<span id="cb323-3"><a href="#cb323-3" aria-hidden="true" tabindex="-1"></a>eqInt<span class="op">.</span><span class="fu">eqv</span><span class="op">(</span><span class="dv">123</span><span class="op">,</span> <span class="dv">234</span><span class="op">)</span></span>
<span id="cb323-4"><a href="#cb323-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: Boolean = false</span></span></code></pre></div>
    <p>Unlike Scala’s <code>==</code> method, if we try to compare
    objects of different types using <code>eqv</code> we get a compile
    error:</p>
    <div class="sourceCode" id="cb324"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb324-1"><a href="#cb324-1" aria-hidden="true" tabindex="-1"></a>eqInt<span class="op">.</span><span class="fu">eqv</span><span class="op">(</span><span class="dv">123</span><span class="op">,</span> <span class="st">&quot;234&quot;</span><span class="op">)</span></span>
<span id="cb324-2"><a href="#cb324-2" aria-hidden="true" tabindex="-1"></a><span class="co">// error:</span></span>
<span id="cb324-3"><a href="#cb324-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Found:    (&quot;234&quot; : String)</span></span>
<span id="cb324-4"><a href="#cb324-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Required: Int</span></span>
<span id="cb324-5"><a href="#cb324-5" aria-hidden="true" tabindex="-1"></a><span class="co">// eqInt.eqv(123, &quot;234&quot;)</span></span>
<span id="cb324-6"><a href="#cb324-6" aria-hidden="true" tabindex="-1"></a><span class="co">//                ^^^^^</span></span></code></pre></div>
    <p>We can also import the interface syntax in <a href="http://typelevel.org/cats/api/cats/syntax/package$$eq$"><code>cats.syntax.eq</code></a>
    to use the <code>===</code> and <code>=!=</code> methods:</p>
    <div class="sourceCode" id="cb325"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb325-1"><a href="#cb325-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>all<span class="op">.*</span> <span class="co">// for === and =!=</span></span></code></pre></div>
    <div class="sourceCode" id="cb326"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb326-1"><a href="#cb326-1" aria-hidden="true" tabindex="-1"></a><span class="dv">123</span> <span class="op">===</span> <span class="dv">123</span></span>
<span id="cb326-2"><a href="#cb326-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: Boolean = true</span></span>
<span id="cb326-3"><a href="#cb326-3" aria-hidden="true" tabindex="-1"></a><span class="dv">123</span> <span class="op">=!=</span> <span class="dv">234</span></span>
<span id="cb326-4"><a href="#cb326-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: Boolean = true</span></span></code></pre></div>
    <p>Again, comparing values of different types causes a compiler
    error:</p>
    <div class="sourceCode" id="cb327"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb327-1"><a href="#cb327-1" aria-hidden="true" tabindex="-1"></a><span class="dv">123</span> <span class="op">===</span> <span class="st">&quot;123&quot;</span></span>
<span id="cb327-2"><a href="#cb327-2" aria-hidden="true" tabindex="-1"></a><span class="co">// error:</span></span>
<span id="cb327-3"><a href="#cb327-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Found:    (&quot;123&quot; : String)</span></span>
<span id="cb327-4"><a href="#cb327-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Required: Int</span></span>
<span id="cb327-5"><a href="#cb327-5" aria-hidden="true" tabindex="-1"></a><span class="co">// 123 === &quot;123&quot;</span></span>
<span id="cb327-6"><a href="#cb327-6" aria-hidden="true" tabindex="-1"></a><span class="co">//         ^^^^^</span></span></code></pre></div>
    <h3 data-number="6.3.3" id="sec:type-classes:comparing-options"><span class="header-section-number">6.3.3</span> Comparing Options</h3>
    <p>Now for a more interesting example—<code>Option[Int]</code>.</p>
    <div class="sourceCode" id="cb328"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb328-1"><a href="#cb328-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Some</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">===</span> <span class="bu">None</span></span>
<span id="cb328-2"><a href="#cb328-2" aria-hidden="true" tabindex="-1"></a><span class="co">// error:</span></span>
<span id="cb328-3"><a href="#cb328-3" aria-hidden="true" tabindex="-1"></a><span class="co">// value === is not a member of Some[Int] - did you mean Some[Int].==?</span></span>
<span id="cb328-4"><a href="#cb328-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Some(1) === None</span></span>
<span id="cb328-5"><a href="#cb328-5" aria-hidden="true" tabindex="-1"></a><span class="co">// ^^^^^^^^^^^</span></span></code></pre></div>
    <p>We have received an error here because the types don’t quite
    match up. We have <code>Eq</code> instances in scope for
    <code>Int</code> and <code>Option[Int]</code> but the values we are
    comparing are of type <code>Some[Int]</code>. To fix the issue we
    have to re-type the arguments as <code>Option[Int]</code>:</p>
    <div class="sourceCode" id="cb329"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb329-1"><a href="#cb329-1" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="bu">Some</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">:</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">])</span> <span class="op">===</span> <span class="op">(</span><span class="bu">None</span> <span class="op">:</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">])</span></span>
<span id="cb329-2"><a href="#cb329-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res8: Boolean = false</span></span></code></pre></div>
    <p>We can do this in a friendlier fashion using the
    <code>Option.apply</code> and <code>Option.empty</code> methods from
    the standard library:</p>
    <div class="sourceCode" id="cb330"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb330-1"><a href="#cb330-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Option</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">===</span> <span class="ex">Option</span><span class="op">.</span>empty<span class="op">[</span><span class="bu">Int</span><span class="op">]</span></span>
<span id="cb330-2"><a href="#cb330-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res9: Boolean = false</span></span></code></pre></div>
    <p>or using special syntax from <a href="http://typelevel.org/cats/api/cats/syntax/package$$option$"><code>cats.syntax.option</code></a>:</p>
    <div class="sourceCode" id="cb331"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb331-1"><a href="#cb331-1" aria-hidden="true" tabindex="-1"></a><span class="fl">1.</span>some <span class="op">===</span> none<span class="op">[</span><span class="bu">Int</span><span class="op">]</span></span>
<span id="cb331-2"><a href="#cb331-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res10: Boolean = false</span></span>
<span id="cb331-3"><a href="#cb331-3" aria-hidden="true" tabindex="-1"></a><span class="fl">1.</span>some <span class="op">=!=</span> none<span class="op">[</span><span class="bu">Int</span><span class="op">]</span></span>
<span id="cb331-4"><a href="#cb331-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res11: Boolean = true</span></span></code></pre></div>
    <h3 data-number="6.3.4" id="comparing-custom-types"><span class="header-section-number">6.3.4</span> Comparing Custom
    Types</h3>
    <p>We can define our own instances of <code>Eq</code> using the
    <code>Eq.instance</code> method, which accepts a function of type
    <code>(A, A) =&gt; Boolean</code> and returns an
    <code>Eq[A]</code>:</p>
    <div class="sourceCode" id="cb332"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb332-1"><a href="#cb332-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> java<span class="op">.</span>util<span class="op">.</span><span class="ex">Date</span></span>
<span id="cb332-2"><a href="#cb332-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb332-3"><a href="#cb332-3" aria-hidden="true" tabindex="-1"></a>given dateEq<span class="op">:</span> Eq<span class="op">[</span><span class="ex">Date</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb332-4"><a href="#cb332-4" aria-hidden="true" tabindex="-1"></a>  Eq<span class="op">.</span>instance<span class="op">[</span><span class="ex">Date</span><span class="op">]</span> <span class="op">{</span> <span class="op">(</span>date1<span class="op">,</span> date2<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb332-5"><a href="#cb332-5" aria-hidden="true" tabindex="-1"></a>    date1<span class="op">.</span>getTime <span class="op">===</span> date2<span class="op">.</span>getTime</span>
<span id="cb332-6"><a href="#cb332-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <div class="sourceCode" id="cb333"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb333-1"><a href="#cb333-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> x <span class="op">=</span> <span class="kw">new</span> <span class="ex">Date</span><span class="op">()</span> <span class="co">// now</span></span>
<span id="cb333-2"><a href="#cb333-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> y <span class="op">=</span> <span class="kw">new</span> <span class="ex">Date</span><span class="op">()</span> <span class="co">// a bit later than now</span></span></code></pre></div>
    <div class="sourceCode" id="cb334"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb334-1"><a href="#cb334-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">===</span> x</span>
<span id="cb334-2"><a href="#cb334-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res12: Boolean = true</span></span>
<span id="cb334-3"><a href="#cb334-3" aria-hidden="true" tabindex="-1"></a>x <span class="op">===</span> y</span>
<span id="cb334-4"><a href="#cb334-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res13: Boolean = true</span></span></code></pre></div>
    <h4 data-number="6.3.4.1" id="exercise-equality-liberty-and-felinity"><span class="header-section-number">6.3.4.1</span> Exercise: Equality,
    Liberty, and Felinity</h4>
    <p>Implement an instance of <code>Eq</code> for our running
    <code>Cat</code> example:</p>
    <div class="sourceCode" id="cb335"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb335-1"><a href="#cb335-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">Cat</span><span class="op">(</span>name<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> age<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> color<span class="op">:</span> <span class="ex">String</span><span class="op">)</span></span></code></pre></div>
    <p>Use this to compare the following pairs of objects for equality
    and inequality:</p>
    <div class="sourceCode" id="cb336"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb336-1"><a href="#cb336-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> cat1 <span class="op">=</span> <span class="fu">Cat</span><span class="op">(</span><span class="st">&quot;Garfield&quot;</span><span class="op">,</span>   <span class="dv">38</span><span class="op">,</span> <span class="st">&quot;orange and black&quot;</span><span class="op">)</span></span>
<span id="cb336-2"><a href="#cb336-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> cat2 <span class="op">=</span> <span class="fu">Cat</span><span class="op">(</span><span class="st">&quot;Heathcliff&quot;</span><span class="op">,</span> <span class="dv">33</span><span class="op">,</span> <span class="st">&quot;orange and black&quot;</span><span class="op">)</span></span>
<span id="cb336-3"><a href="#cb336-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb336-4"><a href="#cb336-4" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> optionCat1 <span class="op">=</span> <span class="ex">Option</span><span class="op">(</span>cat1<span class="op">)</span></span>
<span id="cb336-5"><a href="#cb336-5" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> optionCat2 <span class="op">=</span> <span class="ex">Option</span><span class="op">.</span>empty<span class="op">[</span>Cat<span class="op">]</span></span></code></pre></div>
    <div class="solution">
    <p>First we need our Cats imports. In this exercise we’ll be using
    the <code>Eq</code> type class and the <code>Eq</code> interface
    syntax, so we start by importing that.</p>
    <div class="sourceCode" id="cb337"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb337-1"><a href="#cb337-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.*</span></span>
<span id="cb337-2"><a href="#cb337-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>all<span class="op">.*</span> </span></code></pre></div>
    <p>Our <code>Cat</code> class is the same as ever:</p>
    <div class="sourceCode" id="cb338"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb338-1"><a href="#cb338-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">Cat</span><span class="op">(</span>name<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> age<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> color<span class="op">:</span> <span class="ex">String</span><span class="op">)</span></span></code></pre></div>
    <p>We bring the <code>Eq</code> instances for <code>Int</code> and
    <code>String</code> into scope for the implementation of
    <code>Eq[Cat]</code>:</p>
    <div class="sourceCode" id="cb339"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb339-1"><a href="#cb339-1" aria-hidden="true" tabindex="-1"></a>given catEqual<span class="op">:</span> Eq<span class="op">[</span>Cat<span class="op">]</span> <span class="op">=</span></span>
<span id="cb339-2"><a href="#cb339-2" aria-hidden="true" tabindex="-1"></a>  Eq<span class="op">.</span>instance<span class="op">[</span>Cat<span class="op">]</span> <span class="op">{</span> <span class="op">(</span>cat1<span class="op">,</span> cat2<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb339-3"><a href="#cb339-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span>cat1<span class="op">.</span>name  <span class="op">===</span> cat2<span class="op">.</span>name <span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span id="cb339-4"><a href="#cb339-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span>cat1<span class="op">.</span>age   <span class="op">===</span> cat2<span class="op">.</span>age  <span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span id="cb339-5"><a href="#cb339-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span>cat1<span class="op">.</span>color <span class="op">===</span> cat2<span class="op">.</span>color<span class="op">)</span></span>
<span id="cb339-6"><a href="#cb339-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>Finally, we test things out in a sample application:</p>
    <div class="sourceCode" id="cb340"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb340-1"><a href="#cb340-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> cat1 <span class="op">=</span> <span class="fu">Cat</span><span class="op">(</span><span class="st">&quot;Garfield&quot;</span><span class="op">,</span>   <span class="dv">38</span><span class="op">,</span> <span class="st">&quot;orange and black&quot;</span><span class="op">)</span></span>
<span id="cb340-2"><a href="#cb340-2" aria-hidden="true" tabindex="-1"></a><span class="co">// cat1: Cat = Cat(name = &quot;Garfield&quot;, age = 38, color = &quot;orange and black&quot;)</span></span>
<span id="cb340-3"><a href="#cb340-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> cat2 <span class="op">=</span> <span class="fu">Cat</span><span class="op">(</span><span class="st">&quot;Heathcliff&quot;</span><span class="op">,</span> <span class="dv">32</span><span class="op">,</span> <span class="st">&quot;orange and black&quot;</span><span class="op">)</span></span>
<span id="cb340-4"><a href="#cb340-4" aria-hidden="true" tabindex="-1"></a><span class="co">// cat2: Cat = Cat(name = &quot;Heathcliff&quot;, age = 32, color = &quot;orange and black&quot;)</span></span>
<span id="cb340-5"><a href="#cb340-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-6"><a href="#cb340-6" aria-hidden="true" tabindex="-1"></a>cat1 <span class="op">===</span> cat2</span>
<span id="cb340-7"><a href="#cb340-7" aria-hidden="true" tabindex="-1"></a><span class="co">// res15: Boolean = false</span></span>
<span id="cb340-8"><a href="#cb340-8" aria-hidden="true" tabindex="-1"></a>cat1 <span class="op">=!=</span> cat2</span>
<span id="cb340-9"><a href="#cb340-9" aria-hidden="true" tabindex="-1"></a><span class="co">// res16: Boolean = true</span></span>
<span id="cb340-10"><a href="#cb340-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-11"><a href="#cb340-11" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> optionCat1 <span class="op">=</span> <span class="ex">Option</span><span class="op">(</span>cat1<span class="op">)</span></span>
<span id="cb340-12"><a href="#cb340-12" aria-hidden="true" tabindex="-1"></a><span class="co">// optionCat1: Option[Cat] = Some(</span></span>
<span id="cb340-13"><a href="#cb340-13" aria-hidden="true" tabindex="-1"></a><span class="co">//   value = Cat(name = &quot;Garfield&quot;, age = 38, color = &quot;orange and black&quot;)</span></span>
<span id="cb340-14"><a href="#cb340-14" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span>
<span id="cb340-15"><a href="#cb340-15" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> optionCat2 <span class="op">=</span> <span class="ex">Option</span><span class="op">.</span>empty<span class="op">[</span>Cat<span class="op">]</span></span>
<span id="cb340-16"><a href="#cb340-16" aria-hidden="true" tabindex="-1"></a><span class="co">// optionCat2: Option[Cat] = None</span></span>
<span id="cb340-17"><a href="#cb340-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb340-18"><a href="#cb340-18" aria-hidden="true" tabindex="-1"></a>optionCat1 <span class="op">===</span> optionCat2</span>
<span id="cb340-19"><a href="#cb340-19" aria-hidden="true" tabindex="-1"></a><span class="co">// res17: Boolean = false</span></span>
<span id="cb340-20"><a href="#cb340-20" aria-hidden="true" tabindex="-1"></a>optionCat1 <span class="op">=!=</span> optionCat2</span>
<span id="cb340-21"><a href="#cb340-21" aria-hidden="true" tabindex="-1"></a><span class="co">// res18: Boolean = true</span></span></code></pre></div>
    </div>
    <h1 data-number="7" id="sec:monoids"><span class="header-section-number">7</span> Monoids and Semigroups</h1>
    <p>In this section we explore our first type classes,
    <strong>monoid</strong> and <strong>semigroup</strong>. These allow
    us to add or combine values. There are instances for
    <code>Ints</code>, <code>Strings</code>, <code>Lists</code>,
    <code>Options</code>, and many more. Let’s start by looking at a few
    simple types and operations to see what common principles we can
    extract.</p>
    <h4 data-number="7.0.0.1" id="integer-addition"><span class="header-section-number">7.0.0.1</span> Integer addition</h4>
    <p>Addition of <code>Ints</code> is a binary operation that is
    <em>closed</em>, meaning that adding two <code>Ints</code> always
    produces another <code>Int</code>:</p>
    <div class="sourceCode" id="cb341"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb341-1"><a href="#cb341-1" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb341-2"><a href="#cb341-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res0: Int = 3</span></span></code></pre></div>
    <p>There is also the <em>identity</em> element <code>0</code> with
    the property that <code>a + 0 == 0 + a == a</code> for any
    <code>Int</code> <code>a</code>:</p>
    <div class="sourceCode" id="cb342"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb342-1"><a href="#cb342-1" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="op">+</span> <span class="dv">0</span></span>
<span id="cb342-2"><a href="#cb342-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: Int = 2</span></span>
<span id="cb342-3"><a href="#cb342-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb342-4"><a href="#cb342-4" aria-hidden="true" tabindex="-1"></a><span class="dv">0</span> <span class="op">+</span> <span class="dv">2</span></span>
<span id="cb342-5"><a href="#cb342-5" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: Int = 2</span></span></code></pre></div>
    <p>There are also other properties of addition. For instance, it
    doesn’t matter in what order we add elements because we always get
    the same result. This is a property known as
    <em>associativity</em>:</p>
    <div class="sourceCode" id="cb343"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb343-1"><a href="#cb343-1" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="dv">1</span> <span class="op">+</span> <span class="dv">2</span><span class="op">)</span> <span class="op">+</span> <span class="dv">3</span></span>
<span id="cb343-2"><a href="#cb343-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: Int = 6</span></span>
<span id="cb343-3"><a href="#cb343-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb343-4"><a href="#cb343-4" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="op">+</span> <span class="op">(</span><span class="dv">2</span> <span class="op">+</span> <span class="dv">3</span><span class="op">)</span></span>
<span id="cb343-5"><a href="#cb343-5" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: Int = 6</span></span></code></pre></div>
    <h4 data-number="7.0.0.2" id="integer-multiplication"><span class="header-section-number">7.0.0.2</span> Integer
    multiplication</h4>
    <p>The same properties for addition also apply for multiplication,
    provided we use <code>1</code> as the identity instead of
    <code>0</code>:</p>
    <div class="sourceCode" id="cb344"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb344-1"><a href="#cb344-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="op">*</span> <span class="dv">3</span></span>
<span id="cb344-2"><a href="#cb344-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: Int = 3</span></span>
<span id="cb344-3"><a href="#cb344-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb344-4"><a href="#cb344-4" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="op">*</span> <span class="dv">1</span></span>
<span id="cb344-5"><a href="#cb344-5" aria-hidden="true" tabindex="-1"></a><span class="co">// res6: Int = 3</span></span></code></pre></div>
    <p>Multiplication, like addition, is associative:</p>
    <div class="sourceCode" id="cb345"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb345-1"><a href="#cb345-1" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="dv">1</span> <span class="op">*</span> <span class="dv">2</span><span class="op">)</span> <span class="op">*</span> <span class="dv">3</span></span>
<span id="cb345-2"><a href="#cb345-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res7: Int = 6</span></span>
<span id="cb345-3"><a href="#cb345-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb345-4"><a href="#cb345-4" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="op">*</span> <span class="op">(</span><span class="dv">2</span> <span class="op">*</span> <span class="dv">3</span><span class="op">)</span></span>
<span id="cb345-5"><a href="#cb345-5" aria-hidden="true" tabindex="-1"></a><span class="co">// res8: Int = 6</span></span></code></pre></div>
    <h4 data-number="7.0.0.3" id="string-and-sequence-concatenation"><span class="header-section-number">7.0.0.3</span> String and sequence
    concatenation</h4>
    <p>We can also add <code>Strings</code>, using string concatenation
    as our binary operator:</p>
    <div class="sourceCode" id="cb346"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb346-1"><a href="#cb346-1" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;One&quot;</span> <span class="op">++</span> <span class="st">&quot;two&quot;</span></span>
<span id="cb346-2"><a href="#cb346-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res9: String = &quot;Onetwo&quot;</span></span></code></pre></div>
    <p>and the empty string as the identity:</p>
    <div class="sourceCode" id="cb347"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb347-1"><a href="#cb347-1" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;&quot;</span> <span class="op">++</span> <span class="st">&quot;Hello&quot;</span></span>
<span id="cb347-2"><a href="#cb347-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res10: String = &quot;Hello&quot;</span></span>
<span id="cb347-3"><a href="#cb347-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb347-4"><a href="#cb347-4" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;Hello&quot;</span> <span class="op">++</span> <span class="st">&quot;&quot;</span></span>
<span id="cb347-5"><a href="#cb347-5" aria-hidden="true" tabindex="-1"></a><span class="co">// res11: String = &quot;Hello&quot;</span></span></code></pre></div>
    <p>Once again, concatenation is associative:</p>
    <div class="sourceCode" id="cb348"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb348-1"><a href="#cb348-1" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="st">&quot;One&quot;</span> <span class="op">++</span> <span class="st">&quot;Two&quot;</span><span class="op">)</span> <span class="op">++</span> <span class="st">&quot;Three&quot;</span></span>
<span id="cb348-2"><a href="#cb348-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res12: String = &quot;OneTwoThree&quot;</span></span>
<span id="cb348-3"><a href="#cb348-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb348-4"><a href="#cb348-4" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;One&quot;</span> <span class="op">++</span> <span class="op">(</span><span class="st">&quot;Two&quot;</span> <span class="op">++</span> <span class="st">&quot;Three&quot;</span><span class="op">)</span></span>
<span id="cb348-5"><a href="#cb348-5" aria-hidden="true" tabindex="-1"></a><span class="co">// res13: String = &quot;OneTwoThree&quot;</span></span></code></pre></div>
    <p>Note that we used <code>++</code> above instead of the more usual
    <code>+</code> to suggest a parallel with sequences. We can do the
    same with other types of sequence, using concatenation as the binary
    operator and the empty sequence as our identity.</p>
    <h2 data-number="7.1" id="definition-of-a-monoid"><span class="header-section-number">7.1</span> Definition of a Monoid</h2>
    <p>We’ve seen a number of “addition” scenarios above each with an
    associative binary addition and an identity element. It will be no
    surprise to learn that this is a monoid. Formally, a monoid for a
    type <code>A</code> is:</p>
    <ul>
    <li>an operation <code>combine</code> with type
    <code>(A, A) =&gt; A</code></li>
    <li>an element <code>empty</code> of type <code>A</code></li>
    </ul>
    <p>This definition translates nicely into Scala code. Here is a
    simplified version of the definition from Cats:</p>
    <div class="sourceCode" id="cb349"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb349-1"><a href="#cb349-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Monoid<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb349-2"><a href="#cb349-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">combine</span><span class="op">(</span>x<span class="op">:</span> A<span class="op">,</span> y<span class="op">:</span> A<span class="op">):</span> A</span>
<span id="cb349-3"><a href="#cb349-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> empty<span class="op">:</span> A</span>
<span id="cb349-4"><a href="#cb349-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>In addition to providing the <code>combine</code> and
    <code>empty</code> operations, monoids must formally obey several
    <em>laws</em>. For all values <code>x</code>, <code>y</code>, and
    <code>z</code>, in <code>A</code>, <code>combine</code> must be
    associative and <code>empty</code> must be an identity element:</p>
    <div class="sourceCode" id="cb350"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb350-1"><a href="#cb350-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> associativeLaw<span class="op">[</span>A<span class="op">](</span>x<span class="op">:</span> A<span class="op">,</span> y<span class="op">:</span> A<span class="op">,</span> z<span class="op">:</span> A<span class="op">)</span></span>
<span id="cb350-2"><a href="#cb350-2" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>using m<span class="op">:</span> Monoid<span class="op">[</span>A<span class="op">]):</span> <span class="ex">Boolean</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb350-3"><a href="#cb350-3" aria-hidden="true" tabindex="-1"></a>  m<span class="op">.</span><span class="fu">combine</span><span class="op">(</span>x<span class="op">,</span> m<span class="op">.</span><span class="fu">combine</span><span class="op">(</span>y<span class="op">,</span> z<span class="op">))</span> <span class="op">==</span></span>
<span id="cb350-4"><a href="#cb350-4" aria-hidden="true" tabindex="-1"></a>    m<span class="op">.</span><span class="fu">combine</span><span class="op">(</span>m<span class="op">.</span><span class="fu">combine</span><span class="op">(</span>x<span class="op">,</span> y<span class="op">),</span> z<span class="op">)</span></span>
<span id="cb350-5"><a href="#cb350-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb350-6"><a href="#cb350-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb350-7"><a href="#cb350-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> identityLaw<span class="op">[</span>A<span class="op">](</span>x<span class="op">:</span> A<span class="op">)</span></span>
<span id="cb350-8"><a href="#cb350-8" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>using m<span class="op">:</span> Monoid<span class="op">[</span>A<span class="op">]):</span> <span class="ex">Boolean</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb350-9"><a href="#cb350-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">(</span>m<span class="op">.</span><span class="fu">combine</span><span class="op">(</span>x<span class="op">,</span> m<span class="op">.</span>empty<span class="op">)</span> <span class="op">==</span> x<span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span id="cb350-10"><a href="#cb350-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span>m<span class="op">.</span><span class="fu">combine</span><span class="op">(</span>m<span class="op">.</span>empty<span class="op">,</span> x<span class="op">)</span> <span class="op">==</span> x<span class="op">)</span></span>
<span id="cb350-11"><a href="#cb350-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Integer subtraction, for example, is not a monoid because
    subtraction is not associative:</p>
    <div class="sourceCode" id="cb351"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb351-1"><a href="#cb351-1" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="dv">1</span> <span class="op">-</span> <span class="dv">2</span><span class="op">)</span> <span class="op">-</span> <span class="dv">3</span></span>
<span id="cb351-2"><a href="#cb351-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res14: Int = -4</span></span>
<span id="cb351-3"><a href="#cb351-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb351-4"><a href="#cb351-4" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="op">-</span> <span class="op">(</span><span class="dv">2</span> <span class="op">-</span> <span class="dv">3</span><span class="op">)</span></span>
<span id="cb351-5"><a href="#cb351-5" aria-hidden="true" tabindex="-1"></a><span class="co">// res15: Int = 2</span></span></code></pre></div>
    <p>In practice we only need to think about laws when we are writing
    our own <code>Monoid</code> instances. Unlawful instances are
    dangerous because they can yield unpredictable results when used
    with the rest of Cats’ machinery. Most of the time we can rely on
    the instances provided by Cats and assume the library authors know
    what they’re doing.</p>
    <h2 data-number="7.2" id="definition-of-a-semigroup"><span class="header-section-number">7.2</span> Definition of a
    Semigroup</h2>
    <p>A semigroup is just the <code>combine</code> part of a monoid,
    without the <code>empty</code> part. While many semigroups are also
    monoids, there are some data types for which we cannot define an
    <code>empty</code> element. For example, we have just seen that
    sequence concatenation and integer addition are monoids. However, if
    we restrict ourselves to non-empty sequences and positive integers,
    we are no longer able to define a sensible <code>empty</code>
    element. Cats has a <a href="http://typelevel.org/cats/api/cats/data/NonEmptyList.html"><code>NonEmptyList</code></a>
    data type that has an implementation of <code>Semigroup</code> but
    no implementation of <code>Monoid</code>.</p>
    <p>A more accurate (though still simplified) definition of Cats’ <a href="http://typelevel.org/cats/api/cats/kernel/Monoid.html"><code>Monoid</code></a>
    is:</p>
    <div class="sourceCode" id="cb352"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb352-1"><a href="#cb352-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Semigroup<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb352-2"><a href="#cb352-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">combine</span><span class="op">(</span>x<span class="op">:</span> A<span class="op">,</span> y<span class="op">:</span> A<span class="op">):</span> A</span>
<span id="cb352-3"><a href="#cb352-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb352-4"><a href="#cb352-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb352-5"><a href="#cb352-5" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Monoid<span class="op">[</span>A<span class="op">]</span> <span class="kw">extends</span> Semigroup<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb352-6"><a href="#cb352-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> empty<span class="op">:</span> A</span>
<span id="cb352-7"><a href="#cb352-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>We’ll see this kind of inheritance often when discussing type
    classes. It provides modularity and allows us to re-use behaviour.
    If we define a <code>Monoid</code> for a type <code>A</code>, we get
    a <code>Semigroup</code> for free. Similarly, if a method requires a
    parameter of type <code>Semigroup[B]</code>, we can pass a
    <code>Monoid[B]</code> instead.</p>
    <h4 data-number="7.2.0.1" id="exercise-the-truth-about-monoids"><span class="header-section-number">7.2.0.1</span> Exercise: The Truth
    About Monoids</h4>
    <p>We’ve seen a few examples of monoids but there are plenty more to
    be found. Consider <code>Boolean</code>. How many monoids can you
    define for this type? For each monoid, define the
    <code>combine</code> and <code>empty</code> operations and convince
    yourself that the monoid laws hold. Use the following definitions as
    a starting point:</p>
    <div class="sourceCode" id="cb353"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb353-1"><a href="#cb353-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Semigroup<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb353-2"><a href="#cb353-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">combine</span><span class="op">(</span>x<span class="op">:</span> A<span class="op">,</span> y<span class="op">:</span> A<span class="op">):</span> A</span>
<span id="cb353-3"><a href="#cb353-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb353-4"><a href="#cb353-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb353-5"><a href="#cb353-5" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Monoid<span class="op">[</span>A<span class="op">]</span> <span class="kw">extends</span> Semigroup<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb353-6"><a href="#cb353-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> empty<span class="op">:</span> A</span>
<span id="cb353-7"><a href="#cb353-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb353-8"><a href="#cb353-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb353-9"><a href="#cb353-9" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Monoid <span class="op">{</span></span>
<span id="cb353-10"><a href="#cb353-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> apply<span class="op">[</span>A<span class="op">](</span><span class="kw">implicit</span> monoid<span class="op">:</span> Monoid<span class="op">[</span>A<span class="op">])</span> <span class="op">=</span></span>
<span id="cb353-11"><a href="#cb353-11" aria-hidden="true" tabindex="-1"></a>    monoid</span>
<span id="cb353-12"><a href="#cb353-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <div class="solution">
    <p>There are at least four monoids for <code>Boolean</code>! First,
    we have <em>and</em> with operator <code>&amp;&amp;</code> and
    identity <code>true</code>:</p>
    <div class="sourceCode" id="cb354"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb354-1"><a href="#cb354-1" aria-hidden="true" tabindex="-1"></a>given booleanAndMonoid<span class="op">:</span> Monoid<span class="op">[</span><span class="ex">Boolean</span><span class="op">]</span> <span class="kw">with</span> <span class="op">{</span></span>
<span id="cb354-2"><a href="#cb354-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">combine</span><span class="op">(</span>a<span class="op">:</span> <span class="ex">Boolean</span><span class="op">,</span> b<span class="op">:</span> <span class="ex">Boolean</span><span class="op">)</span> <span class="op">=</span> a <span class="op">&amp;&amp;</span> b</span>
<span id="cb354-3"><a href="#cb354-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> empty <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb354-4"><a href="#cb354-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Second, we have <em>or</em> with operator <code>||</code> and
    identity <code>false</code>:</p>
    <div class="sourceCode" id="cb355"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb355-1"><a href="#cb355-1" aria-hidden="true" tabindex="-1"></a>given booleanOrMonoid<span class="op">:</span> Monoid<span class="op">[</span><span class="ex">Boolean</span><span class="op">]</span> <span class="kw">with</span> <span class="op">{</span></span>
<span id="cb355-2"><a href="#cb355-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">combine</span><span class="op">(</span>a<span class="op">:</span> <span class="ex">Boolean</span><span class="op">,</span> b<span class="op">:</span> <span class="ex">Boolean</span><span class="op">)</span> <span class="op">=</span> a <span class="op">||</span> b</span>
<span id="cb355-3"><a href="#cb355-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> empty <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb355-4"><a href="#cb355-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Third, we have <em>exclusive or</em> with identity
    <code>false</code>:</p>
    <div class="sourceCode" id="cb356"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb356-1"><a href="#cb356-1" aria-hidden="true" tabindex="-1"></a>given booleanEitherMonoid<span class="op">:</span> Monoid<span class="op">[</span><span class="ex">Boolean</span><span class="op">]</span> <span class="kw">with</span> <span class="op">{</span></span>
<span id="cb356-2"><a href="#cb356-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">combine</span><span class="op">(</span>a<span class="op">:</span> <span class="ex">Boolean</span><span class="op">,</span> b<span class="op">:</span> <span class="ex">Boolean</span><span class="op">)</span> <span class="op">=</span></span>
<span id="cb356-3"><a href="#cb356-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span>a <span class="op">&amp;&amp;</span> <span class="op">!</span>b<span class="op">)</span> <span class="op">||</span> <span class="op">(!</span>a <span class="op">&amp;&amp;</span> b<span class="op">)</span></span>
<span id="cb356-4"><a href="#cb356-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb356-5"><a href="#cb356-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> empty <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb356-6"><a href="#cb356-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Finally, we have <em>exclusive nor</em> (the negation of
    exclusive or) with identity <code>true</code>:</p>
    <div class="sourceCode" id="cb357"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb357-1"><a href="#cb357-1" aria-hidden="true" tabindex="-1"></a>given booleanXnorMonoid<span class="op">:</span> Monoid<span class="op">[</span><span class="ex">Boolean</span><span class="op">]</span> <span class="kw">with</span> <span class="op">{</span></span>
<span id="cb357-2"><a href="#cb357-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">combine</span><span class="op">(</span>a<span class="op">:</span> <span class="ex">Boolean</span><span class="op">,</span> b<span class="op">:</span> <span class="ex">Boolean</span><span class="op">)</span> <span class="op">=</span></span>
<span id="cb357-3"><a href="#cb357-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">(!</span>a <span class="op">||</span> b<span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">(</span>a <span class="op">||</span> <span class="op">!</span>b<span class="op">)</span></span>
<span id="cb357-4"><a href="#cb357-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb357-5"><a href="#cb357-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> empty <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb357-6"><a href="#cb357-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Showing that the identity law holds in each case is
    straightforward. Similarly associativity of the <code>combine</code>
    operation can be shown by enumerating the cases.</p>
    </div>
    <h4 data-number="7.2.0.2" id="exercise-all-set-for-monoids"><span class="header-section-number">7.2.0.2</span> Exercise: All Set for
    Monoids</h4>
    <p>What monoids and semigroups are there for sets?</p>
    <div class="solution">
    <p><em>Set union</em> forms a monoid along with the empty set:</p>
    <div class="sourceCode" id="cb358"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb358-1"><a href="#cb358-1" aria-hidden="true" tabindex="-1"></a>given setUnionMonoid<span class="op">[</span>A<span class="op">]:</span> Monoid<span class="op">[</span><span class="ex">Set</span><span class="op">[</span>A<span class="op">]]</span> <span class="kw">with</span> <span class="op">{</span></span>
<span id="cb358-2"><a href="#cb358-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">combine</span><span class="op">(</span>a<span class="op">:</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">],</span> b<span class="op">:</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">])</span> <span class="op">=</span> a<span class="op">.</span><span class="fu">union</span><span class="op">(</span>b<span class="op">)</span></span>
<span id="cb358-3"><a href="#cb358-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> empty <span class="op">=</span> <span class="ex">Set</span><span class="op">.</span>empty<span class="op">[</span>A<span class="op">]</span></span>
<span id="cb358-4"><a href="#cb358-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>We need to define <code>setUnionMonoid</code> as a method rather
    than a value so we can accept the type parameter <code>A</code>. The
    type parameter allows us to use the same definition to summon
    <code>Monoids</code> for <code>Sets</code> of any type of data:</p>
    <div class="sourceCode" id="cb359"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb359-1"><a href="#cb359-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> intSetMonoid <span class="op">=</span> Monoid<span class="op">[</span><span class="ex">Set</span><span class="op">[</span><span class="bu">Int</span><span class="op">]]</span></span>
<span id="cb359-2"><a href="#cb359-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> strSetMonoid <span class="op">=</span> Monoid<span class="op">[</span><span class="ex">Set</span><span class="op">[</span><span class="ex">String</span><span class="op">]]</span></span></code></pre></div>
    <div class="sourceCode" id="cb360"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb360-1"><a href="#cb360-1" aria-hidden="true" tabindex="-1"></a>intSetMonoid<span class="op">.</span><span class="fu">combine</span><span class="op">(</span><span class="ex">Set</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">),</span> <span class="ex">Set</span><span class="op">(</span><span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">))</span></span>
<span id="cb360-2"><a href="#cb360-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res18: Set[Int] = Set(1, 2, 3)</span></span>
<span id="cb360-3"><a href="#cb360-3" aria-hidden="true" tabindex="-1"></a>strSetMonoid<span class="op">.</span><span class="fu">combine</span><span class="op">(</span><span class="ex">Set</span><span class="op">(</span><span class="st">&quot;A&quot;</span><span class="op">,</span> <span class="st">&quot;B&quot;</span><span class="op">),</span> <span class="ex">Set</span><span class="op">(</span><span class="st">&quot;B&quot;</span><span class="op">,</span> <span class="st">&quot;C&quot;</span><span class="op">))</span></span>
<span id="cb360-4"><a href="#cb360-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res19: Set[String] = Set(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;)</span></span></code></pre></div>
    <p>Set intersection forms a semigroup, but doesn’t form a monoid
    because it has no identity element:</p>
    <div class="sourceCode" id="cb361"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb361-1"><a href="#cb361-1" aria-hidden="true" tabindex="-1"></a>given setIntersectionSemigroup<span class="op">[</span>A<span class="op">]:</span> Semigroup<span class="op">[</span><span class="ex">Set</span><span class="op">[</span>A<span class="op">]]</span> <span class="kw">with</span> <span class="op">{</span></span>
<span id="cb361-2"><a href="#cb361-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">combine</span><span class="op">(</span>a<span class="op">:</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">],</span> b<span class="op">:</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">])</span> <span class="op">=</span></span>
<span id="cb361-3"><a href="#cb361-3" aria-hidden="true" tabindex="-1"></a>    a<span class="op">.</span><span class="fu">intersect</span><span class="op">(</span>b<span class="op">)</span></span>
<span id="cb361-4"><a href="#cb361-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Set complement and set difference are not associative, so they
    cannot be considered for either monoids or semigroups. However,
    symmetric difference (the union less the intersection) does form a
    monoid with the empty set:</p>
    <div class="sourceCode" id="cb362"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb362-1"><a href="#cb362-1" aria-hidden="true" tabindex="-1"></a>given symDiffMonoid<span class="op">[</span>A<span class="op">]:</span> Monoid<span class="op">[</span><span class="ex">Set</span><span class="op">[</span>A<span class="op">]]</span> <span class="kw">with</span> <span class="op">{</span></span>
<span id="cb362-2"><a href="#cb362-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">combine</span><span class="op">(</span>a<span class="op">:</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">],</span> b<span class="op">:</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]):</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb362-3"><a href="#cb362-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span>a<span class="op">.</span><span class="fu">diff</span><span class="op">(</span>b<span class="op">)).</span><span class="fu">union</span><span class="op">(</span>b<span class="op">.</span><span class="fu">diff</span><span class="op">(</span>a<span class="op">))</span></span>
<span id="cb362-4"><a href="#cb362-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb362-5"><a href="#cb362-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> empty<span class="op">:</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> <span class="ex">Set</span><span class="op">.</span>empty</span>
<span id="cb362-6"><a href="#cb362-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    </div>
    <h2 data-number="7.3" id="monoids-in-cats"><span class="header-section-number">7.3</span> Monoids in Cats</h2>
    <p>Now we’ve seen what monoids are, let’s look at their
    implementation in Cats. Once again we’ll look at the three main
    aspects of the implementation: the <em>type class</em>, the
    <em>instances</em>, and the <em>interface</em>.</p>
    <h3 data-number="7.3.1" id="the-monoid-type-class"><span class="header-section-number">7.3.1</span> The Monoid Type
    Class</h3>
    <p>The monoid type class is <code>cats.kernel.Monoid</code>, which
    is aliased as <a href="http://typelevel.org/cats/api/cats/kernel/Monoid.html"><code>cats.Monoid</code></a>.
    <code>Monoid</code> extends <code>cats.kernel.Semigroup</code>,
    which is aliased as <a href="http://typelevel.org/cats/api/cats/kernel/Semigroup.html"><code>cats.Semigroup</code></a>.
    When using Cats we normally import type classes from the <a href="http://typelevel.org/cats/api/cats/"><code>cats</code></a>
    package:</p>
    <div class="sourceCode" id="cb363"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb363-1"><a href="#cb363-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Monoid</span>
<span id="cb363-2"><a href="#cb363-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Semigroup</span></code></pre></div>
    <p>or just</p>
    <div class="sourceCode" id="cb364"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb364-1"><a href="#cb364-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.*</span></span></code></pre></div>
    <section id="cats-kernel" class="unnumbered callout callout-info">
    <h4 class="unnumbered">Cats Kernel?</h4>
    <p>Cats Kernel is a subproject of Cats providing a small set of
    typeclasses for libraries that don’t require the full Cats toolbox.
    While these core type classes are technically defined in the <a href="http://typelevel.org/cats/api/cats/kernel/"><code>cats.kernel</code></a>
    package, they are all aliased to the <a href="http://typelevel.org/cats/api/cats/"><code>cats</code></a>
    package so we rarely need to be aware of the distinction.</p>
    <p>The Cats Kernel type classes covered in this book are <a href="http://typelevel.org/cats/api/cats/kernel/Eq.html"><code>Eq</code></a>,
    <a href="http://typelevel.org/cats/api/cats/kernel/Semigroup.html"><code>Semigroup</code></a>,
    and <a href="http://typelevel.org/cats/api/cats/kernel/Monoid.html"><code>Monoid</code></a>.
    All the other type classes we cover are part of the main Cats
    project and are defined directly in the <a href="http://typelevel.org/cats/api/cats/"><code>cats</code></a>
    package.</p>
    </section>
    <h3 data-number="7.3.2" id="sec:monoid-instances"><span class="header-section-number">7.3.2</span> Monoid Instances</h3>
    <p><code>Monoid</code> follows the standard Cats pattern for the
    user interface: the companion object has an <code>apply</code>
    method that returns the type class instance for a particular type.
    For example, if we want the monoid instance for <code>String</code>,
    and we have the correct given instances in scope, we can write the
    following:</p>
    <div class="sourceCode" id="cb365"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb365-1"><a href="#cb365-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Monoid</span></code></pre></div>
    <div class="sourceCode" id="cb366"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb366-1"><a href="#cb366-1" aria-hidden="true" tabindex="-1"></a>Monoid<span class="op">[</span><span class="ex">String</span><span class="op">].</span><span class="fu">combine</span><span class="op">(</span><span class="st">&quot;Hi &quot;</span><span class="op">,</span> <span class="st">&quot;there&quot;</span><span class="op">)</span></span>
<span id="cb366-2"><a href="#cb366-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: String = &quot;Hi there&quot;</span></span>
<span id="cb366-3"><a href="#cb366-3" aria-hidden="true" tabindex="-1"></a>Monoid<span class="op">[</span><span class="ex">String</span><span class="op">].</span>empty</span>
<span id="cb366-4"><a href="#cb366-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: String = &quot;&quot;</span></span></code></pre></div>
    <p>which is equivalent to:</p>
    <div class="sourceCode" id="cb367"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb367-1"><a href="#cb367-1" aria-hidden="true" tabindex="-1"></a>Monoid<span class="op">.</span>apply<span class="op">[</span><span class="ex">String</span><span class="op">].</span><span class="fu">combine</span><span class="op">(</span><span class="st">&quot;Hi &quot;</span><span class="op">,</span> <span class="st">&quot;there&quot;</span><span class="op">)</span></span>
<span id="cb367-2"><a href="#cb367-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: String = &quot;Hi there&quot;</span></span>
<span id="cb367-3"><a href="#cb367-3" aria-hidden="true" tabindex="-1"></a>Monoid<span class="op">.</span>apply<span class="op">[</span><span class="ex">String</span><span class="op">].</span>empty</span>
<span id="cb367-4"><a href="#cb367-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: String = &quot;&quot;</span></span></code></pre></div>
    <p>As we know, <code>Monoid</code> extends <code>Semigroup</code>.
    If we don’t need <code>empty</code> we can equivalently write:</p>
    <div class="sourceCode" id="cb368"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb368-1"><a href="#cb368-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Semigroup</span></code></pre></div>
    <div class="sourceCode" id="cb369"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb369-1"><a href="#cb369-1" aria-hidden="true" tabindex="-1"></a>Semigroup<span class="op">[</span><span class="ex">String</span><span class="op">].</span><span class="fu">combine</span><span class="op">(</span><span class="st">&quot;Hi &quot;</span><span class="op">,</span> <span class="st">&quot;there&quot;</span><span class="op">)</span></span>
<span id="cb369-2"><a href="#cb369-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: String = &quot;Hi there&quot;</span></span></code></pre></div>
    <p>The standard type class instances for <code>Monoid</code> are all
    found on the appropriate companion objects, and so are automatically
    in the given scope with no further imports required.</p>
    <h3 data-number="7.3.3" id="sec:monoid-syntax"><span class="header-section-number">7.3.3</span> Monoid Syntax</h3>
    <p>Cats provides syntax for the <code>combine</code> method in the
    form of the <code>|+|</code> operator. Because <code>combine</code>
    technically comes from <code>Semigroup</code>, we access the syntax
    by importing from <a href="http://typelevel.org/cats/api/cats/syntax/package$$semigroup$"><code>cats.syntax.semigroup</code></a>:</p>
    <div class="sourceCode" id="cb370"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb370-1"><a href="#cb370-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>semigroup<span class="op">.*</span> <span class="co">// for |+|</span></span></code></pre></div>
    <div class="sourceCode" id="cb371"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb371-1"><a href="#cb371-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> stringResult <span class="op">=</span> <span class="st">&quot;Hi &quot;</span> <span class="op">|+|</span> <span class="st">&quot;there&quot;</span> <span class="op">|+|</span> Monoid<span class="op">[</span><span class="ex">String</span><span class="op">].</span>empty</span>
<span id="cb371-2"><a href="#cb371-2" aria-hidden="true" tabindex="-1"></a><span class="co">// stringResult: String = &quot;Hi there&quot;</span></span>
<span id="cb371-3"><a href="#cb371-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb371-4"><a href="#cb371-4" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> intResult <span class="op">=</span> <span class="dv">1</span> <span class="op">|+|</span> <span class="dv">2</span> <span class="op">|+|</span> Monoid<span class="op">[</span><span class="bu">Int</span><span class="op">].</span>empty</span>
<span id="cb371-5"><a href="#cb371-5" aria-hidden="true" tabindex="-1"></a><span class="co">// intResult: Int = 3</span></span></code></pre></div>
    <p>As always, unless there is compelling reason not, we recommend
    importing all the syntax with</p>
    <div class="sourceCode" id="cb372"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb372-1"><a href="#cb372-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>all<span class="op">.*</span></span></code></pre></div>
    <h4 data-number="7.3.3.1" id="exercise-adding-all-the-things"><span class="header-section-number">7.3.3.1</span> Exercise: Adding All
    The Things</h4>
    <p>The cutting edge <em>SuperAdder v3.5a-32</em> is the world’s
    first choice for adding together numbers. The main function in the
    program has signature <code>def add(items: List[Int]): Int</code>.
    In a tragic accident this code is deleted! Rewrite the method and
    save the day!</p>
    <div class="solution">
    <p>We can write the addition as a <code>foldLeft</code> using
    <code>0</code> and the <code>+</code> operator:</p>
    <div class="sourceCode" id="cb373"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb373-1"><a href="#cb373-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">add</span><span class="op">(</span>items<span class="op">:</span> <span class="ex">List</span><span class="op">[</span><span class="bu">Int</span><span class="op">]):</span> <span class="bu">Int</span> <span class="op">=</span></span>
<span id="cb373-2"><a href="#cb373-2" aria-hidden="true" tabindex="-1"></a>  items<span class="op">.</span><span class="fu">foldLeft</span><span class="op">(</span><span class="dv">0</span><span class="op">)(</span>_ <span class="op">+</span> _<span class="op">)</span></span></code></pre></div>
    <p>We can alternatively write the fold using <code>Monoids</code>,
    although there’s not a compelling use case for this yet:</p>
    <div class="sourceCode" id="cb374"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb374-1"><a href="#cb374-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Monoid</span>
<span id="cb374-2"><a href="#cb374-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>all<span class="op">.*</span></span>
<span id="cb374-3"><a href="#cb374-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb374-4"><a href="#cb374-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">add</span><span class="op">(</span>items<span class="op">:</span> <span class="ex">List</span><span class="op">[</span><span class="bu">Int</span><span class="op">]):</span> <span class="bu">Int</span> <span class="op">=</span></span>
<span id="cb374-5"><a href="#cb374-5" aria-hidden="true" tabindex="-1"></a>  items<span class="op">.</span><span class="fu">foldLeft</span><span class="op">(</span>Monoid<span class="op">[</span><span class="bu">Int</span><span class="op">].</span>empty<span class="op">)(</span>_ <span class="op">|+|</span> _<span class="op">)</span></span></code></pre></div>
    </div>
    <p>Well done! SuperAdder’s market share continues to grow, and now
    there is demand for additional functionality. People now want to add
    <code>List[Option[Int]]</code>. Change <code>add</code> so this is
    possible. The SuperAdder code base is of the highest quality, so
    make sure there is no code duplication!</p>
    <div class="solution">
    <p>Now there is a use case for <code>Monoids</code>. We need a
    single method that adds <code>Ints</code> and instances of
    <code>Option[Int]</code>. We can write this as a generic method that
    accepts an implicit <code>Monoid</code> as a parameter:</p>
    <div class="sourceCode" id="cb375"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb375-1"><a href="#cb375-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Monoid</span>
<span id="cb375-2"><a href="#cb375-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>all<span class="op">.*</span></span>
<span id="cb375-3"><a href="#cb375-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb375-4"><a href="#cb375-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add<span class="op">[</span>A<span class="op">](</span>items<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">])(</span>using monoid<span class="op">:</span> Monoid<span class="op">[</span>A<span class="op">]):</span> A <span class="op">=</span></span>
<span id="cb375-5"><a href="#cb375-5" aria-hidden="true" tabindex="-1"></a>  items<span class="op">.</span><span class="fu">foldLeft</span><span class="op">(</span>monoid<span class="op">.</span>empty<span class="op">)(</span>_ <span class="op">|+|</span> _<span class="op">)</span></span></code></pre></div>
    <p>We can optionally use Scala’s <em>context bound</em> syntax to
    write the same code in a shorter way:</p>
    <div class="sourceCode" id="cb376"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb376-1"><a href="#cb376-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add<span class="op">[</span>A<span class="op">:</span> Monoid<span class="op">](</span>items<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">]):</span> A <span class="op">=</span></span>
<span id="cb376-2"><a href="#cb376-2" aria-hidden="true" tabindex="-1"></a>  items<span class="op">.</span><span class="fu">foldLeft</span><span class="op">(</span>Monoid<span class="op">[</span>A<span class="op">].</span>empty<span class="op">)(</span>_ <span class="op">|+|</span> _<span class="op">)</span></span></code></pre></div>
    <p>We can use this code to add values of type <code>Int</code> and
    <code>Option[Int]</code> as requested:</p>
    <div class="sourceCode" id="cb377"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb377-1"><a href="#cb377-1" aria-hidden="true" tabindex="-1"></a><span class="fu">add</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">))</span></span>
<span id="cb377-2"><a href="#cb377-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res9: Int = 6</span></span></code></pre></div>
    <div class="sourceCode" id="cb378"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb378-1"><a href="#cb378-1" aria-hidden="true" tabindex="-1"></a><span class="fu">add</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="bu">Some</span><span class="op">(</span><span class="dv">1</span><span class="op">),</span> <span class="bu">None</span><span class="op">,</span> <span class="bu">Some</span><span class="op">(</span><span class="dv">2</span><span class="op">),</span> <span class="bu">None</span><span class="op">,</span> <span class="bu">Some</span><span class="op">(</span><span class="dv">3</span><span class="op">)))</span></span>
<span id="cb378-2"><a href="#cb378-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res10: Option[Int] = Some(value = 6)</span></span></code></pre></div>
    <p>Note that if we try to add a list consisting entirely of
    <code>Some</code> values, we get a compile error:</p>
    <div class="sourceCode" id="cb379"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb379-1"><a href="#cb379-1" aria-hidden="true" tabindex="-1"></a><span class="fu">add</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="bu">Some</span><span class="op">(</span><span class="dv">1</span><span class="op">),</span> <span class="bu">Some</span><span class="op">(</span><span class="dv">2</span><span class="op">),</span> <span class="bu">Some</span><span class="op">(</span><span class="dv">3</span><span class="op">)))</span></span>
<span id="cb379-2"><a href="#cb379-2" aria-hidden="true" tabindex="-1"></a><span class="co">// error: </span></span>
<span id="cb379-3"><a href="#cb379-3" aria-hidden="true" tabindex="-1"></a><span class="co">// No given instance of type cats.kernel.Monoid[Some[Int]] was found for a context parameter of method add in object MdocApp3</span></span></code></pre></div>
    <p>This happens because the inferred type of the list is
    <code>List[Some[Int]]</code>, while Cats will only generate a
    <code>Monoid</code> for <code>Option[Int]</code>. We’ll see how to
    get around this in a moment.</p>
    </div>
    <p>SuperAdder is entering the POS (point-of-sale, not the other POS)
    market. Now we want to add up <code>Orders</code>:</p>
    <div class="sourceCode" id="cb380"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb380-1"><a href="#cb380-1" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">Order</span><span class="op">(</span>totalCost<span class="op">:</span> <span class="ex">Double</span><span class="op">,</span> quantity<span class="op">:</span> <span class="ex">Double</span><span class="op">)</span></span></code></pre></div>
    <p>We need to release this code really soon so we can’t make any
    modifications to <code>add</code>. Make it so!</p>
    <div class="solution">
    <p>Easy—we simply define a monoid instance for
    <code>Order</code>!</p>
    <div class="sourceCode" id="cb381"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb381-1"><a href="#cb381-1" aria-hidden="true" tabindex="-1"></a>given monoid<span class="op">:</span> Monoid<span class="op">[</span>Order<span class="op">]</span> <span class="kw">with</span> <span class="op">{</span></span>
<span id="cb381-2"><a href="#cb381-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">combine</span><span class="op">(</span>o1<span class="op">:</span> Order<span class="op">,</span> o2<span class="op">:</span> Order<span class="op">)</span> <span class="op">=</span></span>
<span id="cb381-3"><a href="#cb381-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Order</span><span class="op">(</span></span>
<span id="cb381-4"><a href="#cb381-4" aria-hidden="true" tabindex="-1"></a>      o1<span class="op">.</span>totalCost <span class="op">+</span> o2<span class="op">.</span>totalCost<span class="op">,</span></span>
<span id="cb381-5"><a href="#cb381-5" aria-hidden="true" tabindex="-1"></a>      o1<span class="op">.</span>quantity <span class="op">+</span> o2<span class="op">.</span>quantity</span>
<span id="cb381-6"><a href="#cb381-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span></span>
<span id="cb381-7"><a href="#cb381-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb381-8"><a href="#cb381-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> empty <span class="op">=</span> <span class="fu">Order</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb381-9"><a href="#cb381-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    </div>
    <h2 data-number="7.4" id="applications-of-monoids"><span class="header-section-number">7.4</span> Applications of
    Monoids</h2>
    <p>We now know what a monoid is—an abstraction of the concept of
    adding or combining—but where is it useful? Here are a few big ideas
    where monoids play a major role. These are explored in more detail
    in case studies later in the book.</p>
    <h3 data-number="7.4.1" id="big-data"><span class="header-section-number">7.4.1</span> Big Data</h3>
    <p>In big data applications like Spark and Flink we distribute data
    analysis over many machines, giving fault tolerance and scalability.
    This means each machine will return results over a portion of the
    data, and we must then combine these results to get our final
    result. In the vast majority of cases this can be viewed as a
    monoid.</p>
    <p>If we want to calculate how many total visitors a web site has
    received, that means calculating an <code>Int</code> on each portion
    of the data. We know the monoid instance of <code>Int</code> is
    addition, which is the right way to combine partial results.</p>
    <p>If we want to find out how many unique visitors a website has
    received, that’s equivalent to building a <code>Set[User]</code> on
    each portion of the data. We know the monoid instance for
    <code>Set</code> is the set union, which is the right way to combine
    partial results.</p>
    <p>If we want to calculate 99% and 95% response times from our
    server logs, we can use a data structure called a <code>QTree</code>
    for which there is a monoid.</p>
    <p>Hopefully you get the idea. Almost every analysis that we might
    want to do over a large data set is a monoid, and therefore we can
    build an expressive and powerful analytics system around this idea.
    This is exactly what Twitter’s Algebird and Summingbird projects
    have done. We explore this idea further in the map-reduce case study
    in Section 17.</p>
    <h3 data-number="7.4.2" id="distributed-systems"><span class="header-section-number">7.4.2</span> Distributed Systems</h3>
    <p>In a distributed system, different machines may end up with
    different views of data. For example, one machine may receive an
    update that other machines did not receive. We would like to
    reconcile these different views, so every machine has the same data
    if no more updates arrive. This is called <em>eventual
    consistency</em>.</p>
    <p>A particular class of data types support this reconciliation.
    These data types are called conflict-free replicated data types
    (CRDTs). The key operation is the ability to merge two data
    instances, with a result that captures all the information in both
    instances. This operation relies on having a monoid instance. We
    explore this idea further in the CRDT case study.</p>
    <h3 data-number="7.4.3" id="monoids-in-the-small"><span class="header-section-number">7.4.3</span> Monoids in the Small</h3>
    <p>The two examples above are cases where monoids inform the entire
    system architecture. There are also many cases where having a monoid
    around makes it easier to write a small code fragment. We’ll see
    lots of examples in the remainder of this book.</p>
    <h2 data-number="7.5" id="summary"><span class="header-section-number">7.5</span> Summary</h2>
    <p>We hit a big milestone in this chapter—we covered our first type
    classes with fancy functional programming names:</p>
    <ul>
    <li>a <code>Semigroup</code> represents an addition or combination
    operation;</li>
    <li>a <code>Monoid</code> extends a <code>Semigroup</code> by adding
    an identity or “zero” element.</li>
    </ul>
    <p>We can use <code>Semigroups</code> and <code>Monoids</code> by
    importing two things: the type classes themselves, and the semigroup
    syntax to give us the <code>|+|</code> operator:</p>
    <div class="sourceCode" id="cb382"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb382-1"><a href="#cb382-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Monoid</span>
<span id="cb382-2"><a href="#cb382-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>semigroup<span class="op">.*</span> <span class="co">// for |+|</span></span></code></pre></div>
    <div class="sourceCode" id="cb383"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb383-1"><a href="#cb383-1" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;Scala&quot;</span> <span class="op">|+|</span> <span class="st">&quot; with &quot;</span> <span class="op">|+|</span> <span class="st">&quot;Cats&quot;</span></span>
<span id="cb383-2"><a href="#cb383-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res0: String = &quot;Scala with Cats&quot;</span></span></code></pre></div>
    <p>With the correct instances in scope, we can set about adding
    anything we want:</p>
    <div class="sourceCode" id="cb384"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb384-1"><a href="#cb384-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Option</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">|+|</span> <span class="ex">Option</span><span class="op">(</span><span class="dv">2</span><span class="op">)</span></span>
<span id="cb384-2"><a href="#cb384-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: Option[Int] = Some(value = 3)</span></span></code></pre></div>
    <div class="sourceCode" id="cb385"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb385-1"><a href="#cb385-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> map1 <span class="op">=</span> <span class="ex">Map</span><span class="op">(</span><span class="st">&quot;a&quot;</span> <span class="op">-&gt;</span> <span class="dv">1</span><span class="op">,</span> <span class="st">&quot;b&quot;</span> <span class="op">-&gt;</span> <span class="dv">2</span><span class="op">)</span></span>
<span id="cb385-2"><a href="#cb385-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> map2 <span class="op">=</span> <span class="ex">Map</span><span class="op">(</span><span class="st">&quot;b&quot;</span> <span class="op">-&gt;</span> <span class="dv">3</span><span class="op">,</span> <span class="st">&quot;d&quot;</span> <span class="op">-&gt;</span> <span class="dv">4</span><span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb386"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb386-1"><a href="#cb386-1" aria-hidden="true" tabindex="-1"></a>map1 <span class="op">|+|</span> map2</span>
<span id="cb386-2"><a href="#cb386-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: Map[String, Int] = Map(&quot;b&quot; -&gt; 5, &quot;d&quot; -&gt; 4, &quot;a&quot; -&gt; 1)</span></span></code></pre></div>
    <div class="sourceCode" id="cb387"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb387-1"><a href="#cb387-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> tuple1 <span class="op">=</span> <span class="op">(</span><span class="st">&quot;hello&quot;</span><span class="op">,</span> <span class="dv">123</span><span class="op">)</span></span>
<span id="cb387-2"><a href="#cb387-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> tuple2 <span class="op">=</span> <span class="op">(</span><span class="st">&quot;world&quot;</span><span class="op">,</span> <span class="dv">321</span><span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb388"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb388-1"><a href="#cb388-1" aria-hidden="true" tabindex="-1"></a>tuple1 <span class="op">|+|</span> tuple2</span>
<span id="cb388-2"><a href="#cb388-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: Tuple2[String, Int] = (&quot;helloworld&quot;, 444)</span></span></code></pre></div>
    <p>We can also write generic code that works with any type for which
    we have an instance of <code>Monoid</code>:</p>
    <div class="sourceCode" id="cb389"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb389-1"><a href="#cb389-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> addAll<span class="op">[</span>A<span class="op">](</span>values<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">])</span></span>
<span id="cb389-2"><a href="#cb389-2" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>using monoid<span class="op">:</span> Monoid<span class="op">[</span>A<span class="op">]):</span> A <span class="op">=</span></span>
<span id="cb389-3"><a href="#cb389-3" aria-hidden="true" tabindex="-1"></a>  values<span class="op">.</span><span class="fu">foldRight</span><span class="op">(</span>monoid<span class="op">.</span>empty<span class="op">)(</span>_ <span class="op">|+|</span> _<span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb390"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb390-1"><a href="#cb390-1" aria-hidden="true" tabindex="-1"></a><span class="fu">addAll</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">))</span></span>
<span id="cb390-2"><a href="#cb390-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: Int = 6</span></span>
<span id="cb390-3"><a href="#cb390-3" aria-hidden="true" tabindex="-1"></a><span class="fu">addAll</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="bu">None</span><span class="op">,</span> <span class="bu">Some</span><span class="op">(</span><span class="dv">1</span><span class="op">),</span> <span class="bu">Some</span><span class="op">(</span><span class="dv">2</span><span class="op">)))</span></span>
<span id="cb390-4"><a href="#cb390-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: Option[Int] = Some(value = 3)</span></span></code></pre></div>
    <p><code>Monoids</code> are a great gateway to Cats. They’re easy to
    understand and simple to use. However, they’re just the tip of the
    iceberg in terms of the abstractions Cats enables us to make. In the
    next chapter we’ll look at <em>functors</em>, the type class
    personification of the beloved <code>map</code> method. That’s where
    the fun really begins!</p>
    <h1 data-number="8" id="functors"><span class="header-section-number">8</span> Functors</h1>
    <p>In this chapter we will investigate <strong>functors</strong>, an
    abstraction that allows us to represent sequences of operations
    within a context such as a <code>List</code>, an
    <code>Option</code>, or any one of thousands of other possibilities.
    Functors on their own aren’t so useful, but special cases of
    functors, such as <strong>monads</strong> and <strong>applicative
    functors</strong>, are some of the most commonly used
    abstractions.</p>
    <h2 data-number="8.1" id="sec:functors:examples"><span class="header-section-number">8.1</span> Examples of Functors</h2>
    <p>Informally, a functor is anything with a <code>map</code> method.
    You probably know lots of types that have this: <code>Option</code>,
    <code>List</code>, and <code>Either</code>, to name a few.</p>
    <p>We typically first encounter <code>map</code> when iterating over
    <code>Lists</code>. However, to understand functors we need to think
    of the method in another way. Rather than traversing the list, we
    should think of it as transforming all of the values inside in one
    go. We specify the function to apply, and <code>map</code> ensures
    it is applied to every item. The values change but the structure of
    the list (the number of elements and their order) remains the
    same:</p>
    <div class="sourceCode" id="cb391"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb391-1"><a href="#cb391-1" aria-hidden="true" tabindex="-1"></a><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">).</span><span class="fu">map</span><span class="op">(</span>n <span class="op">=&gt;</span> n <span class="op">+</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb391-2"><a href="#cb391-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res0: List[Int] = List(2, 3, 4)</span></span></code></pre></div>
    <p>Similarly, when we <code>map</code> over an <code>Option</code>,
    we transform the contents but leave the <code>Some</code> or
    <code>None</code> context unchanged. The same principle applies to
    <code>Either</code> with its <code>Left</code> and
    <code>Right</code> contexts. This general notion of transformation,
    along with the common pattern of type signatures shown in Figure 1,
    is what connects the behaviour of <code>map</code> across different
    data types.</p>
    <figure id="fig:functors:list-option-either-type-chart">
    <svg id="svg_63a9ce4d05972af105b0" alt="Type chart: mapping over List, Option, and Either" width="1761px" height="1160px" viewBox="0 0 1761 1160">
    <!-- Generator: Sketch 43.2 (39069) - http://www.bohemiancoding.com/sketch -->
    <title>list-option-either-map</title>
    <desc>Created with Sketch.</desc>
    <defs>
        <circle id="svg_63a9ce4d05972af105b0_path-1" cx="729" cy="140" r="80"></circle>
        <polygon id="svg_63a9ce4d05972af105b0_path-2" points="1039.59509 194 986.694414 221.811529 996.797543 162.905765 954 121.188471 1013.14475 112.594235 1039.59509 59 1066.04542 112.594235 1125.19017 121.188471 1082.39263 162.905765 1092.49576 221.811529"></polygon>
        <polygon id="svg_63a9ce4d05972af105b0_path-3" points="851 120 891 120 891 100 931 139.497767 891 180 891 160 851 160"></polygon>
        <ellipse id="svg_63a9ce4d05972af105b0_path-4" cx="63.5614334" cy="63.6424051" rx="63.5614334" ry="63.6424051"></ellipse>
        <polygon id="svg_63a9ce4d05972af105b0_path-5" points="249.35438 126.64159 205.606941 149.649143 213.961958 100.918365 178.569536 66.407036 227.48066 59.2973113 249.35438 14.9605848 271.2281 59.2973113 320.139224 66.407036 284.746802 100.918365 293.101819 149.649143"></polygon>
        <path d="M20.058808,155.768753 C34.6818214,171.893119 55.675188,182 79,182 C123.18278,182 159,145.735065 159,101 C159,77.7454802 149.321446,56.7797646 133.820422,42.0071389 L20.058808,155.768753 Z" id="svg_63a9ce4d05972af105b0_path-6" />
        <mask id="svg_63a9ce4d05972af105b0_mask-7" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="138.941192" height="139.992861" fill="white">
            <use xlink:href="#svg_63a9ce4d05972af105b0_path-6" />
        </mask>
        <path d="M23.9260115,158.058837 C9.15850523,143.544644 -1.42108547e-14,123.341864 -1.42108547e-14,101 C-1.42108547e-14,56.81722 35.81722,21 80,21 C102.341864,21 122.544644,30.1585052 137.058837,44.9260115 L23.9260115,158.058837 Z" id="svg_63a9ce4d05972af105b0_path-8" />
        <path d="M1093.55806,143.194146 L1087,181.430593 L1139.90067,153.619064 L1192.80135,181.430593 L1182.69822,122.524828 L1225.49576,80.807534 L1166.35101,72.2132988 L1165.75221,71 L1093.55806,143.194146 Z" id="svg_63a9ce4d05972af105b0_path-9" />
        <mask id="svg_63a9ce4d05972af105b0_mask-10" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="138.495759" height="110.430593" fill="white">
            <use xlink:href="#svg_63a9ce4d05972af105b0_path-9" />
        </mask>
        <path d="M1091.9778,151.007053 L1096.79754,122.905765 L1054,81.1884705 L1113.14475,72.5942353 L1139.59509,19 L1166.04542,72.5942353 L1169.83933,73.1455217 L1091.9778,151.007053 Z" id="svg_63a9ce4d05972af105b0_path-11" />
        <circle id="svg_63a9ce4d05972af105b0_path-12" cx="729" cy="140" r="80"></circle>
        <polygon id="svg_63a9ce4d05972af105b0_path-13" points="1039.59509 194 986.694414 221.811529 996.797543 162.905765 954 121.188471 1013.14475 112.594235 1039.59509 59 1066.04542 112.594235 1125.19017 121.188471 1082.39263 162.905765 1092.49576 221.811529"></polygon>
        <polygon id="svg_63a9ce4d05972af105b0_path-14" points="851 120 891 120 891 100 931 139.497767 891 180 891 160 851 160"></polygon>
        <circle id="svg_63a9ce4d05972af105b0_path-15" cx="80" cy="80" r="80"></circle>
        <circle id="svg_63a9ce4d05972af105b0_path-16" cx="100" cy="100" r="80"></circle>
        <circle id="svg_63a9ce4d05972af105b0_path-17" cx="120" cy="120" r="80"></circle>
        <circle id="svg_63a9ce4d05972af105b0_path-18" cx="727" cy="143" r="80"></circle>
        <polygon id="svg_63a9ce4d05972af105b0_path-19" points="1037.59509 197 984.694414 224.811529 994.797543 165.905765 952 124.188471 1011.14475 115.594235 1037.59509 62 1064.04542 115.594235 1123.19017 124.188471 1080.39263 165.905765 1090.49576 224.811529"></polygon>
        <polygon id="svg_63a9ce4d05972af105b0_path-20" points="85.5950865 135 32.6944138 162.811529 42.7975432 103.905765 -1.17239551e-13 62.1884705 59.1447501 53.5942353 85.5950865 0 112.045423 53.5942353 171.190173 62.1884705 128.39263 103.905765 138.495759 162.811529"></polygon>
        <polygon id="svg_63a9ce4d05972af105b0_path-21" points="101.595086 155 48.6944138 182.811529 58.7975432 123.905765 16 82.1884705 75.1447501 73.5942353 101.595086 20 128.045423 73.5942353 187.190173 82.1884705 144.39263 123.905765 154.495759 182.811529"></polygon>
        <polygon id="svg_63a9ce4d05972af105b0_path-22" points="119.595086 178 66.6944138 205.811529 76.7975432 146.905765 34 105.188471 93.1447501 96.5942353 119.595086 43 146.045423 96.5942353 205.190173 105.188471 162.39263 146.905765 172.495759 205.811529"></polygon>
        <polygon id="svg_63a9ce4d05972af105b0_path-23" points="849 123 889 123 889 103 929 142.497767 889 183 889 163 849 163"></polygon>
    </defs>
    <g id="svg_63a9ce4d05972af105b0_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_63a9ce4d05972af105b0_list-option-either-map">
            <g id="svg_63a9ce4d05972af105b0_either-map" transform="translate(0.000000, 800.000000)">
                <rect id="svg_63a9ce4d05972af105b0_Background" fill="#FFFFFF" x="0" y="0" width="1760" height="360" />
                <g id="svg_63a9ce4d05972af105b0_Oval-1-Copy-2">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_63a9ce4d05972af105b0_path-1" />
                    <circle stroke="#000000" stroke-width="4" cx="729" cy="140" r="78"></circle>
                </g>
                <g id="svg_63a9ce4d05972af105b0_Star-1-Copy-2">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_63a9ce4d05972af105b0_path-2" />
                    <path stroke="#000000" stroke-width="4" d="M989.350676,218.155498 L998.76876,163.243855 L998.946504,162.207525 L998.193567,161.473592 L958.297922,122.58495 L1013.43235,114.573449 L1014.47288,114.422251 L1014.93822,113.479367 L1039.59509,63.5191029 L1064.25195,113.479367 L1064.71729,114.422251 L1065.75783,114.573449 L1120.89225,122.58495 L1080.99661,161.473592 L1080.24367,162.207525 L1080.42141,163.243855 L1089.8395,218.155498 L1040.52577,192.229737 L1039.59509,191.740449 L1038.6644,192.229737 L989.350676,218.155498 Z" />
                </g>
                <g id="svg_63a9ce4d05972af105b0_Path-1-Copy-3">
                    <use fill="#000000" fill-rule="evenodd" xlink:href="#svg_63a9ce4d05972af105b0_path-3" />
                    <path stroke="#000000" stroke-width="4" d="M853,122 L891,122 L893,122 L893,120 L893,104.785615 L928.171517,139.515525 L893,175.128649 L893,160 L893,158 L891,158 L853,158 L853,122 Z" />
                </g>
                <polygon id="svg_63a9ce4d05972af105b0_Path-1-Copy-4" fill="#F6A623" points="1181 120 1221 120 1221 100 1261 139.497767 1221 180 1221 160 1181 160"></polygon>
                <text id="svg_63a9ce4d05972af105b0_Either[E,-A]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                    <tspan x="173.8" y="314">Either[E, A]</tspan>
                </text>
                <text id="svg_63a9ce4d05972af105b0_map-copy-2" font-family="FiraMono-Bold, Fira Mono" font-size="64" font-weight="bold" fill="#F6A623">
                    <tspan x="498.4" y="156">map</tspan>
                </text>
                <text id="svg_63a9ce4d05972af105b0_Either[E,-B]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                    <tspan x="1305.8" y="314">Either[E, B]</tspan>
                </text>
                <text id="svg_63a9ce4d05972af105b0_A-=&gt;-B-Copy-2" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                    <tspan x="825.4" y="314">A =&gt; B</tspan>
                </text>
                <g id="svg_63a9ce4d05972af105b0_Group-10" transform="translate(160.000000, 55.000000)">
                    <g id="svg_63a9ce4d05972af105b0_Group-2" transform="translate(185.877133, 20.322785)">
                        <g id="svg_63a9ce4d05972af105b0_Oval-1">
                            <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_63a9ce4d05972af105b0_path-4" />
                            <ellipse stroke="#000000" stroke-width="4" cx="63.5614334" cy="63.6424051" rx="61.5614334" ry="61.6424051"></ellipse>
                        </g>
                    </g>
                    <polygon id="svg_63a9ce4d05972af105b0_Polygon-2" stroke="#000000" stroke-width="4" points="62.6292391 20.3227848 124.986348 65.6855911 101.168052 139.084153 24.0904264 139.084153 0.272130176 65.6855911"></polygon>
                    <path d="M181.069966,0.534810127 L122.3157,168.46519" id="svg_63a9ce4d05972af105b0_Line" stroke="#000000" stroke-width="4" stroke-linecap="square" />
                </g>
                <g id="svg_63a9ce4d05972af105b0_Group-11" transform="translate(1300.000000, 59.000000)">
                    <g id="svg_63a9ce4d05972af105b0_Star-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_63a9ce4d05972af105b0_path-5" />
                        <path stroke="#000000" stroke-width="4" d="M208.263062,145.992517 L215.933195,101.256338 L216.110827,100.220295 L215.358236,99.4864396 L182.866378,67.8034659 L227.768357,61.2765109 L228.808998,61.1252432 L229.274257,60.1821902 L249.35438,19.4809775 L269.434503,60.1821902 L269.899762,61.1252432 L270.940403,61.2765109 L315.842382,67.8034659 L283.350524,99.4864396 L282.597933,100.220295 L282.775565,101.256338 L290.445698,145.992517 L250.285321,124.871464 L249.35438,124.381865 L248.423439,124.871464 L208.263062,145.992517 Z" />
                    </g>
                    <polygon id="svg_63a9ce4d05972af105b0_Polygon-2" stroke="#000000" stroke-width="4" points="62.0450793 20.2025316 124.090159 65.2969189 100.391047 138.26117 23.6991115 138.26117 9.45910017e-14 65.2969189"></polygon>
                    <path d="M179.100993,0.53164557 L120.640728,167.468354" id="svg_63a9ce4d05972af105b0_Line" stroke="#000000" stroke-width="4" stroke-linecap="square" />
                </g>
            </g>
            <g id="svg_63a9ce4d05972af105b0_option-map" transform="translate(1.000000, 403.000000)">
                <rect id="svg_63a9ce4d05972af105b0_Background" fill="#FFFFFF" x="0" y="0" width="1760" height="360" />
                <g id="svg_63a9ce4d05972af105b0_Group-4" transform="translate(279.000000, 38.000000)">
                    <use id="svg_63a9ce4d05972af105b0_Combined-Shape" stroke="#9B9B9B" mask="url(#mask-7)" stroke-width="8" fill="#FFFFFF" stroke-dasharray="10,5" xlink:href="#svg_63a9ce4d05972af105b0_path-6" />
                    <g id="svg_63a9ce4d05972af105b0_Combined-Shape">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_63a9ce4d05972af105b0_path-8" />
                        <path stroke="#000000" stroke-width="4" d="M23.9314248,155.224996 C9.96856716,140.794787 2,121.532404 2,101 C2,57.9217895 36.9217895,23 80,23 C100.532404,23 119.794787,30.9685672 134.224996,44.9314248 L23.9314248,155.224996 Z" />
                    </g>
                    <rect id="svg_63a9ce4d05972af105b0_Rectangle-1" stroke="#000000" stroke-width="4" x="1022" y="2" width="196" height="196" rx="8" />
                </g>
                <g id="svg_63a9ce4d05972af105b0_Group-3" transform="translate(259.000000, 38.000000)">
                    <use id="svg_63a9ce4d05972af105b0_Combined-Shape" stroke="#9B9B9B" mask="url(#mask-10)" stroke-width="8" fill="#FFFFFF" stroke-dasharray="10,5" xlink:href="#svg_63a9ce4d05972af105b0_path-9" />
                    <g id="svg_63a9ce4d05972af105b0_Combined-Shape">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_63a9ce4d05972af105b0_path-11" />
                        <path stroke="#000000" stroke-width="4" d="M1095.01263,145.143795 L1098.76876,123.243855 L1098.9465,122.207525 L1098.19357,121.473592 L1058.29792,82.5849501 L1113.43235,74.5734493 L1114.47288,74.4222508 L1114.93822,73.4793667 L1139.59509,23.5191029 L1164.25195,73.4793667 L1164.71729,74.4222508 L1165.60516,74.551265 L1095.01263,145.143795 Z" />
                    </g>
                    <rect id="svg_63a9ce4d05972af105b0_Rectangle-1" stroke="#000000" stroke-width="4" x="2" y="2" width="196" height="196" rx="8" />
                </g>
                <g id="svg_63a9ce4d05972af105b0_Oval-1">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_63a9ce4d05972af105b0_path-12" />
                    <circle stroke="#000000" stroke-width="4" cx="729" cy="140" r="78"></circle>
                </g>
                <g id="svg_63a9ce4d05972af105b0_Star-1">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_63a9ce4d05972af105b0_path-13" />
                    <path stroke="#000000" stroke-width="4" d="M989.350676,218.155498 L998.76876,163.243855 L998.946504,162.207525 L998.193567,161.473592 L958.297922,122.58495 L1013.43235,114.573449 L1014.47288,114.422251 L1014.93822,113.479367 L1039.59509,63.5191029 L1064.25195,113.479367 L1064.71729,114.422251 L1065.75783,114.573449 L1120.89225,122.58495 L1080.99661,161.473592 L1080.24367,162.207525 L1080.42141,163.243855 L1089.8395,218.155498 L1040.52577,192.229737 L1039.59509,191.740449 L1038.6644,192.229737 L989.350676,218.155498 Z" />
                </g>
                <g id="svg_63a9ce4d05972af105b0_Path-1">
                    <use fill="#000000" fill-rule="evenodd" xlink:href="#svg_63a9ce4d05972af105b0_path-14" />
                    <path stroke="#000000" stroke-width="4" d="M853,122 L891,122 L893,122 L893,120 L893,104.785615 L928.171517,139.515525 L893,175.128649 L893,160 L893,158 L891,158 L853,158 L853,122 Z" />
                </g>
                <polygon id="svg_63a9ce4d05972af105b0_Path-1" fill="#F6A623" points="1181 120 1221 120 1221 100 1261 139.497767 1221 180 1221 160 1181 160"></polygon>
                <text id="svg_63a9ce4d05972af105b0_Option[A]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                    <tspan x="255.6" y="314">Option[A]</tspan>
                </text>
                <text id="svg_63a9ce4d05972af105b0_map" font-family="FiraMono-Bold, Fira Mono" font-size="64" font-weight="bold" fill="#F6A623">
                    <tspan x="498.4" y="156">map</tspan>
                </text>
                <text id="svg_63a9ce4d05972af105b0_Option[B]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                    <tspan x="1279.6" y="314">Option[B]</tspan>
                </text>
                <text id="svg_63a9ce4d05972af105b0_A-=&gt;-B" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                    <tspan x="825.4" y="314">A =&gt; B</tspan>
                </text>
            </g>
            <g id="svg_63a9ce4d05972af105b0_list-map">
                <rect id="svg_63a9ce4d05972af105b0_Background" fill="#FFFFFF" x="0" y="0" width="1761" height="360" />
                <g id="svg_63a9ce4d05972af105b0_Group-2-Copy" transform="translate(259.000000, 40.000000)">
                    <g id="svg_63a9ce4d05972af105b0_Oval-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_63a9ce4d05972af105b0_path-15" />
                        <circle stroke="#000000" stroke-width="4" cx="80" cy="80" r="78"></circle>
                    </g>
                    <g id="svg_63a9ce4d05972af105b0_Oval-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_63a9ce4d05972af105b0_path-16" />
                        <circle stroke="#000000" stroke-width="4" cx="100" cy="100" r="78"></circle>
                    </g>
                    <g id="svg_63a9ce4d05972af105b0_Oval-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_63a9ce4d05972af105b0_path-17" />
                        <circle stroke="#000000" stroke-width="4" cx="120" cy="120" r="78"></circle>
                    </g>
                </g>
                <g id="svg_63a9ce4d05972af105b0_Oval-1-Copy">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_63a9ce4d05972af105b0_path-18" />
                    <circle stroke="#000000" stroke-width="4" cx="727" cy="143" r="78"></circle>
                </g>
                <g id="svg_63a9ce4d05972af105b0_Star-1-Copy">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_63a9ce4d05972af105b0_path-19" />
                    <path stroke="#000000" stroke-width="4" d="M987.350676,221.155498 L996.76876,166.243855 L996.946504,165.207525 L996.193567,164.473592 L956.297922,125.58495 L1011.43235,117.573449 L1012.47288,117.422251 L1012.93822,116.479367 L1037.59509,66.5191029 L1062.25195,116.479367 L1062.71729,117.422251 L1063.75783,117.573449 L1118.89225,125.58495 L1078.99661,164.473592 L1078.24367,165.207525 L1078.42141,166.243855 L1087.8395,221.155498 L1038.52577,195.229737 L1037.59509,194.740449 L1036.6644,195.229737 L987.350676,221.155498 Z" />
                </g>
                <g id="svg_63a9ce4d05972af105b0_Group-Copy" transform="translate(1299.000000, 40.000000)">
                    <g id="svg_63a9ce4d05972af105b0_Star-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_63a9ce4d05972af105b0_path-20" />
                        <path stroke="#000000" stroke-width="4" d="M35.3506758,159.155498 L44.7687599,104.243855 L44.9465044,103.207525 L44.1935666,102.473592 L4.29792228,63.5849501 L59.4323467,55.5734493 L60.4728811,55.4222508 L60.9382223,54.4793667 L85.5950865,4.51910292 L110.251951,54.4793667 L110.717292,55.4222508 L111.757826,55.5734493 L166.892251,63.5849501 L126.996606,102.473592 L126.243669,103.207525 L126.421413,104.243855 L135.839497,159.155498 L86.5257687,133.229737 L85.5950865,132.740449 L84.6644042,133.229737 L35.3506758,159.155498 Z" />
                    </g>
                    <g id="svg_63a9ce4d05972af105b0_Star-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_63a9ce4d05972af105b0_path-21" />
                        <path stroke="#000000" stroke-width="4" d="M51.3506758,179.155498 L60.7687599,124.243855 L60.9465044,123.207525 L60.1935666,122.473592 L20.2979223,83.5849501 L75.4323467,75.5734493 L76.4728811,75.4222508 L76.9382223,74.4793667 L101.595086,24.5191029 L126.251951,74.4793667 L126.717292,75.4222508 L127.757826,75.5734493 L182.892251,83.5849501 L142.996606,122.473592 L142.243669,123.207525 L142.421413,124.243855 L151.839497,179.155498 L102.525769,153.229737 L101.595086,152.740449 L100.664404,153.229737 L51.3506758,179.155498 Z" />
                    </g>
                    <g id="svg_63a9ce4d05972af105b0_Star-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_63a9ce4d05972af105b0_path-22" />
                        <path stroke="#000000" stroke-width="4" d="M69.3506758,202.155498 L78.7687599,147.243855 L78.9465044,146.207525 L78.1935666,145.473592 L38.2979223,106.58495 L93.4323467,98.5734493 L94.4728811,98.4222508 L94.9382223,97.4793667 L119.595086,47.5191029 L144.251951,97.4793667 L144.717292,98.4222508 L145.757826,98.5734493 L200.892251,106.58495 L160.996606,145.473592 L160.243669,146.207525 L160.421413,147.243855 L169.839497,202.155498 L120.525769,176.229737 L119.595086,175.740449 L118.664404,176.229737 L69.3506758,202.155498 Z" />
                    </g>
                </g>
                <g id="svg_63a9ce4d05972af105b0_Path-1-Copy">
                    <use fill="#000000" fill-rule="evenodd" xlink:href="#svg_63a9ce4d05972af105b0_path-23" />
                    <path stroke="#000000" stroke-width="4" d="M851,125 L889,125 L891,125 L891,123 L891,107.785615 L926.171517,142.515525 L891,178.128649 L891,163 L891,161 L889,161 L851,161 L851,125 Z" />
                </g>
                <polygon id="svg_63a9ce4d05972af105b0_Path-1-Copy-2" fill="#F6A623" points="1179 123 1219 123 1219 103 1259 142.497767 1219 183 1219 163 1179 163"></polygon>
                <text id="svg_63a9ce4d05972af105b0_List[A]-Copy" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                    <tspan x="270.8" y="317">List[A]</tspan>
                </text>
                <text id="svg_63a9ce4d05972af105b0_map-copy" font-family="FiraMono-Bold, Fira Mono" font-size="64" font-weight="bold" fill="#F6A623">
                    <tspan x="496.4" y="159">map</tspan>
                </text>
                <text id="svg_63a9ce4d05972af105b0_List[B]-Copy" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                    <tspan x="1314.8" y="317">List[B]</tspan>
                </text>
                <text id="svg_63a9ce4d05972af105b0_A-=&gt;-B-Copy" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                    <tspan x="823.4" y="317">A =&gt; B</tspan>
                </text>
            </g>
        </g>
    </g>
</svg>
    <figcaption>Figure 1: Type chart: mapping over List, Option, and
    Either</figcaption>
    </figure>
    <p>Because <code>map</code> leaves the structure of the context
    unchanged, we can call it repeatedly to sequence multiple
    computations on the contents of an initial data structure:</p>
    <div class="sourceCode" id="cb392"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb392-1"><a href="#cb392-1" aria-hidden="true" tabindex="-1"></a><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">).</span></span>
<span id="cb392-2"><a href="#cb392-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span><span class="op">(</span>n <span class="op">=&gt;</span> n <span class="op">+</span> <span class="dv">1</span><span class="op">).</span></span>
<span id="cb392-3"><a href="#cb392-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span><span class="op">(</span>n <span class="op">=&gt;</span> n <span class="op">*</span> <span class="dv">2</span><span class="op">).</span></span>
<span id="cb392-4"><a href="#cb392-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span><span class="op">(</span>n <span class="op">=&gt;</span> <span class="ss">s&quot;${</span>n<span class="ss">}</span><span class="st">!</span><span class="ss">&quot;</span><span class="op">)</span></span>
<span id="cb392-5"><a href="#cb392-5" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: List[String] = List(&quot;4!&quot;, &quot;6!&quot;, &quot;8!&quot;)</span></span></code></pre></div>
    <p>We should think of <code>map</code> not as an iteration pattern,
    but as a way of sequencing computations on values ignoring some
    complication dictated by the relevant data type:</p>
    <ul>
    <li><code>Option</code>—the value may or may not be present;</li>
    <li><code>Either</code>—there may be a value or an error;</li>
    <li><code>List</code>—there may be zero or more values.</li>
    </ul>
    <h2 data-number="8.2" id="sec:functors:more-examples"><span class="header-section-number">8.2</span> More Examples of
    Functors</h2>
    <p>The <code>map</code> methods of <code>List</code>,
    <code>Option</code>, and <code>Either</code> apply functions
    eagerly. However, the idea of sequencing computations is more
    general than this. Let’s investigate the behaviour of some other
    functors that apply the pattern in different ways.</p>
    <p><strong>Futures</strong></p>
    <p><code>Future</code> is a functor that sequences asynchronous
    computations by queueing them and applying them as their
    predecessors complete. The type signature of its <code>map</code>
    method, shown in Figure 2, has the same shape as the signatures
    above. However, the behaviour is very different.</p>
    <figure id="fig:functors:future-type-chart">
    <svg id="svg_15e79209238164f042ed" alt="Type chart: mapping over a Future" width="1565px" height="360px" viewBox="0 0 1565 360">
    <!-- Generator: Sketch 40 (33762) - http://www.bohemiancoding.com/sketch -->
    <title>future-map</title>
    <desc>Created with Sketch.</desc>
    <defs>
        <ellipse id="svg_15e79209238164f042ed_path-1" cx="80" cy="80" rx="80" ry="80"></ellipse>
        <mask id="svg_15e79209238164f042ed_mask-2" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="160" height="160" fill="white">
            <use xlink:href="#svg_15e79209238164f042ed_path-1" />
        </mask>
        <ellipse id="svg_15e79209238164f042ed_path-3" cx="638" cy="143" rx="80" ry="80"></ellipse>
        <mask id="svg_15e79209238164f042ed_mask-4" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="160" height="160" fill="white">
            <use xlink:href="#svg_15e79209238164f042ed_path-3" />
        </mask>
        <polygon id="svg_15e79209238164f042ed_path-5" points="942.595086 197 889.694414 224.811529 899.797543 165.905765 857 124.188471 916.14475 115.594235 942.595086 62 969.045423 115.594235 1028.19017 124.188471 985.39263 165.905765 995.495759 224.811529"></polygon>
        <mask id="svg_15e79209238164f042ed_mask-6" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="171.190173" height="162.811529" fill="white">
            <use xlink:href="#svg_15e79209238164f042ed_path-5" />
        </mask>
        <polygon id="svg_15e79209238164f042ed_path-7" points="85.5950865 135 32.6944138 162.811529 42.7975432 103.905765 5.32907052e-14 62.1884705 59.1447501 53.5942353 85.5950865 0 112.045423 53.5942353 171.190173 62.1884705 128.39263 103.905765 138.495759 162.811529"></polygon>
        <mask id="svg_15e79209238164f042ed_mask-8" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="171.190173" height="162.811529" fill="white">
            <use xlink:href="#svg_15e79209238164f042ed_path-7" />
        </mask>
        <polygon id="svg_15e79209238164f042ed_path-9" points="756 123 796 123 796 103 836 142.497767 796 183 796 163 756 163"></polygon>
        <mask id="svg_15e79209238164f042ed_mask-10" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="80" height="80" fill="white">
            <use xlink:href="#svg_15e79209238164f042ed_path-9" />
        </mask>
    </defs>
    <g id="svg_15e79209238164f042ed_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_15e79209238164f042ed_future-map">
            <rect id="svg_15e79209238164f042ed_Background" fill="#FFFFFF" x="0" y="0" width="1565" height="360" />
            <g id="svg_15e79209238164f042ed_Group-2" transform="translate(186.000000, 60.000000)" stroke="#000000" stroke-width="8" fill="#FFFFFF">
                <use id="svg_15e79209238164f042ed_Oval-1" mask="url(#mask-2)" xlink:href="#svg_15e79209238164f042ed_path-1" />
            </g>
            <use id="svg_15e79209238164f042ed_Oval-1" stroke="#000000" mask="url(#mask-4)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_15e79209238164f042ed_path-3" />
            <use id="svg_15e79209238164f042ed_Star-1" stroke="#000000" mask="url(#mask-6)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_15e79209238164f042ed_path-5" />
            <g id="svg_15e79209238164f042ed_Group" transform="translate(1222.000000, 60.000000)" stroke="#000000" stroke-width="8" fill="#FFFFFF">
                <use id="svg_15e79209238164f042ed_Star-1" mask="url(#mask-8)" xlink:href="#svg_15e79209238164f042ed_path-7" />
            </g>
            <use id="svg_15e79209238164f042ed_Path-1" stroke="#000000" mask="url(#mask-10)" stroke-width="8" fill="#000000" xlink:href="#svg_15e79209238164f042ed_path-9" />
            <polygon id="svg_15e79209238164f042ed_Path-1" fill="#F6A623" points="1060 123 1100 123 1100 103 1140 142.497767 1100 183 1100 163 1060 163"></polygon>
            <text id="svg_15e79209238164f042ed_Future[A]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="152.6" y="317">Future[A]</tspan>
            </text>
            <text id="svg_15e79209238164f042ed_Future[B]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="1196.6" y="317">Future[B]</tspan>
            </text>
            <text id="svg_15e79209238164f042ed_A-=&gt;-B" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="730.4" y="317">A =&gt; B</tspan>
            </text>
            <path d="M363.315361,210.467721 C385.006169,199.992471 396,183.961214 396,161.8 C396,135.750232 380.809583,118.170359 350.910889,108.12819 C354.907288,101.078104 357.132924,93.2472515 357.132924,85 C357.132924,54.072054 325.8334,29 287.223482,29 C268.174233,29 250.904488,35.1030628 238.295299,45.00136 C233.887872,43.9548756 229.281771,43.4 224.542169,43.4 C192.682658,43.4 166.855422,68.472054 166.855422,99.4 C166.855422,103.9092 167.404425,108.293923 168.441083,112.494615 C143.680009,122.952373 130,139.184167 130,161.8 C130,197.248626 163.609345,217.012808 220.819802,223.441594 C233.787678,241.035696 259.294061,253 288.638554,253 C324.740936,253 355.033857,234.890521 363.31536,210.467725 Z" id="svg_15e79209238164f042ed_Combined-Shape" stroke="#000000" stroke-width="4" />
            <path d="M1409.31536,219.467721 C1431.00617,208.992471 1442,192.961214 1442,170.8 C1442,144.750232 1426.80958,127.170359 1396.91089,117.12819 C1400.90729,110.078104 1403.13292,102.247251 1403.13292,94 C1403.13292,63.072054 1371.8334,38 1333.22348,38 C1314.17423,38 1296.90449,44.1030628 1284.2953,54.00136 C1279.88787,52.9548756 1275.28177,52.4 1270.54217,52.4 C1238.68266,52.4 1212.85542,77.472054 1212.85542,108.4 C1212.85542,112.9092 1213.40442,117.293923 1214.44108,121.494615 C1189.68001,131.952373 1176,148.184167 1176,170.8 C1176,206.248626 1209.60934,226.012808 1266.8198,232.441594 C1279.78768,250.035696 1305.29406,262 1334.63855,262 C1370.74094,262 1401.03386,243.890521 1409.31536,219.467725 Z" id="svg_15e79209238164f042ed_Combined-Shape" stroke="#000000" stroke-width="4" />
            <text id="svg_15e79209238164f042ed_map" font-family="FiraMono-Bold, Fira Mono" font-size="64" font-weight="bold" fill="#F6A623">
                <tspan x="422.4" y="158">map</tspan>
            </text>
        </g>
    </g>
</svg>
    <figcaption>Figure 2: Type chart: mapping over a Future</figcaption>
    </figure>
    <p>When we work with a <code>Future</code> we have no guarantees
    about its internal state. The wrapped computation may be ongoing,
    complete, or rejected. If the <code>Future</code> is complete, our
    mapping function can be called immediately. If not, some underlying
    thread pool queues the function call and comes back to it later. We
    don’t know <em>when</em> our functions will be called, but we do
    know <em>what order</em> they will be called in. In this way,
    <code>Future</code> provides the same sequencing behaviour seen in
    <code>List</code>, <code>Option</code>, and <code>Either</code>:</p>
    <div class="sourceCode" id="cb393"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb393-1"><a href="#cb393-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.{</span><span class="ex">Future</span><span class="op">,</span> Await<span class="op">}</span></span>
<span id="cb393-2"><a href="#cb393-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span>ExecutionContext<span class="op">.</span>Implicits<span class="op">.</span>global</span>
<span id="cb393-3"><a href="#cb393-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span>duration<span class="op">.</span>_</span>
<span id="cb393-4"><a href="#cb393-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb393-5"><a href="#cb393-5" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> future<span class="op">:</span> <span class="ex">Future</span><span class="op">[</span><span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb393-6"><a href="#cb393-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Future</span><span class="op">(</span><span class="dv">123</span><span class="op">).</span></span>
<span id="cb393-7"><a href="#cb393-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span><span class="op">(</span>n <span class="op">=&gt;</span> n <span class="op">+</span> <span class="dv">1</span><span class="op">).</span></span>
<span id="cb393-8"><a href="#cb393-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span><span class="op">(</span>n <span class="op">=&gt;</span> n <span class="op">*</span> <span class="dv">2</span><span class="op">).</span></span>
<span id="cb393-9"><a href="#cb393-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span><span class="op">(</span>n <span class="op">=&gt;</span> <span class="ss">s&quot;${</span>n<span class="ss">}</span><span class="st">!</span><span class="ss">&quot;</span><span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb394"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb394-1"><a href="#cb394-1" aria-hidden="true" tabindex="-1"></a>Await<span class="op">.</span><span class="fu">result</span><span class="op">(</span>future<span class="op">,</span> <span class="fl">1.</span>second<span class="op">)</span></span>
<span id="cb394-2"><a href="#cb394-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: String = &quot;248!&quot;</span></span></code></pre></div>
    <div class="callout callout-info">
    <p><em>Futures and Referential Transparency</em></p>
    <p>Note that Scala’s <code>Futures</code> aren’t a great example of
    pure functional programming because they aren’t <em>referentially
    transparent</em>. <code>Future</code> always computes and caches a
    result and there’s no way for us to tweak this behaviour. This means
    we can get unpredictable results when we use <code>Future</code> to
    wrap side-effecting computations. For example:</p>
    <div class="sourceCode" id="cb395"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb395-1"><a href="#cb395-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>util<span class="op">.</span><span class="ex">Random</span></span>
<span id="cb395-2"><a href="#cb395-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-3"><a href="#cb395-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> future1 <span class="op">=</span> <span class="op">{</span></span>
<span id="cb395-4"><a href="#cb395-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Initialize Random with a fixed seed:</span></span>
<span id="cb395-5"><a href="#cb395-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> r <span class="op">=</span> <span class="kw">new</span> <span class="ex">Random</span><span class="op">(</span><span class="dv">0L</span><span class="op">)</span></span>
<span id="cb395-6"><a href="#cb395-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-7"><a href="#cb395-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// nextInt has the side-effect of moving to</span></span>
<span id="cb395-8"><a href="#cb395-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// the next random number in the sequence:</span></span>
<span id="cb395-9"><a href="#cb395-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> x <span class="op">=</span> <span class="ex">Future</span><span class="op">(</span>r<span class="op">.</span><span class="fu">nextInt</span><span class="op">())</span></span>
<span id="cb395-10"><a href="#cb395-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-11"><a href="#cb395-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb395-12"><a href="#cb395-12" aria-hidden="true" tabindex="-1"></a>    a <span class="op">&lt;-</span> x</span>
<span id="cb395-13"><a href="#cb395-13" aria-hidden="true" tabindex="-1"></a>    b <span class="op">&lt;-</span> x</span>
<span id="cb395-14"><a href="#cb395-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">yield</span> <span class="op">(</span>a<span class="op">,</span> b<span class="op">)</span></span>
<span id="cb395-15"><a href="#cb395-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb395-16"><a href="#cb395-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-17"><a href="#cb395-17" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> future2 <span class="op">=</span> <span class="op">{</span></span>
<span id="cb395-18"><a href="#cb395-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> r <span class="op">=</span> <span class="kw">new</span> <span class="ex">Random</span><span class="op">(</span><span class="dv">0L</span><span class="op">)</span></span>
<span id="cb395-19"><a href="#cb395-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-20"><a href="#cb395-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb395-21"><a href="#cb395-21" aria-hidden="true" tabindex="-1"></a>    a <span class="op">&lt;-</span> <span class="ex">Future</span><span class="op">(</span>r<span class="op">.</span><span class="fu">nextInt</span><span class="op">())</span></span>
<span id="cb395-22"><a href="#cb395-22" aria-hidden="true" tabindex="-1"></a>    b <span class="op">&lt;-</span> <span class="ex">Future</span><span class="op">(</span>r<span class="op">.</span><span class="fu">nextInt</span><span class="op">())</span></span>
<span id="cb395-23"><a href="#cb395-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">yield</span> <span class="op">(</span>a<span class="op">,</span> b<span class="op">)</span></span>
<span id="cb395-24"><a href="#cb395-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <div class="sourceCode" id="cb396"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb396-1"><a href="#cb396-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> result1 <span class="op">=</span> Await<span class="op">.</span><span class="fu">result</span><span class="op">(</span>future1<span class="op">,</span> <span class="fl">1.</span>second<span class="op">)</span></span>
<span id="cb396-2"><a href="#cb396-2" aria-hidden="true" tabindex="-1"></a><span class="co">// result1: Tuple2[Int, Int] = (-1155484576, -1155484576)</span></span>
<span id="cb396-3"><a href="#cb396-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> result2 <span class="op">=</span> Await<span class="op">.</span><span class="fu">result</span><span class="op">(</span>future2<span class="op">,</span> <span class="fl">1.</span>second<span class="op">)</span></span>
<span id="cb396-4"><a href="#cb396-4" aria-hidden="true" tabindex="-1"></a><span class="co">// result2: Tuple2[Int, Int] = (-1155484576, -723955400)</span></span></code></pre></div>
    <p>Ideally we would like <code>result1</code> and
    <code>result2</code> to contain the same value. However, the
    computation for <code>future1</code> calls <code>nextInt</code> once
    and the computation for <code>future2</code> calls it twice. Because
    <code>nextInt</code> returns a different result every time we get a
    different result in each case.</p>
    <p>This kind of discrepancy makes it hard to reason about programs
    involving <code>Futures</code> and side-effects. There also are
    other problematic aspects of <code>Future&#39;s</code> behaviour, such
    as the way it always starts computations immediately rather than
    allowing the user to dictate when the program should run. For more
    information see <a href="https://www.reddit.com/r/scala/comments/3zofjl/why_is_future_totally_unusable/">this
    excellent Reddit answer</a> by Rob Norris.</p>
    <p>When we look at Cats Effect we’ll see that the <code>IO</code>
    type solves these problems.</p>
    </div>
    <p>If <code>Future</code> isn’t referentially transparent, perhaps
    we should look at another similar data-type that is. You should
    recognise this one…</p>
    <p><strong>Functions (?!)</strong></p>
    <p>It turns out that single argument functions are also functors. To
    see this we have to tweak the types a little. A function
    <code>A =&gt; B</code> has two type parameters: the parameter type
    <code>A</code> and the result type <code>B</code>. To coerce them to
    the correct shape we can fix the parameter type and let the result
    type vary:</p>
    <ul>
    <li>start with <code>X =&gt; A</code>;</li>
    <li>supply a function <code>A =&gt; B</code>;</li>
    <li>get back <code>X =&gt; B</code>.</li>
    </ul>
    <p>If we alias <code>X =&gt; A</code> as <code>MyFunc[A]</code>, we
    see the same pattern of types we saw with the other examples in this
    chapter. We also see this in Figure 3:</p>
    <ul>
    <li>start with <code>MyFunc[A]</code>;</li>
    <li>supply a function <code>A =&gt; B</code>;</li>
    <li>get back <code>MyFunc[B]</code>.</li>
    </ul>
    <figure id="fig:functors:function-type-chart">
    <svg id="svg_089c5d602c772c16c918" alt="Type chart: mapping over a Function1" width="1558px" height="325px" viewBox="0 0 1558 325">
    <!-- Generator: Sketch 40 (33762) - http://www.bohemiancoding.com/sketch -->
    <title>function-map</title>
    <desc>Created with Sketch.</desc>
    <defs>
        <ellipse id="svg_089c5d602c772c16c918_path-1" cx="248.403653" cy="56.5337423" rx="51.403653" ry="51.5337423"></ellipse>
        <mask id="svg_089c5d602c772c16c918_mask-2" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="102.807306" height="103.067485" fill="white">
            <use xlink:href="#svg_089c5d602c772c16c918_path-1" />
        </mask>
        <polygon id="svg_089c5d602c772c16c918_path-3" points="124.372306 41.2944785 150.074132 41.2944785 150.074132 28.4110429 175.775959 53.8543899 150.074132 79.9447853 150.074132 67.0613497 124.372306 67.0613497"></polygon>
        <mask id="svg_089c5d602c772c16c918_mask-4" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="51.403653" height="51.5337423" fill="white">
            <use xlink:href="#svg_089c5d602c772c16c918_path-3" />
        </mask>
        <ellipse id="svg_089c5d602c772c16c918_path-5" cx="51.403653" cy="52.1779141" rx="51.403653" ry="51.5337423"></ellipse>
        <mask id="svg_089c5d602c772c16c918_mask-6" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="102.807306" height="103.067485" fill="white">
            <use xlink:href="#svg_089c5d602c772c16c918_path-5" />
        </mask>
        <polygon id="svg_089c5d602c772c16c918_path-7" points="245.480898 86.9631902 211.4898 104.878593 217.981522 66.9331613 190.482146 40.0600577 228.485349 34.5238939 245.480898 0 262.476447 34.5238939 300.479649 40.0600577 272.980273 66.9331613 279.471995 104.878593"></polygon>
        <mask id="svg_089c5d602c772c16c918_mask-8" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="109.997503" height="104.878593" fill="white">
            <use xlink:href="#svg_089c5d602c772c16c918_path-7" />
        </mask>
        <polygon id="svg_089c5d602c772c16c918_path-9" points="122.372306 39.2944785 148.074132 39.2944785 148.074132 26.4110429 173.775959 51.8543899 148.074132 77.9447853 148.074132 65.0613497 122.372306 65.0613497"></polygon>
        <mask id="svg_089c5d602c772c16c918_mask-10" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="51.403653" height="51.5337423" fill="white">
            <use xlink:href="#svg_089c5d602c772c16c918_path-9" />
        </mask>
        <polygon id="svg_089c5d602c772c16c918_path-11" points="254.480898 87.9631902 220.4898 105.878593 226.981522 67.9331613 199.482146 41.0600577 237.485349 35.5238939 254.480898 1 271.476447 35.5238939 309.479649 41.0600577 281.980273 67.9331613 288.471995 105.878593"></polygon>
        <mask id="svg_089c5d602c772c16c918_mask-12" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="109.997503" height="104.878593" fill="white">
            <use xlink:href="#svg_089c5d602c772c16c918_path-11" />
        </mask>
        <polygon id="svg_089c5d602c772c16c918_path-13" points="131.372306 40.2944785 157.074132 40.2944785 157.074132 27.4110429 182.775959 52.8543899 157.074132 78.9447853 157.074132 66.0613497 131.372306 66.0613497"></polygon>
        <mask id="svg_089c5d602c772c16c918_mask-14" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="51.403653" height="51.5337423" fill="white">
            <use xlink:href="#svg_089c5d602c772c16c918_path-13" />
        </mask>
    </defs>
    <g id="svg_089c5d602c772c16c918_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_089c5d602c772c16c918_function-map">
            <rect id="svg_089c5d602c772c16c918_Background" fill="#FFFFFF" x="0" y="0" width="1558" height="325" />
            <g id="svg_089c5d602c772c16c918_Group-5" transform="translate(156.000000, 51.000000)" stroke="#000000">
                <use id="svg_089c5d602c772c16c918_Oval-1" mask="url(#mask-2)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_089c5d602c772c16c918_path-1" />
                <use id="svg_089c5d602c772c16c918_Path-1" mask="url(#mask-4)" stroke-width="8" fill="#000000" xlink:href="#svg_089c5d602c772c16c918_path-3" />
                <polygon id="svg_089c5d602c772c16c918_Polygon" stroke-width="4" points="53 0.0658617424 105.339263 38.0925622 85.3474435 99.621056 20.6525565 99.621056 0.66073703 38.0925622"></polygon>
            </g>
            <g id="svg_089c5d602c772c16c918_Group-5" transform="translate(647.000000, 53.000000)" stroke="#000000" stroke-width="8">
                <use id="svg_089c5d602c772c16c918_Oval-1" mask="url(#mask-6)" fill="#FFFFFF" xlink:href="#svg_089c5d602c772c16c918_path-5" />
                <use id="svg_089c5d602c772c16c918_Star-1" mask="url(#mask-8)" fill="#FFFFFF" xlink:href="#svg_089c5d602c772c16c918_path-7" />
                <use id="svg_089c5d602c772c16c918_Path-1" mask="url(#mask-10)" fill="#000000" xlink:href="#svg_089c5d602c772c16c918_path-9" />
            </g>
            <g id="svg_089c5d602c772c16c918_Group-6" transform="translate(1088.000000, 52.000000)" stroke="#000000">
                <use id="svg_089c5d602c772c16c918_Star-1" mask="url(#mask-12)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_089c5d602c772c16c918_path-11" />
                <use id="svg_089c5d602c772c16c918_Path-1" mask="url(#mask-14)" stroke-width="8" fill="#000000" xlink:href="#svg_089c5d602c772c16c918_path-13" />
                <polygon id="svg_089c5d602c772c16c918_Polygon" stroke-width="4" points="52.6785259 0.853169549 105.357052 39.126359 85.2356454 101.05368 20.1214064 101.05368 -6.39488462e-14 39.126359"></polygon>
            </g>
            <polygon id="svg_089c5d602c772c16c918_Path-1" fill="#F6A623" points="984 85 1024 85 1024 65 1064 104.497767 1024 145 1024 125 984 125"></polygon>
            <text id="svg_089c5d602c772c16c918_X-=&gt;-A" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="225.4" y="282">X =&gt; A</tspan>
            </text>
            <text id="svg_089c5d602c772c16c918_X-=&gt;-B" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="1173.4" y="282">X =&gt; B</tspan>
            </text>
            <text id="svg_089c5d602c772c16c918_A-=&gt;-B" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="720.4" y="282">A =&gt; B</tspan>
            </text>
            <text id="svg_089c5d602c772c16c918_map" font-family="FiraMono-Bold, Fira Mono" font-size="64" font-weight="bold" fill="#F6A623">
                <tspan x="495.4" y="123">map</tspan>
            </text>
        </g>
    </g>
</svg>
    <figcaption>Figure 3: Type chart: mapping over a
    Function1</figcaption>
    </figure>
    <p>In other words, “mapping” over a <code>Function1</code> is
    function composition:</p>
    <div class="sourceCode" id="cb397"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb397-1"><a href="#cb397-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>all<span class="op">.*</span>     <span class="co">// for map</span></span>
<span id="cb397-2"><a href="#cb397-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-3"><a href="#cb397-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> func1<span class="op">:</span> <span class="bu">Int</span> <span class="op">=&gt;</span> <span class="ex">Double</span> <span class="op">=</span></span>
<span id="cb397-4"><a href="#cb397-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">(</span>x<span class="op">:</span> <span class="bu">Int</span><span class="op">)</span> <span class="op">=&gt;</span> x<span class="op">.</span>toDouble</span>
<span id="cb397-5"><a href="#cb397-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-6"><a href="#cb397-6" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> func2<span class="op">:</span> <span class="ex">Double</span> <span class="op">=&gt;</span> <span class="ex">Double</span> <span class="op">=</span></span>
<span id="cb397-7"><a href="#cb397-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">(</span>y<span class="op">:</span> <span class="ex">Double</span><span class="op">)</span> <span class="op">=&gt;</span> y <span class="op">*</span> <span class="dv">2</span></span></code></pre></div>
    <div class="sourceCode" id="cb398"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb398-1"><a href="#cb398-1" aria-hidden="true" tabindex="-1"></a><span class="op">(</span>func1<span class="op">.</span><span class="fu">map</span><span class="op">(</span>func2<span class="op">))(</span><span class="dv">1</span><span class="op">)</span>     <span class="co">// composition using map</span></span>
<span id="cb398-2"><a href="#cb398-2" aria-hidden="true" tabindex="-1"></a><span class="op">(</span>func1<span class="op">.</span><span class="fu">andThen</span><span class="op">(</span>func2<span class="op">))(</span><span class="dv">1</span><span class="op">)</span> <span class="co">// composition using andThen</span></span>
<span id="cb398-3"><a href="#cb398-3" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: Double = 2.0</span></span>
<span id="cb398-4"><a href="#cb398-4" aria-hidden="true" tabindex="-1"></a><span class="fu">func2</span><span class="op">(</span><span class="fu">func1</span><span class="op">(</span><span class="dv">1</span><span class="op">))</span>           <span class="co">// composition written out by hand</span></span>
<span id="cb398-5"><a href="#cb398-5" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: Double = 2.0</span></span></code></pre></div>
    <p>How does this relate to our general pattern of sequencing
    operations? If we think about it, function composition <em>is</em>
    sequencing. We start with a function that performs a single
    operation and every time we use <code>map</code> we append another
    operation to the chain. Calling <code>map</code> doesn’t actually
    <em>run</em> any of the operations, but if we can pass an argument
    to the final function all of the operations are run in sequence. We
    can think of this as lazily queueing up operations similar to
    <code>Future</code>:</p>
    <div class="sourceCode" id="cb399"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb399-1"><a href="#cb399-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> func <span class="op">=</span></span>
<span id="cb399-2"><a href="#cb399-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">((</span>x<span class="op">:</span> <span class="bu">Int</span><span class="op">)</span> <span class="op">=&gt;</span> x<span class="op">.</span>toDouble<span class="op">).</span></span>
<span id="cb399-3"><a href="#cb399-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span><span class="op">(</span>x <span class="op">=&gt;</span> x <span class="op">+</span> <span class="dv">1</span><span class="op">).</span></span>
<span id="cb399-4"><a href="#cb399-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span><span class="op">(</span>x <span class="op">=&gt;</span> x <span class="op">*</span> <span class="dv">2</span><span class="op">).</span></span>
<span id="cb399-5"><a href="#cb399-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span><span class="op">(</span>x <span class="op">=&gt;</span> <span class="ss">s&quot;${</span>x<span class="ss">}</span><span class="st">!</span><span class="ss">&quot;</span><span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb400"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb400-1"><a href="#cb400-1" aria-hidden="true" tabindex="-1"></a><span class="fu">func</span><span class="op">(</span><span class="dv">123</span><span class="op">)</span></span>
<span id="cb400-2"><a href="#cb400-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: String = &quot;248.0!&quot;</span></span></code></pre></div>
    <div class="callout callout-warning">
    <p><em>Partial Unification</em></p>
    <p>For the above examples to work, in versions of Scala before 2.13,
    we need to add the following compiler option to
    <code>build.sbt</code>:</p>
    <div class="sourceCode" id="cb401"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb401-1"><a href="#cb401-1" aria-hidden="true" tabindex="-1"></a>scalacOptions <span class="op">+=</span> <span class="st">&quot;-Ypartial-unification&quot;</span></span></code></pre></div>
    <p>otherwise we’ll get a compiler error:</p>
    <div class="sourceCode" id="cb402"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb402-1"><a href="#cb402-1" aria-hidden="true" tabindex="-1"></a>func1<span class="op">.</span><span class="fu">map</span><span class="op">(</span>func2<span class="op">)</span></span>
<span id="cb402-2"><a href="#cb402-2" aria-hidden="true" tabindex="-1"></a><span class="co">// &lt;console&gt;: error: value map is not a member of Int =&gt; Double</span></span>
<span id="cb402-3"><a href="#cb402-3" aria-hidden="true" tabindex="-1"></a><span class="co">//        func1.map(func2)</span></span>
<span id="cb402-4"><a href="#cb402-4" aria-hidden="true" tabindex="-1"></a>                <span class="op">^</span></span></code></pre></div>
    <p>We’ll look at why this happens in detail in Section 8.8.</p>
    </div>
    <h2 data-number="8.3" id="definition-of-a-functor"><span class="header-section-number">8.3</span> Definition of a
    Functor</h2>
    <p>Every example we’ve looked at so far is a functor: a class that
    encapsulates sequencing computations. Formally, a functor is a type
    <code>F[A]</code> with an operation <code>map</code> with type
    <code>(A =&gt; B) =&gt; F[B]</code>. The general type chart is shown
    in Figure 4.</p>
    <figure id="fig:functors:functor-type-chart">
    <svg alt="Type chart: generalised functor map" viewBox="0 0 1567 360"><use href="#svg_01158ee086aeec73f7ad" width="100%" height="100%" /></svg>
    <figcaption>Figure 4: Type chart: generalised functor
    map</figcaption>
    </figure>
    <p>Cats encodes <code>Functor</code> as a type class, <a href="http://typelevel.org/cats/api/cats/Functor.html"><code>cats.Functor</code></a>,
    so the method looks a little different. It accepts the initial
    <code>F[A]</code> as a parameter alongside the transformation
    function. Here’s a simplified version of the definition:</p>
    <div class="sourceCode" id="cb403"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb403-1"><a href="#cb403-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> cats</span>
<span id="cb403-2"><a href="#cb403-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb403-3"><a href="#cb403-3" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Functor<span class="op">[</span>F<span class="op">[</span>_<span class="op">]]</span> <span class="op">{</span></span>
<span id="cb403-4"><a href="#cb403-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>fa<span class="op">:</span> F<span class="op">[</span>A<span class="op">])(</span>f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> F<span class="op">[</span>B<span class="op">]</span></span>
<span id="cb403-5"><a href="#cb403-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>If you haven’t seen syntax like <code>F[_]</code> before, it’s
    time to take a brief detour to discuss <em>type constructors</em>
    and <em>higher kinded types</em>.</p>
    <div class="callout callout-warning">
    <p><em>Functor Laws</em></p>
    <p>Functors guarantee the same semantics whether we sequence many
    small operations one by one, or combine them into a larger function
    before <code>mapping</code>. To ensure this is the case the
    following laws must hold:</p>
    <p><em>Identity</em>: calling <code>map</code> with the identity
    function is the same as doing nothing:</p>
    <div class="sourceCode" id="cb404"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb404-1"><a href="#cb404-1" aria-hidden="true" tabindex="-1"></a>fa<span class="op">.</span><span class="fu">map</span><span class="op">(</span>a <span class="op">=&gt;</span> a<span class="op">)</span> <span class="op">==</span> fa</span></code></pre></div>
    <p><em>Composition</em>: <code>mapping</code> with two functions
    <code>f</code> and <code>g</code> is the same as
    <code>mapping</code> with <code>f</code> and then
    <code>mapping</code> with <code>g</code>:</p>
    <div class="sourceCode" id="cb405"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb405-1"><a href="#cb405-1" aria-hidden="true" tabindex="-1"></a>fa<span class="op">.</span><span class="fu">map</span><span class="op">(</span><span class="fu">g</span><span class="op">(</span><span class="fu">f</span><span class="op">(</span>_<span class="op">)))</span> <span class="op">==</span> fa<span class="op">.</span><span class="fu">map</span><span class="op">(</span>f<span class="op">).</span><span class="fu">map</span><span class="op">(</span>g<span class="op">)</span></span></code></pre></div>
    </div>
    <h2 data-number="8.4" id="aside-higher-kinds-and-type-constructors"><span class="header-section-number">8.4</span> Aside: Higher Kinds and
    Type Constructors</h2>
    <p>Kinds are like types for types. They describe the number of
    “holes” in a type. We distinguish between regular types that have no
    holes and “type constructors” that have holes we can fill to produce
    types.</p>
    <p>For example, <code>List</code> is a type constructor with one
    hole. We fill that hole by specifying a parameter to produce a
    regular type like <code>List[Int]</code> or <code>List[A]</code>.
    The trick is not to confuse type constructors with generic types.
    <code>List</code> is a type constructor, <code>List[A]</code> is a
    type:</p>
    <div class="sourceCode" id="cb406"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb406-1"><a href="#cb406-1" aria-hidden="true" tabindex="-1"></a><span class="ex">List</span>    <span class="co">// type constructor, takes one parameter</span></span>
<span id="cb406-2"><a href="#cb406-2" aria-hidden="true" tabindex="-1"></a><span class="ex">List</span><span class="op">[</span>A<span class="op">]</span> <span class="co">// type, produced by applying a type parameter</span></span></code></pre></div>
    <p>There’s a close analogy here with functions and values. Functions
    are “value constructors”—they produce values when we supply
    parameters:</p>
    <div class="sourceCode" id="cb407"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb407-1"><a href="#cb407-1" aria-hidden="true" tabindex="-1"></a>math<span class="op">.</span>abs    <span class="co">// function, takes one parameter</span></span>
<span id="cb407-2"><a href="#cb407-2" aria-hidden="true" tabindex="-1"></a>math<span class="op">.</span><span class="fu">abs</span><span class="op">(</span>x<span class="op">)</span> <span class="co">// value, produced by applying a value parameter</span></span></code></pre></div>
    <p>In Scala we declare type constructors using underscores. This
    specifies how many “holes” the type constructor has. However, to use
    them we refer to just the name.</p>
    <div class="sourceCode" id="cb408"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb408-1"><a href="#cb408-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Declare F using underscores:</span></span>
<span id="cb408-2"><a href="#cb408-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> myMethod<span class="op">[</span>F<span class="op">[</span>_<span class="op">]]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb408-3"><a href="#cb408-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb408-4"><a href="#cb408-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Reference F without underscores:</span></span>
<span id="cb408-5"><a href="#cb408-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> functor <span class="op">=</span> Functor<span class="op">.</span>apply<span class="op">[</span>F<span class="op">]</span></span>
<span id="cb408-6"><a href="#cb408-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb408-7"><a href="#cb408-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb408-8"><a href="#cb408-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>This is analogous to specifying function parameter types. When we
    declare a parameter we also give its type. However, to use them we
    refer to just the name.</p>
    <div class="sourceCode" id="cb409"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb409-1"><a href="#cb409-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Declare f specifying parameter types</span></span>
<span id="cb409-2"><a href="#cb409-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">f</span><span class="op">(</span>x<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="bu">Int</span> <span class="op">=</span> </span>
<span id="cb409-3"><a href="#cb409-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Reference x without type</span></span>
<span id="cb409-4"><a href="#cb409-4" aria-hidden="true" tabindex="-1"></a>  x <span class="op">*</span> <span class="dv">2</span></span></code></pre></div>
    <p>Armed with this knowledge of type constructors, we can see that
    the Cats definition of <code>Functor</code> allows us to create
    instances for any single-parameter type constructor, such as
    <code>List</code>, <code>Option</code>, <code>Future</code>, or a
    type alias such as <code>MyFunc</code>.</p>
    <div class="callout callout-info">
    <p><em>Language Feature Imports</em></p>
    <p>In versions of Scala before 2.13 we need to “enable” the higher
    kinded type language feature, to suppress warnings from the
    compiler, whenever we declare a type constructor with
    <code>A[_]</code> syntax. We can either do this with a “language
    import” as above:</p>
    <div class="sourceCode" id="cb410"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb410-1"><a href="#cb410-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>language<span class="op">.</span>higherKinds</span></code></pre></div>
    <p>or by adding the following to <code>scalacOptions</code> in
    <code>build.sbt</code>:</p>
    <div class="sourceCode" id="cb411"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb411-1"><a href="#cb411-1" aria-hidden="true" tabindex="-1"></a>scalacOptions <span class="op">+=</span> <span class="st">&quot;-language:higherKinds&quot;</span></span></code></pre></div>
    <p>In practice we find the <code>scalacOptions</code> flag to be the
    simpler of the two options.</p>
    </div>
    <h2 data-number="8.5" id="functors-in-cats"><span class="header-section-number">8.5</span> Functors in Cats</h2>
    <p>Let’s look at the implementation of functors in Cats. We’ll
    examine the same aspects we did for monoids: the <em>type
    class</em>, the <em>instances</em>, and the <em>syntax</em>.</p>
    <h3 data-number="8.5.1" id="the-functor-type-class-and-instances"><span class="header-section-number">8.5.1</span> The Functor Type Class
    and Instances</h3>
    <p>The functor type class is <a href="http://typelevel.org/cats/api/cats/Functor.html"><code>cats.Functor</code></a>.
    We obtain instances using the standard <code>Functor.apply</code>
    method on the companion object. As usual, default instances are
    found on companion objects and do not have to be explicity
    imported:</p>
    <div class="sourceCode" id="cb412"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb412-1"><a href="#cb412-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.*</span></span>
<span id="cb412-2"><a href="#cb412-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>all<span class="op">.*</span></span></code></pre></div>
    <div class="sourceCode" id="cb413"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb413-1"><a href="#cb413-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> list1 <span class="op">=</span> <span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">)</span></span>
<span id="cb413-2"><a href="#cb413-2" aria-hidden="true" tabindex="-1"></a><span class="co">// list1: List[Int] = List(1, 2, 3)</span></span>
<span id="cb413-3"><a href="#cb413-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> list2 <span class="op">=</span> Functor<span class="op">[</span><span class="ex">List</span><span class="op">].</span><span class="fu">map</span><span class="op">(</span>list1<span class="op">)(</span>_ <span class="op">*</span> <span class="dv">2</span><span class="op">)</span></span>
<span id="cb413-4"><a href="#cb413-4" aria-hidden="true" tabindex="-1"></a><span class="co">// list2: List[Int] = List(2, 4, 6)</span></span>
<span id="cb413-5"><a href="#cb413-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb413-6"><a href="#cb413-6" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> option1 <span class="op">=</span> <span class="ex">Option</span><span class="op">(</span><span class="dv">123</span><span class="op">)</span></span>
<span id="cb413-7"><a href="#cb413-7" aria-hidden="true" tabindex="-1"></a><span class="co">// option1: Option[Int] = Some(value = 123)</span></span>
<span id="cb413-8"><a href="#cb413-8" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> option2 <span class="op">=</span> Functor<span class="op">[</span><span class="ex">Option</span><span class="op">].</span><span class="fu">map</span><span class="op">(</span>option1<span class="op">)(</span>_<span class="op">.</span>toString<span class="op">)</span></span>
<span id="cb413-9"><a href="#cb413-9" aria-hidden="true" tabindex="-1"></a><span class="co">// option2: Option[String] = Some(value = &quot;123&quot;)</span></span></code></pre></div>
    <p><code>Functor</code> provides a method called <code>lift</code>,
    which converts a function of type <code>A =&gt; B</code> to one that
    operates over a functor and has type
    <code>F[A] =&gt; F[B]</code>:</p>
    <div class="sourceCode" id="cb414"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb414-1"><a href="#cb414-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> func <span class="op">=</span> <span class="op">(</span>x<span class="op">:</span> <span class="bu">Int</span><span class="op">)</span> <span class="op">=&gt;</span> x <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb414-2"><a href="#cb414-2" aria-hidden="true" tabindex="-1"></a><span class="co">// func: Function1[Int, Int] = repl.MdocSession$MdocApp0$$$Lambda/0x00007fcce2e797f8@64533994</span></span>
<span id="cb414-3"><a href="#cb414-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb414-4"><a href="#cb414-4" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> liftedFunc <span class="op">=</span> Functor<span class="op">[</span><span class="ex">Option</span><span class="op">].</span><span class="fu">lift</span><span class="op">(</span>func<span class="op">)</span></span>
<span id="cb414-5"><a href="#cb414-5" aria-hidden="true" tabindex="-1"></a><span class="co">// liftedFunc: Function1[Option[Int], Option[Int]] = cats.Functor$$Lambda/0x00007fcce2e6bad0@18572231</span></span>
<span id="cb414-6"><a href="#cb414-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb414-7"><a href="#cb414-7" aria-hidden="true" tabindex="-1"></a><span class="fu">liftedFunc</span><span class="op">(</span><span class="ex">Option</span><span class="op">(</span><span class="dv">1</span><span class="op">))</span></span>
<span id="cb414-8"><a href="#cb414-8" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: Option[Int] = Some(value = 2)</span></span></code></pre></div>
    <p>The <code>as</code> method is the other method you are likely to
    use. It replaces with value inside the <code>Functor</code> with the
    given value.</p>
    <div class="sourceCode" id="cb415"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb415-1"><a href="#cb415-1" aria-hidden="true" tabindex="-1"></a>Functor<span class="op">[</span><span class="ex">List</span><span class="op">].</span><span class="fu">as</span><span class="op">(</span>list1<span class="op">,</span> <span class="st">&quot;As&quot;</span><span class="op">)</span></span>
<span id="cb415-2"><a href="#cb415-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: List[String] = List(&quot;As&quot;, &quot;As&quot;, &quot;As&quot;)</span></span></code></pre></div>
    <h3 data-number="8.5.2" id="functor-syntax"><span class="header-section-number">8.5.2</span> Functor Syntax</h3>
    <p>The main method provided by the syntax for <code>Functor</code>
    is <code>map</code>. It’s difficult to demonstrate this with
    <code>Options</code> and <code>Lists</code> as they have their own
    built-in <code>map</code> methods and the Scala compiler will always
    prefer a built-in method over an extension method. We’ll work around
    this with two examples.</p>
    <p>First let’s look at mapping over functions. Scala’s
    <code>Function1</code> type doesn’t have a <code>map</code> method
    (it’s called <code>andThen</code> instead) so there are no naming
    conflicts:</p>
    <div class="sourceCode" id="cb416"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb416-1"><a href="#cb416-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> func1 <span class="op">=</span> <span class="op">(</span>a<span class="op">:</span> <span class="bu">Int</span><span class="op">)</span> <span class="op">=&gt;</span> a <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb416-2"><a href="#cb416-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> func2 <span class="op">=</span> <span class="op">(</span>a<span class="op">:</span> <span class="bu">Int</span><span class="op">)</span> <span class="op">=&gt;</span> a <span class="op">*</span> <span class="dv">2</span></span>
<span id="cb416-3"><a href="#cb416-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> func3 <span class="op">=</span> <span class="op">(</span>a<span class="op">:</span> <span class="bu">Int</span><span class="op">)</span> <span class="op">=&gt;</span> <span class="ss">s&quot;${</span>a<span class="ss">}</span><span class="st">!</span><span class="ss">&quot;</span></span>
<span id="cb416-4"><a href="#cb416-4" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> func4 <span class="op">=</span> func1<span class="op">.</span><span class="fu">map</span><span class="op">(</span>func2<span class="op">).</span><span class="fu">map</span><span class="op">(</span>func3<span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb417"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb417-1"><a href="#cb417-1" aria-hidden="true" tabindex="-1"></a><span class="fu">func4</span><span class="op">(</span><span class="dv">123</span><span class="op">)</span></span>
<span id="cb417-2"><a href="#cb417-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: String = &quot;248!&quot;</span></span></code></pre></div>
    <p>Let’s look at another example. This time we’ll abstract over
    functors so we’re not working with any particular concrete type. We
    can write a method that applies an equation to a number no matter
    what functor context it’s in:</p>
    <div class="sourceCode" id="cb418"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb418-1"><a href="#cb418-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> doMath<span class="op">[</span>F<span class="op">[</span>_<span class="op">]](</span>start<span class="op">:</span> F<span class="op">[</span><span class="bu">Int</span><span class="op">])</span></span>
<span id="cb418-2"><a href="#cb418-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span><span class="kw">implicit</span> functor<span class="op">:</span> Functor<span class="op">[</span>F<span class="op">]):</span> F<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb418-3"><a href="#cb418-3" aria-hidden="true" tabindex="-1"></a>  start<span class="op">.</span><span class="fu">map</span><span class="op">(</span>n <span class="op">=&gt;</span> n <span class="op">+</span> <span class="dv">1</span> <span class="op">*</span> <span class="dv">2</span><span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb419"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb419-1"><a href="#cb419-1" aria-hidden="true" tabindex="-1"></a><span class="fu">doMath</span><span class="op">(</span><span class="ex">Option</span><span class="op">(</span><span class="dv">20</span><span class="op">))</span></span>
<span id="cb419-2"><a href="#cb419-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: Option[Int] = Some(value = 22)</span></span>
<span id="cb419-3"><a href="#cb419-3" aria-hidden="true" tabindex="-1"></a><span class="fu">doMath</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">))</span></span>
<span id="cb419-4"><a href="#cb419-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: List[Int] = List(3, 4, 5)</span></span></code></pre></div>
    <p>To illustrate how this works, let’s take a look at the definition
    of the <code>map</code> method in <code>cats.syntax.functor</code>.
    Here’s a simplified version of the code:</p>
    <div class="sourceCode" id="cb420"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb420-1"><a href="#cb420-1" aria-hidden="true" tabindex="-1"></a><span class="kw">implicit</span> <span class="kw">class</span> FunctorOps<span class="op">[</span>F<span class="op">[</span>_<span class="op">],</span> A<span class="op">](</span>src<span class="op">:</span> F<span class="op">[</span>A<span class="op">])</span> <span class="op">{</span></span>
<span id="cb420-2"><a href="#cb420-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>B<span class="op">](</span>func<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">)</span></span>
<span id="cb420-3"><a href="#cb420-3" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span><span class="kw">implicit</span> functor<span class="op">:</span> Functor<span class="op">[</span>F<span class="op">]):</span> F<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb420-4"><a href="#cb420-4" aria-hidden="true" tabindex="-1"></a>    functor<span class="op">.</span><span class="fu">map</span><span class="op">(</span>src<span class="op">)(</span>func<span class="op">)</span></span>
<span id="cb420-5"><a href="#cb420-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>The compiler can use this extension method to insert a
    <code>map</code> method wherever no built-in <code>map</code> is
    available:</p>
    <div class="sourceCode" id="cb421"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb421-1"><a href="#cb421-1" aria-hidden="true" tabindex="-1"></a>foo<span class="op">.</span><span class="fu">map</span><span class="op">(</span>value <span class="op">=&gt;</span> value <span class="op">+</span> <span class="dv">1</span><span class="op">)</span></span></code></pre></div>
    <p>Assuming <code>foo</code> has no built-in <code>map</code>
    method, the compiler detects the potential error and wraps the
    expression in a <code>FunctorOps</code> to fix the code:</p>
    <div class="sourceCode" id="cb422"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb422-1"><a href="#cb422-1" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="fu">FunctorOps</span><span class="op">(</span>foo<span class="op">).</span><span class="fu">map</span><span class="op">(</span>value <span class="op">=&gt;</span> value <span class="op">+</span> <span class="dv">1</span><span class="op">)</span></span></code></pre></div>
    <p>The <code>map</code> method of <code>FunctorOps</code> requires
    an implicit <code>Functor</code> as a parameter. This means this
    code will only compile if we have a <code>Functor</code> for
    <code>F</code> in scope. If we don’t, we get a compiler error:</p>
    <div class="sourceCode" id="cb423"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb423-1"><a href="#cb423-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="ex">Box</span><span class="op">[</span>A<span class="op">](</span>value<span class="op">:</span> A<span class="op">)</span></span>
<span id="cb423-2"><a href="#cb423-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb423-3"><a href="#cb423-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> box <span class="op">=</span> <span class="ex">Box</span><span class="op">[</span><span class="bu">Int</span><span class="op">](</span><span class="dv">123</span><span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb424"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb424-1"><a href="#cb424-1" aria-hidden="true" tabindex="-1"></a>box<span class="op">.</span><span class="fu">map</span><span class="op">(</span>value <span class="op">=&gt;</span> value <span class="op">+</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb424-2"><a href="#cb424-2" aria-hidden="true" tabindex="-1"></a><span class="co">// error:</span></span>
<span id="cb424-3"><a href="#cb424-3" aria-hidden="true" tabindex="-1"></a><span class="co">// value map is not a member of repl.MdocSession.MdocApp0.Box[Int]</span></span>
<span id="cb424-4"><a href="#cb424-4" aria-hidden="true" tabindex="-1"></a><span class="co">// box.map(value =&gt; value + 1)</span></span>
<span id="cb424-5"><a href="#cb424-5" aria-hidden="true" tabindex="-1"></a><span class="co">//    ^</span></span></code></pre></div>
    <p>The <code>as</code> method is also available as syntax.</p>
    <div class="sourceCode" id="cb425"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb425-1"><a href="#cb425-1" aria-hidden="true" tabindex="-1"></a><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">).</span><span class="fu">as</span><span class="op">(</span><span class="st">&quot;As&quot;</span><span class="op">)</span></span>
<span id="cb425-2"><a href="#cb425-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res7: List[String] = List(&quot;As&quot;, &quot;As&quot;, &quot;As&quot;)</span></span></code></pre></div>
    <h3 data-number="8.5.3" id="instances-for-custom-types"><span class="header-section-number">8.5.3</span> Instances for Custom
    Types</h3>
    <p>We can define a functor simply by defining its map method. Here’s
    an example of a <code>Functor</code> for <code>Option</code>, even
    though such a thing already exists in <a href="http://typelevel.org/cats/api/cats/instances/"><code>cats.instances</code></a>.
    The implementation is trivial—we simply call <code>Option&#39;s</code>
    <code>map</code> method:</p>
    <div class="sourceCode" id="cb426"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb426-1"><a href="#cb426-1" aria-hidden="true" tabindex="-1"></a><span class="kw">implicit</span> <span class="kw">val</span> optionFunctor<span class="op">:</span> Functor<span class="op">[</span><span class="ex">Option</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb426-2"><a href="#cb426-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> Functor<span class="op">[</span><span class="ex">Option</span><span class="op">]</span> <span class="op">{</span></span>
<span id="cb426-3"><a href="#cb426-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> map<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>value<span class="op">:</span> <span class="ex">Option</span><span class="op">[</span>A<span class="op">])(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> <span class="ex">Option</span><span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb426-4"><a href="#cb426-4" aria-hidden="true" tabindex="-1"></a>      value<span class="op">.</span><span class="fu">map</span><span class="op">(</span>func<span class="op">)</span></span>
<span id="cb426-5"><a href="#cb426-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>Sometimes we need to inject dependencies into our instances. For
    example, if we had to define a custom <code>Functor</code> for
    <code>Future</code> (another hypothetical example—Cats provides one
    in <code>cats.instances.future</code>) we would need to account for
    the implicit <code>ExecutionContext</code> parameter on
    <code>future.map</code>. We can’t add extra parameters to
    <code>functor.map</code> so we have to account for the dependency
    when we create the instance:</p>
    <div class="sourceCode" id="cb427"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb427-1"><a href="#cb427-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.{</span><span class="ex">Future</span><span class="op">,</span> ExecutionContext<span class="op">}</span></span>
<span id="cb427-2"><a href="#cb427-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb427-3"><a href="#cb427-3" aria-hidden="true" tabindex="-1"></a><span class="kw">implicit</span> <span class="kw">def</span> futureFunctor</span>
<span id="cb427-4"><a href="#cb427-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span><span class="kw">implicit</span> ec<span class="op">:</span> ExecutionContext<span class="op">):</span> Functor<span class="op">[</span><span class="ex">Future</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb427-5"><a href="#cb427-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> Functor<span class="op">[</span><span class="ex">Future</span><span class="op">]</span> <span class="op">{</span></span>
<span id="cb427-6"><a href="#cb427-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> map<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>value<span class="op">:</span> <span class="ex">Future</span><span class="op">[</span>A<span class="op">])(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> <span class="ex">Future</span><span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb427-7"><a href="#cb427-7" aria-hidden="true" tabindex="-1"></a>      value<span class="op">.</span><span class="fu">map</span><span class="op">(</span>func<span class="op">)</span></span>
<span id="cb427-8"><a href="#cb427-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>Whenever we summon a <code>Functor</code> for
    <code>Future</code>, either directly using
    <code>Functor.apply</code> or indirectly via the <code>map</code>
    extension method, the compiler will locate
    <code>futureFunctor</code> by implicit resolution and recursively
    search for an <code>ExecutionContext</code> at the call site. This
    is what the expansion might look like:</p>
    <div class="sourceCode" id="cb428"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb428-1"><a href="#cb428-1" aria-hidden="true" tabindex="-1"></a><span class="co">// We write this:</span></span>
<span id="cb428-2"><a href="#cb428-2" aria-hidden="true" tabindex="-1"></a>Functor<span class="op">[</span><span class="ex">Future</span><span class="op">]</span></span>
<span id="cb428-3"><a href="#cb428-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb428-4"><a href="#cb428-4" aria-hidden="true" tabindex="-1"></a><span class="co">// The compiler expands to this first:</span></span>
<span id="cb428-5"><a href="#cb428-5" aria-hidden="true" tabindex="-1"></a>Functor<span class="op">[</span><span class="ex">Future</span><span class="op">](</span>futureFunctor<span class="op">)</span></span>
<span id="cb428-6"><a href="#cb428-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb428-7"><a href="#cb428-7" aria-hidden="true" tabindex="-1"></a><span class="co">// And then to this:</span></span>
<span id="cb428-8"><a href="#cb428-8" aria-hidden="true" tabindex="-1"></a>Functor<span class="op">[</span><span class="ex">Future</span><span class="op">](</span><span class="fu">futureFunctor</span><span class="op">(</span>executionContext<span class="op">))</span></span></code></pre></div>
    <h3 data-number="8.5.4" id="exercise-branching-out-with-functors"><span class="header-section-number">8.5.4</span> Exercise: Branching out
    with Functors</h3>
    <p>Write a <code>Functor</code> for the following binary tree data
    type. Verify that the code works as expected on instances of
    <code>Branch</code> and <code>Leaf</code>:</p>
    <div class="sourceCode" id="cb429"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb429-1"><a href="#cb429-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> Tree<span class="op">[+</span>A<span class="op">]</span></span>
<span id="cb429-2"><a href="#cb429-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb429-3"><a href="#cb429-3" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> Branch<span class="op">[</span>A<span class="op">](</span>left<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">],</span> right<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb429-4"><a href="#cb429-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">extends</span> Tree<span class="op">[</span>A<span class="op">]</span></span>
<span id="cb429-5"><a href="#cb429-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb429-6"><a href="#cb429-6" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> Leaf<span class="op">[</span>A<span class="op">](</span>value<span class="op">:</span> A<span class="op">)</span> <span class="kw">extends</span> Tree<span class="op">[</span>A<span class="op">]</span></span></code></pre></div>
    <div class="solution">
    <p>The semantics are similar to writing a <code>Functor</code> for
    <code>List</code>. We recurse over the data structure, applying the
    function to every <code>Leaf</code> we find. The functor laws
    intuitively require us to retain the same structure with the same
    pattern of <code>Branch</code> and <code>Leaf</code> nodes:</p>
    <div class="sourceCode" id="cb430"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb430-1"><a href="#cb430-1" aria-hidden="true" tabindex="-1"></a><span class="kw">implicit</span> <span class="kw">val</span> treeFunctor<span class="op">:</span> Functor<span class="op">[</span>Tree<span class="op">]</span> <span class="op">=</span></span>
<span id="cb430-2"><a href="#cb430-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> Functor<span class="op">[</span>Tree<span class="op">]</span> <span class="op">{</span></span>
<span id="cb430-3"><a href="#cb430-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> map<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>tree<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">])(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> Tree<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb430-4"><a href="#cb430-4" aria-hidden="true" tabindex="-1"></a>      tree <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb430-5"><a href="#cb430-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">Branch</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb430-6"><a href="#cb430-6" aria-hidden="true" tabindex="-1"></a>          <span class="fu">Branch</span><span class="op">(</span><span class="fu">map</span><span class="op">(</span>left<span class="op">)(</span>func<span class="op">),</span> <span class="fu">map</span><span class="op">(</span>right<span class="op">)(</span>func<span class="op">))</span></span>
<span id="cb430-7"><a href="#cb430-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb430-8"><a href="#cb430-8" aria-hidden="true" tabindex="-1"></a>          <span class="fu">Leaf</span><span class="op">(</span><span class="fu">func</span><span class="op">(</span>value<span class="op">))</span></span>
<span id="cb430-9"><a href="#cb430-9" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb430-10"><a href="#cb430-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>Let’s use our <code>Functor</code> to transform some
    <code>Trees</code>:</p>
    <div class="sourceCode" id="cb431"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb431-1"><a href="#cb431-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Branch</span><span class="op">(</span><span class="fu">Leaf</span><span class="op">(</span><span class="dv">10</span><span class="op">),</span> <span class="fu">Leaf</span><span class="op">(</span><span class="dv">20</span><span class="op">)).</span><span class="fu">map</span><span class="op">(</span>_ <span class="op">*</span> <span class="dv">2</span><span class="op">)</span></span>
<span id="cb431-2"><a href="#cb431-2" aria-hidden="true" tabindex="-1"></a><span class="co">// error:</span></span>
<span id="cb431-3"><a href="#cb431-3" aria-hidden="true" tabindex="-1"></a><span class="co">// value map is not a member of repl.MdocSession.MdocApp0.Branch[Int]</span></span>
<span id="cb431-4"><a href="#cb431-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Branch(Leaf(10), Leaf(20)).map(_ * 2)</span></span>
<span id="cb431-5"><a href="#cb431-5" aria-hidden="true" tabindex="-1"></a><span class="co">//                           ^</span></span></code></pre></div>
    <p>Oops! This falls foul of the same invariance problem we discussed
    in Section 4.6.1. The compiler can find a <code>Functor</code>
    instance for <code>Tree</code> but not for <code>Branch</code> or
    <code>Leaf</code>. Let’s add some smart constructors to
    compensate:</p>
    <div class="sourceCode" id="cb432"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb432-1"><a href="#cb432-1" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Tree <span class="op">{</span></span>
<span id="cb432-2"><a href="#cb432-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> branch<span class="op">[</span>A<span class="op">](</span>left<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">],</span> right<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">]):</span> Tree<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb432-3"><a href="#cb432-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Branch</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span></span>
<span id="cb432-4"><a href="#cb432-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb432-5"><a href="#cb432-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> leaf<span class="op">[</span>A<span class="op">](</span>value<span class="op">:</span> A<span class="op">):</span> Tree<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb432-6"><a href="#cb432-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">)</span></span>
<span id="cb432-7"><a href="#cb432-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Now we can use our <code>Functor</code> properly:</p>
    <div class="sourceCode" id="cb433"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb433-1"><a href="#cb433-1" aria-hidden="true" tabindex="-1"></a>Tree<span class="op">.</span><span class="fu">leaf</span><span class="op">(</span><span class="dv">100</span><span class="op">).</span><span class="fu">map</span><span class="op">(</span>_ <span class="op">*</span> <span class="dv">2</span><span class="op">)</span></span>
<span id="cb433-2"><a href="#cb433-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res9: Tree[Int] = Leaf(value = 200)</span></span>
<span id="cb433-3"><a href="#cb433-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb433-4"><a href="#cb433-4" aria-hidden="true" tabindex="-1"></a>Tree<span class="op">.</span><span class="fu">branch</span><span class="op">(</span>Tree<span class="op">.</span><span class="fu">leaf</span><span class="op">(</span><span class="dv">10</span><span class="op">),</span> Tree<span class="op">.</span><span class="fu">leaf</span><span class="op">(</span><span class="dv">20</span><span class="op">)).</span><span class="fu">map</span><span class="op">(</span>_ <span class="op">*</span> <span class="dv">2</span><span class="op">)</span></span>
<span id="cb433-5"><a href="#cb433-5" aria-hidden="true" tabindex="-1"></a><span class="co">// res10: Tree[Int] = Branch(left = Leaf(value = 20), right = Leaf(value = 40))</span></span></code></pre></div>
    </div>
    <h2 data-number="8.6" id="sec:functors:contravariant-invariant"><span class="header-section-number">8.6</span> Contravariant and Invariant
    Functors</h2>
    <p>As we have seen, we can think of <code>Functor&#39;s</code>
    <code>map</code> method as “appending” a transformation to a chain.
    We’re now going to look at two other type classes, one representing
    <em>prepending</em> operations to a chain, and one representing
    building a <em>bidirectional</em> chain of operations. These are
    called <em>contravariant</em> and <em>invariant functors</em>
    respectively.</p>
    <div class="callout callout-info">
    <p><em>This Section is Optional!</em></p>
    <p>You don’t need to know about contravariant and invariant functors
    to understand monads, which are the most important type class in
    this book and the focus of the next chapter. However, contravariant
    and invariant do come in handy in our discussion of
    <code>Semigroupal</code> and <code>Applicative</code> in Chapter
    11.</p>
    <p>If you want to move on to monads now, feel free to skip straight
    to Chapter 9. Come back here before you read Chapter 11.</p>
    </div>
    <h3 data-number="8.6.1" id="sec:functors:contravariant"><span class="header-section-number">8.6.1</span> Contravariant Functors
    and the <em>contramap</em> Method</h3>
    <p>The first of our type classes, the <em>contravariant
    functor</em>, provides an operation called <code>contramap</code>
    that represents “prepending” an operation to a chain. The general
    type signature is shown in Figure 5.</p>
    <figure id="fig:functors:contramap-type-chart">
    <svg id="svg_25ba82b5ce64f75f6fd2" alt="Type chart: the contramap method" width="1762px" height="360px" viewBox="0 0 1762 360">
    <!-- Generator: Sketch 40.3 (33839) - http://www.bohemiancoding.com/sketch -->
    <title>generic-contramap</title>
    <desc>Created with Sketch.</desc>
    <defs>
        <ellipse id="svg_25ba82b5ce64f75f6fd2_path-1" cx="64" cy="63.902439" rx="64" ry="63.902439"></ellipse>
        <mask id="svg_25ba82b5ce64f75f6fd2_mask-2" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="128" height="127.804878" fill="white">
            <use xlink:href="#svg_25ba82b5ce64f75f6fd2_path-1" />
        </mask>
        <polygon id="svg_25ba82b5ce64f75f6fd2_path-3" points="314.876069 108.634146 272.555531 130.849453 280.638035 83.7966779 246.4 50.4737173 293.7158 43.6088099 314.876069 0.798780488 336.036338 43.6088099 383.352138 50.4737173 349.114104 83.7966779 357.196607 130.849453"></polygon>
        <mask id="svg_25ba82b5ce64f75f6fd2_mask-4" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="136.952138" height="130.050673" fill="white">
            <use xlink:href="#svg_25ba82b5ce64f75f6fd2_path-3" />
        </mask>
        <polygon id="svg_25ba82b5ce64f75f6fd2_path-5" points="161.6 47.9268293 193.6 47.9268293 193.6 31.9512195 225.6 63.5012652 193.6 95.8536585 193.6 79.8780488 161.6 79.8780488"></polygon>
        <mask id="svg_25ba82b5ce64f75f6fd2_mask-6" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="64" height="63.902439" fill="white">
            <use xlink:href="#svg_25ba82b5ce64f75f6fd2_path-5" />
        </mask>
        <polygon id="svg_25ba82b5ce64f75f6fd2_path-7" points="68.4760692 108 26.155531 130.249224 34.2380346 83.1246118 -9.41469125e-14 49.7507764 47.3158001 42.8753882 68.4760692 0 89.6363383 42.8753882 136.952138 49.7507764 102.714104 83.1246118 110.796607 130.249224"></polygon>
        <mask id="svg_25ba82b5ce64f75f6fd2_mask-8" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="136.952138" height="130.249224" fill="white">
            <use xlink:href="#svg_25ba82b5ce64f75f6fd2_path-7" />
        </mask>
        <rect id="svg_25ba82b5ce64f75f6fd2_path-9" x="0" y="0" width="160" height="160" rx="6.4" />
        <mask id="svg_25ba82b5ce64f75f6fd2_mask-10" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="160" height="160" fill="white">
            <use xlink:href="#svg_25ba82b5ce64f75f6fd2_path-9" />
        </mask>
        <ellipse id="svg_25ba82b5ce64f75f6fd2_path-11" cx="64" cy="64" rx="64" ry="64"></ellipse>
        <mask id="svg_25ba82b5ce64f75f6fd2_mask-12" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="128" height="128" fill="white">
            <use xlink:href="#svg_25ba82b5ce64f75f6fd2_path-11" />
        </mask>
        <rect id="svg_25ba82b5ce64f75f6fd2_path-13" x="0" y="0" width="160" height="160" rx="6.4" />
        <mask id="svg_25ba82b5ce64f75f6fd2_mask-14" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="160" height="160" fill="white">
            <use xlink:href="#svg_25ba82b5ce64f75f6fd2_path-13" />
        </mask>
    </defs>
    <g id="svg_25ba82b5ce64f75f6fd2_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_25ba82b5ce64f75f6fd2_generic-contramap">
            <rect id="svg_25ba82b5ce64f75f6fd2_Background" fill="#FFFFFF" x="0" y="0" width="1762" height="360" />
            <g id="svg_25ba82b5ce64f75f6fd2_Group-7" transform="translate(787.000000, 75.000000)" stroke="#000000" stroke-width="6.4">
                <use id="svg_25ba82b5ce64f75f6fd2_Oval-1" mask="url(#mask-2)" fill="#FFFFFF" xlink:href="#svg_25ba82b5ce64f75f6fd2_path-1" />
                <use id="svg_25ba82b5ce64f75f6fd2_Star-1" mask="url(#mask-4)" fill="#FFFFFF" xlink:href="#svg_25ba82b5ce64f75f6fd2_path-3" />
                <use id="svg_25ba82b5ce64f75f6fd2_Path-1" mask="url(#mask-6)" fill="#000000" xlink:href="#svg_25ba82b5ce64f75f6fd2_path-5" />
            </g>
            <polygon id="svg_25ba82b5ce64f75f6fd2_Path-1" fill="#F6A623" points="1213 123 1245 123 1245 107 1277 138.598214 1245 171 1245 155 1213 155"></polygon>
            <text id="svg_25ba82b5ce64f75f6fd2_F[B]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="312.6" y="314">F[B]</tspan>
            </text>
            <text id="svg_25ba82b5ce64f75f6fd2_F[A]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="1356.6" y="314">F[A]</tspan>
            </text>
            <text id="svg_25ba82b5ce64f75f6fd2_A-=&gt;-B" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="900.4" y="314">A =&gt; B</tspan>
            </text>
            <g id="svg_25ba82b5ce64f75f6fd2_Group-9" transform="translate(280.000000, 57.000000)" stroke="#000000" stroke-width="6.4">
                <g id="svg_25ba82b5ce64f75f6fd2_Group" transform="translate(11.200000, 15.200000)" fill="#FFFFFF">
                    <use id="svg_25ba82b5ce64f75f6fd2_Star-1" mask="url(#mask-8)" xlink:href="#svg_25ba82b5ce64f75f6fd2_path-7" />
                </g>
                <use id="svg_25ba82b5ce64f75f6fd2_Rectangle-1" mask="url(#mask-10)" xlink:href="#svg_25ba82b5ce64f75f6fd2_path-9" />
            </g>
            <g id="svg_25ba82b5ce64f75f6fd2_Group-8" transform="translate(1320.000000, 57.000000)" stroke="#000000" stroke-width="6.4">
                <g id="svg_25ba82b5ce64f75f6fd2_Group-2" transform="translate(16.000000, 19.200000)" fill="#FFFFFF">
                    <use id="svg_25ba82b5ce64f75f6fd2_Oval-1" mask="url(#mask-12)" xlink:href="#svg_25ba82b5ce64f75f6fd2_path-11" />
                </g>
                <use id="svg_25ba82b5ce64f75f6fd2_Rectangle-1" mask="url(#mask-14)" xlink:href="#svg_25ba82b5ce64f75f6fd2_path-13" />
            </g>
            <text id="svg_25ba82b5ce64f75f6fd2_contramap" font-family="FiraMono-Bold, Fira Mono" font-size="51.2" font-weight="bold" fill="#F6A623">
                <tspan x="474.26" y="151">contramap</tspan>
            </text>
        </g>
    </g>
</svg>
    <figcaption>Figure 5: Type chart: the contramap method</figcaption>
    </figure>
    <p>The <code>contramap</code> method only makes sense for data types
    that represent <em>transformations</em>. For example, we can’t
    define <code>contramap</code> for an <code>Option</code> because
    there is no way of feeding a value in an <code>Option[B]</code>
    backwards through a function <code>A =&gt; B</code>. However, we can
    define <code>contramap</code> for the <code>Display</code> type
    class we discussed in Section 4.5:</p>
    <div class="sourceCode" id="cb434"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb434-1"><a href="#cb434-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Display<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb434-2"><a href="#cb434-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">display</span><span class="op">(</span>value<span class="op">:</span> A<span class="op">):</span> <span class="ex">String</span></span>
<span id="cb434-3"><a href="#cb434-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>A <code>Display[A]</code> represents a transformation from
    <code>A</code> to <code>String</code>. Its <code>contramap</code>
    method accepts a function <code>func</code> of type
    <code>B =&gt; A</code> and creates a new
    <code>Display[B]</code>:</p>
    <div class="sourceCode" id="cb435"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb435-1"><a href="#cb435-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Display<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb435-2"><a href="#cb435-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">display</span><span class="op">(</span>value<span class="op">:</span> A<span class="op">):</span> <span class="ex">String</span></span>
<span id="cb435-3"><a href="#cb435-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-4"><a href="#cb435-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> contramap<span class="op">[</span>B<span class="op">](</span>func<span class="op">:</span> B <span class="op">=&gt;</span> A<span class="op">):</span> Display<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb435-5"><a href="#cb435-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb435-6"><a href="#cb435-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb435-7"><a href="#cb435-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-8"><a href="#cb435-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> display<span class="op">[</span>A<span class="op">](</span>value<span class="op">:</span> A<span class="op">)(</span>using p<span class="op">:</span> Display<span class="op">[</span>A<span class="op">]):</span> <span class="ex">String</span> <span class="op">=</span></span>
<span id="cb435-9"><a href="#cb435-9" aria-hidden="true" tabindex="-1"></a>  p<span class="op">.</span><span class="fu">display</span><span class="op">(</span>value<span class="op">)</span></span></code></pre></div>
    <h4 data-number="8.6.1.1" id="exercise-showing-off-with-contramap"><span class="header-section-number">8.6.1.1</span> Exercise: Showing off
    with Contramap</h4>
    <p>Implement the <code>contramap</code> method for
    <code>Display</code> above. Start with the following code template
    and replace the <code>???</code> with a working method body:</p>
    <div class="sourceCode" id="cb436"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb436-1"><a href="#cb436-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Display<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb436-2"><a href="#cb436-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">display</span><span class="op">(</span>value<span class="op">:</span> A<span class="op">):</span> <span class="ex">String</span></span>
<span id="cb436-3"><a href="#cb436-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb436-4"><a href="#cb436-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> contramap<span class="op">[</span>B<span class="op">](</span>func<span class="op">:</span> B <span class="op">=&gt;</span> A<span class="op">):</span> Display<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb436-5"><a href="#cb436-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> Display<span class="op">[</span>B<span class="op">]</span> <span class="op">{</span></span>
<span id="cb436-6"><a href="#cb436-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> <span class="fu">display</span><span class="op">(</span>value<span class="op">:</span> B<span class="op">):</span> <span class="ex">String</span> <span class="op">=</span></span>
<span id="cb436-7"><a href="#cb436-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">???</span></span>
<span id="cb436-8"><a href="#cb436-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb436-9"><a href="#cb436-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>If you get stuck, think about the types. You need to turn
    <code>value</code>, which is of type <code>B</code>, into a
    <code>String</code>. What functions and methods do you have
    available and in what order do they need to be combined?</p>
    <div class="solution">
    <p>Here’s a working implementation. We call <code>func</code> to
    turn the <code>B</code> into an <code>A</code> and then use our
    original <code>Display</code> to turn the <code>A</code> into a
    <code>String</code>. In a small show of sleight of hand we use a
    <code>self</code> alias to distinguish the outer and inner
    <code>Displays</code>:</p>
    <div class="sourceCode" id="cb437"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb437-1"><a href="#cb437-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Display<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span> self <span class="op">=&gt;</span></span>
<span id="cb437-2"><a href="#cb437-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb437-3"><a href="#cb437-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">display</span><span class="op">(</span>value<span class="op">:</span> A<span class="op">):</span> <span class="ex">String</span></span>
<span id="cb437-4"><a href="#cb437-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb437-5"><a href="#cb437-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> contramap<span class="op">[</span>B<span class="op">](</span>func<span class="op">:</span> B <span class="op">=&gt;</span> A<span class="op">):</span> Display<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb437-6"><a href="#cb437-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> Display<span class="op">[</span>B<span class="op">]</span> <span class="op">{</span></span>
<span id="cb437-7"><a href="#cb437-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> <span class="fu">display</span><span class="op">(</span>value<span class="op">:</span> B<span class="op">):</span> <span class="ex">String</span> <span class="op">=</span></span>
<span id="cb437-8"><a href="#cb437-8" aria-hidden="true" tabindex="-1"></a>        self<span class="op">.</span><span class="fu">display</span><span class="op">(</span><span class="fu">func</span><span class="op">(</span>value<span class="op">))</span></span>
<span id="cb437-9"><a href="#cb437-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb437-10"><a href="#cb437-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb437-11"><a href="#cb437-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb437-12"><a href="#cb437-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> display<span class="op">[</span>A<span class="op">](</span>value<span class="op">:</span> A<span class="op">)(</span>using p<span class="op">:</span> Display<span class="op">[</span>A<span class="op">]):</span> <span class="ex">String</span> <span class="op">=</span></span>
<span id="cb437-13"><a href="#cb437-13" aria-hidden="true" tabindex="-1"></a>  p<span class="op">.</span><span class="fu">display</span><span class="op">(</span>value<span class="op">)</span></span></code></pre></div>
    </div>
    <p>For testing purposes, let’s define some instances of
    <code>Display</code> for <code>String</code> and
    <code>Boolean</code>:</p>
    <div class="sourceCode" id="cb438"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb438-1"><a href="#cb438-1" aria-hidden="true" tabindex="-1"></a>given stringDisplay<span class="op">:</span> Display<span class="op">[</span><span class="ex">String</span><span class="op">]</span> <span class="kw">with</span> <span class="op">{</span></span>
<span id="cb438-2"><a href="#cb438-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">display</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">String</span> <span class="op">=</span></span>
<span id="cb438-3"><a href="#cb438-3" aria-hidden="true" tabindex="-1"></a>    <span class="ss">s&quot;</span><span class="st">&#39;</span><span class="ss">${</span>value<span class="ss">}</span><span class="st">&#39;</span><span class="ss">&quot;</span></span>
<span id="cb438-4"><a href="#cb438-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb438-5"><a href="#cb438-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb438-6"><a href="#cb438-6" aria-hidden="true" tabindex="-1"></a>given booleanDisplay<span class="op">:</span> Display<span class="op">[</span><span class="ex">Boolean</span><span class="op">]</span> <span class="kw">with</span> <span class="op">{</span></span>
<span id="cb438-7"><a href="#cb438-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">display</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">Boolean</span><span class="op">):</span> <span class="ex">String</span> <span class="op">=</span></span>
<span id="cb438-8"><a href="#cb438-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> value then <span class="st">&quot;yes&quot;</span> <span class="cf">else</span> <span class="st">&quot;no&quot;</span></span>
<span id="cb438-9"><a href="#cb438-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <div class="sourceCode" id="cb439"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb439-1"><a href="#cb439-1" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span><span class="op">(</span><span class="st">&quot;hello&quot;</span><span class="op">)</span></span>
<span id="cb439-2"><a href="#cb439-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: String = &quot;&#39;hello&#39;&quot;</span></span>
<span id="cb439-3"><a href="#cb439-3" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span><span class="op">(</span><span class="kw">true</span><span class="op">)</span></span>
<span id="cb439-4"><a href="#cb439-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: String = &quot;yes&quot;</span></span></code></pre></div>
    <p>Now define an instance of <code>Display</code> for the following
    <code>Box</code> case class. This is an example of type class
    composotion as described in Section 4.3:</p>
    <div class="sourceCode" id="cb440"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb440-1"><a href="#cb440-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="ex">Box</span><span class="op">[</span>A<span class="op">](</span>value<span class="op">:</span> A<span class="op">)</span></span></code></pre></div>
    <p>Rather than writing out the complete definition from scratch
    (<code>new Display[Box]</code> etc…), create your instance from an
    existing instance using <code>contramap</code>.</p>
    <p>Your instance should work as follows:</p>
    <div class="sourceCode" id="cb441"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb441-1"><a href="#cb441-1" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span><span class="op">(</span><span class="ex">Box</span><span class="op">(</span><span class="st">&quot;hello world&quot;</span><span class="op">))</span></span>
<span id="cb441-2"><a href="#cb441-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: String = &quot;&#39;hello world&#39;&quot;</span></span>
<span id="cb441-3"><a href="#cb441-3" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span><span class="op">(</span><span class="ex">Box</span><span class="op">(</span><span class="kw">true</span><span class="op">))</span></span>
<span id="cb441-4"><a href="#cb441-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: String = &quot;yes&quot;</span></span></code></pre></div>
    <p>If we don’t have a <code>Display</code> for the type inside the
    <code>Box</code>, calls to <code>display</code> should fail to
    compile:</p>
    <div class="sourceCode" id="cb442"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb442-1"><a href="#cb442-1" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span><span class="op">(</span><span class="ex">Box</span><span class="op">(</span><span class="dv">123</span><span class="op">))</span></span>
<span id="cb442-2"><a href="#cb442-2" aria-hidden="true" tabindex="-1"></a><span class="co">// error:</span></span>
<span id="cb442-3"><a href="#cb442-3" aria-hidden="true" tabindex="-1"></a><span class="co">// No given instance of type repl.MdocSession.MdocApp1.Display[repl.MdocSession.MdocApp1.Box[Int]] was found for parameter p of method display in object MdocApp1.</span></span>
<span id="cb442-4"><a href="#cb442-4" aria-hidden="true" tabindex="-1"></a><span class="co">// I found:</span></span>
<span id="cb442-5"><a href="#cb442-5" aria-hidden="true" tabindex="-1"></a><span class="co">// </span></span>
<span id="cb442-6"><a href="#cb442-6" aria-hidden="true" tabindex="-1"></a><span class="co">//     repl.MdocSession.MdocApp1.boxDisplay[A](</span></span>
<span id="cb442-7"><a href="#cb442-7" aria-hidden="true" tabindex="-1"></a><span class="co">//       /* missing */summon[repl.MdocSession.MdocApp1.Display[A]])</span></span>
<span id="cb442-8"><a href="#cb442-8" aria-hidden="true" tabindex="-1"></a><span class="co">// </span></span>
<span id="cb442-9"><a href="#cb442-9" aria-hidden="true" tabindex="-1"></a><span class="co">// But no implicit values were found that match type repl.MdocSession.MdocApp1.Display[A].</span></span>
<span id="cb442-10"><a href="#cb442-10" aria-hidden="true" tabindex="-1"></a><span class="co">// display(Box(123))</span></span>
<span id="cb442-11"><a href="#cb442-11" aria-hidden="true" tabindex="-1"></a><span class="co">//                 ^</span></span></code></pre></div>
    <div class="solution">
    <p>To make the instance generic across all types of
    <code>Box</code>, we base it on the <code>Display</code> for the
    type inside the <code>Box</code>. We can either write out the
    complete definition by hand:</p>
    <div class="sourceCode" id="cb443"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb443-1"><a href="#cb443-1" aria-hidden="true" tabindex="-1"></a>given boxDisplay<span class="op">[</span>A<span class="op">](</span></span>
<span id="cb443-2"><a href="#cb443-2" aria-hidden="true" tabindex="-1"></a>    using p<span class="op">:</span> Display<span class="op">[</span>A<span class="op">]</span></span>
<span id="cb443-3"><a href="#cb443-3" aria-hidden="true" tabindex="-1"></a><span class="op">):</span> Display<span class="op">[</span><span class="ex">Box</span><span class="op">[</span>A<span class="op">]]</span> <span class="kw">with</span> <span class="op">{</span></span>
<span id="cb443-4"><a href="#cb443-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">display</span><span class="op">(</span>box<span class="op">:</span> <span class="ex">Box</span><span class="op">[</span>A<span class="op">]):</span> <span class="ex">String</span> <span class="op">=</span></span>
<span id="cb443-5"><a href="#cb443-5" aria-hidden="true" tabindex="-1"></a>    p<span class="op">.</span><span class="fu">display</span><span class="op">(</span>box<span class="op">.</span>value<span class="op">)</span></span>
<span id="cb443-6"><a href="#cb443-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>or use <code>contramap</code> to base the new instance on the
    using clause:</p>
    <div class="sourceCode" id="cb444"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb444-1"><a href="#cb444-1" aria-hidden="true" tabindex="-1"></a>given boxDisplay<span class="op">[</span>A<span class="op">](</span>using p<span class="op">:</span> Display<span class="op">[</span>A<span class="op">]):</span> Display<span class="op">[</span><span class="ex">Box</span><span class="op">[</span>A<span class="op">]]</span> <span class="op">=</span></span>
<span id="cb444-2"><a href="#cb444-2" aria-hidden="true" tabindex="-1"></a>  p<span class="op">.</span>contramap<span class="op">[</span><span class="ex">Box</span><span class="op">[</span>A<span class="op">]](</span>_<span class="op">.</span>value<span class="op">)</span></span></code></pre></div>
    <p>Using <code>contramap</code> is much simpler, and conveys the
    functional programming approach of building solutions by combining
    simple building blocks using pure functional combinators.</p>
    </div>
    <h3 data-number="8.6.2" id="sec:functors:invariant"><span class="header-section-number">8.6.2</span> Invariant functors and
    the <em>imap</em> method</h3>
    <p><em>Invariant functors</em> implement a method called
    <code>imap</code> that is informally equivalent to a combination of
    <code>map</code> and <code>contramap</code>. If <code>map</code>
    generates new type class instances by appending a function to a
    chain, and <code>contramap</code> generates them by prepending an
    operation to a chain, <code>imap</code> generates them via a pair of
    bidirectional transformations.</p>
    <p>The most intuitive examples of this are a type class that
    represents encoding and decoding as some data type, such as Circe’s
    <a href="https://github.com/circe/circe/blob/series/0.14.x/modules/core/shared/src/main/scala/io/circe/Codec.scala"><code>Codec</code></a>
    and Play JSON’s <a href="https://www.playframework.com/documentation/2.6.x/ScalaJsonCombinators#Format"><code>Format</code></a>.
    We can build our own <code>Codec</code> by enhancing
    <code>Display</code> to support encoding and decoding to/from a
    <code>String</code>:</p>
    <div class="sourceCode" id="cb445"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb445-1"><a href="#cb445-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> <span class="ex">Codec</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb445-2"><a href="#cb445-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">encode</span><span class="op">(</span>value<span class="op">:</span> A<span class="op">):</span> <span class="ex">String</span></span>
<span id="cb445-3"><a href="#cb445-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">decode</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> A</span>
<span id="cb445-4"><a href="#cb445-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> imap<span class="op">[</span>B<span class="op">](</span>dec<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">,</span> enc<span class="op">:</span> B <span class="op">=&gt;</span> A<span class="op">):</span> <span class="ex">Codec</span><span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> <span class="op">???</span></span>
<span id="cb445-5"><a href="#cb445-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <div class="sourceCode" id="cb446"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb446-1"><a href="#cb446-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> encode<span class="op">[</span>A<span class="op">](</span>value<span class="op">:</span> A<span class="op">)(</span>using c<span class="op">:</span> <span class="ex">Codec</span><span class="op">[</span>A<span class="op">]):</span> <span class="ex">String</span> <span class="op">=</span></span>
<span id="cb446-2"><a href="#cb446-2" aria-hidden="true" tabindex="-1"></a>  c<span class="op">.</span><span class="fu">encode</span><span class="op">(</span>value<span class="op">)</span></span>
<span id="cb446-3"><a href="#cb446-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb446-4"><a href="#cb446-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> decode<span class="op">[</span>A<span class="op">](</span>value<span class="op">:</span> <span class="ex">String</span><span class="op">)(</span>using c<span class="op">:</span> <span class="ex">Codec</span><span class="op">[</span>A<span class="op">]):</span> A <span class="op">=</span></span>
<span id="cb446-5"><a href="#cb446-5" aria-hidden="true" tabindex="-1"></a>  c<span class="op">.</span><span class="fu">decode</span><span class="op">(</span>value<span class="op">)</span></span></code></pre></div>
    <p>The type chart for <code>imap</code> is shown in Figure 6. If we
    have a <code>Codec[A]</code> and a pair of functions
    <code>A =&gt; B</code> and <code>B =&gt; A</code>, the
    <code>imap</code> method creates a <code>Codec[B]</code>:</p>
    <figure id="fig:functors:imap-type-chart">
    <svg id="svg_9a72e01356df98aa1887" alt="Type chart: the imap method" width="1763px" height="360px" viewBox="0 0 1763 360">
    <!-- Generator: Sketch 40.3 (33839) - http://www.bohemiancoding.com/sketch -->
    <title>generic-imap</title>
    <desc>Created with Sketch.</desc>
    <defs>
        <ellipse id="svg_9a72e01356df98aa1887_path-1" cx="43.7924731" cy="44.4146341" rx="43.7924731" ry="43.4146341"></ellipse>
        <mask id="svg_9a72e01356df98aa1887_mask-2" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="87.5849462" height="86.8292683" fill="white">
            <use xlink:href="#svg_9a72e01356df98aa1887_path-1" />
        </mask>
        <polygon id="svg_9a72e01356df98aa1887_path-3" points="215.456278 73.804878 186.498137 88.8977203 192.02865 56.9305675 168.601022 34.2913041 200.977207 29.6273594 215.456278 0.542682927 229.935349 29.6273594 262.311535 34.2913041 238.883906 56.9305675 244.414419 88.8977203"></polygon>
        <mask id="svg_9a72e01356df98aa1887_mask-4" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="93.7105131" height="88.3550373" fill="white">
            <use xlink:href="#svg_9a72e01356df98aa1887_path-3" />
        </mask>
        <polygon id="svg_9a72e01356df98aa1887_path-5" points="110.575995 33.5609756 132.472231 33.5609756 132.472231 22.7073171 154.368468 44.1420809 132.472231 66.1219512 132.472231 55.2682927 110.575995 55.2682927"></polygon>
        <mask id="svg_9a72e01356df98aa1887_mask-6" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="43.7924731" height="43.4146341" fill="white">
            <use xlink:href="#svg_9a72e01356df98aa1887_path-5" />
        </mask>
        <ellipse id="svg_9a72e01356df98aa1887_path-7" cx="214.792473" cy="47.4146341" rx="43.7924731" ry="43.4146341"></ellipse>
        <mask id="svg_9a72e01356df98aa1887_mask-8" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="87.5849462" height="86.8292683" fill="white">
            <use xlink:href="#svg_9a72e01356df98aa1887_path-7" />
        </mask>
        <polygon id="svg_9a72e01356df98aa1887_path-9" points="47.0892058 73.2621951 18.1310647 88.3550373 23.6615776 56.3878845 0.233949287 33.7486212 32.6101353 29.0846764 47.0892058 6.32383035e-15 61.5682764 29.0846764 93.9444624 33.7486212 70.5168341 56.3878845 76.0473469 88.3550373"></polygon>
        <mask id="svg_9a72e01356df98aa1887_mask-10" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="93.7105131" height="88.3550373" fill="white">
            <use xlink:href="#svg_9a72e01356df98aa1887_path-9" />
        </mask>
        <polygon id="svg_9a72e01356df98aa1887_path-11" points="110.575995 32.5609756 132.472231 32.5609756 132.472231 21.7073171 154.368468 43.1420809 132.472231 65.1219512 132.472231 54.2682927 110.575995 54.2682927"></polygon>
        <mask id="svg_9a72e01356df98aa1887_mask-12" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="43.7924731" height="43.4146341" fill="white">
            <use xlink:href="#svg_9a72e01356df98aa1887_path-11" />
        </mask>
        <polygon id="svg_9a72e01356df98aa1887_path-13" points="44.509445 70.2 17.0010952 84.6619953 22.2547225 54.0309977 -1.15019105e-13 32.3380047 30.7552701 27.8690023 44.509445 0 58.2636199 27.8690023 89.0188899 32.3380047 66.7641674 54.0309977 72.0177948 84.6619953"></polygon>
        <mask id="svg_9a72e01356df98aa1887_mask-14" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="89.0188899" height="84.6619953" fill="white">
            <use xlink:href="#svg_9a72e01356df98aa1887_path-13" />
        </mask>
        <rect id="svg_9a72e01356df98aa1887_path-15" x="0" y="0" width="104" height="104" rx="6.4" />
        <mask id="svg_9a72e01356df98aa1887_mask-16" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="104" height="104" fill="white">
            <use xlink:href="#svg_9a72e01356df98aa1887_path-15" />
        </mask>
        <ellipse id="svg_9a72e01356df98aa1887_path-17" cx="41.6" cy="41.6" rx="41.6" ry="41.6"></ellipse>
        <mask id="svg_9a72e01356df98aa1887_mask-18" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="83.2" height="83.2" fill="white">
            <use xlink:href="#svg_9a72e01356df98aa1887_path-17" />
        </mask>
        <rect id="svg_9a72e01356df98aa1887_path-19" x="0" y="0" width="104" height="104" rx="6.4" />
        <mask id="svg_9a72e01356df98aa1887_mask-20" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="104" height="104" fill="white">
            <use xlink:href="#svg_9a72e01356df98aa1887_path-19" />
        </mask>
    </defs>
    <g id="svg_9a72e01356df98aa1887_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_9a72e01356df98aa1887_generic-imap">
            <rect id="svg_9a72e01356df98aa1887_Background" fill="#FFFFFF" x="0" y="0" width="1763" height="360" />
            <g id="svg_9a72e01356df98aa1887_Group-7" transform="translate(606.000000, 92.000000)" stroke="#000000" stroke-width="6.4">
                <use id="svg_9a72e01356df98aa1887_Oval-1" mask="url(#mask-2)" fill="#FFFFFF" xlink:href="#svg_9a72e01356df98aa1887_path-1" />
                <use id="svg_9a72e01356df98aa1887_Star-1" mask="url(#mask-4)" fill="#FFFFFF" xlink:href="#svg_9a72e01356df98aa1887_path-3" />
                <use id="svg_9a72e01356df98aa1887_Path-1" mask="url(#mask-6)" fill="#000000" xlink:href="#svg_9a72e01356df98aa1887_path-5" />
            </g>
            <g id="svg_9a72e01356df98aa1887_Group-7" transform="translate(938.000000, 93.000000)" stroke="#000000" stroke-width="6.4">
                <use id="svg_9a72e01356df98aa1887_Oval-1" mask="url(#mask-8)" fill="#FFFFFF" xlink:href="#svg_9a72e01356df98aa1887_path-7" />
                <use id="svg_9a72e01356df98aa1887_Star-1" mask="url(#mask-10)" fill="#FFFFFF" xlink:href="#svg_9a72e01356df98aa1887_path-9" />
                <use id="svg_9a72e01356df98aa1887_Path-1" mask="url(#mask-12)" fill="#000000" xlink:href="#svg_9a72e01356df98aa1887_path-11" />
            </g>
            <polygon id="svg_9a72e01356df98aa1887_Path-1" fill="#F6A623" points="1241 121 1273 121 1273 105 1305 136.598214 1273 169 1273 153 1241 153"></polygon>
            <text id="svg_9a72e01356df98aa1887_F[A]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="312.6" y="314">F[A]</tspan>
            </text>
            <text id="svg_9a72e01356df98aa1887_F[B]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="1356.6" y="314">F[B]</tspan>
            </text>
            <text id="svg_9a72e01356df98aa1887_A-=&gt;-B" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="683.4" y="314">A =&gt; B</tspan>
            </text>
            <text id="svg_9a72e01356df98aa1887_," font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#F6A623">
                <tspan x="886.4" y="185">,</tspan>
            </text>
            <text id="svg_9a72e01356df98aa1887_B-=&gt;-A" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="983.4" y="314">B =&gt; A</tspan>
            </text>
            <g id="svg_9a72e01356df98aa1887_Group-9" transform="translate(1347.000000, 85.000000)" stroke="#000000" stroke-width="6.4">
                <g id="svg_9a72e01356df98aa1887_Group" transform="translate(7.150000, 9.750000)" fill="#FFFFFF">
                    <use id="svg_9a72e01356df98aa1887_Star-1" mask="url(#mask-14)" xlink:href="#svg_9a72e01356df98aa1887_path-13" />
                </g>
                <use id="svg_9a72e01356df98aa1887_Rectangle-1" mask="url(#mask-16)" xlink:href="#svg_9a72e01356df98aa1887_path-15" />
            </g>
            <g id="svg_9a72e01356df98aa1887_Group-8" transform="translate(307.000000, 85.000000)" stroke="#000000" stroke-width="6.4">
                <g id="svg_9a72e01356df98aa1887_Group-2" transform="translate(10.400000, 12.480000)" fill="#FFFFFF">
                    <use id="svg_9a72e01356df98aa1887_Oval-1" mask="url(#mask-18)" xlink:href="#svg_9a72e01356df98aa1887_path-17" />
                </g>
                <use id="svg_9a72e01356df98aa1887_Rectangle-1" mask="url(#mask-20)" xlink:href="#svg_9a72e01356df98aa1887_path-19" />
            </g>
            <text id="svg_9a72e01356df98aa1887_imap" font-family="FiraMono-Bold, Fira Mono" font-size="51.2" font-weight="bold" fill="#F6A623">
                <tspan x="447.06" y="148">imap</tspan>
            </text>
        </g>
    </g>
</svg>
    <figcaption>Figure 6: Type chart: the imap method</figcaption>
    </figure>
    <p>As an example use case, imagine we have a basic
    <code>Codec[String]</code>, whose <code>encode</code> and
    <code>decode</code> methods both simply return the value they are
    passed:</p>
    <div class="sourceCode" id="cb447"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb447-1"><a href="#cb447-1" aria-hidden="true" tabindex="-1"></a>given stringCodec<span class="op">:</span> <span class="ex">Codec</span><span class="op">[</span><span class="ex">String</span><span class="op">]</span> <span class="kw">with</span> <span class="op">{</span></span>
<span id="cb447-2"><a href="#cb447-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">encode</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">String</span> <span class="op">=</span> value</span>
<span id="cb447-3"><a href="#cb447-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">decode</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">String</span> <span class="op">=</span> value</span>
<span id="cb447-4"><a href="#cb447-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>We can construct many useful <code>Codecs</code> for other types
    by building off of <code>stringCodec</code> using
    <code>imap</code>:</p>
    <div class="sourceCode" id="cb448"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb448-1"><a href="#cb448-1" aria-hidden="true" tabindex="-1"></a>given intCodec<span class="op">:</span> <span class="ex">Codec</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb448-2"><a href="#cb448-2" aria-hidden="true" tabindex="-1"></a>  stringCodec<span class="op">.</span><span class="fu">imap</span><span class="op">(</span>_<span class="op">.</span>toInt<span class="op">,</span> _<span class="op">.</span>toString<span class="op">)</span></span>
<span id="cb448-3"><a href="#cb448-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb448-4"><a href="#cb448-4" aria-hidden="true" tabindex="-1"></a>given booleanCodec<span class="op">:</span> <span class="ex">Codec</span><span class="op">[</span><span class="ex">Boolean</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb448-5"><a href="#cb448-5" aria-hidden="true" tabindex="-1"></a>  stringCodec<span class="op">.</span><span class="fu">imap</span><span class="op">(</span>_<span class="op">.</span>toBoolean<span class="op">,</span> _<span class="op">.</span>toString<span class="op">)</span></span></code></pre></div>
    <div class="callout callout-info">
    <p><em>Coping with Failure</em></p>
    <p>Note that the <code>decode</code> method of our
    <code>Codec</code> type class doesn’t account for failures. If we
    want to model more sophisticated relationships we can move beyond
    functors to look at <em>lenses</em> and <em>optics</em>.</p>
    <p>Optics are beyond the scope of this book. However, Julien
    Truffaut’s library <a href="https://github.com/optics-dev/Monocle">Monocle</a> provides a
    great starting point for further investigation.</p>
    </div>
    <h4 data-number="8.6.2.1" id="transformative-thinking-with-imap"><span class="header-section-number">8.6.2.1</span> Transformative Thinking
    with <em>imap</em></h4>
    <p>Implement the <code>imap</code> method for <code>Codec</code>
    above.</p>
    <div class="solution">
    <p>Here’s a working implementation:</p>
    <div class="sourceCode" id="cb449"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb449-1"><a href="#cb449-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> <span class="ex">Codec</span><span class="op">[</span>A<span class="op">]</span> <span class="op">{</span> self <span class="op">=&gt;</span></span>
<span id="cb449-2"><a href="#cb449-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">encode</span><span class="op">(</span>value<span class="op">:</span> A<span class="op">):</span> <span class="ex">String</span></span>
<span id="cb449-3"><a href="#cb449-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">decode</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> A</span>
<span id="cb449-4"><a href="#cb449-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb449-5"><a href="#cb449-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> imap<span class="op">[</span>B<span class="op">](</span>dec<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">,</span> enc<span class="op">:</span> B <span class="op">=&gt;</span> A<span class="op">):</span> <span class="ex">Codec</span><span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb449-6"><a href="#cb449-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="ex">Codec</span><span class="op">[</span>B<span class="op">]</span> <span class="op">{</span></span>
<span id="cb449-7"><a href="#cb449-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> <span class="fu">encode</span><span class="op">(</span>value<span class="op">:</span> B<span class="op">):</span> <span class="ex">String</span> <span class="op">=</span></span>
<span id="cb449-8"><a href="#cb449-8" aria-hidden="true" tabindex="-1"></a>        self<span class="op">.</span><span class="fu">encode</span><span class="op">(</span><span class="fu">enc</span><span class="op">(</span>value<span class="op">))</span></span>
<span id="cb449-9"><a href="#cb449-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb449-10"><a href="#cb449-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">def</span> <span class="fu">decode</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> B <span class="op">=</span></span>
<span id="cb449-11"><a href="#cb449-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">dec</span><span class="op">(</span>self<span class="op">.</span><span class="fu">decode</span><span class="op">(</span>value<span class="op">))</span></span>
<span id="cb449-12"><a href="#cb449-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb449-13"><a href="#cb449-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb449-14"><a href="#cb449-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    </div>
    <p>Demonstrate your <code>imap</code> method works by creating a
    <code>Codec</code> for <code>Double</code>.</p>
    <div class="solution">
    <p>We can implement this using the <code>imap</code> method of
    <code>stringCodec</code>:</p>
    <div class="sourceCode" id="cb450"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb450-1"><a href="#cb450-1" aria-hidden="true" tabindex="-1"></a>given doubleCodec<span class="op">:</span> <span class="ex">Codec</span><span class="op">[</span><span class="ex">Double</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb450-2"><a href="#cb450-2" aria-hidden="true" tabindex="-1"></a>  stringCodec<span class="op">.</span>imap<span class="op">[</span><span class="ex">Double</span><span class="op">](</span>_<span class="op">.</span>toDouble<span class="op">,</span> _<span class="op">.</span>toString<span class="op">)</span></span></code></pre></div>
    </div>
    <p>Finally, implement a <code>Codec</code> for the following
    <code>Box</code> type:</p>
    <div class="sourceCode" id="cb451"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb451-1"><a href="#cb451-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="ex">Box</span><span class="op">[</span>A<span class="op">](</span>value<span class="op">:</span> A<span class="op">)</span></span></code></pre></div>
    <div class="solution">
    <p>We need a generic <code>Codec</code> for <code>Box[A]</code> for
    any given <code>A</code>. We create this by calling
    <code>imap</code> on a <code>Codec[A]</code>, which we bring into
    scope using an implicit parameter:</p>
    <div class="sourceCode" id="cb452"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb452-1"><a href="#cb452-1" aria-hidden="true" tabindex="-1"></a>given boxCodec<span class="op">[</span>A<span class="op">](</span>using c<span class="op">:</span> <span class="ex">Codec</span><span class="op">[</span>A<span class="op">]):</span> <span class="ex">Codec</span><span class="op">[</span><span class="ex">Box</span><span class="op">[</span>A<span class="op">]]</span> <span class="op">=</span></span>
<span id="cb452-2"><a href="#cb452-2" aria-hidden="true" tabindex="-1"></a>  c<span class="op">.</span>imap<span class="op">[</span><span class="ex">Box</span><span class="op">[</span>A<span class="op">]](</span><span class="ex">Box</span><span class="op">(</span>_<span class="op">),</span> _<span class="op">.</span>value<span class="op">)</span></span></code></pre></div>
    </div>
    <p>Your instances should work as follows:</p>
    <div class="sourceCode" id="cb453"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb453-1"><a href="#cb453-1" aria-hidden="true" tabindex="-1"></a><span class="fu">encode</span><span class="op">(</span><span class="fl">123.4</span><span class="op">)</span></span>
<span id="cb453-2"><a href="#cb453-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res11: String = &quot;123.4&quot;</span></span>
<span id="cb453-3"><a href="#cb453-3" aria-hidden="true" tabindex="-1"></a>decode<span class="op">[</span><span class="ex">Double</span><span class="op">](</span><span class="st">&quot;123.4&quot;</span><span class="op">)</span></span>
<span id="cb453-4"><a href="#cb453-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res12: Double = 123.4</span></span>
<span id="cb453-5"><a href="#cb453-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb453-6"><a href="#cb453-6" aria-hidden="true" tabindex="-1"></a><span class="fu">encode</span><span class="op">(</span><span class="ex">Box</span><span class="op">(</span><span class="fl">123.4</span><span class="op">))</span></span>
<span id="cb453-7"><a href="#cb453-7" aria-hidden="true" tabindex="-1"></a><span class="co">// res13: String = &quot;123.4&quot;</span></span>
<span id="cb453-8"><a href="#cb453-8" aria-hidden="true" tabindex="-1"></a>decode<span class="op">[</span><span class="ex">Box</span><span class="op">[</span><span class="ex">Double</span><span class="op">]](</span><span class="st">&quot;123.4&quot;</span><span class="op">)</span></span>
<span id="cb453-9"><a href="#cb453-9" aria-hidden="true" tabindex="-1"></a><span class="co">// res14: Box[Double] = Box(value = 123.4)</span></span></code></pre></div>
    <div class="callout callout-warning">
    <p><em>What’s With the Names?</em></p>
    <p>What’s the relationship between the terms “contravariance”,
    “invariance”, and “covariance” and these different kinds of
    functor?</p>
    <p>If you recall from Section 4.6.1, variance affects subtyping,
    which is essentially our ability to use a value of one type in place
    of a value of another type without breaking the code.</p>
    <p>Subtyping can be viewed as a conversion. If <code>B</code> is a
    subtype of <code>A</code>, we can always convert a <code>B</code> to
    an <code>A</code>.</p>
    <p>Equivalently we could say that <code>B</code> is a subtype of
    <code>A</code> if there exists a function <code>B =&gt; A</code>. A
    standard covariant functor captures exactly this. If <code>F</code>
    is a covariant functor, wherever we have an <code>F[B]</code> and a
    conversion <code>B =&gt; A</code> we can always convert to an
    <code>F[A]</code>.</p>
    <p>A contravariant functor captures the opposite case. If
    <code>F</code> is a contravariant functor, whenever we have a
    <code>F[A]</code> and a conversion <code>B =&gt; A</code> we can
    convert to an <code>F[B]</code>.</p>
    <p>Finally, invariant functors capture the case where we can convert
    from <code>F[A]</code> to <code>F[B]</code> via a function
    <code>A =&gt; B</code> and vice versa via a function
    <code>B =&gt; A</code>.</p>
    </div>
    <h2 data-number="8.7" id="contravariant-and-invariant-in-cats"><span class="header-section-number">8.7</span> Contravariant and Invariant
    in Cats</h2>
    <p>Let’s look at the implementation of contravariant and invariant
    functors in Cats, provided by the <a href="http://typelevel.org/cats/api/cats/Contravariant.html"><code>cats.Contravariant</code></a>
    and <a href="http://typelevel.org/cats/api/cats/Invariant.html"><code>cats.Invariant</code></a>
    type classes respectively. Here’s a simplified version of the
    code:</p>
    <div class="sourceCode" id="cb454"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb454-1"><a href="#cb454-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Contravariant<span class="op">[</span>F<span class="op">[</span>_<span class="op">]]</span> <span class="op">{</span></span>
<span id="cb454-2"><a href="#cb454-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> contramap<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>fa<span class="op">:</span> F<span class="op">[</span>A<span class="op">])(</span>f<span class="op">:</span> B <span class="op">=&gt;</span> A<span class="op">):</span> F<span class="op">[</span>B<span class="op">]</span></span>
<span id="cb454-3"><a href="#cb454-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb454-4"><a href="#cb454-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb454-5"><a href="#cb454-5" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Invariant<span class="op">[</span>F<span class="op">[</span>_<span class="op">]]</span> <span class="op">{</span></span>
<span id="cb454-6"><a href="#cb454-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> imap<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>fa<span class="op">:</span> F<span class="op">[</span>A<span class="op">])(</span>f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">)(</span>g<span class="op">:</span> B <span class="op">=&gt;</span> A<span class="op">):</span> F<span class="op">[</span>B<span class="op">]</span></span>
<span id="cb454-7"><a href="#cb454-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <h3 data-number="8.7.1" id="contravariant-in-cats"><span class="header-section-number">8.7.1</span> Contravariant in
    Cats</h3>
    <p>We can summon instances of <code>Contravariant</code> using the
    <code>Contravariant.apply</code> method. Cats provides instances for
    data types that consume parameters, including <code>Eq</code>,
    <code>Show</code>, and <code>Function1</code>. Here’s an
    example:</p>
    <div class="sourceCode" id="cb455"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb455-1"><a href="#cb455-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.*</span></span>
<span id="cb455-2"><a href="#cb455-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb455-3"><a href="#cb455-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> showString <span class="op">=</span> Show<span class="op">[</span><span class="ex">String</span><span class="op">]</span></span>
<span id="cb455-4"><a href="#cb455-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb455-5"><a href="#cb455-5" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> showSymbol <span class="op">=</span> Contravariant<span class="op">[</span>Show<span class="op">].</span></span>
<span id="cb455-6"><a href="#cb455-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">contramap</span><span class="op">(</span>showString<span class="op">)((</span>sym<span class="op">:</span> <span class="bu">Symbol</span><span class="op">)</span> <span class="op">=&gt;</span> <span class="ss">s&quot;</span><span class="st">&#39;</span><span class="ss">${</span>sym<span class="op">.</span>name<span class="ss">}&quot;</span><span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb456"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb456-1"><a href="#cb456-1" aria-hidden="true" tabindex="-1"></a>showSymbol<span class="op">.</span><span class="fu">show</span><span class="op">(</span><span class="bu">Symbol</span><span class="op">(</span><span class="st">&quot;dave&quot;</span><span class="op">))</span></span>
<span id="cb456-2"><a href="#cb456-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: String = &quot;&#39;dave&quot;</span></span></code></pre></div>
    <p>More conveniently, we can use <a href="http://typelevel.org/cats/api/cats/syntax/package$$contravariant$"><code>cats.syntax.contravariant</code></a>,
    which provides a <code>contramap</code> extension method:</p>
    <div class="sourceCode" id="cb457"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb457-1"><a href="#cb457-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>contravariant<span class="op">.*</span> <span class="co">// for contramap</span></span></code></pre></div>
    <div class="sourceCode" id="cb458"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb458-1"><a href="#cb458-1" aria-hidden="true" tabindex="-1"></a>showString</span>
<span id="cb458-2"><a href="#cb458-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span>contramap<span class="op">[</span><span class="bu">Symbol</span><span class="op">](</span>sym <span class="op">=&gt;</span> <span class="ss">s&quot;</span><span class="st">&#39;</span><span class="ss">${</span>sym<span class="op">.</span>name<span class="ss">}&quot;</span><span class="op">)</span></span>
<span id="cb458-3"><a href="#cb458-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">show</span><span class="op">(</span><span class="bu">Symbol</span><span class="op">(</span><span class="st">&quot;dave&quot;</span><span class="op">))</span></span>
<span id="cb458-4"><a href="#cb458-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: String = &quot;&#39;dave&quot;</span></span></code></pre></div>
    <h3 data-number="8.7.2" id="invariant-in-cats"><span class="header-section-number">8.7.2</span> Invariant in Cats</h3>
    <p>Among other types, Cats provides an instance of
    <code>Invariant</code> for <code>Monoid</code>. This is a little
    different from the <code>Codec</code> example we introduced in
    Section 8.6.2. If you recall, this is what <code>Monoid</code> looks
    like:</p>
    <div class="sourceCode" id="cb459"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb459-1"><a href="#cb459-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> cats</span>
<span id="cb459-2"><a href="#cb459-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb459-3"><a href="#cb459-3" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Monoid<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb459-4"><a href="#cb459-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> empty<span class="op">:</span> A</span>
<span id="cb459-5"><a href="#cb459-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">combine</span><span class="op">(</span>x<span class="op">:</span> A<span class="op">,</span> y<span class="op">:</span> A<span class="op">):</span> A</span>
<span id="cb459-6"><a href="#cb459-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Imagine we want to produce a <code>Monoid</code> for Scala’s <a href="https://www.scala-lang.org/api/3.3.3/scala/Symbol.html#"><code>Symbol</code></a>
    type. Cats doesn’t provide a <code>Monoid</code> for
    <code>Symbol</code> but it does provide a <code>Monoid</code> for a
    similar type: <code>String</code>. We can write our new semigroup
    with an <code>empty</code> method that relies on the empty
    <code>String</code>, and a <code>combine</code> method that works as
    follows:</p>
    <ol type="1">
    <li>accept two <code>Symbols</code> as parameters;</li>
    <li>convert the <code>Symbols</code> to <code>Strings</code>;</li>
    <li>combine the <code>Strings</code> using
    <code>Monoid[String]</code>;</li>
    <li>convert the result back to a <code>Symbol</code>.</li>
    </ol>
    <p>We can implement <code>combine</code> using <code>imap</code>,
    passing functions of type <code>String =&gt; Symbol</code> and
    <code>Symbol =&gt; String</code> as parameters. Here’ the code,
    written out using the <code>imap</code> extension method provided by
    <code>cats.syntax.invariant</code>:</p>
    <div class="sourceCode" id="cb460"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb460-1"><a href="#cb460-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.*</span></span>
<span id="cb460-2"><a href="#cb460-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>invariant<span class="op">.*</span> <span class="co">// for imap</span></span>
<span id="cb460-3"><a href="#cb460-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>semigroup<span class="op">.*</span> <span class="co">// for |+|</span></span>
<span id="cb460-4"><a href="#cb460-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb460-5"><a href="#cb460-5" aria-hidden="true" tabindex="-1"></a>given symbolMonoid<span class="op">:</span> Monoid<span class="op">[</span><span class="bu">Symbol</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb460-6"><a href="#cb460-6" aria-hidden="true" tabindex="-1"></a>  Monoid<span class="op">[</span><span class="ex">String</span><span class="op">].</span><span class="fu">imap</span><span class="op">(</span><span class="bu">Symbol</span><span class="op">.</span>apply<span class="op">)(</span>_<span class="op">.</span>name<span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb461"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb461-1"><a href="#cb461-1" aria-hidden="true" tabindex="-1"></a>Monoid<span class="op">[</span><span class="bu">Symbol</span><span class="op">].</span>empty</span>
<span id="cb461-2"><a href="#cb461-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: Symbol = &#39;</span></span>
<span id="cb461-3"><a href="#cb461-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb461-4"><a href="#cb461-4" aria-hidden="true" tabindex="-1"></a><span class="bu">Symbol</span><span class="op">(</span><span class="st">&quot;a&quot;</span><span class="op">)</span> <span class="op">|+|</span> <span class="bu">Symbol</span><span class="op">(</span><span class="st">&quot;few&quot;</span><span class="op">)</span> <span class="op">|+|</span> <span class="bu">Symbol</span><span class="op">(</span><span class="st">&quot;words&quot;</span><span class="op">)</span></span>
<span id="cb461-5"><a href="#cb461-5" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: Symbol = &#39;afewwords</span></span></code></pre></div>
    <h2 data-number="8.8" id="sec:functors:partial-unification"><span class="header-section-number">8.8</span> Aside: Partial
    Unification</h2>
    <p>In Section 8.2 we saw a functor instance for
    <code>Function1</code>.</p>
    <div class="sourceCode" id="cb462"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb462-1"><a href="#cb462-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.*</span></span>
<span id="cb462-2"><a href="#cb462-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>functor<span class="op">.*</span>     <span class="co">// for map</span></span>
<span id="cb462-3"><a href="#cb462-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb462-4"><a href="#cb462-4" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> func1 <span class="op">=</span> <span class="op">(</span>x<span class="op">:</span> <span class="bu">Int</span><span class="op">)</span>    <span class="op">=&gt;</span> x<span class="op">.</span>toDouble</span>
<span id="cb462-5"><a href="#cb462-5" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> func2 <span class="op">=</span> <span class="op">(</span>y<span class="op">:</span> <span class="ex">Double</span><span class="op">)</span> <span class="op">=&gt;</span> y <span class="op">*</span> <span class="dv">2</span></span></code></pre></div>
    <div class="sourceCode" id="cb463"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb463-1"><a href="#cb463-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> func3 <span class="op">=</span> func1<span class="op">.</span><span class="fu">map</span><span class="op">(</span>func2<span class="op">)</span></span>
<span id="cb463-2"><a href="#cb463-2" aria-hidden="true" tabindex="-1"></a><span class="co">// func3: Function1[Int, Double] = cats.instances.Function1Instances0$$anon$11$$Lambda/0x00007fcce2e7cad0@3266aceb</span></span></code></pre></div>
    <p><code>Function1</code> has two type parameters (the function
    argument and the result type):</p>
    <div class="sourceCode" id="cb464"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb464-1"><a href="#cb464-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Function1<span class="op">[-</span>A<span class="op">,</span> <span class="op">+</span>B<span class="op">]</span> <span class="op">{</span></span>
<span id="cb464-2"><a href="#cb464-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>arg<span class="op">:</span> A<span class="op">):</span> B</span>
<span id="cb464-3"><a href="#cb464-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>However, <code>Functor</code> accepts a type constructor with one
    parameter:</p>
    <div class="sourceCode" id="cb465"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb465-1"><a href="#cb465-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Functor<span class="op">[</span>F<span class="op">[</span>_<span class="op">]]</span> <span class="op">{</span></span>
<span id="cb465-2"><a href="#cb465-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>fa<span class="op">:</span> F<span class="op">[</span>A<span class="op">])(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> F<span class="op">[</span>B<span class="op">]</span></span>
<span id="cb465-3"><a href="#cb465-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>The compiler has to fix one of the two parameters of
    <code>Function1</code> to create a type constructor of the correct
    kind to pass to <code>Functor</code>. It has two options to choose
    from:</p>
    <div class="sourceCode" id="cb466"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb466-1"><a href="#cb466-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> F<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> <span class="bu">Int</span> <span class="op">=&gt;</span> A</span>
<span id="cb466-2"><a href="#cb466-2" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> F<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> A <span class="op">=&gt;</span> <span class="ex">Double</span></span></code></pre></div>
    <p><em>We</em> know that the former of these is the correct choice.
    However the compiler doesn’t understand what the code means. Instead
    it relies on a simple rule, implementing what is called “partial
    unification”.</p>
    <p>The partial unification in the Scala compiler works by fixing
    type parameters from left to right. In the above example, the
    compiler fixes the <code>Int</code> in <code>Int =&gt; Double</code>
    and looks for a <code>Functor</code> for functions of type
    <code>Int =&gt; ?</code>:</p>
    <div class="sourceCode" id="cb467"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb467-1"><a href="#cb467-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> F<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> <span class="bu">Int</span> <span class="op">=&gt;</span> A</span>
<span id="cb467-2"><a href="#cb467-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb467-3"><a href="#cb467-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> functor <span class="op">=</span> Functor<span class="op">[</span>F<span class="op">]</span></span></code></pre></div>
    <p>This left-to-right elimination works for a wide variety of common
    scenarios, including <code>Functors</code> for types such as
    <code>Function1</code> and <code>Either</code>:</p>
    <div class="sourceCode" id="cb468"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb468-1"><a href="#cb468-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> either<span class="op">:</span> Either<span class="op">[</span><span class="ex">String</span><span class="op">,</span> <span class="bu">Int</span><span class="op">]</span> <span class="op">=</span> <span class="fu">Right</span><span class="op">(</span><span class="dv">123</span><span class="op">)</span></span>
<span id="cb468-2"><a href="#cb468-2" aria-hidden="true" tabindex="-1"></a><span class="co">// either: Either[String, Int] = Right(value = 123)</span></span>
<span id="cb468-3"><a href="#cb468-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb468-4"><a href="#cb468-4" aria-hidden="true" tabindex="-1"></a>either<span class="op">.</span><span class="fu">map</span><span class="op">(</span>_ <span class="op">+</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb468-5"><a href="#cb468-5" aria-hidden="true" tabindex="-1"></a><span class="co">// res0: Either[String, Int] = Right(value = 124)</span></span></code></pre></div>
    <div class="callout callout-warning">
    <p>Partial unification is the default behaviour in Scala 2.13. In
    earlier versions of Scala we need to add the
    <code>-Ypartial-unification</code> compiler flag. In sbt we would
    add the compiler flag in <code>build.sbt</code>:</p>
    <div class="sourceCode" id="cb469"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb469-1"><a href="#cb469-1" aria-hidden="true" tabindex="-1"></a>scalacOptions <span class="op">+=</span> <span class="st">&quot;-Ypartial-unification&quot;</span></span></code></pre></div>
    <p>The rationale behind this change is discussed in <a href="https://issues.scala-lang.org/browse/SI-2712">SI-2712</a>.</p>
    </div>
    <h3 data-number="8.8.1" id="limitations-of-partial-unification"><span class="header-section-number">8.8.1</span> Limitations of Partial
    Unification</h3>
    <p>There are situations where left-to-right elimination is not the
    correct choice. One example is the <code>Or</code> type in <a href="http://scalactic.org">Scalactic</a>, which is a conventionally
    left-biased equivalent of <code>Either</code>:</p>
    <div class="sourceCode" id="cb470"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb470-1"><a href="#cb470-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> PossibleResult <span class="op">=</span> ActualResult Or <span class="ex">Error</span></span></code></pre></div>
    <p>Another example is the <code>Contravariant</code> functor for
    <code>Function1</code>.</p>
    <p>While the covariant <code>Functor</code> for
    <code>Function1</code> implements <code>andThen</code>-style
    left-to-right function composition, the <code>Contravariant</code>
    functor implements <code>compose</code>-style right-to-left
    composition. In other words, the following expressions are all
    equivalent:</p>
    <div class="sourceCode" id="cb471"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb471-1"><a href="#cb471-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> func3a<span class="op">:</span> <span class="bu">Int</span> <span class="op">=&gt;</span> <span class="ex">Double</span> <span class="op">=</span></span>
<span id="cb471-2"><a href="#cb471-2" aria-hidden="true" tabindex="-1"></a>  a <span class="op">=&gt;</span> <span class="fu">func2</span><span class="op">(</span><span class="fu">func1</span><span class="op">(</span>a<span class="op">))</span></span>
<span id="cb471-3"><a href="#cb471-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb471-4"><a href="#cb471-4" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> func3b<span class="op">:</span> <span class="bu">Int</span> <span class="op">=&gt;</span> <span class="ex">Double</span> <span class="op">=</span></span>
<span id="cb471-5"><a href="#cb471-5" aria-hidden="true" tabindex="-1"></a>  func2<span class="op">.</span><span class="fu">compose</span><span class="op">(</span>func1<span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb472"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb472-1"><a href="#cb472-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Hypothetical example. This won&#39;t actually compile:</span></span>
<span id="cb472-2"><a href="#cb472-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> func3c<span class="op">:</span> <span class="bu">Int</span> <span class="op">=&gt;</span> <span class="ex">Double</span> <span class="op">=</span></span>
<span id="cb472-3"><a href="#cb472-3" aria-hidden="true" tabindex="-1"></a>  func2<span class="op">.</span><span class="fu">contramap</span><span class="op">(</span>func1<span class="op">)</span></span></code></pre></div>
    <p>If we try this for real, however, our code won’t compile:</p>
    <div class="sourceCode" id="cb473"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb473-1"><a href="#cb473-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>contravariant<span class="op">.*</span> <span class="co">// for contramap</span></span></code></pre></div>
    <div class="sourceCode" id="cb474"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb474-1"><a href="#cb474-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> func3c <span class="op">=</span> func2<span class="op">.</span><span class="fu">contramap</span><span class="op">(</span>func1<span class="op">)</span></span>
<span id="cb474-2"><a href="#cb474-2" aria-hidden="true" tabindex="-1"></a><span class="co">// error:</span></span>
<span id="cb474-3"><a href="#cb474-3" aria-hidden="true" tabindex="-1"></a><span class="co">// value contramap is not a member of Double =&gt; Double.</span></span>
<span id="cb474-4"><a href="#cb474-4" aria-hidden="true" tabindex="-1"></a><span class="co">// An extension method was tried, but could not be fully constructed:</span></span>
<span id="cb474-5"><a href="#cb474-5" aria-hidden="true" tabindex="-1"></a><span class="co">// </span></span>
<span id="cb474-6"><a href="#cb474-6" aria-hidden="true" tabindex="-1"></a><span class="co">//     cats.syntax.contravariant.toContravariantOps[[R] =&gt;&gt; Double =&gt; R, A](</span></span>
<span id="cb474-7"><a href="#cb474-7" aria-hidden="true" tabindex="-1"></a><span class="co">//       repl.MdocSession.MdocApp.func2)(</span></span>
<span id="cb474-8"><a href="#cb474-8" aria-hidden="true" tabindex="-1"></a><span class="co">//       cats.Invariant.catsContravariantForFunction1[R])</span></span>
<span id="cb474-9"><a href="#cb474-9" aria-hidden="true" tabindex="-1"></a><span class="co">// val func3c = func2.contramap(func1)</span></span>
<span id="cb474-10"><a href="#cb474-10" aria-hidden="true" tabindex="-1"></a><span class="co">//              ^^^^^^^^^^^^^^^</span></span></code></pre></div>
    <p>The problem here is that the <code>Contravariant</code> for
    <code>Function1</code> fixes the return type and leaves the
    parameter type varying, requiring the compiler to eliminate type
    parameters from right to left, as shown below and in Figure 7:</p>
    <div class="sourceCode" id="cb475"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb475-1"><a href="#cb475-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> F<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> A <span class="op">=&gt;</span> <span class="ex">Double</span></span></code></pre></div>
    <figure id="fig:functors:function-contramap-type-chart">
    <svg id="svg_f3f7c5eb63b151923f19" alt="Type chart: contramapping over a Function1" width="1761px" height="325px" viewBox="0 0 1761 325">
    <!-- Generator: Sketch 43.2 (39069) - http://www.bohemiancoding.com/sketch -->
    <title>function-contramap</title>
    <desc>Created with Sketch.</desc>
    <defs>
        <ellipse id="svg_f3f7c5eb63b151923f19_path-1" cx="248.403653" cy="56.5337423" rx="51.403653" ry="51.5337423"></ellipse>
        <polygon id="svg_f3f7c5eb63b151923f19_path-2" points="124.372306 41.2944785 150.074132 41.2944785 150.074132 28.4110429 175.775959 53.8543899 150.074132 79.9447853 150.074132 67.0613497 124.372306 67.0613497"></polygon>
        <ellipse id="svg_f3f7c5eb63b151923f19_path-3" cx="51.403653" cy="52.1779141" rx="51.403653" ry="51.5337423"></ellipse>
        <polygon id="svg_f3f7c5eb63b151923f19_path-4" points="245.480898 86.9631902 211.4898 104.878593 217.981522 66.9331613 190.482146 40.0600577 228.485349 34.5238939 245.480898 0 262.476447 34.5238939 300.479649 40.0600577 272.980273 66.9331613 279.471995 104.878593"></polygon>
        <polygon id="svg_f3f7c5eb63b151923f19_path-5" points="122.372306 39.2944785 148.074132 39.2944785 148.074132 26.4110429 173.775959 51.8543899 148.074132 77.9447853 148.074132 65.0613497 122.372306 65.0613497"></polygon>
        <polygon id="svg_f3f7c5eb63b151923f19_path-6" points="254.480898 87.9631902 220.4898 105.878593 226.981522 67.9331613 199.482146 41.0600577 237.485349 35.5238939 254.480898 1 271.476447 35.5238939 309.479649 41.0600577 281.980273 67.9331613 288.471995 105.878593"></polygon>
        <polygon id="svg_f3f7c5eb63b151923f19_path-7" points="131.372306 40.2944785 157.074132 40.2944785 157.074132 27.4110429 182.775959 52.8543899 157.074132 78.9447853 157.074132 66.0613497 131.372306 66.0613497"></polygon>
    </defs>
    <g id="svg_f3f7c5eb63b151923f19_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_f3f7c5eb63b151923f19_function-contramap">
            <rect id="svg_f3f7c5eb63b151923f19_Background" fill="#FFFFFF" x="0" y="0" width="1761" height="325" />
            <g id="svg_f3f7c5eb63b151923f19_Group-5" transform="translate(203.000000, 51.000000)">
                <g id="svg_f3f7c5eb63b151923f19_Oval-1">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_f3f7c5eb63b151923f19_path-1" />
                    <ellipse stroke="#000000" stroke-width="4" cx="248.403653" cy="56.5337423" rx="49.403653" ry="49.5337423"></ellipse>
                </g>
                <g id="svg_f3f7c5eb63b151923f19_Path-1">
                    <use fill="#000000" fill-rule="evenodd" xlink:href="#svg_f3f7c5eb63b151923f19_path-2" />
                    <path stroke="#000000" stroke-width="4" d="M126.372306,43.2944785 L150.074132,43.2944785 L152.074132,43.2944785 L152.074132,41.2944785 L152.074132,33.2051698 L172.951044,53.8721251 L152.074132,75.0646607 L152.074132,67.0613497 L152.074132,65.0613497 L150.074132,65.0613497 L126.372306,65.0613497 L126.372306,43.2944785 Z" />
                </g>
                <polygon id="svg_f3f7c5eb63b151923f19_Polygon" stroke="#000000" stroke-width="4" points="53 0.0658617424 105.339263 38.0925622 85.3474435 99.621056 20.6525565 99.621056 0.66073703 38.0925622"></polygon>
            </g>
            <g id="svg_f3f7c5eb63b151923f19_Group-5" transform="translate(817.000000, 53.000000)">
                <g id="svg_f3f7c5eb63b151923f19_Oval-1">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_f3f7c5eb63b151923f19_path-3" />
                    <ellipse stroke="#000000" stroke-width="4" cx="51.403653" cy="52.1779141" rx="49.403653" ry="49.5337423"></ellipse>
                </g>
                <g id="svg_f3f7c5eb63b151923f19_Star-1">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_f3f7c5eb63b151923f19_path-4" />
                    <path stroke="#000000" stroke-width="4" d="M214.145059,101.218317 L219.952881,67.2704223 L220.129827,66.2361355 L219.379354,65.5027535 L194.772382,41.4561824 L228.773658,36.5030042 L229.814949,36.3513128 L230.279707,35.4072272 L245.480898,4.52830184 L260.682088,35.4072272 L261.146846,36.3513128 L262.188137,36.5030042 L296.189413,41.4561824 L271.582442,65.5027535 L270.831968,66.2361355 L271.008915,67.2704223 L276.816736,101.218317 L246.413424,85.1938979 L245.480898,84.7023992 L244.548372,85.1938979 L214.145059,101.218317 Z" />
                </g>
                <g id="svg_f3f7c5eb63b151923f19_Path-1">
                    <use fill="#000000" fill-rule="evenodd" xlink:href="#svg_f3f7c5eb63b151923f19_path-5" />
                    <path stroke="#000000" stroke-width="4" d="M124.372306,41.2944785 L148.074132,41.2944785 L150.074132,41.2944785 L150.074132,39.2944785 L150.074132,31.2051698 L170.951044,51.8721251 L150.074132,73.0646607 L150.074132,65.0613497 L150.074132,63.0613497 L148.074132,63.0613497 L124.372306,63.0613497 L124.372306,41.2944785 Z" />
                </g>
            </g>
            <g id="svg_f3f7c5eb63b151923f19_Group-6" transform="translate(1258.000000, 52.000000)">
                <g id="svg_f3f7c5eb63b151923f19_Star-1">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_f3f7c5eb63b151923f19_path-6" />
                    <path stroke="#000000" stroke-width="4" d="M223.145059,102.218317 L228.952881,68.2704223 L229.129827,67.2361355 L228.379354,66.5027535 L203.772382,42.4561824 L237.773658,37.5030042 L238.814949,37.3513128 L239.279707,36.4072272 L254.480898,5.52830184 L269.682088,36.4072272 L270.146846,37.3513128 L271.188137,37.5030042 L305.189413,42.4561824 L280.582442,66.5027535 L279.831968,67.2361355 L280.008915,68.2704223 L285.816736,102.218317 L255.413424,86.1938979 L254.480898,85.7023992 L253.548372,86.1938979 L223.145059,102.218317 Z" />
                </g>
                <g id="svg_f3f7c5eb63b151923f19_Path-1">
                    <use fill="#000000" fill-rule="evenodd" xlink:href="#svg_f3f7c5eb63b151923f19_path-7" />
                    <path stroke="#000000" stroke-width="4" d="M133.372306,42.2944785 L157.074132,42.2944785 L159.074132,42.2944785 L159.074132,40.2944785 L159.074132,32.2051698 L179.951044,52.8721251 L159.074132,74.0646607 L159.074132,66.0613497 L159.074132,64.0613497 L157.074132,64.0613497 L133.372306,64.0613497 L133.372306,42.2944785 Z" />
                </g>
                <polygon id="svg_f3f7c5eb63b151923f19_Polygon" stroke="#000000" stroke-width="4" points="52.6785259 0.853169549 105.357052 39.126359 85.2356454 101.05368 20.1214064 101.05368 -6.39488462e-14 39.126359"></polygon>
            </g>
            <polygon id="svg_f3f7c5eb63b151923f19_Path-1" fill="#F6A623" points="1154 85 1194 85 1194 65 1234 104.497767 1194 145 1194 125 1154 125"></polygon>
            <text id="svg_f3f7c5eb63b151923f19_A-=&gt;-X" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="272.4" y="282">A =&gt; X</tspan>
            </text>
            <text id="svg_f3f7c5eb63b151923f19_B-=&gt;-X" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="1343.4" y="282">B =&gt; X</tspan>
            </text>
            <text id="svg_f3f7c5eb63b151923f19_B-=&gt;-A" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="890.4" y="282">B =&gt; A</tspan>
            </text>
            <text id="svg_f3f7c5eb63b151923f19_contramap" font-family="FiraMono-Bold, Fira Mono" font-size="51.2000008" font-weight="bold" fill="#F6A623">
                <tspan x="517.759998" y="123">contramap</tspan>
            </text>
        </g>
    </g>
</svg>
    <figcaption>Figure 7: Type chart: contramapping over a
    Function1</figcaption>
    </figure>
    <p>The compiler fails simply because of its left-to-right bias. We
    can prove this by creating a type alias that flips the parameters on
    Function1:</p>
    <div class="sourceCode" id="cb476"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb476-1"><a href="#cb476-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="op">&lt;=[</span>B<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span> A <span class="op">=&gt;</span> B</span></code></pre></div>
    <div class="sourceCode" id="cb477"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb477-1"><a href="#cb477-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> F<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> <span class="ex">Double</span> <span class="op">&lt;=</span> A</span></code></pre></div>
    <p>If we re-type <code>func2</code> as an instance of
    <code>&lt;=</code>, we reset the required order of elimination and
    we can call <code>contramap</code> as desired:</p>
    <div class="sourceCode" id="cb478"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb478-1"><a href="#cb478-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> func2b<span class="op">:</span> <span class="ex">Double</span> <span class="op">&lt;=</span> <span class="ex">Double</span> <span class="op">=</span> func2</span></code></pre></div>
    <div class="sourceCode" id="cb479"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb479-1"><a href="#cb479-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> func3c <span class="op">=</span> func2b<span class="op">.</span><span class="fu">contramap</span><span class="op">(</span>func1<span class="op">)</span></span>
<span id="cb479-2"><a href="#cb479-2" aria-hidden="true" tabindex="-1"></a><span class="co">// func3c: Function1[Int, Double] = scala.Function1$$Lambda/0x00007fcce2e89f88@711868e6</span></span></code></pre></div>
    <p>The difference between <code>func2</code> and <code>func2b</code>
    is purely syntactic—both refer to the same value and the type
    aliases are otherwise completely compatible. Incredibly, however,
    this simple rephrasing is enough to give the compiler the hint it
    needs to solve the problem.</p>
    <p>It is rare that we have to do this kind of right-to-left
    elimination. Most multi-parameter type constructors are designed to
    be right-biased, requiring the left-to-right elimination that is
    supported by the compiler out of the box. However, it is useful to
    know about this quirk of elimination order in case you ever come
    across an odd scenario like the one above.</p>
    <h2 data-number="8.9" id="summary-1"><span class="header-section-number">8.9</span> Summary</h2>
    <p>Functors represent sequencing behaviours. We covered three types
    of functor in this chapter:</p>
    <ul>
    <li><p>Regular covariant <code>Functors</code>, with their
    <code>map</code> method, represent the ability to apply functions to
    a value in some context. Successive calls to <code>map</code> apply
    these functions in <em>sequence</em>, each accepting the result of
    its predecessor as a parameter.</p></li>
    <li><p><code>Contravariant</code> functors, with their
    <code>contramap</code> method, represent the ability to “prepend”
    functions to a function-like context. Successive calls to
    <code>contramap</code> sequence these functions in the opposite
    order to <code>map</code>.</p></li>
    <li><p><code>Invariant</code> functors, with their <code>imap</code>
    method, represent bidirectional transformations.</p></li>
    </ul>
    <p>Regular <code>Functors</code> are by far the most common of these
    type classes, but even then it is rare to use them on their own.
    Functors form a foundational building block of several more
    interesting abstractions that we use all the time. In the following
    chapters we will look at two of these abstractions: <em>monads</em>
    and <em>applicative functors</em>.</p>
    <p>Functors for collections are extremely important, as they
    transform each element independently of the rest. This allows us to
    parallelise or distribute transformations on large collections, a
    technique leveraged heavily in “map-reduce” frameworks like <a href="http://hadoop.apache.org">Hadoop</a>. We will investigate this
    approach in more detail in the map-reduce case study later in
    Section 17.</p>
    <p>The <code>Contravariant</code> and <code>Invariant</code> type
    classes are less widely applicable but are still useful for building
    data types that represent transformations. We will revisit them to
    discuss the <code>Semigroupal</code> type class later in Chapter
    11.</p>
    <h1 data-number="9" id="sec:monads"><span class="header-section-number">9</span> Monads</h1>
    <p><em>Monads</em> are one of the most common abstractions in Scala.
    Many Scala programmers quickly become intuitively familiar with
    monads, even if we don’t know them by name.</p>
    <p>Informally, a monad is anything with a constructor and a
    <code>flatMap</code> method. All of the functors we saw in the last
    chapter are also monads, including <code>Option</code>,
    <code>List</code>, and <code>Future</code>. We even have special
    syntax to support monads: for comprehensions. However, despite the
    ubiquity of the concept, the Scala standard library lacks a concrete
    type to encompass “things that can be <code>flatMapped</code>”.</p>
    <p>In this chapter we will take a deep dive into monads. We will
    start by motivating them with a few examples. We’ll proceed to their
    formal definition, and see how we can create a concrete type as a
    type class. We’ll then look at their implementation in Cats.
    Finally, we’ll tour some interesting monads that you may not have
    seen, providing introductions and examples of their use.</p>
    <h2 data-number="9.1" id="what-is-a-monad"><span class="header-section-number">9.1</span> What is a Monad?</h2>
    <p>This is the question that has been posed in a thousand blog
    posts, with explanations and analogies involving concepts as diverse
    as cats, Mexican food, space suits full of toxic waste, and monoids
    in the category of endofunctors (whatever that means). We’re going
    to solve the problem of explaining monads once and for all by
    stating very simply:</p>
    <blockquote>
    <p>A monad is a mechanism for <em>sequencing computations</em>.</p>
    </blockquote>
    <p>That was easy! Problem solved, right? But then again, last
    chapter we said functors were a mechanism for exactly the same
    thing. Ok, maybe we need some more discussion…</p>
    <p>In Section 8.1 we said that functors allow us to sequence
    computations ignoring some complication. However, functors are
    limited in that they only allow this complication to occur once at
    the beginning of the sequence. They don’t account for further
    complications at each step in the sequence.</p>
    <p>This is where monads come in. A monad’s <code>flatMap</code>
    method allows us to specify what happens next, taking into account
    an intermediate complication. The <code>flatMap</code> method of
    <code>Option</code> takes intermediate <code>Options</code> into
    account. The <code>flatMap</code> method of <code>List</code>
    handles intermediate <code>Lists</code>. And so on. In each case,
    the function passed to <code>flatMap</code> specifies the
    application-specific part of the computation, and
    <code>flatMap</code> itself takes care of the complication allowing
    us to <code>flatMap</code> again. Let’s ground things by looking at
    some examples.</p>
    <h3 data-number="9.1.1" id="options-as-monads"><span class="header-section-number">9.1.1</span> Options as Monads</h3>
    <p><code>Option</code> allows us to sequence computations that may
    or may not return values. Here are some examples:</p>
    <div class="sourceCode" id="cb480"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb480-1"><a href="#cb480-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">parseInt</span><span class="op">(</span>str<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb480-2"><a href="#cb480-2" aria-hidden="true" tabindex="-1"></a>  scala<span class="op">.</span>util<span class="op">.</span><span class="fu">Try</span><span class="op">(</span>str<span class="op">.</span>toInt<span class="op">).</span>toOption</span>
<span id="cb480-3"><a href="#cb480-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb480-4"><a href="#cb480-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">divide</span><span class="op">(</span>a<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> b<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb480-5"><a href="#cb480-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span><span class="op">(</span>b <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="bu">None</span> <span class="cf">else</span> <span class="bu">Some</span><span class="op">(</span>a <span class="op">/</span> b<span class="op">)</span></span></code></pre></div>
    <p>Each of these methods may “fail” by returning <code>None</code>.
    The <code>flatMap</code> method allows us to ignore this when we
    sequence operations:</p>
    <div class="sourceCode" id="cb481"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb481-1"><a href="#cb481-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">stringDivideBy</span><span class="op">(</span>aStr<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> bStr<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb481-2"><a href="#cb481-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parseInt</span><span class="op">(</span>aStr<span class="op">).</span>flatMap <span class="op">{</span> aNum <span class="op">=&gt;</span></span>
<span id="cb481-3"><a href="#cb481-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">parseInt</span><span class="op">(</span>bStr<span class="op">).</span>flatMap <span class="op">{</span> bNum <span class="op">=&gt;</span></span>
<span id="cb481-4"><a href="#cb481-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">divide</span><span class="op">(</span>aNum<span class="op">,</span> bNum<span class="op">)</span></span>
<span id="cb481-5"><a href="#cb481-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb481-6"><a href="#cb481-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>The semantics are:</p>
    <ul>
    <li>the first call to <code>parseInt</code> returns a
    <code>None</code> or a <code>Some</code>;</li>
    <li>if it returns a <code>Some</code>, the <code>flatMap</code>
    method calls our function and passes us the integer
    <code>aNum</code>;</li>
    <li>the second call to <code>parseInt</code> returns a
    <code>None</code> or a <code>Some</code>;</li>
    <li>if it returns a <code>Some</code>, the <code>flatMap</code>
    method calls our function and passes us <code>bNum</code>;</li>
    <li>the call to <code>divide</code> returns a <code>None</code> or a
    <code>Some</code>, which is our result.</li>
    </ul>
    <p>At each step, <code>flatMap</code> chooses whether to call our
    function, and our function generates the next computation in the
    sequence. This is shown in Figure 8.</p>
    <figure id="fig:monads:option-type-chart">
    <svg id="svg_3959dd8b9a23bd7756a7" alt="Type chart: flatMap for Option" width="1919px" height="360px" viewBox="0 0 1919 360">
    <!-- Generator: Sketch 40.3 (33839) - http://www.bohemiancoding.com/sketch -->
    <title>option-flatmap</title>
    <desc>Created with Sketch.</desc>
    <defs>
        <rect id="svg_3959dd8b9a23bd7756a7_path-1" x="0" y="0" width="200" height="200" rx="8" />
        <mask id="svg_3959dd8b9a23bd7756a7_mask-2" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="200" height="200" fill="white">
            <use xlink:href="#svg_3959dd8b9a23bd7756a7_path-1" />
        </mask>
        <path d="M53.5580639,143.194146 L47,181.430593 L99.9006727,153.619064 L152.801345,181.430593 L142.698216,122.524828 L185.495759,80.807534 L126.351009,72.2132988 L125.75221,71 L53.5580639,143.194146 Z" id="svg_3959dd8b9a23bd7756a7_path-3" />
        <mask id="svg_3959dd8b9a23bd7756a7_mask-4" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="138.495759" height="110.430593" fill="white">
            <use xlink:href="#svg_3959dd8b9a23bd7756a7_path-3" />
        </mask>
        <path d="M51.977795,151.007053 L56.7975432,122.905765 L14,81.1884705 L73.1447501,72.5942353 L99.5950865,19 L126.045423,72.5942353 L129.839326,73.1455217 L51.977795,151.007053 Z" id="svg_3959dd8b9a23bd7756a7_path-5" />
        <mask id="svg_3959dd8b9a23bd7756a7_mask-6" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="115.839326" height="132.007053" fill="white">
            <use xlink:href="#svg_3959dd8b9a23bd7756a7_path-5" />
        </mask>
        <rect id="svg_3959dd8b9a23bd7756a7_path-7" x="0" y="0" width="200" height="200" rx="8" />
        <mask id="svg_3959dd8b9a23bd7756a7_mask-8" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="200" height="200" fill="white">
            <use xlink:href="#svg_3959dd8b9a23bd7756a7_path-7" />
        </mask>
        <path d="M53.5580639,143.194146 L47,181.430593 L99.9006727,153.619064 L152.801345,181.430593 L142.698216,122.524828 L185.495759,80.807534 L126.351009,72.2132988 L125.75221,71 L53.5580639,143.194146 Z" id="svg_3959dd8b9a23bd7756a7_path-9" />
        <mask id="svg_3959dd8b9a23bd7756a7_mask-10" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="138.495759" height="110.430593" fill="white">
            <use xlink:href="#svg_3959dd8b9a23bd7756a7_path-9" />
        </mask>
        <path d="M51.977795,151.007053 L56.7975432,122.905765 L14,81.1884705 L73.1447501,72.5942353 L99.5950865,19 L126.045423,72.5942353 L129.839326,73.1455217 L51.977795,151.007053 Z" id="svg_3959dd8b9a23bd7756a7_path-11" />
        <mask id="svg_3959dd8b9a23bd7756a7_mask-12" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="115.839326" height="132.007053" fill="white">
            <use xlink:href="#svg_3959dd8b9a23bd7756a7_path-11" />
        </mask>
        <path d="M153.820422,42.0071389 C169.321446,56.7797646 179,77.7454802 179,101 C179,145.735065 143.18278,182 99,182 C75.675188,182 54.6818214,171.893119 40.058808,155.768753 L153.820422,42.0071389 Z" id="svg_3959dd8b9a23bd7756a7_path-13" />
        <mask id="svg_3959dd8b9a23bd7756a7_mask-14" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="138.941192" height="139.992861" fill="white">
            <use xlink:href="#svg_3959dd8b9a23bd7756a7_path-13" />
        </mask>
        <path d="M157.058837,44.9260115 C142.544644,30.1585052 122.341864,21 100,21 C55.81722,21 20,56.81722 20,101 C20,123.341864 29.1585052,143.544644 43.9260115,158.058837 L157.058837,44.9260115 Z" id="svg_3959dd8b9a23bd7756a7_path-15" />
        <mask id="svg_3959dd8b9a23bd7756a7_mask-16" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="137.058837" height="137.058837" fill="white">
            <use xlink:href="#svg_3959dd8b9a23bd7756a7_path-15" />
        </mask>
        <rect id="svg_3959dd8b9a23bd7756a7_path-17" x="0" y="0" width="200" height="200" rx="8" />
        <mask id="svg_3959dd8b9a23bd7756a7_mask-18" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="200" height="200" fill="white">
            <use xlink:href="#svg_3959dd8b9a23bd7756a7_path-17" />
        </mask>
        <ellipse id="svg_3959dd8b9a23bd7756a7_path-19" cx="890" cy="140" rx="80" ry="80"></ellipse>
        <mask id="svg_3959dd8b9a23bd7756a7_mask-20" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="160" height="160" fill="white">
            <use xlink:href="#svg_3959dd8b9a23bd7756a7_path-19" />
        </mask>
        <polygon id="svg_3959dd8b9a23bd7756a7_path-21" points="994 120 1034 120 1034 100 1074 139.497767 1034 180 1034 160 994 160"></polygon>
        <mask id="svg_3959dd8b9a23bd7756a7_mask-22" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="80" height="80" fill="white">
            <use xlink:href="#svg_3959dd8b9a23bd7756a7_path-21" />
        </mask>
    </defs>
    <g id="svg_3959dd8b9a23bd7756a7_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_3959dd8b9a23bd7756a7_option-flatmap">
            <rect id="svg_3959dd8b9a23bd7756a7_Background" fill="#FFFFFF" x="0" y="0" width="1919" height="360" />
            <g id="svg_3959dd8b9a23bd7756a7_Group-3" transform="translate(1460.000000, 38.000000)" stroke-width="8">
                <use id="svg_3959dd8b9a23bd7756a7_Rectangle-1" stroke="#000000" mask="url(#mask-2)" xlink:href="#svg_3959dd8b9a23bd7756a7_path-1" />
                <use id="svg_3959dd8b9a23bd7756a7_Combined-Shape" stroke="#9B9B9B" mask="url(#mask-4)" stroke-dasharray="10,5" fill="#FFFFFF" xlink:href="#svg_3959dd8b9a23bd7756a7_path-3" />
                <use id="svg_3959dd8b9a23bd7756a7_Combined-Shape" stroke="#000000" mask="url(#mask-6)" fill="#FFFFFF" xlink:href="#svg_3959dd8b9a23bd7756a7_path-5" />
            </g>
            <g id="svg_3959dd8b9a23bd7756a7_Group-3" transform="translate(1100.000000, 39.000000)" stroke-width="8">
                <use id="svg_3959dd8b9a23bd7756a7_Rectangle-1" stroke="#000000" mask="url(#mask-8)" xlink:href="#svg_3959dd8b9a23bd7756a7_path-7" />
                <use id="svg_3959dd8b9a23bd7756a7_Combined-Shape" stroke="#9B9B9B" mask="url(#mask-10)" stroke-dasharray="10,5" fill="#FFFFFF" xlink:href="#svg_3959dd8b9a23bd7756a7_path-9" />
                <use id="svg_3959dd8b9a23bd7756a7_Combined-Shape" stroke="#000000" mask="url(#mask-12)" fill="#FFFFFF" xlink:href="#svg_3959dd8b9a23bd7756a7_path-11" />
            </g>
            <g id="svg_3959dd8b9a23bd7756a7_Group-4" transform="translate(257.000000, 38.000000)" stroke-width="8">
                <use id="svg_3959dd8b9a23bd7756a7_Combined-Shape" stroke="#9B9B9B" mask="url(#mask-14)" stroke-dasharray="10,5" fill="#FFFFFF" xlink:href="#svg_3959dd8b9a23bd7756a7_path-13" />
                <use id="svg_3959dd8b9a23bd7756a7_Combined-Shape" stroke="#000000" mask="url(#mask-16)" fill="#FFFFFF" xlink:href="#svg_3959dd8b9a23bd7756a7_path-15" />
                <use id="svg_3959dd8b9a23bd7756a7_Rectangle-1" stroke="#000000" mask="url(#mask-18)" xlink:href="#svg_3959dd8b9a23bd7756a7_path-17" />
            </g>
            <use id="svg_3959dd8b9a23bd7756a7_Oval-1" stroke="#000000" mask="url(#mask-20)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_3959dd8b9a23bd7756a7_path-19" />
            <use id="svg_3959dd8b9a23bd7756a7_Path-1" stroke="#000000" mask="url(#mask-22)" stroke-width="8" fill="#000000" xlink:href="#svg_3959dd8b9a23bd7756a7_path-21" />
            <polygon id="svg_3959dd8b9a23bd7756a7_Path-1" fill="#F6A623" points="1342 120 1382 120 1382 100 1422 139.497767 1382 180 1382 160 1342 160"></polygon>
            <text id="svg_3959dd8b9a23bd7756a7_Option[A]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="247.1" y="314">Option[A]</tspan>
            </text>
            <text id="svg_3959dd8b9a23bd7756a7_flatMap" font-family="FiraMono-Bold, Fira Mono" font-size="64" font-weight="bold" fill="#F6A623">
                <tspan x="494.2" y="156">flatMap</tspan>
            </text>
            <text id="svg_3959dd8b9a23bd7756a7_Option[B]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="1448.6" y="314">Option[B]</tspan>
            </text>
            <text id="svg_3959dd8b9a23bd7756a7_A-=&gt;-Option[B]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="885.6" y="314">A =&gt; Option[B]</tspan>
            </text>
        </g>
    </g>
</svg>
    <figcaption>Figure 8: Type chart: flatMap for Option</figcaption>
    </figure>
    <p>The result of the computation is an <code>Option</code>, allowing
    us to call <code>flatMap</code> again and so the sequence continues.
    This results in the fail-fast error handling behaviour that we know
    and love, where a <code>None</code> at any step results in a
    <code>None</code> overall:</p>
    <div class="sourceCode" id="cb482"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb482-1"><a href="#cb482-1" aria-hidden="true" tabindex="-1"></a><span class="fu">stringDivideBy</span><span class="op">(</span><span class="st">&quot;6&quot;</span><span class="op">,</span> <span class="st">&quot;2&quot;</span><span class="op">)</span></span>
<span id="cb482-2"><a href="#cb482-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res0: Option[Int] = Some(value = 3)</span></span>
<span id="cb482-3"><a href="#cb482-3" aria-hidden="true" tabindex="-1"></a><span class="fu">stringDivideBy</span><span class="op">(</span><span class="st">&quot;6&quot;</span><span class="op">,</span> <span class="st">&quot;0&quot;</span><span class="op">)</span></span>
<span id="cb482-4"><a href="#cb482-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: Option[Int] = None</span></span>
<span id="cb482-5"><a href="#cb482-5" aria-hidden="true" tabindex="-1"></a><span class="fu">stringDivideBy</span><span class="op">(</span><span class="st">&quot;6&quot;</span><span class="op">,</span> <span class="st">&quot;foo&quot;</span><span class="op">)</span></span>
<span id="cb482-6"><a href="#cb482-6" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: Option[Int] = None</span></span>
<span id="cb482-7"><a href="#cb482-7" aria-hidden="true" tabindex="-1"></a><span class="fu">stringDivideBy</span><span class="op">(</span><span class="st">&quot;bar&quot;</span><span class="op">,</span> <span class="st">&quot;2&quot;</span><span class="op">)</span></span>
<span id="cb482-8"><a href="#cb482-8" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: Option[Int] = None</span></span></code></pre></div>
    <p>Every monad is also a functor (see below for proof), so we can
    rely on both <code>flatMap</code> and <code>map</code> to sequence
    computations that do and don’t introduce a new monad. Plus, if we
    have both <code>flatMap</code> and <code>map</code> we can use for
    comprehensions to clarify the sequencing behaviour:</p>
    <div class="sourceCode" id="cb483"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb483-1"><a href="#cb483-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">stringDivideBy</span><span class="op">(</span>aStr<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> bStr<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb483-2"><a href="#cb483-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb483-3"><a href="#cb483-3" aria-hidden="true" tabindex="-1"></a>    aNum <span class="op">&lt;-</span> <span class="fu">parseInt</span><span class="op">(</span>aStr<span class="op">)</span></span>
<span id="cb483-4"><a href="#cb483-4" aria-hidden="true" tabindex="-1"></a>    bNum <span class="op">&lt;-</span> <span class="fu">parseInt</span><span class="op">(</span>bStr<span class="op">)</span></span>
<span id="cb483-5"><a href="#cb483-5" aria-hidden="true" tabindex="-1"></a>    ans  <span class="op">&lt;-</span> <span class="fu">divide</span><span class="op">(</span>aNum<span class="op">,</span> bNum<span class="op">)</span></span>
<span id="cb483-6"><a href="#cb483-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">yield</span> ans</span></code></pre></div>
    <h3 data-number="9.1.2" id="lists-as-monads"><span class="header-section-number">9.1.2</span> Lists as Monads</h3>
    <p>When we first encounter <code>flatMap</code> as budding Scala
    developers, we tend to think of it as a pattern for iterating over
    <code>Lists</code>. This is reinforced by the syntax of for
    comprehensions, which look very much like imperative for loops:</p>
    <div class="sourceCode" id="cb484"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb484-1"><a href="#cb484-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">{</span></span>
<span id="cb484-2"><a href="#cb484-2" aria-hidden="true" tabindex="-1"></a>  x <span class="op">&lt;-</span> <span class="op">(</span><span class="dv">1</span> to <span class="dv">3</span><span class="op">).</span>toList</span>
<span id="cb484-3"><a href="#cb484-3" aria-hidden="true" tabindex="-1"></a>  y <span class="op">&lt;-</span> <span class="op">(</span><span class="dv">4</span> to <span class="dv">5</span><span class="op">).</span>toList</span>
<span id="cb484-4"><a href="#cb484-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">yield</span> <span class="op">(</span>x<span class="op">,</span> y<span class="op">)</span></span>
<span id="cb484-5"><a href="#cb484-5" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: List[Tuple2[Int, Int]] = List(</span></span>
<span id="cb484-6"><a href="#cb484-6" aria-hidden="true" tabindex="-1"></a><span class="co">//   (1, 4),</span></span>
<span id="cb484-7"><a href="#cb484-7" aria-hidden="true" tabindex="-1"></a><span class="co">//   (1, 5),</span></span>
<span id="cb484-8"><a href="#cb484-8" aria-hidden="true" tabindex="-1"></a><span class="co">//   (2, 4),</span></span>
<span id="cb484-9"><a href="#cb484-9" aria-hidden="true" tabindex="-1"></a><span class="co">//   (2, 5),</span></span>
<span id="cb484-10"><a href="#cb484-10" aria-hidden="true" tabindex="-1"></a><span class="co">//   (3, 4),</span></span>
<span id="cb484-11"><a href="#cb484-11" aria-hidden="true" tabindex="-1"></a><span class="co">//   (3, 5)</span></span>
<span id="cb484-12"><a href="#cb484-12" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>However, there is another mental model we can apply that
    highlights the monadic behaviour of <code>List</code>. If we think
    of <code>Lists</code> as sets of intermediate results,
    <code>flatMap</code> becomes a construct that calculates
    permutations and combinations.</p>
    <p>For example, in the for comprehension above there are three
    possible values of <code>x</code> and two possible values of
    <code>y</code>. This means there are six possible values of
    <code>(x, y)</code>. <code>flatMap</code> is generating these
    combinations from our code, which states the sequence of
    operations:</p>
    <ul>
    <li>get <code>x</code></li>
    <li>get <code>y</code></li>
    <li>create a tuple <code>(x, y)</code></li>
    </ul>
    <!--
    The type chart in Figure [@fig:monads:list-type-chart]
    illustrates this behaviour[^list-lengths].

    ![Type chart: flatMap for List](src/pages/monads/list-flatmap.pdf+svg){#fig:monads:list-type-chart}

    [^list-lengths]: Although the result of `flatMap` (`List[B]`)
    is the same type as the result of the user-supplied function,
    the end result is actually a larger list
    created from combinations of intermediate `As` and `Bs`.
    -->
    <h3 data-number="9.1.3" id="futures-as-monads"><span class="header-section-number">9.1.3</span> Futures as Monads</h3>
    <p><code>Future</code> is a monad that sequences computations
    without worrying that they may be asynchronous:</p>
    <div class="sourceCode" id="cb485"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb485-1"><a href="#cb485-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span><span class="ex">Future</span></span>
<span id="cb485-2"><a href="#cb485-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span>ExecutionContext<span class="op">.</span>Implicits<span class="op">.</span>global</span>
<span id="cb485-3"><a href="#cb485-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb485-4"><a href="#cb485-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> doSomethingLongRunning<span class="op">:</span> <span class="ex">Future</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span> <span class="op">???</span></span>
<span id="cb485-5"><a href="#cb485-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> doSomethingElseLongRunning<span class="op">:</span> <span class="ex">Future</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span> <span class="op">???</span></span>
<span id="cb485-6"><a href="#cb485-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb485-7"><a href="#cb485-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> doSomethingVeryLongRunning<span class="op">:</span> <span class="ex">Future</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb485-8"><a href="#cb485-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb485-9"><a href="#cb485-9" aria-hidden="true" tabindex="-1"></a>    result1 <span class="op">&lt;-</span> doSomethingLongRunning</span>
<span id="cb485-10"><a href="#cb485-10" aria-hidden="true" tabindex="-1"></a>    result2 <span class="op">&lt;-</span> doSomethingElseLongRunning</span>
<span id="cb485-11"><a href="#cb485-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">yield</span> result1 <span class="op">+</span> result2</span></code></pre></div>
    <p>Again, we specify the code to run at each step, and
    <code>flatMap</code> takes care of all the horrifying underlying
    complexities of thread pools and schedulers.</p>
    <p>If you’ve made extensive use of <code>Future</code>, you’ll know
    that the code above is running each operation <em>in sequence</em>.
    This becomes clearer if we expand out the for comprehension to show
    the nested calls to <code>flatMap</code>:</p>
    <div class="sourceCode" id="cb486"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb486-1"><a href="#cb486-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> doSomethingVeryLongRunning<span class="op">:</span> <span class="ex">Future</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb486-2"><a href="#cb486-2" aria-hidden="true" tabindex="-1"></a>  doSomethingLongRunning<span class="op">.</span>flatMap <span class="op">{</span> result1 <span class="op">=&gt;</span></span>
<span id="cb486-3"><a href="#cb486-3" aria-hidden="true" tabindex="-1"></a>    doSomethingElseLongRunning<span class="op">.</span>map <span class="op">{</span> result2 <span class="op">=&gt;</span></span>
<span id="cb486-4"><a href="#cb486-4" aria-hidden="true" tabindex="-1"></a>      result1 <span class="op">+</span> result2</span>
<span id="cb486-5"><a href="#cb486-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb486-6"><a href="#cb486-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>Each <code>Future</code> in our sequence is created by a function
    that receives the result from a previous <code>Future</code>. In
    other words, each step in our computation can only start once the
    previous step is finished. This is born out by the type chart for
    <code>flatMap</code> in Figure 9, which shows the function parameter
    of type <code>A =&gt; Future[B]</code>.</p>
    <figure id="fig:monads:future-type-chart">
    <svg id="svg_2e4b1ec7ab69ddd582b6" alt="Type chart: flatMap for Future" width="1922px" height="360px" viewBox="0 0 1922 360">
    <!-- Generator: Sketch 40.3 (33839) - http://www.bohemiancoding.com/sketch -->
    <title>future-flatmap</title>
    <desc>Created with Sketch.</desc>
    <defs>
        <ellipse id="svg_2e4b1ec7ab69ddd582b6_path-1" cx="80" cy="80" rx="80" ry="80"></ellipse>
        <mask id="svg_2e4b1ec7ab69ddd582b6_mask-2" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="160" height="160" fill="white">
            <use xlink:href="#svg_2e4b1ec7ab69ddd582b6_path-1" />
        </mask>
        <ellipse id="svg_2e4b1ec7ab69ddd582b6_path-3" cx="840" cy="143" rx="80" ry="80"></ellipse>
        <mask id="svg_2e4b1ec7ab69ddd582b6_mask-4" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="160" height="160" fill="white">
            <use xlink:href="#svg_2e4b1ec7ab69ddd582b6_path-3" />
        </mask>
        <polygon id="svg_2e4b1ec7ab69ddd582b6_path-5" points="135.595086 157 82.6944138 184.811529 92.7975432 125.905765 50 84.1884705 109.14475 75.5942353 135.595086 22 162.045423 75.5942353 221.190173 84.1884705 178.39263 125.905765 188.495759 184.811529"></polygon>
        <mask id="svg_2e4b1ec7ab69ddd582b6_mask-6" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="171.190173" height="162.811529" fill="white">
            <use xlink:href="#svg_2e4b1ec7ab69ddd582b6_path-5" />
        </mask>
        <polygon id="svg_2e4b1ec7ab69ddd582b6_path-7" points="85.5950865 135 32.6944138 162.811529 42.7975432 103.905765 5.32907052e-14 62.1884705 59.1447501 53.5942353 85.5950865 0 112.045423 53.5942353 171.190173 62.1884705 128.39263 103.905765 138.495759 162.811529"></polygon>
        <mask id="svg_2e4b1ec7ab69ddd582b6_mask-8" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="171.190173" height="162.811529" fill="white">
            <use xlink:href="#svg_2e4b1ec7ab69ddd582b6_path-7" />
        </mask>
        <polygon id="svg_2e4b1ec7ab69ddd582b6_path-9" points="958 123 998 123 998 103 1038 142.497767 998 183 998 163 958 163"></polygon>
        <mask id="svg_2e4b1ec7ab69ddd582b6_mask-10" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="80" height="80" fill="white">
            <use xlink:href="#svg_2e4b1ec7ab69ddd582b6_path-9" />
        </mask>
    </defs>
    <g id="svg_2e4b1ec7ab69ddd582b6_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_2e4b1ec7ab69ddd582b6_future-flatmap">
            <rect id="svg_2e4b1ec7ab69ddd582b6_Background" fill="#FFFFFF" x="0" y="0" width="1922" height="360" />
            <g id="svg_2e4b1ec7ab69ddd582b6_Group-12" transform="translate(157.000000, 29.000000)" stroke="#000000">
                <path d="M233.315361,181.467721 C255.006169,170.992471 266,154.961214 266,132.8 C266,106.750232 250.809583,89.170359 220.910889,79.1281896 C224.907288,72.0781043 227.132924,64.2472515 227.132924,56 C227.132924,25.072054 195.8334,0 157.223482,0 C138.174233,0 120.904488,6.10306285 108.295299,16.00136 C103.887872,14.9548756 99.2817714,14.4 94.5421687,14.4 C62.682658,14.4 36.8554217,39.472054 36.8554217,70.4 C36.8554217,74.9092002 37.4044248,79.2939231 38.4410831,83.4946147 C13.680009,93.9523732 0,110.184167 0,132.8 C0,168.248626 33.6093449,188.012808 90.8198022,194.441594 C103.787678,212.035696 129.294061,224 158.638554,224 C194.740936,224 225.033857,205.890521 233.31536,181.467725 Z" id="svg_2e4b1ec7ab69ddd582b6_Combined-Shape" stroke-width="4" />
                <g id="svg_2e4b1ec7ab69ddd582b6_Group-2" transform="translate(57.000000, 31.000000)" stroke-width="8" fill="#FFFFFF">
                    <use id="svg_2e4b1ec7ab69ddd582b6_Oval-1" mask="url(#mask-2)" xlink:href="#svg_2e4b1ec7ab69ddd582b6_path-1" />
                </g>
            </g>
            <use id="svg_2e4b1ec7ab69ddd582b6_Oval-1" stroke="#000000" mask="url(#mask-4)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_2e4b1ec7ab69ddd582b6_path-3" />
            <g id="svg_2e4b1ec7ab69ddd582b6_Group-13" transform="translate(1079.000000, 40.000000)" stroke="#000000">
                <path d="M233.315361,181.467721 C255.006169,170.992471 266,154.961214 266,132.8 C266,106.750232 250.809583,89.170359 220.910889,79.1281896 C224.907288,72.0781043 227.132924,64.2472515 227.132924,56 C227.132924,25.072054 195.8334,0 157.223482,0 C138.174233,0 120.904488,6.10306285 108.295299,16.00136 C103.887872,14.9548756 99.2817714,14.4 94.5421687,14.4 C62.682658,14.4 36.8554217,39.472054 36.8554217,70.4 C36.8554217,74.9092002 37.4044248,79.2939231 38.4410831,83.4946147 C13.680009,93.9523732 0,110.184167 0,132.8 C0,168.248626 33.6093449,188.012808 90.8198022,194.441594 C103.787678,212.035696 129.294061,224 158.638554,224 C194.740936,224 225.033857,205.890521 233.31536,181.467725 Z" id="svg_2e4b1ec7ab69ddd582b6_Combined-Shape" stroke-width="4" />
                <use id="svg_2e4b1ec7ab69ddd582b6_Star-1" mask="url(#mask-6)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_2e4b1ec7ab69ddd582b6_path-5" />
            </g>
            <g id="svg_2e4b1ec7ab69ddd582b6_Group-14" transform="translate(1502.000000, 38.000000)" stroke="#000000">
                <path d="M233.315361,181.467721 C255.006169,170.992471 266,154.961214 266,132.8 C266,106.750232 250.809583,89.170359 220.910889,79.1281896 C224.907288,72.0781043 227.132924,64.2472515 227.132924,56 C227.132924,25.072054 195.8334,0 157.223482,0 C138.174233,0 120.904488,6.10306285 108.295299,16.00136 C103.887872,14.9548756 99.2817714,14.4 94.5421687,14.4 C62.682658,14.4 36.8554217,39.472054 36.8554217,70.4 C36.8554217,74.9092002 37.4044248,79.2939231 38.4410831,83.4946147 C13.680009,93.9523732 0,110.184167 0,132.8 C0,168.248626 33.6093449,188.012808 90.8198022,194.441594 C103.787678,212.035696 129.294061,224 158.638554,224 C194.740936,224 225.033857,205.890521 233.31536,181.467725 Z" id="svg_2e4b1ec7ab69ddd582b6_Combined-Shape" stroke-width="4" />
                <g id="svg_2e4b1ec7ab69ddd582b6_Group" transform="translate(48.000000, 22.000000)" stroke-width="8" fill="#FFFFFF">
                    <use id="svg_2e4b1ec7ab69ddd582b6_Star-1" mask="url(#mask-8)" xlink:href="#svg_2e4b1ec7ab69ddd582b6_path-7" />
                </g>
            </g>
            <use id="svg_2e4b1ec7ab69ddd582b6_Path-1" stroke="#000000" mask="url(#mask-10)" stroke-width="8" fill="#000000" xlink:href="#svg_2e4b1ec7ab69ddd582b6_path-9" />
            <polygon id="svg_2e4b1ec7ab69ddd582b6_Path-1" fill="#F6A623" points="1388 123 1428 123 1428 103 1468 142.497767 1428 183 1428 163 1388 163"></polygon>
            <text id="svg_2e4b1ec7ab69ddd582b6_Future[A]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="187.6" y="317">Future[A]</tspan>
            </text>
            <text id="svg_2e4b1ec7ab69ddd582b6_Future[B]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="1511.6" y="317">Future[B]</tspan>
            </text>
            <text id="svg_2e4b1ec7ab69ddd582b6_A-=&gt;-Future[B]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="875.6" y="317">A =&gt; Future[B]</tspan>
            </text>
            <text id="svg_2e4b1ec7ab69ddd582b6_flatMap" font-family="FiraMono-Bold, Fira Mono" font-size="64" font-weight="bold" fill="#F6A623">
                <tspan x="453.2" y="158">flatMap</tspan>
            </text>
        </g>
    </g>
</svg>
    <figcaption>Figure 9: Type chart: flatMap for Future</figcaption>
    </figure>
    <p>We <em>can</em> run futures in parallel, of course, but that is
    another story and shall be told another time. Monads are all about
    sequencing.</p>
    <h3 data-number="9.1.4" id="definition-of-a-monad"><span class="header-section-number">9.1.4</span> Definition of a
    Monad</h3>
    <p>While we have only talked about <code>flatMap</code> above,
    monadic behaviour is formally captured in two operations:</p>
    <ul>
    <li><code>pure</code>, of type <code>A =&gt; F[A]</code>;</li>
    <li><code>flatMap</code><a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>, of type
    <code>(F[A], A =&gt; F[B]) =&gt; F[B]</code>.</li>
    </ul>
    <p><code>pure</code> abstracts over constructors, providing a way to
    create a new monadic context from a plain value.
    <code>flatMap</code> provides the sequencing step we have already
    discussed, extracting the value from a context and generating the
    next context in the sequence. Here is a simplified version of the
    <code>Monad</code> type class in Cats:</p>
    <div class="sourceCode" id="cb487"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb487-1"><a href="#cb487-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb487-2"><a href="#cb487-2" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Monad<span class="op">[</span>F<span class="op">[</span>_<span class="op">]]</span> <span class="op">{</span></span>
<span id="cb487-3"><a href="#cb487-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> pure<span class="op">[</span>A<span class="op">](</span>value<span class="op">:</span> A<span class="op">):</span> F<span class="op">[</span>A<span class="op">]</span></span>
<span id="cb487-4"><a href="#cb487-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb487-5"><a href="#cb487-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> flatMap<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>value<span class="op">:</span> F<span class="op">[</span>A<span class="op">])(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> F<span class="op">[</span>B<span class="op">]):</span> F<span class="op">[</span>B<span class="op">]</span></span>
<span id="cb487-6"><a href="#cb487-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <section id="monad-laws" class="unnumbered callout callout-warning">
    <h4 class="unnumbered">Monad Laws</h4>
    <p><code>pure</code> and <code>flatMap</code> must obey a set of
    laws that allow us to sequence operations freely without unintended
    glitches and side-effects:</p>
    <p><em>Left identity</em>: calling <code>pure</code> and
    transforming the result with <code>func</code> is the same as
    calling <code>func</code>:</p>
    <div class="sourceCode" id="cb488"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb488-1"><a href="#cb488-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pure</span><span class="op">(</span>a<span class="op">).</span><span class="fu">flatMap</span><span class="op">(</span>func<span class="op">)</span> <span class="op">==</span> <span class="fu">func</span><span class="op">(</span>a<span class="op">)</span></span></code></pre></div>
    <p><em>Right identity</em>: passing <code>pure</code> to
    <code>flatMap</code> is the same as doing nothing:</p>
    <div class="sourceCode" id="cb489"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb489-1"><a href="#cb489-1" aria-hidden="true" tabindex="-1"></a>m<span class="op">.</span><span class="fu">flatMap</span><span class="op">(</span>pure<span class="op">)</span> <span class="op">==</span> m</span></code></pre></div>
    <p><em>Associativity</em>: <code>flatMapping</code> over two
    functions <code>f</code> and <code>g</code> is the same as
    <code>flatMapping</code> over <code>f</code> and then
    <code>flatMapping</code> over <code>g</code>:</p>
    <div class="sourceCode" id="cb490"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb490-1"><a href="#cb490-1" aria-hidden="true" tabindex="-1"></a>m<span class="op">.</span><span class="fu">flatMap</span><span class="op">(</span>f<span class="op">).</span><span class="fu">flatMap</span><span class="op">(</span>g<span class="op">)</span> <span class="op">==</span> m<span class="op">.</span><span class="fu">flatMap</span><span class="op">(</span>x <span class="op">=&gt;</span> <span class="fu">f</span><span class="op">(</span>x<span class="op">).</span><span class="fu">flatMap</span><span class="op">(</span>g<span class="op">))</span></span></code></pre></div>
    </section>
    <h3 data-number="9.1.5" id="exercise-getting-func-y"><span class="header-section-number">9.1.5</span> Exercise: Getting
    Func-y</h3>
    <p>Every monad is also a functor. We can define <code>map</code> in
    the same way for every monad using the existing methods,
    <code>flatMap</code> and <code>pure</code>:</p>
    <div class="sourceCode" id="cb491"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb491-1"><a href="#cb491-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb491-2"><a href="#cb491-2" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Monad<span class="op">[</span>F<span class="op">[</span>_<span class="op">]]</span> <span class="op">{</span></span>
<span id="cb491-3"><a href="#cb491-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> pure<span class="op">[</span>A<span class="op">](</span>a<span class="op">:</span> A<span class="op">):</span> F<span class="op">[</span>A<span class="op">]</span></span>
<span id="cb491-4"><a href="#cb491-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb491-5"><a href="#cb491-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> flatMap<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>value<span class="op">:</span> F<span class="op">[</span>A<span class="op">])(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> F<span class="op">[</span>B<span class="op">]):</span> F<span class="op">[</span>B<span class="op">]</span></span>
<span id="cb491-6"><a href="#cb491-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb491-7"><a href="#cb491-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>value<span class="op">:</span> F<span class="op">[</span>A<span class="op">])(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> F<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb491-8"><a href="#cb491-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb491-9"><a href="#cb491-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Try defining <code>map</code> yourself now.</p>
    <div class="solution">
    <p>At first glance this seems tricky, but if we follow the types
    we’ll see there’s only one solution. We are passed a
    <code>value</code> of type <code>F[A]</code>. Given the tools
    available there’s only one thing we can do: call
    <code>flatMap</code>:</p>
    <div class="sourceCode" id="cb492"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb492-1"><a href="#cb492-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Monad<span class="op">[</span>F<span class="op">[</span>_<span class="op">]]</span> <span class="op">{</span></span>
<span id="cb492-2"><a href="#cb492-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> pure<span class="op">[</span>A<span class="op">](</span>value<span class="op">:</span> A<span class="op">):</span> F<span class="op">[</span>A<span class="op">]</span></span>
<span id="cb492-3"><a href="#cb492-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb492-4"><a href="#cb492-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> flatMap<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>value<span class="op">:</span> F<span class="op">[</span>A<span class="op">])(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> F<span class="op">[</span>B<span class="op">]):</span> F<span class="op">[</span>B<span class="op">]</span></span>
<span id="cb492-5"><a href="#cb492-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb492-6"><a href="#cb492-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>value<span class="op">:</span> F<span class="op">[</span>A<span class="op">])(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> F<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb492-7"><a href="#cb492-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">flatMap</span><span class="op">(</span>value<span class="op">)(</span>a <span class="op">=&gt;</span> <span class="op">???)</span></span>
<span id="cb492-8"><a href="#cb492-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>We need a function of type <code>A =&gt; F[B]</code> as the
    second parameter. We have two function building blocks available:
    the <code>func</code> parameter of type <code>A =&gt; B</code> and
    the <code>pure</code> function of type <code>A =&gt; F[A]</code>.
    Combining these gives us our result:</p>
    <div class="sourceCode" id="cb493"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb493-1"><a href="#cb493-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Monad<span class="op">[</span>F<span class="op">[</span>_<span class="op">]]</span> <span class="op">{</span></span>
<span id="cb493-2"><a href="#cb493-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> pure<span class="op">[</span>A<span class="op">](</span>value<span class="op">:</span> A<span class="op">):</span> F<span class="op">[</span>A<span class="op">]</span></span>
<span id="cb493-3"><a href="#cb493-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb493-4"><a href="#cb493-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> flatMap<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>value<span class="op">:</span> F<span class="op">[</span>A<span class="op">])(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> F<span class="op">[</span>B<span class="op">]):</span> F<span class="op">[</span>B<span class="op">]</span></span>
<span id="cb493-5"><a href="#cb493-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb493-6"><a href="#cb493-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>value<span class="op">:</span> F<span class="op">[</span>A<span class="op">])(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> F<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb493-7"><a href="#cb493-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">flatMap</span><span class="op">(</span>value<span class="op">)(</span>a <span class="op">=&gt;</span> <span class="fu">pure</span><span class="op">(</span><span class="fu">func</span><span class="op">(</span>a<span class="op">)))</span></span>
<span id="cb493-8"><a href="#cb493-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    </div>
    <h2 data-number="9.2" id="monads-in-cats"><span class="header-section-number">9.2</span> Monads in Cats</h2>
    <p>It’s time to give monads our standard Cats treatment. As usual
    we’ll look at the type class, instances, and syntax.</p>
    <h3 data-number="9.2.1" id="monad-type-class"><span class="header-section-number">9.2.1</span> The Monad Type Class</h3>
    <p>The monad type class is <a href="http://typelevel.org/cats/api/cats/Monad.html"><code>cats.Monad</code></a>.
    <code>Monad</code> extends two other type classes:
    <code>FlatMap</code>, which provides the <code>flatMap</code>
    method, and <code>Applicative</code>, which provides
    <code>pure</code>. <code>Applicative</code> also extends
    <code>Functor</code>, which gives every <code>Monad</code> a
    <code>map</code> method as we saw in the exercise above. We’ll
    discuss <code>Applicatives</code> in Chapter 11.</p>
    <p>Here are some examples using <code>pure</code> and
    <code>flatMap</code>, and <code>map</code> directly:</p>
    <div class="sourceCode" id="cb494"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb494-1"><a href="#cb494-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Monad</span></code></pre></div>
    <div class="sourceCode" id="cb495"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb495-1"><a href="#cb495-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> opt1 <span class="op">=</span> Monad<span class="op">[</span><span class="ex">Option</span><span class="op">].</span><span class="fu">pure</span><span class="op">(</span><span class="dv">3</span><span class="op">)</span></span>
<span id="cb495-2"><a href="#cb495-2" aria-hidden="true" tabindex="-1"></a><span class="co">// opt1: Option[Int] = Some(value = 3)</span></span>
<span id="cb495-3"><a href="#cb495-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> opt2 <span class="op">=</span> Monad<span class="op">[</span><span class="ex">Option</span><span class="op">].</span><span class="fu">flatMap</span><span class="op">(</span>opt1<span class="op">)(</span>a <span class="op">=&gt;</span> <span class="bu">Some</span><span class="op">(</span>a <span class="op">+</span> <span class="dv">2</span><span class="op">))</span></span>
<span id="cb495-4"><a href="#cb495-4" aria-hidden="true" tabindex="-1"></a><span class="co">// opt2: Option[Int] = Some(value = 5)</span></span>
<span id="cb495-5"><a href="#cb495-5" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> opt3 <span class="op">=</span> Monad<span class="op">[</span><span class="ex">Option</span><span class="op">].</span><span class="fu">map</span><span class="op">(</span>opt2<span class="op">)(</span>a <span class="op">=&gt;</span> <span class="dv">100</span> <span class="op">*</span> a<span class="op">)</span></span>
<span id="cb495-6"><a href="#cb495-6" aria-hidden="true" tabindex="-1"></a><span class="co">// opt3: Option[Int] = Some(value = 500)</span></span>
<span id="cb495-7"><a href="#cb495-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb495-8"><a href="#cb495-8" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> list1 <span class="op">=</span> Monad<span class="op">[</span><span class="ex">List</span><span class="op">].</span><span class="fu">pure</span><span class="op">(</span><span class="dv">3</span><span class="op">)</span></span>
<span id="cb495-9"><a href="#cb495-9" aria-hidden="true" tabindex="-1"></a><span class="co">// list1: List[Int] = List(3)</span></span>
<span id="cb495-10"><a href="#cb495-10" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> list2 <span class="op">=</span> Monad<span class="op">[</span><span class="ex">List</span><span class="op">].</span></span>
<span id="cb495-11"><a href="#cb495-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">flatMap</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">))(</span>a <span class="op">=&gt;</span> <span class="ex">List</span><span class="op">(</span>a<span class="op">,</span> a<span class="op">*</span><span class="dv">10</span><span class="op">))</span></span>
<span id="cb495-12"><a href="#cb495-12" aria-hidden="true" tabindex="-1"></a><span class="co">// list2: List[Int] = List(1, 10, 2, 20, 3, 30)</span></span>
<span id="cb495-13"><a href="#cb495-13" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> list3 <span class="op">=</span> Monad<span class="op">[</span><span class="ex">List</span><span class="op">].</span><span class="fu">map</span><span class="op">(</span>list2<span class="op">)(</span>a <span class="op">=&gt;</span> a <span class="op">+</span> <span class="dv">123</span><span class="op">)</span></span>
<span id="cb495-14"><a href="#cb495-14" aria-hidden="true" tabindex="-1"></a><span class="co">// list3: List[Int] = List(124, 133, 125, 143, 126, 153)</span></span></code></pre></div>
    <p><code>Monad</code> provides many other methods, including all of
    the methods from <code>Functor</code>. See the <a href="http://typelevel.org/cats/api/cats/Monad.html">scaladoc</a>
    for more information.</p>
    <h3 data-number="9.2.2" id="default-instances"><span class="header-section-number">9.2.2</span> Default Instances</h3>
    <p>Cats provides instances for all the monads in the standard
    library (<code>Option</code>, <code>List</code>, <code>Vector</code>
    and so on). Cats also provides a <code>Monad</code> for
    <code>Future</code>. Unlike the methods on the <code>Future</code>
    class itself, the <code>pure</code> and <code>flatMap</code> methods
    on the monad can’t accept implicit <code>ExecutionContext</code>
    parameters (because the parameters aren’t part of the definitions in
    the <code>Monad</code> trait). To work around this, Cats requires us
    to have an <code>ExecutionContext</code> in scope when we summon a
    <code>Monad</code> for <code>Future</code>:</p>
    <div class="sourceCode" id="cb496"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb496-1"><a href="#cb496-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.*</span></span>
<span id="cb496-2"><a href="#cb496-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span>duration<span class="op">.*</span></span></code></pre></div>
    <div class="sourceCode" id="cb497"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb497-1"><a href="#cb497-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> fm <span class="op">=</span> Monad<span class="op">[</span><span class="ex">Future</span><span class="op">]</span></span>
<span id="cb497-2"><a href="#cb497-2" aria-hidden="true" tabindex="-1"></a><span class="co">// error:</span></span>
<span id="cb497-3"><a href="#cb497-3" aria-hidden="true" tabindex="-1"></a><span class="co">// No given instance of type cats.Monad[scala.concurrent.Future] was found for parameter instance of method apply in object Monad.</span></span>
<span id="cb497-4"><a href="#cb497-4" aria-hidden="true" tabindex="-1"></a><span class="co">// I found:</span></span>
<span id="cb497-5"><a href="#cb497-5" aria-hidden="true" tabindex="-1"></a><span class="co">// </span></span>
<span id="cb497-6"><a href="#cb497-6" aria-hidden="true" tabindex="-1"></a><span class="co">//     cats.Invariant.catsInstancesForFuture(</span></span>
<span id="cb497-7"><a href="#cb497-7" aria-hidden="true" tabindex="-1"></a><span class="co">//       /* missing */summon[scala.concurrent.ExecutionContext])</span></span>
<span id="cb497-8"><a href="#cb497-8" aria-hidden="true" tabindex="-1"></a><span class="co">// </span></span>
<span id="cb497-9"><a href="#cb497-9" aria-hidden="true" tabindex="-1"></a><span class="co">// But no implicit values were found that match type scala.concurrent.ExecutionContext.</span></span>
<span id="cb497-10"><a href="#cb497-10" aria-hidden="true" tabindex="-1"></a><span class="co">// val fm = Monad[Future]</span></span>
<span id="cb497-11"><a href="#cb497-11" aria-hidden="true" tabindex="-1"></a><span class="co">//                      ^</span></span></code></pre></div>
    <p>Bringing the <code>ExecutionContext</code> into scope fixes the
    implicit resolution required to summon the instance:</p>
    <div class="sourceCode" id="cb498"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb498-1"><a href="#cb498-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span>ExecutionContext<span class="op">.</span>Implicits<span class="op">.</span>global</span></code></pre></div>
    <div class="sourceCode" id="cb499"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb499-1"><a href="#cb499-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> fm <span class="op">=</span> Monad<span class="op">[</span><span class="ex">Future</span><span class="op">]</span></span>
<span id="cb499-2"><a href="#cb499-2" aria-hidden="true" tabindex="-1"></a><span class="co">// fm: Monad[[T &gt;: Nothing &lt;: Any] =&gt; Future[T]] = cats.instances.FutureInstances$$anon$1@4ae234b9</span></span></code></pre></div>
    <p>The <code>Monad</code> instance uses the captured
    <code>ExecutionContext</code> for subsequent calls to
    <code>pure</code> and <code>flatMap</code>:</p>
    <div class="sourceCode" id="cb500"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb500-1"><a href="#cb500-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> future <span class="op">=</span> fm<span class="op">.</span><span class="fu">flatMap</span><span class="op">(</span>fm<span class="op">.</span><span class="fu">pure</span><span class="op">(</span><span class="dv">1</span><span class="op">))(</span>x <span class="op">=&gt;</span> fm<span class="op">.</span><span class="fu">pure</span><span class="op">(</span>x <span class="op">+</span> <span class="dv">2</span><span class="op">))</span></span></code></pre></div>
    <div class="sourceCode" id="cb501"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb501-1"><a href="#cb501-1" aria-hidden="true" tabindex="-1"></a>Await<span class="op">.</span><span class="fu">result</span><span class="op">(</span>future<span class="op">,</span> <span class="fl">1.</span>second<span class="op">)</span></span>
<span id="cb501-2"><a href="#cb501-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: Int = 3</span></span></code></pre></div>
    <p>In addition to the above, Cats provides a host of new monads that
    we don’t have in the standard library. We’ll familiarise ourselves
    with some of these in a moment.</p>
    <h3 data-number="9.2.3" id="monad-syntax"><span class="header-section-number">9.2.3</span> Monad Syntax</h3>
    <p>The syntax for monads comes from three places:</p>
    <ul>
    <li><a href="http://typelevel.org/cats/api/cats/syntax/package$$flatMap$"><code>cats.syntax.flatMap</code></a>
    provides syntax for <code>flatMap</code>;</li>
    <li><a href="http://typelevel.org/cats/api/cats/syntax/package$$functor$"><code>cats.syntax.functor</code></a>
    provides syntax for <code>map</code>;</li>
    <li><a href="http://typelevel.org/cats/api/cats/syntax/package$$applicative$"><code>cats.syntax.applicative</code></a>
    provides syntax for <code>pure</code>.</li>
    </ul>
    <p>In practice it’s often easier to import everything in one go from
    <code>cats.syntax.all.**</code>. However, we’ll use the individual
    imports here for clarity.</p>
    <p>We can use <code>pure</code> to construct instances of a monad.
    We’ll often need to specify the type parameter to disambiguate the
    particular instance we want.</p>
    <div class="sourceCode" id="cb502"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb502-1"><a href="#cb502-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>applicative<span class="op">.*</span> <span class="co">// for pure</span></span></code></pre></div>
    <div class="sourceCode" id="cb503"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb503-1"><a href="#cb503-1" aria-hidden="true" tabindex="-1"></a><span class="fl">1.</span>pure<span class="op">[</span><span class="ex">Option</span><span class="op">]</span></span>
<span id="cb503-2"><a href="#cb503-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: Option[Int] = Some(value = 1)</span></span>
<span id="cb503-3"><a href="#cb503-3" aria-hidden="true" tabindex="-1"></a><span class="fl">1.</span>pure<span class="op">[</span><span class="ex">List</span><span class="op">]</span></span>
<span id="cb503-4"><a href="#cb503-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: List[Int] = List(1)</span></span></code></pre></div>
    <p>It’s difficult to demonstrate the <code>flatMap</code> and
    <code>map</code> methods directly on Scala monads like
    <code>Option</code> and <code>List</code>, because they define their
    own explicit versions of those methods. Instead we’ll write a
    generic function that performs a calculation on parameters that come
    wrapped in a monad of the user’s choice:</p>
    <div class="sourceCode" id="cb504"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb504-1"><a href="#cb504-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Monad</span>
<span id="cb504-2"><a href="#cb504-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>functor<span class="op">.*</span> <span class="co">// for map</span></span>
<span id="cb504-3"><a href="#cb504-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>flatMap<span class="op">.*</span> <span class="co">// for flatMap</span></span>
<span id="cb504-4"><a href="#cb504-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb504-5"><a href="#cb504-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sumSquare<span class="op">[</span>F<span class="op">[</span>_<span class="op">]:</span> Monad<span class="op">](</span>a<span class="op">:</span> F<span class="op">[</span><span class="bu">Int</span><span class="op">],</span> b<span class="op">:</span> F<span class="op">[</span><span class="bu">Int</span><span class="op">]):</span> F<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb504-6"><a href="#cb504-6" aria-hidden="true" tabindex="-1"></a>  a<span class="op">.</span><span class="fu">flatMap</span><span class="op">(</span>x <span class="op">=&gt;</span> b<span class="op">.</span><span class="fu">map</span><span class="op">(</span>y <span class="op">=&gt;</span> x<span class="op">*</span>x <span class="op">+</span> y<span class="op">*</span>y<span class="op">))</span></span></code></pre></div>
    <div class="sourceCode" id="cb505"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb505-1"><a href="#cb505-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sumSquare</span><span class="op">(</span><span class="ex">Option</span><span class="op">(</span><span class="dv">3</span><span class="op">),</span> <span class="ex">Option</span><span class="op">(</span><span class="dv">4</span><span class="op">))</span></span>
<span id="cb505-2"><a href="#cb505-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: Option[Int] = Some(value = 25)</span></span>
<span id="cb505-3"><a href="#cb505-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sumSquare</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">),</span> <span class="ex">List</span><span class="op">(</span><span class="dv">4</span><span class="op">,</span> <span class="dv">5</span><span class="op">))</span></span>
<span id="cb505-4"><a href="#cb505-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: List[Int] = List(17, 26, 20, 29, 25, 34)</span></span></code></pre></div>
    <p>We can rewrite this code using for comprehensions. The compiler
    will “do the right thing” by rewriting our comprehension in terms of
    <code>flatMap</code> and <code>map</code> and inserting the correct
    conversions to use our <code>Monad</code>:</p>
    <div class="sourceCode" id="cb506"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb506-1"><a href="#cb506-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sumSquare<span class="op">[</span>F<span class="op">[</span>_<span class="op">]:</span> Monad<span class="op">](</span>a<span class="op">:</span> F<span class="op">[</span><span class="bu">Int</span><span class="op">],</span> b<span class="op">:</span> F<span class="op">[</span><span class="bu">Int</span><span class="op">]):</span> F<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb506-2"><a href="#cb506-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb506-3"><a href="#cb506-3" aria-hidden="true" tabindex="-1"></a>    x <span class="op">&lt;-</span> a</span>
<span id="cb506-4"><a href="#cb506-4" aria-hidden="true" tabindex="-1"></a>    y <span class="op">&lt;-</span> b</span>
<span id="cb506-5"><a href="#cb506-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">yield</span> x<span class="op">*</span>x <span class="op">+</span> y<span class="op">*</span>y</span></code></pre></div>
    <div class="sourceCode" id="cb507"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb507-1"><a href="#cb507-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sumSquare</span><span class="op">(</span><span class="ex">Option</span><span class="op">(</span><span class="dv">3</span><span class="op">),</span> <span class="ex">Option</span><span class="op">(</span><span class="dv">4</span><span class="op">))</span></span>
<span id="cb507-2"><a href="#cb507-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res7: Option[Int] = Some(value = 25)</span></span>
<span id="cb507-3"><a href="#cb507-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sumSquare</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">),</span> <span class="ex">List</span><span class="op">(</span><span class="dv">4</span><span class="op">,</span> <span class="dv">5</span><span class="op">))</span></span>
<span id="cb507-4"><a href="#cb507-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res8: List[Int] = List(17, 26, 20, 29, 25, 34)</span></span></code></pre></div>
    <p>That’s more or less everything we need to know about the
    generalities of monads in Cats. Now let’s take a look at some useful
    monad instances that we haven’t seen in the Scala standard
    library.</p>
    <h2 data-number="9.3" id="sec:monads:identity"><span class="header-section-number">9.3</span> The Identity Monad</h2>
    <p>In the previous section we demonstrated Cats’
    <code>flatMap</code> and <code>map</code> syntax by writing a method
    that abstracted over different monads:</p>
    <div class="sourceCode" id="cb508"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb508-1"><a href="#cb508-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Monad</span>
<span id="cb508-2"><a href="#cb508-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>functor<span class="op">.*</span> <span class="co">// for map</span></span>
<span id="cb508-3"><a href="#cb508-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>flatMap<span class="op">.*</span> <span class="co">// for flatMap</span></span>
<span id="cb508-4"><a href="#cb508-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb508-5"><a href="#cb508-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sumSquare<span class="op">[</span>F<span class="op">[</span>_<span class="op">]:</span> Monad<span class="op">](</span>a<span class="op">:</span> F<span class="op">[</span><span class="bu">Int</span><span class="op">],</span> b<span class="op">:</span> F<span class="op">[</span><span class="bu">Int</span><span class="op">]):</span> F<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb508-6"><a href="#cb508-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb508-7"><a href="#cb508-7" aria-hidden="true" tabindex="-1"></a>    x <span class="op">&lt;-</span> a</span>
<span id="cb508-8"><a href="#cb508-8" aria-hidden="true" tabindex="-1"></a>    y <span class="op">&lt;-</span> b</span>
<span id="cb508-9"><a href="#cb508-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">yield</span> x<span class="op">*</span>x <span class="op">+</span> y<span class="op">*</span>y</span></code></pre></div>
    <p>This method works well on <code>Options</code> and
    <code>Lists</code> but we can’t call it passing in plain values:</p>
    <div class="sourceCode" id="cb509"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb509-1"><a href="#cb509-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sumSquare</span><span class="op">(</span><span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">)</span></span>
<span id="cb509-2"><a href="#cb509-2" aria-hidden="true" tabindex="-1"></a><span class="co">// error:</span></span>
<span id="cb509-3"><a href="#cb509-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Found:    (3 : Int)</span></span>
<span id="cb509-4"><a href="#cb509-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Required: ([_] =&gt;&gt; Any)[Int]</span></span>
<span id="cb509-5"><a href="#cb509-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Note that implicit conversions were not tried because the result of an implicit conversion</span></span>
<span id="cb509-6"><a href="#cb509-6" aria-hidden="true" tabindex="-1"></a><span class="co">// must be more specific than ([_] =&gt;&gt; Any)[Int]</span></span>
<span id="cb509-7"><a href="#cb509-7" aria-hidden="true" tabindex="-1"></a><span class="co">// sumSquare(3, 4)</span></span>
<span id="cb509-8"><a href="#cb509-8" aria-hidden="true" tabindex="-1"></a><span class="co">//           ^</span></span>
<span id="cb509-9"><a href="#cb509-9" aria-hidden="true" tabindex="-1"></a><span class="co">// error:</span></span>
<span id="cb509-10"><a href="#cb509-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Found:    (4 : Int)</span></span>
<span id="cb509-11"><a href="#cb509-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Required: ([_] =&gt;&gt; Any)[Int]</span></span>
<span id="cb509-12"><a href="#cb509-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Note that implicit conversions were not tried because the result of an implicit conversion</span></span>
<span id="cb509-13"><a href="#cb509-13" aria-hidden="true" tabindex="-1"></a><span class="co">// must be more specific than ([_] =&gt;&gt; Any)[Int]</span></span>
<span id="cb509-14"><a href="#cb509-14" aria-hidden="true" tabindex="-1"></a><span class="co">// sumSquare(3, 4)</span></span>
<span id="cb509-15"><a href="#cb509-15" aria-hidden="true" tabindex="-1"></a><span class="co">//              ^</span></span></code></pre></div>
    <p>It would be incredibly useful if we could use
    <code>sumSquare</code> with parameters that were either in a monad
    or not in a monad at all. This would allow us to abstract over
    monadic and non-monadic code. Fortunately, Cats provides the
    <code>Id</code> type to bridge the gap:</p>
    <div class="sourceCode" id="cb510"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb510-1"><a href="#cb510-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Id</span></code></pre></div>
    <div class="sourceCode" id="cb511"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb511-1"><a href="#cb511-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sumSquare</span><span class="op">(</span><span class="dv">3</span> <span class="op">:</span> Id<span class="op">[</span><span class="bu">Int</span><span class="op">],</span> <span class="dv">4</span> <span class="op">:</span> Id<span class="op">[</span><span class="bu">Int</span><span class="op">])</span></span>
<span id="cb511-2"><a href="#cb511-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: Int = 25</span></span></code></pre></div>
    <p><code>Id</code> allows us to call our monadic method using plain
    values. However, the exact semantics are difficult to understand. We
    cast the parameters to <code>sumSquare</code> as
    <code>Id[Int]</code> and received an <code>Id[Int]</code> back as a
    result!</p>
    <p>What’s going on? Here is the definition of <code>Id</code> to
    explain:</p>
    <div class="sourceCode" id="cb512"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb512-1"><a href="#cb512-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> cats</span>
<span id="cb512-2"><a href="#cb512-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb512-3"><a href="#cb512-3" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Id<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> A</span></code></pre></div>
    <p><code>Id</code> is actually a type alias that turns an atomic
    type into a single-parameter type constructor. We can cast any value
    of any type to a corresponding <code>Id</code>:</p>
    <div class="sourceCode" id="cb513"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb513-1"><a href="#cb513-1" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;Dave&quot;</span> <span class="op">:</span> Id<span class="op">[</span><span class="ex">String</span><span class="op">]</span></span>
<span id="cb513-2"><a href="#cb513-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: String = &quot;Dave&quot;</span></span>
<span id="cb513-3"><a href="#cb513-3" aria-hidden="true" tabindex="-1"></a><span class="dv">123</span> <span class="op">:</span> Id<span class="op">[</span><span class="bu">Int</span><span class="op">]</span></span>
<span id="cb513-4"><a href="#cb513-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: Int = 123</span></span>
<span id="cb513-5"><a href="#cb513-5" aria-hidden="true" tabindex="-1"></a><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">)</span> <span class="op">:</span> Id<span class="op">[</span><span class="ex">List</span><span class="op">[</span><span class="bu">Int</span><span class="op">]]</span></span>
<span id="cb513-6"><a href="#cb513-6" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: List[Int] = List(1, 2, 3)</span></span></code></pre></div>
    <p>Cats provides instances of various type classes for
    <code>Id</code>, including <code>Functor</code> and
    <code>Monad</code>. These let us call <code>map</code>,
    <code>flatMap</code>, and <code>pure</code> on plain values:</p>
    <div class="sourceCode" id="cb514"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb514-1"><a href="#cb514-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> a <span class="op">=</span> Monad<span class="op">[</span>Id<span class="op">].</span><span class="fu">pure</span><span class="op">(</span><span class="dv">3</span><span class="op">)</span></span>
<span id="cb514-2"><a href="#cb514-2" aria-hidden="true" tabindex="-1"></a><span class="co">// a: Int = 3</span></span>
<span id="cb514-3"><a href="#cb514-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> b <span class="op">=</span> Monad<span class="op">[</span>Id<span class="op">].</span><span class="fu">flatMap</span><span class="op">(</span>a<span class="op">)(</span>_ <span class="op">+</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb514-4"><a href="#cb514-4" aria-hidden="true" tabindex="-1"></a><span class="co">// b: Int = 4</span></span></code></pre></div>
    <div class="sourceCode" id="cb515"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb515-1"><a href="#cb515-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>functor<span class="op">.*</span> <span class="co">// for map</span></span>
<span id="cb515-2"><a href="#cb515-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>flatMap<span class="op">.*</span> <span class="co">// for flatMap</span></span></code></pre></div>
    <div class="sourceCode" id="cb516"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb516-1"><a href="#cb516-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">{</span></span>
<span id="cb516-2"><a href="#cb516-2" aria-hidden="true" tabindex="-1"></a>  x <span class="op">&lt;-</span> a</span>
<span id="cb516-3"><a href="#cb516-3" aria-hidden="true" tabindex="-1"></a>  y <span class="op">&lt;-</span> b</span>
<span id="cb516-4"><a href="#cb516-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">yield</span> x <span class="op">+</span> y</span>
<span id="cb516-5"><a href="#cb516-5" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: Int = 7</span></span></code></pre></div>
    <p>The ability to abstract over monadic and non-monadic code is
    extremely powerful. For example, we can run code asynchronously in
    production using <code>Future</code> and synchronously in test using
    <code>Id</code>. We’ll see this in our first case study in Chapter
    16.</p>
    <h3 data-number="9.3.1" id="exercise-monadic-secret-identities"><span class="header-section-number">9.3.1</span> Exercise: Monadic Secret
    Identities</h3>
    <p>Implement <code>pure</code>, <code>map</code>, and
    <code>flatMap</code> for <code>Id</code>! What interesting
    discoveries do you uncover about the implementation?</p>
    <div class="solution">
    <p>Let’s start by defining the method signatures:</p>
    <div class="sourceCode" id="cb517"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb517-1"><a href="#cb517-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Id</span>
<span id="cb517-2"><a href="#cb517-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb517-3"><a href="#cb517-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pure<span class="op">[</span>A<span class="op">](</span>value<span class="op">:</span> A<span class="op">):</span> Id<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb517-4"><a href="#cb517-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">???</span></span>
<span id="cb517-5"><a href="#cb517-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb517-6"><a href="#cb517-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> map<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>initial<span class="op">:</span> Id<span class="op">[</span>A<span class="op">])(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> Id<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb517-7"><a href="#cb517-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">???</span></span>
<span id="cb517-8"><a href="#cb517-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb517-9"><a href="#cb517-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> flatMap<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>initial<span class="op">:</span> Id<span class="op">[</span>A<span class="op">])(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> Id<span class="op">[</span>B<span class="op">]):</span> Id<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb517-10"><a href="#cb517-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">???</span></span></code></pre></div>
    <p>Now let’s look at each method in turn. The <code>pure</code>
    operation creates an <code>Id[A]</code> from an <code>A</code>. But
    <code>A</code> and <code>Id[A]</code> are the same type! All we have
    to do is return the initial value:</p>
    <div class="sourceCode" id="cb518"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb518-1"><a href="#cb518-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pure<span class="op">[</span>A<span class="op">](</span>value<span class="op">:</span> A<span class="op">):</span> Id<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb518-2"><a href="#cb518-2" aria-hidden="true" tabindex="-1"></a>  value</span></code></pre></div>
    <div class="sourceCode" id="cb519"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb519-1"><a href="#cb519-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pure</span><span class="op">(</span><span class="dv">123</span><span class="op">)</span></span>
<span id="cb519-2"><a href="#cb519-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res7: Int = 123</span></span></code></pre></div>
    <p>The <code>map</code> method takes a parameter of type
    <code>Id[A]</code>, applies a function of type
    <code>A =&gt; B</code>, and returns an <code>Id[B]</code>. But
    <code>Id[A]</code> is simply <code>A</code> and <code>Id[B]</code>
    is simply <code>B</code>! All we have to do is call the function—no
    boxing or unboxing required:</p>
    <div class="sourceCode" id="cb520"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb520-1"><a href="#cb520-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> map<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>initial<span class="op">:</span> Id<span class="op">[</span>A<span class="op">])(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> Id<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb520-2"><a href="#cb520-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">func</span><span class="op">(</span>initial<span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb521"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb521-1"><a href="#cb521-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span><span class="op">(</span><span class="dv">123</span><span class="op">)(</span>_ <span class="op">*</span> <span class="dv">2</span><span class="op">)</span></span>
<span id="cb521-2"><a href="#cb521-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res8: Int = 246</span></span></code></pre></div>
    <p>The final punch line is that, once we strip away the
    <code>Id</code> type constructors, <code>flatMap</code> and
    <code>map</code> are actually identical:</p>
    <div class="sourceCode" id="cb522"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb522-1"><a href="#cb522-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> flatMap<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>initial<span class="op">:</span> Id<span class="op">[</span>A<span class="op">])(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> Id<span class="op">[</span>B<span class="op">]):</span> Id<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb522-2"><a href="#cb522-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">func</span><span class="op">(</span>initial<span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb523"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb523-1"><a href="#cb523-1" aria-hidden="true" tabindex="-1"></a><span class="fu">flatMap</span><span class="op">(</span><span class="dv">123</span><span class="op">)(</span>_ <span class="op">*</span> <span class="dv">2</span><span class="op">)</span></span>
<span id="cb523-2"><a href="#cb523-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res9: Int = 246</span></span></code></pre></div>
    <p>This ties in with our understanding of functors and monads as
    sequencing type classes. Each type class allows us to sequence
    operations ignoring some kind of complication. In the case of
    <code>Id</code> there is no complication, making <code>map</code>
    and <code>flatMap</code> the same thing.</p>
    <p>Notice that we haven’t had to write type annotations in the
    method bodies above. The compiler is able to interpret values of
    type <code>A</code> as <code>Id[A]</code> and vice versa by the
    context in which they are used.</p>
    <p>The only restriction we’ve seen to this is that Scala cannot
    unify types and type constructors when searching for given
    instances. Hence our need to re-type <code>Int</code> as
    <code>Id[Int]</code> in the call to <code>sumSquare</code> at the
    opening of this section:</p>
    <div class="sourceCode" id="cb524"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb524-1"><a href="#cb524-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sumSquare</span><span class="op">(</span><span class="dv">3</span> <span class="op">:</span> Id<span class="op">[</span><span class="bu">Int</span><span class="op">],</span> <span class="dv">4</span> <span class="op">:</span> Id<span class="op">[</span><span class="bu">Int</span><span class="op">])</span></span></code></pre></div>
    </div>
    <h2 data-number="9.4" id="either"><span class="header-section-number">9.4</span> Either</h2>
    <p>Let’s look at another useful monad: the <code>Either</code> type
    from the Scala standard library. In Scala 2.11 and earlier, many
    people didn’t consider <code>Either</code> a monad because it didn’t
    have <code>map</code> and <code>flatMap</code> methods. In Scala
    2.12, however, <code>Either</code> became <em>right biased</em>.</p>
    <h3 data-number="9.4.1" id="left-and-right-bias"><span class="header-section-number">9.4.1</span> Left and Right Bias</h3>
    <p>In Scala 2.11, <code>Either</code> had no default
    <code>map</code> or <code>flatMap</code> method. This made the Scala
    2.11 version of <code>Either</code> inconvenient to use in for
    comprehensions. We had to insert calls to <code>.right</code> in
    every generator clause:</p>
    <div class="sourceCode" id="cb525"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb525-1"><a href="#cb525-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> either1<span class="op">:</span> Either<span class="op">[</span><span class="ex">String</span><span class="op">,</span> <span class="bu">Int</span><span class="op">]</span> <span class="op">=</span> <span class="fu">Right</span><span class="op">(</span><span class="dv">10</span><span class="op">)</span></span>
<span id="cb525-2"><a href="#cb525-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> either2<span class="op">:</span> Either<span class="op">[</span><span class="ex">String</span><span class="op">,</span> <span class="bu">Int</span><span class="op">]</span> <span class="op">=</span> <span class="fu">Right</span><span class="op">(</span><span class="dv">32</span><span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb526"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb526-1"><a href="#cb526-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">{</span></span>
<span id="cb526-2"><a href="#cb526-2" aria-hidden="true" tabindex="-1"></a>  a <span class="op">&lt;-</span> either1<span class="op">.</span>right</span>
<span id="cb526-3"><a href="#cb526-3" aria-hidden="true" tabindex="-1"></a>  b <span class="op">&lt;-</span> either2<span class="op">.</span>right</span>
<span id="cb526-4"><a href="#cb526-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">yield</span> a <span class="op">+</span> b</span></code></pre></div>
    <p>In Scala 2.12, <code>Either</code> was redesigned. The modern
    <code>Either</code> makes the decision that the right side
    represents the success case and thus supports <code>map</code> and
    <code>flatMap</code> directly. This makes for comprehensions much
    more pleasant:</p>
    <div class="sourceCode" id="cb527"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb527-1"><a href="#cb527-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">{</span></span>
<span id="cb527-2"><a href="#cb527-2" aria-hidden="true" tabindex="-1"></a>  a <span class="op">&lt;-</span> either1</span>
<span id="cb527-3"><a href="#cb527-3" aria-hidden="true" tabindex="-1"></a>  b <span class="op">&lt;-</span> either2</span>
<span id="cb527-4"><a href="#cb527-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">yield</span> a <span class="op">+</span> b</span>
<span id="cb527-5"><a href="#cb527-5" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: Either[String, Int] = Right(value = 42)</span></span></code></pre></div>
    <p>Cats back-ports this behaviour to Scala 2.11 via the
    <code>cats.syntax.either</code> import, allowing us to use
    right-biased <code>Either</code> in all supported versions of Scala.
    In Scala 2.12+ we can either omit this import or leave it in place
    without breaking anything:</p>
    <div class="sourceCode" id="cb528"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb528-1"><a href="#cb528-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>either<span class="op">.*</span> <span class="co">// for map and flatMap</span></span>
<span id="cb528-2"><a href="#cb528-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb528-3"><a href="#cb528-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">{</span></span>
<span id="cb528-4"><a href="#cb528-4" aria-hidden="true" tabindex="-1"></a>  a <span class="op">&lt;-</span> either1</span>
<span id="cb528-5"><a href="#cb528-5" aria-hidden="true" tabindex="-1"></a>  b <span class="op">&lt;-</span> either2</span>
<span id="cb528-6"><a href="#cb528-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">yield</span> a <span class="op">+</span> b</span></code></pre></div>
    <h3 data-number="9.4.2" id="creating-instances"><span class="header-section-number">9.4.2</span> Creating Instances</h3>
    <p>In addition to creating instances of <code>Left</code> and
    <code>Right</code> directly, we can also import the
    <code>asLeft</code> and <code>asRight</code> extension methods from
    <a href="http://typelevel.org/cats/api/cats/syntax/package$$either$"><code>cats.syntax.either</code></a>:</p>
    <div class="sourceCode" id="cb529"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb529-1"><a href="#cb529-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>either<span class="op">.*</span> <span class="co">// for asRight</span></span></code></pre></div>
    <div class="sourceCode" id="cb530"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb530-1"><a href="#cb530-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> a <span class="op">=</span> <span class="fl">3.</span>asRight<span class="op">[</span><span class="ex">String</span><span class="op">]</span></span>
<span id="cb530-2"><a href="#cb530-2" aria-hidden="true" tabindex="-1"></a><span class="co">// a: Either[String, Int] = Right(value = 3)</span></span>
<span id="cb530-3"><a href="#cb530-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> b <span class="op">=</span> <span class="fl">4.</span>asRight<span class="op">[</span><span class="ex">String</span><span class="op">]</span></span>
<span id="cb530-4"><a href="#cb530-4" aria-hidden="true" tabindex="-1"></a><span class="co">// b: Either[String, Int] = Right(value = 4)</span></span>
<span id="cb530-5"><a href="#cb530-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb530-6"><a href="#cb530-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">{</span></span>
<span id="cb530-7"><a href="#cb530-7" aria-hidden="true" tabindex="-1"></a>  x <span class="op">&lt;-</span> a</span>
<span id="cb530-8"><a href="#cb530-8" aria-hidden="true" tabindex="-1"></a>  y <span class="op">&lt;-</span> b</span>
<span id="cb530-9"><a href="#cb530-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">yield</span> x<span class="op">*</span>x <span class="op">+</span> y<span class="op">*</span>y</span>
<span id="cb530-10"><a href="#cb530-10" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: Either[String, Int] = Right(value = 25)</span></span></code></pre></div>
    <p>These “smart constructors” have advantages over
    <code>Left.apply</code> and <code>Right.apply</code> because they
    return results of type <code>Either</code> instead of
    <code>Left</code> and <code>Right</code>. This helps avoid type
    inference problems caused by over-narrowing, like the issue in the
    example below:</p>
    <div class="sourceCode" id="cb531"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb531-1"><a href="#cb531-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">countPositive</span><span class="op">(</span>nums<span class="op">:</span> <span class="ex">List</span><span class="op">[</span><span class="bu">Int</span><span class="op">])</span> <span class="op">=</span></span>
<span id="cb531-2"><a href="#cb531-2" aria-hidden="true" tabindex="-1"></a>  nums<span class="op">.</span><span class="fu">foldLeft</span><span class="op">(</span><span class="fu">Right</span><span class="op">(</span><span class="dv">0</span><span class="op">))</span> <span class="op">{</span> <span class="op">(</span>accumulator<span class="op">,</span> num<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb531-3"><a href="#cb531-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>num <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb531-4"><a href="#cb531-4" aria-hidden="true" tabindex="-1"></a>      accumulator<span class="op">.</span><span class="fu">map</span><span class="op">(</span>_ <span class="op">+</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb531-5"><a href="#cb531-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb531-6"><a href="#cb531-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">Left</span><span class="op">(</span><span class="st">&quot;Negative. Stopping!&quot;</span><span class="op">)</span></span>
<span id="cb531-7"><a href="#cb531-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb531-8"><a href="#cb531-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb531-9"><a href="#cb531-9" aria-hidden="true" tabindex="-1"></a><span class="co">// error:</span></span>
<span id="cb531-10"><a href="#cb531-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Found:    Either[Nothing, Int]</span></span>
<span id="cb531-11"><a href="#cb531-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Required: Right[Nothing, Int]</span></span>
<span id="cb531-12"><a href="#cb531-12" aria-hidden="true" tabindex="-1"></a><span class="co">//       accumulator.map(_ + 1)</span></span>
<span id="cb531-13"><a href="#cb531-13" aria-hidden="true" tabindex="-1"></a><span class="co">//       ^^^^^^^^^^^^^^^^^^^^^^</span></span>
<span id="cb531-14"><a href="#cb531-14" aria-hidden="true" tabindex="-1"></a><span class="co">// error:</span></span>
<span id="cb531-15"><a href="#cb531-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Found:    Left[String, Any]</span></span>
<span id="cb531-16"><a href="#cb531-16" aria-hidden="true" tabindex="-1"></a><span class="co">// Required: Right[Nothing, Int]</span></span>
<span id="cb531-17"><a href="#cb531-17" aria-hidden="true" tabindex="-1"></a><span class="co">//       Left(&quot;Negative. Stopping!&quot;)</span></span>
<span id="cb531-18"><a href="#cb531-18" aria-hidden="true" tabindex="-1"></a><span class="co">//       ^^^^^^^^^^^^^^^^^^^^^^^^^^^</span></span></code></pre></div>
    <p>This code fails to compile for two reasons:</p>
    <ol type="1">
    <li>the compiler infers the type of the accumulator as
    <code>Right</code> instead of <code>Either</code>;</li>
    <li>we didn’t specify type parameters for <code>Right.apply</code>
    so the compiler infers the left parameter as
    <code>Nothing</code>.</li>
    </ol>
    <p>Switching to <code>asRight</code> avoids both of these problems.
    <code>asRight</code> has a return type of <code>Either</code>, and
    allows us to completely specify the type with only one type
    parameter:</p>
    <div class="sourceCode" id="cb532"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb532-1"><a href="#cb532-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">countPositive</span><span class="op">(</span>nums<span class="op">:</span> <span class="ex">List</span><span class="op">[</span><span class="bu">Int</span><span class="op">])</span> <span class="op">=</span></span>
<span id="cb532-2"><a href="#cb532-2" aria-hidden="true" tabindex="-1"></a>  nums<span class="op">.</span><span class="fu">foldLeft</span><span class="op">(</span><span class="fl">0.</span>asRight<span class="op">[</span><span class="ex">String</span><span class="op">])</span> <span class="op">{</span> <span class="op">(</span>accumulator<span class="op">,</span> num<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb532-3"><a href="#cb532-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>num <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb532-4"><a href="#cb532-4" aria-hidden="true" tabindex="-1"></a>      accumulator<span class="op">.</span><span class="fu">map</span><span class="op">(</span>_ <span class="op">+</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb532-5"><a href="#cb532-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb532-6"><a href="#cb532-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">Left</span><span class="op">(</span><span class="st">&quot;Negative. Stopping!&quot;</span><span class="op">)</span></span>
<span id="cb532-7"><a href="#cb532-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb532-8"><a href="#cb532-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <div class="sourceCode" id="cb533"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb533-1"><a href="#cb533-1" aria-hidden="true" tabindex="-1"></a><span class="fu">countPositive</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">))</span></span>
<span id="cb533-2"><a href="#cb533-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: Either[String, Int] = Right(value = 3)</span></span>
<span id="cb533-3"><a href="#cb533-3" aria-hidden="true" tabindex="-1"></a><span class="fu">countPositive</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">-</span><span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">))</span></span>
<span id="cb533-4"><a href="#cb533-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res6: Either[String, Int] = Left(value = &quot;Negative. Stopping!&quot;)</span></span></code></pre></div>
    <p><code>cats.syntax.either</code> adds some useful extension
    methods to the <code>Either</code> companion object. The
    <code>catchOnly</code> and <code>catchNonFatal</code> methods are
    great for capturing <code>Exceptions</code> as instances of
    <code>Either</code>:</p>
    <div class="sourceCode" id="cb534"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb534-1"><a href="#cb534-1" aria-hidden="true" tabindex="-1"></a>Either<span class="op">.</span>catchOnly<span class="op">[</span><span class="ex">NumberFormatException</span><span class="op">](</span><span class="st">&quot;foo&quot;</span><span class="op">.</span>toInt<span class="op">)</span></span>
<span id="cb534-2"><a href="#cb534-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res7: Either[NumberFormatException, Int] = Left(</span></span>
<span id="cb534-3"><a href="#cb534-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   value = java.lang.NumberFormatException: For input string: &quot;foo&quot;</span></span>
<span id="cb534-4"><a href="#cb534-4" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span>
<span id="cb534-5"><a href="#cb534-5" aria-hidden="true" tabindex="-1"></a>Either<span class="op">.</span><span class="fu">catchNonFatal</span><span class="op">(</span>sys<span class="op">.</span><span class="fu">error</span><span class="op">(</span><span class="st">&quot;Badness&quot;</span><span class="op">))</span></span>
<span id="cb534-6"><a href="#cb534-6" aria-hidden="true" tabindex="-1"></a><span class="co">// res8: Either[Throwable, Nothing] = Left(</span></span>
<span id="cb534-7"><a href="#cb534-7" aria-hidden="true" tabindex="-1"></a><span class="co">//   value = java.lang.RuntimeException: Badness</span></span>
<span id="cb534-8"><a href="#cb534-8" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>There are also methods for creating an <code>Either</code> from
    other data types:</p>
    <div class="sourceCode" id="cb535"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb535-1"><a href="#cb535-1" aria-hidden="true" tabindex="-1"></a>Either<span class="op">.</span><span class="fu">fromTry</span><span class="op">(</span>scala<span class="op">.</span>util<span class="op">.</span><span class="fu">Try</span><span class="op">(</span><span class="st">&quot;foo&quot;</span><span class="op">.</span>toInt<span class="op">))</span></span>
<span id="cb535-2"><a href="#cb535-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res9: Either[Throwable, Int] = Left(</span></span>
<span id="cb535-3"><a href="#cb535-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   value = java.lang.NumberFormatException: For input string: &quot;foo&quot;</span></span>
<span id="cb535-4"><a href="#cb535-4" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span>
<span id="cb535-5"><a href="#cb535-5" aria-hidden="true" tabindex="-1"></a>Either<span class="op">.</span>fromOption<span class="op">[</span><span class="ex">String</span><span class="op">,</span> <span class="bu">Int</span><span class="op">](</span><span class="bu">None</span><span class="op">,</span> <span class="st">&quot;Badness&quot;</span><span class="op">)</span></span>
<span id="cb535-6"><a href="#cb535-6" aria-hidden="true" tabindex="-1"></a><span class="co">// res10: Either[String, Int] = Left(value = &quot;Badness&quot;)</span></span></code></pre></div>
    <h3 data-number="9.4.3" id="transforming-eithers"><span class="header-section-number">9.4.3</span> Transforming Eithers</h3>
    <p><code>cats.syntax.either</code> also adds some useful methods for
    instances of <code>Either</code>.</p>
    <p>Users of Scala 2.11 or 2.12 can use <code>orElse</code> and
    <code>getOrElse</code> to extract values from the right side or
    return a default:</p>
    <div class="sourceCode" id="cb536"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb536-1"><a href="#cb536-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>either<span class="op">.*</span></span></code></pre></div>
    <div class="sourceCode" id="cb537"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb537-1"><a href="#cb537-1" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;Error&quot;</span><span class="op">.</span>asLeft<span class="op">[</span><span class="bu">Int</span><span class="op">].</span><span class="fu">getOrElse</span><span class="op">(</span><span class="dv">0</span><span class="op">)</span></span>
<span id="cb537-2"><a href="#cb537-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res11: Int = 0</span></span>
<span id="cb537-3"><a href="#cb537-3" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;Error&quot;</span><span class="op">.</span>asLeft<span class="op">[</span><span class="bu">Int</span><span class="op">].</span><span class="fu">orElse</span><span class="op">(</span><span class="fl">2.</span>asRight<span class="op">[</span><span class="ex">String</span><span class="op">])</span></span>
<span id="cb537-4"><a href="#cb537-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res12: Either[String, Int] = Right(value = 2)</span></span></code></pre></div>
    <p>The <code>ensure</code> method allows us to check whether the
    right-hand value satisfies a predicate:</p>
    <div class="sourceCode" id="cb538"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb538-1"><a href="#cb538-1" aria-hidden="true" tabindex="-1"></a><span class="op">-</span><span class="fl">1.</span>asRight<span class="op">[</span><span class="ex">String</span><span class="op">].</span><span class="fu">ensure</span><span class="op">(</span><span class="st">&quot;Must be non-negative!&quot;</span><span class="op">)(</span>_ <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb538-2"><a href="#cb538-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res13: Either[String, Int] = Left(value = &quot;Must be non-negative!&quot;)</span></span></code></pre></div>
    <p>The <code>recover</code> and <code>recoverWith</code> methods
    provide similar error handling to their namesakes on
    <code>Future</code>:</p>
    <div class="sourceCode" id="cb539"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb539-1"><a href="#cb539-1" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;error&quot;</span><span class="op">.</span>asLeft<span class="op">[</span><span class="bu">Int</span><span class="op">].</span>recover <span class="op">{</span></span>
<span id="cb539-2"><a href="#cb539-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> _<span class="op">:</span> <span class="ex">String</span> <span class="op">=&gt;</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb539-3"><a href="#cb539-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb539-4"><a href="#cb539-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res14: Either[String, Int] = Right(value = -1)</span></span>
<span id="cb539-5"><a href="#cb539-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb539-6"><a href="#cb539-6" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;error&quot;</span><span class="op">.</span>asLeft<span class="op">[</span><span class="bu">Int</span><span class="op">].</span>recoverWith <span class="op">{</span></span>
<span id="cb539-7"><a href="#cb539-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> _<span class="op">:</span> <span class="ex">String</span> <span class="op">=&gt;</span> <span class="fu">Right</span><span class="op">(-</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb539-8"><a href="#cb539-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb539-9"><a href="#cb539-9" aria-hidden="true" tabindex="-1"></a><span class="co">// res15: Either[String, Int] = Right(value = -1)</span></span></code></pre></div>
    <p>There are <code>leftMap</code> and <code>bimap</code> methods to
    complement <code>map</code>:</p>
    <div class="sourceCode" id="cb540"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb540-1"><a href="#cb540-1" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;foo&quot;</span><span class="op">.</span>asLeft<span class="op">[</span><span class="bu">Int</span><span class="op">].</span><span class="fu">leftMap</span><span class="op">(</span>_<span class="op">.</span>reverse<span class="op">)</span></span>
<span id="cb540-2"><a href="#cb540-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res16: Either[String, Int] = Left(value = &quot;oof&quot;)</span></span>
<span id="cb540-3"><a href="#cb540-3" aria-hidden="true" tabindex="-1"></a><span class="fl">6.</span>asRight<span class="op">[</span><span class="ex">String</span><span class="op">].</span><span class="fu">bimap</span><span class="op">(</span>_<span class="op">.</span>reverse<span class="op">,</span> _ <span class="op">*</span> <span class="dv">7</span><span class="op">)</span></span>
<span id="cb540-4"><a href="#cb540-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res17: Either[String, Int] = Right(value = 42)</span></span>
<span id="cb540-5"><a href="#cb540-5" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;bar&quot;</span><span class="op">.</span>asLeft<span class="op">[</span><span class="bu">Int</span><span class="op">].</span><span class="fu">bimap</span><span class="op">(</span>_<span class="op">.</span>reverse<span class="op">,</span> _ <span class="op">*</span> <span class="dv">7</span><span class="op">)</span></span>
<span id="cb540-6"><a href="#cb540-6" aria-hidden="true" tabindex="-1"></a><span class="co">// res18: Either[String, Int] = Left(value = &quot;rab&quot;)</span></span></code></pre></div>
    <p>The <code>swap</code> method lets us exchange left for right:</p>
    <div class="sourceCode" id="cb541"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb541-1"><a href="#cb541-1" aria-hidden="true" tabindex="-1"></a><span class="fl">123.</span>asRight<span class="op">[</span><span class="ex">String</span><span class="op">]</span></span>
<span id="cb541-2"><a href="#cb541-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res19: Either[String, Int] = Right(value = 123)</span></span>
<span id="cb541-3"><a href="#cb541-3" aria-hidden="true" tabindex="-1"></a><span class="fl">123.</span>asRight<span class="op">[</span><span class="ex">String</span><span class="op">].</span>swap</span>
<span id="cb541-4"><a href="#cb541-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res20: Either[Int, String] = Left(value = 123)</span></span></code></pre></div>
    <p>Finally, Cats adds a host of conversion methods:
    <code>toOption</code>, <code>toList</code>, <code>toTry</code>,
    <code>toValidated</code>, and so on.</p>
    <h3 data-number="9.4.4" id="error-handling"><span class="header-section-number">9.4.4</span> Error Handling</h3>
    <p><code>Either</code> is typically used to implement fail-fast
    error handling. We sequence computations using <code>flatMap</code>
    as usual. If one computation fails, the remaining computations are
    not run:</p>
    <div class="sourceCode" id="cb542"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb542-1"><a href="#cb542-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">{</span></span>
<span id="cb542-2"><a href="#cb542-2" aria-hidden="true" tabindex="-1"></a>  a <span class="op">&lt;-</span> <span class="fl">1.</span>asRight<span class="op">[</span><span class="ex">String</span><span class="op">]</span></span>
<span id="cb542-3"><a href="#cb542-3" aria-hidden="true" tabindex="-1"></a>  b <span class="op">&lt;-</span> <span class="fl">0.</span>asRight<span class="op">[</span><span class="ex">String</span><span class="op">]</span></span>
<span id="cb542-4"><a href="#cb542-4" aria-hidden="true" tabindex="-1"></a>  c <span class="op">&lt;-</span> <span class="cf">if</span><span class="op">(</span>b <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="st">&quot;DIV0&quot;</span><span class="op">.</span>asLeft<span class="op">[</span><span class="bu">Int</span><span class="op">]</span></span>
<span id="cb542-5"><a href="#cb542-5" aria-hidden="true" tabindex="-1"></a>       <span class="cf">else</span> <span class="op">(</span>a <span class="op">/</span> b<span class="op">).</span>asRight<span class="op">[</span><span class="ex">String</span><span class="op">]</span></span>
<span id="cb542-6"><a href="#cb542-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">yield</span> c <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb542-7"><a href="#cb542-7" aria-hidden="true" tabindex="-1"></a><span class="co">// res21: Either[String, Int] = Left(value = &quot;DIV0&quot;)</span></span></code></pre></div>
    <p>When using <code>Either</code> for error handling, we need to
    determine what type we want to use to represent errors. We could use
    <code>Throwable</code> for this:</p>
    <div class="sourceCode" id="cb543"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb543-1"><a href="#cb543-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="ex">Result</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> Either<span class="op">[</span><span class="ex">Throwable</span><span class="op">,</span> A<span class="op">]</span></span></code></pre></div>
    <p>This gives us similar semantics to <code>scala.util.Try</code>.
    The problem, however, is that <code>Throwable</code> is an extremely
    broad type. We have (almost) no idea about what type of error
    occurred.</p>
    <p>Another approach is to define an algebraic data type to represent
    errors that may occur in our program:</p>
    <div class="sourceCode" id="cb544"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb544-1"><a href="#cb544-1" aria-hidden="true" tabindex="-1"></a>enum LoginError <span class="op">{</span></span>
<span id="cb544-2"><a href="#cb544-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">UserNotFound</span><span class="op">(</span>username<span class="op">:</span> <span class="ex">String</span><span class="op">)</span></span>
<span id="cb544-3"><a href="#cb544-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb544-4"><a href="#cb544-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">PasswordIncorrect</span><span class="op">(</span>username<span class="op">:</span> <span class="ex">String</span><span class="op">)</span></span>
<span id="cb544-5"><a href="#cb544-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb544-6"><a href="#cb544-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> UnexpectedError </span>
<span id="cb544-7"><a href="#cb544-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <div class="sourceCode" id="cb545"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb545-1"><a href="#cb545-1" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">User</span><span class="op">(</span>username<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> password<span class="op">:</span> <span class="ex">String</span><span class="op">)</span></span>
<span id="cb545-2"><a href="#cb545-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb545-3"><a href="#cb545-3" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> LoginResult <span class="op">=</span> Either<span class="op">[</span>LoginError<span class="op">,</span> User<span class="op">]</span></span></code></pre></div>
    <p>This approach solves the problems we saw with
    <code>Throwable</code>. It gives us a fixed set of expected error
    types and a catch-all for anything else that we didn’t expect. We
    also get the safety of exhaustivity checking on any pattern matching
    we do:</p>
    <div class="sourceCode" id="cb546"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb546-1"><a href="#cb546-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> LoginError<span class="op">.*</span></span>
<span id="cb546-2"><a href="#cb546-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb546-3"><a href="#cb546-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Choose error-handling behaviour based on type:</span></span>
<span id="cb546-4"><a href="#cb546-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">handleError</span><span class="op">(</span>error<span class="op">:</span> LoginError<span class="op">):</span> <span class="bu">Unit</span> <span class="op">=</span></span>
<span id="cb546-5"><a href="#cb546-5" aria-hidden="true" tabindex="-1"></a>  error <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb546-6"><a href="#cb546-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">UserNotFound</span><span class="op">(</span>u<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb546-7"><a href="#cb546-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">println</span><span class="op">(</span><span class="ss">s&quot;</span><span class="st">User not found: </span><span class="ss">$u&quot;</span><span class="op">)</span></span>
<span id="cb546-8"><a href="#cb546-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb546-9"><a href="#cb546-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">PasswordIncorrect</span><span class="op">(</span>u<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb546-10"><a href="#cb546-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">println</span><span class="op">(</span><span class="ss">s&quot;</span><span class="st">Password incorrect: </span><span class="ss">$u&quot;</span><span class="op">)</span></span>
<span id="cb546-11"><a href="#cb546-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb546-12"><a href="#cb546-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> UnexpectedError <span class="op">=&gt;</span></span>
<span id="cb546-13"><a href="#cb546-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">println</span><span class="op">(</span><span class="ss">s&quot;</span><span class="st">Unexpected error</span><span class="ss">&quot;</span><span class="op">)</span></span>
<span id="cb546-14"><a href="#cb546-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <div class="sourceCode" id="cb547"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb547-1"><a href="#cb547-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> result1<span class="op">:</span> LoginResult <span class="op">=</span> <span class="fu">User</span><span class="op">(</span><span class="st">&quot;dave&quot;</span><span class="op">,</span> <span class="st">&quot;passw0rd&quot;</span><span class="op">).</span>asRight</span>
<span id="cb547-2"><a href="#cb547-2" aria-hidden="true" tabindex="-1"></a><span class="co">// result1: Either[LoginError, User] = Right(</span></span>
<span id="cb547-3"><a href="#cb547-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   value = User(username = &quot;dave&quot;, password = &quot;passw0rd&quot;)</span></span>
<span id="cb547-4"><a href="#cb547-4" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span>
<span id="cb547-5"><a href="#cb547-5" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> result2<span class="op">:</span> LoginResult <span class="op">=</span> <span class="fu">UserNotFound</span><span class="op">(</span><span class="st">&quot;dave&quot;</span><span class="op">).</span>asLeft</span>
<span id="cb547-6"><a href="#cb547-6" aria-hidden="true" tabindex="-1"></a><span class="co">// result2: Either[LoginError, User] = Left(</span></span>
<span id="cb547-7"><a href="#cb547-7" aria-hidden="true" tabindex="-1"></a><span class="co">//   value = UserNotFound(username = &quot;dave&quot;)</span></span>
<span id="cb547-8"><a href="#cb547-8" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span>
<span id="cb547-9"><a href="#cb547-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb547-10"><a href="#cb547-10" aria-hidden="true" tabindex="-1"></a>result1<span class="op">.</span><span class="fu">fold</span><span class="op">(</span>handleError<span class="op">,</span> println<span class="op">)</span></span>
<span id="cb547-11"><a href="#cb547-11" aria-hidden="true" tabindex="-1"></a><span class="co">// User(dave,passw0rd)</span></span>
<span id="cb547-12"><a href="#cb547-12" aria-hidden="true" tabindex="-1"></a>result2<span class="op">.</span><span class="fu">fold</span><span class="op">(</span>handleError<span class="op">,</span> println<span class="op">)</span></span>
<span id="cb547-13"><a href="#cb547-13" aria-hidden="true" tabindex="-1"></a><span class="co">// User not found: dave</span></span></code></pre></div>
    <h3 data-number="9.4.5" id="exercise-what-is-best"><span class="header-section-number">9.4.5</span> Exercise: What is
    Best?</h3>
    <p>Is the error handling strategy in the previous examples well
    suited for all purposes? What other features might we want from
    error handling?</p>
    <div class="solution">
    <p>This is an open question. It’s also kind of a trick question—the
    answer depends on the semantics we’re looking for. Some points to
    ponder:</p>
    <ul>
    <li><p>Error recovery is important when processing large jobs. We
    don’t want to run a job for a day and then find it failed on the
    last element.</p></li>
    <li><p>Error reporting is equally important. We need to know what
    went wrong, not just that something went wrong.</p></li>
    <li><p>In a number of cases, we want to collect all the errors, not
    just the first one we encountered. A typical example is validating a
    web form. It’s a far better experience to report all errors to the
    user when they submit a form than to report them one at a
    time.</p></li>
    </ul>
    </div>
    <h2 data-number="9.5" id="aside-error-handling-and-monaderror"><span class="header-section-number">9.5</span> Aside: Error Handling and
    MonadError</h2>
    <p>Cats provides an additional type class called
    <code>MonadError</code> that abstracts over <code>Either</code>-like
    data types that are used for error handling. <code>MonadError</code>
    provides extra operations for raising and handling errors.</p>
    <section id="this-section-is-optional" class="unnumbered callout callout-info">
    <h4 class="unnumbered">This Section is Optional!</h4>
    <p>You won’t need to use <code>MonadError</code> unless you need to
    abstract over error handling monads. For example, you can use
    <code>MonadError</code> to abstract over <code>Future</code> and
    <code>Try</code>, or over <code>Either</code> and
    <code>EitherT</code> (which we will meet in Chapter 10).</p>
    <p>If you don’t need this kind of abstraction right now, feel free
    to skip onwards to Section 9.6.</p>
    </section>
    <h3 data-number="9.5.1" id="the-monaderror-type-class"><span class="header-section-number">9.5.1</span> The MonadError Type
    Class</h3>
    <p>Here is a simplified version of the definition of
    <code>MonadError</code>:</p>
    <div class="sourceCode" id="cb548"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb548-1"><a href="#cb548-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> cats</span>
<span id="cb548-2"><a href="#cb548-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb548-3"><a href="#cb548-3" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> MonadError<span class="op">[</span>F<span class="op">[</span>_<span class="op">],</span> E<span class="op">]</span> <span class="kw">extends</span> Monad<span class="op">[</span>F<span class="op">]</span> <span class="op">{</span></span>
<span id="cb548-4"><a href="#cb548-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Lift an error into the `F` context:</span></span>
<span id="cb548-5"><a href="#cb548-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> raiseError<span class="op">[</span>A<span class="op">](</span>e<span class="op">:</span> E<span class="op">):</span> F<span class="op">[</span>A<span class="op">]</span></span>
<span id="cb548-6"><a href="#cb548-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb548-7"><a href="#cb548-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Handle an error, potentially recovering from it:</span></span>
<span id="cb548-8"><a href="#cb548-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> handleErrorWith<span class="op">[</span>A<span class="op">](</span>fa<span class="op">:</span> F<span class="op">[</span>A<span class="op">])(</span>f<span class="op">:</span> E <span class="op">=&gt;</span> F<span class="op">[</span>A<span class="op">]):</span> F<span class="op">[</span>A<span class="op">]</span></span>
<span id="cb548-9"><a href="#cb548-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb548-10"><a href="#cb548-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Handle all errors, recovering from them:</span></span>
<span id="cb548-11"><a href="#cb548-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> handleError<span class="op">[</span>A<span class="op">](</span>fa<span class="op">:</span> F<span class="op">[</span>A<span class="op">])(</span>f<span class="op">:</span> E <span class="op">=&gt;</span> A<span class="op">):</span> F<span class="op">[</span>A<span class="op">]</span></span>
<span id="cb548-12"><a href="#cb548-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb548-13"><a href="#cb548-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Test an instance of `F`,</span></span>
<span id="cb548-14"><a href="#cb548-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">// failing if the predicate is not satisfied:</span></span>
<span id="cb548-15"><a href="#cb548-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> ensure<span class="op">[</span>A<span class="op">](</span>fa<span class="op">:</span> F<span class="op">[</span>A<span class="op">])(</span>e<span class="op">:</span> E<span class="op">)(</span>f<span class="op">:</span> A <span class="op">=&gt;</span> <span class="ex">Boolean</span><span class="op">):</span> F<span class="op">[</span>A<span class="op">]</span></span>
<span id="cb548-16"><a href="#cb548-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p><code>MonadError</code> is defined in terms of two type
    parameters:</p>
    <ul>
    <li><code>F</code> is the type of the monad;</li>
    <li><code>E</code> is the type of error contained within
    <code>F</code>.</li>
    </ul>
    <p>To demonstrate how these parameters fit together, here’s an
    example where we instantiate the type class for
    <code>Either</code>:</p>
    <div class="sourceCode" id="cb549"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb549-1"><a href="#cb549-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>MonadError</span>
<span id="cb549-2"><a href="#cb549-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb549-3"><a href="#cb549-3" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> ErrorOr<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> Either<span class="op">[</span><span class="ex">String</span><span class="op">,</span> A<span class="op">]</span></span>
<span id="cb549-4"><a href="#cb549-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb549-5"><a href="#cb549-5" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> monadError <span class="op">=</span> MonadError<span class="op">[</span>ErrorOr<span class="op">,</span> <span class="ex">String</span><span class="op">]</span></span></code></pre></div>
    <div class="callout callout-warning">
    <p><em>ApplicativeError</em></p>
    <p>In reality, <code>MonadError</code> extends another type class
    called <code>ApplicativeError</code>. However, we won’t encounter
    <code>Applicatives</code> until Chapter 11. The semantics are the
    same for each type class so we can ignore this detail for now.</p>
    </div>
    <h3 data-number="9.5.2" id="raising-and-handling-errors"><span class="header-section-number">9.5.2</span> Raising and Handling
    Errors</h3>
    <p>The two most important methods of <code>MonadError</code> are
    <code>raiseError</code> and <code>handleErrorWith</code>.
    <code>raiseError</code> is like the <code>pure</code> method for
    <code>Monad</code> except that it creates an instance representing a
    failure:</p>
    <div class="sourceCode" id="cb550"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb550-1"><a href="#cb550-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> success <span class="op">=</span> monadError<span class="op">.</span><span class="fu">pure</span><span class="op">(</span><span class="dv">42</span><span class="op">)</span></span>
<span id="cb550-2"><a href="#cb550-2" aria-hidden="true" tabindex="-1"></a><span class="co">// success: Either[String, Int] = Right(value = 42)</span></span>
<span id="cb550-3"><a href="#cb550-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> failure <span class="op">=</span> monadError<span class="op">.</span><span class="fu">raiseError</span><span class="op">(</span><span class="st">&quot;Badness&quot;</span><span class="op">)</span></span>
<span id="cb550-4"><a href="#cb550-4" aria-hidden="true" tabindex="-1"></a><span class="co">// failure: Either[String, Nothing] = Left(value = &quot;Badness&quot;)</span></span></code></pre></div>
    <p><code>handleErrorWith</code> is the complement of
    <code>raiseError</code>. It allows us to consume an error and
    (possibly) turn it into a success, similar to the
    <code>recover</code> method of <code>Future</code>:</p>
    <div class="sourceCode" id="cb551"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb551-1"><a href="#cb551-1" aria-hidden="true" tabindex="-1"></a>monadError<span class="op">.</span><span class="fu">handleErrorWith</span><span class="op">(</span>failure<span class="op">)</span> <span class="op">{</span></span>
<span id="cb551-2"><a href="#cb551-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="st">&quot;Badness&quot;</span> <span class="op">=&gt;</span></span>
<span id="cb551-3"><a href="#cb551-3" aria-hidden="true" tabindex="-1"></a>    monadError<span class="op">.</span><span class="fu">pure</span><span class="op">(</span><span class="st">&quot;It&#39;s ok&quot;</span><span class="op">)</span></span>
<span id="cb551-4"><a href="#cb551-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb551-5"><a href="#cb551-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> _ <span class="op">=&gt;</span></span>
<span id="cb551-6"><a href="#cb551-6" aria-hidden="true" tabindex="-1"></a>    monadError<span class="op">.</span><span class="fu">raiseError</span><span class="op">(</span><span class="st">&quot;It&#39;s not ok&quot;</span><span class="op">)</span></span>
<span id="cb551-7"><a href="#cb551-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb551-8"><a href="#cb551-8" aria-hidden="true" tabindex="-1"></a><span class="co">// res0: Either[String, String] = Right(value = &quot;It&#39;s ok&quot;)</span></span></code></pre></div>
    <p>If we know we can handle all possible errors we can use
    <code>handleWith</code>.</p>
    <div class="sourceCode" id="cb552"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb552-1"><a href="#cb552-1" aria-hidden="true" tabindex="-1"></a>monadError<span class="op">.</span><span class="fu">handleError</span><span class="op">(</span>failure<span class="op">)</span> <span class="op">{</span></span>
<span id="cb552-2"><a href="#cb552-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="st">&quot;Badness&quot;</span> <span class="op">=&gt;</span> <span class="dv">42</span></span>
<span id="cb552-3"><a href="#cb552-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb552-4"><a href="#cb552-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> _ <span class="op">=&gt;</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb552-5"><a href="#cb552-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb552-6"><a href="#cb552-6" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: Either[String, Int] = Right(value = 42)</span></span></code></pre></div>
    <p>There is another useful method called <code>ensure</code> that
    implements <code>filter</code>-like behaviour. We test the value of
    a successful monad with a predicate and specify an error to raise if
    the predicate returns <code>false</code>:</p>
    <div class="sourceCode" id="cb553"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb553-1"><a href="#cb553-1" aria-hidden="true" tabindex="-1"></a>monadError<span class="op">.</span><span class="fu">ensure</span><span class="op">(</span>success<span class="op">)(</span><span class="st">&quot;Number too low!&quot;</span><span class="op">)(</span>_ <span class="op">&gt;</span> <span class="dv">1000</span><span class="op">)</span></span>
<span id="cb553-2"><a href="#cb553-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: Either[String, Int] = Left(value = &quot;Number too low!&quot;)</span></span></code></pre></div>
    <p>Cats provides syntax for <code>raiseError</code> and
    <code>handleErrorWith</code> via <a href="http://typelevel.org/cats/api/cats/syntax/package$$applicativeError$"><code>cats.syntax.applicativeError</code></a>
    and <code>ensure</code> via <a href="http://typelevel.org/cats/api/cats/syntax/package$$monadError$"><code>cats.syntax.monadError</code></a>:</p>
    <div class="sourceCode" id="cb554"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb554-1"><a href="#cb554-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>applicative<span class="op">.*</span>      <span class="co">// for pure</span></span>
<span id="cb554-2"><a href="#cb554-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>applicativeError<span class="op">.*</span> <span class="co">// for raiseError etc</span></span>
<span id="cb554-3"><a href="#cb554-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>monadError<span class="op">.*</span>       <span class="co">// for ensure</span></span></code></pre></div>
    <div class="sourceCode" id="cb555"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb555-1"><a href="#cb555-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> success <span class="op">=</span> <span class="fl">42.</span>pure<span class="op">[</span>ErrorOr<span class="op">]</span></span>
<span id="cb555-2"><a href="#cb555-2" aria-hidden="true" tabindex="-1"></a><span class="co">// success: Either[String, Int] = Right(value = 42)</span></span>
<span id="cb555-3"><a href="#cb555-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> failure <span class="op">=</span> <span class="st">&quot;Badness&quot;</span><span class="op">.</span>raiseError<span class="op">[</span>ErrorOr<span class="op">,</span> <span class="bu">Int</span><span class="op">]</span></span>
<span id="cb555-4"><a href="#cb555-4" aria-hidden="true" tabindex="-1"></a><span class="co">// failure: Either[String, Int] = Left(value = &quot;Badness&quot;)</span></span>
<span id="cb555-5"><a href="#cb555-5" aria-hidden="true" tabindex="-1"></a>failure<span class="op">.</span>handleErrorWith<span class="op">{</span></span>
<span id="cb555-6"><a href="#cb555-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="st">&quot;Badness&quot;</span> <span class="op">=&gt;</span></span>
<span id="cb555-7"><a href="#cb555-7" aria-hidden="true" tabindex="-1"></a>    <span class="fl">256.</span>pure</span>
<span id="cb555-8"><a href="#cb555-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb555-9"><a href="#cb555-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> _ <span class="op">=&gt;</span></span>
<span id="cb555-10"><a href="#cb555-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span><span class="st">&quot;It&#39;s not ok&quot;</span><span class="op">).</span>raiseError</span>
<span id="cb555-11"><a href="#cb555-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb555-12"><a href="#cb555-12" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: Either[String, Int] = Right(value = 256)</span></span>
<span id="cb555-13"><a href="#cb555-13" aria-hidden="true" tabindex="-1"></a>success<span class="op">.</span><span class="fu">ensure</span><span class="op">(</span><span class="st">&quot;Number to low!&quot;</span><span class="op">)(</span>_ <span class="op">&gt;</span> <span class="dv">1000</span><span class="op">)</span></span>
<span id="cb555-14"><a href="#cb555-14" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: Either[String, Int] = Left(value = &quot;Number to low!&quot;)</span></span></code></pre></div>
    <p>There are other useful variants of these methods. See the source
    of <a href="http://typelevel.org/cats/api/cats/MonadError.html"><code>cats.MonadError</code></a>
    and <a href="http://typelevel.org/cats/api/cats/ApplicativeError.html"><code>cats.ApplicativeError</code></a>
    for more information.</p>
    <h3 data-number="9.5.3" id="instances-of-monaderror"><span class="header-section-number">9.5.3</span> Instances of
    MonadError</h3>
    <p>Cats provides instances of <code>MonadError</code> for numerous
    data types including <code>Either</code>, <code>Future</code>, and
    <code>Try</code>. The instance for <code>Either</code> is
    customisable to any error type, whereas the instances for
    <code>Future</code> and <code>Try</code> always represent errors as
    <code>Throwables</code>:</p>
    <div class="sourceCode" id="cb556"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb556-1"><a href="#cb556-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>util<span class="op">.</span>Try</span>
<span id="cb556-2"><a href="#cb556-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb556-3"><a href="#cb556-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> exn<span class="op">:</span> <span class="ex">Throwable</span> <span class="op">=</span></span>
<span id="cb556-4"><a href="#cb556-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> <span class="ex">RuntimeException</span><span class="op">(</span><span class="st">&quot;It&#39;s all gone wrong&quot;</span><span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb557"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb557-1"><a href="#cb557-1" aria-hidden="true" tabindex="-1"></a>exn<span class="op">.</span>raiseError<span class="op">[</span>Try<span class="op">,</span> <span class="bu">Int</span><span class="op">]</span></span>
<span id="cb557-2"><a href="#cb557-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res6: Try[Int] = Failure(</span></span>
<span id="cb557-3"><a href="#cb557-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   exception = java.lang.RuntimeException: It&#39;s all gone wrong</span></span>
<span id="cb557-4"><a href="#cb557-4" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <h3 data-number="9.5.4" id="exercise-abstracting"><span class="header-section-number">9.5.4</span> Exercise:
    Abstracting</h3>
    <p>Implement a method <code>validateAdult</code> with the following
    signature</p>
    <div class="sourceCode" id="cb558"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb558-1"><a href="#cb558-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validateAdult<span class="op">[</span>F<span class="op">[</span>_<span class="op">]](</span>age<span class="op">:</span> <span class="bu">Int</span><span class="op">)(</span><span class="kw">implicit</span> me<span class="op">:</span> MonadError<span class="op">[</span>F<span class="op">,</span> <span class="ex">Throwable</span><span class="op">]):</span> F<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb558-2"><a href="#cb558-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">???</span></span></code></pre></div>
    <p>When passed an <code>age</code> greater than or equal to 18 it
    should return that value as a success. Otherwise it should return a
    error represented as an <code>IllegalArgumentException</code>.</p>
    <p>Here are some examples of use.</p>
    <div class="sourceCode" id="cb559"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb559-1"><a href="#cb559-1" aria-hidden="true" tabindex="-1"></a>validateAdult<span class="op">[</span>Try<span class="op">](</span><span class="dv">18</span><span class="op">)</span></span>
<span id="cb559-2"><a href="#cb559-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res7: Try[Int] = Success(value = 18)</span></span>
<span id="cb559-3"><a href="#cb559-3" aria-hidden="true" tabindex="-1"></a>validateAdult<span class="op">[</span>Try<span class="op">](</span><span class="dv">8</span><span class="op">)</span></span>
<span id="cb559-4"><a href="#cb559-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res8: Try[Int] = Failure(</span></span>
<span id="cb559-5"><a href="#cb559-5" aria-hidden="true" tabindex="-1"></a><span class="co">//   exception = java.lang.IllegalArgumentException: Age must be greater than or equal to 18</span></span>
<span id="cb559-6"><a href="#cb559-6" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span>
<span id="cb559-7"><a href="#cb559-7" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> ExceptionOr<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> Either<span class="op">[</span><span class="ex">Throwable</span><span class="op">,</span> A<span class="op">]</span></span>
<span id="cb559-8"><a href="#cb559-8" aria-hidden="true" tabindex="-1"></a>validateAdult<span class="op">[</span>ExceptionOr<span class="op">](-</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb559-9"><a href="#cb559-9" aria-hidden="true" tabindex="-1"></a><span class="co">// res9: Either[Throwable, Int] = Left(</span></span>
<span id="cb559-10"><a href="#cb559-10" aria-hidden="true" tabindex="-1"></a><span class="co">//   value = java.lang.IllegalArgumentException: Age must be greater than or equal to 18</span></span>
<span id="cb559-11"><a href="#cb559-11" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <div class="solution">
    <p>We can solve this using <code>pure</code> and
    <code>raiseError</code>. Note the use of type parameters to these
    methods, to aid type inference.</p>
    <div class="sourceCode" id="cb560"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb560-1"><a href="#cb560-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validateAdult<span class="op">[</span>F<span class="op">[</span>_<span class="op">]](</span>age<span class="op">:</span> <span class="bu">Int</span><span class="op">)(</span><span class="kw">implicit</span> me<span class="op">:</span> MonadError<span class="op">[</span>F<span class="op">,</span> <span class="ex">Throwable</span><span class="op">]):</span> F<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb560-2"><a href="#cb560-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span><span class="op">(</span>age <span class="op">&gt;=</span> <span class="dv">18</span><span class="op">)</span> age<span class="op">.</span>pure<span class="op">[</span>F<span class="op">]</span></span>
<span id="cb560-3"><a href="#cb560-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="kw">new</span> <span class="ex">IllegalArgumentException</span><span class="op">(</span><span class="st">&quot;Age must be greater than or equal to 18&quot;</span><span class="op">).</span>raiseError<span class="op">[</span>F<span class="op">,</span> <span class="bu">Int</span><span class="op">]</span></span></code></pre></div>
    </div>
    <h2 data-number="9.6" id="sec:monads:eval"><span class="header-section-number">9.6</span> The Eval Monad</h2>
    <p><a href="http://typelevel.org/cats/api/cats/Eval.html"><code>cats.Eval</code></a>
    is a monad that allows us to abstract over different <em>models of
    evaluation</em>. We typically talk of two such models:
    <em>eager</em> and <em>lazy</em>, also called <em>call-by-value</em>
    and <em>call-by-name</em> respectively. <code>Eval</code> also
    allows for a result to be <em>memoized</em>, which gives us
    <em>call-by-need</em> evaluation.</p>
    <p><code>Eval</code> is also <em>stack-safe</em>, which means we can
    use it in very deep recursions without blowing up the stack.</p>
    <h3 data-number="9.6.1" id="eager-lazy-memoized-oh-my"><span class="header-section-number">9.6.1</span> Eager, Lazy, Memoized, Oh
    My!</h3>
    <p>What do these terms for models of evaluation mean? Let’s see some
    examples.</p>
    <p>Let’s first look at Scala <code>vals</code>. We can see the
    evaluation model using a computation with a visible side-effect. In
    the following example, the code to compute the value of
    <code>x</code> happens at place where it is defined rather than on
    access. Accessing <code>x</code> recalls the stored value without
    re-running the code.</p>
    <div class="sourceCode" id="cb561"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb561-1"><a href="#cb561-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> x <span class="op">=</span> <span class="op">{</span></span>
<span id="cb561-2"><a href="#cb561-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">println</span><span class="op">(</span><span class="st">&quot;Computing X&quot;</span><span class="op">)</span></span>
<span id="cb561-3"><a href="#cb561-3" aria-hidden="true" tabindex="-1"></a>  math<span class="op">.</span><span class="fu">random</span><span class="op">()</span></span>
<span id="cb561-4"><a href="#cb561-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb561-5"><a href="#cb561-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Computing X</span></span>
<span id="cb561-6"><a href="#cb561-6" aria-hidden="true" tabindex="-1"></a><span class="co">// x: Double = 0.2621184300232132</span></span>
<span id="cb561-7"><a href="#cb561-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb561-8"><a href="#cb561-8" aria-hidden="true" tabindex="-1"></a>x <span class="co">// first access</span></span>
<span id="cb561-9"><a href="#cb561-9" aria-hidden="true" tabindex="-1"></a><span class="co">// res0: Double = 0.2621184300232132</span></span>
<span id="cb561-10"><a href="#cb561-10" aria-hidden="true" tabindex="-1"></a>x <span class="co">// second access</span></span>
<span id="cb561-11"><a href="#cb561-11" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: Double = 0.2621184300232132</span></span></code></pre></div>
    <p>This is an example of call-by-value evaluation:</p>
    <ul>
    <li>the computation is evaluated at point where it is defined
    (eager); and</li>
    <li>the computation is evaluated once (memoized).</li>
    </ul>
    <p>Let’s look at an example using a <code>def</code>. The code to
    compute <code>y</code> below is not run until we use it, and is
    re-run on every access:</p>
    <div class="sourceCode" id="cb562"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb562-1"><a href="#cb562-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> y <span class="op">=</span> <span class="op">{</span></span>
<span id="cb562-2"><a href="#cb562-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">println</span><span class="op">(</span><span class="st">&quot;Computing Y&quot;</span><span class="op">)</span></span>
<span id="cb562-3"><a href="#cb562-3" aria-hidden="true" tabindex="-1"></a>  math<span class="op">.</span><span class="fu">random</span><span class="op">()</span></span>
<span id="cb562-4"><a href="#cb562-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb562-5"><a href="#cb562-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb562-6"><a href="#cb562-6" aria-hidden="true" tabindex="-1"></a>y <span class="co">// first access</span></span>
<span id="cb562-7"><a href="#cb562-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Computing Y</span></span>
<span id="cb562-8"><a href="#cb562-8" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: Double = 0.26520904049739435</span></span>
<span id="cb562-9"><a href="#cb562-9" aria-hidden="true" tabindex="-1"></a>y <span class="co">// second access</span></span>
<span id="cb562-10"><a href="#cb562-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Computing Y</span></span>
<span id="cb562-11"><a href="#cb562-11" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: Double = 0.6418366625919592</span></span></code></pre></div>
    <p>These are the properties of call-by-name evaluation:</p>
    <ul>
    <li>the computation is evaluated at the point of use (lazy);
    and</li>
    <li>the computation is evaluated each time it is used (not
    memoized).</li>
    </ul>
    <p>Last but not least, <code>lazy vals</code> are an example of
    call-by-need evaluation. The code to compute <code>z</code> below is
    not run until we use it for the first time (lazy). The result is
    then cached and re-used on subsequent accesses (memoized):</p>
    <div class="sourceCode" id="cb563"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb563-1"><a href="#cb563-1" aria-hidden="true" tabindex="-1"></a><span class="kw">lazy</span> <span class="kw">val</span> z <span class="op">=</span> <span class="op">{</span></span>
<span id="cb563-2"><a href="#cb563-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">println</span><span class="op">(</span><span class="st">&quot;Computing Z&quot;</span><span class="op">)</span></span>
<span id="cb563-3"><a href="#cb563-3" aria-hidden="true" tabindex="-1"></a>  math<span class="op">.</span><span class="fu">random</span><span class="op">()</span></span>
<span id="cb563-4"><a href="#cb563-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb563-5"><a href="#cb563-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb563-6"><a href="#cb563-6" aria-hidden="true" tabindex="-1"></a>z <span class="co">// first access</span></span>
<span id="cb563-7"><a href="#cb563-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Computing Z</span></span>
<span id="cb563-8"><a href="#cb563-8" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: Double = 0.2802817154885391</span></span>
<span id="cb563-9"><a href="#cb563-9" aria-hidden="true" tabindex="-1"></a>z <span class="co">// second access</span></span>
<span id="cb563-10"><a href="#cb563-10" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: Double = 0.2802817154885391</span></span></code></pre></div>
    <p>Let’s summarize. There are two properties of interest:</p>
    <ul>
    <li>evaluation at the point of definition (eager) versus at the
    point of use (lazy); and</li>
    <li>values are saved once evaluated (memoized) or not (not
    memoized).</li>
    </ul>
    <p>There are three possible combinations of these properties:</p>
    <ul>
    <li>call-by-value which is eager and memoized;</li>
    <li>call-by-name which is lazy and not memoized; and</li>
    <li>call-by-need which is lazy and memoized.</li>
    </ul>
    <p>The final combination, eager and not memoized, is not
    possible.</p>
    <h3 data-number="9.6.2" id="evals-models-of-evaluation"><span class="header-section-number">9.6.2</span> Eval’s Models of
    Evaluation</h3>
    <p><code>Eval</code> has three subtypes: <code>Now</code>,
    <code>Always</code>, and <code>Later</code>. They correspond to
    call-by-value, call-by-name, and call-by-need respectively. We
    construct these with three constructor methods, which create
    instances of the three classes and return them typed as
    <code>Eval</code>:</p>
    <div class="sourceCode" id="cb564"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb564-1"><a href="#cb564-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Eval</span></code></pre></div>
    <div class="sourceCode" id="cb565"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb565-1"><a href="#cb565-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> now <span class="op">=</span> Eval<span class="op">.</span><span class="fu">now</span><span class="op">(</span>math<span class="op">.</span><span class="fu">random</span><span class="op">()</span> <span class="op">+</span> <span class="dv">1000</span><span class="op">)</span></span>
<span id="cb565-2"><a href="#cb565-2" aria-hidden="true" tabindex="-1"></a><span class="co">// now: Eval[Double] = Now(value = 1000.7676477499388)</span></span>
<span id="cb565-3"><a href="#cb565-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> always <span class="op">=</span> Eval<span class="op">.</span><span class="fu">always</span><span class="op">(</span>math<span class="op">.</span><span class="fu">random</span><span class="op">()</span> <span class="op">+</span> <span class="dv">3000</span><span class="op">)</span></span>
<span id="cb565-4"><a href="#cb565-4" aria-hidden="true" tabindex="-1"></a><span class="co">// always: Eval[Double] = cats.Always@57d88aab</span></span>
<span id="cb565-5"><a href="#cb565-5" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> later <span class="op">=</span> Eval<span class="op">.</span><span class="fu">later</span><span class="op">(</span>math<span class="op">.</span><span class="fu">random</span><span class="op">()</span> <span class="op">+</span> <span class="dv">2000</span><span class="op">)</span></span>
<span id="cb565-6"><a href="#cb565-6" aria-hidden="true" tabindex="-1"></a><span class="co">// later: Eval[Double] = cats.Later@75d868da</span></span></code></pre></div>
    <p>We can extract the result of an <code>Eval</code> using its
    <code>value</code> method:</p>
    <div class="sourceCode" id="cb566"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb566-1"><a href="#cb566-1" aria-hidden="true" tabindex="-1"></a>now<span class="op">.</span>value</span>
<span id="cb566-2"><a href="#cb566-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res6: Double = 1000.7676477499388</span></span>
<span id="cb566-3"><a href="#cb566-3" aria-hidden="true" tabindex="-1"></a>always<span class="op">.</span>value</span>
<span id="cb566-4"><a href="#cb566-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res7: Double = 3000.921580414089</span></span>
<span id="cb566-5"><a href="#cb566-5" aria-hidden="true" tabindex="-1"></a>later<span class="op">.</span>value</span>
<span id="cb566-6"><a href="#cb566-6" aria-hidden="true" tabindex="-1"></a><span class="co">// res8: Double = 2000.256738653894</span></span></code></pre></div>
    <p>Each type of <code>Eval</code> calculates its result using one of
    the evaluation models defined above. <code>Eval.now</code> captures
    a value <em>right now</em>. Its semantics are similar to a
    <code>val</code>—eager and memoized:</p>
    <div class="sourceCode" id="cb567"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb567-1"><a href="#cb567-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> x <span class="op">=</span> Eval<span class="op">.</span>now<span class="op">{</span></span>
<span id="cb567-2"><a href="#cb567-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">println</span><span class="op">(</span><span class="st">&quot;Computing X&quot;</span><span class="op">)</span></span>
<span id="cb567-3"><a href="#cb567-3" aria-hidden="true" tabindex="-1"></a>  math<span class="op">.</span><span class="fu">random</span><span class="op">()</span></span>
<span id="cb567-4"><a href="#cb567-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb567-5"><a href="#cb567-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Computing X</span></span>
<span id="cb567-6"><a href="#cb567-6" aria-hidden="true" tabindex="-1"></a><span class="co">// x: Eval[Double] = Now(value = 0.7005139400449242)</span></span>
<span id="cb567-7"><a href="#cb567-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb567-8"><a href="#cb567-8" aria-hidden="true" tabindex="-1"></a>x<span class="op">.</span>value <span class="co">// first access</span></span>
<span id="cb567-9"><a href="#cb567-9" aria-hidden="true" tabindex="-1"></a><span class="co">// res10: Double = 0.7005139400449242</span></span>
<span id="cb567-10"><a href="#cb567-10" aria-hidden="true" tabindex="-1"></a>x<span class="op">.</span>value <span class="co">// second access</span></span>
<span id="cb567-11"><a href="#cb567-11" aria-hidden="true" tabindex="-1"></a><span class="co">// res11: Double = 0.7005139400449242</span></span></code></pre></div>
    <p><code>Eval.always</code> captures a lazy computation, similar to
    a <code>def</code>:</p>
    <div class="sourceCode" id="cb568"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb568-1"><a href="#cb568-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> y <span class="op">=</span> Eval<span class="op">.</span>always<span class="op">{</span></span>
<span id="cb568-2"><a href="#cb568-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">println</span><span class="op">(</span><span class="st">&quot;Computing Y&quot;</span><span class="op">)</span></span>
<span id="cb568-3"><a href="#cb568-3" aria-hidden="true" tabindex="-1"></a>  math<span class="op">.</span><span class="fu">random</span><span class="op">()</span></span>
<span id="cb568-4"><a href="#cb568-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb568-5"><a href="#cb568-5" aria-hidden="true" tabindex="-1"></a><span class="co">// y: Eval[Double] = cats.Always@4957d50b</span></span>
<span id="cb568-6"><a href="#cb568-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb568-7"><a href="#cb568-7" aria-hidden="true" tabindex="-1"></a>y<span class="op">.</span>value <span class="co">// first access</span></span>
<span id="cb568-8"><a href="#cb568-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Computing Y</span></span>
<span id="cb568-9"><a href="#cb568-9" aria-hidden="true" tabindex="-1"></a><span class="co">// res12: Double = 0.4033438396135144</span></span>
<span id="cb568-10"><a href="#cb568-10" aria-hidden="true" tabindex="-1"></a>y<span class="op">.</span>value <span class="co">// second access</span></span>
<span id="cb568-11"><a href="#cb568-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Computing Y</span></span>
<span id="cb568-12"><a href="#cb568-12" aria-hidden="true" tabindex="-1"></a><span class="co">// res13: Double = 0.5513246151982267</span></span></code></pre></div>
    <p>Finally, <code>Eval.later</code> captures a lazy, memoized
    computation, similar to a <code>lazy val</code>:</p>
    <div class="sourceCode" id="cb569"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb569-1"><a href="#cb569-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> z <span class="op">=</span> Eval<span class="op">.</span>later<span class="op">{</span></span>
<span id="cb569-2"><a href="#cb569-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">println</span><span class="op">(</span><span class="st">&quot;Computing Z&quot;</span><span class="op">)</span></span>
<span id="cb569-3"><a href="#cb569-3" aria-hidden="true" tabindex="-1"></a>  math<span class="op">.</span><span class="fu">random</span><span class="op">()</span></span>
<span id="cb569-4"><a href="#cb569-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb569-5"><a href="#cb569-5" aria-hidden="true" tabindex="-1"></a><span class="co">// z: Eval[Double] = cats.Later@5e0b317e</span></span>
<span id="cb569-6"><a href="#cb569-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb569-7"><a href="#cb569-7" aria-hidden="true" tabindex="-1"></a>z<span class="op">.</span>value <span class="co">// first access</span></span>
<span id="cb569-8"><a href="#cb569-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Computing Z</span></span>
<span id="cb569-9"><a href="#cb569-9" aria-hidden="true" tabindex="-1"></a><span class="co">// res14: Double = 0.3651558142706397</span></span>
<span id="cb569-10"><a href="#cb569-10" aria-hidden="true" tabindex="-1"></a>z<span class="op">.</span>value <span class="co">// second access</span></span>
<span id="cb569-11"><a href="#cb569-11" aria-hidden="true" tabindex="-1"></a><span class="co">// res15: Double = 0.3651558142706397</span></span></code></pre></div>
    <p>The three behaviours are summarized below:</p>
    <div class="table-responsive">
    <table>
    <colgroup>
    <col style="width: 26%" />
    <col style="width: 36%" />
    <col style="width: 37%" />
    </colgroup>
    <thead>
    <tr class="header">
    <th style="text-align: left;">Scala</th>
    <th style="text-align: left;">Cats</th>
    <th style="text-align: left;">Properties</th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td style="text-align: left;"><code>val</code></td>
    <td style="text-align: left;"><code>Now</code></td>
    <td style="text-align: left;">eager, memoized</td>
    </tr>
    <tr class="even">
    <td style="text-align: left;"><code>def</code></td>
    <td style="text-align: left;"><code>Always</code></td>
    <td style="text-align: left;">lazy, not memoized</td>
    </tr>
    <tr class="odd">
    <td style="text-align: left;"><code>lazy val</code></td>
    <td style="text-align: left;"><code>Later</code></td>
    <td style="text-align: left;">lazy, memoized</td>
    </tr>
    </tbody>
    </table>
    </div>
    <h3 data-number="9.6.3" id="eval-as-a-monad"><span class="header-section-number">9.6.3</span> Eval as a Monad</h3>
    <p>Like all monads, <code>Eval&#39;s</code> <code>map</code> and
    <code>flatMap</code> methods add computations to a chain. In this
    case, however, the chain is stored explicitly as a list of
    functions. The functions aren’t run until we call
    <code>Eval&#39;s</code> <code>value</code> method to request a
    result:</p>
    <div class="sourceCode" id="cb570"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb570-1"><a href="#cb570-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> greeting <span class="op">=</span> Eval</span>
<span id="cb570-2"><a href="#cb570-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span>always<span class="op">{</span> <span class="fu">println</span><span class="op">(</span><span class="st">&quot;Step 1&quot;</span><span class="op">);</span> <span class="st">&quot;Hello&quot;</span> <span class="op">}</span></span>
<span id="cb570-3"><a href="#cb570-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span>map<span class="op">{</span> str <span class="op">=&gt;</span> <span class="fu">println</span><span class="op">(</span><span class="st">&quot;Step 2&quot;</span><span class="op">);</span> <span class="ss">s&quot;$str</span><span class="st"> world</span><span class="ss">&quot;</span> <span class="op">}</span></span>
<span id="cb570-4"><a href="#cb570-4" aria-hidden="true" tabindex="-1"></a><span class="co">// greeting: Eval[String] = cats.Eval$$anon$4@44feb74</span></span>
<span id="cb570-5"><a href="#cb570-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb570-6"><a href="#cb570-6" aria-hidden="true" tabindex="-1"></a>greeting<span class="op">.</span>value</span>
<span id="cb570-7"><a href="#cb570-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Step 1</span></span>
<span id="cb570-8"><a href="#cb570-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Step 2</span></span>
<span id="cb570-9"><a href="#cb570-9" aria-hidden="true" tabindex="-1"></a><span class="co">// res16: String = &quot;Hello world&quot;</span></span></code></pre></div>
    <p>Note that, while the semantics of the originating
    <code>Eval</code> instances are maintained, mapping functions are
    always called lazily on demand (<code>def</code> semantics):</p>
    <div class="sourceCode" id="cb571"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb571-1"><a href="#cb571-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> ans <span class="op">=</span> <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb571-2"><a href="#cb571-2" aria-hidden="true" tabindex="-1"></a>  a <span class="op">&lt;-</span> Eval<span class="op">.</span>now<span class="op">{</span> <span class="fu">println</span><span class="op">(</span><span class="st">&quot;Calculating A&quot;</span><span class="op">);</span> <span class="dv">40</span> <span class="op">}</span></span>
<span id="cb571-3"><a href="#cb571-3" aria-hidden="true" tabindex="-1"></a>  b <span class="op">&lt;-</span> Eval<span class="op">.</span>always<span class="op">{</span> <span class="fu">println</span><span class="op">(</span><span class="st">&quot;Calculating B&quot;</span><span class="op">);</span> <span class="dv">2</span> <span class="op">}</span></span>
<span id="cb571-4"><a href="#cb571-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">yield</span> <span class="op">{</span></span>
<span id="cb571-5"><a href="#cb571-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">println</span><span class="op">(</span><span class="st">&quot;Adding A and B&quot;</span><span class="op">)</span></span>
<span id="cb571-6"><a href="#cb571-6" aria-hidden="true" tabindex="-1"></a>  a <span class="op">+</span> b</span>
<span id="cb571-7"><a href="#cb571-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb571-8"><a href="#cb571-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculating A</span></span>
<span id="cb571-9"><a href="#cb571-9" aria-hidden="true" tabindex="-1"></a><span class="co">// ans: Eval[Int] = cats.Eval$$anon$4@10abfec2</span></span>
<span id="cb571-10"><a href="#cb571-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb571-11"><a href="#cb571-11" aria-hidden="true" tabindex="-1"></a>ans<span class="op">.</span>value <span class="co">// first access</span></span>
<span id="cb571-12"><a href="#cb571-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculating B</span></span>
<span id="cb571-13"><a href="#cb571-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Adding A and B</span></span>
<span id="cb571-14"><a href="#cb571-14" aria-hidden="true" tabindex="-1"></a><span class="co">// res17: Int = 42</span></span>
<span id="cb571-15"><a href="#cb571-15" aria-hidden="true" tabindex="-1"></a>ans<span class="op">.</span>value <span class="co">// second access</span></span>
<span id="cb571-16"><a href="#cb571-16" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculating B</span></span>
<span id="cb571-17"><a href="#cb571-17" aria-hidden="true" tabindex="-1"></a><span class="co">// Adding A and B</span></span>
<span id="cb571-18"><a href="#cb571-18" aria-hidden="true" tabindex="-1"></a><span class="co">// res18: Int = 42</span></span></code></pre></div>
    <p><code>Eval</code> has a <code>memoize</code> method that allows
    us to memoize a chain of computations. The result of the chain up to
    the call to <code>memoize</code> is cached, whereas calculations
    after the call retain their original semantics:</p>
    <div class="sourceCode" id="cb572"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb572-1"><a href="#cb572-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> saying <span class="op">=</span> Eval</span>
<span id="cb572-2"><a href="#cb572-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span>always<span class="op">{</span> <span class="fu">println</span><span class="op">(</span><span class="st">&quot;Step 1&quot;</span><span class="op">);</span> <span class="st">&quot;The cat&quot;</span> <span class="op">}</span></span>
<span id="cb572-3"><a href="#cb572-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span>map<span class="op">{</span> str <span class="op">=&gt;</span> <span class="fu">println</span><span class="op">(</span><span class="st">&quot;Step 2&quot;</span><span class="op">);</span> <span class="ss">s&quot;$str</span><span class="st"> sat on</span><span class="ss">&quot;</span> <span class="op">}</span></span>
<span id="cb572-4"><a href="#cb572-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span>memoize</span>
<span id="cb572-5"><a href="#cb572-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span>map<span class="op">{</span> str <span class="op">=&gt;</span> <span class="fu">println</span><span class="op">(</span><span class="st">&quot;Step 3&quot;</span><span class="op">);</span> <span class="ss">s&quot;$str</span><span class="st"> the mat</span><span class="ss">&quot;</span> <span class="op">}</span></span>
<span id="cb572-6"><a href="#cb572-6" aria-hidden="true" tabindex="-1"></a><span class="co">// saying: Eval[String] = cats.Eval$$anon$4@7fa3396d</span></span>
<span id="cb572-7"><a href="#cb572-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb572-8"><a href="#cb572-8" aria-hidden="true" tabindex="-1"></a>saying<span class="op">.</span>value <span class="co">// first access</span></span>
<span id="cb572-9"><a href="#cb572-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Step 1</span></span>
<span id="cb572-10"><a href="#cb572-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Step 2</span></span>
<span id="cb572-11"><a href="#cb572-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Step 3</span></span>
<span id="cb572-12"><a href="#cb572-12" aria-hidden="true" tabindex="-1"></a><span class="co">// res19: String = &quot;The cat sat on the mat&quot;</span></span>
<span id="cb572-13"><a href="#cb572-13" aria-hidden="true" tabindex="-1"></a>saying<span class="op">.</span>value <span class="co">// second access</span></span>
<span id="cb572-14"><a href="#cb572-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Step 3</span></span>
<span id="cb572-15"><a href="#cb572-15" aria-hidden="true" tabindex="-1"></a><span class="co">// res20: String = &quot;The cat sat on the mat&quot;</span></span></code></pre></div>
    <h3 data-number="9.6.4" id="trampolining-and-eval.defer"><span class="header-section-number">9.6.4</span> Trampolining and
    <em>Eval.defer</em></h3>
    <p>One useful property of <code>Eval</code> is that its
    <code>map</code> and <code>flatMap</code> methods are
    <em>trampolined</em>. This means we can nest calls to
    <code>map</code> and <code>flatMap</code> arbitrarily without
    consuming stack frames. We call this property <em>“stack
    safety”</em>.</p>
    <p>For example, consider this function for calculating
    factorials:</p>
    <div class="sourceCode" id="cb573"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb573-1"><a href="#cb573-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">factorial</span><span class="op">(</span>n<span class="op">:</span> BigInt<span class="op">):</span> BigInt <span class="op">=</span></span>
<span id="cb573-2"><a href="#cb573-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span><span class="op">(</span>n <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> n <span class="cf">else</span> n <span class="op">*</span> <span class="fu">factorial</span><span class="op">(</span>n <span class="op">-</span> <span class="dv">1</span><span class="op">)</span></span></code></pre></div>
    <p>It is relatively easy to make this method stack overflow:</p>
    <div class="sourceCode" id="cb574"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb574-1"><a href="#cb574-1" aria-hidden="true" tabindex="-1"></a><span class="fu">factorial</span><span class="op">(</span><span class="dv">50000</span><span class="op">)</span></span>
<span id="cb574-2"><a href="#cb574-2" aria-hidden="true" tabindex="-1"></a><span class="co">// java.lang.StackOverflowError</span></span>
<span id="cb574-3"><a href="#cb574-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   ...</span></span></code></pre></div>
    <p>We can rewrite the method using <code>Eval</code> to make it
    stack safe:</p>
    <div class="sourceCode" id="cb575"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb575-1"><a href="#cb575-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">factorial</span><span class="op">(</span>n<span class="op">:</span> BigInt<span class="op">):</span> Eval<span class="op">[</span>BigInt<span class="op">]</span> <span class="op">=</span></span>
<span id="cb575-2"><a href="#cb575-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span><span class="op">(</span>n <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb575-3"><a href="#cb575-3" aria-hidden="true" tabindex="-1"></a>    Eval<span class="op">.</span><span class="fu">now</span><span class="op">(</span>n<span class="op">)</span></span>
<span id="cb575-4"><a href="#cb575-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb575-5"><a href="#cb575-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">factorial</span><span class="op">(</span>n <span class="op">-</span> <span class="dv">1</span><span class="op">).</span><span class="fu">map</span><span class="op">(</span>_ <span class="op">*</span> n<span class="op">)</span></span>
<span id="cb575-6"><a href="#cb575-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <div class="sourceCode" id="cb576"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb576-1"><a href="#cb576-1" aria-hidden="true" tabindex="-1"></a><span class="fu">factorial</span><span class="op">(</span><span class="dv">50000</span><span class="op">).</span>value</span>
<span id="cb576-2"><a href="#cb576-2" aria-hidden="true" tabindex="-1"></a><span class="co">// java.lang.StackOverflowError</span></span>
<span id="cb576-3"><a href="#cb576-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   ...</span></span></code></pre></div>
    <p>Oops! That didn’t work—our stack still blew up! This is because
    we’re still making all the recursive calls to <code>factorial</code>
    before we start working with <code>Eval&#39;s</code> <code>map</code>
    method. We can work around this using <code>Eval.defer</code>, which
    takes an existing instance of <code>Eval</code> and defers its
    evaluation. The <code>defer</code> method is trampolined like
    <code>map</code> and <code>flatMap</code>, so we can use it as a
    quick way to make an existing operation stack safe:</p>
    <div class="sourceCode" id="cb577"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb577-1"><a href="#cb577-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">factorial</span><span class="op">(</span>n<span class="op">:</span> BigInt<span class="op">):</span> Eval<span class="op">[</span>BigInt<span class="op">]</span> <span class="op">=</span></span>
<span id="cb577-2"><a href="#cb577-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span><span class="op">(</span>n <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb577-3"><a href="#cb577-3" aria-hidden="true" tabindex="-1"></a>    Eval<span class="op">.</span><span class="fu">now</span><span class="op">(</span>n<span class="op">)</span></span>
<span id="cb577-4"><a href="#cb577-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb577-5"><a href="#cb577-5" aria-hidden="true" tabindex="-1"></a>    Eval<span class="op">.</span><span class="fu">defer</span><span class="op">(</span><span class="fu">factorial</span><span class="op">(</span>n <span class="op">-</span> <span class="dv">1</span><span class="op">).</span><span class="fu">map</span><span class="op">(</span>_ <span class="op">*</span> n<span class="op">))</span></span>
<span id="cb577-6"><a href="#cb577-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <div class="sourceCode" id="cb578"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb578-1"><a href="#cb578-1" aria-hidden="true" tabindex="-1"></a><span class="fu">factorial</span><span class="op">(</span><span class="dv">50000</span><span class="op">).</span>value</span>
<span id="cb578-2"><a href="#cb578-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res: A very big value</span></span></code></pre></div>
    <p><code>Eval</code> is a useful tool to enforce stack safety when
    working on very large computations and data structures. However, we
    must bear in mind that trampolining is not free. It avoids consuming
    stack by creating a chain of function objects on the heap. There are
    still limits on how deeply we can nest computations, but they are
    bounded by the size of the heap rather than the stack.</p>
    <h3 data-number="9.6.5" id="exercise-safer-folding-using-eval"><span class="header-section-number">9.6.5</span> Exercise: Safer Folding
    using Eval</h3>
    <p>The naive implementation of <code>foldRight</code> below is not
    stack safe. Make it so using <code>Eval</code>:</p>
    <div class="sourceCode" id="cb579"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb579-1"><a href="#cb579-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> foldRight<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>as<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">],</span> acc<span class="op">:</span> B<span class="op">)(</span>fn<span class="op">:</span> <span class="op">(</span>A<span class="op">,</span> B<span class="op">)</span> <span class="op">=&gt;</span> B<span class="op">):</span> B <span class="op">=</span></span>
<span id="cb579-2"><a href="#cb579-2" aria-hidden="true" tabindex="-1"></a>  as <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb579-3"><a href="#cb579-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> head <span class="op">::</span> tail <span class="op">=&gt;</span></span>
<span id="cb579-4"><a href="#cb579-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fn</span><span class="op">(</span>head<span class="op">,</span> <span class="fu">foldRight</span><span class="op">(</span>tail<span class="op">,</span> acc<span class="op">)(</span>fn<span class="op">))</span></span>
<span id="cb579-5"><a href="#cb579-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> Nil <span class="op">=&gt;</span></span>
<span id="cb579-6"><a href="#cb579-6" aria-hidden="true" tabindex="-1"></a>      acc</span>
<span id="cb579-7"><a href="#cb579-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <div class="solution">
    <p>The easiest way to fix this is to introduce a helper method
    called <code>foldRightEval</code>. This is essentially our original
    method with every occurrence of <code>B</code> replaced with
    <code>Eval[B]</code>, and a call to <code>Eval.defer</code> to
    protect the recursive call:</p>
    <div class="sourceCode" id="cb580"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb580-1"><a href="#cb580-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Eval</span>
<span id="cb580-2"><a href="#cb580-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb580-3"><a href="#cb580-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> foldRightEval<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>as<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">],</span> acc<span class="op">:</span> Eval<span class="op">[</span>B<span class="op">])</span></span>
<span id="cb580-4"><a href="#cb580-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span>fn<span class="op">:</span> <span class="op">(</span>A<span class="op">,</span> Eval<span class="op">[</span>B<span class="op">])</span> <span class="op">=&gt;</span> Eval<span class="op">[</span>B<span class="op">]):</span> Eval<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb580-5"><a href="#cb580-5" aria-hidden="true" tabindex="-1"></a>  as <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb580-6"><a href="#cb580-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> head <span class="op">::</span> tail <span class="op">=&gt;</span></span>
<span id="cb580-7"><a href="#cb580-7" aria-hidden="true" tabindex="-1"></a>      Eval<span class="op">.</span><span class="fu">defer</span><span class="op">(</span><span class="fu">fn</span><span class="op">(</span>head<span class="op">,</span> <span class="fu">foldRightEval</span><span class="op">(</span>tail<span class="op">,</span> acc<span class="op">)(</span>fn<span class="op">)))</span></span>
<span id="cb580-8"><a href="#cb580-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> Nil <span class="op">=&gt;</span></span>
<span id="cb580-9"><a href="#cb580-9" aria-hidden="true" tabindex="-1"></a>      acc</span>
<span id="cb580-10"><a href="#cb580-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>We can redefine <code>foldRight</code> simply in terms of
    <code>foldRightEval</code> and the resulting method is stack
    safe:</p>
    <div class="sourceCode" id="cb581"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb581-1"><a href="#cb581-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> foldRight<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>as<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">],</span> acc<span class="op">:</span> B<span class="op">)(</span>fn<span class="op">:</span> <span class="op">(</span>A<span class="op">,</span> B<span class="op">)</span> <span class="op">=&gt;</span> B<span class="op">):</span> B <span class="op">=</span></span>
<span id="cb581-2"><a href="#cb581-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">foldRightEval</span><span class="op">(</span>as<span class="op">,</span> Eval<span class="op">.</span><span class="fu">now</span><span class="op">(</span>acc<span class="op">))</span> <span class="op">{</span> <span class="op">(</span>a<span class="op">,</span> b<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb581-3"><a href="#cb581-3" aria-hidden="true" tabindex="-1"></a>    b<span class="op">.</span><span class="fu">map</span><span class="op">(</span><span class="fu">fn</span><span class="op">(</span>a<span class="op">,</span> _<span class="op">))</span></span>
<span id="cb581-4"><a href="#cb581-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}.</span>value</span></code></pre></div>
    <div class="sourceCode" id="cb582"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb582-1"><a href="#cb582-1" aria-hidden="true" tabindex="-1"></a><span class="fu">foldRight</span><span class="op">((</span><span class="dv">1</span> to <span class="dv">100000</span><span class="op">).</span>toList<span class="op">,</span> <span class="dv">0L</span><span class="op">)(</span>_ <span class="op">+</span> _<span class="op">)</span></span>
<span id="cb582-2"><a href="#cb582-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res24: Long = 5000050000L</span></span></code></pre></div>
    </div>
    <h2 data-number="9.7" id="writer-monad"><span class="header-section-number">9.7</span> The Writer Monad</h2>
    <p><a href="http://typelevel.org/cats/api/cats/data/#Writer%5BS,A%5D=cats.data.WriterT%5Bcats.Eval,S,A%5D"><code>cats.data.Writer</code></a>
    is a monad that lets us carry a log along with a computation. We can
    use it to record messages, errors, or additional data about a
    computation, and extract the log alongside the final result.</p>
    <p>One common use for <code>Writers</code> is recording sequences of
    steps in multi-threaded computations where standard imperative
    logging techniques can result in interleaved messages from different
    contexts. With <code>Writer</code> the log for the computation is
    tied to the result, so we can run concurrent computations without
    mixing logs.</p>
    <div class="callout callout-info">
    <p><em>Cats Data Types</em></p>
    <p><code>Writer</code> is the first data type we’ve seen from the <a href="http://typelevel.org/cats/api/cats/data/"><code>cats.data</code></a>
    package. This package provides instances of various type classes
    that produce useful semantics. Other examples from
    <code>cats.data</code> include the monad transformers that we will
    see in the next chapter, and the <a href="http://typelevel.org/cats/api/cats/data/Validated.html"><code>Validated</code></a>
    type we will encounter in Chapter 11.</p>
    </div>
    <h3 data-number="9.7.1" id="creating-and-unpacking-writers"><span class="header-section-number">9.7.1</span> Creating and Unpacking
    Writers</h3>
    <p>A <code>Writer[W, A]</code> carries two values: a <em>log</em> of
    type <code>W</code> and a <em>result</em> of type <code>A</code>. We
    can create a <code>Writer</code> from values of each type as
    follows:</p>
    <div class="sourceCode" id="cb583"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb583-1"><a href="#cb583-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>data<span class="op">.</span><span class="ex">Writer</span></span>
<span id="cb583-2"><a href="#cb583-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>vector<span class="op">.</span>_ <span class="co">// for Monoid</span></span></code></pre></div>
    <div class="sourceCode" id="cb584"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb584-1"><a href="#cb584-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Writer</span><span class="op">(</span><span class="ex">Vector</span><span class="op">(</span></span>
<span id="cb584-2"><a href="#cb584-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;It was the best of times&quot;</span><span class="op">,</span></span>
<span id="cb584-3"><a href="#cb584-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;it was the worst of times&quot;</span></span>
<span id="cb584-4"><a href="#cb584-4" aria-hidden="true" tabindex="-1"></a><span class="op">),</span> <span class="dv">1859</span><span class="op">)</span></span>
<span id="cb584-5"><a href="#cb584-5" aria-hidden="true" tabindex="-1"></a><span class="co">// res0: WriterT[Id, Vector[String], Int] = WriterT(</span></span>
<span id="cb584-6"><a href="#cb584-6" aria-hidden="true" tabindex="-1"></a><span class="co">//   run = (Vector(&quot;It was the best of times&quot;, &quot;it was the worst of times&quot;), 1859)</span></span>
<span id="cb584-7"><a href="#cb584-7" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>Notice that the type reported on the console is actually
    <code>WriterT[Id, Vector[String], Int]</code> instead of
    <code>Writer[Vector[String], Int]</code> as we might expect. In the
    spirit of code reuse, Cats implements <code>Writer</code> in terms
    of another type, <code>WriterT</code>. <code>WriterT</code> is an
    example of a new concept called a <em>monad transformer</em>, which
    we will cover in the next chapter.</p>
    <p>Let’s try to ignore this detail for now. <code>Writer</code> is a
    type alias for <code>WriterT</code>, so we can read types like
    <code>WriterT[Id, W, A]</code> as <code>Writer[W, A]</code>:</p>
    <div class="sourceCode" id="cb585"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb585-1"><a href="#cb585-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="ex">Writer</span><span class="op">[</span>W<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span> WriterT<span class="op">[</span>Id<span class="op">,</span> W<span class="op">,</span> A<span class="op">]</span></span></code></pre></div>
    <p>For convenience, Cats provides a way of creating
    <code>Writers</code> specifying only the log or the result. If we
    only have a result we can use the standard <code>pure</code> syntax.
    To do this we must have a <code>Monoid[W]</code> in scope so Cats
    knows how to produce an empty log:</p>
    <div class="sourceCode" id="cb586"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb586-1"><a href="#cb586-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>vector<span class="op">.</span>_   <span class="co">// for Monoid</span></span>
<span id="cb586-2"><a href="#cb586-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>applicative<span class="op">.</span>_ <span class="co">// for pure</span></span>
<span id="cb586-3"><a href="#cb586-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb586-4"><a href="#cb586-4" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Logged<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> <span class="ex">Writer</span><span class="op">[</span><span class="ex">Vector</span><span class="op">[</span><span class="ex">String</span><span class="op">],</span> A<span class="op">]</span></span></code></pre></div>
    <div class="sourceCode" id="cb587"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb587-1"><a href="#cb587-1" aria-hidden="true" tabindex="-1"></a><span class="fl">123.</span>pure<span class="op">[</span>Logged<span class="op">]</span></span>
<span id="cb587-2"><a href="#cb587-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: WriterT[Id, Vector[String], Int] = WriterT(run = (Vector(), 123))</span></span></code></pre></div>
    <p>If we have a log and no result we can create a
    <code>Writer[Unit]</code> using the <code>tell</code> syntax from <a href="http://typelevel.org/cats/api/cats/syntax/package$$writer$"><code>cats.syntax.writer</code></a>:</p>
    <div class="sourceCode" id="cb588"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb588-1"><a href="#cb588-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>writer<span class="op">.</span>_ <span class="co">// for tell</span></span></code></pre></div>
    <div class="sourceCode" id="cb589"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb589-1"><a href="#cb589-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Vector</span><span class="op">(</span><span class="st">&quot;msg1&quot;</span><span class="op">,</span> <span class="st">&quot;msg2&quot;</span><span class="op">,</span> <span class="st">&quot;msg3&quot;</span><span class="op">).</span>tell</span>
<span id="cb589-2"><a href="#cb589-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: WriterT[Id, Vector[String], Unit] = WriterT(</span></span>
<span id="cb589-3"><a href="#cb589-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   run = (Vector(&quot;msg1&quot;, &quot;msg2&quot;, &quot;msg3&quot;), ())</span></span>
<span id="cb589-4"><a href="#cb589-4" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>If we have both a result and a log, we can either use
    <code>Writer.apply</code> or we can use the <code>writer</code>
    syntax from <a href="http://typelevel.org/cats/api/cats/syntax/package$$writer$"><code>cats.syntax.writer</code></a>:</p>
    <div class="sourceCode" id="cb590"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb590-1"><a href="#cb590-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>writer<span class="op">.</span>_ <span class="co">// for writer</span></span></code></pre></div>
    <div class="sourceCode" id="cb591"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb591-1"><a href="#cb591-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> a <span class="op">=</span> <span class="ex">Writer</span><span class="op">(</span><span class="ex">Vector</span><span class="op">(</span><span class="st">&quot;msg1&quot;</span><span class="op">,</span> <span class="st">&quot;msg2&quot;</span><span class="op">,</span> <span class="st">&quot;msg3&quot;</span><span class="op">),</span> <span class="dv">123</span><span class="op">)</span></span>
<span id="cb591-2"><a href="#cb591-2" aria-hidden="true" tabindex="-1"></a><span class="co">// a: WriterT[Id, Vector[String], Int] = WriterT(</span></span>
<span id="cb591-3"><a href="#cb591-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   run = (Vector(&quot;msg1&quot;, &quot;msg2&quot;, &quot;msg3&quot;), 123)</span></span>
<span id="cb591-4"><a href="#cb591-4" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span>
<span id="cb591-5"><a href="#cb591-5" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> b <span class="op">=</span> <span class="fl">123.</span><span class="fu">writer</span><span class="op">(</span><span class="ex">Vector</span><span class="op">(</span><span class="st">&quot;msg1&quot;</span><span class="op">,</span> <span class="st">&quot;msg2&quot;</span><span class="op">,</span> <span class="st">&quot;msg3&quot;</span><span class="op">))</span></span>
<span id="cb591-6"><a href="#cb591-6" aria-hidden="true" tabindex="-1"></a><span class="co">// b: WriterT[Id, Vector[String], Int] = WriterT(</span></span>
<span id="cb591-7"><a href="#cb591-7" aria-hidden="true" tabindex="-1"></a><span class="co">//   run = (Vector(&quot;msg1&quot;, &quot;msg2&quot;, &quot;msg3&quot;), 123)</span></span>
<span id="cb591-8"><a href="#cb591-8" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>We can extract the result and log from a <code>Writer</code>
    using the <code>value</code> and <code>written</code> methods
    respectively:</p>
    <div class="sourceCode" id="cb592"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb592-1"><a href="#cb592-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> aResult<span class="op">:</span> <span class="bu">Int</span> <span class="op">=</span></span>
<span id="cb592-2"><a href="#cb592-2" aria-hidden="true" tabindex="-1"></a>  a<span class="op">.</span>value</span>
<span id="cb592-3"><a href="#cb592-3" aria-hidden="true" tabindex="-1"></a><span class="co">// aResult: Int = 123</span></span>
<span id="cb592-4"><a href="#cb592-4" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> aLog<span class="op">:</span> <span class="ex">Vector</span><span class="op">[</span><span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb592-5"><a href="#cb592-5" aria-hidden="true" tabindex="-1"></a>  a<span class="op">.</span>written</span>
<span id="cb592-6"><a href="#cb592-6" aria-hidden="true" tabindex="-1"></a><span class="co">// aLog: Vector[String] = Vector(&quot;msg1&quot;, &quot;msg2&quot;, &quot;msg3&quot;)</span></span></code></pre></div>
    <p>We can extract both values at the same time using the
    <code>run</code> method:</p>
    <div class="sourceCode" id="cb593"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb593-1"><a href="#cb593-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="op">(</span>log<span class="op">,</span> result<span class="op">)</span> <span class="op">=</span> b<span class="op">.</span>run</span>
<span id="cb593-2"><a href="#cb593-2" aria-hidden="true" tabindex="-1"></a><span class="co">// log: Vector[String] = Vector(&quot;msg1&quot;, &quot;msg2&quot;, &quot;msg3&quot;)</span></span>
<span id="cb593-3"><a href="#cb593-3" aria-hidden="true" tabindex="-1"></a><span class="co">// result: Int = 123</span></span></code></pre></div>
    <h3 data-number="9.7.2" id="composing-and-transforming-writers"><span class="header-section-number">9.7.2</span> Composing and
    Transforming Writers</h3>
    <p>The log in a <code>Writer</code> is preserved when we
    <code>map</code> or <code>flatMap</code> over it.
    <code>flatMap</code> appends the logs from the source
    <code>Writer</code> and the result of the user’s sequencing
    function. For this reason it’s good practice to use a log type that
    has an efficient append and concatenate operations, such as a
    <code>Vector</code>:</p>
    <div class="sourceCode" id="cb594"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb594-1"><a href="#cb594-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> writer1 <span class="op">=</span> <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb594-2"><a href="#cb594-2" aria-hidden="true" tabindex="-1"></a>  a <span class="op">&lt;-</span> <span class="fl">10.</span>pure<span class="op">[</span>Logged<span class="op">]</span></span>
<span id="cb594-3"><a href="#cb594-3" aria-hidden="true" tabindex="-1"></a>  _ <span class="op">&lt;-</span> <span class="ex">Vector</span><span class="op">(</span><span class="st">&quot;a&quot;</span><span class="op">,</span> <span class="st">&quot;b&quot;</span><span class="op">,</span> <span class="st">&quot;c&quot;</span><span class="op">).</span>tell</span>
<span id="cb594-4"><a href="#cb594-4" aria-hidden="true" tabindex="-1"></a>  b <span class="op">&lt;-</span> <span class="fl">32.</span><span class="fu">writer</span><span class="op">(</span><span class="ex">Vector</span><span class="op">(</span><span class="st">&quot;x&quot;</span><span class="op">,</span> <span class="st">&quot;y&quot;</span><span class="op">,</span> <span class="st">&quot;z&quot;</span><span class="op">))</span></span>
<span id="cb594-5"><a href="#cb594-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">yield</span> a <span class="op">+</span> b</span>
<span id="cb594-6"><a href="#cb594-6" aria-hidden="true" tabindex="-1"></a><span class="co">// writer1: WriterT[Id, Vector[String], Int] = WriterT(</span></span>
<span id="cb594-7"><a href="#cb594-7" aria-hidden="true" tabindex="-1"></a><span class="co">//   run = (Vector(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;x&quot;, &quot;y&quot;, &quot;z&quot;), 42)</span></span>
<span id="cb594-8"><a href="#cb594-8" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span>
<span id="cb594-9"><a href="#cb594-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb594-10"><a href="#cb594-10" aria-hidden="true" tabindex="-1"></a>writer1<span class="op">.</span>run</span>
<span id="cb594-11"><a href="#cb594-11" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: Tuple2[Vector[String], Int] = (</span></span>
<span id="cb594-12"><a href="#cb594-12" aria-hidden="true" tabindex="-1"></a><span class="co">//   Vector(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;x&quot;, &quot;y&quot;, &quot;z&quot;),</span></span>
<span id="cb594-13"><a href="#cb594-13" aria-hidden="true" tabindex="-1"></a><span class="co">//   42</span></span>
<span id="cb594-14"><a href="#cb594-14" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>In addition to transforming the result with <code>map</code> and
    <code>flatMap</code>, we can transform the log in a
    <code>Writer</code> with the <code>mapWritten</code> method:</p>
    <div class="sourceCode" id="cb595"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb595-1"><a href="#cb595-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> writer2 <span class="op">=</span> writer1<span class="op">.</span><span class="fu">mapWritten</span><span class="op">(</span>_<span class="op">.</span><span class="fu">map</span><span class="op">(</span>_<span class="op">.</span>toUpperCase<span class="op">))</span></span>
<span id="cb595-2"><a href="#cb595-2" aria-hidden="true" tabindex="-1"></a><span class="co">// writer2: WriterT[Id, Vector[String], Int] = WriterT(</span></span>
<span id="cb595-3"><a href="#cb595-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   run = (Vector(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;X&quot;, &quot;Y&quot;, &quot;Z&quot;), 42)</span></span>
<span id="cb595-4"><a href="#cb595-4" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span>
<span id="cb595-5"><a href="#cb595-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb595-6"><a href="#cb595-6" aria-hidden="true" tabindex="-1"></a>writer2<span class="op">.</span>run</span>
<span id="cb595-7"><a href="#cb595-7" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: Tuple2[Vector[String], Int] = (</span></span>
<span id="cb595-8"><a href="#cb595-8" aria-hidden="true" tabindex="-1"></a><span class="co">//   Vector(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;X&quot;, &quot;Y&quot;, &quot;Z&quot;),</span></span>
<span id="cb595-9"><a href="#cb595-9" aria-hidden="true" tabindex="-1"></a><span class="co">//   42</span></span>
<span id="cb595-10"><a href="#cb595-10" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>We can transform both log and result simultaneously using
    <code>bimap</code> or <code>mapBoth</code>. <code>bimap</code> takes
    two function parameters, one for the log and one for the result.
    <code>mapBoth</code> takes a single function that accepts two
    parameters:</p>
    <div class="sourceCode" id="cb596"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb596-1"><a href="#cb596-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> writer3 <span class="op">=</span> writer1<span class="op">.</span><span class="fu">bimap</span><span class="op">(</span></span>
<span id="cb596-2"><a href="#cb596-2" aria-hidden="true" tabindex="-1"></a>  log <span class="op">=&gt;</span> log<span class="op">.</span><span class="fu">map</span><span class="op">(</span>_<span class="op">.</span>toUpperCase<span class="op">),</span></span>
<span id="cb596-3"><a href="#cb596-3" aria-hidden="true" tabindex="-1"></a>  res <span class="op">=&gt;</span> res <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb596-4"><a href="#cb596-4" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb596-5"><a href="#cb596-5" aria-hidden="true" tabindex="-1"></a><span class="co">// writer3: WriterT[Id, Vector[String], Int] = WriterT(</span></span>
<span id="cb596-6"><a href="#cb596-6" aria-hidden="true" tabindex="-1"></a><span class="co">//   run = (Vector(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;X&quot;, &quot;Y&quot;, &quot;Z&quot;), 4200)</span></span>
<span id="cb596-7"><a href="#cb596-7" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span>
<span id="cb596-8"><a href="#cb596-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb596-9"><a href="#cb596-9" aria-hidden="true" tabindex="-1"></a>writer3<span class="op">.</span>run</span>
<span id="cb596-10"><a href="#cb596-10" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: Tuple2[Vector[String], Int] = (</span></span>
<span id="cb596-11"><a href="#cb596-11" aria-hidden="true" tabindex="-1"></a><span class="co">//   Vector(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;X&quot;, &quot;Y&quot;, &quot;Z&quot;),</span></span>
<span id="cb596-12"><a href="#cb596-12" aria-hidden="true" tabindex="-1"></a><span class="co">//   4200</span></span>
<span id="cb596-13"><a href="#cb596-13" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span>
<span id="cb596-14"><a href="#cb596-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb596-15"><a href="#cb596-15" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> writer4 <span class="op">=</span> writer1<span class="op">.</span>mapBoth <span class="op">{</span> <span class="op">(</span>log<span class="op">,</span> res<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb596-16"><a href="#cb596-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> log2 <span class="op">=</span> log<span class="op">.</span><span class="fu">map</span><span class="op">(</span>_ <span class="op">+</span> <span class="st">&quot;!&quot;</span><span class="op">)</span></span>
<span id="cb596-17"><a href="#cb596-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> res2 <span class="op">=</span> res <span class="op">*</span> <span class="dv">1000</span></span>
<span id="cb596-18"><a href="#cb596-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">(</span>log2<span class="op">,</span> res2<span class="op">)</span></span>
<span id="cb596-19"><a href="#cb596-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb596-20"><a href="#cb596-20" aria-hidden="true" tabindex="-1"></a><span class="co">// writer4: WriterT[Id, Vector[String], Int] = WriterT(</span></span>
<span id="cb596-21"><a href="#cb596-21" aria-hidden="true" tabindex="-1"></a><span class="co">//   run = (Vector(&quot;a!&quot;, &quot;b!&quot;, &quot;c!&quot;, &quot;x!&quot;, &quot;y!&quot;, &quot;z!&quot;), 42000)</span></span>
<span id="cb596-22"><a href="#cb596-22" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span>
<span id="cb596-23"><a href="#cb596-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb596-24"><a href="#cb596-24" aria-hidden="true" tabindex="-1"></a>writer4<span class="op">.</span>run</span>
<span id="cb596-25"><a href="#cb596-25" aria-hidden="true" tabindex="-1"></a><span class="co">// res6: Tuple2[Vector[String], Int] = (</span></span>
<span id="cb596-26"><a href="#cb596-26" aria-hidden="true" tabindex="-1"></a><span class="co">//   Vector(&quot;a!&quot;, &quot;b!&quot;, &quot;c!&quot;, &quot;x!&quot;, &quot;y!&quot;, &quot;z!&quot;),</span></span>
<span id="cb596-27"><a href="#cb596-27" aria-hidden="true" tabindex="-1"></a><span class="co">//   42000</span></span>
<span id="cb596-28"><a href="#cb596-28" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>Finally, we can clear the log with the <code>reset</code> method
    and swap log and result with the <code>swap</code> method:</p>
    <div class="sourceCode" id="cb597"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb597-1"><a href="#cb597-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> writer5 <span class="op">=</span> writer1<span class="op">.</span>reset</span>
<span id="cb597-2"><a href="#cb597-2" aria-hidden="true" tabindex="-1"></a><span class="co">// writer5: WriterT[Id, Vector[String], Int] = WriterT(run = (Vector(), 42))</span></span>
<span id="cb597-3"><a href="#cb597-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb597-4"><a href="#cb597-4" aria-hidden="true" tabindex="-1"></a>writer5<span class="op">.</span>run</span>
<span id="cb597-5"><a href="#cb597-5" aria-hidden="true" tabindex="-1"></a><span class="co">// res7: Tuple2[Vector[String], Int] = (Vector(), 42)</span></span>
<span id="cb597-6"><a href="#cb597-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb597-7"><a href="#cb597-7" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> writer6 <span class="op">=</span> writer1<span class="op">.</span>swap</span>
<span id="cb597-8"><a href="#cb597-8" aria-hidden="true" tabindex="-1"></a><span class="co">// writer6: WriterT[Id, Int, Vector[String]] = WriterT(</span></span>
<span id="cb597-9"><a href="#cb597-9" aria-hidden="true" tabindex="-1"></a><span class="co">//   run = (42, Vector(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;x&quot;, &quot;y&quot;, &quot;z&quot;))</span></span>
<span id="cb597-10"><a href="#cb597-10" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span>
<span id="cb597-11"><a href="#cb597-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb597-12"><a href="#cb597-12" aria-hidden="true" tabindex="-1"></a>writer6<span class="op">.</span>run</span>
<span id="cb597-13"><a href="#cb597-13" aria-hidden="true" tabindex="-1"></a><span class="co">// res8: Tuple2[Int, Vector[String]] = (</span></span>
<span id="cb597-14"><a href="#cb597-14" aria-hidden="true" tabindex="-1"></a><span class="co">//   42,</span></span>
<span id="cb597-15"><a href="#cb597-15" aria-hidden="true" tabindex="-1"></a><span class="co">//   Vector(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;x&quot;, &quot;y&quot;, &quot;z&quot;)</span></span>
<span id="cb597-16"><a href="#cb597-16" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <h3 data-number="9.7.3" id="exercise-show-your-working"><span class="header-section-number">9.7.3</span> Exercise: Show Your
    Working</h3>
    <p><code>Writers</code> are useful for logging operations in
    multi-threaded environments. Let’s confirm this by computing (and
    logging) some factorials.</p>
    <p>The <code>factorial</code> function below computes a factorial
    and prints out the intermediate steps as it runs. The
    <code>slowly</code> helper function ensures this takes a while to
    run, even on the very small examples below:</p>
    <div class="sourceCode" id="cb598"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb598-1"><a href="#cb598-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> slowly<span class="op">[</span>A<span class="op">](</span>body<span class="op">:</span> <span class="op">=&gt;</span> A<span class="op">)</span> <span class="op">=</span></span>
<span id="cb598-2"><a href="#cb598-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> body <span class="cf">finally</span> <span class="ex">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">100</span><span class="op">)</span></span>
<span id="cb598-3"><a href="#cb598-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb598-4"><a href="#cb598-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">factorial</span><span class="op">(</span>n<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="bu">Int</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb598-5"><a href="#cb598-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> ans <span class="op">=</span> <span class="fu">slowly</span><span class="op">(</span><span class="cf">if</span><span class="op">(</span>n <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="dv">1</span> <span class="cf">else</span> n <span class="op">*</span> <span class="fu">factorial</span><span class="op">(</span>n <span class="op">-</span> <span class="dv">1</span><span class="op">))</span></span>
<span id="cb598-6"><a href="#cb598-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">println</span><span class="op">(</span><span class="ss">s&quot;</span><span class="st">fact </span><span class="ss">$n</span><span class="st"> </span><span class="ss">$ans&quot;</span><span class="op">)</span></span>
<span id="cb598-7"><a href="#cb598-7" aria-hidden="true" tabindex="-1"></a>  ans</span>
<span id="cb598-8"><a href="#cb598-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Here’s the output—a sequence of monotonically increasing
    values:</p>
    <div class="sourceCode" id="cb599"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb599-1"><a href="#cb599-1" aria-hidden="true" tabindex="-1"></a><span class="fu">factorial</span><span class="op">(</span><span class="dv">5</span><span class="op">)</span></span>
<span id="cb599-2"><a href="#cb599-2" aria-hidden="true" tabindex="-1"></a><span class="co">// fact 0 1</span></span>
<span id="cb599-3"><a href="#cb599-3" aria-hidden="true" tabindex="-1"></a><span class="co">// fact 1 1</span></span>
<span id="cb599-4"><a href="#cb599-4" aria-hidden="true" tabindex="-1"></a><span class="co">// fact 2 2</span></span>
<span id="cb599-5"><a href="#cb599-5" aria-hidden="true" tabindex="-1"></a><span class="co">// fact 3 6</span></span>
<span id="cb599-6"><a href="#cb599-6" aria-hidden="true" tabindex="-1"></a><span class="co">// fact 4 24</span></span>
<span id="cb599-7"><a href="#cb599-7" aria-hidden="true" tabindex="-1"></a><span class="co">// fact 5 120</span></span>
<span id="cb599-8"><a href="#cb599-8" aria-hidden="true" tabindex="-1"></a><span class="co">// res9: Int = 120</span></span></code></pre></div>
    <p>If we start several factorials in parallel, the log messages can
    become interleaved on standard out. This makes it difficult to see
    which messages come from which computation:</p>
    <div class="sourceCode" id="cb600"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb600-1"><a href="#cb600-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span>_</span>
<span id="cb600-2"><a href="#cb600-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span>ExecutionContext<span class="op">.</span>Implicits<span class="op">.</span>_</span>
<span id="cb600-3"><a href="#cb600-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span>duration<span class="op">.</span>_</span>
<span id="cb600-4"><a href="#cb600-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb600-5"><a href="#cb600-5" aria-hidden="true" tabindex="-1"></a>Await<span class="op">.</span><span class="fu">result</span><span class="op">(</span><span class="ex">Future</span><span class="op">.</span><span class="fu">sequence</span><span class="op">(</span><span class="ex">Vector</span><span class="op">(</span></span>
<span id="cb600-6"><a href="#cb600-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Future</span><span class="op">(</span><span class="fu">factorial</span><span class="op">(</span><span class="dv">5</span><span class="op">)),</span></span>
<span id="cb600-7"><a href="#cb600-7" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Future</span><span class="op">(</span><span class="fu">factorial</span><span class="op">(</span><span class="dv">5</span><span class="op">))</span></span>
<span id="cb600-8"><a href="#cb600-8" aria-hidden="true" tabindex="-1"></a><span class="op">)),</span> <span class="fl">5.</span>seconds<span class="op">)</span></span>
<span id="cb600-9"><a href="#cb600-9" aria-hidden="true" tabindex="-1"></a><span class="co">// fact 0 1</span></span>
<span id="cb600-10"><a href="#cb600-10" aria-hidden="true" tabindex="-1"></a><span class="co">// fact 0 1</span></span>
<span id="cb600-11"><a href="#cb600-11" aria-hidden="true" tabindex="-1"></a><span class="co">// fact 1 1</span></span>
<span id="cb600-12"><a href="#cb600-12" aria-hidden="true" tabindex="-1"></a><span class="co">// fact 1 1</span></span>
<span id="cb600-13"><a href="#cb600-13" aria-hidden="true" tabindex="-1"></a><span class="co">// fact 2 2</span></span>
<span id="cb600-14"><a href="#cb600-14" aria-hidden="true" tabindex="-1"></a><span class="co">// fact 2 2</span></span>
<span id="cb600-15"><a href="#cb600-15" aria-hidden="true" tabindex="-1"></a><span class="co">// fact 3 6</span></span>
<span id="cb600-16"><a href="#cb600-16" aria-hidden="true" tabindex="-1"></a><span class="co">// fact 3 6</span></span>
<span id="cb600-17"><a href="#cb600-17" aria-hidden="true" tabindex="-1"></a><span class="co">// fact 4 24</span></span>
<span id="cb600-18"><a href="#cb600-18" aria-hidden="true" tabindex="-1"></a><span class="co">// fact 4 24</span></span>
<span id="cb600-19"><a href="#cb600-19" aria-hidden="true" tabindex="-1"></a><span class="co">// fact 5 120</span></span>
<span id="cb600-20"><a href="#cb600-20" aria-hidden="true" tabindex="-1"></a><span class="co">// fact 5 120</span></span>
<span id="cb600-21"><a href="#cb600-21" aria-hidden="true" tabindex="-1"></a><span class="co">// res: scala.collection.immutable.Vector[Int] =</span></span>
<span id="cb600-22"><a href="#cb600-22" aria-hidden="true" tabindex="-1"></a><span class="co">//   Vector(120, 120)</span></span></code></pre></div>
    <!--
    HACK: tut isn't capturing stdout from the threads above,
    so i gone done hacked it.
    -->
    <p>Rewrite <code>factorial</code> so it captures the log messages in
    a <code>Writer</code>. Demonstrate that this allows us to reliably
    separate the logs for concurrent computations.</p>
    <div class="solution">
    <p>We’ll start by defining a type alias for <code>Writer</code> so
    we can use it with <code>pure</code> syntax:</p>
    <div class="sourceCode" id="cb601"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb601-1"><a href="#cb601-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>data<span class="op">.</span><span class="ex">Writer</span></span>
<span id="cb601-2"><a href="#cb601-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>vector<span class="op">.</span>_</span>
<span id="cb601-3"><a href="#cb601-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>applicative<span class="op">.</span>_ <span class="co">// for pure</span></span>
<span id="cb601-4"><a href="#cb601-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb601-5"><a href="#cb601-5" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Logged<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> <span class="ex">Writer</span><span class="op">[</span><span class="ex">Vector</span><span class="op">[</span><span class="ex">String</span><span class="op">],</span> A<span class="op">]</span></span></code></pre></div>
    <div class="sourceCode" id="cb602"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb602-1"><a href="#cb602-1" aria-hidden="true" tabindex="-1"></a><span class="fl">42.</span>pure<span class="op">[</span>Logged<span class="op">]</span></span>
<span id="cb602-2"><a href="#cb602-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res11: WriterT[Id, Vector[String], Int] = WriterT(run = (Vector(), 42))</span></span></code></pre></div>
    <p>We’ll import the <code>tell</code> syntax as well:</p>
    <div class="sourceCode" id="cb603"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb603-1"><a href="#cb603-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>writer<span class="op">.</span>_ <span class="co">// for tell</span></span></code></pre></div>
    <div class="sourceCode" id="cb604"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb604-1"><a href="#cb604-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Vector</span><span class="op">(</span><span class="st">&quot;Message&quot;</span><span class="op">).</span>tell</span>
<span id="cb604-2"><a href="#cb604-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res12: WriterT[Id, Vector[String], Unit] = WriterT(</span></span>
<span id="cb604-3"><a href="#cb604-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   run = (Vector(&quot;Message&quot;), ())</span></span>
<span id="cb604-4"><a href="#cb604-4" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>Finally, we’ll import the <code>Semigroup</code> instance for
    <code>Vector</code>. We need this to <code>map</code> and
    <code>flatMap</code> over <code>Logged</code>:</p>
    <div class="sourceCode" id="cb605"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb605-1"><a href="#cb605-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>vector<span class="op">.</span>_ <span class="co">// for Monoid</span></span></code></pre></div>
    <div class="sourceCode" id="cb606"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb606-1"><a href="#cb606-1" aria-hidden="true" tabindex="-1"></a><span class="fl">41.</span>pure<span class="op">[</span>Logged<span class="op">].</span><span class="fu">map</span><span class="op">(</span>_ <span class="op">+</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb606-2"><a href="#cb606-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res13: WriterT[Id, Vector[String], Int] = WriterT(run = (Vector(), 42))</span></span></code></pre></div>
    <p>With these in scope, the definition of <code>factorial</code>
    becomes:</p>
    <div class="sourceCode" id="cb607"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb607-1"><a href="#cb607-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">factorial</span><span class="op">(</span>n<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> Logged<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb607-2"><a href="#cb607-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb607-3"><a href="#cb607-3" aria-hidden="true" tabindex="-1"></a>    ans <span class="op">&lt;-</span> <span class="cf">if</span><span class="op">(</span>n <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb607-4"><a href="#cb607-4" aria-hidden="true" tabindex="-1"></a>             <span class="fl">1.</span>pure<span class="op">[</span>Logged<span class="op">]</span></span>
<span id="cb607-5"><a href="#cb607-5" aria-hidden="true" tabindex="-1"></a>           <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb607-6"><a href="#cb607-6" aria-hidden="true" tabindex="-1"></a>             <span class="fu">slowly</span><span class="op">(</span><span class="fu">factorial</span><span class="op">(</span>n <span class="op">-</span> <span class="dv">1</span><span class="op">).</span><span class="fu">map</span><span class="op">(</span>_ <span class="op">*</span> n<span class="op">))</span></span>
<span id="cb607-7"><a href="#cb607-7" aria-hidden="true" tabindex="-1"></a>           <span class="op">}</span></span>
<span id="cb607-8"><a href="#cb607-8" aria-hidden="true" tabindex="-1"></a>    _   <span class="op">&lt;-</span> <span class="ex">Vector</span><span class="op">(</span><span class="ss">s&quot;</span><span class="st">fact </span><span class="ss">$n</span><span class="st"> </span><span class="ss">$ans&quot;</span><span class="op">).</span>tell</span>
<span id="cb607-9"><a href="#cb607-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">yield</span> ans</span></code></pre></div>
    <p>When we call <code>factorial</code>, we now have to
    <code>run</code> the return value to extract the log and our
    factorial:</p>
    <div class="sourceCode" id="cb608"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb608-1"><a href="#cb608-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="op">(</span>log<span class="op">,</span> res<span class="op">)</span> <span class="op">=</span> <span class="fu">factorial</span><span class="op">(</span><span class="dv">5</span><span class="op">).</span>run</span>
<span id="cb608-2"><a href="#cb608-2" aria-hidden="true" tabindex="-1"></a><span class="co">// log: Vector[String] = Vector(</span></span>
<span id="cb608-3"><a href="#cb608-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   &quot;fact 0 1&quot;,</span></span>
<span id="cb608-4"><a href="#cb608-4" aria-hidden="true" tabindex="-1"></a><span class="co">//   &quot;fact 1 1&quot;,</span></span>
<span id="cb608-5"><a href="#cb608-5" aria-hidden="true" tabindex="-1"></a><span class="co">//   &quot;fact 2 2&quot;,</span></span>
<span id="cb608-6"><a href="#cb608-6" aria-hidden="true" tabindex="-1"></a><span class="co">//   &quot;fact 3 6&quot;,</span></span>
<span id="cb608-7"><a href="#cb608-7" aria-hidden="true" tabindex="-1"></a><span class="co">//   &quot;fact 4 24&quot;,</span></span>
<span id="cb608-8"><a href="#cb608-8" aria-hidden="true" tabindex="-1"></a><span class="co">//   &quot;fact 5 120&quot;</span></span>
<span id="cb608-9"><a href="#cb608-9" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span>
<span id="cb608-10"><a href="#cb608-10" aria-hidden="true" tabindex="-1"></a><span class="co">// res: Int = 120</span></span></code></pre></div>
    <p>We can run several <code>factorials</code> in parallel as
    follows, capturing their logs independently without fear of
    interleaving:</p>
    <div class="sourceCode" id="cb609"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb609-1"><a href="#cb609-1" aria-hidden="true" tabindex="-1"></a>Await<span class="op">.</span><span class="fu">result</span><span class="op">(</span><span class="ex">Future</span><span class="op">.</span><span class="fu">sequence</span><span class="op">(</span><span class="ex">Vector</span><span class="op">(</span></span>
<span id="cb609-2"><a href="#cb609-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Future</span><span class="op">(</span><span class="fu">factorial</span><span class="op">(</span><span class="dv">5</span><span class="op">)),</span></span>
<span id="cb609-3"><a href="#cb609-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Future</span><span class="op">(</span><span class="fu">factorial</span><span class="op">(</span><span class="dv">5</span><span class="op">))</span></span>
<span id="cb609-4"><a href="#cb609-4" aria-hidden="true" tabindex="-1"></a><span class="op">)).</span><span class="fu">map</span><span class="op">(</span>_<span class="op">.</span><span class="fu">map</span><span class="op">(</span>_<span class="op">.</span>written<span class="op">)),</span> <span class="fl">5.</span>seconds<span class="op">)</span></span>
<span id="cb609-5"><a href="#cb609-5" aria-hidden="true" tabindex="-1"></a><span class="co">// res: scala.collection.immutable.Vector[cats.Id[Vector[String]]] = </span></span>
<span id="cb609-6"><a href="#cb609-6" aria-hidden="true" tabindex="-1"></a><span class="co">//   Vector(</span></span>
<span id="cb609-7"><a href="#cb609-7" aria-hidden="true" tabindex="-1"></a><span class="co">//     Vector(fact 0 1, fact 1 1, fact 2 2, fact 3 6, fact 4 24, fact 5 120), </span></span>
<span id="cb609-8"><a href="#cb609-8" aria-hidden="true" tabindex="-1"></a><span class="co">//     Vector(fact 0 1, fact 1 1, fact 2 2, fact 3 6, fact 4 24, fact 5 120)</span></span>
<span id="cb609-9"><a href="#cb609-9" aria-hidden="true" tabindex="-1"></a><span class="co">//   )</span></span></code></pre></div>
    <!--
    HACK: There is a deadlock in the REPL that prevents the code above from working
    (see https://github.com/scala/bug/issues/9076) so i gone done hacked it.
    -->
    </div>
    <h2 data-number="9.8" id="sec:monads:reader"><span class="header-section-number">9.8</span> The Reader Monad</h2>
    <p><a href="http://typelevel.org/cats/api/cats/data/?search=reader#Reader%5BA,B%5D=cats.data.package.ReaderT%5Bcats.Id,A,B%5D"><code>cats.data.Reader</code></a>
    is a monad that allows us to sequence operations that depend on some
    input. Instances of <code>Reader</code> wrap up functions of one
    argument, providing us with useful methods for composing them.</p>
    <p>One common use for <code>Readers</code> is dependency injection.
    If we have a number of operations that all depend on some external
    configuration, we can chain them together using a
    <code>Reader</code> to produce one large operation that accepts the
    configuration as a parameter and runs our program in the order
    specified.</p>
    <h3 data-number="9.8.1" id="creating-and-unpacking-readers"><span class="header-section-number">9.8.1</span> Creating and Unpacking
    Readers</h3>
    <p>We can create a <code>Reader[A, B]</code> from a function
    <code>A =&gt; B</code> using the <code>Reader.apply</code>
    constructor:</p>
    <div class="sourceCode" id="cb610"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb610-1"><a href="#cb610-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>data<span class="op">.</span><span class="ex">Reader</span></span></code></pre></div>
    <div class="sourceCode" id="cb611"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb611-1"><a href="#cb611-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">Cat</span><span class="op">(</span>name<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> favoriteFood<span class="op">:</span> <span class="ex">String</span><span class="op">)</span></span>
<span id="cb611-2"><a href="#cb611-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb611-3"><a href="#cb611-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> catName<span class="op">:</span> <span class="ex">Reader</span><span class="op">[</span>Cat<span class="op">,</span> <span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb611-4"><a href="#cb611-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Reader</span><span class="op">(</span>cat <span class="op">=&gt;</span> cat<span class="op">.</span>name<span class="op">)</span></span>
<span id="cb611-5"><a href="#cb611-5" aria-hidden="true" tabindex="-1"></a><span class="co">// catName: Kleisli[Id, Cat, String] = Kleisli(</span></span>
<span id="cb611-6"><a href="#cb611-6" aria-hidden="true" tabindex="-1"></a><span class="co">//   run = repl.MdocSession$MdocApp0$$$Lambda/0x00007fcce2e6c000@263f33eb</span></span>
<span id="cb611-7"><a href="#cb611-7" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>We can extract the function again using the <code>Reader&#39;s</code>
    <code>run</code> method and call it using <code>apply</code> as
    usual:</p>
    <div class="sourceCode" id="cb612"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb612-1"><a href="#cb612-1" aria-hidden="true" tabindex="-1"></a>catName<span class="op">.</span><span class="fu">run</span><span class="op">(</span><span class="fu">Cat</span><span class="op">(</span><span class="st">&quot;Garfield&quot;</span><span class="op">,</span> <span class="st">&quot;lasagne&quot;</span><span class="op">))</span></span>
<span id="cb612-2"><a href="#cb612-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: String = &quot;Garfield&quot;</span></span></code></pre></div>
    <p>So far so simple, but what advantage do <code>Readers</code> give
    us over the raw functions?</p>
    <h3 data-number="9.8.2" id="composing-readers"><span class="header-section-number">9.8.2</span> Composing Readers</h3>
    <p>The power of <code>Readers</code> comes from their
    <code>map</code> and <code>flatMap</code> methods, which represent
    different kinds of function composition. We typically create a set
    of <code>Readers</code> that accept the same type of configuration,
    combine them with <code>map</code> and <code>flatMap</code>, and
    then call <code>run</code> to inject the config at the end.</p>
    <p>The <code>map</code> method simply extends the computation in the
    <code>Reader</code> by passing its result through a function:</p>
    <div class="sourceCode" id="cb613"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb613-1"><a href="#cb613-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> greetKitty<span class="op">:</span> <span class="ex">Reader</span><span class="op">[</span>Cat<span class="op">,</span> <span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb613-2"><a href="#cb613-2" aria-hidden="true" tabindex="-1"></a>  catName<span class="op">.</span><span class="fu">map</span><span class="op">(</span>name <span class="op">=&gt;</span> <span class="ss">s&quot;</span><span class="st">Hello </span><span class="ss">${</span>name<span class="ss">}&quot;</span><span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb614"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb614-1"><a href="#cb614-1" aria-hidden="true" tabindex="-1"></a>greetKitty<span class="op">.</span><span class="fu">run</span><span class="op">(</span><span class="fu">Cat</span><span class="op">(</span><span class="st">&quot;Heathcliff&quot;</span><span class="op">,</span> <span class="st">&quot;junk food&quot;</span><span class="op">))</span></span>
<span id="cb614-2"><a href="#cb614-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: String = &quot;Hello Heathcliff&quot;</span></span></code></pre></div>
    <p>The <code>flatMap</code> method is more interesting. It allows us
    to combine readers that depend on the same input type. To illustrate
    this, let’s extend our greeting example to also feed the cat:</p>
    <div class="sourceCode" id="cb615"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb615-1"><a href="#cb615-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> feedKitty<span class="op">:</span> <span class="ex">Reader</span><span class="op">[</span>Cat<span class="op">,</span> <span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb615-2"><a href="#cb615-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Reader</span><span class="op">(</span>cat <span class="op">=&gt;</span> <span class="ss">s&quot;</span><span class="st">Have a nice bowl of </span><span class="ss">${</span>cat<span class="op">.</span>favoriteFood<span class="ss">}&quot;</span><span class="op">)</span></span>
<span id="cb615-3"><a href="#cb615-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb615-4"><a href="#cb615-4" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> greetAndFeed<span class="op">:</span> <span class="ex">Reader</span><span class="op">[</span>Cat<span class="op">,</span> <span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb615-5"><a href="#cb615-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb615-6"><a href="#cb615-6" aria-hidden="true" tabindex="-1"></a>    greet <span class="op">&lt;-</span> greetKitty</span>
<span id="cb615-7"><a href="#cb615-7" aria-hidden="true" tabindex="-1"></a>    feed  <span class="op">&lt;-</span> feedKitty</span>
<span id="cb615-8"><a href="#cb615-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">yield</span> <span class="ss">s&quot;$greet</span><span class="st">. </span><span class="ss">$feed</span><span class="st">.</span><span class="ss">&quot;</span></span></code></pre></div>
    <div class="sourceCode" id="cb616"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb616-1"><a href="#cb616-1" aria-hidden="true" tabindex="-1"></a><span class="fu">greetAndFeed</span><span class="op">(</span><span class="fu">Cat</span><span class="op">(</span><span class="st">&quot;Garfield&quot;</span><span class="op">,</span> <span class="st">&quot;lasagne&quot;</span><span class="op">))</span></span>
<span id="cb616-2"><a href="#cb616-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: String = &quot;Hello Garfield. Have a nice bowl of lasagne.&quot;</span></span>
<span id="cb616-3"><a href="#cb616-3" aria-hidden="true" tabindex="-1"></a><span class="fu">greetAndFeed</span><span class="op">(</span><span class="fu">Cat</span><span class="op">(</span><span class="st">&quot;Heathcliff&quot;</span><span class="op">,</span> <span class="st">&quot;junk food&quot;</span><span class="op">))</span></span>
<span id="cb616-4"><a href="#cb616-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: String = &quot;Hello Heathcliff. Have a nice bowl of junk food.&quot;</span></span></code></pre></div>
    <h3 data-number="9.8.3" id="exercise-hacking-on-readers"><span class="header-section-number">9.8.3</span> Exercise: Hacking on
    Readers</h3>
    <p>The classic use of <code>Readers</code> is to build programs that
    accept a configuration as a parameter. Let’s ground this with a
    complete example of a simple login system. Our configuration will
    consist of two databases: a list of valid users and a list of their
    passwords:</p>
    <div class="sourceCode" id="cb617"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb617-1"><a href="#cb617-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">Db</span><span class="op">(</span></span>
<span id="cb617-2"><a href="#cb617-2" aria-hidden="true" tabindex="-1"></a>  usernames<span class="op">:</span> <span class="ex">Map</span><span class="op">[</span><span class="bu">Int</span><span class="op">,</span> <span class="ex">String</span><span class="op">],</span></span>
<span id="cb617-3"><a href="#cb617-3" aria-hidden="true" tabindex="-1"></a>  passwords<span class="op">:</span> <span class="ex">Map</span><span class="op">[</span><span class="ex">String</span><span class="op">,</span> <span class="ex">String</span><span class="op">]</span></span>
<span id="cb617-4"><a href="#cb617-4" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span></code></pre></div>
    <p>Start by creating a type alias <code>DbReader</code> for a
    <code>Reader</code> that consumes a <code>Db</code> as input. This
    will make the rest of our code shorter.</p>
    <div class="solution">
    <p>Our type alias fixes the <code>Db</code> type but leaves the
    result type flexible:</p>
    <div class="sourceCode" id="cb618"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb618-1"><a href="#cb618-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> DbReader<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> <span class="ex">Reader</span><span class="op">[</span>Db<span class="op">,</span> A<span class="op">]</span></span></code></pre></div>
    </div>
    <p>Now create methods that generate <code>DbReaders</code> to look
    up the username for an <code>Int</code> user ID, and look up the
    password for a <code>String</code> username. The type signatures
    should be as follows:</p>
    <div class="sourceCode" id="cb619"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb619-1"><a href="#cb619-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">findUsername</span><span class="op">(</span>userId<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> DbReader<span class="op">[</span><span class="ex">Option</span><span class="op">[</span><span class="ex">String</span><span class="op">]]</span> <span class="op">=</span></span>
<span id="cb619-2"><a href="#cb619-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">???</span></span>
<span id="cb619-3"><a href="#cb619-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb619-4"><a href="#cb619-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">checkPassword</span><span class="op">(</span></span>
<span id="cb619-5"><a href="#cb619-5" aria-hidden="true" tabindex="-1"></a>      username<span class="op">:</span> <span class="ex">String</span><span class="op">,</span></span>
<span id="cb619-6"><a href="#cb619-6" aria-hidden="true" tabindex="-1"></a>      password<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> DbReader<span class="op">[</span><span class="ex">Boolean</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb619-7"><a href="#cb619-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">???</span></span></code></pre></div>
    <div class="solution">
    <p>Remember: the idea is to leave injecting the configuration until
    last. This means setting up functions that accept the config as a
    parameter and check it against the concrete user info we have been
    given:</p>
    <div class="sourceCode" id="cb620"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb620-1"><a href="#cb620-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">findUsername</span><span class="op">(</span>userId<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> DbReader<span class="op">[</span><span class="ex">Option</span><span class="op">[</span><span class="ex">String</span><span class="op">]]</span> <span class="op">=</span></span>
<span id="cb620-2"><a href="#cb620-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Reader</span><span class="op">(</span>db <span class="op">=&gt;</span> db<span class="op">.</span>usernames<span class="op">.</span><span class="fu">get</span><span class="op">(</span>userId<span class="op">))</span></span>
<span id="cb620-3"><a href="#cb620-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb620-4"><a href="#cb620-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">checkPassword</span><span class="op">(</span></span>
<span id="cb620-5"><a href="#cb620-5" aria-hidden="true" tabindex="-1"></a>      username<span class="op">:</span> <span class="ex">String</span><span class="op">,</span></span>
<span id="cb620-6"><a href="#cb620-6" aria-hidden="true" tabindex="-1"></a>      password<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> DbReader<span class="op">[</span><span class="ex">Boolean</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb620-7"><a href="#cb620-7" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Reader</span><span class="op">(</span>db <span class="op">=&gt;</span> db<span class="op">.</span>passwords<span class="op">.</span><span class="fu">get</span><span class="op">(</span>username<span class="op">).</span><span class="fu">contains</span><span class="op">(</span>password<span class="op">))</span></span></code></pre></div>
    </div>
    <p>Finally create a <code>checkLogin</code> method to check the
    password for a given user ID. The type signature should be as
    follows:</p>
    <div class="sourceCode" id="cb621"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb621-1"><a href="#cb621-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">checkLogin</span><span class="op">(</span></span>
<span id="cb621-2"><a href="#cb621-2" aria-hidden="true" tabindex="-1"></a>      userId<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span></span>
<span id="cb621-3"><a href="#cb621-3" aria-hidden="true" tabindex="-1"></a>      password<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> DbReader<span class="op">[</span><span class="ex">Boolean</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb621-4"><a href="#cb621-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">???</span></span></code></pre></div>
    <div class="solution">
    <p>As you might expect, here we use <code>flatMap</code> to chain
    <code>findUsername</code> and <code>checkPassword</code>. We use
    <code>pure</code> to lift a <code>Boolean</code> to a
    <code>DbReader[Boolean]</code> when the username is not found:</p>
    <div class="sourceCode" id="cb622"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb622-1"><a href="#cb622-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>applicative<span class="op">.</span>_ <span class="co">// for pure</span></span>
<span id="cb622-2"><a href="#cb622-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb622-3"><a href="#cb622-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">checkLogin</span><span class="op">(</span></span>
<span id="cb622-4"><a href="#cb622-4" aria-hidden="true" tabindex="-1"></a>      userId<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span></span>
<span id="cb622-5"><a href="#cb622-5" aria-hidden="true" tabindex="-1"></a>      password<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> DbReader<span class="op">[</span><span class="ex">Boolean</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb622-6"><a href="#cb622-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb622-7"><a href="#cb622-7" aria-hidden="true" tabindex="-1"></a>    username   <span class="op">&lt;-</span> <span class="fu">findUsername</span><span class="op">(</span>userId<span class="op">)</span></span>
<span id="cb622-8"><a href="#cb622-8" aria-hidden="true" tabindex="-1"></a>    passwordOk <span class="op">&lt;-</span> username<span class="op">.</span>map <span class="op">{</span> username <span class="op">=&gt;</span></span>
<span id="cb622-9"><a href="#cb622-9" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">checkPassword</span><span class="op">(</span>username<span class="op">,</span> password<span class="op">)</span></span>
<span id="cb622-10"><a href="#cb622-10" aria-hidden="true" tabindex="-1"></a>                  <span class="op">}.</span>getOrElse <span class="op">{</span></span>
<span id="cb622-11"><a href="#cb622-11" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">false</span><span class="op">.</span>pure<span class="op">[</span>DbReader<span class="op">]</span></span>
<span id="cb622-12"><a href="#cb622-12" aria-hidden="true" tabindex="-1"></a>                  <span class="op">}</span></span>
<span id="cb622-13"><a href="#cb622-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">yield</span> passwordOk</span></code></pre></div>
    </div>
    <p>You should be able to use <code>checkLogin</code> as follows:</p>
    <div class="sourceCode" id="cb623"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb623-1"><a href="#cb623-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> users <span class="op">=</span> <span class="ex">Map</span><span class="op">(</span></span>
<span id="cb623-2"><a href="#cb623-2" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span> <span class="op">-&gt;</span> <span class="st">&quot;dade&quot;</span><span class="op">,</span></span>
<span id="cb623-3"><a href="#cb623-3" aria-hidden="true" tabindex="-1"></a>  <span class="dv">2</span> <span class="op">-&gt;</span> <span class="st">&quot;kate&quot;</span><span class="op">,</span></span>
<span id="cb623-4"><a href="#cb623-4" aria-hidden="true" tabindex="-1"></a>  <span class="dv">3</span> <span class="op">-&gt;</span> <span class="st">&quot;margo&quot;</span></span>
<span id="cb623-5"><a href="#cb623-5" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb623-6"><a href="#cb623-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb623-7"><a href="#cb623-7" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> passwords <span class="op">=</span> <span class="ex">Map</span><span class="op">(</span></span>
<span id="cb623-8"><a href="#cb623-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;dade&quot;</span>  <span class="op">-&gt;</span> <span class="st">&quot;zerocool&quot;</span><span class="op">,</span></span>
<span id="cb623-9"><a href="#cb623-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;kate&quot;</span>  <span class="op">-&gt;</span> <span class="st">&quot;acidburn&quot;</span><span class="op">,</span></span>
<span id="cb623-10"><a href="#cb623-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;margo&quot;</span> <span class="op">-&gt;</span> <span class="st">&quot;secret&quot;</span></span>
<span id="cb623-11"><a href="#cb623-11" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb623-12"><a href="#cb623-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb623-13"><a href="#cb623-13" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> db <span class="op">=</span> <span class="fu">Db</span><span class="op">(</span>users<span class="op">,</span> passwords<span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb624"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb624-1"><a href="#cb624-1" aria-hidden="true" tabindex="-1"></a><span class="fu">checkLogin</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="st">&quot;zerocool&quot;</span><span class="op">).</span><span class="fu">run</span><span class="op">(</span>db<span class="op">)</span></span>
<span id="cb624-2"><a href="#cb624-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res7: Boolean = true</span></span>
<span id="cb624-3"><a href="#cb624-3" aria-hidden="true" tabindex="-1"></a><span class="fu">checkLogin</span><span class="op">(</span><span class="dv">4</span><span class="op">,</span> <span class="st">&quot;davinci&quot;</span><span class="op">).</span><span class="fu">run</span><span class="op">(</span>db<span class="op">)</span></span>
<span id="cb624-4"><a href="#cb624-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res8: Boolean = false</span></span></code></pre></div>
    <h3 data-number="9.8.4" id="when-to-use-readers"><span class="header-section-number">9.8.4</span> When to Use Readers?</h3>
    <p><code>Readers</code> provide a tool for doing dependency
    injection. We write steps of our program as instances of
    <code>Reader</code>, chain them together with <code>map</code> and
    <code>flatMap</code>, and build a function that accepts the
    dependency as input.</p>
    <p>There are many ways of implementing dependency injection in
    Scala, from simple techniques like methods with multiple parameter
    lists, through implicit parameters and type classes, to complex
    techniques like the cake pattern and DI frameworks.</p>
    <p><code>Readers</code> are most useful in situations where:</p>
    <ul>
    <li><p>we are constructing a program that can easily be represented
    by a function;</p></li>
    <li><p>we need to defer injection of a known parameter or set of
    parameters;</p></li>
    <li><p>we want to be able to test parts of the program in
    isolation.</p></li>
    </ul>
    <p>By representing the steps of our program as <code>Readers</code>
    we can test them as easily as pure functions, plus we gain access to
    the <code>map</code> and <code>flatMap</code> combinators.</p>
    <p>For more complicated problems where we have lots of dependencies,
    or where a program isn’t easily represented as a pure function,
    other dependency injection techniques tend to be more
    appropriate.</p>
    <div class="callout callout-warning">
    <p><em>Kleisli Arrows</em></p>
    <p>You may have noticed from console output that <code>Reader</code>
    is implemented in terms of another type called <code>Kleisli</code>.
    <em>Kleisli arrows</em> provide a more general form of
    <code>Reader</code> that generalise over the type constructor of the
    result type. We will encounter Kleislis again in Chapter 10.</p>
    </div>
    <h2 data-number="9.9" id="the-state-monad"><span class="header-section-number">9.9</span> The State Monad</h2>
    <p><a href="http://typelevel.org/cats/api/cats/data/#State%5BS,A%5D=cats.data.StateT%5Bcats.Eval,S,A%5D"><code>cats.data.State</code></a>
    allows us to pass additional state around as part of a computation.
    We define <code>State</code> instances representing atomic state
    operations and thread them together using <code>map</code> and
    <code>flatMap</code>. In this way we can model mutable state in a
    purely functional way, without using actual mutation.</p>
    <h3 data-number="9.9.1" id="creating-and-unpacking-state"><span class="header-section-number">9.9.1</span> Creating and Unpacking
    State</h3>
    <p>Boiled down to their simplest form, instances of
    <code>State[S, A]</code> represent functions of type
    <code>S =&gt; (S, A)</code>. <code>S</code> is the type of the state
    and <code>A</code> is the type of the result.</p>
    <div class="sourceCode" id="cb625"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb625-1"><a href="#cb625-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>data<span class="op">.</span><span class="ex">State</span></span></code></pre></div>
    <div class="sourceCode" id="cb626"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb626-1"><a href="#cb626-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> a <span class="op">=</span> <span class="ex">State</span><span class="op">[</span><span class="bu">Int</span><span class="op">,</span> <span class="ex">String</span><span class="op">]{</span> state <span class="op">=&gt;</span></span>
<span id="cb626-2"><a href="#cb626-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">(</span>state<span class="op">,</span> <span class="ss">s&quot;</span><span class="st">The state is </span><span class="ss">$state&quot;</span><span class="op">)</span></span>
<span id="cb626-3"><a href="#cb626-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>In other words, an instance of <code>State</code> is a function
    that does two things:</p>
    <ul>
    <li>transforms an input state to an output state;</li>
    <li>computes a result.</li>
    </ul>
    <p>We can “run” our monad by supplying an initial state.
    <code>State</code> provides three methods—<code>run</code>,
    <code>runS</code>, and <code>runA</code>—that return different
    combinations of state and result. Each method returns an instance of
    <code>Eval</code>, which <code>State</code> uses to maintain stack
    safety. We call the <code>value</code> method as usual to extract
    the actual result:</p>
    <div class="sourceCode" id="cb627"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb627-1"><a href="#cb627-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Get the state and the result:</span></span>
<span id="cb627-2"><a href="#cb627-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="op">(</span>state<span class="op">,</span> result<span class="op">)</span> <span class="op">=</span> a<span class="op">.</span><span class="fu">run</span><span class="op">(</span><span class="dv">10</span><span class="op">).</span>value</span>
<span id="cb627-3"><a href="#cb627-3" aria-hidden="true" tabindex="-1"></a><span class="co">// state: Int = 10</span></span>
<span id="cb627-4"><a href="#cb627-4" aria-hidden="true" tabindex="-1"></a><span class="co">// result: String = &quot;The state is 10&quot;</span></span>
<span id="cb627-5"><a href="#cb627-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb627-6"><a href="#cb627-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Get the state, ignore the result:</span></span>
<span id="cb627-7"><a href="#cb627-7" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> justTheState <span class="op">=</span> a<span class="op">.</span><span class="fu">runS</span><span class="op">(</span><span class="dv">10</span><span class="op">).</span>value</span>
<span id="cb627-8"><a href="#cb627-8" aria-hidden="true" tabindex="-1"></a><span class="co">// justTheState: Int = 10</span></span>
<span id="cb627-9"><a href="#cb627-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb627-10"><a href="#cb627-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Get the result, ignore the state:</span></span>
<span id="cb627-11"><a href="#cb627-11" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> justTheResult <span class="op">=</span> a<span class="op">.</span><span class="fu">runA</span><span class="op">(</span><span class="dv">10</span><span class="op">).</span>value</span>
<span id="cb627-12"><a href="#cb627-12" aria-hidden="true" tabindex="-1"></a><span class="co">// justTheResult: String = &quot;The state is 10&quot;</span></span></code></pre></div>
    <h3 data-number="9.9.2" id="composing-and-transforming-state"><span class="header-section-number">9.9.2</span> Composing and
    Transforming State</h3>
    <p>As we’ve seen with <code>Reader</code> and <code>Writer</code>,
    the power of the <code>State</code> monad comes from combining
    instances. The <code>map</code> and <code>flatMap</code> methods
    thread the state from one instance to another. Each individual
    instance represents an atomic state transformation, and their
    combination represents a complete sequence of changes:</p>
    <div class="sourceCode" id="cb628"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb628-1"><a href="#cb628-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> step1 <span class="op">=</span> <span class="ex">State</span><span class="op">[</span><span class="bu">Int</span><span class="op">,</span> <span class="ex">String</span><span class="op">]{</span> num <span class="op">=&gt;</span></span>
<span id="cb628-2"><a href="#cb628-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> ans <span class="op">=</span> num <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb628-3"><a href="#cb628-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">(</span>ans<span class="op">,</span> <span class="ss">s&quot;</span><span class="st">Result of step1: </span><span class="ss">$ans&quot;</span><span class="op">)</span></span>
<span id="cb628-4"><a href="#cb628-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb628-5"><a href="#cb628-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb628-6"><a href="#cb628-6" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> step2 <span class="op">=</span> <span class="ex">State</span><span class="op">[</span><span class="bu">Int</span><span class="op">,</span> <span class="ex">String</span><span class="op">]{</span> num <span class="op">=&gt;</span></span>
<span id="cb628-7"><a href="#cb628-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> ans <span class="op">=</span> num <span class="op">*</span> <span class="dv">2</span></span>
<span id="cb628-8"><a href="#cb628-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">(</span>ans<span class="op">,</span> <span class="ss">s&quot;</span><span class="st">Result of step2: </span><span class="ss">$ans&quot;</span><span class="op">)</span></span>
<span id="cb628-9"><a href="#cb628-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb628-10"><a href="#cb628-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb628-11"><a href="#cb628-11" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> both <span class="op">=</span> <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb628-12"><a href="#cb628-12" aria-hidden="true" tabindex="-1"></a>  a <span class="op">&lt;-</span> step1</span>
<span id="cb628-13"><a href="#cb628-13" aria-hidden="true" tabindex="-1"></a>  b <span class="op">&lt;-</span> step2</span>
<span id="cb628-14"><a href="#cb628-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">yield</span> <span class="op">(</span>a<span class="op">,</span> b<span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb629"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb629-1"><a href="#cb629-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="op">(</span>state<span class="op">,</span> result<span class="op">)</span> <span class="op">=</span> both<span class="op">.</span><span class="fu">run</span><span class="op">(</span><span class="dv">20</span><span class="op">).</span>value</span>
<span id="cb629-2"><a href="#cb629-2" aria-hidden="true" tabindex="-1"></a><span class="co">// state: Int = 42</span></span>
<span id="cb629-3"><a href="#cb629-3" aria-hidden="true" tabindex="-1"></a><span class="co">// result: Tuple2[String, String] = (</span></span>
<span id="cb629-4"><a href="#cb629-4" aria-hidden="true" tabindex="-1"></a><span class="co">//   &quot;Result of step1: 21&quot;,</span></span>
<span id="cb629-5"><a href="#cb629-5" aria-hidden="true" tabindex="-1"></a><span class="co">//   &quot;Result of step2: 42&quot;</span></span>
<span id="cb629-6"><a href="#cb629-6" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>As you can see, in this example the final state is the result of
    applying both transformations in sequence. State is threaded from
    step to step even though we don’t interact with it in the for
    comprehension.</p>
    <p>The general model for using the <code>State</code> monad is to
    represent each step of a computation as an instance and compose the
    steps using the standard monad operators. Cats provides several
    convenience constructors for creating primitive steps:</p>
    <ul>
    <li><code>get</code> extracts the state as the result;</li>
    <li><code>set</code> updates the state and returns unit as the
    result;</li>
    <li><code>pure</code> ignores the state and returns a supplied
    result;</li>
    <li><code>inspect</code> extracts the state via a transformation
    function;</li>
    <li><code>modify</code> updates the state using an update
    function.</li>
    </ul>
    <div class="sourceCode" id="cb630"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb630-1"><a href="#cb630-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> getDemo <span class="op">=</span> <span class="ex">State</span><span class="op">.</span>get<span class="op">[</span><span class="bu">Int</span><span class="op">]</span></span>
<span id="cb630-2"><a href="#cb630-2" aria-hidden="true" tabindex="-1"></a><span class="co">// getDemo: IndexedStateT[[A &gt;: Nothing &lt;: Any] =&gt; Eval[A], Int, Int, Int] = cats.data.IndexedStateT@62e56fcc</span></span>
<span id="cb630-3"><a href="#cb630-3" aria-hidden="true" tabindex="-1"></a>getDemo<span class="op">.</span><span class="fu">run</span><span class="op">(</span><span class="dv">10</span><span class="op">).</span>value</span>
<span id="cb630-4"><a href="#cb630-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: Tuple2[Int, Int] = (10, 10)</span></span>
<span id="cb630-5"><a href="#cb630-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb630-6"><a href="#cb630-6" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> setDemo <span class="op">=</span> <span class="ex">State</span><span class="op">.</span>set<span class="op">[</span><span class="bu">Int</span><span class="op">](</span><span class="dv">30</span><span class="op">)</span></span>
<span id="cb630-7"><a href="#cb630-7" aria-hidden="true" tabindex="-1"></a><span class="co">// setDemo: IndexedStateT[[A &gt;: Nothing &lt;: Any] =&gt; Eval[A], Int, Int, Unit] = cats.data.IndexedStateT@7efefdc</span></span>
<span id="cb630-8"><a href="#cb630-8" aria-hidden="true" tabindex="-1"></a>setDemo<span class="op">.</span><span class="fu">run</span><span class="op">(</span><span class="dv">10</span><span class="op">).</span>value</span>
<span id="cb630-9"><a href="#cb630-9" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: Tuple2[Int, Unit] = (30, ())</span></span>
<span id="cb630-10"><a href="#cb630-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb630-11"><a href="#cb630-11" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> pureDemo <span class="op">=</span> <span class="ex">State</span><span class="op">.</span>pure<span class="op">[</span><span class="bu">Int</span><span class="op">,</span> <span class="ex">String</span><span class="op">](</span><span class="st">&quot;Result&quot;</span><span class="op">)</span></span>
<span id="cb630-12"><a href="#cb630-12" aria-hidden="true" tabindex="-1"></a><span class="co">// pureDemo: IndexedStateT[[A &gt;: Nothing &lt;: Any] =&gt; Eval[A], Int, Int, String] = cats.data.IndexedStateT@4f0bfc84</span></span>
<span id="cb630-13"><a href="#cb630-13" aria-hidden="true" tabindex="-1"></a>pureDemo<span class="op">.</span><span class="fu">run</span><span class="op">(</span><span class="dv">10</span><span class="op">).</span>value</span>
<span id="cb630-14"><a href="#cb630-14" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: Tuple2[Int, String] = (10, &quot;Result&quot;)</span></span>
<span id="cb630-15"><a href="#cb630-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb630-16"><a href="#cb630-16" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> inspectDemo <span class="op">=</span> <span class="ex">State</span><span class="op">.</span>inspect<span class="op">[</span><span class="bu">Int</span><span class="op">,</span> <span class="ex">String</span><span class="op">](</span>x <span class="op">=&gt;</span> <span class="ss">s&quot;${</span>x<span class="ss">}</span><span class="st">!</span><span class="ss">&quot;</span><span class="op">)</span></span>
<span id="cb630-17"><a href="#cb630-17" aria-hidden="true" tabindex="-1"></a><span class="co">// inspectDemo: IndexedStateT[[A &gt;: Nothing &lt;: Any] =&gt; Eval[A], Int, Int, String] = cats.data.IndexedStateT@1317804c</span></span>
<span id="cb630-18"><a href="#cb630-18" aria-hidden="true" tabindex="-1"></a>inspectDemo<span class="op">.</span><span class="fu">run</span><span class="op">(</span><span class="dv">10</span><span class="op">).</span>value</span>
<span id="cb630-19"><a href="#cb630-19" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: Tuple2[Int, String] = (10, &quot;10!&quot;)</span></span>
<span id="cb630-20"><a href="#cb630-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb630-21"><a href="#cb630-21" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> modifyDemo <span class="op">=</span> <span class="ex">State</span><span class="op">.</span>modify<span class="op">[</span><span class="bu">Int</span><span class="op">](</span>_ <span class="op">+</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb630-22"><a href="#cb630-22" aria-hidden="true" tabindex="-1"></a><span class="co">// modifyDemo: IndexedStateT[[A &gt;: Nothing &lt;: Any] =&gt; Eval[A], Int, Int, Unit] = cats.data.IndexedStateT@2aadf2d3</span></span>
<span id="cb630-23"><a href="#cb630-23" aria-hidden="true" tabindex="-1"></a>modifyDemo<span class="op">.</span><span class="fu">run</span><span class="op">(</span><span class="dv">10</span><span class="op">).</span>value</span>
<span id="cb630-24"><a href="#cb630-24" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: Tuple2[Int, Unit] = (11, ())</span></span></code></pre></div>
    <p>We can assemble these building blocks using a for comprehension.
    We typically ignore the result of intermediate stages that only
    represent transformations on the state:</p>
    <div class="sourceCode" id="cb631"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb631-1"><a href="#cb631-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>data<span class="op">.</span><span class="ex">State</span></span>
<span id="cb631-2"><a href="#cb631-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="ex">State</span><span class="op">.</span>_</span></code></pre></div>
    <div class="sourceCode" id="cb632"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb632-1"><a href="#cb632-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> program<span class="op">:</span> <span class="ex">State</span><span class="op">[</span><span class="bu">Int</span><span class="op">,</span> <span class="op">(</span><span class="bu">Int</span><span class="op">,</span> <span class="bu">Int</span><span class="op">,</span> <span class="bu">Int</span><span class="op">)]</span> <span class="op">=</span> <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb632-2"><a href="#cb632-2" aria-hidden="true" tabindex="-1"></a>  a <span class="op">&lt;-</span> get<span class="op">[</span><span class="bu">Int</span><span class="op">]</span></span>
<span id="cb632-3"><a href="#cb632-3" aria-hidden="true" tabindex="-1"></a>  _ <span class="op">&lt;-</span> set<span class="op">[</span><span class="bu">Int</span><span class="op">](</span>a <span class="op">+</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb632-4"><a href="#cb632-4" aria-hidden="true" tabindex="-1"></a>  b <span class="op">&lt;-</span> get<span class="op">[</span><span class="bu">Int</span><span class="op">]</span></span>
<span id="cb632-5"><a href="#cb632-5" aria-hidden="true" tabindex="-1"></a>  _ <span class="op">&lt;-</span> modify<span class="op">[</span><span class="bu">Int</span><span class="op">](</span>_ <span class="op">+</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb632-6"><a href="#cb632-6" aria-hidden="true" tabindex="-1"></a>  c <span class="op">&lt;-</span> inspect<span class="op">[</span><span class="bu">Int</span><span class="op">,</span> <span class="bu">Int</span><span class="op">](</span>_ <span class="op">*</span> <span class="dv">1000</span><span class="op">)</span></span>
<span id="cb632-7"><a href="#cb632-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">yield</span> <span class="op">(</span>a<span class="op">,</span> b<span class="op">,</span> c<span class="op">)</span></span>
<span id="cb632-8"><a href="#cb632-8" aria-hidden="true" tabindex="-1"></a><span class="co">// program: IndexedStateT[[A &gt;: Nothing &lt;: Any] =&gt; Eval[A], Int, Int, Tuple3[Int, Int, Int]] = cats.data.IndexedStateT@7102d90f</span></span>
<span id="cb632-9"><a href="#cb632-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb632-10"><a href="#cb632-10" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="op">(</span>state<span class="op">,</span> result<span class="op">)</span> <span class="op">=</span> program<span class="op">.</span><span class="fu">run</span><span class="op">(</span><span class="dv">1</span><span class="op">).</span>value</span>
<span id="cb632-11"><a href="#cb632-11" aria-hidden="true" tabindex="-1"></a><span class="co">// state: Int = 3</span></span>
<span id="cb632-12"><a href="#cb632-12" aria-hidden="true" tabindex="-1"></a><span class="co">// result: Tuple3[Int, Int, Int] = (1, 2, 3000)</span></span></code></pre></div>
    <h3 data-number="9.9.3" id="exercise-post-order-calculator"><span class="header-section-number">9.9.3</span> Exercise: Post-Order
    Calculator</h3>
    <p>The <code>State</code> monad allows us to implement simple
    interpreters for complex expressions, passing the values of mutable
    registers along with the result. We can see a simple example of this
    by implementing a calculator for post-order integer arithmetic
    expressions.</p>
    <p>In case you haven’t heard of post-order expressions before (don’t
    worry if you haven’t), they are a mathematical notation where we
    write the operator <em>after</em> its operands. So, for example,
    instead of writing <code>1 + 2</code> we would write:</p>
    <div class="sourceCode" id="cb633"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb633-1"><a href="#cb633-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="dv">2</span> <span class="op">+</span></span></code></pre></div>
    <p>Although post-order expressions are difficult for humans to read,
    they are easy to evaluate in code. All we need to do is traverse the
    symbols from left to right, carrying a <em>stack</em> of operands
    with us as we go:</p>
    <ul>
    <li><p>when we see a number, we push it onto the stack;</p></li>
    <li><p>when we see an operator, we pop two operands off the stack,
    operate on them, and push the result in their place.</p></li>
    </ul>
    <p>This allows us to evaluate complex expressions without using
    parentheses. For example, we can evaluate <code>(1 + 2) * 3)</code>
    as follows:</p>
    <div class="sourceCode" id="cb634"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb634-1"><a href="#cb634-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="dv">2</span> <span class="op">+</span> <span class="dv">3</span> <span class="op">*</span> <span class="co">// see 1, push onto stack</span></span>
<span id="cb634-2"><a href="#cb634-2" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="op">+</span> <span class="dv">3</span> <span class="op">*</span>   <span class="co">// see 2, push onto stack</span></span>
<span id="cb634-3"><a href="#cb634-3" aria-hidden="true" tabindex="-1"></a><span class="op">+</span> <span class="dv">3</span> <span class="op">*</span>     <span class="co">// see +, pop 1 and 2 off of stack,</span></span>
<span id="cb634-4"><a href="#cb634-4" aria-hidden="true" tabindex="-1"></a>          <span class="co">//        push (1 + 2) = 3 in their place</span></span>
<span id="cb634-5"><a href="#cb634-5" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="dv">3</span> <span class="op">*</span>     <span class="co">// see 3, push onto stack</span></span>
<span id="cb634-6"><a href="#cb634-6" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span> <span class="op">*</span>       <span class="co">// see 3, push onto stack</span></span>
<span id="cb634-7"><a href="#cb634-7" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>         <span class="co">// see *, pop 3 and 3 off of stack,</span></span>
<span id="cb634-8"><a href="#cb634-8" aria-hidden="true" tabindex="-1"></a>          <span class="co">//        push (3 * 3) = 9 in their place</span></span></code></pre></div>
    <p>Let’s write an interpreter for these expressions. We can parse
    each symbol into a <code>State</code> instance representing a
    transformation on the stack and an intermediate result. The
    <code>State</code> instances can be threaded together using
    <code>flatMap</code> to produce an interpreter for any sequence of
    symbols.</p>
    <p>Start by writing a function <code>evalOne</code> that parses a
    single symbol into an instance of <code>State</code>. Use the code
    below as a template. Don’t worry about error handling for now—if the
    stack is in the wrong configuration, it’s OK to throw an
    exception.</p>
    <div class="sourceCode" id="cb635"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb635-1"><a href="#cb635-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>data<span class="op">.</span><span class="ex">State</span></span>
<span id="cb635-2"><a href="#cb635-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb635-3"><a href="#cb635-3" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> CalcState<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> <span class="ex">State</span><span class="op">[</span><span class="ex">List</span><span class="op">[</span><span class="bu">Int</span><span class="op">],</span> A<span class="op">]</span></span>
<span id="cb635-4"><a href="#cb635-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb635-5"><a href="#cb635-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">evalOne</span><span class="op">(</span>sym<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> CalcState<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span> <span class="op">???</span></span></code></pre></div>
    <p>If this seems difficult, think about the basic form of the
    <code>State</code> instances you’re returning. Each instance
    represents a functional transformation from a stack to a pair of a
    stack and a result. You can ignore any wider context and focus on
    just that one step:</p>
    <div class="sourceCode" id="cb636"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb636-1"><a href="#cb636-1" aria-hidden="true" tabindex="-1"></a><span class="ex">State</span><span class="op">[</span><span class="ex">List</span><span class="op">[</span><span class="bu">Int</span><span class="op">],</span> <span class="bu">Int</span><span class="op">]</span> <span class="op">{</span> oldStack <span class="op">=&gt;</span></span>
<span id="cb636-2"><a href="#cb636-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> newStack <span class="op">=</span> <span class="fu">someTransformation</span><span class="op">(</span>oldStack<span class="op">)</span></span>
<span id="cb636-3"><a href="#cb636-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> result   <span class="op">=</span> someCalculation</span>
<span id="cb636-4"><a href="#cb636-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">(</span>newStack<span class="op">,</span> result<span class="op">)</span></span>
<span id="cb636-5"><a href="#cb636-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Feel free to write your <code>Stack</code> instances in this form
    or as sequences of the convenience constructors we saw above.</p>
    <div class="solution">
    <p>The stack operation required is different for operators and
    operands. For clarity we’ll implement <code>evalOne</code> in terms
    of two helper functions, one for each case:</p>
    <div class="sourceCode" id="cb637"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb637-1"><a href="#cb637-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">evalOne</span><span class="op">(</span>sym<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> CalcState<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb637-2"><a href="#cb637-2" aria-hidden="true" tabindex="-1"></a>  sym <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb637-3"><a href="#cb637-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&quot;+&quot;</span> <span class="op">=&gt;</span> <span class="fu">operator</span><span class="op">(</span>_ <span class="op">+</span> _<span class="op">)</span></span>
<span id="cb637-4"><a href="#cb637-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&quot;-&quot;</span> <span class="op">=&gt;</span> <span class="fu">operator</span><span class="op">(</span>_ <span class="op">-</span> _<span class="op">)</span></span>
<span id="cb637-5"><a href="#cb637-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&quot;*&quot;</span> <span class="op">=&gt;</span> <span class="fu">operator</span><span class="op">(</span>_ <span class="op">*</span> _<span class="op">)</span></span>
<span id="cb637-6"><a href="#cb637-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&quot;/&quot;</span> <span class="op">=&gt;</span> <span class="fu">operator</span><span class="op">(</span>_ <span class="op">/</span> _<span class="op">)</span></span>
<span id="cb637-7"><a href="#cb637-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> num <span class="op">=&gt;</span> <span class="fu">operand</span><span class="op">(</span>num<span class="op">.</span>toInt<span class="op">)</span></span>
<span id="cb637-8"><a href="#cb637-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>Let’s look at <code>operand</code> first. All we have to do is
    push a number onto the stack. We also return the operand as an
    intermediate result:</p>
    <div class="sourceCode" id="cb638"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb638-1"><a href="#cb638-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">operand</span><span class="op">(</span>num<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> CalcState<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb638-2"><a href="#cb638-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">State</span><span class="op">[</span><span class="ex">List</span><span class="op">[</span><span class="bu">Int</span><span class="op">],</span> <span class="bu">Int</span><span class="op">]</span> <span class="op">{</span> stack <span class="op">=&gt;</span></span>
<span id="cb638-3"><a href="#cb638-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span>num <span class="op">::</span> stack<span class="op">,</span> num<span class="op">)</span></span>
<span id="cb638-4"><a href="#cb638-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>The <code>operator</code> function is a little more complex. We
    have to pop two operands off the stack (having the second operand at
    the top of the stack)i and push the result in their place. The code
    can fail if the stack doesn’t have enough operands on it, but the
    exercise description allows us to throw an exception in this
    case:</p>
    <div class="sourceCode" id="cb639"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb639-1"><a href="#cb639-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">operator</span><span class="op">(</span>func<span class="op">:</span> <span class="op">(</span><span class="bu">Int</span><span class="op">,</span> <span class="bu">Int</span><span class="op">)</span> <span class="op">=&gt;</span> <span class="bu">Int</span><span class="op">):</span> CalcState<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb639-2"><a href="#cb639-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">State</span><span class="op">[</span><span class="ex">List</span><span class="op">[</span><span class="bu">Int</span><span class="op">],</span> <span class="bu">Int</span><span class="op">]</span> <span class="op">{</span></span>
<span id="cb639-3"><a href="#cb639-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> b <span class="op">::</span> a <span class="op">::</span> tail <span class="op">=&gt;</span></span>
<span id="cb639-4"><a href="#cb639-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">val</span> ans <span class="op">=</span> <span class="fu">func</span><span class="op">(</span>a<span class="op">,</span> b<span class="op">)</span></span>
<span id="cb639-5"><a href="#cb639-5" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>ans <span class="op">::</span> tail<span class="op">,</span> ans<span class="op">)</span></span>
<span id="cb639-6"><a href="#cb639-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb639-7"><a href="#cb639-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> _ <span class="op">=&gt;</span></span>
<span id="cb639-8"><a href="#cb639-8" aria-hidden="true" tabindex="-1"></a>      sys<span class="op">.</span><span class="fu">error</span><span class="op">(</span><span class="st">&quot;Fail!&quot;</span><span class="op">)</span></span>
<span id="cb639-9"><a href="#cb639-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    </div>
    <p><code>evalOne</code> allows us to evaluate single-symbol
    expressions as follows. We call <code>runA</code> supplying
    <code>Nil</code> as an initial stack, and call <code>value</code> to
    unpack the resulting <code>Eval</code> instance:</p>
    <div class="sourceCode" id="cb640"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb640-1"><a href="#cb640-1" aria-hidden="true" tabindex="-1"></a><span class="fu">evalOne</span><span class="op">(</span><span class="st">&quot;42&quot;</span><span class="op">).</span><span class="fu">runA</span><span class="op">(</span>Nil<span class="op">).</span>value</span>
<span id="cb640-2"><a href="#cb640-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res10: Int = 42</span></span></code></pre></div>
    <p>We can represent more complex programs using
    <code>evalOne</code>, <code>map</code>, and <code>flatMap</code>.
    Note that most of the work is happening on the stack, so we ignore
    the results of the intermediate steps for <code>evalOne(&quot;1&quot;)</code>
    and <code>evalOne(&quot;2&quot;)</code>:</p>
    <div class="sourceCode" id="cb641"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb641-1"><a href="#cb641-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> program <span class="op">=</span> <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb641-2"><a href="#cb641-2" aria-hidden="true" tabindex="-1"></a>  _   <span class="op">&lt;-</span> <span class="fu">evalOne</span><span class="op">(</span><span class="st">&quot;1&quot;</span><span class="op">)</span></span>
<span id="cb641-3"><a href="#cb641-3" aria-hidden="true" tabindex="-1"></a>  _   <span class="op">&lt;-</span> <span class="fu">evalOne</span><span class="op">(</span><span class="st">&quot;2&quot;</span><span class="op">)</span></span>
<span id="cb641-4"><a href="#cb641-4" aria-hidden="true" tabindex="-1"></a>  ans <span class="op">&lt;-</span> <span class="fu">evalOne</span><span class="op">(</span><span class="st">&quot;+&quot;</span><span class="op">)</span></span>
<span id="cb641-5"><a href="#cb641-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">yield</span> ans</span>
<span id="cb641-6"><a href="#cb641-6" aria-hidden="true" tabindex="-1"></a><span class="co">// program: IndexedStateT[[A &gt;: Nothing &lt;: Any] =&gt; Eval[A], List[Int], List[Int], Int] = cats.data.IndexedStateT@70bacbf5</span></span>
<span id="cb641-7"><a href="#cb641-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb641-8"><a href="#cb641-8" aria-hidden="true" tabindex="-1"></a>program<span class="op">.</span><span class="fu">runA</span><span class="op">(</span>Nil<span class="op">).</span>value</span>
<span id="cb641-9"><a href="#cb641-9" aria-hidden="true" tabindex="-1"></a><span class="co">// res11: Int = 3</span></span></code></pre></div>
    <p>Generalise this example by writing an <code>evalAll</code> method
    that computes the result of a <code>List[String]</code>. Use
    <code>evalOne</code> to process each symbol, and thread the
    resulting <code>State</code> monads together using
    <code>flatMap</code>. Your function should have the following
    signature:</p>
    <div class="sourceCode" id="cb642"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb642-1"><a href="#cb642-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">evalAll</span><span class="op">(</span>input<span class="op">:</span> <span class="ex">List</span><span class="op">[</span><span class="ex">String</span><span class="op">]):</span> CalcState<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb642-2"><a href="#cb642-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">???</span></span></code></pre></div>
    <div class="solution">
    <p>We implement <code>evalAll</code> by folding over the input. We
    start with a pure <code>CalcState</code> that returns <code>0</code>
    if the list is empty. We <code>flatMap</code> at each stage,
    ignoring the intermediate results as we saw in the example:</p>
    <div class="sourceCode" id="cb643"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb643-1"><a href="#cb643-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>applicative<span class="op">.</span>_ <span class="co">// for pure</span></span>
<span id="cb643-2"><a href="#cb643-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb643-3"><a href="#cb643-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">evalAll</span><span class="op">(</span>input<span class="op">:</span> <span class="ex">List</span><span class="op">[</span><span class="ex">String</span><span class="op">]):</span> CalcState<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb643-4"><a href="#cb643-4" aria-hidden="true" tabindex="-1"></a>  input<span class="op">.</span><span class="fu">foldLeft</span><span class="op">(</span><span class="fl">0.</span>pure<span class="op">[</span>CalcState<span class="op">])</span> <span class="op">{</span> <span class="op">(</span>a<span class="op">,</span> b<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb643-5"><a href="#cb643-5" aria-hidden="true" tabindex="-1"></a>    a<span class="op">.</span><span class="fu">flatMap</span><span class="op">(</span>_ <span class="op">=&gt;</span> <span class="fu">evalOne</span><span class="op">(</span>b<span class="op">))</span></span>
<span id="cb643-6"><a href="#cb643-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    </div>
    <p>We can use <code>evalAll</code> to conveniently evaluate
    multi-stage expressions:</p>
    <div class="sourceCode" id="cb644"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb644-1"><a href="#cb644-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> multistageProgram <span class="op">=</span> <span class="fu">evalAll</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="st">&quot;1&quot;</span><span class="op">,</span> <span class="st">&quot;2&quot;</span><span class="op">,</span> <span class="st">&quot;+&quot;</span><span class="op">,</span> <span class="st">&quot;3&quot;</span><span class="op">,</span> <span class="st">&quot;*&quot;</span><span class="op">))</span></span>
<span id="cb644-2"><a href="#cb644-2" aria-hidden="true" tabindex="-1"></a><span class="co">// multistageProgram: IndexedStateT[[A &gt;: Nothing &lt;: Any] =&gt; Eval[A], List[Int], List[Int], Int] = cats.data.IndexedStateT@84f3bd7</span></span>
<span id="cb644-3"><a href="#cb644-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb644-4"><a href="#cb644-4" aria-hidden="true" tabindex="-1"></a>multistageProgram<span class="op">.</span><span class="fu">runA</span><span class="op">(</span>Nil<span class="op">).</span>value</span>
<span id="cb644-5"><a href="#cb644-5" aria-hidden="true" tabindex="-1"></a><span class="co">// res13: Int = 9</span></span></code></pre></div>
    <p>Because <code>evalOne</code> and <code>evalAll</code> both return
    instances of <code>State</code>, we can thread these results
    together using <code>flatMap</code>. <code>evalOne</code> produces a
    simple stack transformation and <code>evalAll</code> produces a
    complex one, but they’re both pure functions and we can use them in
    any order as many times as we like:</p>
    <div class="sourceCode" id="cb645"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb645-1"><a href="#cb645-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> biggerProgram <span class="op">=</span> <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb645-2"><a href="#cb645-2" aria-hidden="true" tabindex="-1"></a>  _   <span class="op">&lt;-</span> <span class="fu">evalAll</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="st">&quot;1&quot;</span><span class="op">,</span> <span class="st">&quot;2&quot;</span><span class="op">,</span> <span class="st">&quot;+&quot;</span><span class="op">))</span></span>
<span id="cb645-3"><a href="#cb645-3" aria-hidden="true" tabindex="-1"></a>  _   <span class="op">&lt;-</span> <span class="fu">evalAll</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="st">&quot;3&quot;</span><span class="op">,</span> <span class="st">&quot;4&quot;</span><span class="op">,</span> <span class="st">&quot;+&quot;</span><span class="op">))</span></span>
<span id="cb645-4"><a href="#cb645-4" aria-hidden="true" tabindex="-1"></a>  ans <span class="op">&lt;-</span> <span class="fu">evalOne</span><span class="op">(</span><span class="st">&quot;*&quot;</span><span class="op">)</span></span>
<span id="cb645-5"><a href="#cb645-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">yield</span> ans</span>
<span id="cb645-6"><a href="#cb645-6" aria-hidden="true" tabindex="-1"></a><span class="co">// biggerProgram: IndexedStateT[[A &gt;: Nothing &lt;: Any] =&gt; Eval[A], List[Int], List[Int], Int] = cats.data.IndexedStateT@3fa75ab4</span></span>
<span id="cb645-7"><a href="#cb645-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb645-8"><a href="#cb645-8" aria-hidden="true" tabindex="-1"></a>biggerProgram<span class="op">.</span><span class="fu">runA</span><span class="op">(</span>Nil<span class="op">).</span>value</span>
<span id="cb645-9"><a href="#cb645-9" aria-hidden="true" tabindex="-1"></a><span class="co">// res14: Int = 21</span></span></code></pre></div>
    <p>Complete the exercise by implementing an <code>evalInput</code>
    function that splits an input <code>String</code> into symbols,
    calls <code>evalAll</code>, and runs the result with an initial
    stack.</p>
    <div class="solution">
    <p>We’ve done all the hard work now. All we need to do is split the
    input into terms and call <code>runA</code> and <code>value</code>
    to unpack the result:</p>
    <div class="sourceCode" id="cb646"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb646-1"><a href="#cb646-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">evalInput</span><span class="op">(</span>input<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="bu">Int</span> <span class="op">=</span></span>
<span id="cb646-2"><a href="#cb646-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">evalAll</span><span class="op">(</span>input<span class="op">.</span><span class="fu">split</span><span class="op">(</span><span class="st">&quot; &quot;</span><span class="op">).</span>toList<span class="op">).</span><span class="fu">runA</span><span class="op">(</span>Nil<span class="op">).</span>value</span></code></pre></div>
    <div class="sourceCode" id="cb647"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb647-1"><a href="#cb647-1" aria-hidden="true" tabindex="-1"></a><span class="fu">evalInput</span><span class="op">(</span><span class="st">&quot;1 2 + 3 4 + *&quot;</span><span class="op">)</span></span>
<span id="cb647-2"><a href="#cb647-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res15: Int = 21</span></span></code></pre></div>
    </div>
    <h2 data-number="9.10" id="defining-custom-monads"><span class="header-section-number">9.10</span> Defining Custom
    Monads</h2>
    <p>We can define a <code>Monad</code> for a custom type by providing
    implementations of three methods: <code>flatMap</code>,
    <code>pure</code>, and a method we haven’t seen yet called
    <code>tailRecM</code>. Here is an implementation of
    <code>Monad</code> for <code>Option</code> as an example:</p>
    <div class="sourceCode" id="cb648"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb648-1"><a href="#cb648-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Monad</span>
<span id="cb648-2"><a href="#cb648-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>annotation<span class="op">.</span>tailrec</span>
<span id="cb648-3"><a href="#cb648-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb648-4"><a href="#cb648-4" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> optionMonad <span class="op">=</span> <span class="kw">new</span> Monad<span class="op">[</span><span class="ex">Option</span><span class="op">]</span> <span class="op">{</span></span>
<span id="cb648-5"><a href="#cb648-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> flatMap<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>opt<span class="op">:</span> <span class="ex">Option</span><span class="op">[</span>A<span class="op">])</span></span>
<span id="cb648-6"><a href="#cb648-6" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>fn<span class="op">:</span> A <span class="op">=&gt;</span> <span class="ex">Option</span><span class="op">[</span>B<span class="op">]):</span> <span class="ex">Option</span><span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb648-7"><a href="#cb648-7" aria-hidden="true" tabindex="-1"></a>    opt<span class="op">.</span><span class="fu">flatMap</span><span class="op">(</span>fn<span class="op">)</span></span>
<span id="cb648-8"><a href="#cb648-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb648-9"><a href="#cb648-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> pure<span class="op">[</span>A<span class="op">](</span>opt<span class="op">:</span> A<span class="op">):</span> <span class="ex">Option</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb648-10"><a href="#cb648-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Some</span><span class="op">(</span>opt<span class="op">)</span></span>
<span id="cb648-11"><a href="#cb648-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb648-12"><a href="#cb648-12" aria-hidden="true" tabindex="-1"></a>  @tailrec</span>
<span id="cb648-13"><a href="#cb648-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> tailRecM<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>a<span class="op">:</span> A<span class="op">)(</span>fn<span class="op">:</span> A <span class="op">=&gt;</span> <span class="ex">Option</span><span class="op">[</span>Either<span class="op">[</span>A<span class="op">,</span> B<span class="op">]]):</span> <span class="ex">Option</span><span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb648-14"><a href="#cb648-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fn</span><span class="op">(</span>a<span class="op">)</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb648-15"><a href="#cb648-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="bu">None</span>           <span class="op">=&gt;</span> <span class="bu">None</span></span>
<span id="cb648-16"><a href="#cb648-16" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="bu">Some</span><span class="op">(</span><span class="fu">Left</span><span class="op">(</span>a1<span class="op">))</span> <span class="op">=&gt;</span> <span class="fu">tailRecM</span><span class="op">(</span>a1<span class="op">)(</span>fn<span class="op">)</span></span>
<span id="cb648-17"><a href="#cb648-17" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="bu">Some</span><span class="op">(</span><span class="fu">Right</span><span class="op">(</span>b<span class="op">))</span> <span class="op">=&gt;</span> <span class="bu">Some</span><span class="op">(</span>b<span class="op">)</span></span>
<span id="cb648-18"><a href="#cb648-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb648-19"><a href="#cb648-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb648-20"><a href="#cb648-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>The <code>tailRecM</code> method is an optimisation used in Cats
    to limit the amount of stack space consumed by nested calls to
    <code>flatMap</code>. The technique comes from a <a href="http://functorial.com/stack-safety-for-free/index.pdf">2015
    paper</a> by PureScript creator Phil Freeman. The method should
    recursively call itself until the result of <code>fn</code> returns
    a <code>Right</code>.</p>
    <p>To motivate its use let’s use the following example: Suppose we
    want to write a method that calls a function until the function
    indicates it should stop. The function will return a monad instance
    because, as we know, monads represent sequencing and many monads
    have some notion of stopping.</p>
    <p>We can write this method in terms of <code>flatMap</code>.</p>
    <div class="sourceCode" id="cb649"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb649-1"><a href="#cb649-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>flatMap<span class="op">.</span>_ <span class="co">// For flatMap</span></span>
<span id="cb649-2"><a href="#cb649-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb649-3"><a href="#cb649-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> retry<span class="op">[</span>F<span class="op">[</span>_<span class="op">]:</span> Monad<span class="op">,</span> A<span class="op">](</span>start<span class="op">:</span> A<span class="op">)(</span>f<span class="op">:</span> A <span class="op">=&gt;</span> F<span class="op">[</span>A<span class="op">]):</span> F<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb649-4"><a href="#cb649-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">f</span><span class="op">(</span>start<span class="op">).</span>flatMap<span class="op">{</span> a <span class="op">=&gt;</span></span>
<span id="cb649-5"><a href="#cb649-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">retry</span><span class="op">(</span>a<span class="op">)(</span>f<span class="op">)</span></span>
<span id="cb649-6"><a href="#cb649-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>Unfortunately it is not stack-safe. It works for small input.</p>
    <div class="sourceCode" id="cb650"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb650-1"><a href="#cb650-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>option<span class="op">.</span>_</span>
<span id="cb650-2"><a href="#cb650-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb650-3"><a href="#cb650-3" aria-hidden="true" tabindex="-1"></a><span class="fu">retry</span><span class="op">(</span><span class="dv">100</span><span class="op">)(</span>a <span class="op">=&gt;</span> <span class="cf">if</span><span class="op">(</span>a <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="bu">None</span> <span class="cf">else</span> <span class="bu">Some</span><span class="op">(</span>a <span class="op">-</span> <span class="dv">1</span><span class="op">))</span></span>
<span id="cb650-4"><a href="#cb650-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: Option[Int] = None</span></span></code></pre></div>
    <p>but if we try large input we get a
    <code>StackOverflowError</code>.</p>
    <div class="sourceCode" id="cb651"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb651-1"><a href="#cb651-1" aria-hidden="true" tabindex="-1"></a><span class="fu">retry</span><span class="op">(</span><span class="dv">100000</span><span class="op">)(</span>a <span class="op">=&gt;</span> <span class="cf">if</span><span class="op">(</span>a <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="bu">None</span> <span class="cf">else</span> <span class="bu">Some</span><span class="op">(</span>a <span class="op">-</span> <span class="dv">1</span><span class="op">))</span></span>
<span id="cb651-2"><a href="#cb651-2" aria-hidden="true" tabindex="-1"></a><span class="co">// KABLOOIE!!!!</span></span></code></pre></div>
    <p>We can instead rewrite this method using
    <code>tailRecM</code>.</p>
    <div class="sourceCode" id="cb652"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb652-1"><a href="#cb652-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>functor<span class="op">.</span>_ <span class="co">// for map</span></span>
<span id="cb652-2"><a href="#cb652-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb652-3"><a href="#cb652-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> retryTailRecM<span class="op">[</span>F<span class="op">[</span>_<span class="op">]:</span> Monad<span class="op">,</span> A<span class="op">](</span>start<span class="op">:</span> A<span class="op">)(</span>f<span class="op">:</span> A <span class="op">=&gt;</span> F<span class="op">[</span>A<span class="op">]):</span> F<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb652-4"><a href="#cb652-4" aria-hidden="true" tabindex="-1"></a>  Monad<span class="op">[</span>F<span class="op">].</span><span class="fu">tailRecM</span><span class="op">(</span>start<span class="op">){</span> a <span class="op">=&gt;</span></span>
<span id="cb652-5"><a href="#cb652-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">f</span><span class="op">(</span>a<span class="op">).</span><span class="fu">map</span><span class="op">(</span>a2 <span class="op">=&gt;</span> <span class="fu">Left</span><span class="op">(</span>a2<span class="op">))</span></span>
<span id="cb652-6"><a href="#cb652-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>Now it runs successfully no matter how many time we recurse.</p>
    <div class="sourceCode" id="cb653"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb653-1"><a href="#cb653-1" aria-hidden="true" tabindex="-1"></a><span class="fu">retryTailRecM</span><span class="op">(</span><span class="dv">100000</span><span class="op">)(</span>a <span class="op">=&gt;</span> <span class="cf">if</span><span class="op">(</span>a <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="bu">None</span> <span class="cf">else</span> <span class="bu">Some</span><span class="op">(</span>a <span class="op">-</span> <span class="dv">1</span><span class="op">))</span></span>
<span id="cb653-2"><a href="#cb653-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: Option[Int] = None</span></span></code></pre></div>
    <p>It’s important to note that we have to explicitly call
    <code>tailRecM</code>. There isn’t a code transformation that will
    convert non-tail recursive code into tail recursive code that uses
    <code>tailRecM</code>. However there are several utilities provided
    by the <code>Monad</code> type class that makes these kinds of
    methods easier to write. For example, we can rewrite
    <code>retry</code> in terms of <code>iterateWhileM</code> and we
    don’t have to explicitly call <code>tailRecM</code>.</p>
    <div class="sourceCode" id="cb654"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb654-1"><a href="#cb654-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>monad<span class="op">.</span>_ <span class="co">// for iterateWhileM</span></span>
<span id="cb654-2"><a href="#cb654-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb654-3"><a href="#cb654-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> retryM<span class="op">[</span>F<span class="op">[</span>_<span class="op">]:</span> Monad<span class="op">,</span> A<span class="op">](</span>start<span class="op">:</span> A<span class="op">)(</span>f<span class="op">:</span> A <span class="op">=&gt;</span> F<span class="op">[</span>A<span class="op">]):</span> F<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb654-4"><a href="#cb654-4" aria-hidden="true" tabindex="-1"></a>  start<span class="op">.</span><span class="fu">iterateWhileM</span><span class="op">(</span>f<span class="op">)(</span>a <span class="op">=&gt;</span> <span class="kw">true</span><span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb655"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb655-1"><a href="#cb655-1" aria-hidden="true" tabindex="-1"></a><span class="fu">retryM</span><span class="op">(</span><span class="dv">100000</span><span class="op">)(</span>a <span class="op">=&gt;</span> <span class="cf">if</span><span class="op">(</span>a <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="bu">None</span> <span class="cf">else</span> <span class="bu">Some</span><span class="op">(</span>a <span class="op">-</span> <span class="dv">1</span><span class="op">))</span></span>
<span id="cb655-2"><a href="#cb655-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: Option[Int] = None</span></span></code></pre></div>
    <p>We’ll see more methods that use <code>tailRecM</code> in Section
    12.1.</p>
    <p>All of the built-in monads in Cats have tail-recursive
    implementations of <code>tailRecM</code>, although writing one for
    custom monads can be a challenge… as we shall see.</p>
    <h3 data-number="9.10.1" id="exercise-branching-out-further-with-monads"><span class="header-section-number">9.10.1</span> Exercise: Branching out
    Further with Monads</h3>
    <p>Let’s write a <code>Monad</code> for our <code>Tree</code> data
    type from last chapter. Here’s the type again:</p>
    <div class="sourceCode" id="cb656"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb656-1"><a href="#cb656-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> Tree<span class="op">[+</span>A<span class="op">]</span></span>
<span id="cb656-2"><a href="#cb656-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb656-3"><a href="#cb656-3" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> Branch<span class="op">[</span>A<span class="op">](</span>left<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">],</span> right<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb656-4"><a href="#cb656-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">extends</span> Tree<span class="op">[</span>A<span class="op">]</span></span>
<span id="cb656-5"><a href="#cb656-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb656-6"><a href="#cb656-6" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> Leaf<span class="op">[</span>A<span class="op">](</span>value<span class="op">:</span> A<span class="op">)</span> <span class="kw">extends</span> Tree<span class="op">[</span>A<span class="op">]</span></span>
<span id="cb656-7"><a href="#cb656-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb656-8"><a href="#cb656-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> branch<span class="op">[</span>A<span class="op">](</span>left<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">],</span> right<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">]):</span> Tree<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb656-9"><a href="#cb656-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Branch</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span></span>
<span id="cb656-10"><a href="#cb656-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb656-11"><a href="#cb656-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> leaf<span class="op">[</span>A<span class="op">](</span>value<span class="op">:</span> A<span class="op">):</span> Tree<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb656-12"><a href="#cb656-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">)</span></span></code></pre></div>
    <p>Verify that the code works on instances of <code>Branch</code>
    and <code>Leaf</code>, and that the <code>Monad</code> provides
    <code>Functor</code>-like behaviour for free.</p>
    <p>Also verify that having a <code>Monad</code> in scope allows us
    to use for comprehensions, despite the fact that we haven’t directly
    implemented <code>flatMap</code> or <code>map</code> on
    <code>Tree</code>.</p>
    <p>Don’t feel you have to make <code>tailRecM</code> tail-recursive.
    Doing so is quite difficult. We’ve included both tail-recursive and
    non-tail-recursive implementations in the solutions so you can check
    your work.</p>
    <div class="solution">
    <p>The code for <code>flatMap</code> is similar to the code for
    <code>map</code>. Again, we recurse down the structure and use the
    results from <code>func</code> to build a new <code>Tree</code>.</p>
    <p>The code for <code>tailRecM</code> is fairly complex regardless
    of whether we make it tail-recursive or not.</p>
    <p>If we follow the types, the non-tail-recursive solution falls
    out:</p>
    <div class="sourceCode" id="cb657"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb657-1"><a href="#cb657-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Monad</span>
<span id="cb657-2"><a href="#cb657-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb657-3"><a href="#cb657-3" aria-hidden="true" tabindex="-1"></a><span class="kw">implicit</span> <span class="kw">val</span> treeMonad<span class="op">:</span> Monad<span class="op">[</span>Tree<span class="op">]</span> <span class="op">=</span> <span class="kw">new</span> Monad<span class="op">[</span>Tree<span class="op">]</span> <span class="op">{</span></span>
<span id="cb657-4"><a href="#cb657-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> pure<span class="op">[</span>A<span class="op">](</span>value<span class="op">:</span> A<span class="op">):</span> Tree<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb657-5"><a href="#cb657-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">)</span></span>
<span id="cb657-6"><a href="#cb657-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb657-7"><a href="#cb657-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> flatMap<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>tree<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb657-8"><a href="#cb657-8" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> Tree<span class="op">[</span>B<span class="op">]):</span> Tree<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb657-9"><a href="#cb657-9" aria-hidden="true" tabindex="-1"></a>    tree <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb657-10"><a href="#cb657-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Branch</span><span class="op">(</span>l<span class="op">,</span> r<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb657-11"><a href="#cb657-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">Branch</span><span class="op">(</span><span class="fu">flatMap</span><span class="op">(</span>l<span class="op">)(</span>func<span class="op">),</span> <span class="fu">flatMap</span><span class="op">(</span>r<span class="op">)(</span>func<span class="op">))</span></span>
<span id="cb657-12"><a href="#cb657-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">)</span>  <span class="op">=&gt;</span></span>
<span id="cb657-13"><a href="#cb657-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">func</span><span class="op">(</span>value<span class="op">)</span></span>
<span id="cb657-14"><a href="#cb657-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb657-15"><a href="#cb657-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb657-16"><a href="#cb657-16" aria-hidden="true" tabindex="-1"></a> <span class="kw">def</span> tailRecM<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>a<span class="op">:</span> A<span class="op">)(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> Tree<span class="op">[</span>Either<span class="op">[</span>A<span class="op">,</span> B<span class="op">]]):</span> Tree<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb657-17"><a href="#cb657-17" aria-hidden="true" tabindex="-1"></a>   <span class="fu">flatMap</span><span class="op">(</span><span class="fu">func</span><span class="op">(</span>a<span class="op">))</span> <span class="op">{</span></span>
<span id="cb657-18"><a href="#cb657-18" aria-hidden="true" tabindex="-1"></a>     <span class="cf">case</span> <span class="fu">Left</span><span class="op">(</span>value<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb657-19"><a href="#cb657-19" aria-hidden="true" tabindex="-1"></a>       <span class="fu">tailRecM</span><span class="op">(</span>value<span class="op">)(</span>func<span class="op">)</span></span>
<span id="cb657-20"><a href="#cb657-20" aria-hidden="true" tabindex="-1"></a>     <span class="cf">case</span> <span class="fu">Right</span><span class="op">(</span>value<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb657-21"><a href="#cb657-21" aria-hidden="true" tabindex="-1"></a>       <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">)</span></span>
<span id="cb657-22"><a href="#cb657-22" aria-hidden="true" tabindex="-1"></a>   <span class="op">}</span></span>
<span id="cb657-23"><a href="#cb657-23" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb657-24"><a href="#cb657-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>The solution above is perfectly fine for this exercise. Its only
    downside is that Cats cannot make guarantees about stack safety.</p>
    <p>The tail-recursive solution is much harder to write. We adapted
    this solution from <a href="https://stackoverflow.com/questions/44504790/cats-non-tail-recursive-tailrecm-method-for-monads">this
    Stack Overflow post</a> by Nazarii Bardiuk. It involves an explicit
    depth first traversal of the tree, maintaining an <code>open</code>
    list of nodes to visit and a <code>closed</code> list of nodes to
    use to reconstruct the tree:</p>
    <div class="sourceCode" id="cb658"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb658-1"><a href="#cb658-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Monad</span>
<span id="cb658-2"><a href="#cb658-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>annotation<span class="op">.</span>tailrec</span>
<span id="cb658-3"><a href="#cb658-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb658-4"><a href="#cb658-4" aria-hidden="true" tabindex="-1"></a><span class="kw">implicit</span> <span class="kw">val</span> treeMonad<span class="op">:</span> Monad<span class="op">[</span>Tree<span class="op">]</span> <span class="op">=</span> <span class="kw">new</span> Monad<span class="op">[</span>Tree<span class="op">]</span> <span class="op">{</span></span>
<span id="cb658-5"><a href="#cb658-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> pure<span class="op">[</span>A<span class="op">](</span>value<span class="op">:</span> A<span class="op">):</span> Tree<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb658-6"><a href="#cb658-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">)</span></span>
<span id="cb658-7"><a href="#cb658-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb658-8"><a href="#cb658-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> flatMap<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>tree<span class="op">:</span> Tree<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb658-9"><a href="#cb658-9" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> Tree<span class="op">[</span>B<span class="op">]):</span> Tree<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb658-10"><a href="#cb658-10" aria-hidden="true" tabindex="-1"></a>    tree <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb658-11"><a href="#cb658-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Branch</span><span class="op">(</span>l<span class="op">,</span> r<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb658-12"><a href="#cb658-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">Branch</span><span class="op">(</span><span class="fu">flatMap</span><span class="op">(</span>l<span class="op">)(</span>func<span class="op">),</span> <span class="fu">flatMap</span><span class="op">(</span>r<span class="op">)(</span>func<span class="op">))</span></span>
<span id="cb658-13"><a href="#cb658-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span>value<span class="op">)</span>  <span class="op">=&gt;</span></span>
<span id="cb658-14"><a href="#cb658-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">func</span><span class="op">(</span>value<span class="op">)</span></span>
<span id="cb658-15"><a href="#cb658-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb658-16"><a href="#cb658-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb658-17"><a href="#cb658-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> tailRecM<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>arg<span class="op">:</span> A<span class="op">)</span></span>
<span id="cb658-18"><a href="#cb658-18" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> Tree<span class="op">[</span>Either<span class="op">[</span>A<span class="op">,</span> B<span class="op">]]):</span> Tree<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb658-19"><a href="#cb658-19" aria-hidden="true" tabindex="-1"></a>    @tailrec</span>
<span id="cb658-20"><a href="#cb658-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">loop</span><span class="op">(</span></span>
<span id="cb658-21"><a href="#cb658-21" aria-hidden="true" tabindex="-1"></a>          open<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>Tree<span class="op">[</span>Either<span class="op">[</span>A<span class="op">,</span> B<span class="op">]]],</span></span>
<span id="cb658-22"><a href="#cb658-22" aria-hidden="true" tabindex="-1"></a>          closed<span class="op">:</span> <span class="ex">List</span><span class="op">[</span><span class="ex">Option</span><span class="op">[</span>Tree<span class="op">[</span>B<span class="op">]]]):</span> <span class="ex">List</span><span class="op">[</span>Tree<span class="op">[</span>B<span class="op">]]</span> <span class="op">=</span></span>
<span id="cb658-23"><a href="#cb658-23" aria-hidden="true" tabindex="-1"></a>      open <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb658-24"><a href="#cb658-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">Branch</span><span class="op">(</span>l<span class="op">,</span> r<span class="op">)</span> <span class="op">::</span> next <span class="op">=&gt;</span></span>
<span id="cb658-25"><a href="#cb658-25" aria-hidden="true" tabindex="-1"></a>          <span class="fu">loop</span><span class="op">(</span>l <span class="op">::</span> r <span class="op">::</span> next<span class="op">,</span> <span class="bu">None</span> <span class="op">::</span> closed<span class="op">)</span></span>
<span id="cb658-26"><a href="#cb658-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb658-27"><a href="#cb658-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span><span class="fu">Left</span><span class="op">(</span>value<span class="op">))</span> <span class="op">::</span> next <span class="op">=&gt;</span></span>
<span id="cb658-28"><a href="#cb658-28" aria-hidden="true" tabindex="-1"></a>          <span class="fu">loop</span><span class="op">(</span><span class="fu">func</span><span class="op">(</span>value<span class="op">)</span> <span class="op">::</span> next<span class="op">,</span> closed<span class="op">)</span></span>
<span id="cb658-29"><a href="#cb658-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb658-30"><a href="#cb658-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">Leaf</span><span class="op">(</span><span class="fu">Right</span><span class="op">(</span>value<span class="op">))</span> <span class="op">::</span> next <span class="op">=&gt;</span></span>
<span id="cb658-31"><a href="#cb658-31" aria-hidden="true" tabindex="-1"></a>          <span class="fu">loop</span><span class="op">(</span>next<span class="op">,</span> <span class="bu">Some</span><span class="op">(</span><span class="fu">pure</span><span class="op">(</span>value<span class="op">))</span> <span class="op">::</span> closed<span class="op">)</span></span>
<span id="cb658-32"><a href="#cb658-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb658-33"><a href="#cb658-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> Nil <span class="op">=&gt;</span></span>
<span id="cb658-34"><a href="#cb658-34" aria-hidden="true" tabindex="-1"></a>          closed<span class="op">.</span><span class="fu">foldLeft</span><span class="op">(</span>Nil<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>Tree<span class="op">[</span>B<span class="op">]])</span> <span class="op">{</span> <span class="op">(</span>acc<span class="op">,</span> maybeTree<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb658-35"><a href="#cb658-35" aria-hidden="true" tabindex="-1"></a>            maybeTree<span class="op">.</span><span class="fu">map</span><span class="op">(</span>_ <span class="op">::</span> acc<span class="op">).</span>getOrElse <span class="op">{</span></span>
<span id="cb658-36"><a href="#cb658-36" aria-hidden="true" tabindex="-1"></a>              acc <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb658-37"><a href="#cb658-37" aria-hidden="true" tabindex="-1"></a>                <span class="cf">case</span> left <span class="op">::</span> right <span class="op">::</span> tail <span class="op">=&gt;</span> <span class="fu">branch</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">::</span> tail</span>
<span id="cb658-38"><a href="#cb658-38" aria-hidden="true" tabindex="-1"></a>              <span class="op">}</span></span>
<span id="cb658-39"><a href="#cb658-39" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb658-40"><a href="#cb658-40" aria-hidden="true" tabindex="-1"></a>          <span class="op">}</span></span>
<span id="cb658-41"><a href="#cb658-41" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb658-42"><a href="#cb658-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb658-43"><a href="#cb658-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">loop</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="fu">func</span><span class="op">(</span>arg<span class="op">)),</span> Nil<span class="op">).</span>head</span>
<span id="cb658-44"><a href="#cb658-44" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb658-45"><a href="#cb658-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Regardless of which version of <code>tailRecM</code> we define,
    we can use our <code>Monad</code> to <code>flatMap</code> and
    <code>map</code> on <code>Trees</code>:</p>
    <div class="sourceCode" id="cb659"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb659-1"><a href="#cb659-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>functor<span class="op">.</span>_ <span class="co">// for map</span></span>
<span id="cb659-2"><a href="#cb659-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>flatMap<span class="op">.</span>_ <span class="co">// for flatMap</span></span></code></pre></div>
    <div class="sourceCode" id="cb660"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb660-1"><a href="#cb660-1" aria-hidden="true" tabindex="-1"></a><span class="fu">branch</span><span class="op">(</span><span class="fu">leaf</span><span class="op">(</span><span class="dv">100</span><span class="op">),</span> <span class="fu">leaf</span><span class="op">(</span><span class="dv">200</span><span class="op">)).</span></span>
<span id="cb660-2"><a href="#cb660-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">flatMap</span><span class="op">(</span>x <span class="op">=&gt;</span> <span class="fu">branch</span><span class="op">(</span><span class="fu">leaf</span><span class="op">(</span>x <span class="op">-</span> <span class="dv">1</span><span class="op">),</span> <span class="fu">leaf</span><span class="op">(</span>x <span class="op">+</span> <span class="dv">1</span><span class="op">)))</span></span>
<span id="cb660-3"><a href="#cb660-3" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: Tree[Int] = Branch(</span></span>
<span id="cb660-4"><a href="#cb660-4" aria-hidden="true" tabindex="-1"></a><span class="co">//   left = Branch(left = Leaf(value = 99), right = Leaf(value = 101)),</span></span>
<span id="cb660-5"><a href="#cb660-5" aria-hidden="true" tabindex="-1"></a><span class="co">//   right = Branch(left = Leaf(value = 199), right = Leaf(value = 201))</span></span>
<span id="cb660-6"><a href="#cb660-6" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>We can also transform <code>Trees</code> using for
    comprehensions:</p>
    <div class="sourceCode" id="cb661"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb661-1"><a href="#cb661-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">{</span></span>
<span id="cb661-2"><a href="#cb661-2" aria-hidden="true" tabindex="-1"></a>  a <span class="op">&lt;-</span> <span class="fu">branch</span><span class="op">(</span><span class="fu">leaf</span><span class="op">(</span><span class="dv">100</span><span class="op">),</span> <span class="fu">leaf</span><span class="op">(</span><span class="dv">200</span><span class="op">))</span></span>
<span id="cb661-3"><a href="#cb661-3" aria-hidden="true" tabindex="-1"></a>  b <span class="op">&lt;-</span> <span class="fu">branch</span><span class="op">(</span><span class="fu">leaf</span><span class="op">(</span>a <span class="op">-</span> <span class="dv">10</span><span class="op">),</span> <span class="fu">leaf</span><span class="op">(</span>a <span class="op">+</span> <span class="dv">10</span><span class="op">))</span></span>
<span id="cb661-4"><a href="#cb661-4" aria-hidden="true" tabindex="-1"></a>  c <span class="op">&lt;-</span> <span class="fu">branch</span><span class="op">(</span><span class="fu">leaf</span><span class="op">(</span>b <span class="op">-</span> <span class="dv">1</span><span class="op">),</span> <span class="fu">leaf</span><span class="op">(</span>b <span class="op">+</span> <span class="dv">1</span><span class="op">))</span></span>
<span id="cb661-5"><a href="#cb661-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">yield</span> c</span>
<span id="cb661-6"><a href="#cb661-6" aria-hidden="true" tabindex="-1"></a><span class="co">// res6: Tree[Int] = Branch(</span></span>
<span id="cb661-7"><a href="#cb661-7" aria-hidden="true" tabindex="-1"></a><span class="co">//   left = Branch(</span></span>
<span id="cb661-8"><a href="#cb661-8" aria-hidden="true" tabindex="-1"></a><span class="co">//     left = Branch(left = Leaf(value = 89), right = Leaf(value = 91)),</span></span>
<span id="cb661-9"><a href="#cb661-9" aria-hidden="true" tabindex="-1"></a><span class="co">//     right = Branch(left = Leaf(value = 109), right = Leaf(value = 111))</span></span>
<span id="cb661-10"><a href="#cb661-10" aria-hidden="true" tabindex="-1"></a><span class="co">//   ),</span></span>
<span id="cb661-11"><a href="#cb661-11" aria-hidden="true" tabindex="-1"></a><span class="co">//   right = Branch(</span></span>
<span id="cb661-12"><a href="#cb661-12" aria-hidden="true" tabindex="-1"></a><span class="co">//     left = Branch(left = Leaf(value = 189), right = Leaf(value = 191)),</span></span>
<span id="cb661-13"><a href="#cb661-13" aria-hidden="true" tabindex="-1"></a><span class="co">//     right = Branch(left = Leaf(value = 209), right = Leaf(value = 211))</span></span>
<span id="cb661-14"><a href="#cb661-14" aria-hidden="true" tabindex="-1"></a><span class="co">//   )</span></span>
<span id="cb661-15"><a href="#cb661-15" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>The monad for <code>Option</code> provides fail-fast semantics.
    The monad for <code>List</code> provides concatenation semantics.
    What are the semantics of <code>flatMap</code> for a binary tree?
    Every node in the tree has the potential to be replaced with a whole
    subtree, producing a kind of “growing” or “feathering” behaviour,
    reminiscent of list concatenation along two axes.</p>
    </div>
    <h2 data-number="9.11" id="summary-2"><span class="header-section-number">9.11</span> Summary</h2>
    <p>In this chapter we’ve seen monads up-close. We saw that
    <code>flatMap</code> can be viewed as an operator for sequencing
    computations, dictating the order in which operations must happen.
    From this viewpoint, <code>Option</code> represents a computation
    that can fail without an error message, <code>Either</code>
    represents computations that can fail with a message,
    <code>List</code> represents multiple possible results, and
    <code>Future</code> represents a computation that may produce a
    value at some point in the future.</p>
    <p>We’ve also seen some of the custom types and data structures that
    Cats provides, including <code>Id</code>, <code>Reader</code>,
    <code>Writer</code>, and <code>State</code>. These cover a wide
    range of use cases.</p>
    <p>Finally, in the unlikely event that we have to implement a custom
    monad, we’ve learned about defining our own instance using
    <code>tailRecM</code>. <code>tailRecM</code> is an odd wrinkle that
    is a concession to building a functional programming library that is
    stack-safe by default. We don’t need to understand
    <code>tailRecM</code> to understand monads, but having it around
    gives us benefits of which we can be grateful when writing monadic
    code.</p>
    <h1 data-number="10" id="sec:monad-transformers"><span class="header-section-number">10</span> Monad Transformers</h1>
    <p>Monads are <a href="http://blog.plover.com/prog/burritos.html">like burritos</a>,
    which means that once you acquire a taste, you’ll find yourself
    returning to them again and again. This is not without issues. As
    burritos can bloat the waist, monads can bloat the code base through
    nested for-comprehensions.</p>
    <p>Imagine we are interacting with a database. We want to look up a
    user record. The user may or may not be present, so we return an
    <code>Option[User]</code>. Our communication with the database could
    fail for many reasons (network issues, authentication problems, and
    so on), so this result is wrapped up in an <code>Either</code>,
    giving us a final result of
    <code>Either[Error, Option[User]]</code>.</p>
    <p>To use this value we must nest <code>flatMap</code> calls (or
    equivalently, for-comprehensions):</p>
    <div class="sourceCode" id="cb662"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb662-1"><a href="#cb662-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">lookupUserName</span><span class="op">(</span>id<span class="op">:</span> <span class="ex">Long</span><span class="op">):</span> Either<span class="op">[</span><span class="ex">Error</span><span class="op">,</span> <span class="ex">Option</span><span class="op">[</span><span class="ex">String</span><span class="op">]]</span> <span class="op">=</span></span>
<span id="cb662-2"><a href="#cb662-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb662-3"><a href="#cb662-3" aria-hidden="true" tabindex="-1"></a>    optUser <span class="op">&lt;-</span> <span class="fu">lookupUser</span><span class="op">(</span>id<span class="op">)</span></span>
<span id="cb662-4"><a href="#cb662-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">yield</span> <span class="op">{</span></span>
<span id="cb662-5"><a href="#cb662-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">{</span> user <span class="op">&lt;-</span> optUser <span class="op">}</span> <span class="cf">yield</span> user<span class="op">.</span>name</span>
<span id="cb662-6"><a href="#cb662-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>This quickly becomes very tedious.</p>
    <h2 data-number="10.1" id="exercise-composing-monads"><span class="header-section-number">10.1</span> Exercise: Composing
    Monads</h2>
    <p>A question arises. Given two arbitrary monads, can we combine
    them in some way to make a single monad? That is, do monads
    <em>compose</em>? We can try to write the code but we soon hit
    problems:</p>
    <div class="sourceCode" id="cb663"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb663-1"><a href="#cb663-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>applicative<span class="op">.</span>_ <span class="co">// for pure</span></span></code></pre></div>
    <div class="sourceCode" id="cb664"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb664-1"><a href="#cb664-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Hypothetical example. This won&#39;t actually compile:</span></span>
<span id="cb664-2"><a href="#cb664-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compose<span class="op">[</span>M1<span class="op">[</span>_<span class="op">]:</span> Monad<span class="op">,</span> M2<span class="op">[</span>_<span class="op">]:</span> Monad<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb664-3"><a href="#cb664-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">type</span> Composed<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> M1<span class="op">[</span>M2<span class="op">[</span>A<span class="op">]]</span></span>
<span id="cb664-4"><a href="#cb664-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb664-5"><a href="#cb664-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> Monad<span class="op">[</span>Composed<span class="op">]</span> <span class="op">{</span></span>
<span id="cb664-6"><a href="#cb664-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> pure<span class="op">[</span>A<span class="op">](</span>a<span class="op">:</span> A<span class="op">):</span> Composed<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb664-7"><a href="#cb664-7" aria-hidden="true" tabindex="-1"></a>      a<span class="op">.</span>pure<span class="op">[</span>M2<span class="op">].</span>pure<span class="op">[</span>M1<span class="op">]</span></span>
<span id="cb664-8"><a href="#cb664-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb664-9"><a href="#cb664-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> flatMap<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>fa<span class="op">:</span> Composed<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb664-10"><a href="#cb664-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span>f<span class="op">:</span> A <span class="op">=&gt;</span> Composed<span class="op">[</span>B<span class="op">]):</span> Composed<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb664-11"><a href="#cb664-11" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Problem! How do we write flatMap?</span></span>
<span id="cb664-12"><a href="#cb664-12" aria-hidden="true" tabindex="-1"></a>      <span class="op">???</span></span>
<span id="cb664-13"><a href="#cb664-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb664-14"><a href="#cb664-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>It is impossible to write a general definition of
    <code>flatMap</code> without knowing something about <code>M1</code>
    or <code>M2</code>. However, if we <em>do</em> know something about
    one or other monad, we can typically complete this code. For
    example, if we fix <code>M2</code> above to be <code>Option</code>,
    a definition of <code>flatMap</code> comes to light:</p>
    <div class="sourceCode" id="cb665"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb665-1"><a href="#cb665-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> flatMap<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>fa<span class="op">:</span> Composed<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb665-2"><a href="#cb665-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span>f<span class="op">:</span> A <span class="op">=&gt;</span> Composed<span class="op">[</span>B<span class="op">]):</span> Composed<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb665-3"><a href="#cb665-3" aria-hidden="true" tabindex="-1"></a>  fa<span class="op">.</span><span class="fu">flatMap</span><span class="op">(</span>_<span class="op">.</span>fold<span class="op">[</span>Composed<span class="op">[</span>B<span class="op">]](</span><span class="bu">None</span><span class="op">.</span>pure<span class="op">[</span>M1<span class="op">])(</span>f<span class="op">))</span></span></code></pre></div>
    <p>Notice that the definition above makes use of
    <code>None</code>—an <code>Option</code>-specific concept that
    doesn’t appear in the general <code>Monad</code> interface. We need
    this extra detail to combine <code>Option</code> with other monads.
    Similarly, there are things about other monads that help us write
    composed <code>flatMap</code> methods for them. This is the idea
    behind monad transformers: Cats defines transformers for a variety
    of monads, each providing the extra knowledge we need to compose
    that monad with others. Let’s look at some examples.</p>
    <h2 data-number="10.2" id="a-transformative-example"><span class="header-section-number">10.2</span> A Transformative
    Example</h2>
    <p>Cats provides transformers for many monads, each named with a
    <code>T</code> suffix: <code>EitherT</code> composes
    <code>Either</code> with other monads, <code>OptionT</code> composes
    <code>Option</code>, and so on.</p>
    <p>Here’s an example that uses <code>OptionT</code> to compose
    <code>List</code> and <code>Option</code>. We can use
    <code>OptionT[List, A]</code>, aliased to <code>ListOption[A]</code>
    for convenience, to transform a <code>List[Option[A]]</code> into a
    single monad:</p>
    <div class="sourceCode" id="cb666"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb666-1"><a href="#cb666-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>data<span class="op">.</span>OptionT</span>
<span id="cb666-2"><a href="#cb666-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb666-3"><a href="#cb666-3" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> ListOption<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> OptionT<span class="op">[</span><span class="ex">List</span><span class="op">,</span> A<span class="op">]</span></span></code></pre></div>
    <p>Note how we build <code>ListOption</code> from the inside out: we
    pass <code>List</code>, the type of the outer monad, as a parameter
    to <code>OptionT</code>, the transformer for the inner monad.</p>
    <p>We can create instances of <code>ListOption</code> using the
    <code>OptionT</code> constructor, or more conveniently using
    <code>pure</code>:</p>
    <div class="sourceCode" id="cb667"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb667-1"><a href="#cb667-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>list<span class="op">.</span>_     <span class="co">// for Monad</span></span>
<span id="cb667-2"><a href="#cb667-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>applicative<span class="op">.</span>_ <span class="co">// for pure</span></span></code></pre></div>
    <div class="sourceCode" id="cb668"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb668-1"><a href="#cb668-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> result1<span class="op">:</span> ListOption<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span> <span class="fu">OptionT</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="ex">Option</span><span class="op">(</span><span class="dv">10</span><span class="op">)))</span></span>
<span id="cb668-2"><a href="#cb668-2" aria-hidden="true" tabindex="-1"></a><span class="co">// result1: OptionT[List, Int] = OptionT(value = List(Some(value = 10)))</span></span>
<span id="cb668-3"><a href="#cb668-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb668-4"><a href="#cb668-4" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> result2<span class="op">:</span> ListOption<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span> <span class="fl">32.</span>pure<span class="op">[</span>ListOption<span class="op">]</span></span>
<span id="cb668-5"><a href="#cb668-5" aria-hidden="true" tabindex="-1"></a><span class="co">// result2: OptionT[List, Int] = OptionT(value = List(Some(value = 32)))</span></span></code></pre></div>
    <p>The <code>map</code> and <code>flatMap</code> methods combine the
    corresponding methods of <code>List</code> and <code>Option</code>
    into single operations:</p>
    <div class="sourceCode" id="cb669"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb669-1"><a href="#cb669-1" aria-hidden="true" tabindex="-1"></a>result1<span class="op">.</span>flatMap <span class="op">{</span> <span class="op">(</span>x<span class="op">:</span> <span class="bu">Int</span><span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb669-2"><a href="#cb669-2" aria-hidden="true" tabindex="-1"></a>  result2<span class="op">.</span>map <span class="op">{</span> <span class="op">(</span>y<span class="op">:</span> <span class="bu">Int</span><span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb669-3"><a href="#cb669-3" aria-hidden="true" tabindex="-1"></a>    x <span class="op">+</span> y</span>
<span id="cb669-4"><a href="#cb669-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb669-5"><a href="#cb669-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb669-6"><a href="#cb669-6" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: OptionT[List, Int] = OptionT(value = List(Some(value = 42)))</span></span></code></pre></div>
    <p>This is the basis of all monad transformers. The combined
    <code>map</code> and <code>flatMap</code> methods allow us to use
    both component monads without having to recursively unpack and
    repack values at each stage in the computation. Now let’s look at
    the API in more depth.</p>
    <div class="callout callout-warning">
    <p><em>Complexity of Imports</em></p>
    <p>The imports in the code samples above hint at how everything
    bolts together.</p>
    <p>We import <a href="http://typelevel.org/cats/api/cats/syntax/package$$applicative$"><code>cats.syntax.applicative</code></a>
    to get the <code>pure</code> syntax. <code>pure</code> requires an
    implicit parameter of type <code>Applicative[ListOption]</code>. We
    haven’t met <code>Applicatives</code> yet, but all
    <code>Monads</code> are also <code>Applicatives</code> so we can
    ignore that difference for now.</p>
    <p>In order to generate our <code>Applicative[ListOption]</code> we
    need instances of <code>Applicative</code> for <code>List</code> and
    <code>OptionT</code>. <code>OptionT</code> is a Cats data type so
    its instance is provided by its companion object. The instance for
    <code>List</code> comes from <a href="http://typelevel.org/cats/api/cats/instances/package$$list$"><code>cats.instances.list</code></a>.</p>
    <p>Notice we’re not importing <a href="http://typelevel.org/cats/api/cats/syntax/package$$functor$"><code>cats.syntax.functor</code></a>
    or <a href="http://typelevel.org/cats/api/cats/syntax/package$$flatMap$"><code>cats.syntax.flatMap</code></a>.
    This is because <code>OptionT</code> is a concrete data type with
    its own explicit <code>map</code> and <code>flatMap</code> methods.
    It wouldn’t cause problems if we imported the syntax—the compiler
    would ignore it in favour of the explicit methods.</p>
    <p>Remember that we’re subjecting ourselves to these shenanigans
    because we’re stubbornly refusing to use the universal Cats import,
    <a href="http://typelevel.org/cats/api/cats/implicits$.html"><code>cats.implicits</code></a>.
    If we did use that import, all of the instances and syntax we needed
    would be in scope and everything would just work.</p>
    </div>
    <h2 data-number="10.3" id="monad-transformers-in-cats"><span class="header-section-number">10.3</span> Monad Transformers in
    Cats</h2>
    <p>Each monad transformer is a data type, defined in <a href="http://typelevel.org/cats/api/cats/data/"><code>cats.data</code></a>,
    that allows us to <em>wrap</em> stacks of monads to produce new
    monads. We use the monads we’ve built via the <code>Monad</code>
    type class. The main concepts we have to cover to understand monad
    transformers are:</p>
    <ul>
    <li>the available transformer classes;</li>
    <li>how to build stacks of monads using transformers;</li>
    <li>how to construct instances of a monad stack; and</li>
    <li>how to pull apart a stack to access the wrapped monads.</li>
    </ul>
    <h3 data-number="10.3.1" id="the-monad-transformer-classes"><span class="header-section-number">10.3.1</span> The Monad Transformer
    Classes</h3>
    <p>By convention, in Cats a monad <code>Foo</code> will have a
    transformer class called <code>FooT</code>. In fact, many monads in
    Cats are defined by combining a monad transformer with the
    <code>Id</code> monad. Concretely, some of the available instances
    are:</p>
    <ul>
    <li><a href="http://typelevel.org/cats/api/cats/data/OptionT.html"><code>cats.data.OptionT</code></a>
    for <code>Option</code>;</li>
    <li><a href="http://typelevel.org/cats/api/cats/data/EitherT.html"><code>cats.data.EitherT</code></a>
    for <code>Either</code>;</li>
    <li><a href="http://typelevel.org/cats/api/cats/data/?search=reader#ReaderT%5BF%5B_%5D,A,B%5D=cats.data.Kleisli%5BF,A,B%5D"><code>cats.data.ReaderT</code></a>
    for <code>Reader</code>;</li>
    <li><a href="http://typelevel.org/cats/api/cats/data/WriterT.html"><code>cats.data.WriterT</code></a>
    for <code>Writer</code>;</li>
    <li><a href="http://typelevel.org/cats/api/cats/data/StateT.html"><code>cats.data.StateT</code></a>
    for <code>State</code>;</li>
    <li><a href="http://typelevel.org/cats/api/cats/data/IdT.html"><code>cats.data.IdT</code></a>
    for the <a href="http://typelevel.org/cats/api/cats/Id.html"><code>Id</code></a>
    monad.</li>
    </ul>
    <div class="callout callout-info">
    <p><em>Kleisli Arrows</em></p>
    <p>In Section 9.8 we mentioned that the <code>Reader</code> monad
    was a specialisation of a more general concept called a “kleisli
    arrow”, represented in Cats as <a href="http://typelevel.org/cats/api/cats/data/Kleisli.html"><code>cats.data.Kleisli</code></a>.</p>
    <p>We can now reveal that <code>Kleisli</code> and
    <code>ReaderT</code> are, in fact, the same thing!
    <code>ReaderT</code> is actually a type alias for
    <code>Kleisli</code>. Hence, we were creating <code>Readers</code>
    last chapter and seeing <code>Kleislis</code> on the console.</p>
    </div>
    <h3 data-number="10.3.2" id="building-monad-stacks"><span class="header-section-number">10.3.2</span> Building Monad
    Stacks</h3>
    <p>All of these monad transformers follow the same convention. The
    transformer itself represents the <em>inner</em> monad in a stack,
    while the first type parameter specifies the outer monad. The
    remaining type parameters are the types we’ve used to form the
    corresponding monads.</p>
    <p>For example, our <code>ListOption</code> type above is an alias
    for <code>OptionT[List, A]</code> but the result is effectively a
    <code>List[Option[A]]</code>. In other words, we build monad stacks
    from the inside out:</p>
    <div class="sourceCode" id="cb670"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb670-1"><a href="#cb670-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> ListOption<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> OptionT<span class="op">[</span><span class="ex">List</span><span class="op">,</span> A<span class="op">]</span></span></code></pre></div>
    <p>Many monads and all transformers have at least two type
    parameters, so we often have to define type aliases for intermediate
    stages.</p>
    <p>For example, suppose we want to wrap <code>Either</code> around
    <code>Option</code>. <code>Option</code> is the innermost type so we
    want to use the <code>OptionT</code> monad transformer. We need to
    use <code>Either</code> as the first type parameter. However,
    <code>Either</code> itself has two type parameters and monads only
    have one. We need a type alias to convert the type constructor to
    the correct shape:</p>
    <div class="sourceCode" id="cb671"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb671-1"><a href="#cb671-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Alias Either to a type constructor with one parameter:</span></span>
<span id="cb671-2"><a href="#cb671-2" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> ErrorOr<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> Either<span class="op">[</span><span class="ex">String</span><span class="op">,</span> A<span class="op">]</span></span>
<span id="cb671-3"><a href="#cb671-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb671-4"><a href="#cb671-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Build our final monad stack using OptionT:</span></span>
<span id="cb671-5"><a href="#cb671-5" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> ErrorOrOption<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> OptionT<span class="op">[</span>ErrorOr<span class="op">,</span> A<span class="op">]</span></span></code></pre></div>
    <p><code>ErrorOrOption</code> is a monad, just like
    <code>ListOption</code>. We can use <code>pure</code>,
    <code>map</code>, and <code>flatMap</code> as usual to create and
    transform instances:</p>
    <div class="sourceCode" id="cb672"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb672-1"><a href="#cb672-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>either<span class="op">.</span>_ <span class="co">// for Monad</span></span></code></pre></div>
    <div class="sourceCode" id="cb673"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb673-1"><a href="#cb673-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> a <span class="op">=</span> <span class="fl">10.</span>pure<span class="op">[</span>ErrorOrOption<span class="op">]</span></span>
<span id="cb673-2"><a href="#cb673-2" aria-hidden="true" tabindex="-1"></a><span class="co">// a: OptionT[ErrorOr, Int] = OptionT(value = Right(value = Some(value = 10)))</span></span>
<span id="cb673-3"><a href="#cb673-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> b <span class="op">=</span> <span class="fl">32.</span>pure<span class="op">[</span>ErrorOrOption<span class="op">]</span></span>
<span id="cb673-4"><a href="#cb673-4" aria-hidden="true" tabindex="-1"></a><span class="co">// b: OptionT[ErrorOr, Int] = OptionT(value = Right(value = Some(value = 32)))</span></span>
<span id="cb673-5"><a href="#cb673-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb673-6"><a href="#cb673-6" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> c <span class="op">=</span> a<span class="op">.</span><span class="fu">flatMap</span><span class="op">(</span>x <span class="op">=&gt;</span> b<span class="op">.</span><span class="fu">map</span><span class="op">(</span>y <span class="op">=&gt;</span> x <span class="op">+</span> y<span class="op">))</span></span>
<span id="cb673-7"><a href="#cb673-7" aria-hidden="true" tabindex="-1"></a><span class="co">// c: OptionT[ErrorOr, Int] = OptionT(value = Right(value = Some(value = 42)))</span></span></code></pre></div>
    <p>Things become even more confusing when we want to stack three or
    more monads.</p>
    <p>For example, let’s create a <code>Future</code> of an
    <code>Either</code> of <code>Option</code>. Once again we build this
    from the inside out with an <code>OptionT</code> of an
    <code>EitherT</code> of <code>Future</code>. However, we can’t
    define this in one line because <code>EitherT</code> has three type
    parameters:</p>
    <div class="sourceCode" id="cb674"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb674-1"><a href="#cb674-1" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> EitherT<span class="op">[</span>F<span class="op">[</span>_<span class="op">],</span> E<span class="op">,</span> A<span class="op">](</span>stack<span class="op">:</span> F<span class="op">[</span>Either<span class="op">[</span>E<span class="op">,</span> A<span class="op">]])</span> <span class="op">{</span></span>
<span id="cb674-2"><a href="#cb674-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// etc...</span></span>
<span id="cb674-3"><a href="#cb674-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>The three type parameters are as follows:</p>
    <ul>
    <li><code>F[_]</code> is the outer monad in the stack
    (<code>Either</code> is the inner);</li>
    <li><code>E</code> is the error type for the
    <code>Either</code>;</li>
    <li><code>A</code> is the result type for the
    <code>Either</code>.</li>
    </ul>
    <p>This time we create an alias for <code>EitherT</code> that fixes
    <code>Future</code> and <code>Error</code> and allows <code>A</code>
    to vary:</p>
    <div class="sourceCode" id="cb675"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb675-1"><a href="#cb675-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span><span class="ex">Future</span></span>
<span id="cb675-2"><a href="#cb675-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>data<span class="op">.{</span>EitherT<span class="op">,</span> OptionT<span class="op">}</span></span>
<span id="cb675-3"><a href="#cb675-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb675-4"><a href="#cb675-4" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> FutureEither<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> EitherT<span class="op">[</span><span class="ex">Future</span><span class="op">,</span> <span class="ex">String</span><span class="op">,</span> A<span class="op">]</span></span>
<span id="cb675-5"><a href="#cb675-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb675-6"><a href="#cb675-6" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> FutureEitherOption<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> OptionT<span class="op">[</span>FutureEither<span class="op">,</span> A<span class="op">]</span></span></code></pre></div>
    <p>Our mammoth stack now composes three monads and our
    <code>map</code> and <code>flatMap</code> methods cut through three
    layers of abstraction:</p>
    <div class="sourceCode" id="cb676"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb676-1"><a href="#cb676-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>future<span class="op">.</span>_ <span class="co">// for Monad</span></span>
<span id="cb676-2"><a href="#cb676-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span>Await</span>
<span id="cb676-3"><a href="#cb676-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span>ExecutionContext<span class="op">.</span>Implicits<span class="op">.</span>global</span>
<span id="cb676-4"><a href="#cb676-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span>duration<span class="op">.</span>_</span></code></pre></div>
    <div class="sourceCode" id="cb677"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb677-1"><a href="#cb677-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> futureEitherOr<span class="op">:</span> FutureEitherOption<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb677-2"><a href="#cb677-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb677-3"><a href="#cb677-3" aria-hidden="true" tabindex="-1"></a>    a <span class="op">&lt;-</span> <span class="fl">10.</span>pure<span class="op">[</span>FutureEitherOption<span class="op">]</span></span>
<span id="cb677-4"><a href="#cb677-4" aria-hidden="true" tabindex="-1"></a>    b <span class="op">&lt;-</span> <span class="fl">32.</span>pure<span class="op">[</span>FutureEitherOption<span class="op">]</span></span>
<span id="cb677-5"><a href="#cb677-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">yield</span> a <span class="op">+</span> b</span></code></pre></div>
    <div class="callout callout-warning">
    <p><em>Kind Projector</em></p>
    <p>If you frequently find yourself defining multiple type aliases
    when building monad stacks, you may want to try the <a href="https://github.com/typelevel/kind-projector">Kind
    Projector</a> compiler plugin. Kind Projector enhances Scala’s type
    syntax to make it easier to define partially applied type
    constructors. For example:</p>
    <div class="sourceCode" id="cb678"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb678-1"><a href="#cb678-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>option<span class="op">.</span>_ <span class="co">// for Monad</span></span>
<span id="cb678-2"><a href="#cb678-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb678-3"><a href="#cb678-3" aria-hidden="true" tabindex="-1"></a><span class="fl">123.</span>pure<span class="op">[</span>EitherT<span class="op">[</span><span class="ex">Option</span><span class="op">,</span> <span class="ex">String</span><span class="op">,</span> _<span class="op">]]</span></span>
<span id="cb678-4"><a href="#cb678-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: EitherT[[A &gt;: Nothing &lt;: Any] =&gt; Option[A], String, Int] = EitherT(</span></span>
<span id="cb678-5"><a href="#cb678-5" aria-hidden="true" tabindex="-1"></a><span class="co">//   value = Some(value = Right(value = 123))</span></span>
<span id="cb678-6"><a href="#cb678-6" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>Kind Projector can’t simplify all type declarations down to a
    single line, but it can reduce the number of intermediate type
    definitions needed to keep our code readable.</p>
    </div>
    <h3 data-number="10.3.3" id="constructing-and-unpacking-instances"><span class="header-section-number">10.3.3</span> Constructing and
    Unpacking Instances</h3>
    <p>As we saw above, we can create transformed monad stacks using the
    relevant monad transformer’s <code>apply</code> method or the usual
    <code>pure</code> syntax<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a>:</p>
    <div class="sourceCode" id="cb679"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb679-1"><a href="#cb679-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Create using apply:</span></span>
<span id="cb679-2"><a href="#cb679-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> errorStack1 <span class="op">=</span> OptionT<span class="op">[</span>ErrorOr<span class="op">,</span> <span class="bu">Int</span><span class="op">](</span><span class="fu">Right</span><span class="op">(</span><span class="bu">Some</span><span class="op">(</span><span class="dv">10</span><span class="op">)))</span></span>
<span id="cb679-3"><a href="#cb679-3" aria-hidden="true" tabindex="-1"></a><span class="co">// errorStack1: OptionT[ErrorOr, Int] = OptionT(</span></span>
<span id="cb679-4"><a href="#cb679-4" aria-hidden="true" tabindex="-1"></a><span class="co">//   value = Right(value = Some(value = 10))</span></span>
<span id="cb679-5"><a href="#cb679-5" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span>
<span id="cb679-6"><a href="#cb679-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb679-7"><a href="#cb679-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Create using pure:</span></span>
<span id="cb679-8"><a href="#cb679-8" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> errorStack2 <span class="op">=</span> <span class="fl">32.</span>pure<span class="op">[</span>ErrorOrOption<span class="op">]</span></span>
<span id="cb679-9"><a href="#cb679-9" aria-hidden="true" tabindex="-1"></a><span class="co">// errorStack2: OptionT[ErrorOr, Int] = OptionT(</span></span>
<span id="cb679-10"><a href="#cb679-10" aria-hidden="true" tabindex="-1"></a><span class="co">//   value = Right(value = Some(value = 32))</span></span>
<span id="cb679-11"><a href="#cb679-11" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>Once we’ve finished with a monad transformer stack, we can unpack
    it using its <code>value</code> method. This returns the
    untransformed stack. We can then manipulate the individual monads in
    the usual way:</p>
    <div class="sourceCode" id="cb680"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb680-1"><a href="#cb680-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Extracting the untransformed monad stack:</span></span>
<span id="cb680-2"><a href="#cb680-2" aria-hidden="true" tabindex="-1"></a>errorStack1<span class="op">.</span>value</span>
<span id="cb680-3"><a href="#cb680-3" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: Either[String, Option[Int]] = Right(value = Some(value = 10))</span></span>
<span id="cb680-4"><a href="#cb680-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb680-5"><a href="#cb680-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Mapping over the Either in the stack:</span></span>
<span id="cb680-6"><a href="#cb680-6" aria-hidden="true" tabindex="-1"></a>errorStack2<span class="op">.</span>value<span class="op">.</span><span class="fu">map</span><span class="op">(</span>_<span class="op">.</span><span class="fu">getOrElse</span><span class="op">(-</span><span class="dv">1</span><span class="op">))</span></span>
<span id="cb680-7"><a href="#cb680-7" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: Either[String, Int] = Right(value = 32)</span></span></code></pre></div>
    <p>Each call to <code>value</code> unpacks a single monad
    transformer. We may need more than one call to completely unpack a
    large stack. For example, to <code>Await</code> the
    <code>FutureEitherOption</code> stack above, we need to call
    <code>value</code> twice:</p>
    <div class="sourceCode" id="cb681"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb681-1"><a href="#cb681-1" aria-hidden="true" tabindex="-1"></a>futureEitherOr</span>
<span id="cb681-2"><a href="#cb681-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res6: OptionT[FutureEither, Int] = OptionT(</span></span>
<span id="cb681-3"><a href="#cb681-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   value = EitherT(value = Future(Success(Right(Some(42)))))</span></span>
<span id="cb681-4"><a href="#cb681-4" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span>
<span id="cb681-5"><a href="#cb681-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb681-6"><a href="#cb681-6" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> intermediate <span class="op">=</span> futureEitherOr<span class="op">.</span>value</span>
<span id="cb681-7"><a href="#cb681-7" aria-hidden="true" tabindex="-1"></a><span class="co">// intermediate: EitherT[[T &gt;: Nothing &lt;: Any] =&gt; Future[T], String, Option[Int]] = EitherT(</span></span>
<span id="cb681-8"><a href="#cb681-8" aria-hidden="true" tabindex="-1"></a><span class="co">//   value = Future(Success(Right(Some(42))))</span></span>
<span id="cb681-9"><a href="#cb681-9" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span>
<span id="cb681-10"><a href="#cb681-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb681-11"><a href="#cb681-11" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> stack <span class="op">=</span> intermediate<span class="op">.</span>value</span>
<span id="cb681-12"><a href="#cb681-12" aria-hidden="true" tabindex="-1"></a><span class="co">// stack: Future[Either[String, Option[Int]]] = Future(Success(Right(Some(42))))</span></span>
<span id="cb681-13"><a href="#cb681-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb681-14"><a href="#cb681-14" aria-hidden="true" tabindex="-1"></a>Await<span class="op">.</span><span class="fu">result</span><span class="op">(</span>stack<span class="op">,</span> <span class="fl">1.</span>second<span class="op">)</span></span>
<span id="cb681-15"><a href="#cb681-15" aria-hidden="true" tabindex="-1"></a><span class="co">// res7: Either[String, Option[Int]] = Right(value = Some(value = 42))</span></span></code></pre></div>
    <h3 data-number="10.3.4" id="default-instances-1"><span class="header-section-number">10.3.4</span> Default Instances</h3>
    <p>Many monads in Cats are defined using the corresponding
    transformer and the <code>Id</code> monad. This is reassuring as it
    confirms that the APIs for monads and transformers are identical.
    <code>Reader</code>, <code>Writer</code>, and <code>State</code> are
    all defined in this way:</p>
    <div class="sourceCode" id="cb682"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb682-1"><a href="#cb682-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="ex">Reader</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span> ReaderT<span class="op">[</span>Id<span class="op">,</span> E<span class="op">,</span> A<span class="op">]</span> <span class="co">// = Kleisli[Id, E, A]</span></span>
<span id="cb682-2"><a href="#cb682-2" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="ex">Writer</span><span class="op">[</span>W<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span> WriterT<span class="op">[</span>Id<span class="op">,</span> W<span class="op">,</span> A<span class="op">]</span></span>
<span id="cb682-3"><a href="#cb682-3" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="ex">State</span><span class="op">[</span>S<span class="op">,</span> A<span class="op">]</span>  <span class="op">=</span> StateT<span class="op">[</span>Id<span class="op">,</span> S<span class="op">,</span> A<span class="op">]</span></span></code></pre></div>
    <p>In other cases monad transformers are defined separately to their
    corresponding monads. In these cases, the methods of the transformer
    tend to mirror the methods on the monad. For example,
    <code>OptionT</code> defines <code>getOrElse</code>, and
    <code>EitherT</code> defines <code>fold</code>, <code>bimap</code>,
    <code>swap</code>, and other useful methods.</p>
    <h3 data-number="10.3.5" id="usage-patterns"><span class="header-section-number">10.3.5</span> Usage Patterns</h3>
    <p>Widespread use of monad transformers is sometimes difficult
    because they fuse monads together in predefined ways. Without
    careful thought, we can end up having to unpack and repack monads in
    different configurations to operate on them in different
    contexts.</p>
    <p>We can cope with this in multiple ways. One approach involves
    creating a single “super stack” and sticking to it throughout our
    code base. This works if the code is simple and largely uniform in
    nature. For example, in a web application, we could decide that all
    request handlers are asynchronous and all can fail with the same set
    of HTTP error codes. We could design a custom ADT representing the
    errors and use a fusion <code>Future</code> and <code>Either</code>
    everywhere in our code:</p>
    <div class="sourceCode" id="cb683"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb683-1"><a href="#cb683-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">abstract</span> <span class="kw">class</span> HttpError</span>
<span id="cb683-2"><a href="#cb683-2" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="ex">NotFound</span><span class="op">(</span>item<span class="op">:</span> <span class="ex">String</span><span class="op">)</span> <span class="kw">extends</span> HttpError</span>
<span id="cb683-3"><a href="#cb683-3" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">BadRequest</span><span class="op">(</span>msg<span class="op">:</span> <span class="ex">String</span><span class="op">)</span> <span class="kw">extends</span> HttpError</span>
<span id="cb683-4"><a href="#cb683-4" aria-hidden="true" tabindex="-1"></a><span class="co">// etc...</span></span>
<span id="cb683-5"><a href="#cb683-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb683-6"><a href="#cb683-6" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> FutureEither<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> EitherT<span class="op">[</span><span class="ex">Future</span><span class="op">,</span> HttpError<span class="op">,</span> A<span class="op">]</span></span></code></pre></div>
    <p>The “super stack” approach starts to fail in larger, more
    heterogeneous code bases where different stacks make sense in
    different contexts. Another design pattern that makes more sense in
    these contexts uses monad transformers as local “glue code”. We
    expose untransformed stacks at module boundaries, transform them to
    operate on them locally, and untransform them before passing them
    on. This allows each module of code to make its own decisions about
    which transformers to use:</p>
    <div class="sourceCode" id="cb684"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb684-1"><a href="#cb684-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>data<span class="op">.</span><span class="ex">Writer</span></span>
<span id="cb684-2"><a href="#cb684-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb684-3"><a href="#cb684-3" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Logged<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> <span class="ex">Writer</span><span class="op">[</span><span class="ex">List</span><span class="op">[</span><span class="ex">String</span><span class="op">],</span> A<span class="op">]</span></span>
<span id="cb684-4"><a href="#cb684-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb684-5"><a href="#cb684-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Methods generally return untransformed stacks:</span></span>
<span id="cb684-6"><a href="#cb684-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">parseNumber</span><span class="op">(</span>str<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> Logged<span class="op">[</span><span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">]]</span> <span class="op">=</span></span>
<span id="cb684-7"><a href="#cb684-7" aria-hidden="true" tabindex="-1"></a>  util<span class="op">.</span><span class="fu">Try</span><span class="op">(</span>str<span class="op">.</span>toInt<span class="op">).</span>toOption <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb684-8"><a href="#cb684-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="bu">Some</span><span class="op">(</span>num<span class="op">)</span> <span class="op">=&gt;</span> <span class="ex">Writer</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="ss">s&quot;</span><span class="st">Read </span><span class="ss">$str&quot;</span><span class="op">),</span> <span class="bu">Some</span><span class="op">(</span>num<span class="op">))</span></span>
<span id="cb684-9"><a href="#cb684-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="bu">None</span>      <span class="op">=&gt;</span> <span class="ex">Writer</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="ss">s&quot;</span><span class="st">Failed on </span><span class="ss">$str&quot;</span><span class="op">),</span> <span class="bu">None</span><span class="op">)</span></span>
<span id="cb684-10"><a href="#cb684-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb684-11"><a href="#cb684-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb684-12"><a href="#cb684-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Consumers use monad transformers locally to simplify composition:</span></span>
<span id="cb684-13"><a href="#cb684-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">addAll</span><span class="op">(</span>a<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> b<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> c<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> Logged<span class="op">[</span><span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">]]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb684-14"><a href="#cb684-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">import</span> cats<span class="op">.</span>data<span class="op">.</span>OptionT</span>
<span id="cb684-15"><a href="#cb684-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb684-16"><a href="#cb684-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> result <span class="op">=</span> <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb684-17"><a href="#cb684-17" aria-hidden="true" tabindex="-1"></a>    a <span class="op">&lt;-</span> <span class="fu">OptionT</span><span class="op">(</span><span class="fu">parseNumber</span><span class="op">(</span>a<span class="op">))</span></span>
<span id="cb684-18"><a href="#cb684-18" aria-hidden="true" tabindex="-1"></a>    b <span class="op">&lt;-</span> <span class="fu">OptionT</span><span class="op">(</span><span class="fu">parseNumber</span><span class="op">(</span>b<span class="op">))</span></span>
<span id="cb684-19"><a href="#cb684-19" aria-hidden="true" tabindex="-1"></a>    c <span class="op">&lt;-</span> <span class="fu">OptionT</span><span class="op">(</span><span class="fu">parseNumber</span><span class="op">(</span>c<span class="op">))</span></span>
<span id="cb684-20"><a href="#cb684-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">yield</span> a <span class="op">+</span> b <span class="op">+</span> c</span>
<span id="cb684-21"><a href="#cb684-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb684-22"><a href="#cb684-22" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>value</span>
<span id="cb684-23"><a href="#cb684-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <div class="sourceCode" id="cb685"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb685-1"><a href="#cb685-1" aria-hidden="true" tabindex="-1"></a><span class="co">// This approach doesn&#39;t force OptionT on other users&#39; code:</span></span>
<span id="cb685-2"><a href="#cb685-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> result1 <span class="op">=</span> <span class="fu">addAll</span><span class="op">(</span><span class="st">&quot;1&quot;</span><span class="op">,</span> <span class="st">&quot;2&quot;</span><span class="op">,</span> <span class="st">&quot;3&quot;</span><span class="op">)</span></span>
<span id="cb685-3"><a href="#cb685-3" aria-hidden="true" tabindex="-1"></a><span class="co">// result1: WriterT[Id, List[String], Option[Int]] = WriterT(</span></span>
<span id="cb685-4"><a href="#cb685-4" aria-hidden="true" tabindex="-1"></a><span class="co">//   run = (List(&quot;Read 1&quot;, &quot;Read 2&quot;, &quot;Read 3&quot;), Some(value = 6))</span></span>
<span id="cb685-5"><a href="#cb685-5" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span>
<span id="cb685-6"><a href="#cb685-6" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> result2 <span class="op">=</span> <span class="fu">addAll</span><span class="op">(</span><span class="st">&quot;1&quot;</span><span class="op">,</span> <span class="st">&quot;a&quot;</span><span class="op">,</span> <span class="st">&quot;3&quot;</span><span class="op">)</span></span>
<span id="cb685-7"><a href="#cb685-7" aria-hidden="true" tabindex="-1"></a><span class="co">// result2: WriterT[Id, List[String], Option[Int]] = WriterT(</span></span>
<span id="cb685-8"><a href="#cb685-8" aria-hidden="true" tabindex="-1"></a><span class="co">//   run = (List(&quot;Read 1&quot;, &quot;Failed on a&quot;), None)</span></span>
<span id="cb685-9"><a href="#cb685-9" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>Unfortunately, there aren’t one-size-fits-all approaches to
    working with monad transformers. The best approach for you may
    depend on a lot of factors: the size and experience of your team,
    the complexity of your code base, and so on. You may need to
    experiment and gather feedback from colleagues to determine whether
    monad transformers are a good fit.</p>
    <h2 data-number="10.4" id="exercise-monads-transform-and-roll-out"><span class="header-section-number">10.4</span> Exercise: Monads:
    Transform and Roll Out</h2>
    <p>The Autobots, well-known robots in disguise, frequently send
    messages during battle requesting the power levels of their team
    mates. This helps them coordinate strategies and launch devastating
    attacks. The message sending method looks like this:</p>
    <div class="sourceCode" id="cb686"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb686-1"><a href="#cb686-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">getPowerLevel</span><span class="op">(</span>autobot<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Response</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb686-2"><a href="#cb686-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">???</span></span></code></pre></div>
    <p>Transmissions take time in Earth’s viscous atmosphere, and
    messages are occasionally lost due to satellite malfunction or
    sabotage by pesky Decepticons<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a>.
    <code>Responses</code> are therefore represented as a stack of
    monads:</p>
    <div class="sourceCode" id="cb687"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb687-1"><a href="#cb687-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="ex">Response</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> <span class="ex">Future</span><span class="op">[</span>Either<span class="op">[</span><span class="ex">String</span><span class="op">,</span> A<span class="op">]]</span></span></code></pre></div>
    <p>Optimus Prime is getting tired of the nested for comprehensions
    in his neural matrix. Help him by rewriting <code>Response</code>
    using a monad transformer.</p>
    <div class="solution">
    <p>This is a relatively simple combination. We want
    <code>Future</code> on the outside and <code>Either</code> on the
    inside, so we build from the inside out using an
    <code>EitherT</code> of <code>Future</code>:</p>
    <div class="sourceCode" id="cb688"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb688-1"><a href="#cb688-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>data<span class="op">.</span>EitherT</span>
<span id="cb688-2"><a href="#cb688-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span><span class="ex">Future</span></span>
<span id="cb688-3"><a href="#cb688-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb688-4"><a href="#cb688-4" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="ex">Response</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> EitherT<span class="op">[</span><span class="ex">Future</span><span class="op">,</span> <span class="ex">String</span><span class="op">,</span> A<span class="op">]</span></span></code></pre></div>
    </div>
    <p>Now test the code by implementing <code>getPowerLevel</code> to
    retrieve data from a set of imaginary allies. Here’s the data we’ll
    use:</p>
    <div class="sourceCode" id="cb689"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb689-1"><a href="#cb689-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> powerLevels <span class="op">=</span> <span class="ex">Map</span><span class="op">(</span></span>
<span id="cb689-2"><a href="#cb689-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Jazz&quot;</span>      <span class="op">-&gt;</span> <span class="dv">6</span><span class="op">,</span></span>
<span id="cb689-3"><a href="#cb689-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Bumblebee&quot;</span> <span class="op">-&gt;</span> <span class="dv">8</span><span class="op">,</span></span>
<span id="cb689-4"><a href="#cb689-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Hot Rod&quot;</span>   <span class="op">-&gt;</span> <span class="dv">10</span></span>
<span id="cb689-5"><a href="#cb689-5" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span></code></pre></div>
    <p>If an Autobot isn’t in the <code>powerLevels</code> map, return
    an error message reporting that they were unreachable. Include the
    <code>name</code> in the message for good effect.</p>
    <div class="solution">
    <div class="sourceCode" id="cb690"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb690-1"><a href="#cb690-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>data<span class="op">.</span>EitherT</span>
<span id="cb690-2"><a href="#cb690-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span><span class="ex">Future</span></span>
<span id="cb690-3"><a href="#cb690-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> powerLevels <span class="op">=</span> <span class="ex">Map</span><span class="op">(</span></span>
<span id="cb690-4"><a href="#cb690-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Jazz&quot;</span>      <span class="op">-&gt;</span> <span class="dv">6</span><span class="op">,</span></span>
<span id="cb690-5"><a href="#cb690-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Bumblebee&quot;</span> <span class="op">-&gt;</span> <span class="dv">8</span><span class="op">,</span></span>
<span id="cb690-6"><a href="#cb690-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Hot Rod&quot;</span>   <span class="op">-&gt;</span> <span class="dv">10</span></span>
<span id="cb690-7"><a href="#cb690-7" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb691"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb691-1"><a href="#cb691-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>future<span class="op">.</span>_ <span class="co">// for Monad</span></span>
<span id="cb691-2"><a href="#cb691-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span>ExecutionContext<span class="op">.</span>Implicits<span class="op">.</span>global</span>
<span id="cb691-3"><a href="#cb691-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb691-4"><a href="#cb691-4" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="ex">Response</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> EitherT<span class="op">[</span><span class="ex">Future</span><span class="op">,</span> <span class="ex">String</span><span class="op">,</span> A<span class="op">]</span></span>
<span id="cb691-5"><a href="#cb691-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb691-6"><a href="#cb691-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">getPowerLevel</span><span class="op">(</span>ally<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Response</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb691-7"><a href="#cb691-7" aria-hidden="true" tabindex="-1"></a>  powerLevels<span class="op">.</span><span class="fu">get</span><span class="op">(</span>ally<span class="op">)</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb691-8"><a href="#cb691-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="bu">Some</span><span class="op">(</span>avg<span class="op">)</span> <span class="op">=&gt;</span> EitherT<span class="op">.</span><span class="fu">right</span><span class="op">(</span><span class="ex">Future</span><span class="op">(</span>avg<span class="op">))</span></span>
<span id="cb691-9"><a href="#cb691-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="bu">None</span>      <span class="op">=&gt;</span> EitherT<span class="op">.</span><span class="fu">left</span><span class="op">(</span><span class="ex">Future</span><span class="op">(</span><span class="ss">s&quot;$ally</span><span class="st"> unreachable</span><span class="ss">&quot;</span><span class="op">))</span></span>
<span id="cb691-10"><a href="#cb691-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb691-11"><a href="#cb691-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    </div>
    <p>Two autobots can perform a special move if their combined power
    level is greater than 15. Write a second method,
    <code>canSpecialMove</code>, that accepts the names of two allies
    and checks whether a special move is possible. If either ally is
    unavailable, fail with an appropriate error message:</p>
    <div class="sourceCode" id="cb692"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb692-1"><a href="#cb692-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">canSpecialMove</span><span class="op">(</span>ally1<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> ally2<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Response</span><span class="op">[</span><span class="ex">Boolean</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb692-2"><a href="#cb692-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">???</span></span></code></pre></div>
    <div class="solution">
    <p>We request the power level from each ally and use
    <code>map</code> and <code>flatMap</code> to combine the
    results:</p>
    <div class="sourceCode" id="cb693"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb693-1"><a href="#cb693-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">canSpecialMove</span><span class="op">(</span>ally1<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> ally2<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Response</span><span class="op">[</span><span class="ex">Boolean</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb693-2"><a href="#cb693-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb693-3"><a href="#cb693-3" aria-hidden="true" tabindex="-1"></a>    power1 <span class="op">&lt;-</span> <span class="fu">getPowerLevel</span><span class="op">(</span>ally1<span class="op">)</span></span>
<span id="cb693-4"><a href="#cb693-4" aria-hidden="true" tabindex="-1"></a>    power2 <span class="op">&lt;-</span> <span class="fu">getPowerLevel</span><span class="op">(</span>ally2<span class="op">)</span></span>
<span id="cb693-5"><a href="#cb693-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">yield</span> <span class="op">(</span>power1 <span class="op">+</span> power2<span class="op">)</span> <span class="op">&gt;</span> <span class="dv">15</span></span></code></pre></div>
    </div>
    <p>Finally, write a method <code>tacticalReport</code> that takes
    two ally names and prints a message saying whether they can perform
    a special move:</p>
    <div class="sourceCode" id="cb694"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb694-1"><a href="#cb694-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">tacticalReport</span><span class="op">(</span>ally1<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> ally2<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">String</span> <span class="op">=</span></span>
<span id="cb694-2"><a href="#cb694-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">???</span></span></code></pre></div>
    <div class="solution">
    <p>We use the <code>value</code> method to unpack the monad stack
    and <code>Await</code> and <code>fold</code> to unpack the
    <code>Future</code> and <code>Either</code>:</p>
    <div class="sourceCode" id="cb695"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb695-1"><a href="#cb695-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span>Await</span>
<span id="cb695-2"><a href="#cb695-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span>ExecutionContext<span class="op">.</span>Implicits<span class="op">.</span>global</span>
<span id="cb695-3"><a href="#cb695-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span>duration<span class="op">.</span>_</span>
<span id="cb695-4"><a href="#cb695-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb695-5"><a href="#cb695-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">canSpecialMove</span><span class="op">(</span>ally1<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> ally2<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Response</span><span class="op">[</span><span class="ex">Boolean</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb695-6"><a href="#cb695-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb695-7"><a href="#cb695-7" aria-hidden="true" tabindex="-1"></a>    power1 <span class="op">&lt;-</span> <span class="fu">getPowerLevel</span><span class="op">(</span>ally1<span class="op">)</span></span>
<span id="cb695-8"><a href="#cb695-8" aria-hidden="true" tabindex="-1"></a>    power2 <span class="op">&lt;-</span> <span class="fu">getPowerLevel</span><span class="op">(</span>ally2<span class="op">)</span></span>
<span id="cb695-9"><a href="#cb695-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">yield</span> <span class="op">(</span>power1 <span class="op">+</span> power2<span class="op">)</span> <span class="op">&gt;</span> <span class="dv">15</span></span>
<span id="cb695-10"><a href="#cb695-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb695-11"><a href="#cb695-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">tacticalReport</span><span class="op">(</span>ally1<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> ally2<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">String</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb695-12"><a href="#cb695-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> stack <span class="op">=</span> <span class="fu">canSpecialMove</span><span class="op">(</span>ally1<span class="op">,</span> ally2<span class="op">).</span>value</span>
<span id="cb695-13"><a href="#cb695-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb695-14"><a href="#cb695-14" aria-hidden="true" tabindex="-1"></a>  Await<span class="op">.</span><span class="fu">result</span><span class="op">(</span>stack<span class="op">,</span> <span class="fl">1.</span>second<span class="op">)</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb695-15"><a href="#cb695-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Left</span><span class="op">(</span>msg<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb695-16"><a href="#cb695-16" aria-hidden="true" tabindex="-1"></a>      <span class="ss">s&quot;</span><span class="st">Comms error: </span><span class="ss">$msg&quot;</span></span>
<span id="cb695-17"><a href="#cb695-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Right</span><span class="op">(</span><span class="kw">true</span><span class="op">)</span>  <span class="op">=&gt;</span></span>
<span id="cb695-18"><a href="#cb695-18" aria-hidden="true" tabindex="-1"></a>      <span class="ss">s&quot;$ally1</span><span class="st"> and </span><span class="ss">$ally2</span><span class="st"> are ready to roll out!</span><span class="ss">&quot;</span></span>
<span id="cb695-19"><a href="#cb695-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Right</span><span class="op">(</span><span class="kw">false</span><span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb695-20"><a href="#cb695-20" aria-hidden="true" tabindex="-1"></a>      <span class="ss">s&quot;$ally1</span><span class="st"> and </span><span class="ss">$ally2</span><span class="st"> need a recharge.</span><span class="ss">&quot;</span></span>
<span id="cb695-21"><a href="#cb695-21" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb695-22"><a href="#cb695-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    </div>
    <p>You should be able to use <code>report</code> as follows:</p>
    <div class="sourceCode" id="cb696"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb696-1"><a href="#cb696-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tacticalReport</span><span class="op">(</span><span class="st">&quot;Jazz&quot;</span><span class="op">,</span> <span class="st">&quot;Bumblebee&quot;</span><span class="op">)</span></span>
<span id="cb696-2"><a href="#cb696-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res13: String = &quot;Jazz and Bumblebee need a recharge.&quot;</span></span>
<span id="cb696-3"><a href="#cb696-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tacticalReport</span><span class="op">(</span><span class="st">&quot;Bumblebee&quot;</span><span class="op">,</span> <span class="st">&quot;Hot Rod&quot;</span><span class="op">)</span></span>
<span id="cb696-4"><a href="#cb696-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res14: String = &quot;Bumblebee and Hot Rod are ready to roll out!&quot;</span></span>
<span id="cb696-5"><a href="#cb696-5" aria-hidden="true" tabindex="-1"></a><span class="fu">tacticalReport</span><span class="op">(</span><span class="st">&quot;Jazz&quot;</span><span class="op">,</span> <span class="st">&quot;Ironhide&quot;</span><span class="op">)</span></span>
<span id="cb696-6"><a href="#cb696-6" aria-hidden="true" tabindex="-1"></a><span class="co">// res15: String = &quot;Comms error: Ironhide unreachable&quot;</span></span></code></pre></div>
    <h2 data-number="10.5" id="summary-3"><span class="header-section-number">10.5</span> Summary</h2>
    <p>In this chapter we introduced monad transformers, which eliminate
    the need for nested for comprehensions and pattern matching when
    working with “stacks” of nested monads.</p>
    <p>Each monad transformer, such as <code>FutureT</code>,
    <code>OptionT</code> or <code>EitherT</code>, provides the code
    needed to merge its related monad with other monads. The transformer
    is a data structure that wraps a monad stack, equipping it with
    <code>map</code> and <code>flatMap</code> methods that unpack and
    repack the whole stack.</p>
    <p>The type signatures of monad transformers are written from the
    inside out, so an <code>EitherT[Option, String, A]</code> is a
    wrapper for an <code>Option[Either[String, A]]</code>. It is often
    useful to use type aliases when writing transformer types for deeply
    nested monads.</p>
    <p>With this look at monad transformers, we have now covered
    everything we need to know about monads and the sequencing of
    computations using <code>flatMap</code>. In the next chapter we will
    switch tack and discuss two new type classes,
    <code>Semigroupal</code> and <code>Applicative</code>, that support
    new kinds of operation such as <code>zipping</code> independent
    values within a context.</p>
    <h1 data-number="11" id="sec:applicatives"><span class="header-section-number">11</span> Semigroupal and
    Applicative</h1>
    <p>In previous chapters we saw how functors and monads let us
    sequence operations using <code>map</code> and <code>flatMap</code>.
    While functors and monads are both immensely useful abstractions,
    there are certain types of program flow that they cannot
    represent.</p>
    <p>One such example is form validation. When we validate a form we
    want to return <em>all</em> the errors to the user, not stop on the
    first error we encounter. If we model this with a monad like
    <code>Either</code>, we fail fast and lose errors. For example, the
    code below fails on the first call to <code>parseInt</code> and
    doesn’t go any further:</p>
    <div class="sourceCode" id="cb697"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb697-1"><a href="#cb697-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>either<span class="op">.</span>_ <span class="co">// for catchOnly</span></span>
<span id="cb697-2"><a href="#cb697-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb697-3"><a href="#cb697-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">parseInt</span><span class="op">(</span>str<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> Either<span class="op">[</span><span class="ex">String</span><span class="op">,</span> <span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb697-4"><a href="#cb697-4" aria-hidden="true" tabindex="-1"></a>  Either<span class="op">.</span>catchOnly<span class="op">[</span><span class="ex">NumberFormatException</span><span class="op">](</span>str<span class="op">.</span>toInt<span class="op">).</span></span>
<span id="cb697-5"><a href="#cb697-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">leftMap</span><span class="op">(</span>_ <span class="op">=&gt;</span> <span class="ss">s&quot;</span><span class="st">Couldn&#39;t read </span><span class="ss">$str&quot;</span><span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb698"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb698-1"><a href="#cb698-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">{</span></span>
<span id="cb698-2"><a href="#cb698-2" aria-hidden="true" tabindex="-1"></a>  a <span class="op">&lt;-</span> <span class="fu">parseInt</span><span class="op">(</span><span class="st">&quot;a&quot;</span><span class="op">)</span></span>
<span id="cb698-3"><a href="#cb698-3" aria-hidden="true" tabindex="-1"></a>  b <span class="op">&lt;-</span> <span class="fu">parseInt</span><span class="op">(</span><span class="st">&quot;b&quot;</span><span class="op">)</span></span>
<span id="cb698-4"><a href="#cb698-4" aria-hidden="true" tabindex="-1"></a>  c <span class="op">&lt;-</span> <span class="fu">parseInt</span><span class="op">(</span><span class="st">&quot;c&quot;</span><span class="op">)</span></span>
<span id="cb698-5"><a href="#cb698-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">yield</span> <span class="op">(</span>a <span class="op">+</span> b <span class="op">+</span> c<span class="op">)</span></span>
<span id="cb698-6"><a href="#cb698-6" aria-hidden="true" tabindex="-1"></a><span class="co">// res0: Either[String, Int] = Left(value = &quot;Couldn&#39;t read a&quot;)</span></span></code></pre></div>
    <p>Another example is the concurrent evaluation of
    <code>Futures</code>. If we have several long-running independent
    tasks, it makes sense to execute them concurrently. However, monadic
    comprehension only allows us to run them in sequence.
    <code>map</code> and <code>flatMap</code> aren’t quite capable of
    capturing what we want because they make the assumption that each
    computation is <em>dependent</em> on the previous one:</p>
    <div class="sourceCode" id="cb699"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb699-1"><a href="#cb699-1" aria-hidden="true" tabindex="-1"></a><span class="co">// context2 is dependent on value1:</span></span>
<span id="cb699-2"><a href="#cb699-2" aria-hidden="true" tabindex="-1"></a>context1<span class="op">.</span><span class="fu">flatMap</span><span class="op">(</span>value1 <span class="op">=&gt;</span> context2<span class="op">)</span></span></code></pre></div>
    <p>The calls to <code>parseInt</code> and <code>Future.apply</code>
    above are <em>independent</em> of one another, but <code>map</code>
    and <code>flatMap</code> can’t exploit this. We need a weaker
    construct—one that doesn’t guarantee sequencing—to achieve the
    result we want. In this chapter we will look at three type classes
    that support this pattern:</p>
    <ul>
    <li><p><code>Semigroupal</code> encompasses the notion of composing
    pairs of contexts. Cats provides a <a href="http://typelevel.org/cats/api/cats/syntax/package$$semigroupal$"><code>cats.syntax.apply</code></a>
    module that makes use of <code>Semigroupal</code> and
    <code>Functor</code> to allow users to sequence functions with
    multiple arguments.</p></li>
    <li><p><code>Parallel</code> converts types with a
    <code>Monad</code> instance to a related type with a
    <code>Semigroupal</code> instance.</p></li>
    <li><p><code>Applicative</code> extends <code>Semigroupal</code> and
    <code>Functor</code>. It provides a way of applying functions to
    parameters within a context. <code>Applicative</code> is the source
    of the <code>pure</code> method we introduced in Chapter 9.</p></li>
    </ul>
    <p>Applicatives are often formulated in terms of function
    application, instead of the semigroupal formulation that is
    emphasised in Cats. This alternative formulation provides a link to
    other libraries and languages such as Scalaz and Haskell. We’ll take
    a look at different formulations of Applicative, as well as the
    relationships between <code>Semigroupal</code>,
    <code>Functor</code>, <code>Applicative</code>, and
    <code>Monad</code>, towards the end of the chapter.</p>
    <h2 data-number="11.1" id="sec:semigroupal"><span class="header-section-number">11.1</span> Semigroupal</h2>
    <p><a href="http://typelevel.org/cats/api/cats/Semigroupal.html"><code>cats.Semigroupal</code></a>
    is a type class that allows us to combine contexts<a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a>. If we have two objects of type
    <code>F[A]</code> and <code>F[B]</code>, a
    <code>Semigroupal[F]</code> allows us to combine them to form an
    <code>F[(A, B)]</code>. Its definition in Cats is:</p>
    <div class="sourceCode" id="cb700"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb700-1"><a href="#cb700-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Semigroupal<span class="op">[</span>F<span class="op">[</span>_<span class="op">]]</span> <span class="op">{</span></span>
<span id="cb700-2"><a href="#cb700-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> product<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>fa<span class="op">:</span> F<span class="op">[</span>A<span class="op">],</span> fb<span class="op">:</span> F<span class="op">[</span>B<span class="op">]):</span> F<span class="op">[(</span>A<span class="op">,</span> B<span class="op">)]</span></span>
<span id="cb700-3"><a href="#cb700-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>As we discussed at the beginning of this chapter, the parameters
    <code>fa</code> and <code>fb</code> are independent of one another:
    we can compute them in either order before passing them to
    <code>product</code>. This is in contrast to <code>flatMap</code>,
    which imposes a strict order on its parameters. This gives us more
    freedom when defining instances of <code>Semigroupal</code> than we
    get when defining <code>Monads</code>.</p>
    <p>is also the winner of Underscore’s 2017 award for the most
    difficult functional programming term to work into a coherent
    English sentence.</p>
    <h3 data-number="11.1.1" id="joining-two-contexts"><span class="header-section-number">11.1.1</span> Joining Two
    Contexts</h3>
    <p>While <code>Semigroup</code> allows us to join values,
    <code>Semigroupal</code> allows us to join contexts. Let’s join some
    <code>Options</code> as an example:</p>
    <div class="sourceCode" id="cb701"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb701-1"><a href="#cb701-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Semigroupal</span>
<span id="cb701-2"><a href="#cb701-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>option<span class="op">.</span>_ <span class="co">// for Semigroupal</span></span></code></pre></div>
    <div class="sourceCode" id="cb702"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb702-1"><a href="#cb702-1" aria-hidden="true" tabindex="-1"></a>Semigroupal<span class="op">[</span><span class="ex">Option</span><span class="op">].</span><span class="fu">product</span><span class="op">(</span><span class="bu">Some</span><span class="op">(</span><span class="dv">123</span><span class="op">),</span> <span class="bu">Some</span><span class="op">(</span><span class="st">&quot;abc&quot;</span><span class="op">))</span></span>
<span id="cb702-2"><a href="#cb702-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: Option[Tuple2[Int, String]] = Some(value = (123, &quot;abc&quot;))</span></span></code></pre></div>
    <p>If both parameters are instances of <code>Some</code>, we end up
    with a tuple of the values within. If either parameter evaluates to
    <code>None</code>, the entire result is <code>None</code>:</p>
    <div class="sourceCode" id="cb703"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb703-1"><a href="#cb703-1" aria-hidden="true" tabindex="-1"></a>Semigroupal<span class="op">[</span><span class="ex">Option</span><span class="op">].</span><span class="fu">product</span><span class="op">(</span><span class="bu">None</span><span class="op">,</span> <span class="bu">Some</span><span class="op">(</span><span class="st">&quot;abc&quot;</span><span class="op">))</span></span>
<span id="cb703-2"><a href="#cb703-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: Option[Tuple2[Nothing, String]] = None</span></span>
<span id="cb703-3"><a href="#cb703-3" aria-hidden="true" tabindex="-1"></a>Semigroupal<span class="op">[</span><span class="ex">Option</span><span class="op">].</span><span class="fu">product</span><span class="op">(</span><span class="bu">Some</span><span class="op">(</span><span class="dv">123</span><span class="op">),</span> <span class="bu">None</span><span class="op">)</span></span>
<span id="cb703-4"><a href="#cb703-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: Option[Tuple2[Int, Nothing]] = None</span></span></code></pre></div>
    <h3 data-number="11.1.2" id="joining-three-or-more-contexts"><span class="header-section-number">11.1.2</span> Joining Three or More
    Contexts</h3>
    <p>The companion object for <code>Semigroupal</code> defines a set
    of methods on top of <code>product</code>. For example, the methods
    <code>tuple2</code> through <code>tuple22</code> generalise
    <code>product</code> to different arities:</p>
    <div class="sourceCode" id="cb704"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb704-1"><a href="#cb704-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>option<span class="op">.</span>_ <span class="co">// for Semigroupal</span></span></code></pre></div>
    <div class="sourceCode" id="cb705"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb705-1"><a href="#cb705-1" aria-hidden="true" tabindex="-1"></a>Semigroupal<span class="op">.</span><span class="fu">tuple3</span><span class="op">(</span><span class="ex">Option</span><span class="op">(</span><span class="dv">1</span><span class="op">),</span> <span class="ex">Option</span><span class="op">(</span><span class="dv">2</span><span class="op">),</span> <span class="ex">Option</span><span class="op">(</span><span class="dv">3</span><span class="op">))</span></span>
<span id="cb705-2"><a href="#cb705-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: Option[Tuple3[Int, Int, Int]] = Some(value = (1, 2, 3))</span></span>
<span id="cb705-3"><a href="#cb705-3" aria-hidden="true" tabindex="-1"></a>Semigroupal<span class="op">.</span><span class="fu">tuple3</span><span class="op">(</span><span class="ex">Option</span><span class="op">(</span><span class="dv">1</span><span class="op">),</span> <span class="ex">Option</span><span class="op">(</span><span class="dv">2</span><span class="op">),</span> <span class="ex">Option</span><span class="op">.</span>empty<span class="op">[</span><span class="bu">Int</span><span class="op">])</span></span>
<span id="cb705-4"><a href="#cb705-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: Option[Tuple3[Int, Int, Int]] = None</span></span></code></pre></div>
    <p>The methods <code>map2</code> through <code>map22</code> apply a
    user-specified function to the values inside 2 to 22 contexts:</p>
    <div class="sourceCode" id="cb706"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb706-1"><a href="#cb706-1" aria-hidden="true" tabindex="-1"></a>Semigroupal<span class="op">.</span><span class="fu">map3</span><span class="op">(</span><span class="ex">Option</span><span class="op">(</span><span class="dv">1</span><span class="op">),</span> <span class="ex">Option</span><span class="op">(</span><span class="dv">2</span><span class="op">),</span> <span class="ex">Option</span><span class="op">(</span><span class="dv">3</span><span class="op">))(</span>_ <span class="op">+</span> _ <span class="op">+</span> _<span class="op">)</span></span>
<span id="cb706-2"><a href="#cb706-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res6: Option[Int] = Some(value = 6)</span></span>
<span id="cb706-3"><a href="#cb706-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb706-4"><a href="#cb706-4" aria-hidden="true" tabindex="-1"></a>Semigroupal<span class="op">.</span><span class="fu">map2</span><span class="op">(</span><span class="ex">Option</span><span class="op">(</span><span class="dv">1</span><span class="op">),</span> <span class="ex">Option</span><span class="op">.</span>empty<span class="op">[</span><span class="bu">Int</span><span class="op">])(</span>_ <span class="op">+</span> _<span class="op">)</span></span>
<span id="cb706-5"><a href="#cb706-5" aria-hidden="true" tabindex="-1"></a><span class="co">// res7: Option[Int] = None</span></span></code></pre></div>
    <p>There are also methods <code>contramap2</code> through
    <code>contramap22</code> and <code>imap2</code> through
    <code>imap22</code>, that require instances of
    <code>Contravariant</code> and <code>Invariant</code>
    respectively.</p>
    <h3 data-number="11.1.3" id="semigroupal-laws"><span class="header-section-number">11.1.3</span> Semigroupal Laws</h3>
    <p>There is only one law for <code>Semigroupal</code>: the
    <code>product</code> method must be associative.</p>
    <div class="sourceCode" id="cb707"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb707-1"><a href="#cb707-1" aria-hidden="true" tabindex="-1"></a><span class="fu">product</span><span class="op">(</span>a<span class="op">,</span> <span class="fu">product</span><span class="op">(</span>b<span class="op">,</span> c<span class="op">))</span> <span class="op">==</span> <span class="fu">product</span><span class="op">(</span><span class="fu">product</span><span class="op">(</span>a<span class="op">,</span> b<span class="op">),</span> c<span class="op">)</span></span></code></pre></div>
    <h2 data-number="11.2" id="apply-syntax"><span class="header-section-number">11.2</span> Apply Syntax</h2>
    <p>Cats provides a convenient <em>apply syntax</em> that provides a
    shorthand for the methods described above. We import the syntax from
    <a href="http://typelevel.org/cats/api/cats/syntax/package$$semigroupal$"><code>cats.syntax.apply</code></a>.
    Here’s an example:</p>
    <div class="sourceCode" id="cb708"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb708-1"><a href="#cb708-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>option<span class="op">.</span>_ <span class="co">// for Semigroupal</span></span>
<span id="cb708-2"><a href="#cb708-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>apply<span class="op">.</span>_     <span class="co">// for tupled and mapN</span></span></code></pre></div>
    <p>The <code>tupled</code> method is implicitly added to the tuple
    of <code>Options</code>. It uses the <code>Semigroupal</code> for
    <code>Option</code> to zip the values inside the
    <code>Options</code>, creating a single <code>Option</code> of a
    tuple:</p>
    <div class="sourceCode" id="cb709"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb709-1"><a href="#cb709-1" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="ex">Option</span><span class="op">(</span><span class="dv">123</span><span class="op">),</span> <span class="ex">Option</span><span class="op">(</span><span class="st">&quot;abc&quot;</span><span class="op">)).</span>tupled</span>
<span id="cb709-2"><a href="#cb709-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res8: Option[Tuple2[Int, String]] = Some(value = (123, &quot;abc&quot;))</span></span></code></pre></div>
    <p>We can use the same trick on tuples of up to 22 values. Cats
    defines a separate <code>tupled</code> method for each arity:</p>
    <div class="sourceCode" id="cb710"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb710-1"><a href="#cb710-1" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="ex">Option</span><span class="op">(</span><span class="dv">123</span><span class="op">),</span> <span class="ex">Option</span><span class="op">(</span><span class="st">&quot;abc&quot;</span><span class="op">),</span> <span class="ex">Option</span><span class="op">(</span><span class="kw">true</span><span class="op">)).</span>tupled</span>
<span id="cb710-2"><a href="#cb710-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res9: Option[Tuple3[Int, String, Boolean]] = Some(</span></span>
<span id="cb710-3"><a href="#cb710-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   value = (123, &quot;abc&quot;, true)</span></span>
<span id="cb710-4"><a href="#cb710-4" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>In addition to <code>tupled</code>, Cats’ apply syntax provides a
    method called <code>mapN</code> that accepts an implicit
    <code>Functor</code> and a function of the correct arity to combine
    the values.</p>
    <div class="sourceCode" id="cb711"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb711-1"><a href="#cb711-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">Cat</span><span class="op">(</span>name<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> born<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> color<span class="op">:</span> <span class="ex">String</span><span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb712"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb712-1"><a href="#cb712-1" aria-hidden="true" tabindex="-1"></a><span class="op">(</span></span>
<span id="cb712-2"><a href="#cb712-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Option</span><span class="op">(</span><span class="st">&quot;Garfield&quot;</span><span class="op">),</span></span>
<span id="cb712-3"><a href="#cb712-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Option</span><span class="op">(</span><span class="dv">1978</span><span class="op">),</span></span>
<span id="cb712-4"><a href="#cb712-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Option</span><span class="op">(</span><span class="st">&quot;Orange &amp; black&quot;</span><span class="op">)</span></span>
<span id="cb712-5"><a href="#cb712-5" aria-hidden="true" tabindex="-1"></a><span class="op">).</span><span class="fu">mapN</span><span class="op">(</span>Cat<span class="op">.</span>apply<span class="op">)</span></span>
<span id="cb712-6"><a href="#cb712-6" aria-hidden="true" tabindex="-1"></a><span class="co">// res10: Option[Cat] = Some(</span></span>
<span id="cb712-7"><a href="#cb712-7" aria-hidden="true" tabindex="-1"></a><span class="co">//   value = Cat(name = &quot;Garfield&quot;, born = 1978, color = &quot;Orange &amp; black&quot;)</span></span>
<span id="cb712-8"><a href="#cb712-8" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>Of all the methods mentioned here, it is most common to use
    <code>mapN</code>.</p>
    <p>Internally <code>mapN</code> uses the <code>Semigroupal</code> to
    extract the values from the <code>Option</code> and the
    <code>Functor</code> to apply the values to the function.</p>
    <p>It’s nice to see that this syntax is type checked. If we supply a
    function that accepts the wrong number or types of parameters, we
    get a compile error:</p>
    <div class="sourceCode" id="cb713"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb713-1"><a href="#cb713-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> add<span class="op">:</span> <span class="op">(</span><span class="bu">Int</span><span class="op">,</span> <span class="bu">Int</span><span class="op">)</span> <span class="op">=&gt;</span> <span class="bu">Int</span> <span class="op">=</span> <span class="op">(</span>a<span class="op">,</span> b<span class="op">)</span> <span class="op">=&gt;</span> a <span class="op">+</span> b</span>
<span id="cb713-2"><a href="#cb713-2" aria-hidden="true" tabindex="-1"></a><span class="co">// add: Function2[Int, Int, Int] = repl.MdocSession$MdocApp0$$$Lambda/0x00007fcce2c7e000@41a3dbaa</span></span></code></pre></div>
    <div class="sourceCode" id="cb714"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb714-1"><a href="#cb714-1" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="ex">Option</span><span class="op">(</span><span class="dv">1</span><span class="op">),</span> <span class="ex">Option</span><span class="op">(</span><span class="dv">2</span><span class="op">),</span> <span class="ex">Option</span><span class="op">(</span><span class="dv">3</span><span class="op">)).</span><span class="fu">mapN</span><span class="op">(</span>add<span class="op">)</span></span>
<span id="cb714-2"><a href="#cb714-2" aria-hidden="true" tabindex="-1"></a><span class="co">// error: </span></span>
<span id="cb714-3"><a href="#cb714-3" aria-hidden="true" tabindex="-1"></a><span class="co">// &#39;:&#39; expected, but &#39;(&#39; found</span></span>
<span id="cb714-4"><a href="#cb714-4" aria-hidden="true" tabindex="-1"></a><span class="co">// error: </span></span>
<span id="cb714-5"><a href="#cb714-5" aria-hidden="true" tabindex="-1"></a><span class="co">// &#39;:&#39; expected, but &#39;(&#39; found</span></span>
<span id="cb714-6"><a href="#cb714-6" aria-hidden="true" tabindex="-1"></a><span class="co">// error: </span></span>
<span id="cb714-7"><a href="#cb714-7" aria-hidden="true" tabindex="-1"></a><span class="co">// &#39;:&#39; expected, but &#39;(&#39; found</span></span>
<span id="cb714-8"><a href="#cb714-8" aria-hidden="true" tabindex="-1"></a><span class="co">// error: </span></span>
<span id="cb714-9"><a href="#cb714-9" aria-hidden="true" tabindex="-1"></a><span class="co">// end of statement expected but &#39;.&#39; found</span></span>
<span id="cb714-10"><a href="#cb714-10" aria-hidden="true" tabindex="-1"></a><span class="co">// error: </span></span>
<span id="cb714-11"><a href="#cb714-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Found:    (repl.MdocSession.MdocApp0.add : (Int, Int) =&gt; Int)</span></span>
<span id="cb714-12"><a href="#cb714-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Required: (Int, Int, Int) =&gt; Any</span></span></code></pre></div>
    <div class="sourceCode" id="cb715"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb715-1"><a href="#cb715-1" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="ex">Option</span><span class="op">(</span><span class="st">&quot;cats&quot;</span><span class="op">),</span> <span class="ex">Option</span><span class="op">(</span><span class="kw">true</span><span class="op">)).</span><span class="fu">mapN</span><span class="op">(</span>add<span class="op">)</span></span>
<span id="cb715-2"><a href="#cb715-2" aria-hidden="true" tabindex="-1"></a><span class="co">// error: </span></span>
<span id="cb715-3"><a href="#cb715-3" aria-hidden="true" tabindex="-1"></a><span class="co">// &#39;:&#39; expected, but &#39;(&#39; found</span></span>
<span id="cb715-4"><a href="#cb715-4" aria-hidden="true" tabindex="-1"></a><span class="co">// error: </span></span>
<span id="cb715-5"><a href="#cb715-5" aria-hidden="true" tabindex="-1"></a><span class="co">// &#39;:&#39; expected, but &#39;(&#39; found</span></span>
<span id="cb715-6"><a href="#cb715-6" aria-hidden="true" tabindex="-1"></a><span class="co">// error: </span></span>
<span id="cb715-7"><a href="#cb715-7" aria-hidden="true" tabindex="-1"></a><span class="co">// &#39;:&#39; expected, but &#39;(&#39; found</span></span>
<span id="cb715-8"><a href="#cb715-8" aria-hidden="true" tabindex="-1"></a><span class="co">// error: </span></span>
<span id="cb715-9"><a href="#cb715-9" aria-hidden="true" tabindex="-1"></a><span class="co">// end of statement expected but &#39;.&#39; found</span></span>
<span id="cb715-10"><a href="#cb715-10" aria-hidden="true" tabindex="-1"></a><span class="co">// error:</span></span>
<span id="cb715-11"><a href="#cb715-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Found:    (repl.MdocSession.MdocApp0.add : (Int, Int) =&gt; Int)</span></span>
<span id="cb715-12"><a href="#cb715-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Required: (String, Boolean) =&gt; Any</span></span>
<span id="cb715-13"><a href="#cb715-13" aria-hidden="true" tabindex="-1"></a><span class="co">// (Option(&quot;cats&quot;), Option(true)).mapN(add)</span></span>
<span id="cb715-14"><a href="#cb715-14" aria-hidden="true" tabindex="-1"></a><span class="co">//                                     ^^^</span></span></code></pre></div>
    <h3 data-number="11.2.1" id="fancy-functors-and-apply-syntax"><span class="header-section-number">11.2.1</span> Fancy Functors and Apply
    Syntax</h3>
    <p>Apply syntax also has <code>contramapN</code> and
    <code>imapN</code> methods that accept Contravariant and Invariant
    functors (Section 8.6). For example, we can combine
    <code>Monoids</code> using <code>Invariant</code>. Here’s an
    example:</p>
    <div class="sourceCode" id="cb716"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb716-1"><a href="#cb716-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Monoid</span>
<span id="cb716-2"><a href="#cb716-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span><span class="dt">int</span><span class="op">.</span>_        <span class="co">// for Monoid</span></span>
<span id="cb716-3"><a href="#cb716-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>invariant<span class="op">.</span>_  <span class="co">// for Semigroupal</span></span>
<span id="cb716-4"><a href="#cb716-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>list<span class="op">.</span>_       <span class="co">// for Monoid</span></span>
<span id="cb716-5"><a href="#cb716-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>string<span class="op">.</span>_     <span class="co">// for Monoid</span></span>
<span id="cb716-6"><a href="#cb716-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>apply<span class="op">.</span>_         <span class="co">// for imapN</span></span>
<span id="cb716-7"><a href="#cb716-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb716-8"><a href="#cb716-8" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">Cat</span><span class="op">(</span></span>
<span id="cb716-9"><a href="#cb716-9" aria-hidden="true" tabindex="-1"></a>  name<span class="op">:</span> <span class="ex">String</span><span class="op">,</span></span>
<span id="cb716-10"><a href="#cb716-10" aria-hidden="true" tabindex="-1"></a>  yearOfBirth<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span></span>
<span id="cb716-11"><a href="#cb716-11" aria-hidden="true" tabindex="-1"></a>  favoriteFoods<span class="op">:</span> <span class="ex">List</span><span class="op">[</span><span class="ex">String</span><span class="op">]</span></span>
<span id="cb716-12"><a href="#cb716-12" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb716-13"><a href="#cb716-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb716-14"><a href="#cb716-14" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> tupleToCat<span class="op">:</span> <span class="op">(</span><span class="ex">String</span><span class="op">,</span> <span class="bu">Int</span><span class="op">,</span> <span class="ex">List</span><span class="op">[</span><span class="ex">String</span><span class="op">])</span> <span class="op">=&gt;</span> Cat <span class="op">=</span></span>
<span id="cb716-15"><a href="#cb716-15" aria-hidden="true" tabindex="-1"></a>  Cat<span class="op">.</span>apply _</span>
<span id="cb716-16"><a href="#cb716-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb716-17"><a href="#cb716-17" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> catToTuple<span class="op">:</span> Cat <span class="op">=&gt;</span> <span class="op">(</span><span class="ex">String</span><span class="op">,</span> <span class="bu">Int</span><span class="op">,</span> <span class="ex">List</span><span class="op">[</span><span class="ex">String</span><span class="op">])</span> <span class="op">=</span></span>
<span id="cb716-18"><a href="#cb716-18" aria-hidden="true" tabindex="-1"></a>  cat <span class="op">=&gt;</span> <span class="op">(</span>cat<span class="op">.</span>name<span class="op">,</span> cat<span class="op">.</span>yearOfBirth<span class="op">,</span> cat<span class="op">.</span>favoriteFoods<span class="op">)</span></span>
<span id="cb716-19"><a href="#cb716-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb716-20"><a href="#cb716-20" aria-hidden="true" tabindex="-1"></a><span class="kw">implicit</span> <span class="kw">val</span> catMonoid<span class="op">:</span> Monoid<span class="op">[</span>Cat<span class="op">]</span> <span class="op">=</span> <span class="op">(</span></span>
<span id="cb716-21"><a href="#cb716-21" aria-hidden="true" tabindex="-1"></a>  Monoid<span class="op">[</span><span class="ex">String</span><span class="op">],</span></span>
<span id="cb716-22"><a href="#cb716-22" aria-hidden="true" tabindex="-1"></a>  Monoid<span class="op">[</span><span class="bu">Int</span><span class="op">],</span></span>
<span id="cb716-23"><a href="#cb716-23" aria-hidden="true" tabindex="-1"></a>  Monoid<span class="op">[</span><span class="ex">List</span><span class="op">[</span><span class="ex">String</span><span class="op">]]</span></span>
<span id="cb716-24"><a href="#cb716-24" aria-hidden="true" tabindex="-1"></a><span class="op">).</span><span class="fu">imapN</span><span class="op">(</span>tupleToCat<span class="op">)(</span>catToTuple<span class="op">)</span></span></code></pre></div>
    <p>Our <code>Monoid</code> allows us to create “empty”
    <code>Cats</code>, and add <code>Cats</code> together using the
    syntax from Chapter 7:</p>
    <div class="sourceCode" id="cb717"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb717-1"><a href="#cb717-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>semigroup<span class="op">.</span>_ <span class="co">// for |+|</span></span>
<span id="cb717-2"><a href="#cb717-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb717-3"><a href="#cb717-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> garfield   <span class="op">=</span> <span class="fu">Cat</span><span class="op">(</span><span class="st">&quot;Garfield&quot;</span><span class="op">,</span> <span class="dv">1978</span><span class="op">,</span> <span class="ex">List</span><span class="op">(</span><span class="st">&quot;Lasagne&quot;</span><span class="op">))</span></span>
<span id="cb717-4"><a href="#cb717-4" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> heathcliff <span class="op">=</span> <span class="fu">Cat</span><span class="op">(</span><span class="st">&quot;Heathcliff&quot;</span><span class="op">,</span> <span class="dv">1988</span><span class="op">,</span> <span class="ex">List</span><span class="op">(</span><span class="st">&quot;Junk Food&quot;</span><span class="op">))</span></span></code></pre></div>
    <div class="sourceCode" id="cb718"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb718-1"><a href="#cb718-1" aria-hidden="true" tabindex="-1"></a>garfield <span class="op">|+|</span> heathcliff</span>
<span id="cb718-2"><a href="#cb718-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res14: Cat = Cat(</span></span>
<span id="cb718-3"><a href="#cb718-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   name = &quot;GarfieldHeathcliff&quot;,</span></span>
<span id="cb718-4"><a href="#cb718-4" aria-hidden="true" tabindex="-1"></a><span class="co">//   yearOfBirth = 3966,</span></span>
<span id="cb718-5"><a href="#cb718-5" aria-hidden="true" tabindex="-1"></a><span class="co">//   favoriteFoods = List(&quot;Lasagne&quot;, &quot;Junk Food&quot;)</span></span>
<span id="cb718-6"><a href="#cb718-6" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <h2 data-number="11.3" id="semigroupal-applied-to-different-types"><span class="header-section-number">11.3</span> Semigroupal Applied to
    Different Types</h2>
    <p><code>Semigroupal</code> doesn’t always provide the behaviour we
    expect, particularly for types that also have instances of
    <code>Monad</code>. We have seen the behaviour of the
    <code>Semigroupal</code> for <code>Option</code>. Let’s look at some
    examples for other types.</p>
    <p><strong>Future</strong></p>
    <p>The semantics for <code>Future</code> provide parallel as opposed
    to sequential execution:</p>
    <div class="sourceCode" id="cb719"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb719-1"><a href="#cb719-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Semigroupal</span>
<span id="cb719-2"><a href="#cb719-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>future<span class="op">.</span>_ <span class="co">// for Semigroupal</span></span>
<span id="cb719-3"><a href="#cb719-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span>_</span>
<span id="cb719-4"><a href="#cb719-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span>duration<span class="op">.</span>_</span>
<span id="cb719-5"><a href="#cb719-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span>ExecutionContext<span class="op">.</span>Implicits<span class="op">.</span>global</span>
<span id="cb719-6"><a href="#cb719-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb719-7"><a href="#cb719-7" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> futurePair <span class="op">=</span> Semigroupal<span class="op">[</span><span class="ex">Future</span><span class="op">].</span></span>
<span id="cb719-8"><a href="#cb719-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">product</span><span class="op">(</span><span class="ex">Future</span><span class="op">(</span><span class="st">&quot;Hello&quot;</span><span class="op">),</span> <span class="ex">Future</span><span class="op">(</span><span class="dv">123</span><span class="op">))</span></span></code></pre></div>
    <div class="sourceCode" id="cb720"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb720-1"><a href="#cb720-1" aria-hidden="true" tabindex="-1"></a>Await<span class="op">.</span><span class="fu">result</span><span class="op">(</span>futurePair<span class="op">,</span> <span class="fl">1.</span>second<span class="op">)</span></span>
<span id="cb720-2"><a href="#cb720-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res0: Tuple2[String, Int] = (&quot;Hello&quot;, 123)</span></span></code></pre></div>
    <p>The two <code>Futures</code> start executing the moment we create
    them, so they are already calculating results by the time we call
    <code>product</code>. We can use apply syntax to zip fixed numbers
    of <code>Futures</code>:</p>
    <div class="sourceCode" id="cb721"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb721-1"><a href="#cb721-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>apply<span class="op">.</span>_ <span class="co">// for mapN</span></span>
<span id="cb721-2"><a href="#cb721-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb721-3"><a href="#cb721-3" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">Cat</span><span class="op">(</span></span>
<span id="cb721-4"><a href="#cb721-4" aria-hidden="true" tabindex="-1"></a>  name<span class="op">:</span> <span class="ex">String</span><span class="op">,</span></span>
<span id="cb721-5"><a href="#cb721-5" aria-hidden="true" tabindex="-1"></a>  yearOfBirth<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span></span>
<span id="cb721-6"><a href="#cb721-6" aria-hidden="true" tabindex="-1"></a>  favoriteFoods<span class="op">:</span> <span class="ex">List</span><span class="op">[</span><span class="ex">String</span><span class="op">]</span></span>
<span id="cb721-7"><a href="#cb721-7" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb721-8"><a href="#cb721-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb721-9"><a href="#cb721-9" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> futureCat <span class="op">=</span> <span class="op">(</span></span>
<span id="cb721-10"><a href="#cb721-10" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Future</span><span class="op">(</span><span class="st">&quot;Garfield&quot;</span><span class="op">),</span></span>
<span id="cb721-11"><a href="#cb721-11" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Future</span><span class="op">(</span><span class="dv">1978</span><span class="op">),</span></span>
<span id="cb721-12"><a href="#cb721-12" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Future</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="st">&quot;Lasagne&quot;</span><span class="op">))</span></span>
<span id="cb721-13"><a href="#cb721-13" aria-hidden="true" tabindex="-1"></a><span class="op">).</span><span class="fu">mapN</span><span class="op">(</span>Cat<span class="op">.</span>apply<span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb722"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb722-1"><a href="#cb722-1" aria-hidden="true" tabindex="-1"></a>Await<span class="op">.</span><span class="fu">result</span><span class="op">(</span>futureCat<span class="op">,</span> <span class="fl">1.</span>second<span class="op">)</span></span>
<span id="cb722-2"><a href="#cb722-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: Cat = Cat(</span></span>
<span id="cb722-3"><a href="#cb722-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   name = &quot;Garfield&quot;,</span></span>
<span id="cb722-4"><a href="#cb722-4" aria-hidden="true" tabindex="-1"></a><span class="co">//   yearOfBirth = 1978,</span></span>
<span id="cb722-5"><a href="#cb722-5" aria-hidden="true" tabindex="-1"></a><span class="co">//   favoriteFoods = List(&quot;Lasagne&quot;)</span></span>
<span id="cb722-6"><a href="#cb722-6" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p><strong>List</strong></p>
    <p>Combining <code>Lists</code> with <code>Semigroupal</code>
    produces some potentially unexpected results. We might expect code
    like the following to <em>zip</em> the lists, but we actually get
    the cartesian product of their elements:</p>
    <div class="sourceCode" id="cb723"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb723-1"><a href="#cb723-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Semigroupal</span>
<span id="cb723-2"><a href="#cb723-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>list<span class="op">.</span>_ <span class="co">// for Semigroupal</span></span></code></pre></div>
    <div class="sourceCode" id="cb724"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb724-1"><a href="#cb724-1" aria-hidden="true" tabindex="-1"></a>Semigroupal<span class="op">[</span><span class="ex">List</span><span class="op">].</span><span class="fu">product</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">),</span> <span class="ex">List</span><span class="op">(</span><span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">))</span></span>
<span id="cb724-2"><a href="#cb724-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: List[Tuple2[Int, Int]] = List((1, 3), (1, 4), (2, 3), (2, 4))</span></span></code></pre></div>
    <p>This is perhaps surprising. Zipping lists tends to be a more
    common operation. We’ll see why we get this behaviour in a
    moment.</p>
    <p><strong>Either</strong></p>
    <p>We opened this chapter with a discussion of fail-fast versus
    accumulating error-handling. We might expect <code>product</code>
    applied to <code>Either</code> to accumulate errors instead of fail
    fast. Again, perhaps surprisingly, we find that <code>product</code>
    implements the same fail-fast behaviour as <code>flatMap</code>:</p>
    <div class="sourceCode" id="cb725"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb725-1"><a href="#cb725-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>either<span class="op">.</span>_ <span class="co">// for Semigroupal</span></span>
<span id="cb725-2"><a href="#cb725-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb725-3"><a href="#cb725-3" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> ErrorOr<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> Either<span class="op">[</span><span class="ex">Vector</span><span class="op">[</span><span class="ex">String</span><span class="op">],</span> A<span class="op">]</span></span></code></pre></div>
    <div class="sourceCode" id="cb726"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb726-1"><a href="#cb726-1" aria-hidden="true" tabindex="-1"></a>Semigroupal<span class="op">[</span>ErrorOr<span class="op">].</span><span class="fu">product</span><span class="op">(</span></span>
<span id="cb726-2"><a href="#cb726-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Left</span><span class="op">(</span><span class="ex">Vector</span><span class="op">(</span><span class="st">&quot;Error 1&quot;</span><span class="op">)),</span></span>
<span id="cb726-3"><a href="#cb726-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Left</span><span class="op">(</span><span class="ex">Vector</span><span class="op">(</span><span class="st">&quot;Error 2&quot;</span><span class="op">))</span></span>
<span id="cb726-4"><a href="#cb726-4" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb726-5"><a href="#cb726-5" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: Either[Vector[String], Tuple2[Nothing, Nothing]] = Left(</span></span>
<span id="cb726-6"><a href="#cb726-6" aria-hidden="true" tabindex="-1"></a><span class="co">//   value = Vector(&quot;Error 1&quot;)</span></span>
<span id="cb726-7"><a href="#cb726-7" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>In this example <code>product</code> sees the first failure and
    stops, even though it is possible to examine the second parameter
    and see that it is also a failure.</p>
    <h3 data-number="11.3.1" id="semigroupal-applied-to-monads"><span class="header-section-number">11.3.1</span> Semigroupal Applied to
    Monads</h3>
    <p>The reason for the surprising results for <code>List</code> and
    <code>Either</code> is that they are both monads. If we have a monad
    we can implement <code>product</code> as follows.</p>
    <div class="sourceCode" id="cb727"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb727-1"><a href="#cb727-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Monad</span>
<span id="cb727-2"><a href="#cb727-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>functor<span class="op">.</span>_ <span class="co">// for map</span></span>
<span id="cb727-3"><a href="#cb727-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>flatMap<span class="op">.</span>_ <span class="co">// for flatmap</span></span>
<span id="cb727-4"><a href="#cb727-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb727-5"><a href="#cb727-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> product<span class="op">[</span>F<span class="op">[</span>_<span class="op">]:</span> Monad<span class="op">,</span> A<span class="op">,</span> B<span class="op">](</span>fa<span class="op">:</span> F<span class="op">[</span>A<span class="op">],</span> fb<span class="op">:</span> F<span class="op">[</span>B<span class="op">]):</span> F<span class="op">[(</span>A<span class="op">,</span>B<span class="op">)]</span> <span class="op">=</span></span>
<span id="cb727-6"><a href="#cb727-6" aria-hidden="true" tabindex="-1"></a>  fa<span class="op">.</span><span class="fu">flatMap</span><span class="op">(</span>a <span class="op">=&gt;</span> </span>
<span id="cb727-7"><a href="#cb727-7" aria-hidden="true" tabindex="-1"></a>    fb<span class="op">.</span><span class="fu">map</span><span class="op">(</span>b <span class="op">=&gt;</span></span>
<span id="cb727-8"><a href="#cb727-8" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>a<span class="op">,</span> b<span class="op">)</span></span>
<span id="cb727-9"><a href="#cb727-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span></span>
<span id="cb727-10"><a href="#cb727-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">)</span></span></code></pre></div>
    <p>It would be very strange if we had different semantics for
    <code>product</code> depending on how we implemented it. To ensure
    consistent semantics, Cats’ <code>Monad</code> (which extends
    <code>Semigroupal</code>) provides a standard definition of
    <code>product</code> in terms of <code>map</code> and
    <code>flatMap</code> as we showed above.</p>
    <p>Even our results for <code>Future</code> are a trick of the
    light. <code>flatMap</code> provides sequential ordering, so
    <code>product</code> provides the same. The parallel execution we
    observe occurs because our constituent <code>Futures</code> start
    running before we call <code>product</code>. This is equivalent to
    the classic create-then-flatMap pattern:</p>
    <div class="sourceCode" id="cb728"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb728-1"><a href="#cb728-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> a <span class="op">=</span> <span class="ex">Future</span><span class="op">(</span><span class="st">&quot;Future 1&quot;</span><span class="op">)</span></span>
<span id="cb728-2"><a href="#cb728-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> b <span class="op">=</span> <span class="ex">Future</span><span class="op">(</span><span class="st">&quot;Future 2&quot;</span><span class="op">)</span></span>
<span id="cb728-3"><a href="#cb728-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb728-4"><a href="#cb728-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">{</span></span>
<span id="cb728-5"><a href="#cb728-5" aria-hidden="true" tabindex="-1"></a>  x <span class="op">&lt;-</span> a</span>
<span id="cb728-6"><a href="#cb728-6" aria-hidden="true" tabindex="-1"></a>  y <span class="op">&lt;-</span> b</span>
<span id="cb728-7"><a href="#cb728-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">yield</span> <span class="op">(</span>x<span class="op">,</span> y<span class="op">)</span></span></code></pre></div>
    <p>So why bother with <code>Semigroupal</code> at all? The answer is
    that we can create useful data types that have instances of
    <code>Semigroupal</code> (and <code>Applicative</code>) but not
    <code>Monad</code>. This frees us to implement <code>product</code>
    in different ways. We’ll examine this further in a moment when we
    look at an alternative data type for error handling.</p>
    <h4 data-number="11.3.1.1" id="exercise-the-product-of-lists"><span class="header-section-number">11.3.1.1</span> Exercise: The Product
    of Lists</h4>
    <p>Why does <code>product</code> for <code>List</code> produce the
    Cartesian product? We saw an example above. Here it is again.</p>
    <div class="sourceCode" id="cb729"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb729-1"><a href="#cb729-1" aria-hidden="true" tabindex="-1"></a>Semigroupal<span class="op">[</span><span class="ex">List</span><span class="op">].</span><span class="fu">product</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">),</span> <span class="ex">List</span><span class="op">(</span><span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">))</span></span>
<span id="cb729-2"><a href="#cb729-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: List[Tuple2[Int, Int]] = List((1, 3), (1, 4), (2, 3), (2, 4))</span></span></code></pre></div>
    <p>We can also write this in terms of <code>tupled</code>.</p>
    <div class="sourceCode" id="cb730"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb730-1"><a href="#cb730-1" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">),</span> <span class="ex">List</span><span class="op">(</span><span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">)).</span>tupled</span>
<span id="cb730-2"><a href="#cb730-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res6: List[Tuple2[Int, Int]] = List((1, 3), (1, 4), (2, 3), (2, 4))</span></span></code></pre></div>
    <div class="solution">
    <p>This exercise is checking that you understood the definition of
    <code>product</code> in terms of <code>flatMap</code> and
    <code>map</code>.</p>
    <div class="sourceCode" id="cb731"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb731-1"><a href="#cb731-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>functor<span class="op">.</span>_ <span class="co">// for map</span></span>
<span id="cb731-2"><a href="#cb731-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>flatMap<span class="op">.</span>_ <span class="co">// for flatMap</span></span>
<span id="cb731-3"><a href="#cb731-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb731-4"><a href="#cb731-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> product<span class="op">[</span>F<span class="op">[</span>_<span class="op">]:</span> Monad<span class="op">,</span> A<span class="op">,</span> B<span class="op">](</span>x<span class="op">:</span> F<span class="op">[</span>A<span class="op">],</span> y<span class="op">:</span> F<span class="op">[</span>B<span class="op">]):</span> F<span class="op">[(</span>A<span class="op">,</span> B<span class="op">)]</span> <span class="op">=</span></span>
<span id="cb731-5"><a href="#cb731-5" aria-hidden="true" tabindex="-1"></a>  x<span class="op">.</span><span class="fu">flatMap</span><span class="op">(</span>a <span class="op">=&gt;</span> y<span class="op">.</span><span class="fu">map</span><span class="op">(</span>b <span class="op">=&gt;</span> <span class="op">(</span>a<span class="op">,</span> b<span class="op">)))</span></span></code></pre></div>
    <p>This code is equivalent to a for comprehension:</p>
    <div class="sourceCode" id="cb732"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb732-1"><a href="#cb732-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> product<span class="op">[</span>F<span class="op">[</span>_<span class="op">]:</span> Monad<span class="op">,</span> A<span class="op">,</span> B<span class="op">](</span>x<span class="op">:</span> F<span class="op">[</span>A<span class="op">],</span> y<span class="op">:</span> F<span class="op">[</span>B<span class="op">]):</span> F<span class="op">[(</span>A<span class="op">,</span> B<span class="op">)]</span> <span class="op">=</span></span>
<span id="cb732-2"><a href="#cb732-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb732-3"><a href="#cb732-3" aria-hidden="true" tabindex="-1"></a>    a <span class="op">&lt;-</span> x</span>
<span id="cb732-4"><a href="#cb732-4" aria-hidden="true" tabindex="-1"></a>    b <span class="op">&lt;-</span> y</span>
<span id="cb732-5"><a href="#cb732-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">yield</span> <span class="op">(</span>a<span class="op">,</span> b<span class="op">)</span></span></code></pre></div>
    <p>The semantics of <code>flatMap</code> are what give rise to the
    behaviour for <code>List</code> and <code>Either</code>:</p>
    <div class="sourceCode" id="cb733"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb733-1"><a href="#cb733-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>list<span class="op">.</span>_ <span class="co">// for Semigroupal</span></span></code></pre></div>
    <div class="sourceCode" id="cb734"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb734-1"><a href="#cb734-1" aria-hidden="true" tabindex="-1"></a><span class="fu">product</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">),</span> <span class="ex">List</span><span class="op">(</span><span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">))</span></span>
<span id="cb734-2"><a href="#cb734-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res9: List[Tuple2[Int, Int]] = List((1, 3), (1, 4), (2, 3), (2, 4))</span></span></code></pre></div>
    </div>
    <h2 data-number="11.4" id="parallel"><span class="header-section-number">11.4</span> Parallel</h2>
    <p>In the previous section we saw that when call
    <code>product</code> on a type that has a <code>Monad</code>
    instance we get sequential semantics. This makes sense from the
    point-of-view of keeping consistency with implementations of
    <code>product</code> in terms of <code>flatMap</code> and
    <code>map</code>. However it’s not always what we want. The
    <code>Parallel</code> type class, and its associated syntax, allows
    us to access alternate semantics for certain monads.</p>
    <p>We’ve seen how the <code>product</code> method on
    <code>Either</code> stops at the first error.</p>
    <div class="sourceCode" id="cb735"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb735-1"><a href="#cb735-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Semigroupal</span>
<span id="cb735-2"><a href="#cb735-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>either<span class="op">.</span>_ <span class="co">// for Semigroupal</span></span>
<span id="cb735-3"><a href="#cb735-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb735-4"><a href="#cb735-4" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> ErrorOr<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> Either<span class="op">[</span><span class="ex">Vector</span><span class="op">[</span><span class="ex">String</span><span class="op">],</span> A<span class="op">]</span></span>
<span id="cb735-5"><a href="#cb735-5" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> error1<span class="op">:</span> ErrorOr<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span> <span class="fu">Left</span><span class="op">(</span><span class="ex">Vector</span><span class="op">(</span><span class="st">&quot;Error 1&quot;</span><span class="op">))</span></span>
<span id="cb735-6"><a href="#cb735-6" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> error2<span class="op">:</span> ErrorOr<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span> <span class="fu">Left</span><span class="op">(</span><span class="ex">Vector</span><span class="op">(</span><span class="st">&quot;Error 2&quot;</span><span class="op">))</span></span></code></pre></div>
    <div class="sourceCode" id="cb736"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb736-1"><a href="#cb736-1" aria-hidden="true" tabindex="-1"></a>Semigroupal<span class="op">[</span>ErrorOr<span class="op">].</span><span class="fu">product</span><span class="op">(</span>error1<span class="op">,</span> error2<span class="op">)</span></span>
<span id="cb736-2"><a href="#cb736-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res0: Either[Vector[String], Tuple2[Int, Int]] = Left(</span></span>
<span id="cb736-3"><a href="#cb736-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   value = Vector(&quot;Error 1&quot;)</span></span>
<span id="cb736-4"><a href="#cb736-4" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>We can also write this using <code>tupled</code> as a
    short-cut.</p>
    <div class="sourceCode" id="cb737"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb737-1"><a href="#cb737-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>apply<span class="op">.</span>_ <span class="co">// for tupled</span></span>
<span id="cb737-2"><a href="#cb737-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>vector<span class="op">.</span>_ <span class="co">// for Semigroup on Vector</span></span></code></pre></div>
    <div class="sourceCode" id="cb738"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb738-1"><a href="#cb738-1" aria-hidden="true" tabindex="-1"></a><span class="op">(</span>error1<span class="op">,</span> error2<span class="op">).</span>tupled</span>
<span id="cb738-2"><a href="#cb738-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: Either[Vector[String], Tuple2[Int, Int]] = Left(</span></span>
<span id="cb738-3"><a href="#cb738-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   value = Vector(&quot;Error 1&quot;)</span></span>
<span id="cb738-4"><a href="#cb738-4" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>To collect all the errors we simply replace <code>tupled</code>
    with its “parallel” version called <code>parTupled</code>.</p>
    <div class="sourceCode" id="cb739"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb739-1"><a href="#cb739-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>parallel<span class="op">.</span>_ <span class="co">// for parTupled</span></span></code></pre></div>
    <div class="sourceCode" id="cb740"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb740-1"><a href="#cb740-1" aria-hidden="true" tabindex="-1"></a><span class="op">(</span>error1<span class="op">,</span> error2<span class="op">).</span>parTupled</span>
<span id="cb740-2"><a href="#cb740-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: Either[Vector[String], Tuple2[Int, Int]] = Left(</span></span>
<span id="cb740-3"><a href="#cb740-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   value = Vector(&quot;Error 1&quot;, &quot;Error 2&quot;)</span></span>
<span id="cb740-4"><a href="#cb740-4" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>Notice that both errors are returned! This behaviour is not
    special to using <code>Vector</code> as the error type. Any type
    that has a <code>Semigroup</code> instance will work. For example,
    here we use <code>List</code> instead.</p>
    <div class="sourceCode" id="cb741"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb741-1"><a href="#cb741-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>list<span class="op">.</span>_ <span class="co">// for Semigroup on List</span></span>
<span id="cb741-2"><a href="#cb741-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb741-3"><a href="#cb741-3" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> ErrorOrList<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> Either<span class="op">[</span><span class="ex">List</span><span class="op">[</span><span class="ex">String</span><span class="op">],</span> A<span class="op">]</span></span>
<span id="cb741-4"><a href="#cb741-4" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> errStr1<span class="op">:</span> ErrorOrList<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span> <span class="fu">Left</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="st">&quot;error 1&quot;</span><span class="op">))</span></span>
<span id="cb741-5"><a href="#cb741-5" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> errStr2<span class="op">:</span> ErrorOrList<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span> <span class="fu">Left</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="st">&quot;error 2&quot;</span><span class="op">))</span></span></code></pre></div>
    <div class="sourceCode" id="cb742"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb742-1"><a href="#cb742-1" aria-hidden="true" tabindex="-1"></a><span class="op">(</span>errStr1<span class="op">,</span> errStr2<span class="op">).</span>parTupled</span>
<span id="cb742-2"><a href="#cb742-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: Either[List[String], Tuple2[Int, Int]] = Left(</span></span>
<span id="cb742-3"><a href="#cb742-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   value = List(&quot;error 1&quot;, &quot;error 2&quot;)</span></span>
<span id="cb742-4"><a href="#cb742-4" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>There are many syntax methods provided by <code>Parallel</code>
    for methods on <code>Semigroupal</code> and related types, but the
    most commonly used is <code>parMapN</code>. Here’s an example of
    <code>parMapN</code> in an error handling situation.</p>
    <div class="sourceCode" id="cb743"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb743-1"><a href="#cb743-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> success1<span class="op">:</span> ErrorOr<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span> <span class="fu">Right</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb743-2"><a href="#cb743-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> success2<span class="op">:</span> ErrorOr<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span> <span class="fu">Right</span><span class="op">(</span><span class="dv">2</span><span class="op">)</span></span>
<span id="cb743-3"><a href="#cb743-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> addTwo <span class="op">=</span> <span class="op">(</span>x<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> y<span class="op">:</span> <span class="bu">Int</span><span class="op">)</span> <span class="op">=&gt;</span> x <span class="op">+</span> y</span></code></pre></div>
    <div class="sourceCode" id="cb744"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb744-1"><a href="#cb744-1" aria-hidden="true" tabindex="-1"></a><span class="op">(</span>error1<span class="op">,</span> error2<span class="op">).</span><span class="fu">parMapN</span><span class="op">(</span>addTwo<span class="op">)</span></span>
<span id="cb744-2"><a href="#cb744-2" aria-hidden="true" tabindex="-1"></a><span class="op">(</span>success1<span class="op">,</span> success2<span class="op">).</span><span class="fu">parMapN</span><span class="op">(</span>addTwo<span class="op">)</span></span>
<span id="cb744-3"><a href="#cb744-3" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: Either[Vector[String], Int] = Right(value = 3)</span></span></code></pre></div>
    <p>Let’s dig into how <code>Parallel</code> works. The definition
    below is the core of <code>Parallel</code>.</p>
    <div class="sourceCode" id="cb745"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb745-1"><a href="#cb745-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Parallel<span class="op">[</span>M<span class="op">[</span>_<span class="op">]]</span> <span class="op">{</span></span>
<span id="cb745-2"><a href="#cb745-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">type</span> F<span class="op">[</span>_<span class="op">]</span></span>
<span id="cb745-3"><a href="#cb745-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb745-4"><a href="#cb745-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> applicative<span class="op">:</span> Applicative<span class="op">[</span>F<span class="op">]</span></span>
<span id="cb745-5"><a href="#cb745-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> monad<span class="op">:</span> Monad<span class="op">[</span>M<span class="op">]</span></span>
<span id="cb745-6"><a href="#cb745-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> parallel<span class="op">:</span> <span class="op">~&gt;[</span>M<span class="op">,</span> F<span class="op">]</span></span>
<span id="cb745-7"><a href="#cb745-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>This tells us if there is a <code>Parallel</code> instance for
    some type constructor <code>M</code> then:</p>
    <ul>
    <li>there must be a <code>Monad</code> instance for
    <code>M</code>;</li>
    <li>there is a related type constructor <code>F</code> that has an
    <code>Applicative</code> instance; and</li>
    <li>we can convert <code>M</code> to <code>F</code>.</li>
    </ul>
    <p>We haven’t seen <code>~&gt;</code> before. It’s a type alias for
    <a href="http://typelevel.org/cats/api/cats/arrow/FunctionK.html"><code>FunctionK</code></a>
    and is what performs the conversion from <code>M</code> to
    <code>F</code>. A normal function <code>A =&gt; B</code> converts
    values of type <code>A</code> to values of type <code>B</code>.
    Remember that <code>M</code> and <code>F</code> are not types; they
    are type constructors. A <code>FunctionK</code>
    <code>M ~&gt; F</code> is a function from a value with type
    <code>M[A]</code> to a value with type <code>F[A]</code>. Let’s see
    a quick example by defining a <code>FunctionK</code> that converts
    an <code>Option</code> to a <code>List</code>.</p>
    <div class="sourceCode" id="cb746"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb746-1"><a href="#cb746-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>arrow<span class="op">.</span>FunctionK</span>
<span id="cb746-2"><a href="#cb746-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb746-3"><a href="#cb746-3" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> optionToList <span class="kw">extends</span> FunctionK<span class="op">[</span><span class="ex">Option</span><span class="op">,</span> <span class="ex">List</span><span class="op">]</span> <span class="op">{</span></span>
<span id="cb746-4"><a href="#cb746-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> apply<span class="op">[</span>A<span class="op">](</span>fa<span class="op">:</span> <span class="ex">Option</span><span class="op">[</span>A<span class="op">]):</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb746-5"><a href="#cb746-5" aria-hidden="true" tabindex="-1"></a>    fa <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb746-6"><a href="#cb746-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="bu">None</span>    <span class="op">=&gt;</span> <span class="ex">List</span><span class="op">.</span>empty<span class="op">[</span>A<span class="op">]</span></span>
<span id="cb746-7"><a href="#cb746-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="bu">Some</span><span class="op">(</span>a<span class="op">)</span> <span class="op">=&gt;</span> <span class="ex">List</span><span class="op">(</span>a<span class="op">)</span></span>
<span id="cb746-8"><a href="#cb746-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb746-9"><a href="#cb746-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <div class="sourceCode" id="cb747"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb747-1"><a href="#cb747-1" aria-hidden="true" tabindex="-1"></a><span class="fu">optionToList</span><span class="op">(</span><span class="bu">Some</span><span class="op">(</span><span class="dv">1</span><span class="op">))</span></span>
<span id="cb747-2"><a href="#cb747-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: List[Int] = List(1)</span></span>
<span id="cb747-3"><a href="#cb747-3" aria-hidden="true" tabindex="-1"></a><span class="fu">optionToList</span><span class="op">(</span><span class="bu">None</span><span class="op">)</span></span>
<span id="cb747-4"><a href="#cb747-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res6: List[Nothing] = List()</span></span></code></pre></div>
    <p>As the type parameter <code>A</code> is generic a
    <code>FunctionK</code> cannot inspect any values contained with the
    type constructor <code>M</code>. The conversion must be performed
    purely in terms of the structure of the type constructors
    <code>M</code> and <code>F</code>. We can see in
    <code>optionToList</code> above this is indeed the case.</p>
    <p>So in summary, <code>Parallel</code> allows us to take a type
    that has a monad instance and convert it to some related type that
    instead has an applicative (or semigroupal) instance. This related
    type will have some useful alternate semantics. We’ve seen the case
    above where the related applicative for <code>Either</code> allows
    for accumulation of errors instead of fail-fast semantics.</p>
    <p>Now we’ve seen <code>Parallel</code> it’s time to finally learn
    about <code>Applicative</code>.</p>
    <h4 data-number="11.4.0.1" id="exercise-parallel-list"><span class="header-section-number">11.4.0.1</span> Exercise: Parallel
    List</h4>
    <p>Does <code>List</code> have a <code>Parallel</code> instance? If
    so, what does the <code>Parallel</code> instance do?</p>
    <div class="solution">
    <p><code>List</code> does have a <code>Parallel</code> instance, and
    it zips the <code>List</code> insted of creating the cartesian
    product.</p>
    <p>We can see by writing a little bit of code.</p>
    <div class="sourceCode" id="cb748"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb748-1"><a href="#cb748-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>list<span class="op">.</span>_</span></code></pre></div>
    <div class="sourceCode" id="cb749"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb749-1"><a href="#cb749-1" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">),</span> <span class="ex">List</span><span class="op">(</span><span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">)).</span>tupled</span>
<span id="cb749-2"><a href="#cb749-2" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">),</span> <span class="ex">List</span><span class="op">(</span><span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">)).</span>parTupled</span>
<span id="cb749-3"><a href="#cb749-3" aria-hidden="true" tabindex="-1"></a><span class="co">// res7: List[Tuple2[Int, Int]] = List((1, 3), (2, 4))</span></span></code></pre></div>
    </div>
    <h2 data-number="11.5" id="apply-and-applicative"><span class="header-section-number">11.5</span> Apply and Applicative</h2>
    <p>Semigroupals aren’t mentioned frequently in the wider functional
    programming literature. They provide a subset of the functionality
    of a related type class called an <em>applicative functor</em>
    (“applicative” for short).</p>
    <p><code>Semigroupal</code> and <code>Applicative</code> effectively
    provide alternative encodings of the same notion of joining
    contexts. Both encodings are introduced in the <a href="http://www.staff.city.ac.uk/~ross/papers/Applicative.html">same
    2008 paper</a> by Conor McBride and Ross Paterson<a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a>.</p>
    <p>Cats models applicatives using two type classes. The first, <a href="http://typelevel.org/cats/api/cats/Apply.html"><code>cats.Apply</code></a>,
    extends <code>Semigroupal</code> and <code>Functor</code> and adds
    an <code>ap</code> method that applies a parameter to a function
    within a context. The second, <a href="http://typelevel.org/cats/api/cats/Applicative.html"><code>cats.Applicative</code></a>,
    extends <code>Apply</code> and adds the <code>pure</code> method
    introduced in Chapter 9. Here’s a simplified definition in code:</p>
    <div class="sourceCode" id="cb750"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb750-1"><a href="#cb750-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Apply<span class="op">[</span>F<span class="op">[</span>_<span class="op">]]</span> <span class="kw">extends</span> Semigroupal<span class="op">[</span>F<span class="op">]</span> <span class="kw">with</span> Functor<span class="op">[</span>F<span class="op">]</span> <span class="op">{</span></span>
<span id="cb750-2"><a href="#cb750-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> ap<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>ff<span class="op">:</span> F<span class="op">[</span>A <span class="op">=&gt;</span> B<span class="op">])(</span>fa<span class="op">:</span> F<span class="op">[</span>A<span class="op">]):</span> F<span class="op">[</span>B<span class="op">]</span></span>
<span id="cb750-3"><a href="#cb750-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb750-4"><a href="#cb750-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> product<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>fa<span class="op">:</span> F<span class="op">[</span>A<span class="op">],</span> fb<span class="op">:</span> F<span class="op">[</span>B<span class="op">]):</span> F<span class="op">[(</span>A<span class="op">,</span> B<span class="op">)]</span> <span class="op">=</span></span>
<span id="cb750-5"><a href="#cb750-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ap</span><span class="op">(</span><span class="fu">map</span><span class="op">(</span>fa<span class="op">)(</span>a <span class="op">=&gt;</span> <span class="op">(</span>b<span class="op">:</span> B<span class="op">)</span> <span class="op">=&gt;</span> <span class="op">(</span>a<span class="op">,</span> b<span class="op">)))(</span>fb<span class="op">)</span></span>
<span id="cb750-6"><a href="#cb750-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb750-7"><a href="#cb750-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb750-8"><a href="#cb750-8" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Applicative<span class="op">[</span>F<span class="op">[</span>_<span class="op">]]</span> <span class="kw">extends</span> Apply<span class="op">[</span>F<span class="op">]</span> <span class="op">{</span></span>
<span id="cb750-9"><a href="#cb750-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> pure<span class="op">[</span>A<span class="op">](</span>a<span class="op">:</span> A<span class="op">):</span> F<span class="op">[</span>A<span class="op">]</span></span>
<span id="cb750-10"><a href="#cb750-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Breaking this down, the <code>ap</code> method applies a
    parameter <code>fa</code> to a function <code>ff</code> within a
    context <code>F[_]</code>. The <code>product</code> method from
    <code>Semigroupal</code> is defined in terms of <code>ap</code> and
    <code>map</code>.</p>
    <p>Don’t worry too much about the implementation of
    <code>product</code>—it’s difficult to read and the details aren’t
    particuarly important. The main point is that there is a tight
    relationship between <code>product</code>, <code>ap</code>, and
    <code>map</code> that allows any one of them to be defined in terms
    of the other two.</p>
    <p><code>Applicative</code> also introduces the <code>pure</code>
    method. This is the same <code>pure</code> we saw in
    <code>Monad</code>. It constructs a new applicative instance from an
    unwrapped value. In this sense, <code>Applicative</code> is related
    to <code>Apply</code> as <code>Monoid</code> is related to
    <code>Semigroup</code>.</p>
    <h3 data-number="11.5.1" id="the-hierarchy-of-sequencing-type-classes"><span class="header-section-number">11.5.1</span> The Hierarchy of
    Sequencing Type Classes</h3>
    <p>With the introduction of <code>Apply</code> and
    <code>Applicative</code>, we can zoom out and see a whole family of
    type classes that concern themselves with sequencing computations in
    different ways. Figure 10 shows the relationship between the type
    classes covered in this book<a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a>.</p>
    <figure id="fig:applicatives:hierarchy">
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAApQAAAEYCAYAAADiVWYCAAAAAXNSR0IArs4c6QAANj9JREFUeAHt3QeYFEXawPF3YQkKcgKCYgIVBATFAJjgQ0XBhKdiRjxUPDkDBlQQPeTwRFHPeJwgJjCgCIcYzjOgYEBQFEWPaCKLEgSBBYStr966m3FmZ3ZnZmdntsO/n2eZDtXdVb+3XV6qqscCYUEAgXwKmHzejHulFChIWSKzAsQ3M69cl67o+Oa6vlwfAd8KFPq25lQcAZ8KGEPO4YXQFRTkJtcgvl6Irkiu4uuN1lELBLwnUMV7VaJGCCCAAAIIIIAAAn4SIKH0U7SoKwIIIIAAAggg4EEBEkoPBoUqIYAAAggggAACfhIgofRTtKgrAggggAACCCDgQQESSg8GhSohgAACCCCAAAJ+EiCh9FO0qCsCCCCAAAIIIOBBARJKDwaFKiGAAAIIIIAAAn4SIKH0U7SoKwIIIIAAAggg4EEBEkoPBoUqIYAAAggggAACfhIgofRTtKgrAggggAACCCDgQQH+14seDApVQiCZwLp169z/Tq5OnTrJDme9b/Xq1e4a9evXz/pa+bzAZ599JlWqVJGDDz44n7et9Htt375dtm3bllAP/V8OVq9ePWE/OxBAAIFcCtBDmUtdro1ABQgsXLhQjjzySNl5553ld7/7nbRu3VqmTJlSAVeOv8RJJ50knTt3jt/pg637779fhg8f7oOaVmwVR48eLTVr1kz4Ofrooyv2Rkmu9sILLyTZyy4EEAizAD2UYY4+bfeFwHnnnScHHHCAvPbaa1K1alV56qmnZNmyZRVe9wEDBkhxcXGFX5cL5k5AeyKXL18ed4PCwtz+Wtde0R49esi5554bd182EEAg3AL0UIY7/rTe4wI6zK1DuldddZXUq1fP9VBec8017i/02Kr/+uuvMn/+fNm0aVPsblmzZo3b3rhxo6xcuTJ67KeffhLt+YxNII8//njp0qVLtIyuLFmyRObOnSs6vBq7rFq1ym1u3rxZFixYEHvInVMy4S0qKpLIkHqk8Nq1a0XrpYteJ1L3X375xdXNGBMp6j51+5tvvslJMh13Ix9t6PC2TlGI/dFebLXSeMfGLTYGsd4rVqxwriW9lUGfP31OYq+zePHiuO1YLn1eSsZej5f1vMSezzoCCCCAAAIIpCdg/95Of7EJn7HJgjnnnHOMTQ6Tnvi3v/3N7LjjjqZt27amUaNGRrd1sT1Jxs4tNIMGDTL77LOPqVGjhhk6dKgZNmyYadKkiTunTZs25ueff3blL730UtOzZ0+3vmHDBnPccceZPffc0xx00EHuunaOoru2Xtc21YwbN87stNNOxg7Fu3M++eQTs//++7tr165d2xx44IHmq6++csfskLRp1aqVW4/80bFjR3P77be7zbFjxxo7VGv69etn9t13X2OTZ3PIIYcYmxS54xMmTDC77767ad68ubE9cEbrGlkuvPBC07t378hm2p/ahvRCllGptO+fbcHHH3/cxTTZdX788UcXozlz5kQPP/TQQy6WukO9Dz/8cHPRRReZvffe29ieTnPEEUcYm9S78vpMnHHGGaZu3bpG4672dpqFefPNN9262u22227uR5+VsmJf2vMSrViOVnIU34weBgojECYBeijDFG3a6jsB7YF68sknxf5FLnvssYcbZnzvvfei7dD9t9xyi3z++edi/1KXL7/8Uu677z6ZNWuWK6M9kPrz7bffyhdffCFDhgyRDz74QL7++ms3VKq9SU888UT0epGVxx57zPVuam+UnnfWWWdJixYt5Prrr48UkYcfflhswuiuo71f3bt3l169esl3333neiltgitnn3120hdHoheJWZkxY4abK6q9kIsWLRLtdbXJryuhbdC2zps3T2bPni02mXLtjTk9lKvac6jzR2N/Ij29qUD0GdGYqbX2LOqz8+yzz7rTbr75Zvnhhx9E46/lPvroI7H/IJATTjhBbDLqymjPpv7oC1HpxD72eUlVN44jgID/BEgo/RczahwygW7durm/2EeMGOGSvE6dOsmDDz7oFJ5//nn3drMmdhMnThRNNm1vZNxLO5FhbNu7J7ZXSXRoW+di6tCo7SV0Q5olSXWe3H777efeKtdjzZo1c8PSseVuvPFGsb1bssMOO8i0adNcAmJ7GF0RfYGob9++brhcE9J0Fh221cREF9vDKeeff360HZrQakKjS8uWLV0bNbkM+6KJ9ltvvRX3s3Xr1rRYbO+jnHbaaa5sw4YNRV/m0WkTumjSeN1117k46LbGeZdddtHVhCXd2Mc+LwkXYQcCCPheILezt33PQwMQ8IaAHVoWOzzpfrSX8IEHHhCdS6nz5Oxwt+txjNRUk4QOHTpENuM+9a3gatWqRfdp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8ZgxY2TIkCHSuHFjtx5bdT2+adMmt0t7mxYuXBj3l/+6deukuLjYHV+yZIn8+OOPsafHrWtyctlll0m1atXi9msv2A8//BC3Tzc0uZk3b17cUOjixYvjtrWcJpJXXnmlVKlSRVavXu2GbnV/ZNFkZeXKlXH11nvqPpbfBHbaaSepX79+3I+aJluSxUbLxfZOxp53/PHHyw033BC7y62PHTtWVqxYIS1btow7pjH75ptvZNmyZXH7M3ne4k5kAwEEEEAAAQRKFbB/72a32F4p06BBA7N161YzbNgwc8ABB8Rd0P6Fb44++mhje5HMvvvua+rVq2cOOeQQY5MxV+7MM880N998syvTvHlzU716dXPttddGr3HhhRea3r17u+033njD2KHN6LGPP/7Y7LfffsYmhKZZs2bmqKOOMmvXrjVff/216dixo9ljjz3c/Vq0aGFsYmHefPNN06hRI+3KMrvttlv0Z5dddjF2KN1d9/LLLzenn3569B668sgjjxg7JO72TZ8+3bVD26L1PeWUU4xNlOPKl2dD61RqlMp/oDxVyfic9evXO9NJkyYlPTc2hqXFxs6BNK1btzY2ATU777yzi40+O5FrT5s2zdiE1cUwchP7jxVj/xFjHnvsMfdMPf744+7QhAkTzO677+7iU1hYaC699NLIKSbV8xYtWMErOYpv+Z8MzkQAAQQQQKACBbL+a1MTN00WdbE9RUb/An///fej19WkQPfZ4XC3T5MvTRyuv/56t61/wWsyaHv83PaMGTNMQUGB+eijj9x2bDISm1AWFRWZvfbay/zlL39x5fSPTz/91K3PmTPHjBs3ztieT6NJx2GHHWZs75Y7ZufbueTHbfzvD62jJpq6zJo1y9VXE9DIcvDBB5t//OMfZsOGDS5Rue+++9y19fpav4EDB0aKlvvTxtT3CaUm43bqQPRn9uzZziM2hmXFRgs3bNjQxS4CGUkoNRG94447XGJvX/5yh+3wuLFTLYydxhCXUL744ovmq6++cmX0fmqr//jQJdXz5grl4I8cxbcCfxVwKQSCJZB8bCRYbaQ1CARGQOe02eRRLrnkEtcm2+snJ598suicythFh0G7d+/udtWuXVvOP/98mTJlSrTIiSeeKJG5du3bt5c2bdqIvmhR1vLBBx+44fEBAwZEix166KFuXYc/zz77bLGJqXtZQ4dL58+f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MmVKqbe5+uqrpWbNmvLLL7+UWiZXBwYPHizPPPNMri7PdRFAAIG8C5BQ5p2cGyKAQD4EjDFy/fXXS3FxccLt5s+fLyNGjEjYzw4EEEAAgfIJkFCWz42zEEDA4wKtWrWSn376SZ5++umEmvbv3186deqUsF93LFmyRJYtW5ZwbM2aNW7fxo0bZc6cObJ58+aEMqtWrZJ58+aJDrmXXDZs2OCGubdt21byENsIIIAAAggggAACZQjYjsL8L48//rg59NBDjR36NnvssYexSWC0Eu+9956pVauW0U9bb7N+/Xp37JNPPjH777+/adKkialdu7Y58MADzVdffeWO2STQVKlSxdx1113ueg0aNDD16tUzdi6kO/7111+bjh07umO6v0WLFsYmpdF7DhkyxFStWtU0bdrUtG7d2n0OHDgwejwfK9rWMuLEIQQQQCArAXoos+LjZAQQ8LJAz549Zdddd5V77rnHVdMmbnLDDTdIv379ZPfdd49WvaioSLp37y69evWS7777zvVStm3bVs4++2yJ9Cjq0Lke0x/twbQJpAwaNMhdY+vWraJzMrV3c/ny5WITVrn//vvdsXfffVduu+02efXVV2XhwoVlzuuMVogVBBBAAAEEEEAAgahAPjrfEu4R6aHUA++8847rkdQew+eff97YBNPYF3GM9iraWroeyrfffttUr17d2Le+o9eaNWuWOz5z5kyjPZRaVns1I8uoUaNM48aNI5txn3ZI3XTr1s3t69Onj2nTpk3c8S5duhh6KKPPCCsIIBAAgcIAtIEmIIAAAqUKHHvssXLccce53kR961vfsLZD2rJy5croOUuXLpU6deqITSqj++zQtNhhatFjBx98cHR/ZGWHHXaIfjWR9mLaBFMmTJggmzZtksWLF8tBBx3kimpv5uGHHx45jU8EEEAgkAIMeQcyrDQKAQRiBe6++24ZM2aMVKtWTXr37h17yK3beZOiL9TokHRk+eyzz9zLNXos1XLllVfK66+/7l4AmjZtWtw9dMhdr82CAAIIBFmAhDLI0aVtCCDgBOxLMi7Ze+6556SwMHFg5qijjhItY1+ecfMjFy1aJPYFHGnXrl20p7EsyhkzZkjXrl2lUaNGsm7dOpk6dWq0+EknneSSzS+++MJ9hdHEiRNFk04WBBBAIEgCJJRBiiZtQQCBUgXOPfdcOeSQQ5Ie157Ll19+2b1U06xZM2nZsqUbuh4/frwUFBQkPSd2p37f5S233CLt27eXs846S0455ZTo4TPOOEMuvfRSd0wTTjsP021HC7CCAAIIBEAg9W/KADSSJiCAQKUJ6MsolXbz8txY/3eMmkTGzqdM5zp6ns6frFu3btLi+ia4zsnUn8pY/pcY8zu/MvC5JwIhEOCXSwiCTBMRqEQB3yWUlWiV01uTUOaUl4sjEHoBhrxD/wgAgAACCCCAAAIIZCdAQpmdH2cjgAACCCCAAAKhFyChDP0jAAACCCCAAAIIIJCdAAlldn6cjQACCCCAAAIIhF6AhDL0jwAACCCAAAIIIIBAdgIklNn5cTYCCCCAAAIIIBB6ARLK0D8CACCAAAIIIIAAAtkJkFBm58fZCCCAAAIIIIBA6AVIKEP/CACAAAIIIIAAAghkJ0BCmZ0fZyOAAAIIIIAAAqEXIKEM/SMAAAIIIIAAAgggkJ0ACWV2fpyNAAIIIIAAAgiEXoCEMvSPAAAIIIAAAggggEB2AiSU2flxNgIIIIAAAgggEHqBgtALAIAAArkUMLm8ONfOWIDf+RmTcQICCKQj8P++vpXz3Cr6ewAAAABJRU5ErkJggg==" alt="Monad type class hierarchy" />
    <figcaption>Figure 10: Monad type class hierarchy</figcaption>
    </figure>
    <p>Each type class in the hierarchy represents a particular set of
    sequencing semantics, introduces a set of characteristic methods,
    and defines the functionality of its supertypes in terms of
    them:</p>
    <ul>
    <li>every monad is an applicative;</li>
    <li>every applicative a semigroupal;</li>
    <li>and so on.</li>
    </ul>
    <p>Because of the lawful nature of the relationships between the
    type classes, the inheritance relationships are constant across all
    instances of a type class. <code>Apply</code> defines
    <code>product</code> in terms of <code>ap</code> and
    <code>map</code>; <code>Monad</code> defines <code>product</code>,
    <code>ap</code>, and <code>map</code>, in terms of <code>pure</code>
    and <code>flatMap</code>.</p>
    <p>To illustrate this let’s consider two hypothetical data
    types:</p>
    <ul>
    <li><p><code>Foo</code> is a monad. It has an instance of the
    <code>Monad</code> type class that implements <code>pure</code> and
    <code>flatMap</code> and inherits standard definitions of
    <code>product</code>, <code>map</code>, and
    <code>ap</code>;</p></li>
    <li><p><code>Bar</code> is an applicative functor. It has an
    instance of <code>Applicative</code> that implements
    <code>pure</code> and <code>ap</code> and inherits standard
    definitions of <code>product</code> and <code>map</code>.</p></li>
    </ul>
    <p>What can we say about these two data types without knowing more
    about their implementation?</p>
    <p>We know strictly more about <code>Foo</code> than
    <code>Bar</code>: <code>Monad</code> is a subtype of
    <code>Applicative</code>, so we can guarantee properties of
    <code>Foo</code> (namely <code>flatMap</code>) that we cannot
    guarantee with <code>Bar</code>. Conversely, we know that
    <code>Bar</code> may have a wider range of behaviours than
    <code>Foo</code>. It has fewer laws to obey (no
    <code>flatMap</code>), so it can implement behaviours that
    <code>Foo</code> cannot.</p>
    <p>This demonstrates the classic trade-off of power (in the
    mathematical sense) versus constraint. The more constraints we place
    on a data type, the more guarantees we have about its behaviour, but
    the fewer behaviours we can model.</p>
    <p>Monads happen to be a sweet spot in this trade-off. They are
    flexible enough to model a wide range of behaviours and restrictive
    enough to give strong guarantees about those behaviours. However,
    there are situations where monads aren’t the right tool for the job.
    Sometimes we want Thai food, and burritos just won’t satisfy.</p>
    <p>Whereas monads impose a strict <em>sequencing</em> on the
    computations they model, applicatives and semigroupals impose no
    such restriction. This puts them in a different sweet spot in the
    hierarchy. We can use them to represent classes of parallel /
    independent computations that monads cannot.</p>
    <p>We choose our semantics by choosing our data structures. If we
    choose a monad, we get strict sequencing. If we choose an
    applicative, we lose the ability to <code>flatMap</code>. This is
    the trade-off enforced by the consistency laws. So choose your types
    carefully!</p>
    <h2 data-number="11.6" id="summary-4"><span class="header-section-number">11.6</span> Summary</h2>
    <p>While monads and functors are the most widely used sequencing
    data types we’ve covered in this book, semigroupals and applicatives
    are the most general. These type classes provide a generic mechanism
    to combine values and apply functions within a context, from which
    we can fashion monads and a variety of other combinators.</p>
    <p><code>Semigroupal</code> and <code>Applicative</code> are most
    commonly used as a means of combining independent values such as the
    results of validation rules. Cats provides the
    <code>Validated</code> type for this specific purpose, along with
    apply syntax as a convenient way to express the combination of
    rules.</p>
    <p>We have almost covered all of the functional programming concepts
    on our agenda for this book. The next chapter covers
    <code>Traverse</code> and <code>Foldable</code>, two powerful type
    classes for converting between data types. After that we’ll look at
    several case studies that bring together all of the concepts from
    Part I.</p>
    <h1 data-number="12" id="sec:foldable-traverse"><span class="header-section-number">12</span> Foldable and Traverse</h1>
    <p>In this chapter we’ll look at two type classes that capture
    iteration over collections:</p>
    <ul>
    <li><code>Foldable</code> abstracts the familiar
    <code>foldLeft</code> and <code>foldRight</code> operations;</li>
    <li><code>Traverse</code> is a higher-level abstraction that uses
    <code>Applicatives</code> to iterate with less pain than
    folding.</li>
    </ul>
    <p>We’ll start by looking at <code>Foldable</code>, and then examine
    cases where folding becomes complex and <code>Traverse</code>
    becomes convenient.</p>
    <h2 data-number="12.1" id="sec:foldable"><span class="header-section-number">12.1</span> Foldable</h2>
    <p>The <code>Foldable</code> type class captures the
    <code>foldLeft</code> and <code>foldRight</code> methods we’re used
    to in sequences like <code>Lists</code>, <code>Vectors</code>, and
    <code>Streams</code>. Using <code>Foldable</code>, we can write
    generic folds that work with a variety of sequence types. We can
    also invent new sequences and plug them into our code.
    <code>Foldable</code> gives us great use cases for
    <code>Monoids</code> and the <code>Eval</code> monad.</p>
    <h3 data-number="12.1.1" id="folds-and-folding"><span class="header-section-number">12.1.1</span> Folds and Folding</h3>
    <p>Let’s start with a quick recap of the general concept of folding.
    We supply an <em>accumulator</em> value and a <em>binary
    function</em> to combine it with each item in the sequence:</p>
    <div class="sourceCode" id="cb751"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb751-1"><a href="#cb751-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> show<span class="op">[</span>A<span class="op">](</span>list<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">]):</span> <span class="ex">String</span> <span class="op">=</span></span>
<span id="cb751-2"><a href="#cb751-2" aria-hidden="true" tabindex="-1"></a>  list<span class="op">.</span><span class="fu">foldLeft</span><span class="op">(</span><span class="st">&quot;nil&quot;</span><span class="op">)((</span>accum<span class="op">,</span> item<span class="op">)</span> <span class="op">=&gt;</span> <span class="ss">s&quot;$item</span><span class="st"> then </span><span class="ss">$accum&quot;</span><span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb752"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb752-1"><a href="#cb752-1" aria-hidden="true" tabindex="-1"></a><span class="fu">show</span><span class="op">(</span>Nil<span class="op">)</span></span>
<span id="cb752-2"><a href="#cb752-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res0: String = &quot;nil&quot;</span></span>
<span id="cb752-3"><a href="#cb752-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb752-4"><a href="#cb752-4" aria-hidden="true" tabindex="-1"></a><span class="fu">show</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">))</span></span>
<span id="cb752-5"><a href="#cb752-5" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: String = &quot;3 then 2 then 1 then nil&quot;</span></span></code></pre></div>
    <p>The <code>foldLeft</code> method works recursively down the
    sequence. Our binary function is called repeatedly for each item,
    the result of each call becoming the accumulator for the next. When
    we reach the end of the sequence, the final accumulator becomes our
    final result.</p>
    <p>Depending on the operation we’re performing, the order in which
    we fold may be important. Because of this there are two standard
    variants of fold:</p>
    <ul>
    <li><code>foldLeft</code> traverses from “left” to “right” (start to
    finish);</li>
    <li><code>foldRight</code> traverses from “right” to “left” (finish
    to start).</li>
    </ul>
    <p>Figure 11 illustrates each direction.</p>
    <figure id="fig:foldable-traverse:fold">
    <svg id="svg_8efac6e679948e0aee33" alt="Illustration of foldLeft and foldRight" width="2200px" height="800px" viewBox="0 0 2200 800">
    <!-- Generator: Sketch 41.2 (35397) - http://www.bohemiancoding.com/sketch -->
    <title>fold</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="svg_8efac6e679948e0aee33_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_8efac6e679948e0aee33_foldright-sum" transform="translate(1307.000000, 0.000000)">
            <ellipse id="svg_8efac6e679948e0aee33_Oval-1" fill="#000000" cx="131.646259" cy="22.3129252" rx="22.3129252" ry="22.3129252"></ellipse>
            <text id="svg_8efac6e679948e0aee33_1" font-family="FiraMono-Regular, Fira Mono" font-size="46.8571429" font-weight="normal" fill="#000000">
                <tspan x="6.0244898" y="148.870748">1</tspan>
            </text>
            <text id="svg_8efac6e679948e0aee33_1" font-family="FiraMono-Regular, Fira Mono" font-size="46.8571429" font-weight="normal" fill="#000000">
                <tspan x="7.14013605" y="693.306122">1</tspan>
            </text>
            <path d="M153.959184,44.6258503 L220.897959,111.564626" id="svg_8efac6e679948e0aee33_Line" stroke="#F6A623" stroke-width="4" stroke-linecap="square" />
            <path d="M109.333333,44.6258503 L42.3945578,111.564626" id="svg_8efac6e679948e0aee33_Line" stroke="#F6A623" stroke-width="4" stroke-linecap="square" />
            <ellipse id="svg_8efac6e679948e0aee33_Oval-1" fill="#000000" cx="239.863946" cy="133.877551" rx="22.3129252" ry="22.3129252"></ellipse>
            <path d="M262.176871,156.190476 L329.115646,223.129252" id="svg_8efac6e679948e0aee33_Line" stroke="#F6A623" stroke-width="4" stroke-linecap="square" />
            <path d="M217.55102,156.190476 L150.612245,223.129252" id="svg_8efac6e679948e0aee33_Line" stroke="#F6A623" stroke-width="4" stroke-linecap="square" />
            <circle id="svg_8efac6e679948e0aee33_Oval-1" fill="#000000" cx="355.891156" cy="245.442177" r="22.3129252"></circle>
            <path d="M378.204082,267.755102 L435.112978,324.663999" id="svg_8efac6e679948e0aee33_Line" stroke="#F6A623" stroke-width="4" stroke-linecap="square" />
            <path d="M333.578231,267.755102 L266.639456,334.693878" id="svg_8efac6e679948e0aee33_Line" stroke="#F6A623" stroke-width="4" stroke-linecap="square" />
            <path d="M488.653061,334.693878 L444.027211,379.319728" id="svg_8efac6e679948e0aee33_Line" stroke="#000000" stroke-width="10" />
            <path d="M488.653061,334.693878 L444.027211,379.319728" id="svg_8efac6e679948e0aee33_Line" stroke="#000000" stroke-width="10" transform="translate(466.340136, 357.006803) rotate(90.000000) translate(-466.340136, -357.006803) " />
            <path d="M224.244898,490.884354 C224.244898,503.528786 234.304438,514.041271 246.557823,514.04127 C258.811209,514.041269 324.277006,514.041269 335.809524,514.041269 C347.342042,514.041269 358.122449,523.83408 358.122449,535.510203" id="svg_8efac6e679948e0aee33_Path-25" stroke="#4990E2" stroke-width="4" />
            <path d="M358.122449,490.884354 C358.122449,503.528786 368.181989,514.041271 380.435374,514.04127 C392.68876,514.041269 458.154557,514.041269 469.687075,514.041269 C481.219593,514.041269 492,523.83408 492,535.510203" id="svg_8efac6e679948e0aee33_Path-25" stroke="#4990E2" stroke-width="4" transform="translate(425.061224, 513.197278) scale(-1, 1) translate(-425.061224, -513.197278) " />
            <path d="M224.244898,490.884354 C224.244898,503.528786 234.304438,514.041271 246.557823,514.04127 C258.811209,514.041269 324.277006,514.041269 335.809524,514.041269 C347.342042,514.041269 358.122449,523.83408 358.122449,535.510203" id="svg_8efac6e679948e0aee33_Path-25" stroke="#4990E2" stroke-width="4" />
            <path d="M358.122449,490.884354 C358.122449,503.528786 368.181989,514.041271 380.435374,514.04127 C392.68876,514.041269 458.154557,514.041269 469.687075,514.041269 C481.219593,514.041269 492,523.83408 492,535.510203" id="svg_8efac6e679948e0aee33_Path-25" stroke="#4990E2" stroke-width="4" transform="translate(425.061224, 513.197278) scale(-1, 1) translate(-425.061224, -513.197278) " />
            <path d="M111.564626,590.176871 C111.564626,602.821303 121.624166,613.333788 133.877551,613.333787 C146.130936,613.333786 211.596733,613.333786 223.129252,613.333786 C234.66177,613.333786 245.442177,623.126597 245.442177,634.80272" id="svg_8efac6e679948e0aee33_Path-25" stroke="#4990E2" stroke-width="4" />
            <path d="M245.442177,590.176871 C245.442177,602.821303 255.501717,613.333788 267.755102,613.333787 C280.008487,613.333786 345.474284,613.333786 357.006803,613.333786 C368.539321,613.333786 379.319728,623.126597 379.319728,634.80272" id="svg_8efac6e679948e0aee33_Path-25" stroke="#4990E2" stroke-width="4" transform="translate(312.380952, 612.489795) scale(-1, 1) translate(-312.380952, -612.489795) " />
            <path d="M0,698.394558 C-2.60961562e-11,711.03899 10.0595398,721.551475 22.3129252,721.551474 C34.5663106,721.551473 100.032108,721.551473 111.564626,721.551473 C123.097144,721.551473 133.877551,731.344284 133.877551,743.020407" id="svg_8efac6e679948e0aee33_Path-25" stroke="#4990E2" stroke-width="4" />
            <path d="M133.877551,698.394558 C133.877551,711.03899 143.937091,721.551475 156.190476,721.551474 C168.443862,721.551473 233.909659,721.551473 245.442177,721.551473 C256.974695,721.551473 267.755102,731.344284 267.755102,743.020407" id="svg_8efac6e679948e0aee33_Path-25" stroke="#4990E2" stroke-width="4" transform="translate(200.816327, 720.707483) scale(-1, 1) translate(-200.816327, -720.707483) " />
            <path d="M251.020408,389.918367 L251.020408,437.891156" id="svg_8efac6e679948e0aee33_Line" stroke="#4990E2" stroke-width="4" stroke-linecap="square" stroke-dasharray="10,10,10,10" />
            <path d="M131.646259,279.469388 L131.646259,526.587553" id="svg_8efac6e679948e0aee33_Line" stroke="#4990E2" stroke-width="4" stroke-linecap="square" stroke-dasharray="10,10,10,10" />
            <path d="M21.1972789,165.673469 L21.1972789,637.035341" id="svg_8efac6e679948e0aee33_Line" stroke="#4990E2" stroke-width="4" stroke-linecap="square" stroke-dasharray="10,10,10,10" />
            <text id="svg_8efac6e679948e0aee33_2" font-family="FiraMono-Regular, Fira Mono" font-size="46.8571429" font-weight="normal" fill="#000000">
                <tspan x="118.704762" y="264.897959">2</tspan>
            </text>
            <text id="svg_8efac6e679948e0aee33_2" font-family="FiraMono-Regular, Fira Mono" font-size="46.8571429" font-weight="normal" fill="#000000">
                <tspan x="117.589116" y="580.62585">2</tspan>
            </text>
            <text id="svg_8efac6e679948e0aee33_3" font-family="FiraMono-Regular, Fira Mono" font-size="46.8571429" font-weight="normal" fill="#000000">
                <tspan x="236.963265" y="378.693878">3</tspan>
            </text>
            <text id="svg_8efac6e679948e0aee33_3" font-family="FiraMono-Regular, Fira Mono" font-size="46.8571429" font-weight="normal" fill="#000000">
                <tspan x="236.963265" y="486.911565">3</tspan>
            </text>
            <text id="svg_8efac6e679948e0aee33_0" font-family="FiraMono-Regular, Fira Mono" font-size="46.8571429" font-weight="normal" fill="#000000">
                <tspan x="452.282993" y="486.911565">0</tspan>
            </text>
            <text id="svg_8efac6e679948e0aee33_3" font-family="FiraMono-Regular, Fira Mono" font-size="46.8571429" font-weight="normal" fill="#000000">
                <tspan x="345.180952" y="580.62585">3</tspan>
            </text>
            <text id="svg_8efac6e679948e0aee33_5" font-family="FiraMono-Regular, Fira Mono" font-size="46.8571429" font-weight="normal" fill="#000000">
                <tspan x="232.50068" y="689.959184">5</tspan>
            </text>
            <text id="svg_8efac6e679948e0aee33_6" font-family="FiraMono-Regular, Fira Mono" font-size="46.8571429" font-weight="normal" fill="#000000">
                <tspan x="119.820408" y="788.136054">6</tspan>
            </text>
            <text id="svg_8efac6e679948e0aee33_+" font-family="FiraMono-Regular, Fira Mono" font-size="46.8571429" font-weight="normal" fill="#4990E2">
                <tspan x="342.94966" y="491.37415">+</tspan>
            </text>
            <text id="svg_8efac6e679948e0aee33_+" font-family="FiraMono-Regular, Fira Mono" font-size="46.8571429" font-weight="normal" fill="#4990E2">
                <tspan x="230.269388" y="580.62585">+</tspan>
            </text>
            <text id="svg_8efac6e679948e0aee33_+" font-family="FiraMono-Regular, Fira Mono" font-size="46.8571429" font-weight="normal" fill="#4990E2">
                <tspan x="118.704762" y="692.190476">+</tspan>
            </text>
        </g>
        <g id="svg_8efac6e679948e0aee33_foldleft-sum" transform="translate(299.000000, 0.000000)">
            <ellipse id="svg_8efac6e679948e0aee33_Oval-1" fill="#000000" cx="387.5" cy="24.2057489" rx="24.21875" ry="24.2057489"></ellipse>
            <path d="M411.71875,48.4114977 L484.375,121.028744" id="svg_8efac6e679948e0aee33_Line" stroke="#F6A623" stroke-width="4" stroke-linecap="square" />
            <path d="M363.28125,48.4114977 L290.625,121.028744" id="svg_8efac6e679948e0aee33_Line" stroke="#F6A623" stroke-width="4" stroke-linecap="square" />
            <ellipse id="svg_8efac6e679948e0aee33_Oval-1" fill="#000000" cx="504.960938" cy="145.234493" rx="24.21875" ry="24.2057489"></ellipse>
            <path d="M529.179688,169.440242 L601.835938,242.057489" id="svg_8efac6e679948e0aee33_Line" stroke="#F6A623" stroke-width="4" stroke-linecap="square" />
            <path d="M480.742187,169.440242 L408.085938,242.057489" id="svg_8efac6e679948e0aee33_Line" stroke="#F6A623" stroke-width="4" stroke-linecap="square" />
            <ellipse id="svg_8efac6e679948e0aee33_Oval-1" fill="#000000" cx="630.898438" cy="266.263238" rx="24.21875" ry="24.2057489"></ellipse>
            <path d="M655.117188,290.468986 L716.886872,352.205511" id="svg_8efac6e679948e0aee33_Line" stroke="#F6A623" stroke-width="4" stroke-linecap="square" />
            <path d="M606.679688,290.468986 L534.023438,363.086233" id="svg_8efac6e679948e0aee33_Line" stroke="#F6A623" stroke-width="4" stroke-linecap="square" />
            <path d="M775,363.086233 L726.5625,411.497731" id="svg_8efac6e679948e0aee33_Line" stroke="#000000" stroke-width="10" />
            <path d="M775,363.086233 L726.5625,411.497731" id="svg_8efac6e679948e0aee33_Line" stroke="#000000" stroke-width="10" transform="translate(750.781250, 387.291982) rotate(90.000000) translate(-750.781250, -387.291982) " />
            <path d="M242.1875,689.863843 C242.1875,703.580912 253.10626,714.98518 266.40625,714.985179 C279.70624,714.985178 350.763699,714.985178 363.28125,714.985178 C375.798801,714.985178 387.5,725.608721 387.5,738.275339" id="svg_8efac6e679948e0aee33_Path-25" stroke="#4990E2" stroke-width="4" />
            <path d="M387.5,689.863843 C387.5,703.580912 398.41876,714.98518 411.71875,714.985179 C425.01874,714.985178 496.076199,714.985178 508.59375,714.985178 C521.111301,714.985178 532.8125,725.608721 532.8125,738.275339" id="svg_8efac6e679948e0aee33_Path-25" stroke="#4990E2" stroke-width="4" transform="translate(460.156250, 714.069591) scale(-1, 1) translate(-460.156250, -714.069591) " />
            <path d="M242.1875,689.863843 C242.1875,703.580912 253.10626,714.98518 266.40625,714.985179 C279.70624,714.985178 350.763699,714.985178 363.28125,714.985178 C375.798801,714.985178 387.5,725.608721 387.5,738.275339" id="svg_8efac6e679948e0aee33_Path-25" stroke="#4990E2" stroke-width="4" />
            <path d="M387.5,689.863843 C387.5,703.580912 398.41876,714.98518 411.71875,714.985179 C425.01874,714.985178 496.076199,714.985178 508.59375,714.985178 C521.111301,714.985178 532.8125,725.608721 532.8125,738.275339" id="svg_8efac6e679948e0aee33_Path-25" stroke="#4990E2" stroke-width="4" transform="translate(460.156250, 714.069591) scale(-1, 1) translate(-460.156250, -714.069591) " />
            <path d="M121.09375,576.096823 C121.09375,589.813893 132.01251,601.21816 145.3125,601.218159 C158.61249,601.218158 229.669949,601.218158 242.1875,601.218158 C254.705051,601.218158 266.40625,611.841701 266.40625,624.50832" id="svg_8efac6e679948e0aee33_Path-25" stroke="#4990E2" stroke-width="4" />
            <path d="M266.40625,576.096823 C266.40625,589.813893 277.32501,601.21816 290.625,601.218159 C303.92499,601.218158 374.982449,601.218158 387.5,601.218158 C400.017551,601.218158 411.71875,611.841701 411.71875,624.50832" id="svg_8efac6e679948e0aee33_Path-25" stroke="#4990E2" stroke-width="4" transform="translate(339.062500, 600.302571) scale(-1, 1) translate(-339.062500, -600.302571) " />
            <path d="M0,463.540091 C-2.832512e-11,477.25716 10.9187602,488.661428 24.21875,488.661427 C37.5187398,488.661426 108.576199,488.661426 121.09375,488.661426 C133.611301,488.661426 145.3125,499.284969 145.3125,511.951588" id="svg_8efac6e679948e0aee33_Path-25" stroke="#4990E2" stroke-width="4" />
            <path d="M145.3125,463.540091 C145.3125,477.25716 156.23126,488.661428 169.53125,488.661427 C182.83124,488.661426 253.888699,488.661426 266.40625,488.661426 C278.923801,488.661426 290.625,499.284969 290.625,511.951588" id="svg_8efac6e679948e0aee33_Path-25" stroke="#4990E2" stroke-width="4" transform="translate(217.968750, 487.745839) scale(-1, 1) translate(-217.968750, -487.745839) " />
            <path d="M508.59375,422.995461 L508.59375,623.429614" id="svg_8efac6e679948e0aee33_Line" stroke="#4990E2" stroke-width="4" stroke-linecap="square" stroke-dasharray="10,10,10,10" />
            <path d="M387.5,303.177005 L387.5,508.377846" id="svg_8efac6e679948e0aee33_Line" stroke="#4990E2" stroke-width="4" stroke-linecap="square" stroke-dasharray="10,10,10,10" />
            <path d="M267.617188,179.727685 L267.617188,400.605144" id="svg_8efac6e679948e0aee33_Line" stroke="#4990E2" stroke-width="4" stroke-linecap="square" stroke-dasharray="10,10,10,10" />
            <text id="svg_8efac6e679948e0aee33_1" font-family="FiraMono-Regular, Fira Mono" font-size="50.8320726" font-weight="normal" fill="#000000">
                <tspan x="251.156628" y="161.76702">1</tspan>
            </text>
            <text id="svg_8efac6e679948e0aee33_2" font-family="FiraMono-Regular, Fira Mono" font-size="50.8320726" font-weight="normal" fill="#000000">
                <tspan x="372.250378" y="286.426626">2</tspan>
            </text>
            <text id="svg_8efac6e679948e0aee33_3" font-family="FiraMono-Regular, Fira Mono" font-size="50.8320726" font-weight="normal" fill="#000000">
                <tspan x="493.344128" y="406.245083">3</tspan>
            </text>
            <text id="svg_8efac6e679948e0aee33_1" font-family="FiraMono-Regular, Fira Mono" font-size="50.8320726" font-weight="normal" fill="#000000">
                <tspan x="251.156628" y="453.446293">1</tspan>
            </text>
            <text id="svg_8efac6e679948e0aee33_2" font-family="FiraMono-Regular, Fira Mono" font-size="50.8320726" font-weight="normal" fill="#000000">
                <tspan x="372.250378" y="559.951589">2</tspan>
            </text>
            <text id="svg_8efac6e679948e0aee33_3" font-family="FiraMono-Regular, Fira Mono" font-size="50.8320726" font-weight="normal" fill="#000000">
                <tspan x="493.344128" y="679.770045">3</tspan>
            </text>
            <text id="svg_8efac6e679948e0aee33_0" font-family="FiraMono-Regular, Fira Mono" font-size="50.8320726" font-weight="normal" fill="#000000">
                <tspan x="8.96912821" y="453.446293">0</tspan>
            </text>
            <text id="svg_8efac6e679948e0aee33_1" font-family="FiraMono-Regular, Fira Mono" font-size="50.8320726" font-weight="normal" fill="#000000">
                <tspan x="130.062878" y="559.951589">1</tspan>
            </text>
            <text id="svg_8efac6e679948e0aee33_3" font-family="FiraMono-Regular, Fira Mono" font-size="50.8320726" font-weight="normal" fill="#000000">
                <tspan x="251.156628" y="679.770045">3</tspan>
            </text>
            <text id="svg_8efac6e679948e0aee33_+" font-family="FiraMono-Regular, Fira Mono" font-size="50.8320726" font-weight="normal" fill="#4990E2">
                <tspan x="130.062878" y="453.446293">+</tspan>
            </text>
            <text id="svg_8efac6e679948e0aee33_+" font-family="FiraMono-Regular, Fira Mono" font-size="50.8320726" font-weight="normal" fill="#4990E2">
                <tspan x="251.156628" y="559.951589">+</tspan>
            </text>
            <text id="svg_8efac6e679948e0aee33_+" font-family="FiraMono-Regular, Fira Mono" font-size="50.8320726" font-weight="normal" fill="#4990E2">
                <tspan x="372.250378" y="679.770045">+</tspan>
            </text>
            <text id="svg_8efac6e679948e0aee33_6" font-family="FiraMono-Regular, Fira Mono" font-size="50.8320726" font-weight="normal" fill="#000000">
                <tspan x="372.250378" y="787.485628">6</tspan>
            </text>
        </g>
    </g>
</svg>
    <figcaption>Figure 11: Illustration of foldLeft and
    foldRight</figcaption>
    </figure>
    <p><code>foldLeft</code> and <code>foldRight</code> are equivalent
    if our binary operation is associative. For example, we can sum a
    <code>List[Int]</code> by folding in either direction, using
    <code>0</code> as our accumulator and addition as our operation:</p>
    <div class="sourceCode" id="cb753"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb753-1"><a href="#cb753-1" aria-hidden="true" tabindex="-1"></a><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">).</span><span class="fu">foldLeft</span><span class="op">(</span><span class="dv">0</span><span class="op">)(</span>_ <span class="op">+</span> _<span class="op">)</span></span>
<span id="cb753-2"><a href="#cb753-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: Int = 6</span></span>
<span id="cb753-3"><a href="#cb753-3" aria-hidden="true" tabindex="-1"></a><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">).</span><span class="fu">foldRight</span><span class="op">(</span><span class="dv">0</span><span class="op">)(</span>_ <span class="op">+</span> _<span class="op">)</span></span>
<span id="cb753-4"><a href="#cb753-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: Int = 6</span></span></code></pre></div>
    <p>If we provide a non-associative operator the order of evaluation
    makes a difference. For example, if we fold using subtraction, we
    get different results in each direction:</p>
    <div class="sourceCode" id="cb754"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb754-1"><a href="#cb754-1" aria-hidden="true" tabindex="-1"></a><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">).</span><span class="fu">foldLeft</span><span class="op">(</span><span class="dv">0</span><span class="op">)(</span>_ <span class="op">-</span> _<span class="op">)</span></span>
<span id="cb754-2"><a href="#cb754-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: Int = -6</span></span>
<span id="cb754-3"><a href="#cb754-3" aria-hidden="true" tabindex="-1"></a><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">).</span><span class="fu">foldRight</span><span class="op">(</span><span class="dv">0</span><span class="op">)(</span>_ <span class="op">-</span> _<span class="op">)</span></span>
<span id="cb754-4"><a href="#cb754-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: Int = 2</span></span></code></pre></div>
    <h3 data-number="12.1.2" id="exercise-reflecting-on-folds"><span class="header-section-number">12.1.2</span> Exercise: Reflecting on
    Folds</h3>
    <p>Try using <code>foldLeft</code> and <code>foldRight</code> with
    an empty list as the accumulator and <code>::</code> as the binary
    operator. What results do you get in each case?</p>
    <div class="solution">
    <p>Folding from left to right reverses the list:</p>
    <div class="sourceCode" id="cb755"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb755-1"><a href="#cb755-1" aria-hidden="true" tabindex="-1"></a><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">).</span><span class="fu">foldLeft</span><span class="op">(</span><span class="ex">List</span><span class="op">.</span>empty<span class="op">[</span><span class="bu">Int</span><span class="op">])((</span>a<span class="op">,</span> i<span class="op">)</span> <span class="op">=&gt;</span> i <span class="op">::</span> a<span class="op">)</span></span>
<span id="cb755-2"><a href="#cb755-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res6: List[Int] = List(3, 2, 1)</span></span></code></pre></div>
    <p>Folding right to left copies the list, leaving the order
    intact:</p>
    <div class="sourceCode" id="cb756"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb756-1"><a href="#cb756-1" aria-hidden="true" tabindex="-1"></a><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">).</span><span class="fu">foldRight</span><span class="op">(</span><span class="ex">List</span><span class="op">.</span>empty<span class="op">[</span><span class="bu">Int</span><span class="op">])((</span>i<span class="op">,</span> a<span class="op">)</span> <span class="op">=&gt;</span> i <span class="op">::</span> a<span class="op">)</span></span>
<span id="cb756-2"><a href="#cb756-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res7: List[Int] = List(1, 2, 3)</span></span></code></pre></div>
    <p>Note that we have to carefully specify the type of the
    accumulator to avoid a type error. We use
    <code>List.empty[Int]</code> to avoid inferring the accumulator type
    as <code>Nil.type</code> or <code>List[Nothing]</code>:</p>
    <div class="sourceCode" id="cb757"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb757-1"><a href="#cb757-1" aria-hidden="true" tabindex="-1"></a><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">).</span><span class="fu">foldRight</span><span class="op">(</span>Nil<span class="op">)(</span>_ <span class="op">::</span> _<span class="op">)</span></span>
<span id="cb757-2"><a href="#cb757-2" aria-hidden="true" tabindex="-1"></a><span class="co">// error:</span></span>
<span id="cb757-3"><a href="#cb757-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Found:    List[Int]</span></span>
<span id="cb757-4"><a href="#cb757-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Required: scala.collection.immutable.Nil.type</span></span>
<span id="cb757-5"><a href="#cb757-5" aria-hidden="true" tabindex="-1"></a><span class="co">// List(1, 2, 3).foldRight(Nil)(_ :: _)</span></span>
<span id="cb757-6"><a href="#cb757-6" aria-hidden="true" tabindex="-1"></a><span class="co">//                              ^^^^^^</span></span></code></pre></div>
    </div>
    <h3 data-number="12.1.3" id="exercise-scaf-fold-ing-other-methods"><span class="header-section-number">12.1.3</span> Exercise: Scaf-fold-ing
    Other Methods</h3>
    <p><code>foldLeft</code> and <code>foldRight</code> are very general
    methods. We can use them to implement many of the other high-level
    sequence operations we know. Prove this to yourself by implementing
    substitutes for <code>List&#39;s</code> <code>map</code>,
    <code>flatMap</code>, <code>filter</code>, and <code>sum</code>
    methods in terms of <code>foldRight</code>.</p>
    <div class="solution">
    <p>Here are the solutions:</p>
    <div class="sourceCode" id="cb758"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb758-1"><a href="#cb758-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> map<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>list<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">])(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> <span class="ex">List</span><span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb758-2"><a href="#cb758-2" aria-hidden="true" tabindex="-1"></a>  list<span class="op">.</span><span class="fu">foldRight</span><span class="op">(</span><span class="ex">List</span><span class="op">.</span>empty<span class="op">[</span>B<span class="op">])</span> <span class="op">{</span> <span class="op">(</span>item<span class="op">,</span> accum<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb758-3"><a href="#cb758-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">func</span><span class="op">(</span>item<span class="op">)</span> <span class="op">::</span> accum</span>
<span id="cb758-4"><a href="#cb758-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <div class="sourceCode" id="cb759"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb759-1"><a href="#cb759-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">))(</span>_ <span class="op">*</span> <span class="dv">2</span><span class="op">)</span></span>
<span id="cb759-2"><a href="#cb759-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res9: List[Int] = List(2, 4, 6)</span></span></code></pre></div>
    <div class="sourceCode" id="cb760"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb760-1"><a href="#cb760-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> flatMap<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>list<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">])(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> <span class="ex">List</span><span class="op">[</span>B<span class="op">]):</span> <span class="ex">List</span><span class="op">[</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb760-2"><a href="#cb760-2" aria-hidden="true" tabindex="-1"></a>  list<span class="op">.</span><span class="fu">foldRight</span><span class="op">(</span><span class="ex">List</span><span class="op">.</span>empty<span class="op">[</span>B<span class="op">])</span> <span class="op">{</span> <span class="op">(</span>item<span class="op">,</span> accum<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb760-3"><a href="#cb760-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">func</span><span class="op">(</span>item<span class="op">)</span> <span class="op">:::</span> accum</span>
<span id="cb760-4"><a href="#cb760-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <div class="sourceCode" id="cb761"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb761-1"><a href="#cb761-1" aria-hidden="true" tabindex="-1"></a><span class="fu">flatMap</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">))(</span>a <span class="op">=&gt;</span> <span class="ex">List</span><span class="op">(</span>a<span class="op">,</span> a <span class="op">*</span> <span class="dv">10</span><span class="op">,</span> a <span class="op">*</span> <span class="dv">100</span><span class="op">))</span></span>
<span id="cb761-2"><a href="#cb761-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res10: List[Int] = List(1, 10, 100, 2, 20, 200, 3, 30, 300)</span></span></code></pre></div>
    <div class="sourceCode" id="cb762"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb762-1"><a href="#cb762-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> filter<span class="op">[</span>A<span class="op">](</span>list<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">])(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> <span class="ex">Boolean</span><span class="op">):</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb762-2"><a href="#cb762-2" aria-hidden="true" tabindex="-1"></a>  list<span class="op">.</span><span class="fu">foldRight</span><span class="op">(</span><span class="ex">List</span><span class="op">.</span>empty<span class="op">[</span>A<span class="op">])</span> <span class="op">{</span> <span class="op">(</span>item<span class="op">,</span> accum<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb762-3"><a href="#cb762-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span><span class="fu">func</span><span class="op">(</span>item<span class="op">))</span> item <span class="op">::</span> accum <span class="cf">else</span> accum</span>
<span id="cb762-4"><a href="#cb762-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <div class="sourceCode" id="cb763"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb763-1"><a href="#cb763-1" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">))(</span>_ <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb763-2"><a href="#cb763-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res11: List[Int] = List(1, 3)</span></span></code></pre></div>
    <p>We’ve provided two definitions of <code>sum</code>, one using
    <code>scala.math.Numeric</code> (which recreates the built-in
    functionality accurately)…</p>
    <div class="sourceCode" id="cb764"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb764-1"><a href="#cb764-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>math<span class="op">.</span>Numeric</span>
<span id="cb764-2"><a href="#cb764-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb764-3"><a href="#cb764-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sumWithNumeric<span class="op">[</span>A<span class="op">](</span>list<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">])</span></span>
<span id="cb764-4"><a href="#cb764-4" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span><span class="kw">implicit</span> numeric<span class="op">:</span> Numeric<span class="op">[</span>A<span class="op">]):</span> A <span class="op">=</span></span>
<span id="cb764-5"><a href="#cb764-5" aria-hidden="true" tabindex="-1"></a>  list<span class="op">.</span><span class="fu">foldRight</span><span class="op">(</span>numeric<span class="op">.</span>zero<span class="op">)(</span>numeric<span class="op">.</span>plus<span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb765"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb765-1"><a href="#cb765-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sumWithNumeric</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">))</span></span>
<span id="cb765-2"><a href="#cb765-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res12: Int = 6</span></span></code></pre></div>
    <p>and one using <code>cats.Monoid</code> (which is more appropriate
    to the content of this book):</p>
    <div class="sourceCode" id="cb766"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb766-1"><a href="#cb766-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Monoid</span>
<span id="cb766-2"><a href="#cb766-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb766-3"><a href="#cb766-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sumWithMonoid<span class="op">[</span>A<span class="op">](</span>list<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">])</span></span>
<span id="cb766-4"><a href="#cb766-4" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span><span class="kw">implicit</span> monoid<span class="op">:</span> Monoid<span class="op">[</span>A<span class="op">]):</span> A <span class="op">=</span></span>
<span id="cb766-5"><a href="#cb766-5" aria-hidden="true" tabindex="-1"></a>  list<span class="op">.</span><span class="fu">foldRight</span><span class="op">(</span>monoid<span class="op">.</span>empty<span class="op">)(</span>monoid<span class="op">.</span>combine<span class="op">)</span></span>
<span id="cb766-6"><a href="#cb766-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb766-7"><a href="#cb766-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span><span class="dt">int</span><span class="op">.</span>_ <span class="co">// for Monoid</span></span></code></pre></div>
    <div class="sourceCode" id="cb767"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb767-1"><a href="#cb767-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sumWithMonoid</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">))</span></span>
<span id="cb767-2"><a href="#cb767-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res13: Int = 6</span></span></code></pre></div>
    </div>
    <h3 data-number="12.1.4" id="foldable-in-cats"><span class="header-section-number">12.1.4</span> Foldable in Cats</h3>
    <p>Cats’ <code>Foldable</code> abstracts <code>foldLeft</code> and
    <code>foldRight</code> into a type class. Instances of
    <code>Foldable</code> define these two methods and inherit a host of
    derived methods. Cats provides out-of-the-box instances of
    <code>Foldable</code> for a handful of Scala data types:
    <code>List</code>, <code>Vector</code>, <code>LazyList</code>, and
    <code>Option</code>.</p>
    <p>We can summon instances as usual using
    <code>Foldable.apply</code> and call their implementations of
    <code>foldLeft</code> directly. Here is an example using
    <code>List</code>:</p>
    <div class="sourceCode" id="cb768"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb768-1"><a href="#cb768-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Foldable</span>
<span id="cb768-2"><a href="#cb768-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>list<span class="op">.</span>_ <span class="co">// for Foldable</span></span>
<span id="cb768-3"><a href="#cb768-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb768-4"><a href="#cb768-4" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> ints <span class="op">=</span> <span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb769"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb769-1"><a href="#cb769-1" aria-hidden="true" tabindex="-1"></a>Foldable<span class="op">[</span><span class="ex">List</span><span class="op">].</span><span class="fu">foldLeft</span><span class="op">(</span>ints<span class="op">,</span> <span class="dv">0</span><span class="op">)(</span>_ <span class="op">+</span> _<span class="op">)</span></span>
<span id="cb769-2"><a href="#cb769-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res0: Int = 6</span></span></code></pre></div>
    <p>Other sequences like <code>Vector</code> and
    <code>LazyList</code> work in the same way. Here is an example using
    <code>Option</code>, which is treated like a sequence of zero or one
    elements:</p>
    <div class="sourceCode" id="cb770"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb770-1"><a href="#cb770-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>option<span class="op">.</span>_ <span class="co">// for Foldable</span></span>
<span id="cb770-2"><a href="#cb770-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb770-3"><a href="#cb770-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> maybeInt <span class="op">=</span> <span class="ex">Option</span><span class="op">(</span><span class="dv">123</span><span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb771"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb771-1"><a href="#cb771-1" aria-hidden="true" tabindex="-1"></a>Foldable<span class="op">[</span><span class="ex">Option</span><span class="op">].</span><span class="fu">foldLeft</span><span class="op">(</span>maybeInt<span class="op">,</span> <span class="dv">10</span><span class="op">)(</span>_ <span class="op">*</span> _<span class="op">)</span></span>
<span id="cb771-2"><a href="#cb771-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: Int = 1230</span></span></code></pre></div>
    <h4 data-number="12.1.4.1" id="folding-right"><span class="header-section-number">12.1.4.1</span> Folding Right</h4>
    <p><code>Foldable</code> defines <code>foldRight</code> differently
    to <code>foldLeft</code>, in terms of the <code>Eval</code>
    monad:</p>
    <div class="sourceCode" id="cb772"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb772-1"><a href="#cb772-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> foldRight<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>fa<span class="op">:</span> F<span class="op">[</span>A<span class="op">],</span> lb<span class="op">:</span> Eval<span class="op">[</span>B<span class="op">])</span></span>
<span id="cb772-2"><a href="#cb772-2" aria-hidden="true" tabindex="-1"></a>                     <span class="op">(</span>f<span class="op">:</span> <span class="op">(</span>A<span class="op">,</span> Eval<span class="op">[</span>B<span class="op">])</span> <span class="op">=&gt;</span> Eval<span class="op">[</span>B<span class="op">]):</span> Eval<span class="op">[</span>B<span class="op">]</span></span></code></pre></div>
    <p>Using <code>Eval</code> means folding is always <em>stack
    safe</em>, even when the collection’s default definition of
    <code>foldRight</code> is not. For example, the default
    implementation of <code>foldRight</code> for <code>LazyList</code>
    is not stack safe. The longer the lazy list, the larger the stack
    requirements for the fold. A sufficiently large lazy list will
    trigger a <code>StackOverflowError</code>:</p>
    <div class="sourceCode" id="cb773"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb773-1"><a href="#cb773-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Eval</span>
<span id="cb773-2"><a href="#cb773-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Foldable</span>
<span id="cb773-3"><a href="#cb773-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb773-4"><a href="#cb773-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> bigData <span class="op">=</span> <span class="op">(</span><span class="dv">1</span> to <span class="dv">100000</span><span class="op">).</span><span class="fu">to</span><span class="op">(</span>LazyList<span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb774"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb774-1"><a href="#cb774-1" aria-hidden="true" tabindex="-1"></a>bigData<span class="op">.</span><span class="fu">foldRight</span><span class="op">(</span><span class="dv">0L</span><span class="op">)(</span>_ <span class="op">+</span> _<span class="op">)</span></span>
<span id="cb774-2"><a href="#cb774-2" aria-hidden="true" tabindex="-1"></a><span class="co">// java.lang.StackOverflowError ...</span></span></code></pre></div>
    <p>Using <code>Foldable</code> forces us to use stack safe
    operations, which fixes the overflow exception:</p>
    <div class="sourceCode" id="cb775"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb775-1"><a href="#cb775-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>lazyList<span class="op">.</span>_ <span class="co">// for Foldable</span></span></code></pre></div>
    <div class="sourceCode" id="cb776"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb776-1"><a href="#cb776-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> eval<span class="op">:</span> Eval<span class="op">[</span><span class="ex">Long</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb776-2"><a href="#cb776-2" aria-hidden="true" tabindex="-1"></a>  Foldable<span class="op">[</span>LazyList<span class="op">].</span></span>
<span id="cb776-3"><a href="#cb776-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">foldRight</span><span class="op">(</span>bigData<span class="op">,</span> Eval<span class="op">.</span><span class="fu">now</span><span class="op">(</span><span class="dv">0L</span><span class="op">))</span> <span class="op">{</span> <span class="op">(</span>num<span class="op">,</span> eval<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb776-4"><a href="#cb776-4" aria-hidden="true" tabindex="-1"></a>      eval<span class="op">.</span><span class="fu">map</span><span class="op">(</span>_ <span class="op">+</span> num<span class="op">)</span></span>
<span id="cb776-5"><a href="#cb776-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
    <div class="sourceCode" id="cb777"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb777-1"><a href="#cb777-1" aria-hidden="true" tabindex="-1"></a>eval<span class="op">.</span>value</span>
<span id="cb777-2"><a href="#cb777-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: Long = 5000050000L</span></span></code></pre></div>
    <div class="callout callout-info">
    <p><em>Stack Safety in the Standard Library</em></p>
    <p>Stack safety isn’t typically an issue when using the standard
    library. The most commonly used collection types, such as
    <code>List</code> and <code>Vector</code>, provide stack safe
    implementations of <code>foldRight</code>:</p>
    <div class="sourceCode" id="cb778"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb778-1"><a href="#cb778-1" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="dv">1</span> to <span class="dv">100000</span><span class="op">).</span>toList<span class="op">.</span><span class="fu">foldRight</span><span class="op">(</span><span class="dv">0L</span><span class="op">)(</span>_ <span class="op">+</span> _<span class="op">)</span></span>
<span id="cb778-2"><a href="#cb778-2" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="dv">1</span> to <span class="dv">100000</span><span class="op">).</span>toVector<span class="op">.</span><span class="fu">foldRight</span><span class="op">(</span><span class="dv">0L</span><span class="op">)(</span>_ <span class="op">+</span> _<span class="op">)</span></span>
<span id="cb778-3"><a href="#cb778-3" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: Long = 5000050000L</span></span></code></pre></div>
    <p>We’ve called out <code>Stream</code> because it is an exception
    to this rule. Whatever data type we’re using, though, it’s useful to
    know that <code>Eval</code> has our back.</p>
    </div>
    <h4 data-number="12.1.4.2" id="folding-with-monoids"><span class="header-section-number">12.1.4.2</span> Folding with
    Monoids</h4>
    <p><code>Foldable</code> provides us with a host of useful methods
    defined on top of <code>foldLeft</code>. Many of these are
    facsimiles of familiar methods from the standard library:
    <code>find</code>, <code>exists</code>, <code>forall</code>,
    <code>toList</code>, <code>isEmpty</code>, <code>nonEmpty</code>,
    and so on:</p>
    <div class="sourceCode" id="cb779"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb779-1"><a href="#cb779-1" aria-hidden="true" tabindex="-1"></a>Foldable<span class="op">[</span><span class="ex">Option</span><span class="op">].</span><span class="fu">nonEmpty</span><span class="op">(</span><span class="ex">Option</span><span class="op">(</span><span class="dv">42</span><span class="op">))</span></span>
<span id="cb779-2"><a href="#cb779-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: Boolean = true</span></span>
<span id="cb779-3"><a href="#cb779-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb779-4"><a href="#cb779-4" aria-hidden="true" tabindex="-1"></a>Foldable<span class="op">[</span><span class="ex">List</span><span class="op">].</span><span class="fu">find</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">))(</span>_ <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb779-5"><a href="#cb779-5" aria-hidden="true" tabindex="-1"></a><span class="co">// res6: Option[Int] = Some(value = 2)</span></span></code></pre></div>
    <p>In addition to these familiar methods, Cats provides two methods
    that make use of <code>Monoids</code>:</p>
    <ul>
    <li><p><code>combineAll</code> (and its alias <code>fold</code>)
    combines all elements in the sequence using their
    <code>Monoid</code>;</p></li>
    <li><p><code>foldMap</code> maps a user-supplied function over the
    sequence and combines the results using a
    <code>Monoid</code>.</p></li>
    </ul>
    <p>For example, we can use <code>combineAll</code> to sum over a
    <code>List[Int]</code>:</p>
    <div class="sourceCode" id="cb780"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb780-1"><a href="#cb780-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span><span class="dt">int</span><span class="op">.</span>_ <span class="co">// for Monoid</span></span></code></pre></div>
    <div class="sourceCode" id="cb781"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb781-1"><a href="#cb781-1" aria-hidden="true" tabindex="-1"></a>Foldable<span class="op">[</span><span class="ex">List</span><span class="op">].</span><span class="fu">combineAll</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">))</span></span>
<span id="cb781-2"><a href="#cb781-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res7: Int = 6</span></span></code></pre></div>
    <p>Alternatively, we can use <code>foldMap</code> to convert each
    <code>Int</code> to a <code>String</code> and concatenate them:</p>
    <div class="sourceCode" id="cb782"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb782-1"><a href="#cb782-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>string<span class="op">.</span>_ <span class="co">// for Monoid</span></span></code></pre></div>
    <div class="sourceCode" id="cb783"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb783-1"><a href="#cb783-1" aria-hidden="true" tabindex="-1"></a>Foldable<span class="op">[</span><span class="ex">List</span><span class="op">].</span><span class="fu">foldMap</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">))(</span>_<span class="op">.</span>toString<span class="op">)</span></span>
<span id="cb783-2"><a href="#cb783-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res8: String = &quot;123&quot;</span></span></code></pre></div>
    <p>Finally, we can compose <code>Foldables</code> to support deep
    traversal of nested sequences:</p>
    <div class="sourceCode" id="cb784"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb784-1"><a href="#cb784-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>vector<span class="op">.</span>_ <span class="co">// for Monoid</span></span>
<span id="cb784-2"><a href="#cb784-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb784-3"><a href="#cb784-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> ints <span class="op">=</span> <span class="ex">List</span><span class="op">(</span><span class="ex">Vector</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">),</span> <span class="ex">Vector</span><span class="op">(</span><span class="dv">4</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">6</span><span class="op">))</span></span></code></pre></div>
    <div class="sourceCode" id="cb785"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb785-1"><a href="#cb785-1" aria-hidden="true" tabindex="-1"></a><span class="op">(</span>Foldable<span class="op">[</span><span class="ex">List</span><span class="op">]</span> compose Foldable<span class="op">[</span><span class="ex">Vector</span><span class="op">]).</span><span class="fu">combineAll</span><span class="op">(</span>ints<span class="op">)</span></span>
<span id="cb785-2"><a href="#cb785-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res10: Int = 21</span></span></code></pre></div>
    <h4 data-number="12.1.4.3" id="syntax-for-foldable"><span class="header-section-number">12.1.4.3</span> Syntax for
    Foldable</h4>
    <p>Every method in <code>Foldable</code> is available in syntax form
    via <a href="http://typelevel.org/cats/api/cats/syntax/package$$foldable$"><code>cats.syntax.foldable</code></a>.
    In each case, the first argument to the method on
    <code>Foldable</code> becomes the receiver of the method call:</p>
    <div class="sourceCode" id="cb786"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb786-1"><a href="#cb786-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>foldable<span class="op">.</span>_ <span class="co">// for combineAll and foldMap</span></span></code></pre></div>
    <div class="sourceCode" id="cb787"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb787-1"><a href="#cb787-1" aria-hidden="true" tabindex="-1"></a><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">).</span>combineAll</span>
<span id="cb787-2"><a href="#cb787-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res11: Int = 6</span></span>
<span id="cb787-3"><a href="#cb787-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb787-4"><a href="#cb787-4" aria-hidden="true" tabindex="-1"></a><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">).</span><span class="fu">foldMap</span><span class="op">(</span>_<span class="op">.</span>toString<span class="op">)</span></span>
<span id="cb787-5"><a href="#cb787-5" aria-hidden="true" tabindex="-1"></a><span class="co">// res12: String = &quot;123&quot;</span></span></code></pre></div>
    <div class="callout callout-info">
    <p><em>Explicits over Implicits</em></p>
    <p>Remember that Scala will only use an instance of
    <code>Foldable</code> if the method isn’t explicitly available on
    the receiver. For example, the following code will use the version
    of <code>foldLeft</code> defined on <code>List</code>:</p>
    <div class="sourceCode" id="cb788"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb788-1"><a href="#cb788-1" aria-hidden="true" tabindex="-1"></a><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">).</span><span class="fu">foldLeft</span><span class="op">(</span><span class="dv">0</span><span class="op">)(</span>_ <span class="op">+</span> _<span class="op">)</span></span>
<span id="cb788-2"><a href="#cb788-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res13: Int = 6</span></span></code></pre></div>
    <p>whereas the following generic code will use
    <code>Foldable</code>:</p>
    <div class="sourceCode" id="cb789"><pre class="sourceCode scala"><code class="sourceCode scala"></code></pre></div>
    <div class="sourceCode" id="cb790"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb790-1"><a href="#cb790-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sum<span class="op">[</span>F<span class="op">[</span>_<span class="op">]:</span> Foldable<span class="op">](</span>values<span class="op">:</span> F<span class="op">[</span><span class="bu">Int</span><span class="op">]):</span> <span class="bu">Int</span> <span class="op">=</span></span>
<span id="cb790-2"><a href="#cb790-2" aria-hidden="true" tabindex="-1"></a>  values<span class="op">.</span><span class="fu">foldLeft</span><span class="op">(</span><span class="dv">0</span><span class="op">)(</span>_ <span class="op">+</span> _<span class="op">)</span></span></code></pre></div>
    <p>We typically don’t need to worry about this distinction. It’s a
    feature! We call the method we want and the compiler uses a
    <code>Foldable</code> when needed to ensure our code works as
    expected. If we need a stack-safe implementation of
    <code>foldRight</code>, using <code>Eval</code> as the accumulator
    is enough to force the compiler to select the method from Cats.</p>
    </div>
    <h2 data-number="12.2" id="sec:traverse"><span class="header-section-number">12.2</span> Traverse</h2>
    <p><code>foldLeft</code> and <code>foldRight</code> are flexible
    iteration methods but they require us to do a lot of work to define
    accumulators and combinator functions. The <code>Traverse</code>
    type class is a higher level tool that leverages
    <code>Applicatives</code> to provide a more convenient, more lawful,
    pattern for iteration.</p>
    <h3 data-number="12.2.1" id="traversing-with-futures"><span class="header-section-number">12.2.1</span> Traversing with
    Futures</h3>
    <p>We can demonstrate <code>Traverse</code> using the
    <code>Future.traverse</code> and <code>Future.sequence</code>
    methods in the Scala standard library. These methods provide
    <code>Future</code>-specific implementations of the traverse
    pattern. As an example, suppose we have a list of server hostnames
    and a method to poll a host for its uptime:</p>
    <div class="sourceCode" id="cb791"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb791-1"><a href="#cb791-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span>_</span>
<span id="cb791-2"><a href="#cb791-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span>duration<span class="op">.</span>_</span>
<span id="cb791-3"><a href="#cb791-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span>ExecutionContext<span class="op">.</span>Implicits<span class="op">.</span>global</span>
<span id="cb791-4"><a href="#cb791-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb791-5"><a href="#cb791-5" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> hostnames <span class="op">=</span> <span class="ex">List</span><span class="op">(</span></span>
<span id="cb791-6"><a href="#cb791-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;alpha.example.com&quot;</span><span class="op">,</span></span>
<span id="cb791-7"><a href="#cb791-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;beta.example.com&quot;</span><span class="op">,</span></span>
<span id="cb791-8"><a href="#cb791-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;gamma.demo.com&quot;</span></span>
<span id="cb791-9"><a href="#cb791-9" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb791-10"><a href="#cb791-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb791-11"><a href="#cb791-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">getUptime</span><span class="op">(</span>hostname<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Future</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb791-12"><a href="#cb791-12" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Future</span><span class="op">(</span>hostname<span class="op">.</span>length <span class="op">*</span> <span class="dv">60</span><span class="op">)</span> <span class="co">// just for demonstration</span></span></code></pre></div>
    <p>Now, suppose we want to poll all of the hosts and collect all of
    their uptimes. We can’t simply <code>map</code> over
    <code>hostnames</code> because the result—a
    <code>List[Future[Int]]</code>—would contain more than one
    <code>Future</code>. We need to reduce the results to a single
    <code>Future</code> to get something we can block on. Let’s start by
    doing this manually using a fold:</p>
    <div class="sourceCode" id="cb792"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb792-1"><a href="#cb792-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> allUptimes<span class="op">:</span> <span class="ex">Future</span><span class="op">[</span><span class="ex">List</span><span class="op">[</span><span class="bu">Int</span><span class="op">]]</span> <span class="op">=</span></span>
<span id="cb792-2"><a href="#cb792-2" aria-hidden="true" tabindex="-1"></a>  hostnames<span class="op">.</span><span class="fu">foldLeft</span><span class="op">(</span><span class="ex">Future</span><span class="op">(</span><span class="ex">List</span><span class="op">.</span>empty<span class="op">[</span><span class="bu">Int</span><span class="op">]))</span> <span class="op">{</span></span>
<span id="cb792-3"><a href="#cb792-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span>accum<span class="op">,</span> host<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb792-4"><a href="#cb792-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">val</span> uptime <span class="op">=</span> <span class="fu">getUptime</span><span class="op">(</span>host<span class="op">)</span></span>
<span id="cb792-5"><a href="#cb792-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb792-6"><a href="#cb792-6" aria-hidden="true" tabindex="-1"></a>        accum  <span class="op">&lt;-</span> accum</span>
<span id="cb792-7"><a href="#cb792-7" aria-hidden="true" tabindex="-1"></a>        uptime <span class="op">&lt;-</span> uptime</span>
<span id="cb792-8"><a href="#cb792-8" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">yield</span> accum <span class="op">:+</span> uptime</span>
<span id="cb792-9"><a href="#cb792-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <div class="sourceCode" id="cb793"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb793-1"><a href="#cb793-1" aria-hidden="true" tabindex="-1"></a>Await<span class="op">.</span><span class="fu">result</span><span class="op">(</span>allUptimes<span class="op">,</span> <span class="fl">1.</span>second<span class="op">)</span></span>
<span id="cb793-2"><a href="#cb793-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res0: List[Int] = List(1020, 960, 840)</span></span></code></pre></div>
    <p>Intuitively, we iterate over <code>hostnames</code>, call
    <code>func</code> for each item, and combine the results into a
    list. This sounds simple, but the code is fairly unwieldy because of
    the need to create and combine <code>Futures</code> at every
    iteration. We can improve on things greatly using
    <code>Future.traverse</code>, which is tailor-made for this
    pattern:</p>
    <div class="sourceCode" id="cb794"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb794-1"><a href="#cb794-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> allUptimes<span class="op">:</span> <span class="ex">Future</span><span class="op">[</span><span class="ex">List</span><span class="op">[</span><span class="bu">Int</span><span class="op">]]</span> <span class="op">=</span></span>
<span id="cb794-2"><a href="#cb794-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Future</span><span class="op">.</span><span class="fu">traverse</span><span class="op">(</span>hostnames<span class="op">)(</span>getUptime<span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb795"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb795-1"><a href="#cb795-1" aria-hidden="true" tabindex="-1"></a>Await<span class="op">.</span><span class="fu">result</span><span class="op">(</span>allUptimes<span class="op">,</span> <span class="fl">1.</span>second<span class="op">)</span></span>
<span id="cb795-2"><a href="#cb795-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: List[Int] = List(1020, 960, 840)</span></span></code></pre></div>
    <p>This is much clearer and more concise—let’s see how it works. If
    we ignore distractions like <code>CanBuildFrom</code> and
    <code>ExecutionContext</code>, the implementation of
    <code>Future.traverse</code> in the standard library looks like
    this:</p>
    <div class="sourceCode" id="cb796"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb796-1"><a href="#cb796-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> traverse<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>values<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">])</span></span>
<span id="cb796-2"><a href="#cb796-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> <span class="ex">Future</span><span class="op">[</span>B<span class="op">]):</span> <span class="ex">Future</span><span class="op">[</span><span class="ex">List</span><span class="op">[</span>B<span class="op">]]</span> <span class="op">=</span></span>
<span id="cb796-3"><a href="#cb796-3" aria-hidden="true" tabindex="-1"></a>  values<span class="op">.</span><span class="fu">foldLeft</span><span class="op">(</span><span class="ex">Future</span><span class="op">(</span><span class="ex">List</span><span class="op">.</span>empty<span class="op">[</span>B<span class="op">]))</span> <span class="op">{</span> <span class="op">(</span>accum<span class="op">,</span> host<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb796-4"><a href="#cb796-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> item <span class="op">=</span> <span class="fu">func</span><span class="op">(</span>host<span class="op">)</span></span>
<span id="cb796-5"><a href="#cb796-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb796-6"><a href="#cb796-6" aria-hidden="true" tabindex="-1"></a>      accum <span class="op">&lt;-</span> accum</span>
<span id="cb796-7"><a href="#cb796-7" aria-hidden="true" tabindex="-1"></a>      item  <span class="op">&lt;-</span> item</span>
<span id="cb796-8"><a href="#cb796-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">yield</span> accum <span class="op">:+</span> item</span>
<span id="cb796-9"><a href="#cb796-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>This is essentially the same as our example code above.
    <code>Future.traverse</code> is abstracting away the pain of folding
    and defining accumulators and combination functions. It gives us a
    clean high-level interface to do what we want:</p>
    <ul>
    <li>start with a <code>List[A]</code>;</li>
    <li>provide a function <code>A =&gt; Future[B]</code>;</li>
    <li>end up with a <code>Future[List[B]]</code>.</li>
    </ul>
    <p>The standard library also provides another method,
    <code>Future.sequence</code>, that assumes we’re starting with a
    <code>List[Future[B]]</code> and don’t need to provide an identity
    function:</p>
    <div class="sourceCode" id="cb797"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb797-1"><a href="#cb797-1" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> <span class="ex">Future</span> <span class="op">{</span></span>
<span id="cb797-2"><a href="#cb797-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> sequence<span class="op">[</span>B<span class="op">](</span>futures<span class="op">:</span> <span class="ex">List</span><span class="op">[</span><span class="ex">Future</span><span class="op">[</span>B<span class="op">]]):</span> <span class="ex">Future</span><span class="op">[</span><span class="ex">List</span><span class="op">[</span>B<span class="op">]]</span> <span class="op">=</span></span>
<span id="cb797-3"><a href="#cb797-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">traverse</span><span class="op">(</span>futures<span class="op">)(</span>identity<span class="op">)</span></span>
<span id="cb797-4"><a href="#cb797-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb797-5"><a href="#cb797-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// etc...</span></span>
<span id="cb797-6"><a href="#cb797-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>In this case the intuitive understanding is even simpler:</p>
    <ul>
    <li>start with a <code>List[Future[A]]</code>;</li>
    <li>end up with a <code>Future[List[A]]</code>.</li>
    </ul>
    <p><code>Future.traverse</code> and <code>Future.sequence</code>
    solve a very specific problem: they allow us to iterate over a
    sequence of <code>Futures</code> and accumulate a result. The
    simplified examples above only work with <code>Lists</code>, but the
    real <code>Future.traverse</code> and <code>Future.sequence</code>
    work with any standard Scala collection.</p>
    <p>Cats’ <code>Traverse</code> type class generalises these patterns
    to work with any type of <code>Applicative</code>:
    <code>Future</code>, <code>Option</code>, <code>Validated</code>,
    and so on. We’ll approach <code>Traverse</code> in the next sections
    in two steps: first we’ll generalise over the
    <code>Applicative</code>, then we’ll generalise over the sequence
    type. We’ll end up with an extremely valuable tool that trivialises
    many operations involving sequences and other data types.</p>
    <h3 data-number="12.2.2" id="traversing-with-applicatives"><span class="header-section-number">12.2.2</span> Traversing with
    Applicatives</h3>
    <p>If we squint, we’ll see that we can rewrite <code>traverse</code>
    in terms of an <code>Applicative</code>. Our accumulator from the
    example above:</p>
    <div class="sourceCode" id="cb798"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb798-1"><a href="#cb798-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Future</span><span class="op">(</span><span class="ex">List</span><span class="op">.</span>empty<span class="op">[</span><span class="bu">Int</span><span class="op">])</span></span></code></pre></div>
    <p>is equivalent to <code>Applicative.pure</code>:</p>
    <div class="sourceCode" id="cb799"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb799-1"><a href="#cb799-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Applicative</span>
<span id="cb799-2"><a href="#cb799-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>future<span class="op">.</span>_   <span class="co">// for Applicative</span></span>
<span id="cb799-3"><a href="#cb799-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>applicative<span class="op">.</span>_ <span class="co">// for pure</span></span>
<span id="cb799-4"><a href="#cb799-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb799-5"><a href="#cb799-5" aria-hidden="true" tabindex="-1"></a><span class="ex">List</span><span class="op">.</span>empty<span class="op">[</span><span class="bu">Int</span><span class="op">].</span>pure<span class="op">[</span><span class="ex">Future</span><span class="op">]</span></span></code></pre></div>
    <p>Our combinator, which used to be this:</p>
    <div class="sourceCode" id="cb800"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb800-1"><a href="#cb800-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">oldCombine</span><span class="op">(</span></span>
<span id="cb800-2"><a href="#cb800-2" aria-hidden="true" tabindex="-1"></a>  accum <span class="op">:</span> <span class="ex">Future</span><span class="op">[</span><span class="ex">List</span><span class="op">[</span><span class="bu">Int</span><span class="op">]],</span></span>
<span id="cb800-3"><a href="#cb800-3" aria-hidden="true" tabindex="-1"></a>  host  <span class="op">:</span> <span class="ex">String</span></span>
<span id="cb800-4"><a href="#cb800-4" aria-hidden="true" tabindex="-1"></a><span class="op">):</span> <span class="ex">Future</span><span class="op">[</span><span class="ex">List</span><span class="op">[</span><span class="bu">Int</span><span class="op">]]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb800-5"><a href="#cb800-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> uptime <span class="op">=</span> <span class="fu">getUptime</span><span class="op">(</span>host<span class="op">)</span></span>
<span id="cb800-6"><a href="#cb800-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb800-7"><a href="#cb800-7" aria-hidden="true" tabindex="-1"></a>    accum  <span class="op">&lt;-</span> accum</span>
<span id="cb800-8"><a href="#cb800-8" aria-hidden="true" tabindex="-1"></a>    uptime <span class="op">&lt;-</span> uptime</span>
<span id="cb800-9"><a href="#cb800-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">yield</span> accum <span class="op">:+</span> uptime</span>
<span id="cb800-10"><a href="#cb800-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>is now equivalent to <code>Semigroupal.combine</code>:</p>
    <div class="sourceCode" id="cb801"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb801-1"><a href="#cb801-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>apply<span class="op">.</span>_ <span class="co">// for mapN</span></span>
<span id="cb801-2"><a href="#cb801-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb801-3"><a href="#cb801-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Combining accumulator and hostname using an Applicative:</span></span>
<span id="cb801-4"><a href="#cb801-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">newCombine</span><span class="op">(</span>accum<span class="op">:</span> <span class="ex">Future</span><span class="op">[</span><span class="ex">List</span><span class="op">[</span><span class="bu">Int</span><span class="op">]],</span></span>
<span id="cb801-5"><a href="#cb801-5" aria-hidden="true" tabindex="-1"></a>      host<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Future</span><span class="op">[</span><span class="ex">List</span><span class="op">[</span><span class="bu">Int</span><span class="op">]]</span> <span class="op">=</span></span>
<span id="cb801-6"><a href="#cb801-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">(</span>accum<span class="op">,</span> <span class="fu">getUptime</span><span class="op">(</span>host<span class="op">)).</span><span class="fu">mapN</span><span class="op">(</span>_ <span class="op">:+</span> _<span class="op">)</span></span></code></pre></div>
    <p>By substituting these snippets back into the definition of
    <code>traverse</code> we can generalise it to to work with any
    <code>Applicative</code>:</p>
    <div class="sourceCode" id="cb802"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb802-1"><a href="#cb802-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb802-2"><a href="#cb802-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> listTraverse<span class="op">[</span>F<span class="op">[</span>_<span class="op">]:</span> Applicative<span class="op">,</span> A<span class="op">,</span> B<span class="op">]</span></span>
<span id="cb802-3"><a href="#cb802-3" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>list<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>A<span class="op">])(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> F<span class="op">[</span>B<span class="op">]):</span> F<span class="op">[</span><span class="ex">List</span><span class="op">[</span>B<span class="op">]]</span> <span class="op">=</span></span>
<span id="cb802-4"><a href="#cb802-4" aria-hidden="true" tabindex="-1"></a>  list<span class="op">.</span><span class="fu">foldLeft</span><span class="op">(</span><span class="ex">List</span><span class="op">.</span>empty<span class="op">[</span>B<span class="op">].</span>pure<span class="op">[</span>F<span class="op">])</span> <span class="op">{</span> <span class="op">(</span>accum<span class="op">,</span> item<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb802-5"><a href="#cb802-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span>accum<span class="op">,</span> <span class="fu">func</span><span class="op">(</span>item<span class="op">)).</span><span class="fu">mapN</span><span class="op">(</span>_ <span class="op">:+</span> _<span class="op">)</span></span>
<span id="cb802-6"><a href="#cb802-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb802-7"><a href="#cb802-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb802-8"><a href="#cb802-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> listSequence<span class="op">[</span>F<span class="op">[</span>_<span class="op">]:</span> Applicative<span class="op">,</span> B<span class="op">]</span></span>
<span id="cb802-9"><a href="#cb802-9" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>list<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>F<span class="op">[</span>B<span class="op">]]):</span> F<span class="op">[</span><span class="ex">List</span><span class="op">[</span>B<span class="op">]]</span> <span class="op">=</span></span>
<span id="cb802-10"><a href="#cb802-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">listTraverse</span><span class="op">(</span>list<span class="op">)(</span>identity<span class="op">)</span></span></code></pre></div>
    <p>We can use <code>listTraverse</code> to re-implement our uptime
    example:</p>
    <div class="sourceCode" id="cb803"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb803-1"><a href="#cb803-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> totalUptime <span class="op">=</span> <span class="fu">listTraverse</span><span class="op">(</span>hostnames<span class="op">)(</span>getUptime<span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb804"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb804-1"><a href="#cb804-1" aria-hidden="true" tabindex="-1"></a>Await<span class="op">.</span><span class="fu">result</span><span class="op">(</span>totalUptime<span class="op">,</span> <span class="fl">1.</span>second<span class="op">)</span></span>
<span id="cb804-2"><a href="#cb804-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: List[Int] = List(1020, 960, 840)</span></span></code></pre></div>
    <p>or we can use it with other <code>Applicative</code> data types
    as shown in the following exercises.</p>
    <h4 data-number="12.2.2.1" id="exercise-traversing-with-vectors"><span class="header-section-number">12.2.2.1</span> Exercise: Traversing
    with Vectors</h4>
    <p>What is the result of the following?</p>
    <div class="sourceCode" id="cb805"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb805-1"><a href="#cb805-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>vector<span class="op">.</span>_ <span class="co">// for Applicative</span></span>
<span id="cb805-2"><a href="#cb805-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb805-3"><a href="#cb805-3" aria-hidden="true" tabindex="-1"></a><span class="fu">listSequence</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="ex">Vector</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">),</span> <span class="ex">Vector</span><span class="op">(</span><span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">)))</span></span></code></pre></div>
    <div class="solution">
    <p>The argument is of type <code>List[Vector[Int]]</code>, so we’re
    using the <code>Applicative</code> for <code>Vector</code> and the
    return type is going to be <code>Vector[List[Int]]</code>.</p>
    <p><code>Vector</code> is a monad, so its semigroupal
    <code>combine</code> function is based on <code>flatMap</code>.
    We’ll end up with a <code>Vector</code> of <code>Lists</code> of all
    the possible combinations of <code>List(1, 2)</code> and
    <code>List(3, 4)</code>:</p>
    <div class="sourceCode" id="cb806"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb806-1"><a href="#cb806-1" aria-hidden="true" tabindex="-1"></a><span class="fu">listSequence</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="ex">Vector</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">),</span> <span class="ex">Vector</span><span class="op">(</span><span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">)))</span></span>
<span id="cb806-2"><a href="#cb806-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res7: Vector[List[Int]] = Vector(</span></span>
<span id="cb806-3"><a href="#cb806-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   List(1, 3),</span></span>
<span id="cb806-4"><a href="#cb806-4" aria-hidden="true" tabindex="-1"></a><span class="co">//   List(1, 4),</span></span>
<span id="cb806-5"><a href="#cb806-5" aria-hidden="true" tabindex="-1"></a><span class="co">//   List(2, 3),</span></span>
<span id="cb806-6"><a href="#cb806-6" aria-hidden="true" tabindex="-1"></a><span class="co">//   List(2, 4)</span></span>
<span id="cb806-7"><a href="#cb806-7" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    </div>
    <p>What about a list of three parameters?</p>
    <div class="sourceCode" id="cb807"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb807-1"><a href="#cb807-1" aria-hidden="true" tabindex="-1"></a><span class="fu">listSequence</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="ex">Vector</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">),</span> <span class="ex">Vector</span><span class="op">(</span><span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">),</span> <span class="ex">Vector</span><span class="op">(</span><span class="dv">5</span><span class="op">,</span> <span class="dv">6</span><span class="op">)))</span></span></code></pre></div>
    <div class="solution">
    <p>With three items in the input list, we end up with combinations
    of three <code>Ints</code>: one from the first item, one from the
    second, and one from the third:</p>
    <div class="sourceCode" id="cb808"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb808-1"><a href="#cb808-1" aria-hidden="true" tabindex="-1"></a><span class="fu">listSequence</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="ex">Vector</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">),</span> <span class="ex">Vector</span><span class="op">(</span><span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">),</span> <span class="ex">Vector</span><span class="op">(</span><span class="dv">5</span><span class="op">,</span> <span class="dv">6</span><span class="op">)))</span></span>
<span id="cb808-2"><a href="#cb808-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res9: Vector[List[Int]] = Vector(</span></span>
<span id="cb808-3"><a href="#cb808-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   List(1, 3, 5),</span></span>
<span id="cb808-4"><a href="#cb808-4" aria-hidden="true" tabindex="-1"></a><span class="co">//   List(1, 3, 6),</span></span>
<span id="cb808-5"><a href="#cb808-5" aria-hidden="true" tabindex="-1"></a><span class="co">//   List(1, 4, 5),</span></span>
<span id="cb808-6"><a href="#cb808-6" aria-hidden="true" tabindex="-1"></a><span class="co">//   List(1, 4, 6),</span></span>
<span id="cb808-7"><a href="#cb808-7" aria-hidden="true" tabindex="-1"></a><span class="co">//   List(2, 3, 5),</span></span>
<span id="cb808-8"><a href="#cb808-8" aria-hidden="true" tabindex="-1"></a><span class="co">//   List(2, 3, 6),</span></span>
<span id="cb808-9"><a href="#cb808-9" aria-hidden="true" tabindex="-1"></a><span class="co">//   List(2, 4, 5),</span></span>
<span id="cb808-10"><a href="#cb808-10" aria-hidden="true" tabindex="-1"></a><span class="co">//   List(2, 4, 6)</span></span>
<span id="cb808-11"><a href="#cb808-11" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    </div>
    <h4 data-number="12.2.2.2" id="exercise-traversing-with-options"><span class="header-section-number">12.2.2.2</span> Exercise: Traversing
    with Options</h4>
    <p>Here’s an example that uses <code>Options</code>:</p>
    <div class="sourceCode" id="cb809"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb809-1"><a href="#cb809-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>option<span class="op">.</span>_ <span class="co">// for Applicative</span></span>
<span id="cb809-2"><a href="#cb809-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb809-3"><a href="#cb809-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">process</span><span class="op">(</span>inputs<span class="op">:</span> <span class="ex">List</span><span class="op">[</span><span class="bu">Int</span><span class="op">])</span> <span class="op">=</span></span>
<span id="cb809-4"><a href="#cb809-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">listTraverse</span><span class="op">(</span>inputs<span class="op">)(</span>n <span class="op">=&gt;</span> <span class="cf">if</span><span class="op">(</span>n <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="bu">Some</span><span class="op">(</span>n<span class="op">)</span> <span class="cf">else</span> <span class="bu">None</span><span class="op">)</span></span></code></pre></div>
    <p>What is the return type of this method? What does it produce for
    the following inputs?</p>
    <div class="sourceCode" id="cb810"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb810-1"><a href="#cb810-1" aria-hidden="true" tabindex="-1"></a><span class="fu">process</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">2</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">6</span><span class="op">))</span></span>
<span id="cb810-2"><a href="#cb810-2" aria-hidden="true" tabindex="-1"></a><span class="fu">process</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">))</span></span></code></pre></div>
    <div class="solution">
    <p>The arguments to <code>listTraverse</code> are of types
    <code>List[Int]</code> and <code>Int =&gt; Option[Int]</code>, so
    the return type is <code>Option[List[Int]]</code>. Again,
    <code>Option</code> is a monad, so the semigroupal
    <code>combine</code> function follows from <code>flatMap</code>. The
    semantics are therefore fail-fast error handling: if all inputs are
    even, we get a list of outputs. Otherwise we get
    <code>None</code>:</p>
    <div class="sourceCode" id="cb811"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb811-1"><a href="#cb811-1" aria-hidden="true" tabindex="-1"></a><span class="fu">process</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">2</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">6</span><span class="op">))</span></span>
<span id="cb811-2"><a href="#cb811-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res12: Option[List[Int]] = Some(value = List(2, 4, 6))</span></span>
<span id="cb811-3"><a href="#cb811-3" aria-hidden="true" tabindex="-1"></a><span class="fu">process</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">))</span></span>
<span id="cb811-4"><a href="#cb811-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res13: Option[List[Int]] = None</span></span></code></pre></div>
    </div>
    <h4 data-number="12.2.2.3" id="exercise-traversing-with-validated"><span class="header-section-number">12.2.2.3</span> Exercise: Traversing
    with Validated</h4>
    <p>Finally, here is an example that uses <code>Validated</code>:</p>
    <div class="sourceCode" id="cb812"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb812-1"><a href="#cb812-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>data<span class="op">.</span>Validated</span>
<span id="cb812-2"><a href="#cb812-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>list<span class="op">.</span>_ <span class="co">// for Monoid</span></span>
<span id="cb812-3"><a href="#cb812-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb812-4"><a href="#cb812-4" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> ErrorsOr<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> Validated<span class="op">[</span><span class="ex">List</span><span class="op">[</span><span class="ex">String</span><span class="op">],</span> A<span class="op">]</span></span>
<span id="cb812-5"><a href="#cb812-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb812-6"><a href="#cb812-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">process</span><span class="op">(</span>inputs<span class="op">:</span> <span class="ex">List</span><span class="op">[</span><span class="bu">Int</span><span class="op">]):</span> ErrorsOr<span class="op">[</span><span class="ex">List</span><span class="op">[</span><span class="bu">Int</span><span class="op">]]</span> <span class="op">=</span></span>
<span id="cb812-7"><a href="#cb812-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">listTraverse</span><span class="op">(</span>inputs<span class="op">)</span> <span class="op">{</span> n <span class="op">=&gt;</span></span>
<span id="cb812-8"><a href="#cb812-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>n <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb812-9"><a href="#cb812-9" aria-hidden="true" tabindex="-1"></a>      Validated<span class="op">.</span><span class="fu">valid</span><span class="op">(</span>n<span class="op">)</span></span>
<span id="cb812-10"><a href="#cb812-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb812-11"><a href="#cb812-11" aria-hidden="true" tabindex="-1"></a>      Validated<span class="op">.</span><span class="fu">invalid</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="ss">s&quot;$n</span><span class="st"> is not even</span><span class="ss">&quot;</span><span class="op">))</span></span>
<span id="cb812-12"><a href="#cb812-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb812-13"><a href="#cb812-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>What does this method produce for the following inputs?</p>
    <div class="sourceCode" id="cb813"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb813-1"><a href="#cb813-1" aria-hidden="true" tabindex="-1"></a><span class="fu">process</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">2</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">6</span><span class="op">))</span></span>
<span id="cb813-2"><a href="#cb813-2" aria-hidden="true" tabindex="-1"></a><span class="fu">process</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">))</span></span></code></pre></div>
    <div class="solution">
    <p>The return type here is <code>ErrorsOr[List[Int]]</code>, which
    expands to <code>Validated[List[String], List[Int]]</code>. The
    semantics for semigroupal <code>combine</code> on validated are
    accumulating error handling, so the result is either a list of even
    <code>Ints</code>, or a list of errors detailing which
    <code>Ints</code> failed the test:</p>
    <div class="sourceCode" id="cb814"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb814-1"><a href="#cb814-1" aria-hidden="true" tabindex="-1"></a><span class="fu">process</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">2</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">6</span><span class="op">))</span></span>
<span id="cb814-2"><a href="#cb814-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res17: Validated[List[String], List[Int]] = Valid(a = List(2, 4, 6))</span></span>
<span id="cb814-3"><a href="#cb814-3" aria-hidden="true" tabindex="-1"></a><span class="fu">process</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">))</span></span>
<span id="cb814-4"><a href="#cb814-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res18: Validated[List[String], List[Int]] = Invalid(</span></span>
<span id="cb814-5"><a href="#cb814-5" aria-hidden="true" tabindex="-1"></a><span class="co">//   e = List(&quot;1 is not even&quot;, &quot;3 is not even&quot;)</span></span>
<span id="cb814-6"><a href="#cb814-6" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    </div>
    <h3 data-number="12.2.3" id="traverse-in-cats"><span class="header-section-number">12.2.3</span> Traverse in Cats</h3>
    <p>Our <code>listTraverse</code> and <code>listSequence</code>
    methods work with any type of <code>Applicative</code>, but they
    only work with one type of sequence: <code>List</code>. We can
    generalise over different sequence types using a type class, which
    brings us to Cats’ <code>Traverse</code>. Here’s the abbreviated
    definition:</p>
    <div class="sourceCode" id="cb815"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb815-1"><a href="#cb815-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> cats</span>
<span id="cb815-2"><a href="#cb815-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb815-3"><a href="#cb815-3" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Traverse<span class="op">[</span>F<span class="op">[</span>_<span class="op">]]</span> <span class="op">{</span></span>
<span id="cb815-4"><a href="#cb815-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> traverse<span class="op">[</span>G<span class="op">[</span>_<span class="op">]:</span> Applicative<span class="op">,</span> A<span class="op">,</span> B<span class="op">]</span></span>
<span id="cb815-5"><a href="#cb815-5" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>inputs<span class="op">:</span> F<span class="op">[</span>A<span class="op">])(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> G<span class="op">[</span>B<span class="op">]):</span> G<span class="op">[</span>F<span class="op">[</span>B<span class="op">]]</span></span>
<span id="cb815-6"><a href="#cb815-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb815-7"><a href="#cb815-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> sequence<span class="op">[</span>G<span class="op">[</span>_<span class="op">]:</span> Applicative<span class="op">,</span> B<span class="op">]</span></span>
<span id="cb815-8"><a href="#cb815-8" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>inputs<span class="op">:</span> F<span class="op">[</span>G<span class="op">[</span>B<span class="op">]]):</span> G<span class="op">[</span>F<span class="op">[</span>B<span class="op">]]</span> <span class="op">=</span></span>
<span id="cb815-9"><a href="#cb815-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">traverse</span><span class="op">(</span>inputs<span class="op">)(</span>identity<span class="op">)</span></span>
<span id="cb815-10"><a href="#cb815-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Cats provides instances of <code>Traverse</code> for
    <code>List</code>, <code>Vector</code>, <code>Stream</code>,
    <code>Option</code>, <code>Either</code>, and a variety of other
    types. We can summon instances as usual using
    <code>Traverse.apply</code> and use the <code>traverse</code> and
    <code>sequence</code> methods as described in the previous
    section:</p>
    <div class="sourceCode" id="cb816"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb816-1"><a href="#cb816-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Traverse</span>
<span id="cb816-2"><a href="#cb816-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>future<span class="op">.</span>_ <span class="co">// for Applicative</span></span>
<span id="cb816-3"><a href="#cb816-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>list<span class="op">.</span>_   <span class="co">// for Traverse</span></span>
<span id="cb816-4"><a href="#cb816-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb816-5"><a href="#cb816-5" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> totalUptime<span class="op">:</span> <span class="ex">Future</span><span class="op">[</span><span class="ex">List</span><span class="op">[</span><span class="bu">Int</span><span class="op">]]</span> <span class="op">=</span></span>
<span id="cb816-6"><a href="#cb816-6" aria-hidden="true" tabindex="-1"></a>  Traverse<span class="op">[</span><span class="ex">List</span><span class="op">].</span><span class="fu">traverse</span><span class="op">(</span>hostnames<span class="op">)(</span>getUptime<span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb817"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb817-1"><a href="#cb817-1" aria-hidden="true" tabindex="-1"></a>Await<span class="op">.</span><span class="fu">result</span><span class="op">(</span>totalUptime<span class="op">,</span> <span class="fl">1.</span>second<span class="op">)</span></span>
<span id="cb817-2"><a href="#cb817-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res0: List[Int] = List(1020, 960, 840)</span></span></code></pre></div>
    <div class="sourceCode" id="cb818"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb818-1"><a href="#cb818-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> numbers <span class="op">=</span> <span class="ex">List</span><span class="op">(</span><span class="ex">Future</span><span class="op">(</span><span class="dv">1</span><span class="op">),</span> <span class="ex">Future</span><span class="op">(</span><span class="dv">2</span><span class="op">),</span> <span class="ex">Future</span><span class="op">(</span><span class="dv">3</span><span class="op">))</span></span>
<span id="cb818-2"><a href="#cb818-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb818-3"><a href="#cb818-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> numbers2<span class="op">:</span> <span class="ex">Future</span><span class="op">[</span><span class="ex">List</span><span class="op">[</span><span class="bu">Int</span><span class="op">]]</span> <span class="op">=</span></span>
<span id="cb818-4"><a href="#cb818-4" aria-hidden="true" tabindex="-1"></a>  Traverse<span class="op">[</span><span class="ex">List</span><span class="op">].</span><span class="fu">sequence</span><span class="op">(</span>numbers<span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb819"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb819-1"><a href="#cb819-1" aria-hidden="true" tabindex="-1"></a>Await<span class="op">.</span><span class="fu">result</span><span class="op">(</span>numbers2<span class="op">,</span> <span class="fl">1.</span>second<span class="op">)</span></span>
<span id="cb819-2"><a href="#cb819-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: List[Int] = List(1, 2, 3)</span></span></code></pre></div>
    <p>There are also syntax versions of the methods, imported via <a href="http://typelevel.org/cats/api/cats/syntax/package$$traverse$"><code>cats.syntax.traverse</code></a>:</p>
    <div class="sourceCode" id="cb820"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb820-1"><a href="#cb820-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>traverse<span class="op">.</span>_ <span class="co">// for sequence and traverse</span></span></code></pre></div>
    <div class="sourceCode" id="cb821"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb821-1"><a href="#cb821-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> numbers3 <span class="op">=</span> hostnames<span class="op">.</span><span class="fu">traverse</span><span class="op">(</span>getUptime<span class="op">)</span></span>
<span id="cb821-2"><a href="#cb821-2" aria-hidden="true" tabindex="-1"></a><span class="co">// numbers3: Future[List[Int]] = Future(Success(List(1020, 960, 840)))</span></span>
<span id="cb821-3"><a href="#cb821-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> numbers4 <span class="op">=</span> numbers<span class="op">.</span>sequence</span>
<span id="cb821-4"><a href="#cb821-4" aria-hidden="true" tabindex="-1"></a><span class="co">// numbers4: Future[List[Int]] = Future(Success(List(1, 2, 3)))</span></span>
<span id="cb821-5"><a href="#cb821-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb821-6"><a href="#cb821-6" aria-hidden="true" tabindex="-1"></a>Await<span class="op">.</span><span class="fu">result</span><span class="op">(</span>numbers3<span class="op">,</span> <span class="fl">1.</span>second<span class="op">)</span></span>
<span id="cb821-7"><a href="#cb821-7" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: List[Int] = List(1020, 960, 840)</span></span>
<span id="cb821-8"><a href="#cb821-8" aria-hidden="true" tabindex="-1"></a>Await<span class="op">.</span><span class="fu">result</span><span class="op">(</span>numbers4<span class="op">,</span> <span class="fl">1.</span>second<span class="op">)</span></span>
<span id="cb821-9"><a href="#cb821-9" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: List[Int] = List(1, 2, 3)</span></span></code></pre></div>
    <p>As you can see, this is much more compact and readable than the
    <code>foldLeft</code> code we started with earlier this chapter!</p>
    <h2 data-number="12.3" id="summary-5"><span class="header-section-number">12.3</span> Summary</h2>
    <p>In this chapter we were introduced to <code>Foldable</code> and
    <code>Traverse</code>, two type classes for iterating over
    sequences.</p>
    <p><code>Foldable</code> abstracts the <code>foldLeft</code> and
    <code>foldRight</code> methods we know from collections in the
    standard library. It adds stack-safe implementations of these
    methods to a handful of extra data types, and defines a host of
    situationally useful additions. That said, <code>Foldable</code>
    doesn’t introduce much that we didn’t already know.</p>
    <p>The real power comes from <code>Traverse</code>, which abstracts
    and generalises the <code>traverse</code> and <code>sequence</code>
    methods we know from <code>Future</code>. Using these methods we can
    turn an <code>F[G[A]]</code> into a <code>G[F[A]]</code> for any
    <code>F</code> with an instance of <code>Traverse</code> and any
    <code>G</code> with an instance of <code>Applicative</code>. In
    terms of the reduction we get in lines of code,
    <code>Traverse</code> is one of the most powerful patterns in this
    book. We can reduce <code>folds</code> of many lines down to a
    single <code>foo.traverse</code>.</p>
    <hr />
    <p>…and with that, we’ve finished all of the theory in this book.
    There’s plenty more to come, though, as we put everything we’ve
    learned into practice in a series of in-depth case studies in Part
    II!</p>
    <h1 data-number="13" id="indexed-types"><span class="header-section-number">13</span> Indexed Types</h1>
    <p>In this chapter we look at <strong>indexed types</strong>. Both
    data and codata can be indexed. An indexed type is a type
    constructor, so a type like <code>F[_]</code>, along with a set of
    types that can fill in the type parameters for the constructor.
    Let’s say the set of types is <code>Int</code>, <code>String</code>,
    and <code>Option[A]</code>. Then, for a type constructor
    <code>F</code> we can construct an indexed type from the set
    <code>F[Int]</code>, <code>F[String]</code>, and
    <code>F[Option[A]]</code>. As the name suggests, the indices act as
    indexes into this set of types.</p>
    <p>This is a very abstract definition and doesn’t help us understand
    how indexed types are useful. We’ll see a lot of details and
    examples in this chapter, but let’s start with a more useful
    high-level overview. When we’re treating a type as indexed data we
    create elements from our set of types. We can think of this as
    providing a proof that some type parameter, <code>A</code> in the
    example above, is equal to some other type. When we’re treating a
    type as indexed codata we require</p>
    <p><strong>TODO: Complete</strong></p>
    <p>As you might expect, indexed data and indexed codata are duals.
    We can</p>
    <p>We’ll begin by revisiting the definition of algebras we gave in
    Section 5.2, where we said algebra consists of three different kinds
    of methods: constructors, combinators, and interpreters. Indexed
    types allows us to do two things:</p>
    <ul>
    <li><p>We can restrict where constructors and combinators can be
    used. We can think of representing some state using a type parameter
    of <code>F</code>, and we can only call particular methods when we
    are in the correct state. In this case we are working with
    <strong>indexed codata</strong>.</p></li>
    <li><p>We restrict the types produced interpreters, enabling us to
    create type-safe interpreters that guarantee they only encounter
    particular states when they run. Again these constraints are
    represented using type parameters. In this case we are working with
    <strong>indexed data</strong>.</p></li>
    </ul>
    <p>Indexed data are more usually known as <strong>generalized
    algebraic data types</strong>. Indexed codata are sometimes known as
    <strong>typestate</strong>. Both can make use of what is known as
    <strong>phantom types</strong>. Indeed, an early name for indexed
    data was <strong>first-class phantom types</strong>.</p>
    <p>As you might expect, indexed data and indexed codata are dual are
    one another. I’ve tried to represent this in the description above.
    Another way to look at this is terms of type equalities, which are
    proofs or guarantees that a particular type parameter is equal to a
    particular concrete type. When we work with indexed codata we
    require the user supplies us with these type equalities. When we
    work with indexed data we discover these type equalities as we
    destructure the data.</p>
    <h2 data-number="13.1" id="sec:indexed-types:phantom"><span class="header-section-number">13.1</span> Phantom Types</h2>
    <p>Phantom types are a basic building block of indexed types, so
    we’ll start with an example of them. A phantom type is simply a type
    parameter that doesn’t correspond to any value. In the example
    below, the type parameter <code>A</code> is a phantom type, because
    there is no value of type <code>A</code>, while <code>B</code> is
    not because there is a value of that type.</p>
    <div class="sourceCode" id="cb822"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb822-1"><a href="#cb822-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> PhantomExample<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>value<span class="op">:</span> B<span class="op">)</span></span></code></pre></div>
    <p>We can phantom types to shift constraints to compile time.</p>
    <p>A simple example involves units of measurement. Most of the world
    has standardized on SI units, such as metres and litres. However,
    other measuring systems, such as Imperial units, remain in use some
    countries or in some niches within countries that otherwise use
    metric. Somtimes differences between different measurement systems
    can cause problems. A dramatic example is the <a href="https://en.wikipedia.org/wiki/Mars_Climate_Orbiter#Cause_of_failure">loss
    of the Mars orbiter</a>, caused by two software components using
    incompatible measurements (one using metric, and one using US
    customary measurements.)</p>
    <p>Using phantom types we can annotate measurements with their
    units, which in turn can prevent us ever using incompatible units.
    Let’s work with just length, which is sufficient to show the idea.
    We’ll start by defining a length type with a phantom type recording
    the unit, and a method that allows us to add together lengths.</p>
    <div class="sourceCode" id="cb823"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb823-1"><a href="#cb823-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> Length<span class="op">[</span><span class="bu">Unit</span><span class="op">](</span>value<span class="op">:</span> <span class="ex">Double</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb823-2"><a href="#cb823-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">+(</span>that<span class="op">:</span> Length<span class="op">[</span><span class="bu">Unit</span><span class="op">]):</span> Length<span class="op">[</span><span class="bu">Unit</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb823-3"><a href="#cb823-3" aria-hidden="true" tabindex="-1"></a>    Length<span class="op">[</span><span class="bu">Unit</span><span class="op">](</span><span class="kw">this</span><span class="op">.</span>value <span class="op">+</span> that<span class="op">.</span>value<span class="op">)</span></span>
<span id="cb823-4"><a href="#cb823-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>We’ll need to define a few unit types to use this, and some
    <code>Lengths</code> using these units.</p>
    <div class="sourceCode" id="cb824"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb824-1"><a href="#cb824-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Metres</span>
<span id="cb824-2"><a href="#cb824-2" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Feet</span>
<span id="cb824-3"><a href="#cb824-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb824-4"><a href="#cb824-4" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> threeMetres <span class="op">=</span> Length<span class="op">[</span>Metres<span class="op">](</span><span class="dv">3</span><span class="op">)</span></span>
<span id="cb824-5"><a href="#cb824-5" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> threeFeetAndRising <span class="op">=</span> Length<span class="op">[</span>Feet<span class="op">](</span><span class="dv">3</span><span class="op">)</span></span></code></pre></div>
    <p>Now we can add <code>Lengths</code> together if they have the
    same unit.</p>
    <div class="sourceCode" id="cb825"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb825-1"><a href="#cb825-1" aria-hidden="true" tabindex="-1"></a>threeMetres <span class="op">+</span> threeMetres</span>
<span id="cb825-2"><a href="#cb825-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res0: Length[Metres] = Length(value = 6.0)</span></span></code></pre></div>
    <p>However if we try to add <code>Lengths</code> with different
    units the code will not compile.</p>
    <div class="sourceCode" id="cb826"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb826-1"><a href="#cb826-1" aria-hidden="true" tabindex="-1"></a>threeMetres <span class="op">+</span> threeFeetAndRising</span>
<span id="cb826-2"><a href="#cb826-2" aria-hidden="true" tabindex="-1"></a><span class="co">// error:</span></span>
<span id="cb826-3"><a href="#cb826-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Found:    (repl.MdocSession.MdocApp.threeFeetAndRising :</span></span>
<span id="cb826-4"><a href="#cb826-4" aria-hidden="true" tabindex="-1"></a><span class="co">//   repl.MdocSession.MdocApp.Length[repl.MdocSession.MdocApp.Feet])</span></span>
<span id="cb826-5"><a href="#cb826-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Required: repl.MdocSession.MdocApp.Length[repl.MdocSession.MdocApp.Metres]</span></span>
<span id="cb826-6"><a href="#cb826-6" aria-hidden="true" tabindex="-1"></a><span class="co">// threeMetres + threeFeetAndRising</span></span>
<span id="cb826-7"><a href="#cb826-7" aria-hidden="true" tabindex="-1"></a><span class="co">//               ^^^^^^^^^^^^^^^^^^</span></span></code></pre></div>
    <p>There is one big problem with phantom types on their own: there
    is no way to use the information stored in the phantom type in
    further processing. For example, force times length gives torque
    (with the SI unit of newton-metres). However we cannot define a
    <code>*</code> method on <code>Length</code> that can only be called
    if the <code>Unit</code> is <code>Metre</code> using just the tool
    of phantom types. Similarly, we cannot define, say, a
    <code>toString</code> method that uses the <code>Unit</code> type to
    appropriately print the result. Solving these problems leads us to
    indexed codata, so let’s now look at that.</p>
    <p>We’ll solve all these problems in due course, but before we move
    on let’s see another, more complex, example of phantom types to give
    you a better understanding of their power.</p>
    <p>Our next example will represent a subset of <a href="https://html.spec.whatwg.org/multipage/">HTML</a>, the
    language used to write web pages, in a typesafe way. An example of
    HTML is below.</p>
    <div class="sourceCode" id="cb827"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb827-1"><a href="#cb827-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> html<span class="dt">&gt;</span></span>
<span id="cb827-2"><a href="#cb827-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb827-3"><a href="#cb827-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">head</span><span class="dt">&gt;&lt;</span><span class="kw">title</span><span class="dt">&gt;</span>Our Amazing Web Page<span class="dt">&lt;/</span><span class="kw">title</span><span class="dt">&gt;&lt;/</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb827-4"><a href="#cb827-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb827-5"><a href="#cb827-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">h1</span><span class="dt">&gt;</span>This Is Our Amazing Web Page<span class="dt">&lt;/</span><span class="kw">h1</span><span class="dt">&gt;</span></span>
<span id="cb827-6"><a href="#cb827-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">p</span><span class="dt">&gt;</span>Please be in awe of its <span class="dt">&lt;</span><span class="kw">strong</span><span class="dt">&gt;</span>amazingness<span class="dt">&lt;/</span><span class="kw">strong</span><span class="dt">&gt;&lt;/</span><span class="kw">p</span><span class="dt">&gt;</span></span>
<span id="cb827-7"><a href="#cb827-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb827-8"><a href="#cb827-8" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code></pre></div>
    <p>In HTML the content of the page is marked up with tags, like
    <code>&lt;h1&gt;</code>, that give it meaning. For example,
    <code>&lt;h1&gt;</code> means a heading at level one, and
    <code>&lt;p&gt;</code> means a paragraph. An opening tag is closed
    by a corresponding closing tag such as <code>&lt;/h1&gt;</code> for
    <code>&lt;h1&gt;</code> and <code>&lt;/p&gt;</code> for
    <code>&lt;p&gt;</code>.</p>
    <p>There are rules that control where tags are allowed. The complete
    set of tags, and their associated rules, is very complex. We’ll use
    the following, much simplified, rules:</p>
    <ul>
    <li>the <code>body</code> tag can only contain block level
    tags;</li>
    <li>block level tags are <code>h1</code> and <code>p</code> and can
    only contain inline tags; and</li>
    <li>inline tags are <code>strong</code> and <code>em</code> and can
    only contain inline tags.</li>
    </ul>
    <p>We’re missing one thing: we need to be able to end our recursion
    in text content. In fact we have two different kinds of tags: those
    that can contain text content in addition to other tags (we’ll call
    these content tags) and those that cannot (which we will call
    structural tags.)</p>
    <h2 data-number="13.2" id="indexed-codata"><span class="header-section-number">13.2</span> Indexed Codata</h2>
    <p>The basic idea of indexed codata is to prevent methods being
    called unless certain conditions, encoded in types, are met. More
    precisely, methods are guarded by type equalities that callers must
    prove they satisfy to call a method. The contextual abstraction
    features, <code>given</code> instances and <code>using</code>
    clauses, are used to implement this in Scala.</p>
    <p>We’ll start our exploration of indexed codata with a very simple
    example. We are going to define a switch that can only be turned on
    when it is off, and off when it is on. Since this is codata, we
    start with an interface.</p>
    <div class="sourceCode" id="cb828"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb828-1"><a href="#cb828-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Switch <span class="op">{</span></span>
<span id="cb828-2"><a href="#cb828-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> on<span class="op">:</span> Switch</span>
<span id="cb828-3"><a href="#cb828-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> off<span class="op">:</span> Switch</span>
<span id="cb828-4"><a href="#cb828-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>There are no constraints on this interface as defined; we can
    turn any switch on, even if it is already on, and vice versa. The
    first step to implement such a constraint is to add a type
    parameter, which will hold the state of the <code>Switch</code>.</p>
    <div class="sourceCode" id="cb829"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb829-1"><a href="#cb829-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Switch<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb829-2"><a href="#cb829-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> on<span class="op">:</span> Switch<span class="op">[</span>A<span class="op">]</span></span>
<span id="cb829-3"><a href="#cb829-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> off<span class="op">:</span> Switch<span class="op">[</span>A<span class="op">]</span></span>
<span id="cb829-4"><a href="#cb829-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>This type parameter doesn’t correspond to any data we store in
    <code>Switch</code>, so it is a phantom type. This is the first part
    of implementing indexed codata. We are now going to add constraints
    that say we can only call a certain method when this type parameter
    corresponds to a particular concrete type. It is in this way that
    indexed codata goes beyond what phantom types alone can do: we can
    inspect, at compile-time, the type of a type parameter and make
    decisions based on this type.</p>
    <p>Implementing these constraints has two parts. The first is
    defining types to represent on and off.</p>
    <div class="sourceCode" id="cb830"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb830-1"><a href="#cb830-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> On</span>
<span id="cb830-2"><a href="#cb830-2" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Off</span></code></pre></div>
    <p>The second step is to add the constraints to the relevant methods
    on <code>Switch</code>. Here is how we do it.</p>
    <div class="sourceCode" id="cb831"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb831-1"><a href="#cb831-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Switch<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb831-2"><a href="#cb831-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">on</span><span class="op">(</span>using ev<span class="op">:</span> A <span class="op">=:=</span> Off<span class="op">):</span> Switch<span class="op">[</span>On<span class="op">]</span></span>
<span id="cb831-3"><a href="#cb831-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">off</span><span class="op">(</span>using ev<span class="op">:</span> A <span class="op">=:=</span> On<span class="op">):</span> Switch<span class="op">[</span>Off<span class="op">]</span></span>
<span id="cb831-4"><a href="#cb831-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>We can create an implementation to show it really works.</p>
    <div class="sourceCode" id="cb832"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb832-1"><a href="#cb832-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> SimpleSwitch<span class="op">[</span>A<span class="op">]()</span> <span class="kw">extends</span> Switch<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb832-2"><a href="#cb832-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">on</span><span class="op">(</span>using ev<span class="op">:</span> A <span class="op">=:=</span> Off<span class="op">):</span> Switch<span class="op">[</span>On<span class="op">]</span> <span class="op">=</span></span>
<span id="cb832-3"><a href="#cb832-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">SimpleSwitch</span><span class="op">()</span></span>
<span id="cb832-4"><a href="#cb832-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">off</span><span class="op">(</span>using ev<span class="op">:</span> A <span class="op">=:=</span> On<span class="op">):</span> Switch<span class="op">[</span>Off<span class="op">]</span> <span class="op">=</span></span>
<span id="cb832-5"><a href="#cb832-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">SimpleSwitch</span><span class="op">()</span></span>
<span id="cb832-6"><a href="#cb832-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb832-7"><a href="#cb832-7" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> SimpleSwitch <span class="op">{</span></span>
<span id="cb832-8"><a href="#cb832-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> on<span class="op">:</span> Switch<span class="op">[</span>On<span class="op">]</span> <span class="op">=</span> <span class="fu">SimpleSwitch</span><span class="op">()</span></span>
<span id="cb832-9"><a href="#cb832-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> off<span class="op">:</span> Switch<span class="op">[</span>Off<span class="op">]</span> <span class="op">=</span> <span class="fu">SimpleSwitch</span><span class="op">()</span></span>
<span id="cb832-10"><a href="#cb832-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Here are some examples of using it correctly</p>
    <div class="sourceCode" id="cb833"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb833-1"><a href="#cb833-1" aria-hidden="true" tabindex="-1"></a>SimpleSwitch<span class="op">.</span>on<span class="op">.</span>off</span>
<span id="cb833-2"><a href="#cb833-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: Switch[Off] = SimpleSwitch()</span></span>
<span id="cb833-3"><a href="#cb833-3" aria-hidden="true" tabindex="-1"></a>SimpleSwitch<span class="op">.</span>off<span class="op">.</span>on</span>
<span id="cb833-4"><a href="#cb833-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: Switch[On] = SimpleSwitch()</span></span></code></pre></div>
    <p>Incorrect uses fail to compile.</p>
    <div class="sourceCode" id="cb834"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb834-1"><a href="#cb834-1" aria-hidden="true" tabindex="-1"></a>SimpleSwitch<span class="op">.</span>on<span class="op">.</span>on</span>
<span id="cb834-2"><a href="#cb834-2" aria-hidden="true" tabindex="-1"></a><span class="co">// error: </span></span>
<span id="cb834-3"><a href="#cb834-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Cannot prove that MdocApp1.this.On =:= MdocApp1.this.Off.</span></span></code></pre></div>
    <p>The constraint is made of two parts: using clauses, which we
    learned about in 4, and the <a href="https://www.scala-lang.org/api/current/scala/=:=.html"><code>A =:= B</code></a>
    construction, which is new. <code>=:=</code> represents a type
    equality. If a given instance <code>A =:= B</code> exists, then the
    type <code>A</code> is equal to the type <code>B</code>. (Note we
    can write this with the more familiar prefix notation
    <code>=:=[A, B]</code> if we prefer.) We never create these
    instances ourselves. Instead the compiler creates them for us. In
    the <code>on</code> method, we are asking the compiler to construct
    an instance <code>A =:= Off</code>, which can only be done if
    <code>A</code> <em>is</em> <code>Off</code>. This in turn means we
    can only call the method when the <code>Switch</code> is
    <code>Off</code>. This is the core idea of indexed codata: we
    reflect states as types, and restrict method calls to a subset of
    states.</p>
    <p>This is a different use of contextual abstraction to type
    classes. Type classes associate operations with types. What we’re
    doing here is proving some property of a type with respect to
    another type. More precisely we’re proving that a type parameter is
    equal to a particular type. The given instance only exists when the
    compiler can prove this is the case. Hence these given instances are
    sometimes called <strong>evidence</strong> or
    <strong>witnesses</strong>. This different view subsumes type
    classes, as we can think of type classes as evidence that a type
    implements a certain interface.</p>
    <h4 class="unnumbered" id="exercise-torque">Exercise: Torque</h4>
    <p>In Section 13.1 we saw how we could use phantom types to
    represent units. We also ran into a limitation: we had no way to
    inspect the phantom types and hence make decisions based on them.
    Now, with indexed codata, we can do that.</p>
    <p>Below if the definition of <code>Length</code> we previously
    used. Your mission is to:</p>
    <ol type="1">
    <li>implement a type <code>Force</code>, parameterized by a phantom
    type that represents the units of force;</li>
    <li>implement a type <code>Torque</code>, parameterized by a phantom
    type that represents the units of torque;</li>
    <li>define types <code>Newtons</code> and <code>NewtonMetres</code>
    to represent force in SI units;</li>
    <li>implement a method <code>*</code> on <code>Force</code> that
    accepts a <code>Length</code> and returns a <code>Torque</code>. It
    can only be called if the <code>Force</code> is in
    <code>Newtons</code> and the <code>Length</code> is in
    <code>Metres</code>. In this case the <code>Torque</code> is in
    <code>NewtonMetres</code>. (Torque is force times length.)</li>
    </ol>
    <div class="sourceCode" id="cb835"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb835-1"><a href="#cb835-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> Length<span class="op">[</span><span class="bu">Unit</span><span class="op">](</span>value<span class="op">:</span> <span class="ex">Double</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb835-2"><a href="#cb835-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">+(</span>that<span class="op">:</span> Length<span class="op">[</span><span class="bu">Unit</span><span class="op">]):</span> Length<span class="op">[</span><span class="bu">Unit</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb835-3"><a href="#cb835-3" aria-hidden="true" tabindex="-1"></a>    Length<span class="op">[</span><span class="bu">Unit</span><span class="op">](</span><span class="kw">this</span><span class="op">.</span>value <span class="op">+</span> that<span class="op">.</span>value<span class="op">)</span></span>
<span id="cb835-4"><a href="#cb835-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <div class="solution">
    <p>Defining <code>Force</code>, <code>Torque</code>, and the unit
    types is just repeating the pattern we saw in the example code.</p>
    <div class="sourceCode" id="cb836"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb836-1"><a href="#cb836-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Newtons</span>
<span id="cb836-2"><a href="#cb836-2" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> NewtonMetres</span>
<span id="cb836-3"><a href="#cb836-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb836-4"><a href="#cb836-4" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> Force<span class="op">[</span><span class="bu">Unit</span><span class="op">](</span>value<span class="op">:</span> <span class="ex">Double</span><span class="op">)</span></span>
<span id="cb836-5"><a href="#cb836-5" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> Torque<span class="op">[</span><span class="bu">Unit</span><span class="op">](</span>value<span class="op">:</span> <span class="ex">Double</span><span class="op">)</span></span></code></pre></div>
    <p>To define the <code>*</code> method on <code>Force</code> we need
    constraints that <code>Forces</code> <code>Unit</code> type is
    <code>Newtons</code>, and <code>Lengths</code> <code>Unit</code>
    type is <code>Metres</code>. These are both type equalities, so we
    can express them with <code>=:=</code>.</p>
    <div class="sourceCode" id="cb837"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb837-1"><a href="#cb837-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> Force<span class="op">[</span><span class="bu">Unit</span><span class="op">](</span>value<span class="op">:</span> <span class="ex">Double</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb837-2"><a href="#cb837-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">*[</span>L<span class="op">](</span>length<span class="op">:</span> Length<span class="op">[</span>L<span class="op">])(</span>using <span class="bu">Unit</span> <span class="op">=:=</span> Newtons<span class="op">,</span> L <span class="op">=:=</span> Metres<span class="op">):</span> Torque<span class="op">[</span>NewtonMetres<span class="op">]</span> <span class="op">=</span></span>
<span id="cb837-3"><a href="#cb837-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Torque</span><span class="op">(</span><span class="kw">this</span><span class="op">.</span>value <span class="op">*</span> length<span class="op">.</span>value<span class="op">)</span></span>
<span id="cb837-4"><a href="#cb837-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    </div>
    <h3 data-number="13.2.1" id="api-protocols"><span class="header-section-number">13.2.1</span> API Protocols</h3>
    <p>An API protocol defines the order in which methods must be
    called. The protocol in the case of <code>Switch</code> is that we
    can only call <code>off</code> after calling <code>on</code> and
    vice versa. This protocol is a simple finite state machine, and
    illustrated in Figure 12. Many common types have similar protocols.
    For example, files can only be read once they are opened and cannot
    be read once they have been closed.</p>
    <figure id="fig:indexed-types:switch">
    <embed src="data:application/pdf;base64,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"></embed>
    <figcaption>Figure 12: The switch API protocol</figcaption>
    </figure>
    <p>Indexed codata allows us to enforce API protocols at
    compile-time. Often these protocols are finite-state machines. We
    can represent these protocols with a single type parameter that
    represents the state, as we did with <code>Switch</code>. We can
    also use multiple type parameters if that makes for a more
    convenient representation.</p>
    <p>Let’s see an example using multiple type parameters. We’re going
    to build an API that represents a very limited subset of <a href="https://html.spec.whatwg.org/multipage/">HTML</a>, the
    language the defines web pages. An example of HTML is below.</p>
    <div class="sourceCode" id="cb838"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb838-1"><a href="#cb838-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> html<span class="dt">&gt;</span></span>
<span id="cb838-2"><a href="#cb838-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb838-3"><a href="#cb838-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">head</span><span class="dt">&gt;&lt;</span><span class="kw">title</span><span class="dt">&gt;</span>Our Amazing Web Page<span class="dt">&lt;/</span><span class="kw">title</span><span class="dt">&gt;&lt;/</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb838-4"><a href="#cb838-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb838-5"><a href="#cb838-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">h1</span><span class="dt">&gt;</span>This Is Our Amazing Web Page<span class="dt">&lt;/</span><span class="kw">h1</span><span class="dt">&gt;</span></span>
<span id="cb838-6"><a href="#cb838-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">p</span><span class="dt">&gt;</span>Please be in awe of its <span class="dt">&lt;</span><span class="kw">strong</span><span class="dt">&gt;</span>amazingness<span class="dt">&lt;/</span><span class="kw">strong</span><span class="dt">&gt;&lt;/</span><span class="kw">p</span><span class="dt">&gt;</span></span>
<span id="cb838-7"><a href="#cb838-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb838-8"><a href="#cb838-8" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code></pre></div>
    <p>In HTML the content of the page is marked up with tags, like
    <code>&lt;h1&gt;</code>, that give it meaning. For example,
    <code>&lt;h1&gt;</code> means a heading at level one, and
    <code>&lt;p&gt;</code> means a paragraph. An opening tag is closed
    by a corresponding closing tag such as <code>&lt;/h1&gt;</code> for
    <code>&lt;h1&gt;</code> and <code>&lt;/p&gt;</code> for
    <code>&lt;p&gt;</code>.</p>
    <p>There are several rules for valid HTML<a href="#fn14" class="footnote-ref" id="fnref14" role="doc-noteref"><sup>14</sup></a>. We’re going to focus on the
    following:</p>
    <ol type="1">
    <li>Within the <code>html</code> tag there can only be a
    <code>head</code> and a <code>body</code> tag, in that order.</li>
    <li>Within the <code>head</code> tag there must be exactly one
    <code>title</code>, and there can be any other number of allowed
    tags (of which we’re only going to model <code>link</code>).</li>
    <li>Within the <code>body</code> there can be any number of allowed
    tags (of which we are only going to model <code>h1</code> and
    <code>p</code>).</li>
    </ol>
    <p>We’re going to use a Church-encoded representation for HTML, so
    tags are created by method calls. Figure 13 shows the finite state
    machine representation of the API protocol. I find it easier to read
    as a regular expression, which we can write down as</p>
    <p><span class="math display">head link<sup>*</sup> title link<sup>*</sup> body (h1 | p)<sup>*</sup></span></p>
    <figure id="fig:indexed-types:html">
    <embed src="data:application/pdf;base64,JVBERi0xLjcKJbXtrvsKNCAwIG9iago8PCAvTGVuZ3RoIDUgMCBSCiAgIC9GaWx0ZXIgL0ZsYXRlRGVjb2RlCj4+CnN0cmVhbQp4nK1Yy45bNwzd6yu0tBdRReq9NVC0CFqgbWYXZBE4r6YzLfoAiv59D6nH9VzHySyCIHZEixR1SB5SIevx5xnhgzna84P503iV/fKd/ea1t+//NmT/hew5/n40L19Z77x9Y8jbH22rLuZmKbJjDvZhCVJ1idjW5DizpUKuULO5ulbCWp5tYpfrXBsbmovy+9Cey2H9vAScXAtTmdgVLst2XxrsnoePDdO1rrzz/GxfjGv/9d6e7gxF573nGAc8a5kiXOCcMlRhiKmWZO8ezDfvnvln3pK9e2deHr4/cj68PVI6vJaPN8dXd8/Nt3cbslSb8xlGfBjILQlVR1VAyfAT38G7gFtk6vfryzOOL/CpmrUhRCe+LP25Hiecl6RWx6lOAxbnABNr5gljfV4eDMF0cKrvbvBkBClKpDqEPt+E8Icj8+HXI/nD70cqh9+uIGzZceuAtEiCoEdACJ5xdpUESViPcJzZeQl8cRQKxAX5sHN4CwyUBRWCw6FVMRuyS0UkweWS7T32VFfk6uxdBfT39oO51jsZLgOiVR5LkooGifMIcm4SQ04jyH15thxmkMcGHkGd+nO90nhJcFsJ07AAv5JE0WxndIGoTCeGZDk5Teyu8eRIc9gi/ZliuTuGhkg/K4d/JNz38vH2OtySdvECS+Lmst9KmKp3XGmtGY6kEj/t9jIru3KS8qmaFQ+KoEqG3v22B5coKvlgrvVORn9HSsKRGjV1YnA+BuGmqvogHQCN4DXOq6TH8qw8GCuiPTdIAVabA0IvhABtpHPxrvib6VtJqwGbWlKUoIVzp09I3hLnDgRDU3evg5vUAk+iZrOvWeyg3EqIg14QW48dzFpcDd+Mqgo5aNKIt7fQBhIZNQiMKUdFG9WFIAZcnaqCjUICXUtdp5wH2Hu1kwlw9zGDLslgwCAwbgwaEM9HDAo3HzFoQP5fMuhaL4abkkGBw8Bi0HnCYtDpwRBMB6f67gZPrquAzP8aDMoFBV47+AI1olFhzvfSD8hYRtWB9zTKESkSPHKwdA6t7VaUA3IDOzR7cmEJDfbnTqESx3tsaT3FmTTBJMrXaicTc+pUu8p+STAkCB1HjAFRiwUsD9aPIY0ho6/PNlLDOJHNtgWgobY2E3O9mGJJuB82TOgsgcPMdkoXiMr0Y0iWn9PE7iZPjnZEl3kCi56OHA9/HKli2sDHf5+INqancMmgGoS2MV3IKLm0MWhoyeWWvsCgAcygabyYUNC7bBj3254LBr3WQ1GDDR4xaEDFXzCoZP4Fg86CWwwaJAgXDKoFuBg0pPZlBg2ZH7OhaD1i0JDSjkGvdHATeByE2HRq0BpAtRWpNpk/CGwAGihSS9wTJjS02TLGl3jDu+g95lZp7zALShGwwSal82VB+xOwcYDvEg8XxMNrvZNJCEYQVkXd9YRYEqS7D80mZLm6DKLLqMwEbc36scYAj2ynJLU1t3juXXeamOtxyHlJkFxIlGlBpvXK0awz+lr2DyeGYPo41XeXePogDy6fkzz5z0/ydFVMMUdtg0KdpJmKh0lv8jI1EVm0T6RH1fAW3Cc2jCPS19BdSiu34tvQC5KOYgnoISRoDjJjisSTzJoRN6+1540ftXSldjJZpl+J1YrukiABpYtmZE6jqAwlO1IbT6ixBvQy4wcy25bqH5lY6y26Q9KKDmPDgsUXfjfrjL7G/unEEEwfh/r+Ek+PLtBuX4ru4afj3cddWHPvdxHBCvKoiNKsES5hLpl3EvI66CyH8Nak+SeDC14WEwGhB89G31v4BZ0VtlKvEMGspFWKMmZ8OhES0knsyxuDvPBHqjKLsWKP6yHuqci/an/Slp4J13oodEKSgseBsTCEJBXaN5gBs6H0fS1BBtpFM3VW4FhKBbI0ZrM24EWEbo5uKqAm3DyjBNBehHVuXCeSjkDIDgpKNbBRlku4i4AFXGEl+dqvstcRyor9iQdWDaSopDBQiVofCVQs3sha7CXM1KGRapSYb6JN4/8K8IaIWdHGQNp6O+/Yyh7pTYI/cxlo7/Xg49T0pP9b8dBjKYQMEs5efIxKGrIOnjRj8JrRNfy/5SN2eYm2x02LsvUAAwcJQHAxRT0I1SOYqId7LXEQP0fsCuj2Se/K2kLwpemAIVCeWnK3C1oYSylZbWBmSjIgkvaKKReWdFk9wgbzftfHpJ6pgcvxSK6dk9BVkZrDl3sYl4duFG1phnKFK6V3W8F+HYMvzM/mf5TcveEKZW5kc3RyZWFtCmVuZG9iago1IDAgb2JqCiAgIDE2NzQKZW5kb2JqCjMgMCBvYmoKPDwKICAgL0V4dEdTdGF0ZSA8PAogICAgICAvYTAgPDwgL0NBIDEgL2NhIDEgPj4KICAgPj4KICAgL0ZvbnQgPDwKICAgICAgL2YtMC0wIDcgMCBSCiAgID4+Cj4+CmVuZG9iago4IDAgb2JqCjw8IC9UeXBlIC9PYmpTdG0KICAgL0xlbmd0aCA5IDAgUgogICAvTiAxCiAgIC9GaXJzdCA0CiAgIC9GaWx0ZXIgL0ZsYXRlRGVjb2RlCj4+CnN0cmVhbQp4nDNTMOCK5orlAgAGOAFdCmVuZHN0cmVhbQplbmRvYmoKOSAwIG9iagogICAxNgplbmRvYmoKMTEgMCBvYmoKPDwgL0xlbmd0aCAxMiAwIFIKICAgL0ZpbHRlciAvRmxhdGVEZWNvZGUKICAgL0xlbmd0aDEgMTU2ODQKPj4Kc3RyZWFtCnic5Xt7fFTVtfDa+5x5z2TOzGTeyZwzc2bymkkm5D1hJCckIUBAIs+EmmZCeAqWJDwUBIlVVIJKru9HBaxFrWAZEh9BbY1ea6u1V+zDqrVCP7HWWm5pi972Cplv7TMBoV/v/b7v9/v++87JWmvvvfbZe5+1116PkwQIABhhEDiQeq/u6ft12cPfAcgfBqBLezdvlP469/0bAMQ/AuheXdm36uraTY/HAQrTAJoNq9ZtWVksR/fiCIcA8k6uXtGz/I2zp1oBSsPYVrMaGxzF5u9i/Uqsh1dfvfHaloX897A+iPXmdet7e4BwY1h/Feszr+65tk+7UcCxysxYl/oGVvT9bGX0DNZjAFYPULZYDd64Wh3MPULJC/QHoAUdfWkENPwY/cHTHBh1rPAMAa9eq3kJ+RQ4UgwGspZ8HTxR4YvkueTlwpnk3HNJaMCycBbRlPKgLWiLICLAw1mJGz+raOBLkPhxnJKAjPM+rJkDLfAjpb+vdX/rsdYTrbyjdW+eUtOORWoX/aZgKCT684KhKtFfFgy1iP5pwRAV/cag7BD9/qAcEf2lQbla9F8WlHFIORz2T7vsMpPJSMtKS/Py/Hq7I0SVEDkeIlKoPNQX2h86FjoR0obGqKT4hNZU63grJ7WS1pZIqLq9KlVFq/bO6PnAE50rnBlg7yP0D5zp6h9Iqm8m4J3F9kQcm6KT15Ry0hUlXSRoqyosKCyQ5eqgUw7ptFqnLdftcrsqK53B6sqK2ppqlMg/tvzjI+QA3WwxStHyctpcXh6V3BajGCsvP/di+YIC77khlTXl3AvlCws8WQ5tmVIeFT30V+Sm1UGv3ROJuIXG5WfvWZWtTJG2kocner+qcWsv6oZbgbs5J3OSW8ClIRfyaZPitXd7urwpSOW+w2m8Ul7CjeBS8hLiWGZcMTbNrtKLTZauGlYdLSqqUpu/VlJW5dd6DR2Or7u63Us9X/PpCGfQ6gx6s8Y5S7uL3qa9xTwk7Mx/lB70POP4BX3P+r5whv6Vc9hR8fSCTtCndCl9n25Qt8vwsu7H1tM6M090lpsoZ3g+cwK0mRNKU41hBm01zBMX0oWGZXSA7nLs8j7g+I7hO8Yx/TOGtPFH9BN6wnzGmKs/piOgO6ajkm5Yt1+X1vG67XwulLucbK0Oe8Le7dzh3Oc87uSdTv/PecKPZY6N5CaQ/H7Ewci7ykx7gp9iMl3pJ/6ITad7U+8q8iesLrLetcO1x8W5zuTmDupJuX5YT8v1e/TH9ZygV/T4Cvq0/oReq38yx8nDLpTuGBdT7OU5Sk57Dgc5Qo6Uw53OITlsJQYUZk5ToKnNE8UDFO0fGJh7rj8pnOvq70Jyqqs/KpyChlMDDadQzQZsiXhXU8fIeifp6oyyc8ZUM8G0D+rqoL+LNHU8rQVCaX9n/8CkbsJA05UdR0GHk5nkhFkpTVgQ9Dj5SFFClyVaRvzZmj/Lm6wZszVjtmZQa0qOIeEUvAmvZEtYECAaJVGIXnR1OrSo4hU1tW6tVg7R6ip7ZYXLGQmiohfIIe37ZPnyW5buLBWdb9x/4LM/P/vga+duIU9oBG9vzYIb6dQ3N27svTZ3128Jee8zovvJk/Ud4TrlBlVPZ2VOcbu4w1ABl9FFynpT3lAltS+oIXZJTAw2PGF41sjZo/btsL3yZtht2l2tzbe76oWGwQbekDdHM0fbIrWE5tQrDbvy9cYcnQShWaTNOMs0q7qttql+1mVLTKtMOw03GW8yWRe6bnRRsaG7gab0lVCVLCsurXqB+MEM5sz4s4aEuciUMDNh+OqrBXO7mSqIUmZOUslmM29OepgSFZsS8zzdnvUeLu7Z4aGe60WBCJGArjypJGkyxveVDpbS0uriWPkYN0Ox8aay8VJSmopApcVsrqqqfIGsgjBEcKLcnARExMhgZDjCK5HTEToYIZEXaBOeHifujZhwjpFVSsAfT0zRKTkJSdeOR4kTdOS0jrTriK5pWtM3VC1DnRmIzj115lSU6dmAqkjZ+4sutHJnzp3sEk71o9IhN2pLdKmqFD9lsyfwB7WtaYvSWj01T9Y4autq6qjWoDfqqTYYkkJUW21KSGDLd+SB3WEVLXkkJE/VJPKgTl8lkeoqkz1PyCM5IUT12mQeUxqcF9UHEf5ES0pKbrjhBjJA+qGf9A8A0/YGO2o72ldVkZ+egq9WNpY5MSKo5NmcRK2EL8uOrZmRE4rJlPBIJrRZpkTeWOa04jMljLhZtUWMGpEakRqQGhKXKC3TW+iKaHWosgXVVbU1NbXVVQXMJjvdudm2msoKZrzRqrtczHjXOll7oU3L7HYuNtHW28M1l3VfFyj+yR+XLGiIFNB4QSSe3rf18ql5dqPbKpidyb6VU+rJfbF5zYvr5tx0tc37zauapjRfuzi8a2UoFKsvq6gqXTxcLE6P7px4/capuTpLsu7e5rtIV9IbSyVmdmftdXPmJK/R3AEilJKyoxBHO9zaWhVn+jg9WlaVim/jt2mG+MH44fh4XKfEB+MU4q4SZ3SRZpF+YfRenW6mjkjxWmOrcbHxfv7xkv1x3Xj8dJRKEkhBZm5NKMmWpDRP+rq00rhO2irtg33Sk7qjutdKTAV6R6G50R5wNDvzC12NeYH8ZhEfM/ExJ0QiBp0YI7GYyJlEMAXNEtNKuzPlGnQddnGia9hFXZ8Vt2tV31FWxehzrdXaprKmHVkbiKp5bqALlZJd6HSZ8WuwuRPC56fOks8hS1Qt9BVEeX1hpEBfLEGUR1Ski0ikRBOTQLVJ0egNN0BXHV6kvwsVaqC/KxqNaLN7iSbJjfvLNrgwUjm5o26NXG0ro+qmq/v5o6bB2fee+Nu/bplnlTy+qIXYSq1Bl7/UNHG6TJvsjXe0fC297murZlz25Q9/SFrnfvfhmT5B7vvyN4+05tnk/tfJu819iXmrf/zGr0CNeYoB+Ocw5pHgZsUvgEBQ3EQJLaGr6DV0SHpA+q50VDKT0Bi5Q6nMWV6ziF4ZoAbRzwVDrlq/7bKQUfQLQVkSJSgHBUO2T/JsAs2TKaeHQ2QdHaOvKiaXO2QwGPcGe7pUgSbnCueSZ86cYqLE4OVkVyKRDVkGWMji5i6KQ9QopGAybMEYpaKmhr83uPHL31UujjjzCudW0pXrlkiCueLG3m9dv5pco5sYjtRJG7m1O6RYJEJKlC1nDy0Qnbllm1BHk6ioOtRRE4Tg14p3OExS4b7wcHh/+HRYI4Xbw1RhKMwUoaKiSqV19VlaWp6lckSlSpnXV+UpDjhmhyzFAftsOVjobZQCwWaz1+wY1hJtAiBk1jnsxmEDMSQ45quaqhlRrA3V3Fqz2eK1hD1KNOFRTXZNfdWwh7R7SMrT5xn27Pec9mg8I/LIoyyWVe3dKWYOURdPDaDY8D41gLYvq3qq7FRzQdBLo61C13bePjhUPcLQDiWnSjSrXqS4ZOrUkpLk1Ou9UxonmprK/AZdwJdXlENyNXcwRrKkZOpE8Jy0OJEXDvuSi0jPPTHJaw33oc5g3M79B/q8SqJX6quVkmp9dQqDr/Lq9upUdV/1cLWmlCeKWh7EWrpam64+Vk3T1SSFDePVXL7eVRywjnFWxRYqLg6EZ4f0xYGc2XJ+cUAe43KUMnlKYUljeWBKcx7IFZU6X4zqwrJsteYY3a6wblhP0npixbBmn/4tPa8fo99X/MWV+eESsbi9OFXcV8wPFg8Xp4s5KBaKabEa1uS6qopTVY/tYAKNZuNn1dlcFEejMtoSiUmRMqHiibZ7vJyWj3g5dx7RaD0aXx6JEuYY0Cl09eMPoMBR8GiIs3bYnRU3izWYwJm4L25kTZMnnLQ9cmfbOsmVY5oyfWKqQ6k08o1zr9lsypnSNjE1d8YUq+jLK7SS3Cg99Urb4uS2iS1LRC/uRmGBdR65Znv/Nyfyu1z5/nC4dTlZeGCmj22OeqZteKbNqOe1dKqSsSbEBLVrBYI/dxnuMQ6bhs0PWR+0PWR/UNyXGDUaE96Er1votnWL64T1tvXiQ9TwWeCUSAcNN+S8xr1m/ZR+aj1l+5Nd32Br8DSIdVJDYoZ1wLjJqo/TEkGKSAXxRB2pE3ROYRGZLyyUeFlYQpZYfyd8Lmhm2WaKrxheMX5k1LgNLkHMF8UWOt2qNdmsDovPnG8N5IjaBdwifoGmU1hoW+jQeq35+QFxAeUFK6E2u8MheEVfwFtWHCgsDBmpIWAMFgcKCuWawnhjdaCmGeJgcghCWBJzJUIl0SoI5YTmEkKZKRMVq4PwhdRqFASPsRbAPUb+qMzxmN/EjEyLp8Hr9RhN5eZBMz1tJsfMJ8y0zzxupua4273PQzw+MUESwXAZhONxKBPK0mXjZcfKNO1lZLBsuIyWpeoSY+Ta0eBjGMhELz/Tj25irnBKOHW5MPAFK57p6sKw+atEDVkNSS+e3DgGLnZ3AlUpeUtOmSeas1149Rb9ZAGwg2fybAuniDCexbcw3qs6HbOUA/3oQLoGSJd6AUYnalAtZH6v5NpNDWKRPUEQ8hXc/yJrgjIDZEqYGLElrFliyBIWNB6xJVQLko0/SBTDG2KrZSpcVVCIJlir1ekcLjVPRD1GU1JVSJhlcTPLUjup6pOmZd6ns836YAG5Y/7VjZ99tixUHvZOm2gq8BdNfOItmztRNkN2mqw5ks9ZYiOC5o6zfb9stpvNufno6mnZ1PcmfnVdMJ5jDIeJ0+GuJKsmjnXWeUg4bDO5g1dw0/e1+m1yn6rn01DP0+i7RHhdqV9KltKl+UsDa8laujZ/bUAfDzYE5wXv19znf0LzmF9HSX7AxXxVCL2XNSjrPDKIVLDqg2MU8y8DJgyKO6fBbsXh2uEw8DBGi57TG0JulxgNqEkGY0NACHQH9gf4wPO0CFx0fFRa3sVsyhmMDI9CgIm5OqBK21qF8Vv0pIAWhjEVAyimaoTz7b9TDTnL2YnwuvC6mjR1EYes5iQyMxoX5eRqJq6THfwj1gKTQ1y18CV/wbz4uZfLF4ddj3YXVc3WFQiaOROvLAzX1355ZrtYEolUSQO8Ocex7koyLWsXcjN/pkn+ZfDDO0fBgprSaE50k25KG/IfsD3gfcn5kmvM+3uvbl8+2eUj88zzLN3mbsvnHrR7Tk+hh3M5PV4fRxjK9e8nnLOcHyN+JY9w5ZQSrblaH7OaXG9hCvsnJ+dcket/E0zsuMUwgDCXxfPT+TQfCOF5TTi33UEGHQQcgiPtGHccc5xwaB2pvIO7Jv3d+Qyg60wXHhk8RniGzp3MHiBknSQYfgGCHaN/lmbiwQOMHmyVThScmuhVqlFVAUoO1RU1lMx+553KouA0W6E82FzWUfIvtRtK3cX8yxM/n3Hue53TiouW9VZ299LVQdeamQUrVHldhvGCFe2oEx56btg97j7t5twsBmiYUcWoUp+YWkXcI5blNe1uorjb3Sl3n3vYvR876szFAd3sECkOaAvl3EJLoyOQ2+wE0GmNQMIW8+Qw2XytemrVsJm0m0nK3GceNu83nzZrzCOui5x/1kk1JL9y9/jKhAWU6O0v9fDnT+F13qrWiYaGMl+O6PEV2YhNc8eXjYvr8lVvzikPtbKwkOkFh9EQ8L/DcxSAKNTRTqV8KSwN7IJbA7sqH/A9XHjId6jwU98fCj+Jm+tga+GWygcrHqg8EH6y8l3fu4XvFhn5+jH6yah1VU09e6u8UBWjykdOd1WlEowh8gaqKhS5CJE/v6o53BzZ5XuPvBN+v/LjiI4Pk4ilQuCcWr8vN+AKu4qc5WUVLeHZVUtIh3dp4b3UhlFp/SKyNJyq76sfrN9fr/eV+yraARNJXzhQ5I3zWsoF3IF5lbeGHwy/V6mT6pX69vpe2sulNCltSpcq36zd4Nvg7wtsDG8o3Fp0k/Zm/82BPZWD9W/E349/Fv7PsLdTbxX9hmBIEP2uoFwZBo6PQXVUDHOh4rpYJVcWKqquNriKi9xuFy0r0usN+uECUsCOeX21SqYzMjja0FjFqqNNM1Sq5GL7nO48YgyU59G8RXxUrItNYQyhpdqu8Pt5CohO8Byvfsiy2KqAJxL7+EPefjYWEqx7E/UvkrchCD3EA6qPSWI2gmlwVz+zN1O40k/9KjnViflqkn2AGTilGnEWJzJvI7A8OX4KnY2NQYIwMhndNMar5CJPgOh8fq+farUF4QiNVBYUeQoqSVw3pZLIgYJKropMqeQKMcIi5ZqySojkhyohUMFVVxICGAolo9nURr1YtqxGRgMDAzDQD9FJJjDbxiKkXDyX/xDgYwrL2iMs4WGuRY2ZWDmbDWl13MjtM3oGj398brByUcSdz8L+2d/pvXfvtnPXRboTd951+SvPL2/f2P/MDxa/smdah58+HZh+5c4VRxdFauQBbt31wVjEE37umpWPWHW6hm/OveYJ15fr/Y9eO+/OhbyG5a4tmZPcUYxnrZBPOpQW+6CTPO561vVD8rrh1fz3DFr7J0Yy09DiWuLcSW4z7LK+59eJSkU1r35y3CeS15yv+6gikll6IQI6d0RvsqvbGUVHPA8jYZ4cY7idT/F9/DCf5rX8H80KMhXzPgw1LnxsY99Auth5b0sXLWhLt1+x9Ig5MOuIyM+av7Tj++wzD/AIYmYcE8jOpo4XwcdVoKPK5So+FT71X1RFK9kJGM+eUne5huTbIzkFNJJXYIxoC2zWXAnf1CcRlwFLHh2WHBZBIn4OkdPklsCrQRS9eF8x4GUfQdAWYdBL0JvZNtFN2q3GrTlb7de6Nnk25em7OnGPMQpRDHmCLeFHcI5lTh8xqR81OknF5OaHClleUuMOsS8UdnWXCwsoHLt+7ea3dry1ddX2NxdUr52+75s9169p5Q7vveXwdWcHD+x+6vq/X9PYsHfbjyc+3P+vZ25LMftsnpjBneHuhgqyTjloEFCgOdF7iqmjqsy1vOZGzU4tNRg0dr1X7zNEc30FhrA9jAl6HamxV/tb7asNq41rvCt9vf7VsWv1W4xbvNf4Nvqvje0y7vLeD/cb7vPdG30BjlV9rJUNBn00GispMRI9DRCHNzfggFhFAOxGW8BeoJe8Pl95iTEXO8Si0bBBn2uIluAjJT4Db9THkHqNBr1edtjteGK0hWowgastjMuJfGuV2+3zjmEq5d9jJMeNp400Zewz/snIGbc3GOYZug2cYbt+jOQo+dF3rBKxSvskKu3pjpF4rCFGY97Kqu8GWVqDpqFrYO7Jrv6T586g2+zqP3d5y4pmDDLmnjsZnfwdgTt7+jHQzAacLPJESli8CWqM+b9inaBP6pNZl4PHmEQd7PcCuHduh0PduwI5GyBqdUR70Vcp5oRrSQH7XUKhmRx0lpYGj//UptOHoqQkUuQxeCd21xy+Yuqc2vJgosgYaA03TjxnDXoFdyV3d6Qwv7BlooL8Z3GR3WCyRCK8J5jTcPYbO29tjpVUuqzTOvfRUbFMNgtm1IPT6MS0mtXggvuUXMWTwvT5hIcHj+Khm+FmoDmNDrKGNIKB7Edfx6llPZZlVKK/gZWsARe2APmLkkOsVmqgRGPQmykHz5P/wO6zFHtODqaq1eXWHdZh634rb/W6n6dhchKyXy+jLObHOE910ShKYkvABU+NEuvvcmS/57BoeRq9kIafJrODjuSVEzRV5zLqIr7IdP5Hj3x5y0BdgEYiNH/KVvrB3SVSQGQ2ivnoqBrrxsjlR6EMVeiu+up42SbPRv/GvG1FfWX35Om2eJ4LP1/0a/+v894Pa72FQllRQSKSKJxaVF62tHBNYV/ZYJnpNSC+vOK8trxfeX/t1zxRRN4Iv+d+P/weevLPwto8Rc4v0ueIfn0wRES/LiijY3QGZciXYiX5RQ3yPJnKss5ZUoQmm+p1ejv4BPTHiq/Pp/HNKlPjmYZqKCMK5kp0n5oucWUxErLm7C0tGyPXjAZ7eif92DmUGzN3X3TNZb6sIOvLCpgvU0WZ9Vxdp1iqlDifkOeFi915nkhRQbEbnVQ4D1Ght6SSRPxy5eQ3NvaRbdbCLYoQCAVFeSofCkhTISiJQNghwBznBvXr2wAZwM3pwqgx9x9//aV6JdfkV5RC11e+SEe+k1cwt+rcC5WLI7l+dETkz8/+bPjXP54y0Fg9P3/1fTNvWljZTq+b2DQoxiKROnEjt46V2ka2PnYsp9VofGSw4742hxpdcsB+0WkGnl6ONAACtuTADsiQBaSHXEuuJ3fS1+gHUoFULtVLh4KhTIb9vhT2k/kkhfztk3wH8hMX+P/1RXCOD8iD5FtkL977J+/X8P4x+fF/++T5y/q/7WG+ZL7spZmkwiQ1/JdPcyrmUduzlxZBDybEOrBc6GW8UMr5367n/8ML8xVgdgIhD32jHyDzW4STCL+fmJ05q1kL8sRVmRMc08KnJgEgAvfCPgjDaTIFXoFxmA2PQSMmwndDK7yF6XAObCE/wb2RoRmegAgRcZdmgJto4AF4D66EAfgYTkARtMGHxI7jtEAf2uNE5lPEbXBr5ij2MkITfA+N6jqyAOJYnkljmHVHYA8GNW4oyvw08y7WHoaPSThzBGZi6Xdgg0I8E/8CdrgK3sicxZWGYRk8TraRTzEoTsFuvoofyqyFqfAM/JK0YWkubNG8a3gG1uFTjxI3Gc8cz3wCP+AJrMCRvgm34opHYJyWcU2a/XieCjDPuxx6kHsdvEccZAqnZAoz0zMPYOvj8Bcapa9xOlxHFGZBN9wOj6A03oGT8DkxkWryMDmI99vk3zXv4traYBNshUFc+WP47CE4SqaQKdRN3SgtNxTDIuTtgQM4/ygcI22kk4yTl7kDmvKJhkxuxpn5BM9wCXTgCvfByzjHGVKOfXAGLsRt5AP8Rk3FuRvwDZfDt+AYvI3r+BDl/jn8jZTg/Vt6Pd2RWZJ5IvMxsJMjQh1cAUthPWyGa+DbuKuvwKvwZ/Ilurjr6Vv8DzVbNaczd6JsC2A6rn0e9l6AY+/GXRqBMbzfwbe0EQnfoo5cjnZnFdlD7iVj5D3yHtXSIO2nf+DS3E+4D/gajSZTjyO50MqIqCVLYDXuwPUo7TvxfZ+AH8LrxEkKSCm+0Tv4/Bd0Km3G+1H6Fv2Q28nt4c9qbp44MfHZxJeZITzvzah3HSjNJ1EKfyIuXEMxuYpsIB/hyofp01wOJ3AyV801cgu5Tu5W7m7ux9y/8QP8Qf59zSxNj+agrmfiGxNvZ9oyNwGzRVpcVyHEoApqUX9WojatxfX14T0A2+AGGII7UF/uhP1wEN/7JXgdfgm/gT/iDgAJ4prX4OxXo9btJHfg/QA5RF4mmCCQ35Iv2E1DeBfRGtpAm+gMuoruxPtueoy+Q3/P5XG93A5uEO+93LPcezzwPJ/RVOA9U7Nb87j2J7oi3UzdMv2bZ0+dKznXee7DCZjwTXxt4t6Jlyc+ySzObMH1R6AUynClt+AqH0AdPID3k6iJz8Jr8Cb8Sl3rXwhGLqjxHiKjNsRw1xpIK5mF91xyBd6L8F5CluLdQ5aR1XjvIIPkm+RGchO5ndyj3vfjux0g3yXP4v0ceR7vX5Lj5HfkD+QvFJWYcqjNEVpI4zSBb9pEW+k8Oh/vVXQ93n10gG7GHXqcjtKj9B3OwUW4Uq6H6+ce4L7HvcL9gvs7T/kYH+eT/GJ+FX8j/xb/Nv8u/6VG1LRoVmv2al7R+rVV2kXaq7T3aw9rf689i2Flu26ZbpvuF7qMPoLW6kf43s9cYvLi2rfIBk0ufy09jufCw/VpbiGLUGJaupBbx93B/UyzkpzmJPI+GeLWcGszj3Iz6N+49WQxfYmEOFFTz62E29DvHqS/pWfoJ7yTLKSfkiL+X8hzdD3XRLWqXf057+Rv1Pweg7FfQT3dTsbpD7kbuRsz34d6zV5yXLOXvg0Sf4I64Die6lvoffjQv9E1dDd08FWaL2ENyv27mmtR3tPoraSE+wW/Fz7mZPpXcprci1bjp2Q2H6ZfpwlyEC3uORKAU6Qf+sg9oJAXyG/IGBDyBPc4mUPNuFtpaiG16GJ/ygXJLzgjdLI1kgLqJO30NF3Evag9xlVjtnEMfgZbCUfKUXfOXxPwDTwBd9NCtGktaE1+TirAA/ehvT8z8SKz2Jp3NbtRzx7hYjAfMIKlP4F6PBsf492BAXUFPI86eCuU0/thW2aQLEe7PxftJ4UxchXEiQmtpRvXtgP9hYuG0BayXxL/De3/G2j128i/wzVEwpM1DkU849zGt6BlSqH93Y33cujC2rfgTu0zmp/DPOLGkECa2Ita/gF8HX3ORzi/D5K4vqXwCB/DVUtomfvxiW9NzAQF75vhJ4TCdlzzNDzn7fxMtLz3Zq7CN1yDPmoO+sTXYU3mPmjCvZufuTGzG7ozj2SuhFWwIPME2t/NmRGogVs0nXSxJspXoY19nbyK/ujXZDfa7ZnwPtqjCPHAH/D+Hq5omuYFGOJ/hbazIXNb5pfgRHmEUELL0IuehKvh31FuM7lxqJy4nB7JzOD60EMdhysyj2dEYoTVmXVoeV+EAzoN2p5BCGgOKIrSMO2y5NT6RB37Al9ZMaU8XlaKiWRxUWFBJCyHMJgN5Of5fV6P25XrsNsEa47FbMIkU6fV8BwlEGuRZ6SkdEEqzRfIM2eWsrrcgw09FzWk0hI2zbi0T1pKqd2kS3sq2HPlP/RUsj2VCz2JICUhWRqTWmQp/dNmWRojS6/owPLtzXKnlD6llueq5WG1bMFyMIgPSC2e1c1SmqSklvSMzauHWlLNONwRk7FJblphLI3BEaMJiyYspd1y3xHinkbUAnW31B+hoLfgotI+ubkl7ZWb2QrSXKSlZ3m6/YqOlmZ/MNhZGkuTpl55WRrk6WlrVO0CTeo0aW1TWqdOI61hbwO7pSOx8aHbxgRYloqal8vLe67sSHM9nWwOWxTnbU67t570fFXFwe1NHbdczPVzQy2eNRKrDg3dIqX3X9FxMTfIcGcnjpGmkRmpoRk48W0owrYFEs5Fd3Z2pMlOnFBi78HeKft2K+QW1pK6Skob5Ony6qGrUrgxvqE0zN8SHPH5lKOZE+BrkYYWdsjBdINf7uxpzjuSC0Pzt4x6Fcl7Kac0dkSwZcV6JMc6WTBbLi6suMBTS2p3Vmqbf0GuhK1InoXqkJZ6JVxJh4zvVMfQijoY6q3Dbnh1EnwqvRz3Y03a0JQaEuqxXWDPpzURQZaGPgfcf/nUHy9t6Zls0UaEz4EVmZZcUDTkny+no9F0SQlTEF0T7iiucZpary6NbR6jablPkJCg+KAdZdvTWR9H4QeDbHt3jymwDCvpwSs6snUJlvlHQIlHO9M0xTjj5znORYwzeJ5z4fGUjHr8tJr1ONP6ggs/VsHlaFldnyau/4a9IstvWyC3XbG0Q2oZSk3Ktm3hJbUsv+4Cb7JEsgwUeJqPoKRmyah685d2sAb80URmyC1rUjPxqOEa046mDs5PO7Ml6ufUoVB/r7wwMqt0mNlYfESr6v/yMZ0eFVhtIdKMtJCamcWdxmDw//Chscxp9pRKvnps8p3S9dFL61MvqV+yPPMQhwvmC2jbwqVDQ8ZLeDPQWA0NzZClGUOpoZ6xzOAyWRLkoaNcB9cx1NeSOr/9Y5nnd/vTM27rxJdYTepLs/kqffuP0297mnZbk5/rvXrVWX77o/xXGH3mslH4cuO524R6Pcs7Ddg/m+Ei1gUnWmCJgPyJ+UL9hcz3/GXTJkie5kcgc7fDHIRZPEAz/xEU0wQksWxGsGF9GtZzES7TLIYQtrVM8k7zG9j3H/W6FheJTfwhnPVpXMY6TIg7AEz7ASwKJtlFOBTW7bcCOPoAXAgebPOVA/hz2d9vq6uzwV/Qg67H3JxiXh5HHwqan1o9mIHTo5lx7rejLS0VyhjSaJlKR4qKK1TGiC+v4vvcb+khDKZFbDg+4vKrnA9Hpk+fLNTUZQujJaUVxxuN3IfwJwTKfcgdR8eoPjVaVFZxutGCDYS7HqwYp4iwn/sNpBEoKNz7o+GCin0vcW8i/w3udYwJ2GOvj1hsFTjgj7jnMNMQMZZ+ZpLzzGiOrQIaN6BwCYwjPoZwAuE0Ag/rucdhB8IehMMIPFgRiwhxhHmshTvIHcR1HsDnrYjjCOsR9iDwsJB7EtvXMsw9wV2FmyFyt2Fy7US6m7tLpd9B6kP6bWzHFIh7BOuM7pusP4SU8R+cbH8A6y6k90/S+7Ddj/ReNWkXuXsm65u5TepzGyfpfm7DSEAUGgPIlxDKETgs3Y2lu1F0d7PPKIgJBqfr1JmOIK1AenWWori2jwRldY+2j7q9FftRpNtR9NtRcttRctvZbxm4bef7bMv2KeW2YZ9t2Gcb9tmGUinnNuB8G9jnGsQCgoTAodw3oNxZexrxOMIxtf0mxMMI+1mNuwblWIyr2sVdNVIkopKtGk0oFQ0vYCxOcNiVo978ij1f1QxGpohIcyaplfVdoXJXjBrMrHXFqC8/S7HX2sYcrheuQ6CQiziMUIXQjMBzvSPhuPg8dzlcrQclR9xBd3A7+B0avryZ2F/iKqAdD78Idq4UktihWOxOktqUoc8waOAEg2QoNyiGdoNmPaZ1ezhO5OJcAzeP6+Y07FeBuvpK9hm0VVtfOWzab0qbxk3HTJq0dlx7THtCe1qrkbTlWkXbrk1p+7SD2mHtfq1hWDusoylTn2nQxAkmyVRuUkztJo2oI/sbd3LL2KFFLCD0IQwj8CjjbmyXuK8jdONudKMovo7tgBiwJiAcw/IJpBqsWbGfFftZsdWKrVb1fyysKqcdIYXQN8nVXuCcf4b1P804CIXIzcHWHJTtCcSnWQlhNtYsWLNgzYK9jtGzuEIBsYTQjsCpbScQUGsQn+eVT/JTCFqVf1rtc56nsGfpWaWncLyYpIvJ/mIyXEyUZENjhRJCZLfbu+XuSHdR9wF+vbw+sr5o/QF+njwvMq9o3gG+QW6INBQ1HODjcjwSL4of4EVZjIhF4gF+z5zDc16a89YcvnvO+jk75nC17Le3I9HyCpWGIow+M+L1VdRaGy+jh/F1uhHvQziOwIEVsYgQR2hAWI+goYfV1qew9SlsfQrmIXQjaPCpp5iJQSxO8lj7PpXHSoxPL+Fz+PKHRuor5zXOQbPbjbAPgcOxDyH/kNo7WzqstqcRn1Db503236+2s14iwvnnmBFcqpq7pXgMl0IDQjdCH4IG3uKWwHEEHB2xiNCHcBiB55bivYRbQp/C+xA9xMUUyxSnCC4Xeha7TS80CtSMumAhT6j4fhXvUnGDisNKzmzLF7MtP5htuXm2pRALtAh9kIXcreKgYmq0PN1omddoKW604GhuCIKFOlWsZZh8puLLVRxTcoOWvwctfw1a/hy0PBy09ActlwXZc3l4hi00V8UmhjHRZni2igsUk2h5TbQsES21oqXRQvYSnB2mqzigYj/D5C9PW5utYHiB/AWacSQykiwWxyiohGRGko1IJkaSrUjOjST3IvnPkeRd4ovk70R1beSLkfBJsdFJzpBZPKv/dZL+mczClE8kp5GuQvoYJEkE6XdGkjew/o/i8w9i/dsQ0rP+j2Ayy+g+Mkttf3jyuW+NxJbhrA+NxLbgrA9CTJ31vpHYSWy9ayS2C8mdI7F1SPaMRNgCrxpJloiNNvan/JT17YUIZSuZMznjTBx5HdLW7MMtIzH2VDObYIw0jchTkBSyVb5IZGhXpxNHZPUl80FWh8gDWV20HyIqzSFWdfEWjG0Y1Y/IN+Ao2qcjJ8X/SL7AXhw+J9aRveJHL+L7Lcbq/yCzRg6Kbx9l4hoR34qNkciz4r/JL4g/DI+RxSPieGxMj4yXYmOUPCMeQSGnsS8lz4qHY6vEp2SVe0BGLm71vmSp+JC8VHwggvUR8YbYi2wZcDW+8WJkd8amiXOSB8UZkTGCbCWJkylGsV4eEBPYXDdGZo0eFKeEx9hSynGMg8+KJThjgawuZVHt87QadGSTEtNt1C3TLdZdoZuqq9SV6iRdvi5Pl6u36wV9jt6sN+r1eq2e11M96HPZvwdE1b/N0grqZ0qeYV4tC5Rhmg0xKdFTPDtpB9dG2xZMJ2l7G7QtnJ6ujbaN6TLz03XRtrS+/WsdRwi5oxNraXrrGIGFHaigrGmnnyWoR4GQ+M7b/Yxu23l7ZydpS4/3QtsyKf3FAnwPIwbaGnm6B1ybGzwN9mm2xIzmf4JSk/ii/1PwXPJfC5789L1tCzrST+Z3pitYIZPf2ZZuZantUdpP17c0H6V9jHR2HCVbaX/LfNZOtjZ3XugGIdqH3SDJCOs2CiHWDUJkVO02R+2GahpqaT4SCmU7vUJmsU6oPq+onVZlxwrjFDhWOyPYjQYgrI4VpgHWDfUhO5j14sHMQKzqYFYzqIPlsU5HIhHsEouwLkdqI9jhSKRWZR/8ii1HssvphIg6T4R0qvMQ8lWfomwf1ILJPlSPfaL/L68V0/8vOpPRng+W97IPDCm5ZQVCKr1782pPenCZJB1Z/sHkl4eC1LLe1Yz2rEh/IK9oTi+Xm6UjPb3/hN3L2D1y8xHobVnYcaRXWdE80qP0tMg9zZ2jj+1oartkrl0X5mra8U8G28EGa2JzPdb2T9htjP0Ym6uNzdXG5npMeUydq23+dNLW3nFED9M7MUNV6Sg1GfE8pPzBzukuoW+aejimBj3X+5/nAd2WCbN7szw9bUFgrNLG0kbGwtPJWDnsE9Iky3P91KD/efLEJEvAZps8HaLgaVnTfOFnw4YNGxls2hRFvHGTR23biIc2uKAtPYMlvMl0siWtpJo71V9hb5q8mjoU4aXkW0m6PrkjuSe5L3k4qdm0qROb7S+F3grR7tD60I7QntC+0OGQljGu7HhWSe4L/SnEbUJtIhvxamlW59yEFH9YdeOmDewCnGADQna66KZoU0djCHox6iUYoZeCA0FGqERYgKCBf0X8c4SPEP6KwMONiO9CeBRhlLVwpVxpi2dNM5uxM8qMjoerGC2vrqgbQ9qzMksXLM3SlsuzNNlY4UE60lBpbLRiAE7gecRvILyP8AeE/0TQcBVchTr4pqzWdm6ADVGCy2d/Y7SRoQ3Rjer//hEm7o0bolHYkP2zZoI7oP7F5KV6D2TDJkBR4IYgwU5q6wb22CZGz1//E9s0yicKZW5kc3RyZWFtCmVuZG9iagoxMiAwIG9iagogICAxMTI5MwplbmRvYmoKMTMgMCBvYmoKPDwgL0xlbmd0aCAxNCAwIFIKICAgL0ZpbHRlciAvRmxhdGVEZWNvZGUKPj4Kc3RyZWFtCnicXZHLboMwEEX3/opZpouIR4A0EkKq0g2LPlTaDwB7nFoqxjLOgr+vxxOlUhfg4/Hcq3lk5/65tyZA9u4XOWAAbazyuC5XLxEmvBgrihKUkeF2S385j05kUTxsa8C5t3oRbQvZR3xcg99g96SWCR8EAGRvXqE39gK7r/PAoeHq3A/OaAPkoutAoY52L6N7HWeELIn3vYrvJmz7KPvL+NwcQpnuBZckF4WrGyX60V5QtHneQat1J9Cqf29Fw5JJy+/Ri7Z6jKl5Hg/RNnXieEQumAviirmKXEnOlxQ/cfxEjMxIPDFPkWvW1qQ9Mh+JG/ZpyKcq2bOkuOa4pnz2P5L/ges5UD11zp55avDWCbVKO7nPUF69j+NLi0tzo4kZi/fdusWRKn2/gvGTvAplbmRzdHJlYW0KZW5kb2JqCjE0IDAgb2JqCiAgIDMwMAplbmRvYmoKMTUgMCBvYmoKPDwgL1R5cGUgL0ZvbnREZXNjcmlwdG9yCiAgIC9Gb250TmFtZSAvRldDSFpSK1RpbWVzTmV3Um9tYW5QU01UCiAgIC9Gb250RmFtaWx5IChUaW1lcyBOZXcgUm9tYW4pCiAgIC9GbGFncyAzMgogICAvRm9udEJCb3ggWyAtNTY4IC0zMDYgMjAyOCAxMDA2IF0KICAgL0l0YWxpY0FuZ2xlIDAKICAgL0FzY2VudCA4OTEKICAgL0Rlc2NlbnQgLTIxNgogICAvQ2FwSGVpZ2h0IDEwMDYKICAgL1N0ZW1WIDgwCiAgIC9TdGVtSCA4MAogICAvRm9udEZpbGUyIDExIDAgUgo+PgplbmRvYmoKNyAwIG9iago8PCAvVHlwZSAvRm9udAogICAvU3VidHlwZSAvVHJ1ZVR5cGUKICAgL0Jhc2VGb250IC9GV0NIWlIrVGltZXNOZXdSb21hblBTTVQKICAgL0ZpcnN0Q2hhciAzMgogICAvTGFzdENoYXIgMTIxCiAgIC9Gb250RGVzY3JpcHRvciAxNSAwIFIKICAgL0VuY29kaW5nIC9XaW5BbnNpRW5jb2RpbmcKICAgL1dpZHRocyBbIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCA1MDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCA2NjYuOTkyMTg4IDAgMCAwIDAgMCA3MjIuMTY3OTY5IDAgMCAwIDYxMC44Mzk4NDQgMCAwIDAgNTU2LjE1MjM0NCAwIDAgMCA2MTAuODM5ODQ0IDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDQ0My44NDc2NTYgMCAwIDUwMCA0NDMuODQ3NjU2IDAgMCAwIDI3Ny44MzIwMzEgMCA1MDAgMjc3LjgzMjAzMSAwIDUwMCA1MDAgMCAwIDAgMCAyNzcuODMyMDMxIDAgMCAwIDAgNTAwIF0KICAgIC9Ub1VuaWNvZGUgMTMgMCBSCj4+CmVuZG9iagoxMCAwIG9iago8PCAvVHlwZSAvT2JqU3RtCiAgIC9MZW5ndGggMTggMCBSCiAgIC9OIDQKICAgL0ZpcnN0IDIzCiAgIC9GaWx0ZXIgL0ZsYXRlRGVjb2RlCj4+CnN0cmVhbQp4nFWRwWrDMBBE7/6KuZQ6FOKV4jhpMDnEgVBKISS9lR6ELBxBsYwkl+bvKzmxS9FpH7OaGZaBElZgSQkHW7KErbBY5UlZInu/dgrZUTTKJQCyV107fICDcMLngCrTtx4s2W6HjaM1dS+VRSqFtgZsztZzQnrxvnObLBtoY0V30dLNjW1ms9s3VgmvTbsXXiHdbzjxnNb0zHKivHgi9kg0G03+YuEhWMf9o7Aq5ojJBvCmai125ifEpfCK5Qqc51Po1ge5Qz7pD9b0HcoyDnG+eQx0ROdArWhdF73kdcQv8LZX41QF1V59a6lOh12EIXPkJ+VMb6VyWEye57Ao/S26C1f4V68SXnyZ5t4uXOBeLoh+ASgpbtcKZW5kc3RyZWFtCmVuZG9iagoxOCAwIG9iagogICAyNzkKZW5kb2JqCjE5IDAgb2JqCjw8IC9UeXBlIC9YUmVmCiAgIC9MZW5ndGggODAKICAgL0ZpbHRlciAvRmxhdGVEZWNvZGUKICAgL1NpemUgMjAKICAgL1cgWzEgMiAyXQogICAvUm9vdCAxNyAwIFIKICAgL0luZm8gMTYgMCBSCj4+CnN0cmVhbQp4nGNgYPj/n4mBi4EBRDAxsv1lYGBk4AcSbM9AYhxAlrkLkGDPAhFvgISlNZDgYAQSJvUgYgaQMBMGEVoQUxhBBDOj1XGgmNU9BgYAQMoK6AplbmRzdHJlYW0KZW5kb2JqCnN0YXJ0eHJlZgoxNTA3MAolJUVPRgo="></embed>
    <figcaption>Figure 13: The HTML API protocol</figcaption>
    </figure>
    <p>As the code is fairly repetitive I will just present all the code
    and then discuss the important parts. Here’s the implementation.</p>
    <div class="sourceCode" id="cb839"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb839-1"><a href="#cb839-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> StructureState</span>
<span id="cb839-2"><a href="#cb839-2" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Empty <span class="kw">extends</span> StructureState</span>
<span id="cb839-3"><a href="#cb839-3" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> InHead <span class="kw">extends</span> StructureState</span>
<span id="cb839-4"><a href="#cb839-4" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> InBody <span class="kw">extends</span> StructureState</span>
<span id="cb839-5"><a href="#cb839-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb839-6"><a href="#cb839-6" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> TitleState</span>
<span id="cb839-7"><a href="#cb839-7" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> WithoutTitle <span class="kw">extends</span> TitleState</span>
<span id="cb839-8"><a href="#cb839-8" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> WithTitle <span class="kw">extends</span> TitleState</span>
<span id="cb839-9"><a href="#cb839-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb839-10"><a href="#cb839-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Not a case class so external users cannot copy it</span></span>
<span id="cb839-11"><a href="#cb839-11" aria-hidden="true" tabindex="-1"></a><span class="co">// and break invariants</span></span>
<span id="cb839-12"><a href="#cb839-12" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="kw">class</span> Html<span class="op">[</span>S <span class="op">&lt;:</span> StructureState<span class="op">,</span> T <span class="op">&lt;:</span> TitleState<span class="op">](</span></span>
<span id="cb839-13"><a href="#cb839-13" aria-hidden="true" tabindex="-1"></a>    head<span class="op">:</span> <span class="ex">Vector</span><span class="op">[</span><span class="ex">String</span><span class="op">],</span></span>
<span id="cb839-14"><a href="#cb839-14" aria-hidden="true" tabindex="-1"></a>    body<span class="op">:</span> <span class="ex">Vector</span><span class="op">[</span><span class="ex">String</span><span class="op">]</span></span>
<span id="cb839-15"><a href="#cb839-15" aria-hidden="true" tabindex="-1"></a><span class="op">)</span> <span class="op">{</span></span>
<span id="cb839-16"><a href="#cb839-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Head tags ---------------------------------------------</span></span>
<span id="cb839-17"><a href="#cb839-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb839-18"><a href="#cb839-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">head</span><span class="op">(</span>using S <span class="op">=:=</span> Empty<span class="op">):</span> Html<span class="op">[</span>InHead<span class="op">,</span> WithoutTitle<span class="op">]</span> <span class="op">=</span></span>
<span id="cb839-19"><a href="#cb839-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Html</span><span class="op">(</span>head<span class="op">,</span> body<span class="op">)</span></span>
<span id="cb839-20"><a href="#cb839-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb839-21"><a href="#cb839-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">title</span><span class="op">(</span></span>
<span id="cb839-22"><a href="#cb839-22" aria-hidden="true" tabindex="-1"></a>      text<span class="op">:</span> <span class="ex">String</span></span>
<span id="cb839-23"><a href="#cb839-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">)(</span>using S <span class="op">=:=</span> InHead<span class="op">,</span> T <span class="op">=:=</span> WithoutTitle<span class="op">):</span> Html<span class="op">[</span>InHead<span class="op">,</span> WithTitle<span class="op">]</span> <span class="op">=</span></span>
<span id="cb839-24"><a href="#cb839-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Html</span><span class="op">(</span>head <span class="op">:+</span> <span class="ss">s&quot;</span><span class="st">&lt;title&gt;</span><span class="ss">$text</span><span class="st">&lt;/title&gt;</span><span class="ss">&quot;</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span>body<span class="op">)</span></span>
<span id="cb839-25"><a href="#cb839-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb839-26"><a href="#cb839-26" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">link</span><span class="op">(</span>rel<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> href<span class="op">:</span> <span class="ex">String</span><span class="op">)(</span>using S <span class="op">=:=</span> InHead<span class="op">):</span> Html<span class="op">[</span>InHead<span class="op">,</span> T<span class="op">]</span> <span class="op">=</span></span>
<span id="cb839-27"><a href="#cb839-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Html</span><span class="op">(</span>head <span class="op">:+</span> <span class="ss">s&quot;</span><span class="st">&lt;link rel=</span><span class="ch">\&quot;</span><span class="ss">$rel</span><span class="ch">\&quot;</span><span class="st"> href=</span><span class="ch">\&quot;</span><span class="ss">$href</span><span class="ch">\&quot;</span><span class="st">/&gt;</span><span class="ss">&quot;</span><span class="op">,</span> body<span class="op">)</span></span>
<span id="cb839-28"><a href="#cb839-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb839-29"><a href="#cb839-29" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Body tags ---------------------------------------------</span></span>
<span id="cb839-30"><a href="#cb839-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb839-31"><a href="#cb839-31" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">body</span><span class="op">(</span>using S <span class="op">=:=</span> InHead<span class="op">,</span> T <span class="op">=:=</span> WithTitle<span class="op">):</span> Html<span class="op">[</span>InBody<span class="op">,</span> WithTitle<span class="op">]</span> <span class="op">=</span></span>
<span id="cb839-32"><a href="#cb839-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Html</span><span class="op">(</span>head<span class="op">,</span> body<span class="op">)</span></span>
<span id="cb839-33"><a href="#cb839-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb839-34"><a href="#cb839-34" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">h1</span><span class="op">(</span>text<span class="op">:</span> <span class="ex">String</span><span class="op">)(</span>using S <span class="op">=:=</span> InBody<span class="op">):</span> Html<span class="op">[</span>InBody<span class="op">,</span> T<span class="op">]</span> <span class="op">=</span></span>
<span id="cb839-35"><a href="#cb839-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Html</span><span class="op">(</span>head<span class="op">,</span> body <span class="op">:+</span> <span class="ss">s&quot;</span><span class="st">&lt;h1&gt;</span><span class="ss">$text</span><span class="st">&lt;/h1&gt;</span><span class="ss">&quot;</span><span class="op">)</span></span>
<span id="cb839-36"><a href="#cb839-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb839-37"><a href="#cb839-37" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">p</span><span class="op">(</span>text<span class="op">:</span> <span class="ex">String</span><span class="op">)(</span>using S <span class="op">=:=</span> InBody<span class="op">):</span> Html<span class="op">[</span>InBody<span class="op">,</span> T<span class="op">]</span> <span class="op">=</span></span>
<span id="cb839-38"><a href="#cb839-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Html</span><span class="op">(</span>head<span class="op">,</span> body <span class="op">:+</span> <span class="ss">s&quot;</span><span class="st">&lt;p&gt;</span><span class="ss">$text</span><span class="st">&lt;/p&gt;</span><span class="ss">&quot;</span><span class="op">)</span></span>
<span id="cb839-39"><a href="#cb839-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb839-40"><a href="#cb839-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Interpreter ------------------------------------------</span></span>
<span id="cb839-41"><a href="#cb839-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb839-42"><a href="#cb839-42" aria-hidden="true" tabindex="-1"></a>  <span class="kw">override</span> <span class="kw">def</span> <span class="fu">toString</span><span class="op">():</span> <span class="ex">String</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb839-43"><a href="#cb839-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> h <span class="op">=</span> head<span class="op">.</span><span class="fu">mkString</span><span class="op">(</span><span class="st">&quot;  &lt;head&gt;</span><span class="ch">\n</span><span class="st">    &quot;</span><span class="op">,</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">    &quot;</span><span class="op">,</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">  &lt;/head&gt;&quot;</span><span class="op">)</span></span>
<span id="cb839-44"><a href="#cb839-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> b <span class="op">=</span> body<span class="op">.</span><span class="fu">mkString</span><span class="op">(</span><span class="st">&quot;  &lt;body&gt;</span><span class="ch">\n</span><span class="st">    &quot;</span><span class="op">,</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">    &quot;</span><span class="op">,</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">  &lt;/body&gt;&quot;</span><span class="op">)</span></span>
<span id="cb839-45"><a href="#cb839-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb839-46"><a href="#cb839-46" aria-hidden="true" tabindex="-1"></a>    <span class="ss">s&quot;</span><span class="ch">\n</span><span class="st">&lt;html&gt;</span><span class="ch">\n</span><span class="ss">$h</span><span class="ch">\n</span><span class="ss">$b</span><span class="ch">\n</span><span class="st">&lt;/html&gt;</span><span class="ss">&quot;</span></span>
<span id="cb839-47"><a href="#cb839-47" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb839-48"><a href="#cb839-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb839-49"><a href="#cb839-49" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Html <span class="op">{</span></span>
<span id="cb839-50"><a href="#cb839-50" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> empty<span class="op">:</span> Html<span class="op">[</span>Empty<span class="op">,</span> WithoutTitle<span class="op">]</span> <span class="op">=</span> <span class="fu">Html</span><span class="op">(</span><span class="ex">Vector</span><span class="op">.</span>empty<span class="op">,</span> <span class="ex">Vector</span><span class="op">.</span>empty<span class="op">)</span></span>
<span id="cb839-51"><a href="#cb839-51" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>The key point is that we factor the state into two components.
    <code>StructureState</code> represents where in the overall
    structure we are (inside the <code>head</code>, inside the
    <code>body</code>, or inside neither). <code>TitleState</code>
    represents the state when defining the elements inside the
    <code>head</code>, specifically whether we have a <code>title</code>
    element or not. We could certainly represent this with one state
    type variable, but I find the factored representation both easier to
    work with and easier for other developers to understand. We can
    implement more complex protcols, such as those that can be
    represented by context-free or even context-sensitive grammars,
    using the same technique.</p>
    <p>Here’s an example in use.</p>
    <div class="sourceCode" id="cb840"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb840-1"><a href="#cb840-1" aria-hidden="true" tabindex="-1"></a>Html<span class="op">.</span>empty<span class="op">.</span>head</span>
<span id="cb840-2"><a href="#cb840-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">link</span><span class="op">(</span><span class="st">&quot;stylesheet&quot;</span><span class="op">,</span> <span class="st">&quot;styles.css&quot;</span><span class="op">)</span></span>
<span id="cb840-3"><a href="#cb840-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">title</span><span class="op">(</span><span class="st">&quot;Our Amazing Webpage&quot;</span><span class="op">)</span></span>
<span id="cb840-4"><a href="#cb840-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span>body</span>
<span id="cb840-5"><a href="#cb840-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">h1</span><span class="op">(</span><span class="st">&quot;Where Amazing Exists&quot;</span><span class="op">)</span></span>
<span id="cb840-6"><a href="#cb840-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">p</span><span class="op">(</span><span class="st">&quot;Right here&quot;</span><span class="op">)</span></span>
<span id="cb840-7"><a href="#cb840-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span>toString</span>
<span id="cb840-8"><a href="#cb840-8" aria-hidden="true" tabindex="-1"></a><span class="co">// res6: String = &quot;&quot;&quot;</span></span>
<span id="cb840-9"><a href="#cb840-9" aria-hidden="true" tabindex="-1"></a><span class="co">// &lt;html&gt;</span></span>
<span id="cb840-10"><a href="#cb840-10" aria-hidden="true" tabindex="-1"></a><span class="co">//   &lt;head&gt;</span></span>
<span id="cb840-11"><a href="#cb840-11" aria-hidden="true" tabindex="-1"></a><span class="co">//     &lt;link rel=&quot;stylesheet&quot; href=&quot;styles.css&quot;/&gt;</span></span>
<span id="cb840-12"><a href="#cb840-12" aria-hidden="true" tabindex="-1"></a><span class="co">//     &lt;title&gt;Our Amazing Webpage&lt;/title&gt;</span></span>
<span id="cb840-13"><a href="#cb840-13" aria-hidden="true" tabindex="-1"></a><span class="co">//   &lt;/head&gt;</span></span>
<span id="cb840-14"><a href="#cb840-14" aria-hidden="true" tabindex="-1"></a><span class="co">//   &lt;body&gt;</span></span>
<span id="cb840-15"><a href="#cb840-15" aria-hidden="true" tabindex="-1"></a><span class="co">//     &lt;h1&gt;Where Amazing Exists&lt;/h1&gt;</span></span>
<span id="cb840-16"><a href="#cb840-16" aria-hidden="true" tabindex="-1"></a><span class="co">//     &lt;p&gt;Right here&lt;/p&gt;</span></span>
<span id="cb840-17"><a href="#cb840-17" aria-hidden="true" tabindex="-1"></a><span class="co">//   &lt;/body&gt;</span></span>
<span id="cb840-18"><a href="#cb840-18" aria-hidden="true" tabindex="-1"></a><span class="co">// &lt;/html&gt;&quot;&quot;&quot;</span></span></code></pre></div>
    <p>Here’s an example of the type system preventing an invalid
    construction, in this case the lack of a title.</p>
    <div class="sourceCode" id="cb841"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb841-1"><a href="#cb841-1" aria-hidden="true" tabindex="-1"></a>Html<span class="op">.</span>empty<span class="op">.</span>head</span>
<span id="cb841-2"><a href="#cb841-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">link</span><span class="op">(</span><span class="st">&quot;stylesheet&quot;</span><span class="op">,</span> <span class="st">&quot;styles.css&quot;</span><span class="op">)</span></span>
<span id="cb841-3"><a href="#cb841-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span>body</span>
<span id="cb841-4"><a href="#cb841-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">h1</span><span class="op">(</span><span class="st">&quot;This Shouldn&#39;t Work&quot;</span><span class="op">)</span></span>
<span id="cb841-5"><a href="#cb841-5" aria-hidden="true" tabindex="-1"></a><span class="co">// error: </span></span>
<span id="cb841-6"><a href="#cb841-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Cannot prove that MdocApp2.this.WithoutTitle =:= MdocApp2.this.WithTitle.</span></span></code></pre></div>
    <p>These error messages are not great. We’ll address this in Chapter
    15.</p>
    <h4 class="unnumbered" id="exercise-html-api-design">Exercise: HTML
    API Design</h4>
    <p>I don’t particularly like the HTML API we developed above, as the
    flat method call structure doesn’t match the nesting in the HTML
    structure we’re creating. I would prefer to write the following.</p>
    <div class="sourceCode" id="cb842"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb842-1"><a href="#cb842-1" aria-hidden="true" tabindex="-1"></a>Html<span class="op">.</span>empty</span>
<span id="cb842-2"><a href="#cb842-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">head</span><span class="op">(</span>_<span class="op">.</span><span class="fu">title</span><span class="op">(</span><span class="st">&quot;Our Amazing Webpage&quot;</span><span class="op">))</span></span>
<span id="cb842-3"><a href="#cb842-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">body</span><span class="op">(</span>_<span class="op">.</span><span class="fu">h1</span><span class="op">(</span><span class="st">&quot;Where Amazing Happens&quot;</span><span class="op">).</span><span class="fu">p</span><span class="op">(</span><span class="st">&quot;Right here&quot;</span><span class="op">))</span></span>
<span id="cb842-4"><a href="#cb842-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span>toString</span></code></pre></div>
    <p>We still require the head is specified before the body, but now
    the nesting of the method calls matches the nesting of the
    structure. Notice we’re still using a Church-encoded
    representation.</p>
    <p>Can you think of how to implement this? You’ll need to use
    indexed codata, and perhaps a bit of inspiration. This is a very
    open ended question, so don’t worry if you struggle with it!</p>
    <div class="solution">
    <p>Here’s how I implemented it. The structure is very similar to the
    original implementation, but where we factored the state into type
    parameters I also factored the implementation into types. Notice how
    we use <code>Head</code> and <code>Body</code> to accumulate the set
    of tags that make up the head and body respectively. We still need
    to use indexed codata in some place, but we can avoid it in others.
    For example, the <code>head</code> method simply requires a function
    of type <code>Head[WithoutTitle] =&gt; Head[WithTitle]</code>.</p>
    <div class="sourceCode" id="cb843"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb843-1"><a href="#cb843-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> StructureState</span>
<span id="cb843-2"><a href="#cb843-2" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> NeedsHead <span class="kw">extends</span> StructureState</span>
<span id="cb843-3"><a href="#cb843-3" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> NeedsBody <span class="kw">extends</span> StructureState</span>
<span id="cb843-4"><a href="#cb843-4" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Complete <span class="kw">extends</span> StructureState</span>
<span id="cb843-5"><a href="#cb843-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb843-6"><a href="#cb843-6" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> TitleState</span>
<span id="cb843-7"><a href="#cb843-7" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> WithoutTitle <span class="kw">extends</span> TitleState</span>
<span id="cb843-8"><a href="#cb843-8" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> WithTitle <span class="kw">extends</span> TitleState</span>
<span id="cb843-9"><a href="#cb843-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb843-10"><a href="#cb843-10" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="kw">class</span> Head<span class="op">[</span>S <span class="op">&lt;:</span> TitleState<span class="op">](</span>contents<span class="op">:</span> <span class="ex">Vector</span><span class="op">[</span><span class="ex">String</span><span class="op">])</span> <span class="op">{</span></span>
<span id="cb843-11"><a href="#cb843-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">title</span><span class="op">(</span>text<span class="op">:</span> <span class="ex">String</span><span class="op">)(</span>using S <span class="op">=:=</span> WithoutTitle<span class="op">):</span> Head<span class="op">[</span>WithTitle<span class="op">]</span> <span class="op">=</span></span>
<span id="cb843-12"><a href="#cb843-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Head</span><span class="op">(</span>contents <span class="op">:+</span> <span class="ss">s&quot;</span><span class="st">&lt;title&gt;</span><span class="ss">$text</span><span class="st">&lt;/title&gt;</span><span class="ss">&quot;</span><span class="op">)</span></span>
<span id="cb843-13"><a href="#cb843-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb843-14"><a href="#cb843-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">link</span><span class="op">(</span>rel<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> href<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> Head<span class="op">[</span>S<span class="op">]</span> <span class="op">=</span></span>
<span id="cb843-15"><a href="#cb843-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Head</span><span class="op">(</span>contents <span class="op">:+</span> <span class="ss">s&quot;</span><span class="st">&lt;link rel=</span><span class="ch">\&quot;</span><span class="ss">$rel</span><span class="ch">\&quot;</span><span class="st"> href=</span><span class="ch">\&quot;</span><span class="ss">$href</span><span class="ch">\&quot;</span><span class="st">/&gt;</span><span class="ss">&quot;</span><span class="op">)</span></span>
<span id="cb843-16"><a href="#cb843-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb843-17"><a href="#cb843-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">override</span> <span class="kw">def</span> <span class="fu">toString</span><span class="op">():</span> <span class="ex">String</span> <span class="op">=</span></span>
<span id="cb843-18"><a href="#cb843-18" aria-hidden="true" tabindex="-1"></a>    contents<span class="op">.</span><span class="fu">mkString</span><span class="op">(</span><span class="st">&quot;  &lt;head&gt;</span><span class="ch">\n</span><span class="st">    &quot;</span><span class="op">,</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">    &quot;</span><span class="op">,</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">  &lt;/head&gt;&quot;</span><span class="op">)</span></span>
<span id="cb843-19"><a href="#cb843-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb843-20"><a href="#cb843-20" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Head <span class="op">{</span></span>
<span id="cb843-21"><a href="#cb843-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> empty<span class="op">:</span> Head<span class="op">[</span>WithoutTitle<span class="op">]</span> <span class="op">=</span> <span class="fu">Head</span><span class="op">(</span><span class="ex">Vector</span><span class="op">.</span>empty<span class="op">)</span></span>
<span id="cb843-22"><a href="#cb843-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb843-23"><a href="#cb843-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb843-24"><a href="#cb843-24" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="kw">class</span> <span class="fu">Body</span><span class="op">(</span>contents<span class="op">:</span> <span class="ex">Vector</span><span class="op">[</span><span class="ex">String</span><span class="op">])</span> <span class="op">{</span></span>
<span id="cb843-25"><a href="#cb843-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">h1</span><span class="op">(</span>text<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> Body <span class="op">=</span></span>
<span id="cb843-26"><a href="#cb843-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Body</span><span class="op">(</span>contents <span class="op">:+</span> <span class="ss">s&quot;</span><span class="st">&lt;h1&gt;</span><span class="ss">$text</span><span class="st">&lt;/h1&gt;</span><span class="ss">&quot;</span><span class="op">)</span></span>
<span id="cb843-27"><a href="#cb843-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb843-28"><a href="#cb843-28" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">p</span><span class="op">(</span>text<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> Body <span class="op">=</span></span>
<span id="cb843-29"><a href="#cb843-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Body</span><span class="op">(</span>contents <span class="op">:+</span> <span class="ss">s&quot;</span><span class="st">&lt;p&gt;</span><span class="ss">$text</span><span class="st">&lt;/p&gt;</span><span class="ss">&quot;</span><span class="op">)</span></span>
<span id="cb843-30"><a href="#cb843-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb843-31"><a href="#cb843-31" aria-hidden="true" tabindex="-1"></a>  <span class="kw">override</span> <span class="kw">def</span> <span class="fu">toString</span><span class="op">():</span> <span class="ex">String</span> <span class="op">=</span></span>
<span id="cb843-32"><a href="#cb843-32" aria-hidden="true" tabindex="-1"></a>    contents<span class="op">.</span><span class="fu">mkString</span><span class="op">(</span><span class="st">&quot;  &lt;body&gt;</span><span class="ch">\n</span><span class="st">    &quot;</span><span class="op">,</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">    &quot;</span><span class="op">,</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">  &lt;/body&gt;&quot;</span><span class="op">)</span></span>
<span id="cb843-33"><a href="#cb843-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb843-34"><a href="#cb843-34" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Body <span class="op">{</span></span>
<span id="cb843-35"><a href="#cb843-35" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> empty<span class="op">:</span> Body <span class="op">=</span> <span class="fu">Body</span><span class="op">(</span><span class="ex">Vector</span><span class="op">.</span>empty<span class="op">)</span></span>
<span id="cb843-36"><a href="#cb843-36" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb843-37"><a href="#cb843-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb843-38"><a href="#cb843-38" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="kw">class</span> Html<span class="op">[</span>S <span class="op">&lt;:</span> StructureState<span class="op">](</span></span>
<span id="cb843-39"><a href="#cb843-39" aria-hidden="true" tabindex="-1"></a>    head<span class="op">:</span> Head<span class="op">[?],</span></span>
<span id="cb843-40"><a href="#cb843-40" aria-hidden="true" tabindex="-1"></a>    body<span class="op">:</span> Body</span>
<span id="cb843-41"><a href="#cb843-41" aria-hidden="true" tabindex="-1"></a><span class="op">)</span> <span class="op">{</span></span>
<span id="cb843-42"><a href="#cb843-42" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">head</span><span class="op">(</span>f<span class="op">:</span> Head<span class="op">[</span>WithoutTitle<span class="op">]</span> <span class="op">=&gt;</span> Head<span class="op">[</span>WithTitle<span class="op">])(</span>using</span>
<span id="cb843-43"><a href="#cb843-43" aria-hidden="true" tabindex="-1"></a>      S <span class="op">=:=</span> NeedsHead</span>
<span id="cb843-44"><a href="#cb843-44" aria-hidden="true" tabindex="-1"></a>  <span class="op">):</span> Html<span class="op">[</span>NeedsBody<span class="op">]</span> <span class="op">=</span></span>
<span id="cb843-45"><a href="#cb843-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Html</span><span class="op">(</span><span class="fu">f</span><span class="op">(</span>Head<span class="op">.</span>empty<span class="op">),</span> body<span class="op">)</span></span>
<span id="cb843-46"><a href="#cb843-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb843-47"><a href="#cb843-47" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">body</span><span class="op">(</span>f<span class="op">:</span> Body <span class="op">=&gt;</span> Body<span class="op">)(</span>using S <span class="op">=:=</span> NeedsBody<span class="op">):</span> Html<span class="op">[</span>Complete<span class="op">]</span> <span class="op">=</span></span>
<span id="cb843-48"><a href="#cb843-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Html</span><span class="op">(</span>head<span class="op">,</span> <span class="fu">f</span><span class="op">(</span>Body<span class="op">.</span>empty<span class="op">))</span></span>
<span id="cb843-49"><a href="#cb843-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb843-50"><a href="#cb843-50" aria-hidden="true" tabindex="-1"></a>  <span class="kw">override</span> <span class="kw">def</span> <span class="fu">toString</span><span class="op">():</span> <span class="ex">String</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb843-51"><a href="#cb843-51" aria-hidden="true" tabindex="-1"></a>    <span class="ss">s&quot;</span><span class="ch">\n</span><span class="st">&lt;html&gt;</span><span class="ch">\n</span><span class="ss">${</span>head<span class="op">.</span><span class="fu">toString</span><span class="op">()</span><span class="ss">}</span><span class="ch">\n</span><span class="ss">${</span>body<span class="op">.</span><span class="fu">toString</span><span class="op">()</span><span class="ss">}</span><span class="ch">\n</span><span class="st">&lt;/html&gt;</span><span class="ss">&quot;</span></span>
<span id="cb843-52"><a href="#cb843-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb843-53"><a href="#cb843-53" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb843-54"><a href="#cb843-54" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb843-55"><a href="#cb843-55" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Html <span class="op">{</span></span>
<span id="cb843-56"><a href="#cb843-56" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> empty<span class="op">:</span> Html<span class="op">[</span>NeedsHead<span class="op">]</span> <span class="op">=</span> <span class="fu">Html</span><span class="op">(</span>Head<span class="op">.</span>empty<span class="op">,</span> Body<span class="op">.</span>empty<span class="op">)</span></span>
<span id="cb843-57"><a href="#cb843-57" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>As always, we should show that is works. Here’s the output from
    the motivating example.</p>
    <div class="sourceCode" id="cb844"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb844-1"><a href="#cb844-1" aria-hidden="true" tabindex="-1"></a>Html<span class="op">.</span>empty</span>
<span id="cb844-2"><a href="#cb844-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">head</span><span class="op">(</span>_<span class="op">.</span><span class="fu">title</span><span class="op">(</span><span class="st">&quot;Our Amazing Webpage&quot;</span><span class="op">))</span></span>
<span id="cb844-3"><a href="#cb844-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">body</span><span class="op">(</span>_<span class="op">.</span><span class="fu">h1</span><span class="op">(</span><span class="st">&quot;Where Amazing Happens&quot;</span><span class="op">).</span><span class="fu">p</span><span class="op">(</span><span class="st">&quot;Right here&quot;</span><span class="op">))</span></span>
<span id="cb844-4"><a href="#cb844-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">toString</span><span class="op">()</span></span>
<span id="cb844-5"><a href="#cb844-5" aria-hidden="true" tabindex="-1"></a><span class="co">// res9: String = &quot;&quot;&quot;</span></span>
<span id="cb844-6"><a href="#cb844-6" aria-hidden="true" tabindex="-1"></a><span class="co">// &lt;html&gt;</span></span>
<span id="cb844-7"><a href="#cb844-7" aria-hidden="true" tabindex="-1"></a><span class="co">//   &lt;head&gt;</span></span>
<span id="cb844-8"><a href="#cb844-8" aria-hidden="true" tabindex="-1"></a><span class="co">//     &lt;title&gt;Our Amazing Webpage&lt;/title&gt;</span></span>
<span id="cb844-9"><a href="#cb844-9" aria-hidden="true" tabindex="-1"></a><span class="co">//   &lt;/head&gt;</span></span>
<span id="cb844-10"><a href="#cb844-10" aria-hidden="true" tabindex="-1"></a><span class="co">//   &lt;body&gt;</span></span>
<span id="cb844-11"><a href="#cb844-11" aria-hidden="true" tabindex="-1"></a><span class="co">//     &lt;h1&gt;Where Amazing Happens&lt;/h1&gt;</span></span>
<span id="cb844-12"><a href="#cb844-12" aria-hidden="true" tabindex="-1"></a><span class="co">//     &lt;p&gt;Right here&lt;/p&gt;</span></span>
<span id="cb844-13"><a href="#cb844-13" aria-hidden="true" tabindex="-1"></a><span class="co">//   &lt;/body&gt;</span></span>
<span id="cb844-14"><a href="#cb844-14" aria-hidden="true" tabindex="-1"></a><span class="co">// &lt;/html&gt;&quot;&quot;&quot;</span></span></code></pre></div>
    </div>
    <h3 data-number="13.2.2" id="beyond-equality-constraints"><span class="header-section-number">13.2.2</span> Beyond Equality
    Constraints</h3>
    <p>Indexed data is all about equality constraints: proofs that some
    type parameter is equal to some type. However we can go beyond
    equality constraints with contextual abstraction. We can use <a href="https://www.scala-lang.org/api/current/scala/%3C:%3C.html"><code>&lt;:&lt;</code></a>
    for evidence of a subtyping relationship, and <a href="https://www.scala-lang.org/api/current/scala/util/NotGiven.html"><code>NotGiven</code></a>
    for evidence that no given instance exists (with which we can test
    that types are not equal, for example). Beyond that, we can view any
    given instance as evidence.</p>
    <p>Let’s return to our example of length, force, and torque to see
    how this is useful. In the exercise where we defined torque as force
    times length, we fixed the computation to have SI units. The example
    code is below. This is a reasonable thing to do, as other units are
    insane, but there are a lot of insane people out there.</p>
    <div class="sourceCode" id="cb845"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb845-1"><a href="#cb845-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> Force<span class="op">[</span><span class="bu">Unit</span><span class="op">](</span>value<span class="op">:</span> <span class="ex">Double</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb845-2"><a href="#cb845-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">*[</span>L<span class="op">](</span>length<span class="op">:</span> Length<span class="op">[</span>L<span class="op">])(</span>using <span class="bu">Unit</span> <span class="op">=:=</span> Newtons<span class="op">,</span> L <span class="op">=:=</span> Metres<span class="op">):</span> Torque<span class="op">[</span>NewtonMetres<span class="op">]</span> <span class="op">=</span></span>
<span id="cb845-3"><a href="#cb845-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Torque</span><span class="op">(</span><span class="kw">this</span><span class="op">.</span>value <span class="op">*</span> length<span class="op">.</span>value<span class="op">)</span></span>
<span id="cb845-4"><a href="#cb845-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>To accomodate other unit types we can create given instances that
    represent the results of operations of interest. In this case we
    want to represent the result of multiplying a length unit by the
    force unit. In code we can write the following.</p>
    <div class="sourceCode" id="cb846"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb846-1"><a href="#cb846-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Weird units</span></span>
<span id="cb846-2"><a href="#cb846-2" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Feet</span>
<span id="cb846-3"><a href="#cb846-3" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Pounds</span>
<span id="cb846-4"><a href="#cb846-4" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> PoundsFeet</span>
<span id="cb846-5"><a href="#cb846-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb846-6"><a href="#cb846-6" aria-hidden="true" tabindex="-1"></a><span class="co">// An instance exists if A * B = C</span></span>
<span id="cb846-7"><a href="#cb846-7" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Multiply<span class="op">[</span>A<span class="op">,</span> B<span class="op">,</span> C<span class="op">]</span></span>
<span id="cb846-8"><a href="#cb846-8" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Multiply <span class="op">{</span></span>
<span id="cb846-9"><a href="#cb846-9" aria-hidden="true" tabindex="-1"></a>  given Multiply<span class="op">[</span>Metres<span class="op">,</span> Newtons<span class="op">,</span> NewtonMetres<span class="op">]</span> <span class="op">=</span> <span class="kw">new</span> Multiply <span class="op">{}</span></span>
<span id="cb846-10"><a href="#cb846-10" aria-hidden="true" tabindex="-1"></a>  given Multiply<span class="op">[</span>Feet<span class="op">,</span> Pounds<span class="op">,</span> PoundsFeet<span class="op">]</span> <span class="op">=</span> <span class="kw">new</span> Multiply <span class="op">{}</span></span>
<span id="cb846-11"><a href="#cb846-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Now we can define <code>*</code> methods on <code>Length</code>
    and <code>Force</code> in terms of <code>Multiply</code>.</p>
    <div class="sourceCode" id="cb847"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb847-1"><a href="#cb847-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> Length<span class="op">[</span>L<span class="op">](</span>value<span class="op">:</span> <span class="ex">Double</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb847-2"><a href="#cb847-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">*[</span>F<span class="op">,</span> T<span class="op">](</span>that<span class="op">:</span> Force<span class="op">[</span>F<span class="op">])(</span>using Multiply<span class="op">[</span>L<span class="op">,</span> F<span class="op">,</span> T<span class="op">]):</span> Torque<span class="op">[</span>T<span class="op">]</span> <span class="op">=</span></span>
<span id="cb847-3"><a href="#cb847-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Torque</span><span class="op">(</span><span class="kw">this</span><span class="op">.</span>value <span class="op">*</span> that<span class="op">.</span>value<span class="op">)</span></span>
<span id="cb847-4"><a href="#cb847-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb847-5"><a href="#cb847-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb847-6"><a href="#cb847-6" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> Force<span class="op">[</span>F<span class="op">](</span>value<span class="op">:</span> <span class="ex">Double</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb847-7"><a href="#cb847-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">*[</span>L<span class="op">,</span> T<span class="op">](</span>that<span class="op">:</span> Length<span class="op">[</span>L<span class="op">])(</span>using Multiply<span class="op">[</span>F<span class="op">,</span> L<span class="op">,</span> T<span class="op">]):</span> Torque<span class="op">[</span>T<span class="op">]</span> <span class="op">=</span></span>
<span id="cb847-8"><a href="#cb847-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Torque</span><span class="op">(</span><span class="kw">this</span><span class="op">.</span>value <span class="op">*</span> that<span class="op">.</span>value<span class="op">)</span></span>
<span id="cb847-9"><a href="#cb847-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Here’s an example showing it works.</p>
    <div class="sourceCode" id="cb848"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb848-1"><a href="#cb848-1" aria-hidden="true" tabindex="-1"></a>Length<span class="op">[</span>Metres<span class="op">](</span><span class="dv">3</span><span class="op">)</span> <span class="op">*</span> Force<span class="op">[</span>Newtons<span class="op">](</span><span class="dv">4</span><span class="op">)</span></span>
<span id="cb848-2"><a href="#cb848-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res11: Torque[NewtonMetres] = Torque(value = 12.0)</span></span>
<span id="cb848-3"><a href="#cb848-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb848-4"><a href="#cb848-4" aria-hidden="true" tabindex="-1"></a><span class="co">// What is this nonsense?</span></span>
<span id="cb848-5"><a href="#cb848-5" aria-hidden="true" tabindex="-1"></a>Length<span class="op">[</span>Feet<span class="op">](</span><span class="dv">3</span><span class="op">)</span> <span class="op">*</span> Force<span class="op">[</span>Pounds<span class="op">](</span><span class="dv">4</span><span class="op">)</span></span>
<span id="cb848-6"><a href="#cb848-6" aria-hidden="true" tabindex="-1"></a><span class="co">// res12: Torque[PoundsFeet] = Torque(value = 12.0)</span></span></code></pre></div>
    <p>Note that’s it hard to think of <code>Multiply</code> as a type
    class, as it does not provide <em>any</em> methods. Viewing it as
    evidence, however, does make sense.</p>
    <h4 class="unnumbered" id="exercise-commutivitiy">Exercise:
    Commutivitiy</h4>
    <p>In the example above we defined a <code>Multiply</code> type
    class to represent that metres times newtons gives newton metres.
    Multiplication is commutative. If <span class="math inline"><em>A</em> × <em>B</em> = <em>C</em></span>,
    then <span class="math inline"><em>B</em> × <em>A</em> = <em>C</em></span>.
    However we have not represented this, and if we try newtons times
    metres, as in the example below, the code will fail.</p>
    <div class="sourceCode" id="cb849"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb849-1"><a href="#cb849-1" aria-hidden="true" tabindex="-1"></a>Force<span class="op">[</span>Newtons<span class="op">](</span><span class="dv">3</span><span class="op">)</span> <span class="op">*</span> Length<span class="op">[</span>Metres<span class="op">](</span><span class="dv">4</span><span class="op">)</span></span>
<span id="cb849-2"><a href="#cb849-2" aria-hidden="true" tabindex="-1"></a><span class="co">// error:</span></span>
<span id="cb849-3"><a href="#cb849-3" aria-hidden="true" tabindex="-1"></a><span class="co">// No given instance of type MdocApp4.this.Multiply[MdocApp4.this.Newtons, MdocApp4.this.Metres, Any] was found for parameter x$2 of method * in class Force</span></span>
<span id="cb849-4"><a href="#cb849-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Force[Newtons](3) * Length[Metres](4)</span></span>
<span id="cb849-5"><a href="#cb849-5" aria-hidden="true" tabindex="-1"></a><span class="co">//                                     ^</span></span></code></pre></div>
    <p>Add evidence to <code>Multiply</code> that if
    <code>Multiply[A, B, C]</code> exists, then so does
    <code>Multiply[B, A, C]</code>, and show that it solves this
    problem.</p>
    <div class="solution">
    <p>To solve this I defined a given instance called
    <code>commutative</code>, as shown below.</p>
    <div class="sourceCode" id="cb850"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb850-1"><a href="#cb850-1" aria-hidden="true" tabindex="-1"></a><span class="co">// An instance exists if A * B = C</span></span>
<span id="cb850-2"><a href="#cb850-2" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Multiply<span class="op">[</span>A<span class="op">,</span> B<span class="op">,</span> C<span class="op">]</span></span>
<span id="cb850-3"><a href="#cb850-3" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Multiply <span class="op">{</span></span>
<span id="cb850-4"><a href="#cb850-4" aria-hidden="true" tabindex="-1"></a>  given Multiply<span class="op">[</span>Metres<span class="op">,</span> Newtons<span class="op">,</span> NewtonMetres<span class="op">]</span> <span class="op">=</span> <span class="kw">new</span> Multiply <span class="op">{}</span></span>
<span id="cb850-5"><a href="#cb850-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb850-6"><a href="#cb850-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// A * B == B * A</span></span>
<span id="cb850-7"><a href="#cb850-7" aria-hidden="true" tabindex="-1"></a>  given commutative<span class="op">[</span>A<span class="op">,</span> B<span class="op">,</span> C<span class="op">](</span>using Multiply<span class="op">[</span>A<span class="op">,</span> B<span class="op">,</span> C<span class="op">]):</span> Multiply<span class="op">[</span>B<span class="op">,</span> A<span class="op">,</span> C<span class="op">]</span> <span class="op">=</span></span>
<span id="cb850-8"><a href="#cb850-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> Multiply <span class="op">{}</span></span>
<span id="cb850-9"><a href="#cb850-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Now the example works as expected.</p>
    <div class="sourceCode" id="cb851"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb851-1"><a href="#cb851-1" aria-hidden="true" tabindex="-1"></a>Force<span class="op">[</span>Newtons<span class="op">](</span><span class="dv">3</span><span class="op">)</span> <span class="op">*</span> Length<span class="op">[</span>Metres<span class="op">](</span><span class="dv">4</span><span class="op">)</span></span>
<span id="cb851-2"><a href="#cb851-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res15: Torque[NewtonMetres] = Torque(value = 12.0)</span></span></code></pre></div>
    </div>
    <h2 data-number="13.3" id="indexed-data"><span class="header-section-number">13.3</span> Indexed Data</h2>
    <p>The key idea of indexed data is to encode type equalities in
    data.</p>
    <h2 data-number="13.4" id="conclusions-4"><span class="header-section-number">13.4</span> Conclusions</h2>
    <p>The earliest reference I’ve found to phantom types is <span class="citation" data-cites="10.1145/331960.331977">[Leijen and
    Meijer 2000]</span>.</p>
    <p>The majority of research on generalized algebraic data types
    focuses on type checking and inference algorithms, which is not so
    relevant to the working programmer. <em>Pointwise Generalized
    Algebraic Data Types</em> <span class="citation" data-cites="10.1145/1708016.1708024">[Lin and Sheard 2010]</span> is
    not different in this respect, but it does have a particularly clear
    breakdown of how GADTs are used in the most common case.</p>
    <p>Indexed codata is described in <span class="citation" data-cites="10.1145/3022670.2951929">[Thibodeau et al.
    2016]</span>.</p>
    <p>Fluent APIs. <span class="citation" data-cites="Roth_2023">[Roth
    and Gil 2023]</span></p>
    <h1 data-number="14" id="optimizing-interpreters-and-compilers"><span class="header-section-number">14</span> Optimizing Interpreters and
    Compilers</h1>
    <p>In a previous chapter we introduced interpreters as a key
    strategy in functional programming. In many cases simple
    structurally recursive interpreters are sufficient. However, in a
    few cases we need more performance than they can offer so in this
    chapter we’ll turn to optimization. This is a huge subject, which we
    cannot hope to cover in just one book chapter. Instead we’ll focus
    on two techniques that I believe use key ideas found in more complex
    techniques: algebraic manipulation and compilation to a virtual
    machine.</p>
    <p>We’ll start looking at algebraic manipulation, returning to the
    regular expression example we used earlier. We’ll then move to
    virtual machine, this time using a simple arithmetic interpreter
    example. We’ll see how we can compile code to a stack machine, and
    then look at some of the optimizations that are available when we
    use a virtual machine.</p>
    <h2 data-number="14.1" id="algebraic-manipulation"><span class="header-section-number">14.1</span> Algebraic
    Manipulation</h2>
    <p>Reifying a program represents it as a data structure. We can
    <strong>rewrite</strong> this data structure to several ends: as a
    way to simplify and therefore optimize the program being
    interpreted, but also as a general form of computation implementing
    the interpreter. In this section we’re going to return to our
    regular expression example, and show how rewriting can be used
    perform both of these tasks.</p>
    <p>We will use a technique known as regular expression derivatives.
    Regular expression derivatives provide a simple way to match a
    regular expression against input (with the correct semantics for
    union, which you may recall we didn’t deal with in the previous
    chapter). The derivative of a regular expression, with respect to a
    character, is the regular expression that remains after matching
    that character. Say we have the regular expression that matches the
    string <code>&quot;osprey&quot;</code>. In our library this would be
    <code>Regexp(&quot;osprey&quot;)</code>. The derivative with respect to the
    character <code>o</code> is <code>Regexp(&quot;sprey&quot;)</code>. In other
    words it’s the regular expression that is looking for the string
    <code>&quot;sprey&quot;</code>. The derivative with respect to the character
    <code>a</code> is the regular expression that matches nothing, which
    is written <code>Regexp.empty</code> in our library. To take a more
    complicated example, the derivative with respect to <code>c</code>
    of <code>Regexp(&quot;cats&quot;).repeat</code> is
    <code>Regexp(&quot;ats&quot;) ++ Regexp(&quot;cats&quot;).repeat</code>. This indicates
    we’re looking for the string <code>&quot;ats&quot;</code> followed by zero or
    more repeats of <code>&quot;cats&quot;</code></p>
    <p>All we need to do to determine if a regular expression matches
    some input is to calculate successive derivatives with respect to
    the characters in the input in the order in which they occur. If the
    resulting regular expression matches the empty string then we have a
    successful match. Otherwise it has failed to match.</p>
    <p>To implement this algorithm we need three things:</p>
    <ol type="1">
    <li>an explicit representation of the regular expression that
    matches the empty string;</li>
    <li>a method that tests if a regular expression matches the empty
    string; and</li>
    <li>a method that computes the derivative of a regular expression
    with respect to a given character.</li>
    </ol>
    <p>Our starting point is the basic reified interpreter we developed
    in the previous chapter. This is the simplest code and therefore the
    easiest to work with.</p>
    <div class="sourceCode" id="cb852"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb852-1"><a href="#cb852-1" aria-hidden="true" tabindex="-1"></a>enum Regexp <span class="op">{</span></span>
<span id="cb852-2"><a href="#cb852-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">++(</span>that<span class="op">:</span> Regexp<span class="op">):</span> Regexp <span class="op">=</span></span>
<span id="cb852-3"><a href="#cb852-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Append</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb852-4"><a href="#cb852-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb852-5"><a href="#cb852-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">orElse</span><span class="op">(</span>that<span class="op">:</span> Regexp<span class="op">):</span> Regexp <span class="op">=</span></span>
<span id="cb852-6"><a href="#cb852-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">OrElse</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb852-7"><a href="#cb852-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb852-8"><a href="#cb852-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> repeat<span class="op">:</span> Regexp <span class="op">=</span></span>
<span id="cb852-9"><a href="#cb852-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Repeat</span><span class="op">(</span><span class="kw">this</span><span class="op">)</span></span>
<span id="cb852-10"><a href="#cb852-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb852-11"><a href="#cb852-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> `<span class="op">*</span>` <span class="op">:</span> Regexp <span class="op">=</span> <span class="kw">this</span><span class="op">.</span>repeat</span>
<span id="cb852-12"><a href="#cb852-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb852-13"><a href="#cb852-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">matches</span><span class="op">(</span>input<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Boolean</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb852-14"><a href="#cb852-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">loop</span><span class="op">(</span>regexp<span class="op">:</span> Regexp<span class="op">,</span> idx<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb852-15"><a href="#cb852-15" aria-hidden="true" tabindex="-1"></a>      regexp <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb852-16"><a href="#cb852-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">Append</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb852-17"><a href="#cb852-17" aria-hidden="true" tabindex="-1"></a>          <span class="fu">loop</span><span class="op">(</span>left<span class="op">,</span> idx<span class="op">).</span><span class="fu">flatMap</span><span class="op">(</span>i <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>right<span class="op">,</span> i<span class="op">))</span></span>
<span id="cb852-18"><a href="#cb852-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">OrElse</span><span class="op">(</span>first<span class="op">,</span> second<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb852-19"><a href="#cb852-19" aria-hidden="true" tabindex="-1"></a>          <span class="fu">loop</span><span class="op">(</span>first<span class="op">,</span> idx<span class="op">).</span><span class="fu">orElse</span><span class="op">(</span><span class="fu">loop</span><span class="op">(</span>second<span class="op">,</span> idx<span class="op">))</span></span>
<span id="cb852-20"><a href="#cb852-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">Repeat</span><span class="op">(</span>source<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb852-21"><a href="#cb852-21" aria-hidden="true" tabindex="-1"></a>          <span class="fu">loop</span><span class="op">(</span>source<span class="op">,</span> idx<span class="op">)</span></span>
<span id="cb852-22"><a href="#cb852-22" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">flatMap</span><span class="op">(</span>i <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>regexp<span class="op">,</span> i<span class="op">))</span></span>
<span id="cb852-23"><a href="#cb852-23" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">orElse</span><span class="op">(</span><span class="bu">Some</span><span class="op">(</span>idx<span class="op">))</span></span>
<span id="cb852-24"><a href="#cb852-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">Apply</span><span class="op">(</span>string<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb852-25"><a href="#cb852-25" aria-hidden="true" tabindex="-1"></a>          <span class="ex">Option</span><span class="op">.</span><span class="fu">when</span><span class="op">(</span>input<span class="op">.</span><span class="fu">startsWith</span><span class="op">(</span>string<span class="op">,</span> idx<span class="op">))(</span>idx <span class="op">+</span> string<span class="op">.</span>size<span class="op">)</span></span>
<span id="cb852-26"><a href="#cb852-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> Empty <span class="op">=&gt;</span></span>
<span id="cb852-27"><a href="#cb852-27" aria-hidden="true" tabindex="-1"></a>          <span class="bu">None</span></span>
<span id="cb852-28"><a href="#cb852-28" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb852-29"><a href="#cb852-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb852-30"><a href="#cb852-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check we matched the entire input</span></span>
<span id="cb852-31"><a href="#cb852-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">loop</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> <span class="dv">0</span><span class="op">).</span><span class="fu">map</span><span class="op">(</span>idx <span class="op">=&gt;</span> idx <span class="op">==</span> input<span class="op">.</span>size<span class="op">).</span><span class="fu">getOrElse</span><span class="op">(</span><span class="kw">false</span><span class="op">)</span></span>
<span id="cb852-32"><a href="#cb852-32" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb852-33"><a href="#cb852-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb852-34"><a href="#cb852-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Append</span><span class="op">(</span>left<span class="op">:</span> Regexp<span class="op">,</span> right<span class="op">:</span> Regexp<span class="op">)</span></span>
<span id="cb852-35"><a href="#cb852-35" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">OrElse</span><span class="op">(</span>first<span class="op">:</span> Regexp<span class="op">,</span> second<span class="op">:</span> Regexp<span class="op">)</span></span>
<span id="cb852-36"><a href="#cb852-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Repeat</span><span class="op">(</span>source<span class="op">:</span> Regexp<span class="op">)</span></span>
<span id="cb852-37"><a href="#cb852-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Apply</span><span class="op">(</span>string<span class="op">:</span> <span class="ex">String</span><span class="op">)</span></span>
<span id="cb852-38"><a href="#cb852-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> Empty</span>
<span id="cb852-39"><a href="#cb852-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb852-40"><a href="#cb852-40" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Regexp <span class="op">{</span></span>
<span id="cb852-41"><a href="#cb852-41" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> empty<span class="op">:</span> Regexp <span class="op">=</span> Empty</span>
<span id="cb852-42"><a href="#cb852-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb852-43"><a href="#cb852-43" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>string<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> Regexp <span class="op">=</span></span>
<span id="cb852-44"><a href="#cb852-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Apply</span><span class="op">(</span>string<span class="op">)</span></span>
<span id="cb852-45"><a href="#cb852-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>We want to explicitly represent the regular expression that
    matches the empty string, as it plays an important part in the
    algorithms that follow. This is simple to do: we just reify it and
    adjust the constructors as necessary. I’ve called this case
    “epsilon”, which matches the terminology used in the literature.</p>
    <div class="sourceCode" id="cb853"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb853-1"><a href="#cb853-1" aria-hidden="true" tabindex="-1"></a>enum Regexp <span class="op">{</span></span>
<span id="cb853-2"><a href="#cb853-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb853-3"><a href="#cb853-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> Epsilon</span>
<span id="cb853-4"><a href="#cb853-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb853-5"><a href="#cb853-5" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Regexp <span class="op">{</span></span>
<span id="cb853-6"><a href="#cb853-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> epsilon<span class="op">:</span> Regexp <span class="op">=</span> Epsilon</span>
<span id="cb853-7"><a href="#cb853-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb853-8"><a href="#cb853-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>string<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> Regexp <span class="op">=</span></span>
<span id="cb853-9"><a href="#cb853-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> string<span class="op">.</span><span class="fu">isEmpty</span><span class="op">()</span> then Epsilon</span>
<span id="cb853-10"><a href="#cb853-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="fu">Apply</span><span class="op">(</span>string<span class="op">)</span></span>
<span id="cb853-11"><a href="#cb853-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Next up we will create a predicate that tells us if a regular
    expression matches the empty string. Such a regular expression is
    called “nullable”. The code is so simple it’s easier to read it than
    try to explain it in English.</p>
    <div class="sourceCode" id="cb854"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb854-1"><a href="#cb854-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> nullable<span class="op">:</span> <span class="ex">Boolean</span> <span class="op">=</span></span>
<span id="cb854-2"><a href="#cb854-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb854-3"><a href="#cb854-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Append</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span> left<span class="op">.</span>nullable <span class="op">&amp;&amp;</span> right<span class="op">.</span>nullable</span>
<span id="cb854-4"><a href="#cb854-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">OrElse</span><span class="op">(</span>first<span class="op">,</span> second<span class="op">)</span> <span class="op">=&gt;</span> first<span class="op">.</span>nullable <span class="op">||</span> second<span class="op">.</span>nullable</span>
<span id="cb854-5"><a href="#cb854-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Repeat</span><span class="op">(</span>source<span class="op">)</span> <span class="op">=&gt;</span> <span class="kw">true</span></span>
<span id="cb854-6"><a href="#cb854-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Apply</span><span class="op">(</span>string<span class="op">)</span> <span class="op">=&gt;</span> <span class="kw">false</span></span>
<span id="cb854-7"><a href="#cb854-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> Epsilon <span class="op">=&gt;</span> <span class="kw">true</span></span>
<span id="cb854-8"><a href="#cb854-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> Empty <span class="op">=&gt;</span> <span class="kw">false</span></span>
<span id="cb854-9"><a href="#cb854-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>Now we can implement the actual regular expression derivative. It
    consists of two parts: the method to calculate the derivative which
    in turn depends on a method that handles a nullable regular
    expression. Both parts are quite simple so I’ll give the code first
    and then explain the more complicated parts.</p>
    <div class="sourceCode" id="cb855"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb855-1"><a href="#cb855-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> delta<span class="op">:</span> Regexp <span class="op">=</span></span>
<span id="cb855-2"><a href="#cb855-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> nullable then Epsilon <span class="cf">else</span> Empty</span>
<span id="cb855-3"><a href="#cb855-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb855-4"><a href="#cb855-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">derivative</span><span class="op">(</span>ch<span class="op">:</span> <span class="bu">Char</span><span class="op">):</span> Regexp <span class="op">=</span></span>
<span id="cb855-5"><a href="#cb855-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb855-6"><a href="#cb855-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Append</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb855-7"><a href="#cb855-7" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>left<span class="op">.</span><span class="fu">derivative</span><span class="op">(</span>ch<span class="op">)</span> <span class="op">++</span> right<span class="op">).</span><span class="fu">orElse</span><span class="op">(</span>left<span class="op">.</span>delta <span class="op">++</span> right<span class="op">.</span><span class="fu">derivative</span><span class="op">(</span>ch<span class="op">))</span></span>
<span id="cb855-8"><a href="#cb855-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">OrElse</span><span class="op">(</span>first<span class="op">,</span> second<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb855-9"><a href="#cb855-9" aria-hidden="true" tabindex="-1"></a>      first<span class="op">.</span><span class="fu">derivative</span><span class="op">(</span>ch<span class="op">).</span><span class="fu">orElse</span><span class="op">(</span>second<span class="op">.</span><span class="fu">derivative</span><span class="op">(</span>ch<span class="op">))</span></span>
<span id="cb855-10"><a href="#cb855-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Repeat</span><span class="op">(</span>source<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb855-11"><a href="#cb855-11" aria-hidden="true" tabindex="-1"></a>      source<span class="op">.</span><span class="fu">derivative</span><span class="op">(</span>ch<span class="op">)</span> <span class="op">++</span> <span class="kw">this</span></span>
<span id="cb855-12"><a href="#cb855-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Apply</span><span class="op">(</span>string<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb855-13"><a href="#cb855-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> string<span class="op">.</span>size <span class="op">==</span> <span class="dv">1</span> then</span>
<span id="cb855-14"><a href="#cb855-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> string<span class="op">.</span><span class="fu">charAt</span><span class="op">(</span><span class="dv">0</span><span class="op">)</span> <span class="op">==</span> ch then Epsilon</span>
<span id="cb855-15"><a href="#cb855-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> Empty</span>
<span id="cb855-16"><a href="#cb855-16" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> string<span class="op">.</span><span class="fu">charAt</span><span class="op">(</span><span class="dv">0</span><span class="op">)</span> <span class="op">==</span> ch then <span class="fu">Apply</span><span class="op">(</span>string<span class="op">.</span>tail<span class="op">)</span></span>
<span id="cb855-17"><a href="#cb855-17" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> Empty</span>
<span id="cb855-18"><a href="#cb855-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> Epsilon <span class="op">=&gt;</span> Empty</span>
<span id="cb855-19"><a href="#cb855-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> Empty <span class="op">=&gt;</span> Empty</span>
<span id="cb855-20"><a href="#cb855-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>I think this code is reasonably straightforward, except perhaps
    for the cases for <code>OrElse</code> and <code>Append</code>. The
    case for <code>OrElse</code> is trying to match both regular
    expressions simultaneously, which gets around the problem in our
    earlier implementation. The definition of <code>nullable</code>
    ensures we match if either side matches. The case for
    <code>Append</code> is attempting to match the <code>left</code>
    side if it is still looking for characters; otherwise it is
    attempting to match the <code>right</code> side.</p>
    <p>With this we redefine <code>matches</code> as follows.</p>
    <div class="sourceCode" id="cb856"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb856-1"><a href="#cb856-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">matches</span><span class="op">(</span>input<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Boolean</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb856-2"><a href="#cb856-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> r <span class="op">=</span> input<span class="op">.</span><span class="fu">foldLeft</span><span class="op">(</span><span class="kw">this</span><span class="op">){</span> <span class="op">(</span>regexp<span class="op">,</span> ch<span class="op">)</span> <span class="op">=&gt;</span> regexp<span class="op">.</span><span class="fu">derivative</span><span class="op">(</span>ch<span class="op">)</span> <span class="op">}</span></span>
<span id="cb856-3"><a href="#cb856-3" aria-hidden="true" tabindex="-1"></a>  r<span class="op">.</span>nullable</span>
<span id="cb856-4"><a href="#cb856-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>We can show the code works as expected.</p>
    <div class="sourceCode" id="cb857"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb857-1"><a href="#cb857-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> regexp <span class="op">=</span> <span class="fu">Regexp</span><span class="op">(</span><span class="st">&quot;Sca&quot;</span><span class="op">)</span> <span class="op">++</span> <span class="fu">Regexp</span><span class="op">(</span><span class="st">&quot;la&quot;</span><span class="op">)</span> <span class="op">++</span> <span class="fu">Regexp</span><span class="op">(</span><span class="st">&quot;la&quot;</span><span class="op">).</span>repeat</span></code></pre></div>
    <div class="sourceCode" id="cb858"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb858-1"><a href="#cb858-1" aria-hidden="true" tabindex="-1"></a>regexp<span class="op">.</span><span class="fu">matches</span><span class="op">(</span><span class="st">&quot;Scala&quot;</span><span class="op">)</span></span>
<span id="cb858-2"><a href="#cb858-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: Boolean = true</span></span>
<span id="cb858-3"><a href="#cb858-3" aria-hidden="true" tabindex="-1"></a>regexp<span class="op">.</span><span class="fu">matches</span><span class="op">(</span><span class="st">&quot;Scalalalala&quot;</span><span class="op">)</span></span>
<span id="cb858-4"><a href="#cb858-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: Boolean = true</span></span>
<span id="cb858-5"><a href="#cb858-5" aria-hidden="true" tabindex="-1"></a>regexp<span class="op">.</span><span class="fu">matches</span><span class="op">(</span><span class="st">&quot;Sca&quot;</span><span class="op">)</span></span>
<span id="cb858-6"><a href="#cb858-6" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: Boolean = false</span></span>
<span id="cb858-7"><a href="#cb858-7" aria-hidden="true" tabindex="-1"></a>regexp<span class="op">.</span><span class="fu">matches</span><span class="op">(</span><span class="st">&quot;Scalal&quot;</span><span class="op">)</span></span>
<span id="cb858-8"><a href="#cb858-8" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: Boolean = false</span></span></code></pre></div>
    <p>It also solves the problem with the earlier implementation.</p>
    <div class="sourceCode" id="cb859"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb859-1"><a href="#cb859-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Regexp</span><span class="op">(</span><span class="st">&quot;cat&quot;</span><span class="op">).</span><span class="fu">orElse</span><span class="op">(</span><span class="fu">Regexp</span><span class="op">(</span><span class="st">&quot;cats&quot;</span><span class="op">)).</span><span class="fu">matches</span><span class="op">(</span><span class="st">&quot;cats&quot;</span><span class="op">)</span></span>
<span id="cb859-2"><a href="#cb859-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: Boolean = true</span></span></code></pre></div>
    <p>This is a nice result for a very simple algorithm. However there
    is a problem. You might notice that regular expression matching can
    become very slow. In fact we can run out of heap space trying a
    simple match like</p>
    <div class="sourceCode" id="cb860"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb860-1"><a href="#cb860-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Regexp</span><span class="op">(</span><span class="st">&quot;cats&quot;</span><span class="op">).</span>repeat<span class="op">.</span><span class="fu">matches</span><span class="op">(</span><span class="st">&quot;catscatscatscats&quot;</span><span class="op">)</span></span>
<span id="cb860-2"><a href="#cb860-2" aria-hidden="true" tabindex="-1"></a><span class="co">// java.lang.OutOfMemoryError: Java heap space</span></span></code></pre></div>
    <p>This happens because the derivative of the regular expression can
    grow very large. Look at this example, after only a few
    derivatives.</p>
    <div class="sourceCode" id="cb861"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb861-1"><a href="#cb861-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Regexp</span><span class="op">(</span><span class="st">&quot;cats&quot;</span><span class="op">).</span>repeat<span class="op">.</span><span class="fu">derivative</span><span class="op">(</span><span class="ch">&#39;c&#39;</span><span class="op">).</span><span class="fu">derivative</span><span class="op">(</span><span class="ch">&#39;a&#39;</span><span class="op">).</span><span class="fu">derivative</span><span class="op">(</span><span class="ch">&#39;t&#39;</span><span class="op">)</span></span>
<span id="cb861-2"><a href="#cb861-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res6: Regexp = OrElse(OrElse(Append(Apply(s),Repeat(Apply(cats))),Append(Empty,Append(Empty,Repeat(Apply(cats))))),OrElse(Append(Empty,Append(Empty,Repeat(Apply(cats)))),Append(Empty,OrElse(Append(Empty,Repeat(Apply(cats))),Append(Empty,Append(Empty,Repeat(Apply(cats))))))))</span></span></code></pre></div>
    <p>The root cause is that the derivative rules for
    <code>Append</code>, <code>OrElse</code>, and <code>Repeat</code>
    can produce a regular expression that is larger than the input.
    However this output often contains redundant information. In the
    example above there are multiple occurrences of
    <code>Append(Empty, ...)</code>, which is equivalent to just
    <code>Empty</code>. This is similar to adding zero or multiplying by
    one in arithmetic, and we can use similar algebraic simplification
    rules to get rid of these unnecessary elements.</p>
    <p>We can implement this simplification in one of two ways: we can
    make simplification a separate method that we apply to an existing
    <code>Regexp</code>, or we can do the simplification as we construct
    the <code>Regexp</code>. I’ve chosen to do the latter, modifying
    <code>++</code>, <code>orElse</code>, and <code>repeat</code> as
    follows:</p>
    <div class="sourceCode" id="cb862"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb862-1"><a href="#cb862-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="op">++(</span>that<span class="op">:</span> Regexp<span class="op">):</span> Regexp <span class="op">=</span> <span class="op">{</span></span>
<span id="cb862-2"><a href="#cb862-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb862-3"><a href="#cb862-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="op">(</span>Epsilon<span class="op">,</span> re2<span class="op">)</span> <span class="op">=&gt;</span> re2</span>
<span id="cb862-4"><a href="#cb862-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="op">(</span>re1<span class="op">,</span> Epsilon<span class="op">)</span> <span class="op">=&gt;</span> re1</span>
<span id="cb862-5"><a href="#cb862-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="op">(</span>Empty<span class="op">,</span> _<span class="op">)</span> <span class="op">=&gt;</span> Empty</span>
<span id="cb862-6"><a href="#cb862-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="op">(</span>_<span class="op">,</span> Empty<span class="op">)</span> <span class="op">=&gt;</span> Empty</span>
<span id="cb862-7"><a href="#cb862-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> _ <span class="op">=&gt;</span> <span class="fu">Append</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb862-8"><a href="#cb862-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb862-9"><a href="#cb862-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb862-10"><a href="#cb862-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb862-11"><a href="#cb862-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">orElse</span><span class="op">(</span>that<span class="op">:</span> Regexp<span class="op">):</span> Regexp <span class="op">=</span> <span class="op">{</span></span>
<span id="cb862-12"><a href="#cb862-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb862-13"><a href="#cb862-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="op">(</span>Empty<span class="op">,</span> re<span class="op">)</span> <span class="op">=&gt;</span> re</span>
<span id="cb862-14"><a href="#cb862-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="op">(</span>re<span class="op">,</span> Empty<span class="op">)</span> <span class="op">=&gt;</span> re</span>
<span id="cb862-15"><a href="#cb862-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> _ <span class="op">=&gt;</span> <span class="fu">OrElse</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb862-16"><a href="#cb862-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb862-17"><a href="#cb862-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb862-18"><a href="#cb862-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb862-19"><a href="#cb862-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> repeat<span class="op">:</span> Regexp <span class="op">=</span> <span class="op">{</span></span>
<span id="cb862-20"><a href="#cb862-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb862-21"><a href="#cb862-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Repeat</span><span class="op">(</span>source<span class="op">)</span> <span class="op">=&gt;</span> <span class="kw">this</span></span>
<span id="cb862-22"><a href="#cb862-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> Epsilon <span class="op">=&gt;</span> Epsilon</span>
<span id="cb862-23"><a href="#cb862-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> Empty <span class="op">=&gt;</span> Empty</span>
<span id="cb862-24"><a href="#cb862-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> _ <span class="op">=&gt;</span> <span class="fu">Repeat</span><span class="op">(</span><span class="kw">this</span><span class="op">)</span></span>
<span id="cb862-25"><a href="#cb862-25" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb862-26"><a href="#cb862-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>With this small change in-place, our regular expressions stay at
    a reasonable size for any input.</p>
    <div class="sourceCode" id="cb863"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb863-1"><a href="#cb863-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Regexp</span><span class="op">(</span><span class="st">&quot;cats&quot;</span><span class="op">).</span>repeat<span class="op">.</span><span class="fu">derivative</span><span class="op">(</span><span class="ch">&#39;c&#39;</span><span class="op">).</span><span class="fu">derivative</span><span class="op">(</span><span class="ch">&#39;a&#39;</span><span class="op">).</span><span class="fu">derivative</span><span class="op">(</span><span class="ch">&#39;t&#39;</span><span class="op">)</span></span>
<span id="cb863-2"><a href="#cb863-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res8: Regexp = Append(Apply(s),Repeat(Apply(cats)))</span></span></code></pre></div>
    <p>Here’s the final code.</p>
    <div class="sourceCode" id="cb864"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb864-1"><a href="#cb864-1" aria-hidden="true" tabindex="-1"></a>enum Regexp <span class="op">{</span></span>
<span id="cb864-2"><a href="#cb864-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">++(</span>that<span class="op">:</span> Regexp<span class="op">):</span> Regexp <span class="op">=</span> <span class="op">{</span></span>
<span id="cb864-3"><a href="#cb864-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb864-4"><a href="#cb864-4" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="op">(</span>Epsilon<span class="op">,</span> re2<span class="op">)</span> <span class="op">=&gt;</span> re2</span>
<span id="cb864-5"><a href="#cb864-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="op">(</span>re1<span class="op">,</span> Epsilon<span class="op">)</span> <span class="op">=&gt;</span> re1</span>
<span id="cb864-6"><a href="#cb864-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="op">(</span>Empty<span class="op">,</span> _<span class="op">)</span> <span class="op">=&gt;</span> Empty</span>
<span id="cb864-7"><a href="#cb864-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="op">(</span>_<span class="op">,</span> Empty<span class="op">)</span> <span class="op">=&gt;</span> Empty</span>
<span id="cb864-8"><a href="#cb864-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> _ <span class="op">=&gt;</span> <span class="fu">Append</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb864-9"><a href="#cb864-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb864-10"><a href="#cb864-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb864-11"><a href="#cb864-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb864-12"><a href="#cb864-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">orElse</span><span class="op">(</span>that<span class="op">:</span> Regexp<span class="op">):</span> Regexp <span class="op">=</span> <span class="op">{</span></span>
<span id="cb864-13"><a href="#cb864-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb864-14"><a href="#cb864-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="op">(</span>Empty<span class="op">,</span> re<span class="op">)</span> <span class="op">=&gt;</span> re</span>
<span id="cb864-15"><a href="#cb864-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="op">(</span>re<span class="op">,</span> Empty<span class="op">)</span> <span class="op">=&gt;</span> re</span>
<span id="cb864-16"><a href="#cb864-16" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> _ <span class="op">=&gt;</span> <span class="fu">OrElse</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb864-17"><a href="#cb864-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb864-18"><a href="#cb864-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb864-19"><a href="#cb864-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb864-20"><a href="#cb864-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> repeat<span class="op">:</span> Regexp <span class="op">=</span> <span class="op">{</span></span>
<span id="cb864-21"><a href="#cb864-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb864-22"><a href="#cb864-22" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Repeat</span><span class="op">(</span>source<span class="op">)</span> <span class="op">=&gt;</span> <span class="kw">this</span></span>
<span id="cb864-23"><a href="#cb864-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> Epsilon <span class="op">=&gt;</span> Epsilon</span>
<span id="cb864-24"><a href="#cb864-24" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> Empty <span class="op">=&gt;</span> Empty</span>
<span id="cb864-25"><a href="#cb864-25" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> _ <span class="op">=&gt;</span> <span class="fu">Repeat</span><span class="op">(</span><span class="kw">this</span><span class="op">)</span></span>
<span id="cb864-26"><a href="#cb864-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb864-27"><a href="#cb864-27" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb864-28"><a href="#cb864-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb864-29"><a href="#cb864-29" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> `<span class="op">*</span>` <span class="op">:</span> Regexp <span class="op">=</span> <span class="kw">this</span><span class="op">.</span>repeat</span>
<span id="cb864-30"><a href="#cb864-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb864-31"><a href="#cb864-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">/**</span> True if this regular expression accepts the empty string <span class="co">*/</span></span>
<span id="cb864-32"><a href="#cb864-32" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> nullable<span class="op">:</span> <span class="ex">Boolean</span> <span class="op">=</span></span>
<span id="cb864-33"><a href="#cb864-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb864-34"><a href="#cb864-34" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Append</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span> left<span class="op">.</span>nullable <span class="op">&amp;&amp;</span> right<span class="op">.</span>nullable</span>
<span id="cb864-35"><a href="#cb864-35" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">OrElse</span><span class="op">(</span>first<span class="op">,</span> second<span class="op">)</span> <span class="op">=&gt;</span> first<span class="op">.</span>nullable <span class="op">||</span> second<span class="op">.</span>nullable</span>
<span id="cb864-36"><a href="#cb864-36" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Repeat</span><span class="op">(</span>source<span class="op">)</span> <span class="op">=&gt;</span> <span class="kw">true</span></span>
<span id="cb864-37"><a href="#cb864-37" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Apply</span><span class="op">(</span>string<span class="op">)</span> <span class="op">=&gt;</span> <span class="kw">false</span></span>
<span id="cb864-38"><a href="#cb864-38" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> Epsilon <span class="op">=&gt;</span> <span class="kw">true</span></span>
<span id="cb864-39"><a href="#cb864-39" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> Empty <span class="op">=&gt;</span> <span class="kw">false</span></span>
<span id="cb864-40"><a href="#cb864-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb864-41"><a href="#cb864-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb864-42"><a href="#cb864-42" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> delta<span class="op">:</span> Regexp <span class="op">=</span></span>
<span id="cb864-43"><a href="#cb864-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> nullable then Epsilon <span class="cf">else</span> Empty</span>
<span id="cb864-44"><a href="#cb864-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb864-45"><a href="#cb864-45" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">derivative</span><span class="op">(</span>ch<span class="op">:</span> <span class="bu">Char</span><span class="op">):</span> Regexp <span class="op">=</span></span>
<span id="cb864-46"><a href="#cb864-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb864-47"><a href="#cb864-47" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Append</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb864-48"><a href="#cb864-48" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span>left<span class="op">.</span><span class="fu">derivative</span><span class="op">(</span>ch<span class="op">)</span> <span class="op">++</span> right<span class="op">).</span><span class="fu">orElse</span><span class="op">(</span>left<span class="op">.</span>delta <span class="op">++</span> right<span class="op">.</span><span class="fu">derivative</span><span class="op">(</span>ch<span class="op">))</span></span>
<span id="cb864-49"><a href="#cb864-49" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">OrElse</span><span class="op">(</span>first<span class="op">,</span> second<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb864-50"><a href="#cb864-50" aria-hidden="true" tabindex="-1"></a>        first<span class="op">.</span><span class="fu">derivative</span><span class="op">(</span>ch<span class="op">).</span><span class="fu">orElse</span><span class="op">(</span>second<span class="op">.</span><span class="fu">derivative</span><span class="op">(</span>ch<span class="op">))</span></span>
<span id="cb864-51"><a href="#cb864-51" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Repeat</span><span class="op">(</span>source<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb864-52"><a href="#cb864-52" aria-hidden="true" tabindex="-1"></a>        source<span class="op">.</span><span class="fu">derivative</span><span class="op">(</span>ch<span class="op">)</span> <span class="op">++</span> <span class="kw">this</span></span>
<span id="cb864-53"><a href="#cb864-53" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Apply</span><span class="op">(</span>string<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb864-54"><a href="#cb864-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> string<span class="op">.</span>size <span class="op">==</span> <span class="dv">1</span> then</span>
<span id="cb864-55"><a href="#cb864-55" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> string<span class="op">.</span><span class="fu">charAt</span><span class="op">(</span><span class="dv">0</span><span class="op">)</span> <span class="op">==</span> ch then Epsilon</span>
<span id="cb864-56"><a href="#cb864-56" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span> Empty</span>
<span id="cb864-57"><a href="#cb864-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="cf">if</span> string<span class="op">.</span><span class="fu">charAt</span><span class="op">(</span><span class="dv">0</span><span class="op">)</span> <span class="op">==</span> ch then <span class="fu">Apply</span><span class="op">(</span>string<span class="op">.</span>tail<span class="op">)</span></span>
<span id="cb864-58"><a href="#cb864-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> Empty</span>
<span id="cb864-59"><a href="#cb864-59" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> Epsilon <span class="op">=&gt;</span> Empty</span>
<span id="cb864-60"><a href="#cb864-60" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> Empty <span class="op">=&gt;</span> Empty</span>
<span id="cb864-61"><a href="#cb864-61" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb864-62"><a href="#cb864-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb864-63"><a href="#cb864-63" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">matches</span><span class="op">(</span>input<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Boolean</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb864-64"><a href="#cb864-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> r <span class="op">=</span> input<span class="op">.</span><span class="fu">foldLeft</span><span class="op">(</span><span class="kw">this</span><span class="op">){</span> <span class="op">(</span>regexp<span class="op">,</span> ch<span class="op">)</span> <span class="op">=&gt;</span> regexp<span class="op">.</span><span class="fu">derivative</span><span class="op">(</span>ch<span class="op">)</span> <span class="op">}</span></span>
<span id="cb864-65"><a href="#cb864-65" aria-hidden="true" tabindex="-1"></a>    r<span class="op">.</span>nullable</span>
<span id="cb864-66"><a href="#cb864-66" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb864-67"><a href="#cb864-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb864-68"><a href="#cb864-68" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Append</span><span class="op">(</span>left<span class="op">:</span> Regexp<span class="op">,</span> right<span class="op">:</span> Regexp<span class="op">)</span></span>
<span id="cb864-69"><a href="#cb864-69" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">OrElse</span><span class="op">(</span>first<span class="op">:</span> Regexp<span class="op">,</span> second<span class="op">:</span> Regexp<span class="op">)</span></span>
<span id="cb864-70"><a href="#cb864-70" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Repeat</span><span class="op">(</span>source<span class="op">:</span> Regexp<span class="op">)</span></span>
<span id="cb864-71"><a href="#cb864-71" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Apply</span><span class="op">(</span>string<span class="op">:</span> <span class="ex">String</span><span class="op">)</span></span>
<span id="cb864-72"><a href="#cb864-72" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> Epsilon</span>
<span id="cb864-73"><a href="#cb864-73" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> Empty</span>
<span id="cb864-74"><a href="#cb864-74" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb864-75"><a href="#cb864-75" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Regexp <span class="op">{</span></span>
<span id="cb864-76"><a href="#cb864-76" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> empty<span class="op">:</span> Regexp <span class="op">=</span> Empty</span>
<span id="cb864-77"><a href="#cb864-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb864-78"><a href="#cb864-78" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> epsilon<span class="op">:</span> Regexp <span class="op">=</span> Epsilon</span>
<span id="cb864-79"><a href="#cb864-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb864-80"><a href="#cb864-80" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>string<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> Regexp <span class="op">=</span></span>
<span id="cb864-81"><a href="#cb864-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> string<span class="op">.</span><span class="fu">isEmpty</span><span class="op">()</span> then Epsilon</span>
<span id="cb864-82"><a href="#cb864-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="fu">Apply</span><span class="op">(</span>string<span class="op">)</span></span>
<span id="cb864-83"><a href="#cb864-83" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Notice that our implementation is tail recursive. The only
    “looping” is the call to the tail recursive <code>foldLeft</code> in
    <code>matches</code>. No continuation-passing style transform is
    necessary here! (Calculating the derivatives is not tail recursive
    but it very unlikely this would overflow the stack.) This may not be
    surprising if you’ve studied theory of computation. A key result
    from that field is the equivalence between regular expressions and
    finite state machines. If you know this you may have found it a bit
    surprising we had to use a stack at all in our prior
    implementations. But hold on a minute. If we think carefully about
    regular expression derivatives we’ll see that they actually are
    continuations! A continuation means “what comes next”, which is
    exactly what a regular expression derviative defines for a regular
    expression and a particular character. So our interpreter does use
    CPS, but reified as a regular expression not a function, and derived
    through a different route.</p>
    <p>Continuations reify control-flow. That is, they give us an
    explicit representation of how control moves through our program.
    This means we can change the control flow by applying continuations
    in a different order. Let’s make this concrete. A regular expression
    derivative represents a continuation. So imagine we’re running a
    regular expression on data that arrives asynchronously; we want to
    match as much data as we have available, and then suspend the
    regular expression and continue matching when more data arrives.
    This is trival. When we run out of data we just store the current
    derivative. When more data arrives we continue processing using the
    derivative we stored. Here’s an example.</p>
    <p>Start by defining the regular expression.</p>
    <div class="sourceCode" id="cb865"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb865-1"><a href="#cb865-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> cats <span class="op">=</span> <span class="fu">Regexp</span><span class="op">(</span><span class="st">&quot;cats&quot;</span><span class="op">).</span>repeat</span></code></pre></div>
    <p>Process the first piece of data and store the continuation.</p>
    <div class="sourceCode" id="cb866"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb866-1"><a href="#cb866-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> next <span class="op">=</span> <span class="st">&quot;catsca&quot;</span><span class="op">.</span><span class="fu">foldLeft</span><span class="op">(</span>cats<span class="op">){</span> <span class="op">(</span>regexp<span class="op">,</span> ch<span class="op">)</span> <span class="op">=&gt;</span> regexp<span class="op">.</span><span class="fu">derivative</span><span class="op">(</span>ch<span class="op">)</span> <span class="op">}</span></span></code></pre></div>
    <p>Continue processing when more data arrives.</p>
    <div class="sourceCode" id="cb867"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb867-1"><a href="#cb867-1" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;tscats&quot;</span><span class="op">.</span><span class="fu">foldLeft</span><span class="op">(</span>next<span class="op">){</span> <span class="op">(</span>regexp<span class="op">,</span> ch<span class="op">)</span> <span class="op">=&gt;</span> regexp<span class="op">.</span><span class="fu">derivative</span><span class="op">(</span>ch<span class="op">)</span> <span class="op">}</span></span></code></pre></div>
    <p>Notice that we could just as easily go back to a previous regular
    expression if we wanted to. This would give us backtracking. We
    don’t need backtracking for regular expressions, but for more
    general parsers we do. In fact with continuations we can define any
    control flow we like, including backtracking search, exceptions,
    cooperative threading, and much much more.</p>
    <p>In this section we’ve also seen the power of rewrites. Regular
    expression matching using derivatives works solely by rewriting the
    regular expression. We also used rewriting to simplify the regular
    expressions, avoiding the explosion in size that derivatives can
    cause. The abstract type of these methods is
    <code>Program =&gt; Program</code> so we might think they are
    combinators. However the implementation uses structural recursion
    and they serve the role of interpreters. Rewrites are the one place
    where the types alone can lead us astray.</p>
    <p>I hope you find regular expression derivatives interesting and a
    bit surprising. I certainly did when I first read about them. There
    is a deeper point here, which runs throughout the book: most
    problems have already been solved and we can save a lot of time if
    we can just find those solutions. I elevate this idea of the status
    of a strategy, which I call <strong>read the literature</strong> for
    reasons that will soon be clear. Most developers read the occasional
    blog post and might attend a conference from time to time. Many
    fewer, I think, read academic papers. This is unfortunate. Part of
    the fault is with the academics: they write in a style that is hard
    to read without some practice. However I think many developers think
    the academic literature is irrelevant. One of the goals of this book
    is to show the relevance of academic work, which is why each chapter
    conclusion sketches the development of its main ideas with links to
    relevant papers.</p>
    <h2 data-number="14.2" id="from-continuations-to-stacks"><span class="header-section-number">14.2</span> From Continuations to
    Stacks</h2>
    <p>In the previous section we explored regular expression
    derivatives. We saw that they are continuations, but reified as data
    structures rather than the functions we used when we first worked
    with continuation-passing style. In this section we’ll reify
    continuations-as-functions as data. In doing so we’ll find
    continuations implicitly encode a stack structure. Explicitly
    reifying this structure is a step towards implementing a stack
    machine.</p>
    <p>We’ll start with the CPSed regular expression interpreter (not
    using derivatives), shown below.</p>
    <div class="sourceCode" id="cb868"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb868-1"><a href="#cb868-1" aria-hidden="true" tabindex="-1"></a>enum Regexp <span class="op">{</span></span>
<span id="cb868-2"><a href="#cb868-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">++(</span>that<span class="op">:</span> Regexp<span class="op">):</span> Regexp <span class="op">=</span></span>
<span id="cb868-3"><a href="#cb868-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Append</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb868-4"><a href="#cb868-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb868-5"><a href="#cb868-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">orElse</span><span class="op">(</span>that<span class="op">:</span> Regexp<span class="op">):</span> Regexp <span class="op">=</span></span>
<span id="cb868-6"><a href="#cb868-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">OrElse</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb868-7"><a href="#cb868-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb868-8"><a href="#cb868-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> repeat<span class="op">:</span> Regexp <span class="op">=</span></span>
<span id="cb868-9"><a href="#cb868-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Repeat</span><span class="op">(</span><span class="kw">this</span><span class="op">)</span></span>
<span id="cb868-10"><a href="#cb868-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb868-11"><a href="#cb868-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> `<span class="op">*</span>` <span class="op">:</span> Regexp <span class="op">=</span> <span class="kw">this</span><span class="op">.</span>repeat</span>
<span id="cb868-12"><a href="#cb868-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb868-13"><a href="#cb868-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">matches</span><span class="op">(</span>input<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Boolean</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb868-14"><a href="#cb868-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Define a type alias so we can easily write continuations</span></span>
<span id="cb868-15"><a href="#cb868-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">type</span> Continuation <span class="op">=</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=&gt;</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span></span>
<span id="cb868-16"><a href="#cb868-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb868-17"><a href="#cb868-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">loop</span><span class="op">(</span>regexp<span class="op">:</span> Regexp<span class="op">,</span> idx<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> cont<span class="op">:</span> Continuation<span class="op">):</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb868-18"><a href="#cb868-18" aria-hidden="true" tabindex="-1"></a>      regexp <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb868-19"><a href="#cb868-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">Append</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb868-20"><a href="#cb868-20" aria-hidden="true" tabindex="-1"></a>          <span class="kw">val</span> k<span class="op">:</span> Continuation <span class="op">=</span> _ <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb868-21"><a href="#cb868-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="bu">None</span>    <span class="op">=&gt;</span> <span class="fu">cont</span><span class="op">(</span><span class="bu">None</span><span class="op">)</span></span>
<span id="cb868-22"><a href="#cb868-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="bu">Some</span><span class="op">(</span>i<span class="op">)</span> <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>right<span class="op">,</span> i<span class="op">,</span> cont<span class="op">)</span></span>
<span id="cb868-23"><a href="#cb868-23" aria-hidden="true" tabindex="-1"></a>          <span class="op">}</span></span>
<span id="cb868-24"><a href="#cb868-24" aria-hidden="true" tabindex="-1"></a>          <span class="fu">loop</span><span class="op">(</span>left<span class="op">,</span> idx<span class="op">,</span> k<span class="op">)</span></span>
<span id="cb868-25"><a href="#cb868-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb868-26"><a href="#cb868-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">OrElse</span><span class="op">(</span>first<span class="op">,</span> second<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb868-27"><a href="#cb868-27" aria-hidden="true" tabindex="-1"></a>          <span class="kw">val</span> k<span class="op">:</span> Continuation <span class="op">=</span> _ <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb868-28"><a href="#cb868-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="bu">None</span> <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>second<span class="op">,</span> idx<span class="op">,</span> cont<span class="op">)</span></span>
<span id="cb868-29"><a href="#cb868-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> some <span class="op">=&gt;</span> <span class="fu">cont</span><span class="op">(</span>some<span class="op">)</span></span>
<span id="cb868-30"><a href="#cb868-30" aria-hidden="true" tabindex="-1"></a>          <span class="op">}</span></span>
<span id="cb868-31"><a href="#cb868-31" aria-hidden="true" tabindex="-1"></a>          <span class="fu">loop</span><span class="op">(</span>first<span class="op">,</span> idx<span class="op">,</span> k<span class="op">)</span></span>
<span id="cb868-32"><a href="#cb868-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb868-33"><a href="#cb868-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">Repeat</span><span class="op">(</span>source<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb868-34"><a href="#cb868-34" aria-hidden="true" tabindex="-1"></a>          <span class="kw">val</span> k<span class="op">:</span> Continuation <span class="op">=</span></span>
<span id="cb868-35"><a href="#cb868-35" aria-hidden="true" tabindex="-1"></a>            _ <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb868-36"><a href="#cb868-36" aria-hidden="true" tabindex="-1"></a>              <span class="cf">case</span> <span class="bu">None</span>    <span class="op">=&gt;</span> <span class="fu">cont</span><span class="op">(</span><span class="bu">Some</span><span class="op">(</span>idx<span class="op">))</span></span>
<span id="cb868-37"><a href="#cb868-37" aria-hidden="true" tabindex="-1"></a>              <span class="cf">case</span> <span class="bu">Some</span><span class="op">(</span>i<span class="op">)</span> <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>regexp<span class="op">,</span> i<span class="op">,</span> cont<span class="op">)</span></span>
<span id="cb868-38"><a href="#cb868-38" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb868-39"><a href="#cb868-39" aria-hidden="true" tabindex="-1"></a>          <span class="fu">loop</span><span class="op">(</span>source<span class="op">,</span> idx<span class="op">,</span> k<span class="op">)</span></span>
<span id="cb868-40"><a href="#cb868-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb868-41"><a href="#cb868-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fu">Apply</span><span class="op">(</span>string<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb868-42"><a href="#cb868-42" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cont</span><span class="op">(</span><span class="ex">Option</span><span class="op">.</span><span class="fu">when</span><span class="op">(</span>input<span class="op">.</span><span class="fu">startsWith</span><span class="op">(</span>string<span class="op">,</span> idx<span class="op">))(</span>idx <span class="op">+</span> string<span class="op">.</span>size<span class="op">))</span></span>
<span id="cb868-43"><a href="#cb868-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb868-44"><a href="#cb868-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> Empty <span class="op">=&gt;</span></span>
<span id="cb868-45"><a href="#cb868-45" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cont</span><span class="op">(</span><span class="bu">None</span><span class="op">)</span></span>
<span id="cb868-46"><a href="#cb868-46" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb868-47"><a href="#cb868-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb868-48"><a href="#cb868-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check we matched the entire input</span></span>
<span id="cb868-49"><a href="#cb868-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">loop</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> identity<span class="op">).</span><span class="fu">map</span><span class="op">(</span>idx <span class="op">=&gt;</span> idx <span class="op">==</span> input<span class="op">.</span>size<span class="op">).</span><span class="fu">getOrElse</span><span class="op">(</span><span class="kw">false</span><span class="op">)</span></span>
<span id="cb868-50"><a href="#cb868-50" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb868-51"><a href="#cb868-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb868-52"><a href="#cb868-52" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Append</span><span class="op">(</span>left<span class="op">:</span> Regexp<span class="op">,</span> right<span class="op">:</span> Regexp<span class="op">)</span></span>
<span id="cb868-53"><a href="#cb868-53" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">OrElse</span><span class="op">(</span>first<span class="op">:</span> Regexp<span class="op">,</span> second<span class="op">:</span> Regexp<span class="op">)</span></span>
<span id="cb868-54"><a href="#cb868-54" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Repeat</span><span class="op">(</span>source<span class="op">:</span> Regexp<span class="op">)</span></span>
<span id="cb868-55"><a href="#cb868-55" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Apply</span><span class="op">(</span>string<span class="op">:</span> <span class="ex">String</span><span class="op">)</span></span>
<span id="cb868-56"><a href="#cb868-56" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> Empty</span>
<span id="cb868-57"><a href="#cb868-57" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb868-58"><a href="#cb868-58" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Regexp <span class="op">{</span></span>
<span id="cb868-59"><a href="#cb868-59" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> empty<span class="op">:</span> Regexp <span class="op">=</span> Empty</span>
<span id="cb868-60"><a href="#cb868-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb868-61"><a href="#cb868-61" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>string<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> Regexp <span class="op">=</span></span>
<span id="cb868-62"><a href="#cb868-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Apply</span><span class="op">(</span>string<span class="op">)</span></span>
<span id="cb868-63"><a href="#cb868-63" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>To reify the continuations we can apply the same recipe as
    before: we create a case for each place in which we construct a
    continuation. In our interpreter loop this is for
    <code>Append</code>, <code>OrElse</code>, and <code>Repeat</code>.
    We also construct a continuation using the identity function when we
    first call <code>loop</code>, which represents the continuation to
    call when the loop has finished. This gives us four cases.</p>
    <div class="sourceCode" id="cb869"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb869-1"><a href="#cb869-1" aria-hidden="true" tabindex="-1"></a>enum Continuation <span class="op">{</span></span>
<span id="cb869-2"><a href="#cb869-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> AppendK</span>
<span id="cb869-3"><a href="#cb869-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> OrElseK</span>
<span id="cb869-4"><a href="#cb869-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> RepeatK</span>
<span id="cb869-5"><a href="#cb869-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> DoneK</span>
<span id="cb869-6"><a href="#cb869-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>What data does each case next to hold? Let’s let look at the
    structure of the cases within the CPS interpreter. The case for
    <code>Append</code> is typical.</p>
    <div class="sourceCode" id="cb870"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb870-1"><a href="#cb870-1" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="fu">Append</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb870-2"><a href="#cb870-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> k<span class="op">:</span> Cont <span class="op">=</span> _ <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb870-3"><a href="#cb870-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="bu">None</span>    <span class="op">=&gt;</span> <span class="fu">cont</span><span class="op">(</span><span class="bu">None</span><span class="op">)</span></span>
<span id="cb870-4"><a href="#cb870-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="bu">Some</span><span class="op">(</span>i<span class="op">)</span> <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>right<span class="op">,</span> i<span class="op">,</span> cont<span class="op">)</span></span>
<span id="cb870-5"><a href="#cb870-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb870-6"><a href="#cb870-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loop</span><span class="op">(</span>left<span class="op">,</span> idx<span class="op">,</span> k<span class="op">)</span></span></code></pre></div>
    <p>The continuation <code>k</code> refers to the <code>Regexp</code>
    <code>right</code>, the method <code>loop</code>, and the
    continuation <code>cont</code>. Our reification should reflect this
    by holding the same data. If we consider all the cases we end up
    with the following definition. Notice that I implemented an
    <code>apply</code> method so we can still call these continuations
    like a function.</p>
    <div class="sourceCode" id="cb871"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb871-1"><a href="#cb871-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Loop <span class="op">=</span> <span class="op">(</span>Regexp<span class="op">,</span> <span class="bu">Int</span><span class="op">,</span> Continuation<span class="op">)</span> <span class="op">=&gt;</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span></span>
<span id="cb871-2"><a href="#cb871-2" aria-hidden="true" tabindex="-1"></a>enum Continuation <span class="op">{</span></span>
<span id="cb871-3"><a href="#cb871-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">AppendK</span><span class="op">(</span>right<span class="op">:</span> Regexp<span class="op">,</span> loop<span class="op">:</span> Loop<span class="op">,</span> next<span class="op">:</span> Continuation<span class="op">)</span></span>
<span id="cb871-4"><a href="#cb871-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">OrElseK</span><span class="op">(</span>second<span class="op">:</span> Regexp<span class="op">,</span> index<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> loop<span class="op">:</span> Loop<span class="op">,</span> next<span class="op">:</span> Continuation<span class="op">)</span></span>
<span id="cb871-5"><a href="#cb871-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">RepeatK</span><span class="op">(</span>regexp<span class="op">:</span> Regexp<span class="op">,</span> index<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> loop<span class="op">:</span> Loop<span class="op">,</span> next<span class="op">:</span> Continuation<span class="op">)</span></span>
<span id="cb871-6"><a href="#cb871-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> DoneK</span>
<span id="cb871-7"><a href="#cb871-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb871-8"><a href="#cb871-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>idx<span class="op">:</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">]):</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb871-9"><a href="#cb871-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb871-10"><a href="#cb871-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">AppendK</span><span class="op">(</span>right<span class="op">,</span> loop<span class="op">,</span> next<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb871-11"><a href="#cb871-11" aria-hidden="true" tabindex="-1"></a>        idx <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb871-12"><a href="#cb871-12" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> <span class="bu">None</span>    <span class="op">=&gt;</span> <span class="fu">next</span><span class="op">(</span><span class="bu">None</span><span class="op">)</span></span>
<span id="cb871-13"><a href="#cb871-13" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> <span class="bu">Some</span><span class="op">(</span>i<span class="op">)</span> <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>right<span class="op">,</span> i<span class="op">,</span> next<span class="op">)</span></span>
<span id="cb871-14"><a href="#cb871-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb871-15"><a href="#cb871-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb871-16"><a href="#cb871-16" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">OrElseK</span><span class="op">(</span>second<span class="op">,</span> index<span class="op">,</span> loop<span class="op">,</span> next<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb871-17"><a href="#cb871-17" aria-hidden="true" tabindex="-1"></a>        idx <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb871-18"><a href="#cb871-18" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> <span class="bu">None</span> <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>second<span class="op">,</span> index<span class="op">,</span> next<span class="op">)</span></span>
<span id="cb871-19"><a href="#cb871-19" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> some <span class="op">=&gt;</span> <span class="fu">next</span><span class="op">(</span>some<span class="op">)</span></span>
<span id="cb871-20"><a href="#cb871-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb871-21"><a href="#cb871-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb871-22"><a href="#cb871-22" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">RepeatK</span><span class="op">(</span>regexp<span class="op">,</span> index<span class="op">,</span> loop<span class="op">,</span> next<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb871-23"><a href="#cb871-23" aria-hidden="true" tabindex="-1"></a>        idx <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb871-24"><a href="#cb871-24" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> <span class="bu">None</span>    <span class="op">=&gt;</span> <span class="fu">next</span><span class="op">(</span><span class="bu">Some</span><span class="op">(</span>index<span class="op">))</span></span>
<span id="cb871-25"><a href="#cb871-25" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> <span class="bu">Some</span><span class="op">(</span>i<span class="op">)</span> <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span>regexp<span class="op">,</span> i<span class="op">,</span> next<span class="op">)</span></span>
<span id="cb871-26"><a href="#cb871-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb871-27"><a href="#cb871-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb871-28"><a href="#cb871-28" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> DoneK <span class="op">=&gt;</span></span>
<span id="cb871-29"><a href="#cb871-29" aria-hidden="true" tabindex="-1"></a>        idx</span>
<span id="cb871-30"><a href="#cb871-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb871-31"><a href="#cb871-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Now we can rewrite the interpreter loop using the
    <code>Continuation</code> type.</p>
    <div class="sourceCode" id="cb872"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb872-1"><a href="#cb872-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">matches</span><span class="op">(</span>input<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Boolean</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb872-2"><a href="#cb872-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">loop</span><span class="op">(</span></span>
<span id="cb872-3"><a href="#cb872-3" aria-hidden="true" tabindex="-1"></a>      regexp<span class="op">:</span> Regexp<span class="op">,</span></span>
<span id="cb872-4"><a href="#cb872-4" aria-hidden="true" tabindex="-1"></a>      idx<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span></span>
<span id="cb872-5"><a href="#cb872-5" aria-hidden="true" tabindex="-1"></a>      cont<span class="op">:</span> Continuation</span>
<span id="cb872-6"><a href="#cb872-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">):</span> <span class="ex">Option</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb872-7"><a href="#cb872-7" aria-hidden="true" tabindex="-1"></a>    regexp <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb872-8"><a href="#cb872-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Append</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb872-9"><a href="#cb872-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">val</span> k<span class="op">:</span> Continuation <span class="op">=</span> <span class="fu">AppendK</span><span class="op">(</span>right<span class="op">,</span> loop<span class="op">,</span> cont<span class="op">)</span></span>
<span id="cb872-10"><a href="#cb872-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">loop</span><span class="op">(</span>left<span class="op">,</span> idx<span class="op">,</span> k<span class="op">)</span></span>
<span id="cb872-11"><a href="#cb872-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb872-12"><a href="#cb872-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">OrElse</span><span class="op">(</span>first<span class="op">,</span> second<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb872-13"><a href="#cb872-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">val</span> k<span class="op">:</span> Continuation <span class="op">=</span> <span class="fu">OrElseK</span><span class="op">(</span>second<span class="op">,</span> idx<span class="op">,</span> loop<span class="op">,</span> cont<span class="op">)</span></span>
<span id="cb872-14"><a href="#cb872-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">loop</span><span class="op">(</span>first<span class="op">,</span> idx<span class="op">,</span> k<span class="op">)</span></span>
<span id="cb872-15"><a href="#cb872-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb872-16"><a href="#cb872-16" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Repeat</span><span class="op">(</span>source<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb872-17"><a href="#cb872-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">val</span> k<span class="op">:</span> Continuation <span class="op">=</span> <span class="fu">RepeatK</span><span class="op">(</span>regexp<span class="op">,</span> idx<span class="op">,</span> loop<span class="op">,</span> cont<span class="op">)</span></span>
<span id="cb872-18"><a href="#cb872-18" aria-hidden="true" tabindex="-1"></a>        <span class="fu">loop</span><span class="op">(</span>source<span class="op">,</span> idx<span class="op">,</span> k<span class="op">)</span></span>
<span id="cb872-19"><a href="#cb872-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb872-20"><a href="#cb872-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Apply</span><span class="op">(</span>string<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb872-21"><a href="#cb872-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cont</span><span class="op">(</span><span class="ex">Option</span><span class="op">.</span><span class="fu">when</span><span class="op">(</span>input<span class="op">.</span><span class="fu">startsWith</span><span class="op">(</span>string<span class="op">,</span> idx<span class="op">))(</span>idx <span class="op">+</span> string<span class="op">.</span>size<span class="op">))</span></span>
<span id="cb872-22"><a href="#cb872-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb872-23"><a href="#cb872-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> Empty <span class="op">=&gt;</span></span>
<span id="cb872-24"><a href="#cb872-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cont</span><span class="op">(</span><span class="bu">None</span><span class="op">)</span></span>
<span id="cb872-25"><a href="#cb872-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb872-26"><a href="#cb872-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb872-27"><a href="#cb872-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check we matched the entire input</span></span>
<span id="cb872-28"><a href="#cb872-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loop</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> DoneK<span class="op">)</span></span>
<span id="cb872-29"><a href="#cb872-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span><span class="op">(</span>idx <span class="op">=&gt;</span> idx <span class="op">==</span> input<span class="op">.</span>size<span class="op">)</span></span>
<span id="cb872-30"><a href="#cb872-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">getOrElse</span><span class="op">(</span><span class="kw">false</span><span class="op">)</span></span>
<span id="cb872-31"><a href="#cb872-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>The point of this construction is that we’ve reified the stack:
    it’s now explicitly represented as the <code>next</code> field in
    each <code>Continuation</code>. The stack is a last-in first-out
    (LIFO) data structure: the last element we add to the stack is the
    first element we use. (This is exactly the same as efficient use of
    a <code>List</code>.) We construct continuations by adding elements
    to the front of the existing continuation, which is exactly how we
    construct lists or stacks. We use continuations from front-to-back;
    in other words in last-in first-out (LIFO) order. This is the
    correct access pattern to use a list efficiently, and also the
    access pattern that defines a stack. Reifying the continuations as
    data has reified the stack. In the next section we’ll use this fact
    to build a compiler that targets a stack machine.</p>
    <h2 data-number="14.3" id="compilers-and-virtual-machines"><span class="header-section-number">14.3</span> Compilers and Virtual
    Machines</h2>
    <p>We’ve reified continuations and seen they contain a stack
    structure: each continuation contains a references to the next
    continuation, and continuations are constructed in a last-in
    first-out order. We’ll now, once again, reify this structure. This
    time we’ll create an explicit stack, giving rise to a stack-based
    <strong>virtual machine</strong> to run our code. We’ll also
    introduce a compiler, transforming our code into a sequence of
    operations that run on this virtual machine. We’ll then look at
    optimizing our virtual machine. As this code involves benchmarking,
    there is an <a href="https://github.com/scalawithcats/stack-machine">accompanying
    repository</a> that contains benchmarks you can run on your own
    computer.</p>
    <h3 data-number="14.3.1" id="virtual-and-abstract-machines"><span class="header-section-number">14.3.1</span> Virtual and Abstract
    Machines</h3>
    <p>A virtual machine is a computational machine implemented in
    software rather than hardware. A virtual machine runs programs
    written in some <strong>instruction set</strong>. The Java Virtual
    Machine (JVM), for example, runs programs written in Java bytecode.
    Closely related are <strong>abstract machines</strong>. The two
    terms are sometimes used interchangeably but I’ll make the
    distinction that a virtual machine has an implementation in
    software, while an abstract machine is a theoretical model without
    an implementation. Thus we can think of an abstract machine as a
    concept, and a virtual machine as a realization of a concept. This
    is a distinction we’ve made in many other parts of the book.</p>
    <p>As an abstract machine, stack machines are represented by models
    such as push down automata and the SECD machine. From abstract stack
    machines we firstly get the concept itself of a stack machine. The
    two core operations for a stack are pushing a value on to the top of
    the stack, and popping the top value off the stack. Function
    arguments and results are both passed via the stack. So, for
    example, a binary operation like addition will pop the top two
    values off the stack, add them, and push the result onto the stack.
    Abstract stack machines also tell us that stack machines with a
    single stack are not universal computers. In other words, they are
    not as powerful as Turing machines. If we add a second stack, or
    some other form of additional memory, we have a universal computer.
    This informs the design of virtual machines based on a stack
    machine.</p>
    <p>Stack machines are also very common virtual machines. The Java
    Virtual Machine is a stack machine, as are the .Net and WASM virtual
    machines. They are easy to implement, and to write compilers for.
    We’ve already seen how easy it is to implement an interpreter so why
    should we care about stack machines, or virtual machines in general?
    The usual answer is performance. Implementing a virtual machine
    opens up opportunities for optimizations that are difficult to
    implement in interpreters. Virtual machines also give us a lot of
    flexibility. It’s simple to trace or otherwise inspect the execution
    of a virtual machine, which makes debugging easier. They are easy to
    port to different platforms and languages. Virtual machines are
    often very compact, as is the code they run. This makes them
    suitable for embedded devices. Our focus will be on performance.
    Although we won’t go down the rabbit-hole of compiler and virtual
    machine optimizations, which would easily take up an entire book,
    we’ll at least tip-toe to the edge and peek down.</p>
    <h3 data-number="14.3.2" id="compilation"><span class="header-section-number">14.3.2</span> Compilation</h3>
    <p>Let’s now briefly talk about compilation. A compiler transforms a
    program from one representation to another. In our case we will
    transform our programs represented as an algebraic data type of
    reified constructors and combinators into the instruction set for
    our virtual machine. The virtual machine itself is an interpreter
    for its instruction set. Computation always bottoms out in
    interpretation: a hardware CPU is nothing but an interpreter for
    it’s machine code.</p>
    <p>Notice there are two notions of program here, and two
    corresponding instruction sets: there is the program the
    structurally recursive interpreter executes, with an instruction set
    consisting of reified constructors and combinators, and there is the
    program we compile this into for the stack machine using the stack
    machine’s instruction set. We will call these the interpreter
    program and instruction set, and stack machine program and
    instruction set respectively.</p>
    <p>The structurally recursive interpreter is an example of a
    <strong>tree-walking interpreter</strong> or <strong>abstract syntax
    tree (AST) interpreter</strong>. The stack machine is an example of
    a <strong>byte-code interpreter</strong>.</p>
    <h2 data-number="14.4" id="from-interpreter-to-stack-machine"><span class="header-section-number">14.4</span> From Interpreter to Stack
    Machine</h2>
    <p>There are three parts to transforming an interpreter to a stack
    machine:</p>
    <ol type="1">
    <li>creating the instruction set the stack machine will run;</li>
    <li>creating the compiler from interpreter programs to stack machine
    programs; and</li>
    <li>implementing the stack machine to execute stack machine
    instructions.</li>
    </ol>
    <p>Let’s make this concrete by returning to our arithmetic
    interpreter.</p>
    <div class="sourceCode" id="cb873"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb873-1"><a href="#cb873-1" aria-hidden="true" tabindex="-1"></a>enum <span class="ex">Expression</span> <span class="op">{</span></span>
<span id="cb873-2"><a href="#cb873-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">+(</span>that<span class="op">:</span> <span class="ex">Expression</span><span class="op">):</span> <span class="ex">Expression</span> <span class="op">=</span> <span class="fu">Addition</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb873-3"><a href="#cb873-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">*(</span>that<span class="op">:</span> <span class="ex">Expression</span><span class="op">):</span> <span class="ex">Expression</span> <span class="op">=</span> <span class="fu">Multiplication</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb873-4"><a href="#cb873-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">-(</span>that<span class="op">:</span> <span class="ex">Expression</span><span class="op">):</span> <span class="ex">Expression</span> <span class="op">=</span> <span class="fu">Subtraction</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb873-5"><a href="#cb873-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="op">/(</span>that<span class="op">:</span> <span class="ex">Expression</span><span class="op">):</span> <span class="ex">Expression</span> <span class="op">=</span> <span class="fu">Division</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb873-6"><a href="#cb873-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb873-7"><a href="#cb873-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> eval<span class="op">:</span> <span class="ex">Double</span> <span class="op">=</span></span>
<span id="cb873-8"><a href="#cb873-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb873-9"><a href="#cb873-9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Literal</span><span class="op">(</span>value<span class="op">)</span>              <span class="op">=&gt;</span> value</span>
<span id="cb873-10"><a href="#cb873-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Addition</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span>       <span class="op">=&gt;</span> left<span class="op">.</span>eval <span class="op">+</span> right<span class="op">.</span>eval</span>
<span id="cb873-11"><a href="#cb873-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Subtraction</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span>    <span class="op">=&gt;</span> left<span class="op">.</span>eval <span class="op">-</span> right<span class="op">.</span>eval</span>
<span id="cb873-12"><a href="#cb873-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Multiplication</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span> left<span class="op">.</span>eval <span class="op">*</span> right<span class="op">.</span>eval</span>
<span id="cb873-13"><a href="#cb873-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Division</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span>       <span class="op">=&gt;</span> left<span class="op">.</span>eval <span class="op">/</span> right<span class="op">.</span>eval</span>
<span id="cb873-14"><a href="#cb873-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb873-15"><a href="#cb873-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb873-16"><a href="#cb873-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Literal</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">Double</span><span class="op">)</span></span>
<span id="cb873-17"><a href="#cb873-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Addition</span><span class="op">(</span>left<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> right<span class="op">:</span> <span class="ex">Expression</span><span class="op">)</span></span>
<span id="cb873-18"><a href="#cb873-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Subtraction</span><span class="op">(</span>left<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> right<span class="op">:</span> <span class="ex">Expression</span><span class="op">)</span></span>
<span id="cb873-19"><a href="#cb873-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Multiplication</span><span class="op">(</span>left<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> right<span class="op">:</span> <span class="ex">Expression</span><span class="op">)</span></span>
<span id="cb873-20"><a href="#cb873-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Division</span><span class="op">(</span>left<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> right<span class="op">:</span> <span class="ex">Expression</span><span class="op">)</span></span>
<span id="cb873-21"><a href="#cb873-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb873-22"><a href="#cb873-22" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> <span class="ex">Expression</span> <span class="op">{</span></span>
<span id="cb873-23"><a href="#cb873-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">literal</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">Double</span><span class="op">):</span> <span class="ex">Expression</span> <span class="op">=</span> <span class="fu">Literal</span><span class="op">(</span>value<span class="op">)</span></span>
<span id="cb873-24"><a href="#cb873-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Interpreter programs are defined by the interpreter instruction
    set</p>
    <div class="sourceCode" id="cb874"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb874-1"><a href="#cb874-1" aria-hidden="true" tabindex="-1"></a>enum <span class="ex">Expression</span> <span class="op">{</span></span>
<span id="cb874-2"><a href="#cb874-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Literal</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">Double</span><span class="op">)</span></span>
<span id="cb874-3"><a href="#cb874-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Addition</span><span class="op">(</span>left<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> right<span class="op">:</span> <span class="ex">Expression</span><span class="op">)</span></span>
<span id="cb874-4"><a href="#cb874-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Subtraction</span><span class="op">(</span>left<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> right<span class="op">:</span> <span class="ex">Expression</span><span class="op">)</span></span>
<span id="cb874-5"><a href="#cb874-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Multiplication</span><span class="op">(</span>left<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> right<span class="op">:</span> <span class="ex">Expression</span><span class="op">)</span></span>
<span id="cb874-6"><a href="#cb874-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Division</span><span class="op">(</span>left<span class="op">:</span> <span class="ex">Expression</span><span class="op">,</span> right<span class="op">:</span> <span class="ex">Expression</span><span class="op">)</span></span>
<span id="cb874-7"><a href="#cb874-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Transforming the interpreter instruction set to the stack machine
    instruction set works as follows:</p>
    <ul>
    <li>each constructor interpreter instruction corresponds to stack
    machine instruction carrying exactly the same data; and</li>
    <li>each combinator interpreter instruction has a corresponding
    stack machine instruction that carries only non-recursive data.
    Recursive data, which is executed by recursive calls to the
    interpreter, will be represented by data on the stack machine’s
    stack.</li>
    </ul>
    <p>Turning to the arithmetic interpreter’s instruction set, we see
    that <code>Literal</code> is our sole constructor and thus has a
    mirror in our stack machine’s instruction set. Here I’ve named the
    interpreter instruction set <code>Op</code> (short for “operation”),
    and shortened the name from <code>Literal</code> to <code>Lit</code>
    to make it clearer which instruction set we are using.</p>
    <div class="sourceCode" id="cb875"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb875-1"><a href="#cb875-1" aria-hidden="true" tabindex="-1"></a>enum Op <span class="op">{</span></span>
<span id="cb875-2"><a href="#cb875-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Lit</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">Double</span><span class="op">)</span></span>
<span id="cb875-3"><a href="#cb875-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>The other instructions are all combinators. They also all only
    contain values of type <code>Expression</code>, and hence in the
    stack machine the corresponding values will be found on the stack.
    This gives us the complete stack machine instruction set.</p>
    <div class="sourceCode" id="cb876"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb876-1"><a href="#cb876-1" aria-hidden="true" tabindex="-1"></a>enum Op <span class="op">{</span></span>
<span id="cb876-2"><a href="#cb876-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Lit</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">Double</span><span class="op">)</span></span>
<span id="cb876-3"><a href="#cb876-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> Add</span>
<span id="cb876-4"><a href="#cb876-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> Sub</span>
<span id="cb876-5"><a href="#cb876-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> Mul</span>
<span id="cb876-6"><a href="#cb876-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> Div</span>
<span id="cb876-7"><a href="#cb876-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>This completes the first step of the process. The second step is
    to implement the compiler. The secret to compiling for a stack
    machine is to transfrom instructions into <strong>reverse polish
    notation (RPN)</strong>. In RPN operations follow their operands.
    So, instead of writing <code>1 + 2</code> we write
    <code>1 2 +</code>. This is exactly the order in which a stack
    machine works. To evaluate <code>1 + 2</code> we should first push
    <code>1</code> onto the stack, then push <code>2</code>, and finally
    pop both these values, perform the addition, and push the result
    back to the stack. RPN also does not need nesting. To represent
    <code>1 + (2 + 3)</code> in RPN we simply use
    <code>2 3 + 1 +</code>. Doing away with brackets means that stack
    machine programs can be represented as a linear sequence of
    instructions, not a tree. Concretely, we can use
    <code>List[Op]</code>.</p>
    <p>How we should we implement the conversion to RPN. We are
    performing a transformation on an algebraic data type, our
    interpreter instruction set and therefore we can use structural
    recursion. The following code shows one way to implement this. It’s
    not very efficient (appending lists is a slow operation) but this
    doesn’t matter for our purposes.</p>
    <div class="sourceCode" id="cb877"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb877-1"><a href="#cb877-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compile<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>Op<span class="op">]</span> <span class="op">=</span></span>
<span id="cb877-2"><a href="#cb877-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb877-3"><a href="#cb877-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Literal</span><span class="op">(</span>value<span class="op">)</span> <span class="op">=&gt;</span> <span class="ex">List</span><span class="op">(</span>Op<span class="op">.</span><span class="fu">Lit</span><span class="op">(</span>value<span class="op">))</span></span>
<span id="cb877-4"><a href="#cb877-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Addition</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb877-5"><a href="#cb877-5" aria-hidden="true" tabindex="-1"></a>      left<span class="op">.</span>compile <span class="op">++</span> right<span class="op">.</span>compile <span class="op">++</span> <span class="ex">List</span><span class="op">(</span>Op<span class="op">.</span>Add<span class="op">)</span></span>
<span id="cb877-6"><a href="#cb877-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Subtraction</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb877-7"><a href="#cb877-7" aria-hidden="true" tabindex="-1"></a>      left<span class="op">.</span>compile <span class="op">++</span> right<span class="op">.</span>compile <span class="op">++</span> <span class="ex">List</span><span class="op">(</span>Op<span class="op">.</span>Sub<span class="op">)</span></span>
<span id="cb877-8"><a href="#cb877-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Multiplication</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb877-9"><a href="#cb877-9" aria-hidden="true" tabindex="-1"></a>      left<span class="op">.</span>compile <span class="op">++</span> right<span class="op">.</span>compile <span class="op">++</span> <span class="ex">List</span><span class="op">(</span>Op<span class="op">.</span>Mul<span class="op">)</span></span>
<span id="cb877-10"><a href="#cb877-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="fu">Division</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb877-11"><a href="#cb877-11" aria-hidden="true" tabindex="-1"></a>      left<span class="op">.</span>compile <span class="op">++</span> right<span class="op">.</span>compile <span class="op">++</span> <span class="ex">List</span><span class="op">(</span>Op<span class="op">.</span>Div<span class="op">)</span></span>
<span id="cb877-12"><a href="#cb877-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>We now are left to implement the stack machine. We’ll start by
    sketching out the interface for the stack machine.</p>
    <div class="sourceCode" id="cb878"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb878-1"><a href="#cb878-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">StackMachine</span><span class="op">(</span>program<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>Op<span class="op">])</span> <span class="op">{</span></span>
<span id="cb878-2"><a href="#cb878-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> eval<span class="op">:</span> <span class="ex">Double</span> <span class="op">=</span> <span class="op">???</span></span>
<span id="cb878-3"><a href="#cb878-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>In this design the program is fixed for a given
    <code>StackMachine</code> instance, but we can run the program
    multiple times.</p>
    <p>Now we’ll implement <code>eval</code>. It is a structural
    recursion over an algebraic data type, in this case the
    <code>program</code> of type <code>List[Op]</code>. It’s a little
    bit more complicated than some of the structural recursions we have
    seen, because we need to implement the stack as well. We’ll
    represent the stack as a <code>List[Double]</code>, and define
    methods to push and pop the stack.</p>
    <div class="sourceCode" id="cb879"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb879-1"><a href="#cb879-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">StackMachine</span><span class="op">(</span>program<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>Op<span class="op">])</span> <span class="op">{</span></span>
<span id="cb879-2"><a href="#cb879-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> eval<span class="op">:</span> <span class="ex">Double</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb879-3"><a href="#cb879-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">pop</span><span class="op">(</span>stack<span class="op">:</span> <span class="ex">List</span><span class="op">[</span><span class="ex">Double</span><span class="op">]):</span> <span class="op">(</span><span class="ex">Double</span><span class="op">,</span> <span class="ex">List</span><span class="op">[</span><span class="ex">Double</span><span class="op">])</span> <span class="op">=</span></span>
<span id="cb879-4"><a href="#cb879-4" aria-hidden="true" tabindex="-1"></a>      stack <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb879-5"><a href="#cb879-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> head <span class="op">::</span> next <span class="op">=&gt;</span> <span class="op">(</span>head<span class="op">,</span> next<span class="op">)</span></span>
<span id="cb879-6"><a href="#cb879-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> Nil <span class="op">=&gt;</span></span>
<span id="cb879-7"><a href="#cb879-7" aria-hidden="true" tabindex="-1"></a>          <span class="cf">throw</span> <span class="kw">new</span> <span class="ex">IllegalStateException</span><span class="op">(</span></span>
<span id="cb879-8"><a href="#cb879-8" aria-hidden="true" tabindex="-1"></a>            <span class="ss">s&quot;</span><span class="st">The data stack does not have any elements.</span><span class="ss">&quot;</span></span>
<span id="cb879-9"><a href="#cb879-9" aria-hidden="true" tabindex="-1"></a>          <span class="op">)</span></span>
<span id="cb879-10"><a href="#cb879-10" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb879-11"><a href="#cb879-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb879-12"><a href="#cb879-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">push</span><span class="op">(</span>value<span class="op">:</span> <span class="ex">Double</span><span class="op">,</span> stack<span class="op">:</span> <span class="ex">List</span><span class="op">[</span><span class="ex">Double</span><span class="op">]):</span> <span class="ex">List</span><span class="op">[</span><span class="ex">Double</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb879-13"><a href="#cb879-13" aria-hidden="true" tabindex="-1"></a>      value <span class="op">::</span> stack</span>
<span id="cb879-14"><a href="#cb879-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb879-15"><a href="#cb879-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb879-16"><a href="#cb879-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb879-17"><a href="#cb879-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Now we can define the main stack machine loop. It takes as
    parameters the program and the stack, and is a structural recursion
    over the program.</p>
    <div class="sourceCode" id="cb880"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb880-1"><a href="#cb880-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> eval<span class="op">:</span> <span class="ex">Double</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb880-2"><a href="#cb880-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// pop and push defined here ...</span></span>
<span id="cb880-3"><a href="#cb880-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb880-4"><a href="#cb880-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">loop</span><span class="op">(</span>stack<span class="op">:</span> <span class="ex">List</span><span class="op">[</span><span class="ex">Double</span><span class="op">],</span> program<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>Op<span class="op">]):</span> <span class="ex">Double</span> <span class="op">=</span></span>
<span id="cb880-5"><a href="#cb880-5" aria-hidden="true" tabindex="-1"></a>    program <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb880-6"><a href="#cb880-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> head <span class="op">::</span> next <span class="op">=&gt;</span></span>
<span id="cb880-7"><a href="#cb880-7" aria-hidden="true" tabindex="-1"></a>        head <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb880-8"><a href="#cb880-8" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> Op<span class="op">.</span><span class="fu">Lit</span><span class="op">(</span>value<span class="op">)</span> <span class="op">=&gt;</span> <span class="fu">loop</span><span class="op">(</span><span class="fu">push</span><span class="op">(</span>value<span class="op">,</span> stack<span class="op">),</span> next<span class="op">)</span></span>
<span id="cb880-9"><a href="#cb880-9" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> Op<span class="op">.</span>Add <span class="op">=&gt;</span></span>
<span id="cb880-10"><a href="#cb880-10" aria-hidden="true" tabindex="-1"></a>            <span class="kw">val</span> <span class="op">(</span>a<span class="op">,</span> s1<span class="op">)</span> <span class="op">=</span> <span class="fu">pop</span><span class="op">(</span>stack<span class="op">)</span></span>
<span id="cb880-11"><a href="#cb880-11" aria-hidden="true" tabindex="-1"></a>            <span class="kw">val</span> <span class="op">(</span>b<span class="op">,</span> s2<span class="op">)</span> <span class="op">=</span> <span class="fu">pop</span><span class="op">(</span>s1<span class="op">)</span></span>
<span id="cb880-12"><a href="#cb880-12" aria-hidden="true" tabindex="-1"></a>            <span class="kw">val</span> s <span class="op">=</span> <span class="fu">push</span><span class="op">(</span>a <span class="op">+</span> b<span class="op">,</span> s2<span class="op">)</span></span>
<span id="cb880-13"><a href="#cb880-13" aria-hidden="true" tabindex="-1"></a>            <span class="fu">loop</span><span class="op">(</span>s<span class="op">,</span> next<span class="op">)</span></span>
<span id="cb880-14"><a href="#cb880-14" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> Op<span class="op">.</span>Sub <span class="op">=&gt;</span></span>
<span id="cb880-15"><a href="#cb880-15" aria-hidden="true" tabindex="-1"></a>            <span class="kw">val</span> <span class="op">(</span>a<span class="op">,</span> s1<span class="op">)</span> <span class="op">=</span> <span class="fu">pop</span><span class="op">(</span>stack<span class="op">)</span></span>
<span id="cb880-16"><a href="#cb880-16" aria-hidden="true" tabindex="-1"></a>            <span class="kw">val</span> <span class="op">(</span>b<span class="op">,</span> s2<span class="op">)</span> <span class="op">=</span> <span class="fu">pop</span><span class="op">(</span>s1<span class="op">)</span></span>
<span id="cb880-17"><a href="#cb880-17" aria-hidden="true" tabindex="-1"></a>            <span class="kw">val</span> s <span class="op">=</span> <span class="fu">push</span><span class="op">(</span>a <span class="op">+</span> b<span class="op">,</span> s2<span class="op">)</span></span>
<span id="cb880-18"><a href="#cb880-18" aria-hidden="true" tabindex="-1"></a>            <span class="fu">loop</span><span class="op">(</span>s<span class="op">,</span> next<span class="op">)</span></span>
<span id="cb880-19"><a href="#cb880-19" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> Op<span class="op">.</span>Mul <span class="op">=&gt;</span></span>
<span id="cb880-20"><a href="#cb880-20" aria-hidden="true" tabindex="-1"></a>            <span class="kw">val</span> <span class="op">(</span>a<span class="op">,</span> s1<span class="op">)</span> <span class="op">=</span> <span class="fu">pop</span><span class="op">(</span>stack<span class="op">)</span></span>
<span id="cb880-21"><a href="#cb880-21" aria-hidden="true" tabindex="-1"></a>            <span class="kw">val</span> <span class="op">(</span>b<span class="op">,</span> s2<span class="op">)</span> <span class="op">=</span> <span class="fu">pop</span><span class="op">(</span>s1<span class="op">)</span></span>
<span id="cb880-22"><a href="#cb880-22" aria-hidden="true" tabindex="-1"></a>            <span class="kw">val</span> s <span class="op">=</span> <span class="fu">push</span><span class="op">(</span>a <span class="op">+</span> b<span class="op">,</span> s2<span class="op">)</span></span>
<span id="cb880-23"><a href="#cb880-23" aria-hidden="true" tabindex="-1"></a>            <span class="fu">loop</span><span class="op">(</span>s<span class="op">,</span> next<span class="op">)</span></span>
<span id="cb880-24"><a href="#cb880-24" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> Op<span class="op">.</span>Div <span class="op">=&gt;</span></span>
<span id="cb880-25"><a href="#cb880-25" aria-hidden="true" tabindex="-1"></a>            <span class="kw">val</span> <span class="op">(</span>a<span class="op">,</span> s1<span class="op">)</span> <span class="op">=</span> <span class="fu">pop</span><span class="op">(</span>stack<span class="op">)</span></span>
<span id="cb880-26"><a href="#cb880-26" aria-hidden="true" tabindex="-1"></a>            <span class="kw">val</span> <span class="op">(</span>b<span class="op">,</span> s2<span class="op">)</span> <span class="op">=</span> <span class="fu">pop</span><span class="op">(</span>s1<span class="op">)</span></span>
<span id="cb880-27"><a href="#cb880-27" aria-hidden="true" tabindex="-1"></a>            <span class="kw">val</span> s <span class="op">=</span> <span class="fu">push</span><span class="op">(</span>a <span class="op">+</span> b<span class="op">,</span> s2<span class="op">)</span></span>
<span id="cb880-28"><a href="#cb880-28" aria-hidden="true" tabindex="-1"></a>            <span class="fu">loop</span><span class="op">(</span>s<span class="op">,</span> next<span class="op">)</span></span>
<span id="cb880-29"><a href="#cb880-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb880-30"><a href="#cb880-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb880-31"><a href="#cb880-31" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> Nil <span class="op">=&gt;</span> stack<span class="op">.</span>head</span>
<span id="cb880-32"><a href="#cb880-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb880-33"><a href="#cb880-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb880-34"><a href="#cb880-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loop</span><span class="op">(</span><span class="ex">List</span><span class="op">.</span>empty<span class="op">,</span> program<span class="op">)</span></span>
<span id="cb880-35"><a href="#cb880-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>I’ve implemented a simple benchmark for this code (see <a href="https://github.com/scalawithcats/stack-machine">the
    repository</a>) and it’s roughly five times slower than the
    interpreter we started with. Clearly some optimization is
    needed.</p>
    <h3 data-number="14.4.1" id="effectful-interpreters"><span class="header-section-number">14.4.1</span> Effectful
    Interpreters</h3>
    <p>One of the reasons for using the interpreter strategy is to
    isolate effects, such as state or input and output. An interpreter
    can be effectful without impacting the ability to reason about or
    compose the programs the interpreter runs. Sometimes the effects are
    the entire point of the interpreter as the program may describe
    effectful actions, such as parsing network data or drawing on a
    screen, which the interpreter then carries out. Sometimes effects
    may just be optimizations, which is how we are going to use them in
    our arithmetic stack machine.</p>
    <p>There are many inefficiencies in the stack machine we have just
    created. A <code>List</code> is a poor choice of data structure for
    both the stack and program. We can avoid a lot of pointer chasing
    and memory allocation by using a fixed size <code>Array</code>. The
    program never changes in size, and we can simply allocate a large
    enough stack that resizing it becomes very unlikely. We can also
    avoid the indirection of pushing and popping and operate directly on
    the stack array.</p>
    <p>The code below shows a simple implementation, which in my
    benchmarking is about thirty percent faster than the tree-walking
    interpreter.</p>
    <div class="sourceCode" id="cb881"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb881-1"><a href="#cb881-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">StackMachine</span><span class="op">(</span>program<span class="op">:</span> <span class="ex">Array</span><span class="op">[</span>Op<span class="op">])</span> <span class="op">{</span></span>
<span id="cb881-2"><a href="#cb881-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// The data stack</span></span>
<span id="cb881-3"><a href="#cb881-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">private</span> <span class="kw">val</span> stack<span class="op">:</span> <span class="ex">Array</span><span class="op">[</span><span class="ex">Double</span><span class="op">]</span> <span class="op">=</span> <span class="ex">Array</span><span class="op">.</span>ofDim<span class="op">[</span><span class="ex">Double</span><span class="op">](</span><span class="dv">256</span><span class="op">)</span></span>
<span id="cb881-4"><a href="#cb881-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb881-5"><a href="#cb881-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> eval<span class="op">:</span> <span class="ex">Double</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb881-6"><a href="#cb881-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// sp points to first free element on the stack</span></span>
<span id="cb881-7"><a href="#cb881-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// stack(sp - 1) is the first element with data</span></span>
<span id="cb881-8"><a href="#cb881-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">//</span></span>
<span id="cb881-9"><a href="#cb881-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// pc points to the current instruction in program</span></span>
<span id="cb881-10"><a href="#cb881-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">loop</span><span class="op">(</span>sp<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> pc<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="ex">Double</span> <span class="op">=</span></span>
<span id="cb881-11"><a href="#cb881-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>pc <span class="op">==</span> program<span class="op">.</span>size<span class="op">)</span> <span class="fu">stack</span><span class="op">(</span>sp <span class="op">-</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb881-12"><a href="#cb881-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span></span>
<span id="cb881-13"><a href="#cb881-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">program</span><span class="op">(</span>pc<span class="op">)</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb881-14"><a href="#cb881-14" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> Op<span class="op">.</span><span class="fu">Lit</span><span class="op">(</span>value<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb881-15"><a href="#cb881-15" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stack</span><span class="op">(</span>sp<span class="op">)</span> <span class="op">=</span> value</span>
<span id="cb881-16"><a href="#cb881-16" aria-hidden="true" tabindex="-1"></a>            <span class="fu">loop</span><span class="op">(</span>sp <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> pc <span class="op">+</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb881-17"><a href="#cb881-17" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> Op<span class="op">.</span>Add <span class="op">=&gt;</span></span>
<span id="cb881-18"><a href="#cb881-18" aria-hidden="true" tabindex="-1"></a>            <span class="kw">val</span> a <span class="op">=</span> <span class="fu">stack</span><span class="op">(</span>sp <span class="op">-</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb881-19"><a href="#cb881-19" aria-hidden="true" tabindex="-1"></a>            <span class="kw">val</span> b <span class="op">=</span> <span class="fu">stack</span><span class="op">(</span>sp <span class="op">-</span> <span class="dv">2</span><span class="op">)</span></span>
<span id="cb881-20"><a href="#cb881-20" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stack</span><span class="op">(</span>sp <span class="op">-</span> <span class="dv">2</span><span class="op">)</span> <span class="op">=</span> <span class="op">(</span>a <span class="op">+</span> b<span class="op">)</span></span>
<span id="cb881-21"><a href="#cb881-21" aria-hidden="true" tabindex="-1"></a>            <span class="fu">loop</span><span class="op">(</span>sp <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> pc <span class="op">+</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb881-22"><a href="#cb881-22" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> Op<span class="op">.</span>Sub <span class="op">=&gt;</span></span>
<span id="cb881-23"><a href="#cb881-23" aria-hidden="true" tabindex="-1"></a>            <span class="kw">val</span> a <span class="op">=</span> <span class="fu">stack</span><span class="op">(</span>sp <span class="op">-</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb881-24"><a href="#cb881-24" aria-hidden="true" tabindex="-1"></a>            <span class="kw">val</span> b <span class="op">=</span> <span class="fu">stack</span><span class="op">(</span>sp <span class="op">-</span> <span class="dv">2</span><span class="op">)</span></span>
<span id="cb881-25"><a href="#cb881-25" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stack</span><span class="op">(</span>sp <span class="op">-</span> <span class="dv">2</span><span class="op">)</span> <span class="op">=</span> <span class="op">(</span>a <span class="op">-</span> b<span class="op">)</span></span>
<span id="cb881-26"><a href="#cb881-26" aria-hidden="true" tabindex="-1"></a>            <span class="fu">loop</span><span class="op">(</span>sp <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> pc <span class="op">+</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb881-27"><a href="#cb881-27" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> Op<span class="op">.</span>Mul <span class="op">=&gt;</span></span>
<span id="cb881-28"><a href="#cb881-28" aria-hidden="true" tabindex="-1"></a>            <span class="kw">val</span> a <span class="op">=</span> <span class="fu">stack</span><span class="op">(</span>sp <span class="op">-</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb881-29"><a href="#cb881-29" aria-hidden="true" tabindex="-1"></a>            <span class="kw">val</span> b <span class="op">=</span> <span class="fu">stack</span><span class="op">(</span>sp <span class="op">-</span> <span class="dv">2</span><span class="op">)</span></span>
<span id="cb881-30"><a href="#cb881-30" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stack</span><span class="op">(</span>sp <span class="op">-</span> <span class="dv">2</span><span class="op">)</span> <span class="op">=</span> <span class="op">(</span>a <span class="op">*</span> b<span class="op">)</span></span>
<span id="cb881-31"><a href="#cb881-31" aria-hidden="true" tabindex="-1"></a>            <span class="fu">loop</span><span class="op">(</span>sp <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> pc <span class="op">+</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb881-32"><a href="#cb881-32" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> Op<span class="op">.</span>Div <span class="op">=&gt;</span></span>
<span id="cb881-33"><a href="#cb881-33" aria-hidden="true" tabindex="-1"></a>            <span class="kw">val</span> a <span class="op">=</span> <span class="fu">stack</span><span class="op">(</span>sp <span class="op">-</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb881-34"><a href="#cb881-34" aria-hidden="true" tabindex="-1"></a>            <span class="kw">val</span> b <span class="op">=</span> <span class="fu">stack</span><span class="op">(</span>sp <span class="op">-</span> <span class="dv">2</span><span class="op">)</span></span>
<span id="cb881-35"><a href="#cb881-35" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stack</span><span class="op">(</span>sp <span class="op">-</span> <span class="dv">2</span><span class="op">)</span> <span class="op">=</span> <span class="op">(</span>a <span class="op">/</span> b<span class="op">)</span></span>
<span id="cb881-36"><a href="#cb881-36" aria-hidden="true" tabindex="-1"></a>            <span class="fu">loop</span><span class="op">(</span>sp <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> pc <span class="op">+</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb881-37"><a href="#cb881-37" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb881-38"><a href="#cb881-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb881-39"><a href="#cb881-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">loop</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb881-40"><a href="#cb881-40" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb881-41"><a href="#cb881-41" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <h3 data-number="14.4.2" id="further-optimization"><span class="header-section-number">14.4.2</span> Further
    Optimization</h3>
    <p>The above optimization is, to me, the most obvious and
    straightforward to implement. In this section we’ll attempt to go
    further, by looking at some of the optimizations described in the
    literature. We’ll see that there is not always a straight path to
    faster code.</p>
    <p>The benchmark I used is the simple recursive Fibonacci.
    Calculating the <span class="math inline"><em>n</em><sup><em>t</em><em>h</em></sup></span>
    Fibonacci number produces a large expression for a modest choice of
    <span class="math inline"><em>n</em></span>. I used a value of 25,
    and the expression has over one million elements. Notably the
    expressions only involve addition, and the only literals in use are
    zero and one. This limits the applicability of the optimizations to
    a wider range of inputs, but the intention is not to produce an
    optimized interpreter for this specific case but rather to discuss
    possible optimizations and issues that arise when attempting to
    optimize an interpreter in general.</p>
    <p>We’ll look at four different optimizations, which all use the
    optimized stack machine above as their base:</p>
    <ul>
    <li><p><strong>Algebraic simplification</strong> performs
    simplifications at compile-time to produce smaller expressions. A
    small expression should require fewer interpreter steps and hence be
    faster. The only simplification I used was replacing <span class="math inline"><em>x</em> + 0</span> or <span class="math inline">0 + <em>x</em></span> with <span class="math inline"><em>x</em></span>. This occurs frequently in the
    Fibonacci series. Since the expressions we are working with have no
    variables or control flow we could simplify the entire expression to
    a single literal at compile-time. This would be an extremely good
    optimization but rather defeats the purpose of trying to generalize
    to other applications.</p></li>
    <li><p><strong>Byte code</strong> replaces the <code>Op</code>
    algebraic data type with a single byte. The hope here is that the
    smaller representation will lead to better cache utilization, and
    possibly a faster <code>match</code> expression, and therefore a
    faster overall interpreter. In this representation literals are also
    stored in a separate array of <code>Doubles</code>. More on this
    later.</p></li>
    <li><p><strong>Stack caching</strong> stores the top of the stack in
    a variable, which we hope will be allocated to a register and
    therefore be extremely fast to access. The remainder of the stack is
    stored in an array as above. Stack caching involves more work when
    pushing values on to the stack, as we must copy the value from the
    top into the array, but less work when popping values off the stack.
    The hope is that the savings will outweigh the costs.</p></li>
    <li><p><strong>Superinstructions</strong> replace common sequences
    of instructions with a single instruction. We already do this to an
    extent; a typical stack machine would have separate instructions for
    pushing and popping, but our instruction set merges these into the
    arithmetic operations. I used two superinstructions: one for
    incrementing a value, which frequently occurs in the Fibonacci, and
    one for adding two values from the stack and a literal.</p></li>
    </ul>
    <p>Below are the benchmarks results obtained on an AMD Ryzen 5 3600
    and an Apple M1, both running JDK 21. Results are shown in
    operations per second. The Baseline interpreter is the one using
    structural recursion. The Stack interpreter uses a <code>List</code>
    to represent the stack and program. The Optimized Stack represents
    the stack and program as arrays. The other interpreters build on the
    Optimized Stack interpreter and add the optimizations described
    above. The All interpreter has all the optimizations.</p>
    <div class="table-responsive">
    <table style="width:93%;">
    <colgroup>
    <col style="width: 37%" />
    <col style="width: 13%" />
    <col style="width: 13%" />
    <col style="width: 13%" />
    <col style="width: 13%" />
    </colgroup>
    <thead>
    <tr class="header">
    <th>Interpreter</th>
    <th>Ryzen 5</th>
    <th>Speedup</th>
    <th>M1</th>
    <th>Speedup</th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td>Baseline</td>
    <td>2754.43</td>
    <td>1</td>
    <td>3932.93</td>
    <td>1</td>
    </tr>
    <tr class="even">
    <td>Stack</td>
    <td>676.43</td>
    <td>0.25</td>
    <td>1004.16</td>
    <td>0.26</td>
    </tr>
    <tr class="odd">
    <td>Optimized Stack</td>
    <td>3631.19</td>
    <td>1.32</td>
    <td>2953.21</td>
    <td>0.75</td>
    </tr>
    <tr class="even">
    <td>Algebraic Simplification</td>
    <td>1630.93</td>
    <td>0.59</td>
    <td>4818.45</td>
    <td>1.23</td>
    </tr>
    <tr class="odd">
    <td>Byte Code</td>
    <td>4057.11</td>
    <td>1.47</td>
    <td>3355.75</td>
    <td>0.85</td>
    </tr>
    <tr class="even">
    <td>Stack Caching</td>
    <td>3698.10</td>
    <td>1.34</td>
    <td>3237.17</td>
    <td>0.82</td>
    </tr>
    <tr class="odd">
    <td>Superinstructions</td>
    <td>3706.10</td>
    <td>1.35</td>
    <td>4689.02</td>
    <td>1.19</td>
    </tr>
    <tr class="even">
    <td>All</td>
    <td>7612.45</td>
    <td>2.76</td>
    <td>7098.06</td>
    <td>1.80</td>
    </tr>
    </tbody>
    </table>
    </div>
    <p>There are a few lessons to take from this. The most important, in
    my opinion, is that <em>performance is not compositional</em>. The
    results of applying two optimizations is not simply the sum of
    applying the optimizations individually. You can see that most of
    the optimizations on their own make little or no change to
    performance relative to the Optimized Stack interpreter. Taken
    together, however, they make a significant improvement.</p>
    <p>Basic structural recursion, the Baseline interpreter, is
    surprisingly fast; a bit slower than the Optimized Stack interpreter
    on the Ryzen 5 but faster on the M1. A stack machine emulates the
    processor’s built-in call stack. The native call stack is extremely
    fast, so we need a good reason to avoid using it.</p>
    <p>Details really matter in optimization. We see the choice of data
    structure makes a massive difference between the Stack and Optimized
    Stack interpreters. An earlier version of the Byte Code interpreter
    had worse performance than the Optimized Stack. As best I could tell
    this was because I was storing literals alongside byte code, and
    loading a <code>Double</code> from an <code>Array[Byte]</code>
    (using a <code>ByteBuffer</code>) was slow. Superinstructions are
    very dependent on the chosen superinstructions. The superinstruction
    to add two values from the stack plus a literal had little effect on
    it’s own; in fact the interpreter with this single superinstruction
    was much slower on the Ryzen 5.</p>
    <p>Compilers, and JIT compilers in particular, are difficult to
    understand. I cannot explain why, for example, the Algebraic
    Simplification interpreter is so slow on the Ryzen 5. This
    interpreter does strictly less work than the Optimized Stack
    interpreter. Just like the interpreter optimizations I implemented,
    compiler optimizations apply in restricted cases that the algorithms
    recognize. If code does not match the patterns the algorithms look
    for, the optimizations will not apply, which can lead to strange
    performance cliffs. My best guess is that something about my
    implementation caused me to run afoul of such an issue.</p>
    <p>Finally, differences between platforms are also significant. It’s
    hard to know how much this due to differences in the computer’s
    architecture, and how much is down to differences in the JVM. Either
    way, be aware of which platform or platforms you expect the majority
    of users to run on, and don’t naively assume performance on one
    platform will directly translate to another.</p>
    <h2 data-number="14.5" id="conclusions-5"><span class="header-section-number">14.5</span> Conclusions</h2>
    <p>In this chapter we explored two main techniques for optimizing
    interpeters: algebraic simplification of programs, and
    interpretation in a virtual machine.</p>
    <p>Our regular expression derivative algorithm is taken from <a href="https://www.khoury.northeastern.edu/home/turon/re-deriv.pdf">Regular-expression
    derivatives reexamined</a>. What we didn’t explore, but we should if
    we really care about performance, is compiling regular expressions
    to a finite state machine, another kind of virtual machine. Regular
    expression derivatives are very easy to implement and nicely
    illustrate the point of algebraic simplification. However we have to
    recompute the derivative on each input character. If we instead
    compile the regular expression to a finite state machine ahead of
    time, we save time when parsing input. The details of this algorithm
    are in the paper.</p>
    <p>This work is based on <a href="https://dl.acm.org/doi/pdf/10.1145/321239.321249">Derivatives
    of Regular Expressions</a>. Derivatives of Regular Expressions was
    published in 1964. Although the style of the paper will be
    immediately recognizable to anyone familiar with the more
    theoretical end of computer science, anachronisms like “State
    Diagram Construction” are a reminder that this work comes from the
    very beginnings of the discipline. Regular expression derivatives
    can be extended to context-free grammars and therefore used to
    implement parsers. This is explored in <a href="https://matt.might.net/papers/might2011derivatives.pdf">Parsing
    with Derivatives</a>.</p>
    <p>A lot of work has looked at systematically transforming an
    interpreter into a compiler and virtual machine. <a href="https://www.brics.dk/RS/03/14/BRICS-RS-03-14.pdf">From
    Interpreter to Compiler and Virtual Machine: A Functional
    Derivation</a> is an earlier example. <a href="https://www.cambridge.org/core/journals/journal-of-functional-programming/article/calculating-correct-compilers/70AA17724EBCA4182B1B2B522362A9AF">Calculating
    Correct Compilers</a> is more recent, and follow-up papers extend
    the technique in a number of directions.</p>
    <p>Interpreter and their optimization is an enormous area of work.
    It also one I find very interesting, so I’ve been a bit more through
    in collecting references for this section.</p>
    <p>We looked at four techniques for optimization: algebraic
    simplification, byte code, stack caching, and superinstructions.
    Algebraic simplification is as old as algebra, and something
    familiar to any secondary school student. In the world of compilers,
    different aspects of algebraic simplification are known as constant
    folding, constant propagation, and common subexpression elimination.
    Byte code is probably as old as interpreters, and dates back to at
    least the 1960s in the form of <a href="https://en.wikipedia.org/wiki/P-code_machine">p-code</a>. <a href="https://dl.acm.org/doi/pdf/10.1145/207110.207165">Stack
    Caching for Interpreters</a> introduces the idea of stack caching,
    and shows some rather more complex realizations than the simple
    system I used. Superinstructions were introduced in <a href="https://dl.acm.org/doi/abs/10.1145/199448.199526">Optimizing
    an ANSI C interpreter with superoperators</a>. <a href="https://core.ac.uk/download/pdf/297029962.pdf">Towards
    Superinstructions for Java Interpreters</a> is a nice example of
    applying superinstructions to a interpreted JVM.</p>
    <p>Let’s now talk about instruction dispatch, which is area we did
    not consider for optimization. Instruction dispatch is the process
    by which the interpreter chooses the code to run for a given
    interpreter instruction. <a href="https://jilp.org/vol5/v5paper12.pdf">The Structure and
    Performance of Efficient Interpreters</a> argues that instruction
    dispatch makes up a major portion of an interpreter’s execution
    time. The approach we used is generally called switch dispatch in
    the literature. There are several alternative approaches. Direct
    threaded dispatch is described in <a href="https://dl.acm.org/doi/pdf/10.1145/362248.362270">Threaded
    Code</a>. Direct threading represents an instruction by the function
    that implements it. This requires first-class functions and full
    tail calls. It is generally considered the fastest form of dispatch.
    Notice that it relies on the duality between data and functions.
    Subroutine threading is like direct threading, but uses normal calls
    and returns instead of tail calls. In indirect threaded code
    (described in <a href="http://figforth.org.uk/library/Indirect.Threaded.Code.p330-dewar.pdf">Indirect
    Threaded Code</a>), each bytecode is the index into a lookup table
    that points to the implementing function.</p>
    <p>Stack machines are not the only virtual machine used for
    implementing interpreters. Register machines are the most common
    alternative. The Lua virtual machine, for example, is a register
    machine. <a href="https://dl.acm.org/doi/pdf/10.1145/1328195.1328197">Virtual
    Machine Showdown: Stack Versus Registers</a> compares the two and
    concludes that register machines are faster. However they are more
    complex to implement.</p>
    <p>If you’re interested in the design considerations in a general
    purpose stack based instruction set, <a href="https://dl.acm.org/doi/pdf/10.1145/3062341.3062363">Bringing
    the Web up to Speed with WebAssembly</a> is the paper for you. It
    covers the design of WebAssembly, and the rationale behind the
    design choices. An interpreter for WebAssembly is described in <a href="https://dl.acm.org/doi/pdf/10.1145/3563311">A Fast In-Place
    Interpreter for WebAssembly</a>. Notice how often tail calls arise
    in the discussion!</p>
    <h1 data-number="15" id="sec:usability"><span class="header-section-number">15</span> Creating Usable Code</h1>
    <p>APIs are interfaces and should be designed as such.</p>
    <p><code>scala.annotation.implicitNotFound</code> and
    <code>scala.annotation.implicitAmbiguous</code></p>
    <h1 data-number="16" id="sec:case-studies:testing"><span class="header-section-number">16</span> Case Study: Testing
    Asynchronous Code</h1>
    <p>We’ll start with a straightforward case study: how to simplify
    unit tests for asynchronous code by making them synchronous.</p>
    <p>Let’s return to the example from Chapter 12 where we’re measuring
    the uptime on a set of servers. We’ll flesh out the code into a more
    complete structure. There will be two components. The first is an
    <code>UptimeClient</code> that polls remote servers for their
    uptime:</p>
    <div class="sourceCode" id="cb882"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb882-1"><a href="#cb882-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span><span class="ex">Future</span></span>
<span id="cb882-2"><a href="#cb882-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb882-3"><a href="#cb882-3" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> UptimeClient <span class="op">{</span></span>
<span id="cb882-4"><a href="#cb882-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">getUptime</span><span class="op">(</span>hostname<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Future</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span></span>
<span id="cb882-5"><a href="#cb882-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>We’ll also have an <code>UptimeService</code> that maintains a
    list of servers and allows the user to poll them for their total
    uptime:</p>
    <div class="sourceCode" id="cb883"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb883-1"><a href="#cb883-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>future<span class="op">.</span>_ <span class="co">// for Applicative</span></span>
<span id="cb883-2"><a href="#cb883-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>list<span class="op">.</span>_   <span class="co">// for Traverse</span></span>
<span id="cb883-3"><a href="#cb883-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>traverse<span class="op">.</span>_  <span class="co">// for traverse</span></span>
<span id="cb883-4"><a href="#cb883-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span>ExecutionContext<span class="op">.</span>Implicits<span class="op">.</span>global</span>
<span id="cb883-5"><a href="#cb883-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb883-6"><a href="#cb883-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="fu">UptimeService</span><span class="op">(</span>client<span class="op">:</span> UptimeClient<span class="op">)</span> <span class="op">{</span></span>
<span id="cb883-7"><a href="#cb883-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">getTotalUptime</span><span class="op">(</span>hostnames<span class="op">:</span> <span class="ex">List</span><span class="op">[</span><span class="ex">String</span><span class="op">]):</span> <span class="ex">Future</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb883-8"><a href="#cb883-8" aria-hidden="true" tabindex="-1"></a>    hostnames<span class="op">.</span><span class="fu">traverse</span><span class="op">(</span>client<span class="op">.</span>getUptime<span class="op">).</span><span class="fu">map</span><span class="op">(</span>_<span class="op">.</span>sum<span class="op">)</span></span>
<span id="cb883-9"><a href="#cb883-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>We’ve modelled <code>UptimeClient</code> as a trait because we’re
    going to want to stub it out in unit tests. For example, we can
    write a test client that allows us to provide dummy data rather than
    calling out to actual servers:</p>
    <div class="sourceCode" id="cb884"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb884-1"><a href="#cb884-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="fu">TestUptimeClient</span><span class="op">(</span>hosts<span class="op">:</span> <span class="ex">Map</span><span class="op">[</span><span class="ex">String</span><span class="op">,</span> <span class="bu">Int</span><span class="op">])</span> <span class="kw">extends</span> UptimeClient <span class="op">{</span></span>
<span id="cb884-2"><a href="#cb884-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">getUptime</span><span class="op">(</span>hostname<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Future</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb884-3"><a href="#cb884-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Future</span><span class="op">.</span><span class="fu">successful</span><span class="op">(</span>hosts<span class="op">.</span><span class="fu">getOrElse</span><span class="op">(</span>hostname<span class="op">,</span> <span class="dv">0</span><span class="op">))</span></span>
<span id="cb884-4"><a href="#cb884-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Now, suppose we’re writing unit tests for
    <code>UptimeService</code>. We want to test its ability to sum
    values, regardless of where it is getting them from. Here’s an
    example:</p>
    <div class="sourceCode" id="cb885"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb885-1"><a href="#cb885-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">testTotalUptime</span><span class="op">()</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb885-2"><a href="#cb885-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> hosts    <span class="op">=</span> <span class="ex">Map</span><span class="op">(</span><span class="st">&quot;host1&quot;</span> <span class="op">-&gt;</span> <span class="dv">10</span><span class="op">,</span> <span class="st">&quot;host2&quot;</span> <span class="op">-&gt;</span> <span class="dv">6</span><span class="op">)</span></span>
<span id="cb885-3"><a href="#cb885-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> client   <span class="op">=</span> <span class="kw">new</span> <span class="fu">TestUptimeClient</span><span class="op">(</span>hosts<span class="op">)</span></span>
<span id="cb885-4"><a href="#cb885-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> service  <span class="op">=</span> <span class="kw">new</span> <span class="fu">UptimeService</span><span class="op">(</span>client<span class="op">)</span></span>
<span id="cb885-5"><a href="#cb885-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> actual   <span class="op">=</span> service<span class="op">.</span><span class="fu">getTotalUptime</span><span class="op">(</span>hosts<span class="op">.</span>keys<span class="op">.</span>toList<span class="op">)</span></span>
<span id="cb885-6"><a href="#cb885-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> expected <span class="op">=</span> hosts<span class="op">.</span>values<span class="op">.</span>sum</span>
<span id="cb885-7"><a href="#cb885-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">assert</span><span class="op">(</span>actual <span class="op">==</span> expected<span class="op">)</span></span>
<span id="cb885-8"><a href="#cb885-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb885-9"><a href="#cb885-9" aria-hidden="true" tabindex="-1"></a><span class="co">// error:</span></span>
<span id="cb885-10"><a href="#cb885-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Values of types scala.concurrent.Future[Int] and Int cannot be compared with == or !=</span></span>
<span id="cb885-11"><a href="#cb885-11" aria-hidden="true" tabindex="-1"></a><span class="co">//   assert(actual == expected)</span></span>
<span id="cb885-12"><a href="#cb885-12" aria-hidden="true" tabindex="-1"></a><span class="co">//          ^^^^^^^^^^^^^^^^^^</span></span></code></pre></div>
    <p>The code doesn’t compile because we’ve made a classic error<a href="#fn15" class="footnote-ref" id="fnref15" role="doc-noteref"><sup>15</sup></a>. We forgot that our application
    code is asynchronous. Our <code>actual</code> result is of type
    <code>Future[Int]</code> and our <code>expected</code> result is of
    type <code>Int</code>. We can’t compare them directly!</p>
    <p>There are a couple of ways to solve this problem. We could alter
    our test code to accommodate the asynchronousness. However, there is
    another alternative. Let’s make our service code synchronous so our
    test works without modification!</p>
    <h2 data-number="16.1" id="abstracting-over-type-constructors"><span class="header-section-number">16.1</span> Abstracting over Type
    Constructors</h2>
    <p>We need to implement two versions of <code>UptimeClient</code>:
    an asynchronous one for use in production and a synchronous one for
    use in our unit tests:</p>
    <div class="sourceCode" id="cb886"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb886-1"><a href="#cb886-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> RealUptimeClient <span class="kw">extends</span> UptimeClient <span class="op">{</span></span>
<span id="cb886-2"><a href="#cb886-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">getUptime</span><span class="op">(</span>hostname<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Future</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span></span>
<span id="cb886-3"><a href="#cb886-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb886-4"><a href="#cb886-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb886-5"><a href="#cb886-5" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> TestUptimeClient <span class="kw">extends</span> UptimeClient <span class="op">{</span></span>
<span id="cb886-6"><a href="#cb886-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">getUptime</span><span class="op">(</span>hostname<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="bu">Int</span></span>
<span id="cb886-7"><a href="#cb886-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>The question is: what result type should we give to the abstract
    method in <code>UptimeClient</code>? We need to abstract over
    <code>Future[Int]</code> and <code>Int</code>:</p>
    <div class="sourceCode" id="cb887"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb887-1"><a href="#cb887-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> UptimeClient <span class="op">{</span></span>
<span id="cb887-2"><a href="#cb887-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">getUptime</span><span class="op">(</span>hostname<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="op">???</span></span>
<span id="cb887-3"><a href="#cb887-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>At first this may seem difficult. We want to retain the
    <code>Int</code> part from each type but “throw away” the
    <code>Future</code> part in the test code. Fortunately, Cats
    provides a solution in terms of the <em>identity type</em>,
    <code>Id</code>, that we discussed way back in Section 9.3.
    <code>Id</code> allows us to “wrap” types in a type constructor
    without changing their meaning:</p>
    <div class="sourceCode" id="cb888"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb888-1"><a href="#cb888-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> cats</span>
<span id="cb888-2"><a href="#cb888-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb888-3"><a href="#cb888-3" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Id<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> A</span></code></pre></div>
    <p><code>Id</code> allows us to abstract over the return types in
    <code>UptimeClient</code>. Implement this now:</p>
    <ul>
    <li><p>write a trait definition for <code>UptimeClient</code> that
    accepts a type constructor <code>F[_]</code> as a
    parameter;</p></li>
    <li><p>extend it with two traits, <code>RealUptimeClient</code> and
    <code>TestUptimeClient</code>, that bind <code>F</code> to
    <code>Future</code> and <code>Id</code> respectively;</p></li>
    <li><p>write out the method signature for <code>getUptime</code> in
    each case to verify that it compiles.</p></li>
    </ul>
    <div class="solution">
    <p>Here’s the implementation:</p>
    <div class="sourceCode" id="cb889"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb889-1"><a href="#cb889-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Id</span>
<span id="cb889-2"><a href="#cb889-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb889-3"><a href="#cb889-3" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> UptimeClient<span class="op">[</span>F<span class="op">[</span>_<span class="op">]]</span> <span class="op">{</span></span>
<span id="cb889-4"><a href="#cb889-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">getUptime</span><span class="op">(</span>hostname<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> F<span class="op">[</span><span class="bu">Int</span><span class="op">]</span></span>
<span id="cb889-5"><a href="#cb889-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb889-6"><a href="#cb889-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb889-7"><a href="#cb889-7" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> RealUptimeClient <span class="kw">extends</span> UptimeClient<span class="op">[</span><span class="ex">Future</span><span class="op">]</span> <span class="op">{</span></span>
<span id="cb889-8"><a href="#cb889-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">getUptime</span><span class="op">(</span>hostname<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Future</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span></span>
<span id="cb889-9"><a href="#cb889-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb889-10"><a href="#cb889-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb889-11"><a href="#cb889-11" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> TestUptimeClient <span class="kw">extends</span> UptimeClient<span class="op">[</span>Id<span class="op">]</span> <span class="op">{</span></span>
<span id="cb889-12"><a href="#cb889-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">getUptime</span><span class="op">(</span>hostname<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> Id<span class="op">[</span><span class="bu">Int</span><span class="op">]</span></span>
<span id="cb889-13"><a href="#cb889-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Note that, because <code>Id[A]</code> is just a simple alias for
    <code>A</code>, we don’t need to refer to the type in
    <code>TestUptimeClient</code> as <code>Id[Int]</code>—we can simply
    write <code>Int</code> instead:</p>
    <div class="sourceCode" id="cb890"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb890-1"><a href="#cb890-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> TestUptimeClient <span class="kw">extends</span> UptimeClient<span class="op">[</span>Id<span class="op">]</span> <span class="op">{</span></span>
<span id="cb890-2"><a href="#cb890-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">getUptime</span><span class="op">(</span>hostname<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="bu">Int</span></span>
<span id="cb890-3"><a href="#cb890-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Of course, technically speaking we don’t need to redeclare
    <code>getUptime</code> in <code>RealUptimeClient</code> or
    <code>TestUptimeClient</code>. However, writing everything out helps
    illustrate the technique.</p>
    </div>
    <p>You should now be able to flesh your definition of
    <code>TestUptimeClient</code> out into a full class based on a
    <code>Map[String, Int]</code> as before.</p>
    <div class="solution">
    <p>The final code is similar to our original implementation of
    <code>TestUptimeClient</code>, except we no longer need the call to
    <code>Future.successful</code>:</p>
    <div class="sourceCode" id="cb891"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb891-1"><a href="#cb891-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="fu">TestUptimeClient</span><span class="op">(</span>hosts<span class="op">:</span> <span class="ex">Map</span><span class="op">[</span><span class="ex">String</span><span class="op">,</span> <span class="bu">Int</span><span class="op">])</span></span>
<span id="cb891-2"><a href="#cb891-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">extends</span> UptimeClient<span class="op">[</span>Id<span class="op">]</span> <span class="op">{</span></span>
<span id="cb891-3"><a href="#cb891-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">getUptime</span><span class="op">(</span>hostname<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="bu">Int</span> <span class="op">=</span></span>
<span id="cb891-4"><a href="#cb891-4" aria-hidden="true" tabindex="-1"></a>    hosts<span class="op">.</span><span class="fu">getOrElse</span><span class="op">(</span>hostname<span class="op">,</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb891-5"><a href="#cb891-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    </div>
    <h2 data-number="16.2" id="abstracting-over-monads"><span class="header-section-number">16.2</span> Abstracting over
    Monads</h2>
    <p>Let’s turn our attention to <code>UptimeService</code>. We need
    to rewrite it to abstract over the two types of
    <code>UptimeClient</code>. We’ll do this in two stages: first we’ll
    rewrite the class and method signatures, then the method bodies.
    Starting with the method signatures:</p>
    <ul>
    <li><p>comment out the body of <code>getTotalUptime</code> (replace
    it with <code>???</code> to make everything compile);</p></li>
    <li><p>add a type parameter <code>F[_]</code> to
    <code>UptimeService</code> and pass it on to
    <code>UptimeClient</code>.</p></li>
    </ul>
    <div class="solution">
    <p>The code should look like this:</p>
    <div class="sourceCode" id="cb892"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb892-1"><a href="#cb892-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UptimeService<span class="op">[</span>F<span class="op">[</span>_<span class="op">]](</span>client<span class="op">:</span> UptimeClient<span class="op">[</span>F<span class="op">])</span> <span class="op">{</span></span>
<span id="cb892-2"><a href="#cb892-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">getTotalUptime</span><span class="op">(</span>hostnames<span class="op">:</span> <span class="ex">List</span><span class="op">[</span><span class="ex">String</span><span class="op">]):</span> F<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb892-3"><a href="#cb892-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb892-4"><a href="#cb892-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// hostnames.traverse(client.getUptime).map(_.sum)</span></span>
<span id="cb892-5"><a href="#cb892-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    </div>
    <p>Now uncomment the body of <code>getTotalUptime</code>. You should
    get a compilation error similar to the following:</p>
    <div class="sourceCode" id="cb893"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb893-1"><a href="#cb893-1" aria-hidden="true" tabindex="-1"></a><span class="co">// &lt;console&gt;:28: error: could not find implicit value for</span></span>
<span id="cb893-2"><a href="#cb893-2" aria-hidden="true" tabindex="-1"></a><span class="co">//               evidence parameter of type cats.Applicative[F]</span></span>
<span id="cb893-3"><a href="#cb893-3" aria-hidden="true" tabindex="-1"></a><span class="co">//            hostnames.traverse(client.getUptime).map(_.sum)</span></span>
<span id="cb893-4"><a href="#cb893-4" aria-hidden="true" tabindex="-1"></a><span class="co">//                              ^</span></span></code></pre></div>
    <p>The problem here is that <code>traverse</code> only works on
    sequences of values that have an <code>Applicative</code>. In our
    original code we were traversing a <code>List[Future[Int]]</code>.
    There is an applicative for <code>Future</code> so that was fine. In
    this version we are traversing a <code>List[F[Int]]</code>. We need
    to <em>prove</em> to the compiler that <code>F</code> has an
    <code>Applicative</code>. Do this by adding an implicit constructor
    parameter to <code>UptimeService</code>.</p>
    <div class="solution">
    <p>We can write this as an implicit parameter:</p>
    <div class="sourceCode" id="cb894"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb894-1"><a href="#cb894-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Applicative</span>
<span id="cb894-2"><a href="#cb894-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>functor<span class="op">.</span>_ <span class="co">// for map</span></span>
<span id="cb894-3"><a href="#cb894-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb894-4"><a href="#cb894-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UptimeService<span class="op">[</span>F<span class="op">[</span>_<span class="op">]](</span>client<span class="op">:</span> UptimeClient<span class="op">[</span>F<span class="op">])</span></span>
<span id="cb894-5"><a href="#cb894-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span><span class="kw">implicit</span> a<span class="op">:</span> Applicative<span class="op">[</span>F<span class="op">])</span> <span class="op">{</span></span>
<span id="cb894-6"><a href="#cb894-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb894-7"><a href="#cb894-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">getTotalUptime</span><span class="op">(</span>hostnames<span class="op">:</span> <span class="ex">List</span><span class="op">[</span><span class="ex">String</span><span class="op">]):</span> F<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb894-8"><a href="#cb894-8" aria-hidden="true" tabindex="-1"></a>    hostnames<span class="op">.</span><span class="fu">traverse</span><span class="op">(</span>client<span class="op">.</span>getUptime<span class="op">).</span><span class="fu">map</span><span class="op">(</span>_<span class="op">.</span>sum<span class="op">)</span></span>
<span id="cb894-9"><a href="#cb894-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>or more tersely as a context bound:</p>
    <div class="sourceCode" id="cb895"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb895-1"><a href="#cb895-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UptimeService<span class="op">[</span>F<span class="op">[</span>_<span class="op">]:</span> Applicative<span class="op">]</span></span>
<span id="cb895-2"><a href="#cb895-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span>client<span class="op">:</span> UptimeClient<span class="op">[</span>F<span class="op">])</span> <span class="op">{</span></span>
<span id="cb895-3"><a href="#cb895-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb895-4"><a href="#cb895-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">getTotalUptime</span><span class="op">(</span>hostnames<span class="op">:</span> <span class="ex">List</span><span class="op">[</span><span class="ex">String</span><span class="op">]):</span> F<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb895-5"><a href="#cb895-5" aria-hidden="true" tabindex="-1"></a>    hostnames<span class="op">.</span><span class="fu">traverse</span><span class="op">(</span>client<span class="op">.</span>getUptime<span class="op">).</span><span class="fu">map</span><span class="op">(</span>_<span class="op">.</span>sum<span class="op">)</span></span>
<span id="cb895-6"><a href="#cb895-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Note that we need to import <code>cats.syntax.functor</code> as
    well as <code>cats.Applicative</code>. This is because we’re
    switching from using <code>future.map</code> to the Cats’ generic
    extension method that requires an implicit <code>Functor</code>
    parameter.</p>
    </div>
    <p>Finally, let’s turn our attention to our unit tests. Our test
    code now works as intended without any modification. We create an
    instance of <code>TestUptimeClient</code> and wrap it in an
    <code>UptimeService</code>. This effectively binds <code>F</code> to
    <code>Id</code>, allowing the rest of the code to operate
    synchronously without worrying about monads or applicatives:</p>
    <div class="sourceCode" id="cb896"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb896-1"><a href="#cb896-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">testTotalUptime</span><span class="op">()</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb896-2"><a href="#cb896-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> hosts    <span class="op">=</span> <span class="ex">Map</span><span class="op">(</span><span class="st">&quot;host1&quot;</span> <span class="op">-&gt;</span> <span class="dv">10</span><span class="op">,</span> <span class="st">&quot;host2&quot;</span> <span class="op">-&gt;</span> <span class="dv">6</span><span class="op">)</span></span>
<span id="cb896-3"><a href="#cb896-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> client   <span class="op">=</span> <span class="kw">new</span> <span class="fu">TestUptimeClient</span><span class="op">(</span>hosts<span class="op">)</span></span>
<span id="cb896-4"><a href="#cb896-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> service  <span class="op">=</span> <span class="kw">new</span> <span class="fu">UptimeService</span><span class="op">(</span>client<span class="op">)</span></span>
<span id="cb896-5"><a href="#cb896-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> actual   <span class="op">=</span> service<span class="op">.</span><span class="fu">getTotalUptime</span><span class="op">(</span>hosts<span class="op">.</span>keys<span class="op">.</span>toList<span class="op">)</span></span>
<span id="cb896-6"><a href="#cb896-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> expected <span class="op">=</span> hosts<span class="op">.</span>values<span class="op">.</span>sum</span>
<span id="cb896-7"><a href="#cb896-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">assert</span><span class="op">(</span>actual <span class="op">==</span> expected<span class="op">)</span></span>
<span id="cb896-8"><a href="#cb896-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb896-9"><a href="#cb896-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb896-10"><a href="#cb896-10" aria-hidden="true" tabindex="-1"></a><span class="fu">testTotalUptime</span><span class="op">()</span></span></code></pre></div>
    <h2 data-number="16.3" id="summary-6"><span class="header-section-number">16.3</span> Summary</h2>
    <p>This case study provides an example of how Cats can help us
    abstract over different computational scenarios. We used the
    <code>Applicative</code> type class to abstract over asynchronous
    and synchronous code. Leaning on a functional abstraction allows us
    to specify the sequence of computations we want to perform without
    worrying about the details of the implementation.</p>
    <p>Back in Figure 10, we showed a “stack” of computational type
    classes that are meant for exactly this kind of abstraction. Type
    classes like <code>Functor</code>, <code>Applicative</code>,
    <code>Monad</code>, and <code>Traverse</code> provide abstract
    implementations of patterns such as mapping, zipping, sequencing,
    and iteration. The mathematical laws on those types ensure that they
    work together with a consistent set of semantics.</p>
    <p>We used <code>Applicative</code> in this case study because it
    was the least powerful type class that did what we needed. If we had
    required <code>flatMap</code>, we could have swapped out
    <code>Applicative</code> for <code>Monad</code>. If we had needed to
    abstract over different sequence types, we could have used
    <code>Traverse</code>. There are also type classes like
    <code>ApplicativeError</code> and <code>MonadError</code> that help
    model failures as well as successful computations.</p>
    <p>Let’s move on now to a more complex case study where type classes
    will help us produce something more interesting: a map-reduce-style
    framework for parallel processing.</p>
    <h1 data-number="17" id="sec:map-reduce"><span class="header-section-number">17</span> Case Study: Map-Reduce</h1>
    <!--
    TODO:

    - DONE - talk about map-reduce - it's just foldMap
    - DONE - introduce/reimplement foldMap
    - DONE - implement parallelFoldMap to mimic map-reduce
      - DONE - mention that we're specifically imitating multi-machine
               map-reduce where we need to split data between machines
               in large blocks
      - DONE - implement in terms of our foldMap first
      - DONE - then implement in terms of Cats' foldMap
      - DONE - talk about traverse
    - summary
      - DONE - real-world map-reduce has communication costs
      - DONE - multi-cpu map-reduce doesn't have communication costs
      - DONE - parallelFoldMap mimics multi-machine
      - DONE - our final version of parallelFoldMap (based on traverse) is far simpler
      - talk about substitution and the things it doesn't model:
        - performance
        - parallelism
        - side-effects (future starts immediately)
        - etc...

    TODO:

    - DONE - drop the current foldMapM stuff
    - DONE - maybe move it elsewhere
    -->
    <p>In this case study we’re going to implement a simple-but-powerful
    parallel processing framework using <code>Monoids</code>,
    <code>Functors</code>, and a host of other goodies.</p>
    <p>If you have used Hadoop or otherwise worked in “big data” you
    will have heard of <a href="http://research.google.com/archive/map-reduce.html">MapReduce</a>,
    which is a programming model for doing parallel data processing
    across clusters of machines (aka “nodes”). As the name suggests, the
    model is built around a <em>map</em> phase, which is the same
    <code>map</code> function we know from Scala and the
    <code>Functor</code> type class, and a <em>reduce</em> phase, which
    we usually call <code>fold</code><a href="#fn16" class="footnote-ref" id="fnref16" role="doc-noteref"><sup>16</sup></a> in Scala.</p>
    <h2 data-number="17.1" id="parallelizing-map-and-fold"><span class="header-section-number">17.1</span> Parallelizing <em>map</em>
    and <em>fold</em></h2>
    <p>Recall the general signature for <code>map</code> is to apply a
    function <code>A =&gt; B</code> to a <code>F[A]</code>, returning a
    <code>F[B]</code>:</p>
    <figure id="fig:map-reduce:functor-type-chart">
    <svg id="svg_01158ee086aeec73f7ad" alt="Type chart: functor map" width="1567px" height="360px" viewBox="0 0 1567 360">
    <!-- Generator: Sketch 40 (33762) - http://www.bohemiancoding.com/sketch -->
    <title>generic-map</title>
    <desc>Created with Sketch.</desc>
    <defs>
        <ellipse id="svg_01158ee086aeec73f7ad_path-1" cx="80" cy="80" rx="80" ry="80"></ellipse>
        <mask id="svg_01158ee086aeec73f7ad_mask-2" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="160" height="160" fill="white">
            <use xlink:href="#svg_01158ee086aeec73f7ad_path-1" />
        </mask>
        <ellipse id="svg_01158ee086aeec73f7ad_path-3" cx="632" cy="140" rx="80" ry="80"></ellipse>
        <mask id="svg_01158ee086aeec73f7ad_mask-4" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="160" height="160" fill="white">
            <use xlink:href="#svg_01158ee086aeec73f7ad_path-3" />
        </mask>
        <polygon id="svg_01158ee086aeec73f7ad_path-5" points="945.595086 194 892.694414 221.811529 902.797543 162.905765 860 121.188471 919.14475 112.594235 945.595086 59 972.045423 112.594235 1031.19017 121.188471 988.39263 162.905765 998.495759 221.811529"></polygon>
        <mask id="svg_01158ee086aeec73f7ad_mask-6" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="171.190173" height="162.811529" fill="white">
            <use xlink:href="#svg_01158ee086aeec73f7ad_path-5" />
        </mask>
        <polygon id="svg_01158ee086aeec73f7ad_path-7" points="85.5950865 135 32.6944138 162.811529 42.7975432 103.905765 -1.17239551e-13 62.1884705 59.1447501 53.5942353 85.5950865 0 112.045423 53.5942353 171.190173 62.1884705 128.39263 103.905765 138.495759 162.811529"></polygon>
        <mask id="svg_01158ee086aeec73f7ad_mask-8" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="171.190173" height="162.811529" fill="white">
            <use xlink:href="#svg_01158ee086aeec73f7ad_path-7" />
        </mask>
        <polygon id="svg_01158ee086aeec73f7ad_path-9" points="754 120 794 120 794 100 834 139.497767 794 180 794 160 754 160"></polygon>
        <mask id="svg_01158ee086aeec73f7ad_mask-10" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="80" height="80" fill="white">
            <use xlink:href="#svg_01158ee086aeec73f7ad_path-9" />
        </mask>
        <rect id="svg_01158ee086aeec73f7ad_path-11" x="164" y="37" width="200" height="200" rx="8" />
        <mask id="svg_01158ee086aeec73f7ad_mask-12" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="200" height="200" fill="white">
            <use xlink:href="#svg_01158ee086aeec73f7ad_path-11" />
        </mask>
        <rect id="svg_01158ee086aeec73f7ad_path-13" x="1204" y="37" width="200" height="200" rx="8" />
        <mask id="svg_01158ee086aeec73f7ad_mask-14" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="200" height="200" fill="white">
            <use xlink:href="#svg_01158ee086aeec73f7ad_path-13" />
        </mask>
    </defs>
    <g id="svg_01158ee086aeec73f7ad_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_01158ee086aeec73f7ad_generic-map">
            <rect id="svg_01158ee086aeec73f7ad_Background" fill="#FFFFFF" x="0" y="0" width="1567" height="360" />
            <g id="svg_01158ee086aeec73f7ad_Group-2" transform="translate(184.000000, 57.000000)" stroke="#000000" stroke-width="8" fill="#FFFFFF">
                <use id="svg_01158ee086aeec73f7ad_Oval-1" mask="url(#mask-2)" xlink:href="#svg_01158ee086aeec73f7ad_path-1" />
            </g>
            <use id="svg_01158ee086aeec73f7ad_Oval-1" stroke="#000000" mask="url(#mask-4)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_01158ee086aeec73f7ad_path-3" />
            <use id="svg_01158ee086aeec73f7ad_Star-1" stroke="#000000" mask="url(#mask-6)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_01158ee086aeec73f7ad_path-5" />
            <g id="svg_01158ee086aeec73f7ad_Group" transform="translate(1220.000000, 57.000000)" stroke="#000000" stroke-width="8" fill="#FFFFFF">
                <use id="svg_01158ee086aeec73f7ad_Star-1" mask="url(#mask-8)" xlink:href="#svg_01158ee086aeec73f7ad_path-7" />
            </g>
            <use id="svg_01158ee086aeec73f7ad_Path-1" stroke="#000000" mask="url(#mask-10)" stroke-width="8" fill="#000000" xlink:href="#svg_01158ee086aeec73f7ad_path-9" />
            <polygon id="svg_01158ee086aeec73f7ad_Path-1" fill="#F6A623" points="1084 120 1124 120 1124 100 1164 139.497767 1124 180 1124 160 1084 160"></polygon>
            <text id="svg_01158ee086aeec73f7ad_F[A]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="213.6" y="314">F[A]</tspan>
            </text>
            <text id="svg_01158ee086aeec73f7ad_F[B]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="1257.6" y="314">F[B]</tspan>
            </text>
            <text id="svg_01158ee086aeec73f7ad_A-=&gt;-B" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="728.4" y="314">A =&gt; B</tspan>
            </text>
            <use id="svg_01158ee086aeec73f7ad_Rectangle-1" stroke="#000000" mask="url(#mask-12)" stroke-width="8" xlink:href="#svg_01158ee086aeec73f7ad_path-11" />
            <use id="svg_01158ee086aeec73f7ad_Rectangle-1" stroke="#000000" mask="url(#mask-14)" stroke-width="8" xlink:href="#svg_01158ee086aeec73f7ad_path-13" />
            <text id="svg_01158ee086aeec73f7ad_map" font-family="FiraMono-Bold, Fira Mono" font-size="64" font-weight="bold" fill="#F6A623">
                <tspan x="404.4" y="155">map</tspan>
            </text>
        </g>
    </g>
</svg>
    <figcaption>Figure 14: Type chart: functor map</figcaption>
    </figure>
    <p><code>map</code> transforms each individual element in a sequence
    independently. We can easily parallelize <code>map</code> because
    there are no dependencies between the transformations applied to
    different elements (the type signature of the function
    <code>A =&gt; B</code> shows us this, assuming we don’t use
    side-effects not reflected in the types).</p>
    <p>What about <code>fold</code>? We can implement this step with an
    instance of <code>Foldable</code>. Not every functor also has an
    instance of foldable but we can implement a map-reduce system on top
    of any data type that has both of these type classes. Our reduction
    step becomes a <code>foldLeft</code> over the results of the
    distributed <code>map</code>.</p>
    <figure id="fig:map-reduce:foldleft-type-chart">
    <svg id="svg_df4f94c24063f55d31a2" alt="Type chart: fold" width="2400px" height="360px" viewBox="0 0 2400 360">
    <!-- Generator: Sketch 41.2 (35397) - http://www.bohemiancoding.com/sketch -->
    <title>generic-foldleft</title>
    <desc>Created with Sketch.</desc>
    <defs>
        <ellipse id="svg_df4f94c24063f55d31a2_path-1" cx="1373" cy="140" rx="80" ry="80"></ellipse>
        <mask id="svg_df4f94c24063f55d31a2_mask-2" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="160" height="160" fill="white">
            <use xlink:href="#svg_df4f94c24063f55d31a2_path-1" />
        </mask>
        <polygon id="svg_df4f94c24063f55d31a2_path-3" points="2047.59509 192 1994.69441 219.811529 2004.79754 160.905765 1962 119.188471 2021.14475 110.594235 2047.59509 57 2074.04542 110.594235 2133.19017 119.188471 2090.39263 160.905765 2100.49576 219.811529"></polygon>
        <mask id="svg_df4f94c24063f55d31a2_mask-4" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="171.190173" height="162.811529" fill="white">
            <use xlink:href="#svg_df4f94c24063f55d31a2_path-3" />
        </mask>
        <polygon id="svg_df4f94c24063f55d31a2_path-5" points="1179.59509 194 1126.69441 221.811529 1136.79754 162.905765 1094 121.188471 1153.14475 112.594235 1179.59509 59 1206.04542 112.594235 1265.19017 121.188471 1222.39263 162.905765 1232.49576 221.811529"></polygon>
        <mask id="svg_df4f94c24063f55d31a2_mask-6" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="171.190173" height="162.811529" fill="white">
            <use xlink:href="#svg_df4f94c24063f55d31a2_path-5" />
        </mask>
        <polygon id="svg_df4f94c24063f55d31a2_path-7" points="1692.59509 195 1639.69441 222.811529 1649.79754 163.905765 1607 122.188471 1666.14475 113.594235 1692.59509 60 1719.04542 113.594235 1778.19017 122.188471 1735.39263 163.905765 1745.49576 222.811529"></polygon>
        <mask id="svg_df4f94c24063f55d31a2_mask-8" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="171.190173" height="162.811529" fill="white">
            <use xlink:href="#svg_df4f94c24063f55d31a2_path-7" />
        </mask>
        <polygon id="svg_df4f94c24063f55d31a2_path-9" points="926.595086 194 873.694414 221.811529 883.797543 162.905765 841 121.188471 900.14475 112.594235 926.595086 59 953.045423 112.594235 1012.19017 121.188471 969.39263 162.905765 979.495759 221.811529"></polygon>
        <mask id="svg_df4f94c24063f55d31a2_mask-10" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="171.190173" height="162.811529" fill="white">
            <use xlink:href="#svg_df4f94c24063f55d31a2_path-9" />
        </mask>
        <polygon id="svg_df4f94c24063f55d31a2_path-11" points="1498 120 1538 120 1538 100 1578 139.497767 1538 180 1538 160 1498 160"></polygon>
        <mask id="svg_df4f94c24063f55d31a2_mask-12" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="80" height="80" fill="white">
            <use xlink:href="#svg_df4f94c24063f55d31a2_path-11" />
        </mask>
        <ellipse id="svg_df4f94c24063f55d31a2_path-13" cx="125" cy="118" rx="80" ry="80"></ellipse>
        <mask id="svg_df4f94c24063f55d31a2_mask-14" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="160" height="160" fill="white">
            <use xlink:href="#svg_df4f94c24063f55d31a2_path-13" />
        </mask>
        <ellipse id="svg_df4f94c24063f55d31a2_path-15" cx="103" cy="98" rx="80" ry="80"></ellipse>
        <mask id="svg_df4f94c24063f55d31a2_mask-16" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="160" height="160" fill="white">
            <use xlink:href="#svg_df4f94c24063f55d31a2_path-15" />
        </mask>
        <ellipse id="svg_df4f94c24063f55d31a2_path-17" cx="80" cy="80" rx="80" ry="80"></ellipse>
        <mask id="svg_df4f94c24063f55d31a2_mask-18" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="160" height="160" fill="white">
            <use xlink:href="#svg_df4f94c24063f55d31a2_path-17" />
        </mask>
    </defs>
    <g id="svg_df4f94c24063f55d31a2_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_df4f94c24063f55d31a2_generic-foldleft">
            <rect id="svg_df4f94c24063f55d31a2_Background" fill="#FFFFFF" x="0" y="0" width="2400" height="360" />
            <use id="svg_df4f94c24063f55d31a2_Oval-1" stroke="#000000" mask="url(#mask-2)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_df4f94c24063f55d31a2_path-1" />
            <use id="svg_df4f94c24063f55d31a2_Star-1" stroke="#000000" mask="url(#mask-4)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_df4f94c24063f55d31a2_path-3" />
            <use id="svg_df4f94c24063f55d31a2_Star-1" stroke="#000000" mask="url(#mask-6)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_df4f94c24063f55d31a2_path-5" />
            <use id="svg_df4f94c24063f55d31a2_Star-1" stroke="#000000" mask="url(#mask-8)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_df4f94c24063f55d31a2_path-7" />
            <use id="svg_df4f94c24063f55d31a2_Star-1" stroke="#000000" mask="url(#mask-10)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_df4f94c24063f55d31a2_path-9" />
            <use id="svg_df4f94c24063f55d31a2_Path-1" stroke="#000000" mask="url(#mask-12)" stroke-width="8" fill="#000000" xlink:href="#svg_df4f94c24063f55d31a2_path-11" />
            <polygon id="svg_df4f94c24063f55d31a2_Path-1" fill="#F6A623" points="1826 120 1866 120 1866 100 1906 139.497767 1866 180 1866 160 1826 160"></polygon>
            <text id="svg_df4f94c24063f55d31a2_F[A]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="310.1" y="314">F[A]</tspan>
            </text>
            <text id="svg_df4f94c24063f55d31a2_B" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="2036.4" y="314">B</tspan>
            </text>
            <text id="svg_df4f94c24063f55d31a2_(B,-A)-=&gt;-B" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="1303.4" y="314">(B, A) =&gt; B</tspan>
            </text>
            <text id="svg_df4f94c24063f55d31a2_B" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="917.4" y="314">B</tspan>
            </text>
            <g id="svg_df4f94c24063f55d31a2_Group" transform="translate(261.000000, 40.000000)" stroke="#000000" stroke-width="8" fill="#FFFFFF">
                <use id="svg_df4f94c24063f55d31a2_Oval-1" mask="url(#mask-14)" xlink:href="#svg_df4f94c24063f55d31a2_path-13" />
                <use id="svg_df4f94c24063f55d31a2_Oval-1" mask="url(#mask-16)" xlink:href="#svg_df4f94c24063f55d31a2_path-15" />
                <use id="svg_df4f94c24063f55d31a2_Oval-1" mask="url(#mask-18)" xlink:href="#svg_df4f94c24063f55d31a2_path-17" />
            </g>
            <text id="svg_df4f94c24063f55d31a2_foldLeft" font-family="FiraMono-Bold, Fira Mono" font-size="64" font-weight="bold" fill="#F6A623">
                <tspan x="500.8" y="155">foldLeft</tspan>
            </text>
            <text id="svg_df4f94c24063f55d31a2_," font-family="FiraMono-Bold, Fira Mono" font-size="64" font-weight="bold" fill="#F6A623">
                <tspan x="1032.6" y="151">,</tspan>
            </text>
        </g>
    </g>
</svg>
    <figcaption>Figure 15: Type chart: fold</figcaption>
    </figure>
    <p>By distributing the reduce step we lose control over the order of
    traversal. Our overall reduction may not be entirely
    left-to-right—we may reduce left-to-right across several
    subsequences and then combine the results. To ensure correctness we
    need a reduction operation that is <em>associative</em>:</p>
    <div class="sourceCode" id="cb897"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb897-1"><a href="#cb897-1" aria-hidden="true" tabindex="-1"></a><span class="fu">reduce</span><span class="op">(</span>a1<span class="op">,</span> <span class="fu">reduce</span><span class="op">(</span>a2<span class="op">,</span> a3<span class="op">))</span> <span class="op">==</span> <span class="fu">reduce</span><span class="op">(</span><span class="fu">reduce</span><span class="op">(</span>a1<span class="op">,</span> a2<span class="op">),</span> a3<span class="op">)</span></span></code></pre></div>
    <p>If we have associativity, we can arbitrarily distribute work
    between our nodes provided the subsequences at every node stay in
    the same order as the initial dataset.</p>
    <p>Our fold operation requires us to seed the computation with an
    element of type <code>B</code>. Since fold may be split into an
    arbitrary number of parallel steps, the seed should not affect the
    result of the computation. This naturally requires the seed to be an
    <em>identity</em> element:</p>
    <div class="sourceCode" id="cb898"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb898-1"><a href="#cb898-1" aria-hidden="true" tabindex="-1"></a><span class="fu">reduce</span><span class="op">(</span>seed<span class="op">,</span> a1<span class="op">)</span> <span class="op">==</span> <span class="fu">reduce</span><span class="op">(</span>a1<span class="op">,</span> seed<span class="op">)</span> <span class="op">==</span> a1</span></code></pre></div>
    <p>In summary, our parallel fold will yield the correct results
    if:</p>
    <ul>
    <li>we require the reducer function to be associative;</li>
    <li>we seed the computation with the identity of this function.</li>
    </ul>
    <p>What does this pattern sound like? That’s right, we’ve come full
    circle back to <code>Monoid</code>, the first type class we
    discussed in this book. We are not the first to recognise the
    importance of monoids. The <a href="http://arxiv.org/abs/1304.7544">monoid design pattern for
    map-reduce jobs</a> is at the core of recent big data systems such
    as Twitter’s <a href="https://github.com/twitter/summingbird">Summingbird</a>.</p>
    <p>In this project we’re going to implement a very simple
    single-machine map-reduce. We’ll start by implementing a method
    called <code>foldMap</code> to model the data-flow we need.</p>
    <h2 data-number="17.2" id="implementing-foldmap"><span class="header-section-number">17.2</span> Implementing
    <em>foldMap</em></h2>
    <p>We saw <code>foldMap</code> briefly back when we covered
    <code>Foldable</code>. It is one of the derived operations that sits
    on top of <code>foldLeft</code> and <code>foldRight</code>. However,
    rather than use <code>Foldable</code>, we will re-implement
    <code>foldMap</code> here ourselves as it will provide useful
    insight into the structure of map-reduce.</p>
    <p>Start by writing out the signature of <code>foldMap</code>. It
    should accept the following parameters:</p>
    <ul>
    <li>a sequence of type <code>Vector[A]</code>;</li>
    <li>a function of type <code>A =&gt; B</code>, where there is a
    <code>Monoid</code> for <code>B</code>;</li>
    </ul>
    <p>You will have to add implicit parameters or context bounds to
    complete the type signature.</p>
    <div class="solution">
    <div class="sourceCode" id="cb899"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb899-1"><a href="#cb899-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Monoid</span>
<span id="cb899-2"><a href="#cb899-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb899-3"><a href="#cb899-3" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span> Single<span class="co">-</span>threaded map<span class="co">-</span>reduce function<span class="co">.</span></span>
<span id="cb899-4"><a href="#cb899-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">*</span> Maps <span class="co">`</span>func<span class="co">`</span> over <span class="co">`</span>values<span class="co">`</span> and reduces using a <span class="co">`</span>Monoid<span class="co">[</span>B<span class="co">]`.</span></span>
<span id="cb899-5"><a href="#cb899-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">*/</span></span>
<span id="cb899-6"><a href="#cb899-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> foldMap<span class="op">[</span>A<span class="op">,</span> B<span class="op">:</span> Monoid<span class="op">](</span>values<span class="op">:</span> <span class="ex">Vector</span><span class="op">[</span>A<span class="op">])(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> B <span class="op">=</span></span>
<span id="cb899-7"><a href="#cb899-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">???</span></span></code></pre></div>
    </div>
    <p>Now implement the body of <code>foldMap</code>. Use the flow
    chart in Figure 16 as a guide to the steps required:</p>
    <ol type="1">
    <li>start with a sequence of items of type <code>A</code>;</li>
    <li>map over the list to produce a sequence of items of type
    <code>B</code>;</li>
    <li>use the <code>Monoid</code> to reduce the items to a single
    <code>B</code>.</li>
    </ol>
    <figure id="fig:map-reduce:fold-map">
    <svg id="svg_e920b4022e3705007059" alt="foldMap algorithm" width="1420px" height="1041px" viewBox="0 0 1420 1041">
    <!-- Generator: Sketch 42 (36781) - http://www.bohemiancoding.com/sketch -->
    <title>fold-map</title>
    <desc>Created with Sketch.</desc>
    <defs>
        <rect id="svg_e920b4022e3705007059_path-1" x="0" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_e920b4022e3705007059_filter-2">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <polygon id="svg_e920b4022e3705007059_path-3" points="50.5950865 76.1806865 24.2698753 90.0206691 29.2975432 60.7071156 8 39.9471418 37.4324809 35.670352 50.5950865 9 63.7576921 35.670352 93.1901729 39.9471418 71.8926297 60.7071156 76.9202977 90.0206691"></polygon>
        <mask id="svg_e920b4022e3705007059_mask-4" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="85.1901729" height="81.0206691" fill="white">
            <use xlink:href="#svg_e920b4022e3705007059_path-3" />
        </mask>
        <rect id="svg_e920b4022e3705007059_path-5" x="0" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_e920b4022e3705007059_filter-6">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_e920b4022e3705007059_path-7" x="100" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_e920b4022e3705007059_filter-8">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_e920b4022e3705007059_path-9" x="200" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_e920b4022e3705007059_filter-10">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <polygon id="svg_e920b4022e3705007059_path-11" points="50.5950865 76.1806865 24.2698753 90.0206691 29.2975432 60.7071156 8 39.9471418 37.4324809 35.670352 50.5950865 9 63.7576921 35.670352 93.1901729 39.9471418 71.8926297 60.7071156 76.9202977 90.0206691"></polygon>
        <mask id="svg_e920b4022e3705007059_mask-12" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="85.1901729" height="81.0206691" fill="white">
            <use xlink:href="#svg_e920b4022e3705007059_path-11" />
        </mask>
        <polygon id="svg_e920b4022e3705007059_path-13" points="149.595086 76.1806865 123.269875 90.0206691 128.297543 60.7071156 107 39.9471418 136.432481 35.670352 149.595086 9 162.757692 35.670352 192.190173 39.9471418 170.89263 60.7071156 175.920298 90.0206691"></polygon>
        <mask id="svg_e920b4022e3705007059_mask-14" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="85.1901729" height="81.0206691" fill="white">
            <use xlink:href="#svg_e920b4022e3705007059_path-13" />
        </mask>
        <polygon id="svg_e920b4022e3705007059_path-15" points="249.595086 76.1806865 223.269875 90.0206691 228.297543 60.7071156 207 39.9471418 236.432481 35.670352 249.595086 9 262.757692 35.670352 292.190173 39.9471418 270.89263 60.7071156 275.920298 90.0206691"></polygon>
        <mask id="svg_e920b4022e3705007059_mask-16" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="85.1901729" height="81.0206691" fill="white">
            <use xlink:href="#svg_e920b4022e3705007059_path-15" />
        </mask>
        <rect id="svg_e920b4022e3705007059_path-17" x="0" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_e920b4022e3705007059_filter-18">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_e920b4022e3705007059_path-19" x="100" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_e920b4022e3705007059_filter-20">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_e920b4022e3705007059_path-21" x="200" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_e920b4022e3705007059_filter-22">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <ellipse id="svg_e920b4022e3705007059_path-23" cx="50.5" cy="50.5" rx="36.5" ry="36.5"></ellipse>
        <mask id="svg_e920b4022e3705007059_mask-24" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="73" height="73" fill="white">
            <use xlink:href="#svg_e920b4022e3705007059_path-23" />
        </mask>
        <ellipse id="svg_e920b4022e3705007059_path-25" cx="150.5" cy="50.5" rx="36.5" ry="36.5"></ellipse>
        <mask id="svg_e920b4022e3705007059_mask-26" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="73" height="73" fill="white">
            <use xlink:href="#svg_e920b4022e3705007059_path-25" />
        </mask>
        <ellipse id="svg_e920b4022e3705007059_path-27" cx="250.5" cy="50.5" rx="36.5" ry="36.5"></ellipse>
        <mask id="svg_e920b4022e3705007059_mask-28" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="73" height="73" fill="white">
            <use xlink:href="#svg_e920b4022e3705007059_path-27" />
        </mask>
    </defs>
    <g id="svg_e920b4022e3705007059_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_e920b4022e3705007059_fold-map">
            <rect id="svg_e920b4022e3705007059_Rectangle-3" fill="#FFFFFF" x="0" y="0" width="1420" height="1041" />
            <g id="svg_e920b4022e3705007059_reduced-B" transform="translate(652.000000, 780.000000)">
                <g id="svg_e920b4022e3705007059_Rectangle">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_e920b4022e3705007059_path-1" />
                    <use fill="black" fill-opacity="1" filter="url(#filter-2)" xlink:href="#svg_e920b4022e3705007059_path-1" />
                    <use stroke="#000000" stroke-width="4" xlink:href="#svg_e920b4022e3705007059_path-1" />
                </g>
                <use id="svg_e920b4022e3705007059_Star-1-Copy-18" stroke="#000000" mask="url(#mask-4)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_e920b4022e3705007059_path-3" />
            </g>
            <g id="svg_e920b4022e3705007059_mapped-B" transform="translate(552.000000, 480.000000)">
                <g id="svg_e920b4022e3705007059_Rectangle">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_e920b4022e3705007059_path-5" />
                    <use fill="black" fill-opacity="1" filter="url(#filter-6)" xlink:href="#svg_e920b4022e3705007059_path-5" />
                    <use stroke="#000000" stroke-width="4" xlink:href="#svg_e920b4022e3705007059_path-5" />
                </g>
                <g id="svg_e920b4022e3705007059_Rectangle">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_e920b4022e3705007059_path-7" />
                    <use fill="black" fill-opacity="1" filter="url(#filter-8)" xlink:href="#svg_e920b4022e3705007059_path-7" />
                    <use stroke="#000000" stroke-width="4" xlink:href="#svg_e920b4022e3705007059_path-7" />
                </g>
                <g id="svg_e920b4022e3705007059_Rectangle">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_e920b4022e3705007059_path-9" />
                    <use fill="black" fill-opacity="1" filter="url(#filter-10)" xlink:href="#svg_e920b4022e3705007059_path-9" />
                    <use stroke="#000000" stroke-width="4" xlink:href="#svg_e920b4022e3705007059_path-9" />
                </g>
                <use id="svg_e920b4022e3705007059_Star-1-Copy-22" stroke="#000000" mask="url(#mask-12)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_e920b4022e3705007059_path-11" />
                <use id="svg_e920b4022e3705007059_Star-1-Copy-26" stroke="#000000" mask="url(#mask-14)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_e920b4022e3705007059_path-13" />
                <use id="svg_e920b4022e3705007059_Star-1-Copy-30" stroke="#000000" mask="url(#mask-16)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_e920b4022e3705007059_path-15" />
            </g>
            <g id="svg_e920b4022e3705007059_Initial-A" transform="translate(552.000000, 180.000000)">
                <g id="svg_e920b4022e3705007059_Rectangle">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_e920b4022e3705007059_path-17" />
                    <use fill="black" fill-opacity="1" filter="url(#filter-18)" xlink:href="#svg_e920b4022e3705007059_path-17" />
                    <use stroke="#000000" stroke-width="4" xlink:href="#svg_e920b4022e3705007059_path-17" />
                </g>
                <g id="svg_e920b4022e3705007059_Rectangle">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_e920b4022e3705007059_path-19" />
                    <use fill="black" fill-opacity="1" filter="url(#filter-20)" xlink:href="#svg_e920b4022e3705007059_path-19" />
                    <use stroke="#000000" stroke-width="4" xlink:href="#svg_e920b4022e3705007059_path-19" />
                </g>
                <g id="svg_e920b4022e3705007059_Rectangle">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_e920b4022e3705007059_path-21" />
                    <use fill="black" fill-opacity="1" filter="url(#filter-22)" xlink:href="#svg_e920b4022e3705007059_path-21" />
                    <use stroke="#000000" stroke-width="4" xlink:href="#svg_e920b4022e3705007059_path-21" />
                </g>
                <use id="svg_e920b4022e3705007059_Oval-1-Copy-20" stroke="#000000" mask="url(#mask-24)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_e920b4022e3705007059_path-23" />
                <use id="svg_e920b4022e3705007059_Oval-1-Copy-21" stroke="#000000" mask="url(#mask-26)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_e920b4022e3705007059_path-25" />
                <use id="svg_e920b4022e3705007059_Oval-1-Copy-22" stroke="#000000" mask="url(#mask-28)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_e920b4022e3705007059_path-27" />
            </g>
            <text id="svg_e920b4022e3705007059_result-label" font-family="Helvetica" font-size="36" font-weight="normal" fill="#000000">
                <tspan x="593.456055" y="980">4. Final result</tspan>
            </text>
            <g id="svg_e920b4022e3705007059_reduce-label" transform="translate(547.000000, 648.000000)">
                <polygon id="svg_e920b4022e3705007059_arrow" fill="#F6A623" transform="translate(154.071618, 40.000000) rotate(-270.000000) translate(-154.071618, -40.000000) " points="114.071618 20 154.071618 20 154.071618 3.55271368e-15 194.071618 39.4977671 154.071618 80 154.071618 60 114.071618 60"></polygon>
                <text font-family="Helvetica" font-size="36" font-weight="normal" fill="#000000">
                    <tspan x="0.41015625" y="44">3. Fold/reduce step</tspan>
                </text>
            </g>
            <g id="svg_e920b4022e3705007059_map-label" transform="translate(607.000000, 350.000000)">
                <polygon id="svg_e920b4022e3705007059_arrow" fill="#F6A623" transform="translate(99.000000, 40.000000) rotate(-270.000000) translate(-99.000000, -40.000000) " points="59 20 99 20 99 3.55271368e-15 139 39.4977671 99 80 99 60 59 60"></polygon>
                <text font-family="Helvetica" font-size="36" font-weight="normal" fill="#000000">
                    <tspan x="0.448242188" y="42">2. Map step</tspan>
                </text>
            </g>
            <text id="svg_e920b4022e3705007059_initial-label" font-family="Helvetica" font-size="36" font-weight="normal" fill="#000000">
                <tspan x="516.367188" y="94">1. Initial data sequence</tspan>
            </text>
        </g>
    </g>
</svg>
    <figcaption>Figure 16: <em>foldMap</em> algorithm</figcaption>
    </figure>
    <p>Here’s some sample output for reference:</p>
    <div class="sourceCode" id="cb900"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb900-1"><a href="#cb900-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span><span class="dt">int</span><span class="op">.</span>_ <span class="co">// for Monoid</span></span></code></pre></div>
    <div class="sourceCode" id="cb901"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb901-1"><a href="#cb901-1" aria-hidden="true" tabindex="-1"></a><span class="fu">foldMap</span><span class="op">(</span><span class="ex">Vector</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">))(</span>identity<span class="op">)</span></span>
<span id="cb901-2"><a href="#cb901-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res1: Int = 6</span></span></code></pre></div>
    <div class="sourceCode" id="cb902"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb902-1"><a href="#cb902-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>string<span class="op">.</span>_ <span class="co">// for Monoid</span></span></code></pre></div>
    <div class="sourceCode" id="cb903"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb903-1"><a href="#cb903-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Mapping to a String uses the concatenation monoid:</span></span>
<span id="cb903-2"><a href="#cb903-2" aria-hidden="true" tabindex="-1"></a><span class="fu">foldMap</span><span class="op">(</span><span class="ex">Vector</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">))(</span>_<span class="op">.</span>toString <span class="op">+</span> <span class="st">&quot;! &quot;</span><span class="op">)</span></span>
<span id="cb903-3"><a href="#cb903-3" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: String = &quot;1! 2! 3! &quot;</span></span>
<span id="cb903-4"><a href="#cb903-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb903-5"><a href="#cb903-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Mapping over a String to produce a String:</span></span>
<span id="cb903-6"><a href="#cb903-6" aria-hidden="true" tabindex="-1"></a><span class="fu">foldMap</span><span class="op">(</span><span class="st">&quot;Hello world!&quot;</span><span class="op">.</span>toVector<span class="op">)(</span>_<span class="op">.</span>toString<span class="op">.</span>toUpperCase<span class="op">)</span></span>
<span id="cb903-7"><a href="#cb903-7" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: String = &quot;HELLO WORLD!&quot;</span></span></code></pre></div>
    <div class="solution">
    <p>We have to modify the type signature to accept a
    <code>Monoid</code> for <code>B</code>. With that change we can use
    the <code>Monoid</code> <code>empty</code> and <code>|+|</code>
    syntax as described in Section 7.3.3:</p>
    <div class="sourceCode" id="cb904"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb904-1"><a href="#cb904-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Monoid</span>
<span id="cb904-2"><a href="#cb904-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>semigroup<span class="op">.</span>_ <span class="co">// for |+|</span></span>
<span id="cb904-3"><a href="#cb904-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb904-4"><a href="#cb904-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> foldMap<span class="op">[</span>A<span class="op">,</span> B <span class="op">:</span> Monoid<span class="op">](</span>as<span class="op">:</span> <span class="ex">Vector</span><span class="op">[</span>A<span class="op">])(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> B <span class="op">=</span></span>
<span id="cb904-5"><a href="#cb904-5" aria-hidden="true" tabindex="-1"></a>  as<span class="op">.</span><span class="fu">map</span><span class="op">(</span>func<span class="op">).</span><span class="fu">foldLeft</span><span class="op">(</span>Monoid<span class="op">[</span>B<span class="op">].</span>empty<span class="op">)(</span>_ <span class="op">|+|</span> _<span class="op">)</span></span></code></pre></div>
    <p>We can make a slight alteration to this code to do everything in
    one step:</p>
    <div class="sourceCode" id="cb905"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb905-1"><a href="#cb905-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> foldMap<span class="op">[</span>A<span class="op">,</span> B <span class="op">:</span> Monoid<span class="op">](</span>as<span class="op">:</span> <span class="ex">Vector</span><span class="op">[</span>A<span class="op">])(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> B <span class="op">=</span></span>
<span id="cb905-2"><a href="#cb905-2" aria-hidden="true" tabindex="-1"></a>  as<span class="op">.</span><span class="fu">foldLeft</span><span class="op">(</span>Monoid<span class="op">[</span>B<span class="op">].</span>empty<span class="op">)(</span>_ <span class="op">|+|</span> <span class="fu">func</span><span class="op">(</span>_<span class="op">))</span></span></code></pre></div>
    </div>
    <h2 data-number="17.3" id="parallelising-foldmap"><span class="header-section-number">17.3</span> Parallelising
    <em>foldMap</em></h2>
    <p>Now we have a working single-threaded implementation of
    <code>foldMap</code>, let’s look at distributing work to run in
    parallel. We’ll use our single-threaded version of
    <code>foldMap</code> as a building block.</p>
    <p>We’ll write a multi-CPU implementation that simulates the way we
    would distribute work in a map-reduce cluster as shown in Figure
    17:</p>
    <ol type="1">
    <li>we start with an initial list of all the data we need to
    process;</li>
    <li>we divide the data into batches, sending one batch to each
    CPU;</li>
    <li>the CPUs run a batch-level map phase in parallel;</li>
    <li>the CPUs run a batch-level reduce phase in parallel, producing a
    local result for each batch;</li>
    <li>we reduce the results for each batch to a single final
    result.</li>
    </ol>
    <figure id="fig:map-reduce:parallel-fold-map">
    <svg id="svg_66a11eb7ee05ff53cd13" alt="parallelFoldMap algorithm" width="1420px" height="1640px" viewBox="0 0 1420 1640">
    <!-- Generator: Sketch 42 (36781) - http://www.bohemiancoding.com/sketch -->
    <title>parallel-fold-map</title>
    <desc>Created with Sketch.</desc>
    <defs>
        <rect id="svg_66a11eb7ee05ff53cd13_path-1" x="0" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-2">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <polygon id="svg_66a11eb7ee05ff53cd13_path-3" points="50.5950865 76.670352 24.2698753 90.5103345 29.2975432 61.1967811 8 40.4368073 37.4324809 36.1600174 50.5950865 9.48966545 63.7576921 36.1600174 93.1901729 40.4368073 71.8926297 61.1967811 76.9202977 90.5103345"></polygon>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-4" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="85.1901729" height="81.0206691" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-3" />
        </mask>
        <rect id="svg_66a11eb7ee05ff53cd13_path-5" x="-1.42108547e-14" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-6">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-7" x="720" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-8">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-9" x="360" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-10">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-11" x="1080" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-12">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <polygon id="svg_66a11eb7ee05ff53cd13_path-13" points="50.5950865 76.1806865 24.2698753 90.0206691 29.2975432 60.7071156 8 39.9471418 37.4324809 35.670352 50.5950865 9 63.7576921 35.670352 93.1901729 39.9471418 71.8926297 60.7071156 76.9202977 90.0206691"></polygon>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-14" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="85.1901729" height="81.0206691" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-13" />
        </mask>
        <polygon id="svg_66a11eb7ee05ff53cd13_path-15" points="410.595086 76.1806865 384.269875 90.0206691 389.297543 60.7071156 368 39.9471418 397.432481 35.670352 410.595086 9 423.757692 35.670352 453.190173 39.9471418 431.89263 60.7071156 436.920298 90.0206691"></polygon>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-16" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="85.1901729" height="81.0206691" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-15" />
        </mask>
        <polygon id="svg_66a11eb7ee05ff53cd13_path-17" points="770.595086 76.1806865 744.269875 90.0206691 749.297543 60.7071156 728 39.9471418 757.432481 35.670352 770.595086 9 783.757692 35.670352 813.190173 39.9471418 791.89263 60.7071156 796.920298 90.0206691"></polygon>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-18" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="85.1901729" height="81.0206691" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-17" />
        </mask>
        <polygon id="svg_66a11eb7ee05ff53cd13_path-19" points="1130.59509 76.1806865 1104.26988 90.0206691 1109.29754 60.7071156 1088 39.9471418 1117.43248 35.670352 1130.59509 9 1143.75769 35.670352 1173.19017 39.9471418 1151.89263 60.7071156 1156.9203 90.0206691"></polygon>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-20" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="85.1901729" height="81.0206691" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-19" />
        </mask>
        <rect id="svg_66a11eb7ee05ff53cd13_path-21" x="0" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-22">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-23" x="720" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-24">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-25" x="100" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-26">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-27" x="820" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-28">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-29" x="200" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-30">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-31" x="920" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-32">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-33" x="360" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-34">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-35" x="1080" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-36">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-37" x="460" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-38">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-39" x="1180" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-40">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-41" x="560" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-42">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-43" x="1280" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-44">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <polygon id="svg_66a11eb7ee05ff53cd13_path-45" points="50.5950865 76.1806865 24.2698753 90.0206691 29.2975432 60.7071156 8 39.9471418 37.4324809 35.670352 50.5950865 9 63.7576921 35.670352 93.1901729 39.9471418 71.8926297 60.7071156 76.9202977 90.0206691"></polygon>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-46" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="85.1901729" height="81.0206691" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-45" />
        </mask>
        <polygon id="svg_66a11eb7ee05ff53cd13_path-47" points="410.595086 76.1806865 384.269875 90.0206691 389.297543 60.7071156 368 39.9471418 397.432481 35.670352 410.595086 9 423.757692 35.670352 453.190173 39.9471418 431.89263 60.7071156 436.920298 90.0206691"></polygon>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-48" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="85.1901729" height="81.0206691" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-47" />
        </mask>
        <polygon id="svg_66a11eb7ee05ff53cd13_path-49" points="770.595086 76.1806865 744.269875 90.0206691 749.297543 60.7071156 728 39.9471418 757.432481 35.670352 770.595086 9 783.757692 35.670352 813.190173 39.9471418 791.89263 60.7071156 796.920298 90.0206691"></polygon>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-50" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="85.1901729" height="81.0206691" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-49" />
        </mask>
        <polygon id="svg_66a11eb7ee05ff53cd13_path-51" points="1130.59509 76.1806865 1104.26988 90.0206691 1109.29754 60.7071156 1088 39.9471418 1117.43248 35.670352 1130.59509 9 1143.75769 35.670352 1173.19017 39.9471418 1151.89263 60.7071156 1156.9203 90.0206691"></polygon>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-52" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="85.1901729" height="81.0206691" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-51" />
        </mask>
        <polygon id="svg_66a11eb7ee05ff53cd13_path-53" points="149.595086 76.1806865 123.269875 90.0206691 128.297543 60.7071156 107 39.9471418 136.432481 35.670352 149.595086 9 162.757692 35.670352 192.190173 39.9471418 170.89263 60.7071156 175.920298 90.0206691"></polygon>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-54" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="85.1901729" height="81.0206691" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-53" />
        </mask>
        <polygon id="svg_66a11eb7ee05ff53cd13_path-55" points="509.595086 76.1806865 483.269875 90.0206691 488.297543 60.7071156 467 39.9471418 496.432481 35.670352 509.595086 9 522.757692 35.670352 552.190173 39.9471418 530.89263 60.7071156 535.920298 90.0206691"></polygon>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-56" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="85.1901729" height="81.0206691" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-55" />
        </mask>
        <polygon id="svg_66a11eb7ee05ff53cd13_path-57" points="869.595086 76.1806865 843.269875 90.0206691 848.297543 60.7071156 827 39.9471418 856.432481 35.670352 869.595086 9 882.757692 35.670352 912.190173 39.9471418 890.89263 60.7071156 895.920298 90.0206691"></polygon>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-58" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="85.1901729" height="81.0206691" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-57" />
        </mask>
        <polygon id="svg_66a11eb7ee05ff53cd13_path-59" points="1229.59509 76.1806865 1203.26988 90.0206691 1208.29754 60.7071156 1187 39.9471418 1216.43248 35.670352 1229.59509 9 1242.75769 35.670352 1272.19017 39.9471418 1250.89263 60.7071156 1255.9203 90.0206691"></polygon>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-60" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="85.1901729" height="81.0206691" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-59" />
        </mask>
        <polygon id="svg_66a11eb7ee05ff53cd13_path-61" points="249.595086 76.1806865 223.269875 90.0206691 228.297543 60.7071156 207 39.9471418 236.432481 35.670352 249.595086 9 262.757692 35.670352 292.190173 39.9471418 270.89263 60.7071156 275.920298 90.0206691"></polygon>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-62" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="85.1901729" height="81.0206691" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-61" />
        </mask>
        <polygon id="svg_66a11eb7ee05ff53cd13_path-63" points="609.595086 76.1806865 583.269875 90.0206691 588.297543 60.7071156 567 39.9471418 596.432481 35.670352 609.595086 9 622.757692 35.670352 652.190173 39.9471418 630.89263 60.7071156 635.920298 90.0206691"></polygon>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-64" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="85.1901729" height="81.0206691" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-63" />
        </mask>
        <polygon id="svg_66a11eb7ee05ff53cd13_path-65" points="969.595086 76.1806865 943.269875 90.0206691 948.297543 60.7071156 927 39.9471418 956.432481 35.670352 969.595086 9 982.757692 35.670352 1012.19017 39.9471418 990.89263 60.7071156 995.920298 90.0206691"></polygon>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-66" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="85.1901729" height="81.0206691" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-65" />
        </mask>
        <polygon id="svg_66a11eb7ee05ff53cd13_path-67" points="1329.59509 76.1806865 1303.26988 90.0206691 1308.29754 60.7071156 1287 39.9471418 1316.43248 35.670352 1329.59509 9 1342.75769 35.670352 1372.19017 39.9471418 1350.89263 60.7071156 1355.9203 90.0206691"></polygon>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-68" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="85.1901729" height="81.0206691" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-67" />
        </mask>
        <rect id="svg_66a11eb7ee05ff53cd13_path-69" x="0" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-70">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-71" x="720" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-72">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-73" x="100" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-74">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-75" x="820" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-76">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-77" x="200" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-78">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-79" x="920" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-80">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-81" x="360" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-82">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-83" x="1080" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-84">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-85" x="460" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-86">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-87" x="1180" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-88">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-89" x="560" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-90">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-91" x="1280" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-92">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <ellipse id="svg_66a11eb7ee05ff53cd13_path-93" cx="1129.5" cy="50.5" rx="36.5" ry="36.5"></ellipse>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-94" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="73" height="73" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-93" />
        </mask>
        <ellipse id="svg_66a11eb7ee05ff53cd13_path-95" cx="1229.5" cy="50.5" rx="36.5" ry="36.5"></ellipse>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-96" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="73" height="73" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-95" />
        </mask>
        <ellipse id="svg_66a11eb7ee05ff53cd13_path-97" cx="1329.5" cy="50.5" rx="36.5" ry="36.5"></ellipse>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-98" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="73" height="73" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-97" />
        </mask>
        <ellipse id="svg_66a11eb7ee05ff53cd13_path-99" cx="770.5" cy="50.5" rx="36.5" ry="36.5"></ellipse>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-100" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="73" height="73" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-99" />
        </mask>
        <ellipse id="svg_66a11eb7ee05ff53cd13_path-101" cx="870.5" cy="50.5" rx="36.5" ry="36.5"></ellipse>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-102" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="73" height="73" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-101" />
        </mask>
        <ellipse id="svg_66a11eb7ee05ff53cd13_path-103" cx="970.5" cy="50.5" rx="36.5" ry="36.5"></ellipse>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-104" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="73" height="73" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-103" />
        </mask>
        <ellipse id="svg_66a11eb7ee05ff53cd13_path-105" cx="410.5" cy="50.5" rx="36.5" ry="36.5"></ellipse>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-106" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="73" height="73" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-105" />
        </mask>
        <ellipse id="svg_66a11eb7ee05ff53cd13_path-107" cx="510.5" cy="50.5" rx="36.5" ry="36.5"></ellipse>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-108" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="73" height="73" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-107" />
        </mask>
        <ellipse id="svg_66a11eb7ee05ff53cd13_path-109" cx="610.5" cy="50.5" rx="36.5" ry="36.5"></ellipse>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-110" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="73" height="73" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-109" />
        </mask>
        <ellipse id="svg_66a11eb7ee05ff53cd13_path-111" cx="50.5" cy="50.5" rx="36.5" ry="36.5"></ellipse>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-112" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="73" height="73" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-111" />
        </mask>
        <ellipse id="svg_66a11eb7ee05ff53cd13_path-113" cx="150.5" cy="50.5" rx="36.5" ry="36.5"></ellipse>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-114" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="73" height="73" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-113" />
        </mask>
        <ellipse id="svg_66a11eb7ee05ff53cd13_path-115" cx="250.5" cy="50.5" rx="36.5" ry="36.5"></ellipse>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-116" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="73" height="73" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-115" />
        </mask>
        <rect id="svg_66a11eb7ee05ff53cd13_path-117" x="0" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-118">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-119" x="600" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-120">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-121" x="100" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-122">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-123" x="700" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-124">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-125" x="200" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-126">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-127" x="800" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-128">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-129" x="300" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-130">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-131" x="900" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-132">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-133" x="400" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-134">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-135" x="1000" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-136">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-137" x="500" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-138">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <rect id="svg_66a11eb7ee05ff53cd13_path-139" x="1100" y="0" width="100" height="100" />
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="svg_66a11eb7ee05ff53cd13_filter-140">
            <feGaussianBlur stdDeviation="1.5" in="SourceAlpha" result="shadowBlurInner1"></feGaussianBlur>
            <feOffset dx="0" dy="1" in="shadowBlurInner1" result="shadowOffsetInner1"></feOffset>
            <feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite>
            <feColorMatrix values="0 0 0 0 0   0 0 0 0 0   0 0 0 0 0  0 0 0 0.5 0" type="matrix" in="shadowInnerInner1"></feColorMatrix>
        </filter>
        <ellipse id="svg_66a11eb7ee05ff53cd13_path-141" cx="50.5" cy="50.5" rx="36.5" ry="36.5"></ellipse>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-142" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="73" height="73" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-141" />
        </mask>
        <ellipse id="svg_66a11eb7ee05ff53cd13_path-143" cx="150.5" cy="50.5" rx="36.5" ry="36.5"></ellipse>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-144" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="73" height="73" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-143" />
        </mask>
        <ellipse id="svg_66a11eb7ee05ff53cd13_path-145" cx="250.5" cy="50.5" rx="36.5" ry="36.5"></ellipse>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-146" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="73" height="73" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-145" />
        </mask>
        <ellipse id="svg_66a11eb7ee05ff53cd13_path-147" cx="350.5" cy="50.5" rx="36.5" ry="36.5"></ellipse>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-148" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="73" height="73" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-147" />
        </mask>
        <ellipse id="svg_66a11eb7ee05ff53cd13_path-149" cx="650.5" cy="50.5" rx="36.5" ry="36.5"></ellipse>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-150" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="73" height="73" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-149" />
        </mask>
        <ellipse id="svg_66a11eb7ee05ff53cd13_path-151" cx="950.5" cy="50.5" rx="36.5" ry="36.5"></ellipse>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-152" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="73" height="73" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-151" />
        </mask>
        <ellipse id="svg_66a11eb7ee05ff53cd13_path-153" cx="450.5" cy="50.5" rx="36.5" ry="36.5"></ellipse>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-154" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="73" height="73" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-153" />
        </mask>
        <ellipse id="svg_66a11eb7ee05ff53cd13_path-155" cx="750.5" cy="50.5" rx="36.5" ry="36.5"></ellipse>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-156" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="73" height="73" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-155" />
        </mask>
        <ellipse id="svg_66a11eb7ee05ff53cd13_path-157" cx="1050.5" cy="50.5" rx="36.5" ry="36.5"></ellipse>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-158" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="73" height="73" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-157" />
        </mask>
        <ellipse id="svg_66a11eb7ee05ff53cd13_path-159" cx="550.5" cy="50.5" rx="36.5" ry="36.5"></ellipse>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-160" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="73" height="73" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-159" />
        </mask>
        <ellipse id="svg_66a11eb7ee05ff53cd13_path-161" cx="850.5" cy="50.5" rx="36.5" ry="36.5"></ellipse>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-162" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="73" height="73" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-161" />
        </mask>
        <ellipse id="svg_66a11eb7ee05ff53cd13_path-163" cx="1150.5" cy="50.5" rx="36.5" ry="36.5"></ellipse>
        <mask id="svg_66a11eb7ee05ff53cd13_mask-164" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="73" height="73" fill="white">
            <use xlink:href="#svg_66a11eb7ee05ff53cd13_path-163" />
        </mask>
    </defs>
    <g id="svg_66a11eb7ee05ff53cd13_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_66a11eb7ee05ff53cd13_parallel-fold-map">
            <rect id="svg_66a11eb7ee05ff53cd13_Rectangle-3" fill="#FFFFFF" x="0" y="0" width="1420" height="1640" />
            <g id="svg_66a11eb7ee05ff53cd13_final-B" transform="translate(660.000000, 1360.000000)">
                <g id="svg_66a11eb7ee05ff53cd13_Rectangle-Copy-4">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-1" />
                    <use fill="black" fill-opacity="1" filter="url(#filter-2)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-1" />
                    <use stroke="#000000" stroke-width="8" xlink:href="#svg_66a11eb7ee05ff53cd13_path-1" />
                </g>
                <use id="svg_66a11eb7ee05ff53cd13_Star-1-Copy-14" stroke="#000000" mask="url(#mask-4)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-3" />
            </g>
            <g id="svg_66a11eb7ee05ff53cd13_reduced-batches-of-B" transform="translate(120.000000, 1060.000000)">
                <g id="svg_66a11eb7ee05ff53cd13_Rectangle">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-5" />
                    <use fill="black" fill-opacity="1" filter="url(#filter-6)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-5" />
                    <use stroke="#000000" stroke-width="8" xlink:href="#svg_66a11eb7ee05ff53cd13_path-5" />
                </g>
                <g id="svg_66a11eb7ee05ff53cd13_Rectangle-Copy-4">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-7" />
                    <use fill="black" fill-opacity="1" filter="url(#filter-8)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-7" />
                    <use stroke="#000000" stroke-width="8" xlink:href="#svg_66a11eb7ee05ff53cd13_path-7" />
                </g>
                <g id="svg_66a11eb7ee05ff53cd13_Rectangle-Copy">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-9" />
                    <use fill="black" fill-opacity="1" filter="url(#filter-10)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-9" />
                    <use stroke="#000000" stroke-width="8" xlink:href="#svg_66a11eb7ee05ff53cd13_path-9" />
                </g>
                <g id="svg_66a11eb7ee05ff53cd13_Rectangle-Copy-7">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-11" />
                    <use fill="black" fill-opacity="1" filter="url(#filter-12)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-11" />
                    <use stroke="#000000" stroke-width="8" xlink:href="#svg_66a11eb7ee05ff53cd13_path-11" />
                </g>
                <use id="svg_66a11eb7ee05ff53cd13_Star-1-Copy-13" stroke="#000000" mask="url(#mask-14)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-13" />
                <use id="svg_66a11eb7ee05ff53cd13_Star-1-Copy-14" stroke="#000000" mask="url(#mask-16)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-15" />
                <use id="svg_66a11eb7ee05ff53cd13_Star-1-Copy-15" stroke="#000000" mask="url(#mask-18)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-17" />
                <use id="svg_66a11eb7ee05ff53cd13_Star-1-Copy-16" stroke="#000000" mask="url(#mask-20)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-19" />
            </g>
            <g id="svg_66a11eb7ee05ff53cd13_batches-of-B" transform="translate(20.000000, 760.000000)">
                <g id="svg_66a11eb7ee05ff53cd13_Group-3">
                    <g id="svg_66a11eb7ee05ff53cd13_Rectangle">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-21" />
                        <use fill="black" fill-opacity="1" filter="url(#filter-22)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-21" />
                        <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-21" />
                    </g>
                    <g id="svg_66a11eb7ee05ff53cd13_Rectangle-Copy-3">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-23" />
                        <use fill="black" fill-opacity="1" filter="url(#filter-24)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-23" />
                        <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-23" />
                    </g>
                    <g id="svg_66a11eb7ee05ff53cd13_Rectangle">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-25" />
                        <use fill="black" fill-opacity="1" filter="url(#filter-26)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-25" />
                        <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-25" />
                    </g>
                    <g id="svg_66a11eb7ee05ff53cd13_Rectangle-Copy-4">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-27" />
                        <use fill="black" fill-opacity="1" filter="url(#filter-28)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-27" />
                        <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-27" />
                    </g>
                    <g id="svg_66a11eb7ee05ff53cd13_Rectangle">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-29" />
                        <use fill="black" fill-opacity="1" filter="url(#filter-30)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-29" />
                        <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-29" />
                    </g>
                    <g id="svg_66a11eb7ee05ff53cd13_Rectangle-Copy-5">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-31" />
                        <use fill="black" fill-opacity="1" filter="url(#filter-32)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-31" />
                        <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-31" />
                    </g>
                    <g id="svg_66a11eb7ee05ff53cd13_Rectangle">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-33" />
                        <use fill="black" fill-opacity="1" filter="url(#filter-34)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-33" />
                        <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-33" />
                    </g>
                    <g id="svg_66a11eb7ee05ff53cd13_Rectangle-Copy-6">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-35" />
                        <use fill="black" fill-opacity="1" filter="url(#filter-36)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-35" />
                        <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-35" />
                    </g>
                    <g id="svg_66a11eb7ee05ff53cd13_Rectangle-Copy">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-37" />
                        <use fill="black" fill-opacity="1" filter="url(#filter-38)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-37" />
                        <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-37" />
                    </g>
                    <g id="svg_66a11eb7ee05ff53cd13_Rectangle-Copy-7">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-39" />
                        <use fill="black" fill-opacity="1" filter="url(#filter-40)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-39" />
                        <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-39" />
                    </g>
                    <g id="svg_66a11eb7ee05ff53cd13_Rectangle-Copy-2">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-41" />
                        <use fill="black" fill-opacity="1" filter="url(#filter-42)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-41" />
                        <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-41" />
                    </g>
                    <g id="svg_66a11eb7ee05ff53cd13_Rectangle-Copy-8">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-43" />
                        <use fill="black" fill-opacity="1" filter="url(#filter-44)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-43" />
                        <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-43" />
                    </g>
                </g>
                <rect id="svg_66a11eb7ee05ff53cd13_Rectangle-2" stroke="#000000" stroke-width="8" stroke-linejoin="round" x="0" y="0" width="300" height="100" />
                <rect id="svg_66a11eb7ee05ff53cd13_Rectangle-2" stroke="#000000" stroke-width="8" stroke-linejoin="round" x="360" y="0" width="300" height="100" />
                <rect id="svg_66a11eb7ee05ff53cd13_Rectangle-2" stroke="#000000" stroke-width="8" stroke-linejoin="round" x="720" y="0" width="300" height="100" />
                <rect id="svg_66a11eb7ee05ff53cd13_Rectangle-2" stroke="#000000" stroke-width="8" stroke-linejoin="round" x="1080" y="0" width="300" height="100" />
                <use id="svg_66a11eb7ee05ff53cd13_Star-1-Copy" stroke="#000000" mask="url(#mask-46)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-45" />
                <use id="svg_66a11eb7ee05ff53cd13_Star-1-Copy-4" stroke="#000000" mask="url(#mask-48)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-47" />
                <use id="svg_66a11eb7ee05ff53cd13_Star-1-Copy-7" stroke="#000000" mask="url(#mask-50)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-49" />
                <use id="svg_66a11eb7ee05ff53cd13_Star-1-Copy-10" stroke="#000000" mask="url(#mask-52)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-51" />
                <use id="svg_66a11eb7ee05ff53cd13_Star-1-Copy-2" stroke="#000000" mask="url(#mask-54)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-53" />
                <use id="svg_66a11eb7ee05ff53cd13_Star-1-Copy-5" stroke="#000000" mask="url(#mask-56)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-55" />
                <use id="svg_66a11eb7ee05ff53cd13_Star-1-Copy-8" stroke="#000000" mask="url(#mask-58)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-57" />
                <use id="svg_66a11eb7ee05ff53cd13_Star-1-Copy-11" stroke="#000000" mask="url(#mask-60)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-59" />
                <use id="svg_66a11eb7ee05ff53cd13_Star-1-Copy-3" stroke="#000000" mask="url(#mask-62)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-61" />
                <use id="svg_66a11eb7ee05ff53cd13_Star-1-Copy-6" stroke="#000000" mask="url(#mask-64)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-63" />
                <use id="svg_66a11eb7ee05ff53cd13_Star-1-Copy-9" stroke="#000000" mask="url(#mask-66)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-65" />
                <use id="svg_66a11eb7ee05ff53cd13_Star-1-Copy-12" stroke="#000000" mask="url(#mask-68)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-67" />
            </g>
            <g id="svg_66a11eb7ee05ff53cd13_batches-of-A" transform="translate(20.000000, 460.000000)">
                <g id="svg_66a11eb7ee05ff53cd13_Group-2">
                    <g id="svg_66a11eb7ee05ff53cd13_Rectangle">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-69" />
                        <use fill="black" fill-opacity="1" filter="url(#filter-70)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-69" />
                        <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-69" />
                    </g>
                    <g id="svg_66a11eb7ee05ff53cd13_Rectangle-Copy-3">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-71" />
                        <use fill="black" fill-opacity="1" filter="url(#filter-72)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-71" />
                        <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-71" />
                    </g>
                    <g id="svg_66a11eb7ee05ff53cd13_Rectangle">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-73" />
                        <use fill="black" fill-opacity="1" filter="url(#filter-74)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-73" />
                        <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-73" />
                    </g>
                    <g id="svg_66a11eb7ee05ff53cd13_Rectangle-Copy-4">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-75" />
                        <use fill="black" fill-opacity="1" filter="url(#filter-76)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-75" />
                        <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-75" />
                    </g>
                    <g id="svg_66a11eb7ee05ff53cd13_Rectangle">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-77" />
                        <use fill="black" fill-opacity="1" filter="url(#filter-78)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-77" />
                        <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-77" />
                    </g>
                    <g id="svg_66a11eb7ee05ff53cd13_Rectangle-Copy-5">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-79" />
                        <use fill="black" fill-opacity="1" filter="url(#filter-80)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-79" />
                        <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-79" />
                    </g>
                    <g id="svg_66a11eb7ee05ff53cd13_Rectangle">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-81" />
                        <use fill="black" fill-opacity="1" filter="url(#filter-82)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-81" />
                        <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-81" />
                    </g>
                    <g id="svg_66a11eb7ee05ff53cd13_Rectangle-Copy-6">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-83" />
                        <use fill="black" fill-opacity="1" filter="url(#filter-84)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-83" />
                        <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-83" />
                    </g>
                    <g id="svg_66a11eb7ee05ff53cd13_Rectangle-Copy">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-85" />
                        <use fill="black" fill-opacity="1" filter="url(#filter-86)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-85" />
                        <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-85" />
                    </g>
                    <g id="svg_66a11eb7ee05ff53cd13_Rectangle-Copy-7">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-87" />
                        <use fill="black" fill-opacity="1" filter="url(#filter-88)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-87" />
                        <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-87" />
                    </g>
                    <g id="svg_66a11eb7ee05ff53cd13_Rectangle-Copy-2">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-89" />
                        <use fill="black" fill-opacity="1" filter="url(#filter-90)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-89" />
                        <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-89" />
                    </g>
                    <g id="svg_66a11eb7ee05ff53cd13_Rectangle-Copy-8">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-91" />
                        <use fill="black" fill-opacity="1" filter="url(#filter-92)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-91" />
                        <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-91" />
                    </g>
                </g>
                <rect id="svg_66a11eb7ee05ff53cd13_Rectangle-2" stroke="#000000" stroke-width="8" stroke-linejoin="round" x="0" y="0" width="300" height="100" />
                <rect id="svg_66a11eb7ee05ff53cd13_Rectangle-2" stroke="#000000" stroke-width="8" stroke-linejoin="round" x="360" y="0" width="300" height="100" />
                <rect id="svg_66a11eb7ee05ff53cd13_Rectangle-2" stroke="#000000" stroke-width="8" stroke-linejoin="round" x="720" y="0" width="300" height="100" />
                <rect id="svg_66a11eb7ee05ff53cd13_Rectangle-2" stroke="#000000" stroke-width="8" stroke-linejoin="round" x="1080" y="0" width="300" height="100" />
                <use id="svg_66a11eb7ee05ff53cd13_Oval-1-Copy-8" stroke="#000000" mask="url(#mask-94)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-93" />
                <use id="svg_66a11eb7ee05ff53cd13_Oval-1-Copy-9" stroke="#000000" mask="url(#mask-96)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-95" />
                <use id="svg_66a11eb7ee05ff53cd13_Oval-1-Copy-10" stroke="#000000" mask="url(#mask-98)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-97" />
                <use id="svg_66a11eb7ee05ff53cd13_Oval-1-Copy-8" stroke="#000000" mask="url(#mask-100)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-99" />
                <use id="svg_66a11eb7ee05ff53cd13_Oval-1-Copy-9" stroke="#000000" mask="url(#mask-102)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-101" />
                <use id="svg_66a11eb7ee05ff53cd13_Oval-1-Copy-10" stroke="#000000" mask="url(#mask-104)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-103" />
                <use id="svg_66a11eb7ee05ff53cd13_Oval-1-Copy-8" stroke="#000000" mask="url(#mask-106)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-105" />
                <use id="svg_66a11eb7ee05ff53cd13_Oval-1-Copy-9" stroke="#000000" mask="url(#mask-108)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-107" />
                <use id="svg_66a11eb7ee05ff53cd13_Oval-1-Copy-10" stroke="#000000" mask="url(#mask-110)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-109" />
                <use id="svg_66a11eb7ee05ff53cd13_Oval-1-Copy-8" stroke="#000000" mask="url(#mask-112)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-111" />
                <use id="svg_66a11eb7ee05ff53cd13_Oval-1-Copy-9" stroke="#000000" mask="url(#mask-114)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-113" />
                <use id="svg_66a11eb7ee05ff53cd13_Oval-1-Copy-10" stroke="#000000" mask="url(#mask-116)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-115" />
            </g>
            <g id="svg_66a11eb7ee05ff53cd13_initial-A" transform="translate(110.000000, 160.000000)">
                <g id="svg_66a11eb7ee05ff53cd13_Rectangle">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-117" />
                    <use fill="black" fill-opacity="1" filter="url(#filter-118)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-117" />
                    <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-117" />
                </g>
                <g id="svg_66a11eb7ee05ff53cd13_Rectangle-Copy-3">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-119" />
                    <use fill="black" fill-opacity="1" filter="url(#filter-120)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-119" />
                    <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-119" />
                </g>
                <g id="svg_66a11eb7ee05ff53cd13_Rectangle">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-121" />
                    <use fill="black" fill-opacity="1" filter="url(#filter-122)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-121" />
                    <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-121" />
                </g>
                <g id="svg_66a11eb7ee05ff53cd13_Rectangle-Copy-4">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-123" />
                    <use fill="black" fill-opacity="1" filter="url(#filter-124)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-123" />
                    <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-123" />
                </g>
                <g id="svg_66a11eb7ee05ff53cd13_Rectangle">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-125" />
                    <use fill="black" fill-opacity="1" filter="url(#filter-126)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-125" />
                    <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-125" />
                </g>
                <g id="svg_66a11eb7ee05ff53cd13_Rectangle-Copy-5">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-127" />
                    <use fill="black" fill-opacity="1" filter="url(#filter-128)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-127" />
                    <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-127" />
                </g>
                <g id="svg_66a11eb7ee05ff53cd13_Rectangle">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-129" />
                    <use fill="black" fill-opacity="1" filter="url(#filter-130)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-129" />
                    <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-129" />
                </g>
                <g id="svg_66a11eb7ee05ff53cd13_Rectangle-Copy-6">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-131" />
                    <use fill="black" fill-opacity="1" filter="url(#filter-132)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-131" />
                    <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-131" />
                </g>
                <g id="svg_66a11eb7ee05ff53cd13_Rectangle-Copy">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-133" />
                    <use fill="black" fill-opacity="1" filter="url(#filter-134)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-133" />
                    <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-133" />
                </g>
                <g id="svg_66a11eb7ee05ff53cd13_Rectangle-Copy-7">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-135" />
                    <use fill="black" fill-opacity="1" filter="url(#filter-136)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-135" />
                    <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-135" />
                </g>
                <g id="svg_66a11eb7ee05ff53cd13_Rectangle-Copy-2">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-137" />
                    <use fill="black" fill-opacity="1" filter="url(#filter-138)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-137" />
                    <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-137" />
                </g>
                <g id="svg_66a11eb7ee05ff53cd13_Rectangle-Copy-8">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_66a11eb7ee05ff53cd13_path-139" />
                    <use fill="black" fill-opacity="1" filter="url(#filter-140)" xlink:href="#svg_66a11eb7ee05ff53cd13_path-139" />
                    <use stroke="#000000" stroke-width="4" xlink:href="#svg_66a11eb7ee05ff53cd13_path-139" />
                </g>
                <rect id="svg_66a11eb7ee05ff53cd13_Rectangle-2" stroke="#000000" stroke-width="8" stroke-linejoin="round" x="0" y="0" width="300" height="100" />
                <rect id="svg_66a11eb7ee05ff53cd13_Rectangle-2" stroke="#000000" stroke-width="8" stroke-linejoin="round" x="300" y="0" width="300" height="100" />
                <rect id="svg_66a11eb7ee05ff53cd13_Rectangle-2" stroke="#000000" stroke-width="8" stroke-linejoin="round" x="600" y="0" width="300" height="100" />
                <rect id="svg_66a11eb7ee05ff53cd13_Rectangle-2" stroke="#000000" stroke-width="8" stroke-linejoin="round" x="900" y="0" width="300" height="100" />
                <use id="svg_66a11eb7ee05ff53cd13_Oval-1-Copy" stroke="#000000" mask="url(#mask-142)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-141" />
                <use id="svg_66a11eb7ee05ff53cd13_Oval-1-Copy" stroke="#000000" mask="url(#mask-144)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-143" />
                <use id="svg_66a11eb7ee05ff53cd13_Oval-1-Copy" stroke="#000000" mask="url(#mask-146)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-145" />
                <use id="svg_66a11eb7ee05ff53cd13_Oval-1-Copy" stroke="#000000" mask="url(#mask-148)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-147" />
                <use id="svg_66a11eb7ee05ff53cd13_Oval-1-Copy-2" stroke="#000000" mask="url(#mask-150)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-149" />
                <use id="svg_66a11eb7ee05ff53cd13_Oval-1-Copy-5" stroke="#000000" mask="url(#mask-152)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-151" />
                <use id="svg_66a11eb7ee05ff53cd13_Oval-1-Copy" stroke="#000000" mask="url(#mask-154)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-153" />
                <use id="svg_66a11eb7ee05ff53cd13_Oval-1-Copy-3" stroke="#000000" mask="url(#mask-156)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-155" />
                <use id="svg_66a11eb7ee05ff53cd13_Oval-1-Copy-6" stroke="#000000" mask="url(#mask-158)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-157" />
                <use id="svg_66a11eb7ee05ff53cd13_Oval-1-Copy" stroke="#000000" mask="url(#mask-160)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-159" />
                <use id="svg_66a11eb7ee05ff53cd13_Oval-1-Copy-4" stroke="#000000" mask="url(#mask-162)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-161" />
                <use id="svg_66a11eb7ee05ff53cd13_Oval-1-Copy-7" stroke="#000000" mask="url(#mask-164)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_66a11eb7ee05ff53cd13_path-163" />
            </g>
            <text id="svg_66a11eb7ee05ff53cd13_result-label" font-family="Helvetica" font-size="36" font-weight="normal" fill="#000000">
                <tspan x="602.456055" y="1572">6. Final result</tspan>
            </text>
            <g id="svg_66a11eb7ee05ff53cd13_reduce-all-label" transform="translate(271.000000, 1211.000000)">
                <polygon id="svg_66a11eb7ee05ff53cd13_Path-1-Copy-2" fill="#F6A623" transform="translate(56.568542, 56.568542) rotate(-315.000000) translate(-56.568542, -56.568542) " points="16.5685425 36.5685425 56.5685425 36.5685425 56.5685425 16.5685425 96.5685425 56.0663096 56.5685425 96.5685425 56.5685425 76.5685425 16.5685425 76.5685425"></polygon>
                <polygon id="svg_66a11eb7ee05ff53cd13_Path-1-Copy-2" fill="#F6A623" transform="translate(349.449439, 57.449439) rotate(-293.000000) translate(-349.449439, -57.449439) " points="309.449439 37.4494393 349.449439 37.4494393 349.449439 17.4494393 389.449439 56.9472064 349.449439 97.4494393 349.449439 77.4494393 309.449439 77.4494393"></polygon>
                <polygon id="svg_66a11eb7ee05ff53cd13_Path-1-Copy-2" fill="#F6A623" transform="translate(553.449439, 57.449439) rotate(-247.000000) translate(-553.449439, -57.449439) " points="513.449439 37.4494393 553.449439 37.4494393 553.449439 17.4494393 593.449439 56.9472064 553.449439 97.4494393 553.449439 77.4494393 513.449439 77.4494393"></polygon>
                <polygon id="svg_66a11eb7ee05ff53cd13_Path-1-Copy-3" fill="#F6A623" transform="translate(819.568542, 57.568542) rotate(-225.000000) translate(-819.568542, -57.568542) " points="779.568542 37.5685425 819.568542 37.5685425 819.568542 17.5685425 859.568542 57.0663096 819.568542 97.5685425 819.568542 77.5685425 779.568542 77.5685425"></polygon>
                <text id="svg_66a11eb7ee05ff53cd13_5.-Reduce-the-batche" font-family="Helvetica" font-size="36" font-weight="normal" fill="#000000">
                    <tspan x="259.376953" y="61">5. Reduce the batches</tspan>
                </text>
            </g>
            <g id="svg_66a11eb7ee05ff53cd13_reduce-batches-label" transform="translate(130.000000, 928.000000)">
                <polygon id="svg_66a11eb7ee05ff53cd13_Path-1-Copy-2" fill="#F6A623" transform="translate(40.071618, 40.000000) rotate(-270.000000) translate(-40.071618, -40.000000) " points="0.0716179193 20 40.0716179 20 40.0716179 3.55271368e-15 80.0716179 39.4977671 40.0716179 80 40.0716179 60 0.0716179193 60"></polygon>
                <polygon id="svg_66a11eb7ee05ff53cd13_Path-1-Copy-2" fill="#F6A623" transform="translate(401.177647, 40.106029) rotate(-270.000000) translate(-401.177647, -40.106029) " points="361.177647 20.1060289 401.177647 20.1060289 401.177647 0.106028869 441.177647 39.603796 401.177647 80.1060289 401.177647 60.1060289 361.177647 60.1060289"></polygon>
                <polygon id="svg_66a11eb7ee05ff53cd13_Path-1-Copy-2" fill="#F6A623" transform="translate(761.177647, 40.106029) rotate(-270.000000) translate(-761.177647, -40.106029) " points="721.177647 20.1060289 761.177647 20.1060289 761.177647 0.106028869 801.177647 39.603796 761.177647 80.1060289 761.177647 60.1060289 721.177647 60.1060289"></polygon>
                <polygon id="svg_66a11eb7ee05ff53cd13_Path-1-Copy-3" fill="#F6A623" transform="translate(1121.000000, 40.000000) rotate(-270.000000) translate(-1121.000000, -40.000000) " points="1081 20 1121 20 1121 3.55271368e-15 1161 39.4977671 1121 80 1121 60 1081 60"></polygon>
                <text id="svg_66a11eb7ee05ff53cd13_4.-Reduce-each-batch" font-family="Helvetica" font-size="36" font-weight="normal" fill="#000000">
                    <tspan x="323.332031" y="44">4. Reduce each batch in parallel</tspan>
                </text>
            </g>
            <g id="svg_66a11eb7ee05ff53cd13_map-label" transform="translate(130.000000, 630.000000)">
                <polygon id="svg_66a11eb7ee05ff53cd13_Path-1-Copy-2" fill="#F6A623" transform="translate(40.000000, 40.000000) rotate(-270.000000) translate(-40.000000, -40.000000) " points="0 20 40 20 40 3.55271368e-15 80 39.4977671 40 80 40 60 0 60"></polygon>
                <polygon id="svg_66a11eb7ee05ff53cd13_Path-1-Copy-2" fill="#F6A623" transform="translate(401.000000, 40.000000) rotate(-270.000000) translate(-401.000000, -40.000000) " points="361 20 401 20 401 3.55271368e-15 441 39.4977671 401 80 401 60 361 60"></polygon>
                <polygon id="svg_66a11eb7ee05ff53cd13_Path-1-Copy-2" fill="#F6A623" transform="translate(761.000000, 40.000000) rotate(-270.000000) translate(-761.000000, -40.000000) " points="721 20 761 20 761 3.55271368e-15 801 39.4977671 761 80 761 60 721 60"></polygon>
                <polygon id="svg_66a11eb7ee05ff53cd13_Path-1-Copy-3" fill="#F6A623" transform="translate(1121.000000, 40.000000) rotate(-270.000000) translate(-1121.000000, -40.000000) " points="1081 20 1121 20 1121 3.55271368e-15 1161 39.4977671 1121 80 1121 60 1081 60"></polygon>
                <text id="svg_66a11eb7ee05ff53cd13_3.-Map-over-the-batc" font-family="Helvetica" font-size="36" font-weight="normal" fill="#000000">
                    <tspan x="305.34082" y="42">3. Map over the batches in parallel</tspan>
                </text>
            </g>
            <g id="svg_66a11eb7ee05ff53cd13_divide-label" transform="translate(156.000000, 316.000000)">
                <polygon id="svg_66a11eb7ee05ff53cd13_Path-1-Copy-2" fill="#F6A623" transform="translate(52.071618, 52.071618) rotate(-248.000000) translate(-52.071618, -52.071618) " points="12.0716179 32.0716179 52.0716179 32.0716179 52.0716179 12.0716179 92.0716179 51.569385 52.0716179 92.0716179 52.0716179 72.0716179 12.0716179 72.0716179"></polygon>
                <polygon id="svg_66a11eb7ee05ff53cd13_Path-1-Copy-2" fill="#F6A623" transform="translate(388.000000, 52.000000) rotate(-262.000000) translate(-388.000000, -52.000000) " points="348 32 388 32 388 12 428 51.4977671 388 92 388 72 348 72"></polygon>
                <polygon id="svg_66a11eb7ee05ff53cd13_Path-1-Copy-2" fill="#F6A623" transform="translate(720.000000, 52.000000) rotate(-278.000000) translate(-720.000000, -52.000000) " points="680 32 720 32 720 12 760 51.4977671 720 92 720 72 680 72"></polygon>
                <polygon id="svg_66a11eb7ee05ff53cd13_Path-1-Copy-3" fill="#F6A623" transform="translate(1053.475962, 52.475962) rotate(-290.000000) translate(-1053.475962, -52.475962) " points="1013.47596 32.4759621 1053.47596 32.4759621 1053.47596 12.4759621 1093.47596 51.9737292 1053.47596 92.4759621 1053.47596 72.4759621 1013.47596 72.4759621"></polygon>
                <text id="svg_66a11eb7ee05ff53cd13_2.-Divide-into-batch" font-family="Helvetica" font-size="36" font-weight="normal" fill="#000000">
                    <tspan x="269.356445" y="56">2. Divide into batches for each CPU</tspan>
                </text>
            </g>
            <text id="svg_66a11eb7ee05ff53cd13_initial-label" font-family="Helvetica" font-size="36" font-weight="normal" fill="#000000">
                <tspan x="525.367188" y="91">1. Initial data sequence</tspan>
            </text>
        </g>
    </g>
</svg>
    <figcaption>Figure 17: <em>parallelFoldMap</em>
    algorithm</figcaption>
    </figure>
    <p>Scala provides some simple tools to distribute work amongst
    threads. We could use the <a href="http://docs.scala-lang.org/overviews/parallel-collections/overview.html">parallel
    collections library</a> to implement a solution, but let’s challenge
    ourselves by diving a bit deeper and implementing the algorithm
    ourselves using <code>Futures</code>.</p>
    <h3 data-number="17.3.1" id="futures-thread-pools-and-executioncontexts"><span class="header-section-number">17.3.1</span> <em>Futures</em>, Thread
    Pools, and ExecutionContexts</h3>
    <p>We already know a fair amount about the monadic nature of
    <code>Futures</code>. Let’s take a moment for a quick recap, and to
    describe how Scala futures are scheduled behind the scenes.</p>
    <p><code>Futures</code> run on a thread pool, determined by an
    implicit <code>ExecutionContext</code> parameter. Whenever we create
    a <code>Future</code>, whether through a call to
    <code>Future.apply</code> or some other combinator, we must have an
    implicit <code>ExecutionContext</code> in scope:</p>
    <div class="sourceCode" id="cb906"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb906-1"><a href="#cb906-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span><span class="ex">Future</span></span>
<span id="cb906-2"><a href="#cb906-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span>ExecutionContext<span class="op">.</span>Implicits<span class="op">.</span>global</span></code></pre></div>
    <div class="sourceCode" id="cb907"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb907-1"><a href="#cb907-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> future1 <span class="op">=</span> <span class="ex">Future</span> <span class="op">{</span></span>
<span id="cb907-2"><a href="#cb907-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">(</span><span class="dv">1</span> to <span class="dv">100</span><span class="op">).</span>toList<span class="op">.</span><span class="fu">foldLeft</span><span class="op">(</span><span class="dv">0</span><span class="op">)(</span>_ <span class="op">+</span> _<span class="op">)</span></span>
<span id="cb907-3"><a href="#cb907-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb907-4"><a href="#cb907-4" aria-hidden="true" tabindex="-1"></a><span class="co">// future1: Future[Int] = Future(Success(5050))</span></span>
<span id="cb907-5"><a href="#cb907-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb907-6"><a href="#cb907-6" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> future2 <span class="op">=</span> <span class="ex">Future</span> <span class="op">{</span></span>
<span id="cb907-7"><a href="#cb907-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">(</span><span class="dv">100</span> to <span class="dv">200</span><span class="op">).</span>toList<span class="op">.</span><span class="fu">foldLeft</span><span class="op">(</span><span class="dv">0</span><span class="op">)(</span>_ <span class="op">+</span> _<span class="op">)</span></span>
<span id="cb907-8"><a href="#cb907-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb907-9"><a href="#cb907-9" aria-hidden="true" tabindex="-1"></a><span class="co">// future2: Future[Int] = Future(Success(15150))</span></span></code></pre></div>
    <p>In this example we’ve imported a
    <code>ExecutionContext.Implicits.global</code>. This default context
    allocates a thread pool with one thread per CPU in our machine. When
    we create a <code>Future</code> the <code>ExecutionContext</code>
    schedules it for execution. If there is a free thread in the pool,
    the <code>Future</code> starts executing immediately. Most modern
    machines have at least two CPUs, so in our example it is likely that
    <code>future1</code> and <code>future2</code> will execute in
    parellel.</p>
    <p>Some combinators create new <code>Futures</code> that schedule
    work based on the results of other <code>Futures</code>. The
    <code>map</code> and <code>flatMap</code> methods, for example,
    schedule computations that run as soon as their input values are
    computed and a CPU is available:</p>
    <div class="sourceCode" id="cb908"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb908-1"><a href="#cb908-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> future3 <span class="op">=</span> future1<span class="op">.</span><span class="fu">map</span><span class="op">(</span>_<span class="op">.</span>toString<span class="op">)</span></span>
<span id="cb908-2"><a href="#cb908-2" aria-hidden="true" tabindex="-1"></a><span class="co">// future3: Future[String] = Future(Success(5050))</span></span>
<span id="cb908-3"><a href="#cb908-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb908-4"><a href="#cb908-4" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> future4 <span class="op">=</span> <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb908-5"><a href="#cb908-5" aria-hidden="true" tabindex="-1"></a>  a <span class="op">&lt;-</span> future1</span>
<span id="cb908-6"><a href="#cb908-6" aria-hidden="true" tabindex="-1"></a>  b <span class="op">&lt;-</span> future2</span>
<span id="cb908-7"><a href="#cb908-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">yield</span> a <span class="op">+</span> b</span>
<span id="cb908-8"><a href="#cb908-8" aria-hidden="true" tabindex="-1"></a><span class="co">// future4: Future[Int] = Future(Success(20200))</span></span></code></pre></div>
    <p>As we saw in Section 12.2, we can convert a
    <code>List[Future[A]]</code> to a <code>Future[List[A]]</code> using
    <code>Future.sequence</code>:</p>
    <div class="sourceCode" id="cb909"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb909-1"><a href="#cb909-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Future</span><span class="op">.</span><span class="fu">sequence</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="ex">Future</span><span class="op">(</span><span class="dv">1</span><span class="op">),</span> <span class="ex">Future</span><span class="op">(</span><span class="dv">2</span><span class="op">),</span> <span class="ex">Future</span><span class="op">(</span><span class="dv">3</span><span class="op">)))</span></span>
<span id="cb909-2"><a href="#cb909-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res6: Future[List[Int]] = Future(Success(List(1, 2, 3)))</span></span></code></pre></div>
    <p>or an instance of <code>Traverse</code>:</p>
    <div class="sourceCode" id="cb910"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb910-1"><a href="#cb910-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>future<span class="op">.</span>_ <span class="co">// for Applicative</span></span>
<span id="cb910-2"><a href="#cb910-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>list<span class="op">.</span>_   <span class="co">// for Traverse</span></span>
<span id="cb910-3"><a href="#cb910-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>traverse<span class="op">.</span>_  <span class="co">// for sequence</span></span></code></pre></div>
    <div class="sourceCode" id="cb911"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb911-1"><a href="#cb911-1" aria-hidden="true" tabindex="-1"></a><span class="ex">List</span><span class="op">(</span><span class="ex">Future</span><span class="op">(</span><span class="dv">1</span><span class="op">),</span> <span class="ex">Future</span><span class="op">(</span><span class="dv">2</span><span class="op">),</span> <span class="ex">Future</span><span class="op">(</span><span class="dv">3</span><span class="op">)).</span>sequence</span>
<span id="cb911-2"><a href="#cb911-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res7: Future[List[Int]] = Future(Success(List(1, 2, 3)))</span></span></code></pre></div>
    <p>An <code>ExecutionContext</code> is required in either case.
    Finally, we can use <code>Await.result</code> to block on a
    <code>Future</code> until a result is available:</p>
    <div class="sourceCode" id="cb912"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb912-1"><a href="#cb912-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span>_</span>
<span id="cb912-2"><a href="#cb912-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span>duration<span class="op">.</span>_</span></code></pre></div>
    <div class="sourceCode" id="cb913"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb913-1"><a href="#cb913-1" aria-hidden="true" tabindex="-1"></a>Await<span class="op">.</span><span class="fu">result</span><span class="op">(</span><span class="ex">Future</span><span class="op">(</span><span class="dv">1</span><span class="op">),</span> <span class="fl">1.</span>second<span class="op">)</span> <span class="co">// wait for the result</span></span>
<span id="cb913-2"><a href="#cb913-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res8: Int = 1</span></span></code></pre></div>
    <p>There are also <code>Monad</code> and <code>Monoid</code>
    implementations for <code>Future</code> available from
    <code>cats.instances.future</code>:</p>
    <div class="sourceCode" id="cb914"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb914-1"><a href="#cb914-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.{</span>Monad<span class="op">,</span> Monoid<span class="op">}</span></span>
<span id="cb914-2"><a href="#cb914-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span><span class="dt">int</span><span class="op">.</span>_    <span class="co">// for Monoid</span></span>
<span id="cb914-3"><a href="#cb914-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>future<span class="op">.</span>_ <span class="co">// for Monad and Monoid</span></span>
<span id="cb914-4"><a href="#cb914-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb914-5"><a href="#cb914-5" aria-hidden="true" tabindex="-1"></a>Monad<span class="op">[</span><span class="ex">Future</span><span class="op">].</span><span class="fu">pure</span><span class="op">(</span><span class="dv">42</span><span class="op">)</span></span>
<span id="cb914-6"><a href="#cb914-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb914-7"><a href="#cb914-7" aria-hidden="true" tabindex="-1"></a>Monoid<span class="op">[</span><span class="ex">Future</span><span class="op">[</span><span class="bu">Int</span><span class="op">]].</span><span class="fu">combine</span><span class="op">(</span><span class="ex">Future</span><span class="op">(</span><span class="dv">1</span><span class="op">),</span> <span class="ex">Future</span><span class="op">(</span><span class="dv">2</span><span class="op">))</span></span></code></pre></div>
    <h3 data-number="17.3.2" id="dividing-work"><span class="header-section-number">17.3.2</span> Dividing Work</h3>
    <p>Now we’ve refreshed our memory of <code>Futures</code>, let’s
    look at how we can divide work into batches. We can query the number
    of available CPUs on our machine using an API call from the Java
    standard library:</p>
    <div class="sourceCode" id="cb915"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb915-1"><a href="#cb915-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Runtime</span><span class="op">.</span>getRuntime<span class="op">.</span>availableProcessors</span>
<span id="cb915-2"><a href="#cb915-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res11: Int = 4</span></span></code></pre></div>
    <p>We can partition a sequence (actually anything that implements
    <code>Vector</code>) using the <code>grouped</code> method. We’ll
    use this to split off batches of work for each CPU:</p>
    <div class="sourceCode" id="cb916"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb916-1"><a href="#cb916-1" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="dv">1</span> to <span class="dv">10</span><span class="op">).</span>toList<span class="op">.</span><span class="fu">grouped</span><span class="op">(</span><span class="dv">3</span><span class="op">).</span>toList</span>
<span id="cb916-2"><a href="#cb916-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res12: List[List[Int]] = List(</span></span>
<span id="cb916-3"><a href="#cb916-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   List(1, 2, 3),</span></span>
<span id="cb916-4"><a href="#cb916-4" aria-hidden="true" tabindex="-1"></a><span class="co">//   List(4, 5, 6),</span></span>
<span id="cb916-5"><a href="#cb916-5" aria-hidden="true" tabindex="-1"></a><span class="co">//   List(7, 8, 9),</span></span>
<span id="cb916-6"><a href="#cb916-6" aria-hidden="true" tabindex="-1"></a><span class="co">//   List(10)</span></span>
<span id="cb916-7"><a href="#cb916-7" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <h3 data-number="17.3.3" id="implementing-parallelfoldmap"><span class="header-section-number">17.3.3</span> Implementing
    <em>parallelFoldMap</em></h3>
    <p>Implement a parallel version of <code>foldMap</code> called
    <code>parallelFoldMap</code>. Here is the type signature:</p>
    <div class="sourceCode" id="cb917"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb917-1"><a href="#cb917-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parallelFoldMap<span class="op">[</span>A<span class="op">,</span> B <span class="op">:</span> Monoid<span class="op">]</span></span>
<span id="cb917-2"><a href="#cb917-2" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>values<span class="op">:</span> <span class="ex">Vector</span><span class="op">[</span>A<span class="op">])</span></span>
<span id="cb917-3"><a href="#cb917-3" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> <span class="ex">Future</span><span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> <span class="op">???</span></span></code></pre></div>
    <p>Use the techniques described above to split the work into
    batches, one batch per CPU. Process each batch in a parallel thread.
    Refer back to Figure 17 if you need to review the overall
    algorithm.</p>
    <p>For bonus points, process the batches for each CPU using your
    implementation of <code>foldMap</code> from above.</p>
    <div class="solution">
    <p>Here is an annotated solution that splits out each
    <code>map</code> and <code>fold</code> into a separate line of
    code:</p>
    <div class="sourceCode" id="cb918"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb918-1"><a href="#cb918-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parallelFoldMap<span class="op">[</span>A<span class="op">,</span> B<span class="op">:</span> Monoid<span class="op">]</span></span>
<span id="cb918-2"><a href="#cb918-2" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>values<span class="op">:</span> <span class="ex">Vector</span><span class="op">[</span>A<span class="op">])</span></span>
<span id="cb918-3"><a href="#cb918-3" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> <span class="ex">Future</span><span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb918-4"><a href="#cb918-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Calculate the number of items to pass to each CPU:</span></span>
<span id="cb918-5"><a href="#cb918-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> numCores  <span class="op">=</span> <span class="ex">Runtime</span><span class="op">.</span>getRuntime<span class="op">.</span>availableProcessors</span>
<span id="cb918-6"><a href="#cb918-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> groupSize <span class="op">=</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">*</span> values<span class="op">.</span>size <span class="op">/</span> numCores<span class="op">).</span>ceil<span class="op">.</span>toInt</span>
<span id="cb918-7"><a href="#cb918-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb918-8"><a href="#cb918-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create one group for each CPU:</span></span>
<span id="cb918-9"><a href="#cb918-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> groups<span class="op">:</span> <span class="ex">Iterator</span><span class="op">[</span><span class="ex">Vector</span><span class="op">[</span>A<span class="op">]]</span> <span class="op">=</span></span>
<span id="cb918-10"><a href="#cb918-10" aria-hidden="true" tabindex="-1"></a>    values<span class="op">.</span><span class="fu">grouped</span><span class="op">(</span>groupSize<span class="op">)</span></span>
<span id="cb918-11"><a href="#cb918-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb918-12"><a href="#cb918-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create a future to foldMap each group:</span></span>
<span id="cb918-13"><a href="#cb918-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> futures<span class="op">:</span> <span class="ex">Iterator</span><span class="op">[</span><span class="ex">Future</span><span class="op">[</span>B<span class="op">]]</span> <span class="op">=</span></span>
<span id="cb918-14"><a href="#cb918-14" aria-hidden="true" tabindex="-1"></a>    groups map <span class="op">{</span> group <span class="op">=&gt;</span></span>
<span id="cb918-15"><a href="#cb918-15" aria-hidden="true" tabindex="-1"></a>      <span class="ex">Future</span> <span class="op">{</span></span>
<span id="cb918-16"><a href="#cb918-16" aria-hidden="true" tabindex="-1"></a>        group<span class="op">.</span><span class="fu">foldLeft</span><span class="op">(</span>Monoid<span class="op">[</span>B<span class="op">].</span>empty<span class="op">)(</span>_ <span class="op">|+|</span> <span class="fu">func</span><span class="op">(</span>_<span class="op">))</span></span>
<span id="cb918-17"><a href="#cb918-17" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb918-18"><a href="#cb918-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb918-19"><a href="#cb918-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb918-20"><a href="#cb918-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">// foldMap over the groups to calculate a final result:</span></span>
<span id="cb918-21"><a href="#cb918-21" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Future</span><span class="op">.</span><span class="fu">sequence</span><span class="op">(</span>futures<span class="op">)</span> map <span class="op">{</span> iterable <span class="op">=&gt;</span></span>
<span id="cb918-22"><a href="#cb918-22" aria-hidden="true" tabindex="-1"></a>    iterable<span class="op">.</span><span class="fu">foldLeft</span><span class="op">(</span>Monoid<span class="op">[</span>B<span class="op">].</span>empty<span class="op">)(</span>_ <span class="op">|+|</span> _<span class="op">)</span></span>
<span id="cb918-23"><a href="#cb918-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb918-24"><a href="#cb918-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb918-25"><a href="#cb918-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb918-26"><a href="#cb918-26" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> result<span class="op">:</span> <span class="ex">Future</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb918-27"><a href="#cb918-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parallelFoldMap</span><span class="op">((</span><span class="dv">1</span> to <span class="dv">1000000</span><span class="op">).</span>toVector<span class="op">)(</span>identity<span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb919"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb919-1"><a href="#cb919-1" aria-hidden="true" tabindex="-1"></a>Await<span class="op">.</span><span class="fu">result</span><span class="op">(</span>result<span class="op">,</span> <span class="fl">1.</span>second<span class="op">)</span></span>
<span id="cb919-2"><a href="#cb919-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res14: Int = 1784293664</span></span></code></pre></div>
    <p>We can re-use our definition of <code>foldMap</code> for a more
    concise solution. Note that the local maps and reduces in steps 3
    and 4 of Figure 17 are actually equivalent to a single call to
    <code>foldMap</code>, shortening the entire algorithm as
    follows:</p>
    <div class="sourceCode" id="cb920"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb920-1"><a href="#cb920-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parallelFoldMap<span class="op">[</span>A<span class="op">,</span> B<span class="op">:</span> Monoid<span class="op">]</span></span>
<span id="cb920-2"><a href="#cb920-2" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>values<span class="op">:</span> <span class="ex">Vector</span><span class="op">[</span>A<span class="op">])</span></span>
<span id="cb920-3"><a href="#cb920-3" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> <span class="ex">Future</span><span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb920-4"><a href="#cb920-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> numCores  <span class="op">=</span> <span class="ex">Runtime</span><span class="op">.</span>getRuntime<span class="op">.</span>availableProcessors</span>
<span id="cb920-5"><a href="#cb920-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> groupSize <span class="op">=</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">*</span> values<span class="op">.</span>size <span class="op">/</span> numCores<span class="op">).</span>ceil<span class="op">.</span>toInt</span>
<span id="cb920-6"><a href="#cb920-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb920-7"><a href="#cb920-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> groups<span class="op">:</span> <span class="ex">Iterator</span><span class="op">[</span><span class="ex">Vector</span><span class="op">[</span>A<span class="op">]]</span> <span class="op">=</span></span>
<span id="cb920-8"><a href="#cb920-8" aria-hidden="true" tabindex="-1"></a>    values<span class="op">.</span><span class="fu">grouped</span><span class="op">(</span>groupSize<span class="op">)</span></span>
<span id="cb920-9"><a href="#cb920-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb920-10"><a href="#cb920-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> futures<span class="op">:</span> <span class="ex">Iterator</span><span class="op">[</span><span class="ex">Future</span><span class="op">[</span>B<span class="op">]]</span> <span class="op">=</span></span>
<span id="cb920-11"><a href="#cb920-11" aria-hidden="true" tabindex="-1"></a>    groups<span class="op">.</span><span class="fu">map</span><span class="op">(</span>group <span class="op">=&gt;</span> <span class="ex">Future</span><span class="op">(</span><span class="fu">foldMap</span><span class="op">(</span>group<span class="op">)(</span>func<span class="op">)))</span></span>
<span id="cb920-12"><a href="#cb920-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb920-13"><a href="#cb920-13" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Future</span><span class="op">.</span><span class="fu">sequence</span><span class="op">(</span>futures<span class="op">)</span> map <span class="op">{</span> iterable <span class="op">=&gt;</span></span>
<span id="cb920-14"><a href="#cb920-14" aria-hidden="true" tabindex="-1"></a>    iterable<span class="op">.</span><span class="fu">foldLeft</span><span class="op">(</span>Monoid<span class="op">[</span>B<span class="op">].</span>empty<span class="op">)(</span>_ <span class="op">|+|</span> _<span class="op">)</span></span>
<span id="cb920-15"><a href="#cb920-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb920-16"><a href="#cb920-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb920-17"><a href="#cb920-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb920-18"><a href="#cb920-18" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> result<span class="op">:</span> <span class="ex">Future</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb920-19"><a href="#cb920-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parallelFoldMap</span><span class="op">((</span><span class="dv">1</span> to <span class="dv">1000000</span><span class="op">).</span>toVector<span class="op">)(</span>identity<span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb921"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb921-1"><a href="#cb921-1" aria-hidden="true" tabindex="-1"></a>Await<span class="op">.</span><span class="fu">result</span><span class="op">(</span>result<span class="op">,</span> <span class="fl">1.</span>second<span class="op">)</span></span>
<span id="cb921-2"><a href="#cb921-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res16: Int = 1784293664</span></span></code></pre></div>
    </div>
    <h3 data-number="17.3.4" id="parallelfoldmap-with-more-cats"><span class="header-section-number">17.3.4</span> <em>parallelFoldMap</em>
    with more Cats</h3>
    <p>Although we implemented <code>foldMap</code> ourselves above, the
    method is also available as part of the <code>Foldable</code> type
    class we discussed in Section 12.1.</p>
    <p>Reimplement <code>parallelFoldMap</code> using Cats’
    <code>Foldable</code> and <code>Traverseable</code> type
    classes.</p>
    <div class="solution">
    <p>We’ll restate all of the necessary imports for completeness:</p>
    <div class="sourceCode" id="cb922"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb922-1"><a href="#cb922-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Monoid</span>
<span id="cb922-2"><a href="#cb922-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb922-3"><a href="#cb922-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span><span class="dt">int</span><span class="op">.</span>_    <span class="co">// for Monoid</span></span>
<span id="cb922-4"><a href="#cb922-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>future<span class="op">.</span>_ <span class="co">// for Applicative and Monad</span></span>
<span id="cb922-5"><a href="#cb922-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>vector<span class="op">.</span>_ <span class="co">// for Foldable and Traverse</span></span>
<span id="cb922-6"><a href="#cb922-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb922-7"><a href="#cb922-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>foldable<span class="op">.</span>_  <span class="co">// for combineAll and foldMap</span></span>
<span id="cb922-8"><a href="#cb922-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>traverse<span class="op">.</span>_  <span class="co">// for traverse</span></span>
<span id="cb922-9"><a href="#cb922-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb922-10"><a href="#cb922-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span>_</span>
<span id="cb922-11"><a href="#cb922-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span>duration<span class="op">.</span>_</span>
<span id="cb922-12"><a href="#cb922-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>concurrent<span class="op">.</span>ExecutionContext<span class="op">.</span>Implicits<span class="op">.</span>global</span></code></pre></div>
    <p>Here’s the implementation of <code>parallelFoldMap</code>
    delegating as much of the method body to Cats as possible:</p>
    <div class="sourceCode" id="cb923"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb923-1"><a href="#cb923-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parallelFoldMap<span class="op">[</span>A<span class="op">,</span> B<span class="op">:</span> Monoid<span class="op">]</span></span>
<span id="cb923-2"><a href="#cb923-2" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>values<span class="op">:</span> <span class="ex">Vector</span><span class="op">[</span>A<span class="op">])</span></span>
<span id="cb923-3"><a href="#cb923-3" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> <span class="ex">Future</span><span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb923-4"><a href="#cb923-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> numCores  <span class="op">=</span> <span class="ex">Runtime</span><span class="op">.</span>getRuntime<span class="op">.</span>availableProcessors</span>
<span id="cb923-5"><a href="#cb923-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> groupSize <span class="op">=</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">*</span> values<span class="op">.</span>size <span class="op">/</span> numCores<span class="op">).</span>ceil<span class="op">.</span>toInt</span>
<span id="cb923-6"><a href="#cb923-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb923-7"><a href="#cb923-7" aria-hidden="true" tabindex="-1"></a>  values</span>
<span id="cb923-8"><a href="#cb923-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">grouped</span><span class="op">(</span>groupSize<span class="op">)</span></span>
<span id="cb923-9"><a href="#cb923-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>toVector</span>
<span id="cb923-10"><a href="#cb923-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">traverse</span><span class="op">(</span>group <span class="op">=&gt;</span> <span class="ex">Future</span><span class="op">(</span>group<span class="op">.</span>toVector<span class="op">.</span><span class="fu">foldMap</span><span class="op">(</span>func<span class="op">)))</span></span>
<span id="cb923-11"><a href="#cb923-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span><span class="op">(</span>_<span class="op">.</span>combineAll<span class="op">)</span></span>
<span id="cb923-12"><a href="#cb923-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <div class="sourceCode" id="cb924"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb924-1"><a href="#cb924-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> future<span class="op">:</span> <span class="ex">Future</span><span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb924-2"><a href="#cb924-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parallelFoldMap</span><span class="op">((</span><span class="dv">1</span> to <span class="dv">1000</span><span class="op">).</span>toVector<span class="op">)(</span>_ <span class="op">*</span> <span class="dv">1000</span><span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb925"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb925-1"><a href="#cb925-1" aria-hidden="true" tabindex="-1"></a>Await<span class="op">.</span><span class="fu">result</span><span class="op">(</span>future<span class="op">,</span> <span class="fl">1.</span>second<span class="op">)</span></span>
<span id="cb925-2"><a href="#cb925-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res18: Int = 500500000</span></span></code></pre></div>
    <p>The call to <code>vector.grouped</code> returns an
    <code>Iterable[Iterator[Int]]</code>. We sprinkle calls to
    <code>toVector</code> through the code to convert the data back to a
    form that Cats can understand. The call to <code>traverse</code>
    creates a <code>Future[Vector[Int]]</code> containing one
    <code>Int</code> per batch. The call to <code>map</code> then
    combines the <code>match</code> using the <code>combineAll</code>
    method from <code>Foldable</code>.</p>
    </div>
    <h2 data-number="17.4" id="summary-7"><span class="header-section-number">17.4</span> Summary</h2>
    <p>In this case study we implemented a system that imitates
    map-reduce as performed on a cluster. Our algorithm followed three
    steps:</p>
    <ol type="1">
    <li>batch the data and send one batch to each “node”;</li>
    <li>perform a local map-reduce on each batch;</li>
    <li>combine the results using monoid addition.</li>
    </ol>
    <p>Our toy system emulates the batching behaviour of real-world
    map-reduce systems such as Hadoop. However, in reality we are
    running all of our work on a single machine where communcation
    between nodes is negligible. We don’t actually need to batch data to
    gain efficient parallel processing of a list. We can simply map
    using a <code>Functor</code> and reduce using a
    <code>Monoid</code>.</p>
    <p>Regardless of the batching strategy, mapping and reducing with
    <code>Monoids</code> is a powerful and general framework that isn’t
    limited to simple tasks like addition and string concatenation. Most
    of the tasks data scientists perform in their day-to-day analyses
    can be cast as monoids. There are monoids for all the following:</p>
    <ul>
    <li>approximate sets such as the Bloom filter;</li>
    <li>set cardinality estimators, such as the HyperLogLog
    algorithm;</li>
    <li>vectors and vector operations like stochastic gradient
    descent;</li>
    <li>quantile estimators such as the t-digest</li>
    </ul>
    <p>to name but a few.</p>
    <h1 data-number="18" id="case-study-data-validation"><span class="header-section-number">18</span> Case Study: Data
    Validation</h1>
    <p>In this case study we will build a library for validation. What
    do we mean by validation? Almost all programs must check their input
    meets certain criteria. Usernames must not be blank, email addresses
    must be valid, and so on. This type of validation often occurs in
    web forms, but it could be performed on configuration files, on web
    service responses, and any other case where we have to deal with
    data that we can’t guarantee is correct. Authentication, for
    example, is just a specialised form of validation.</p>
    <p>We want to build a library that performs these checks. What
    design goals should we have? For inspiration, let’s look at some
    examples of the types of checks we want to perform:</p>
    <ul>
    <li><p>A user must be over 18 years old or must have parental
    consent.</p></li>
    <li><p>A <code>String</code> ID must be parsable as a
    <code>Int</code> and the <code>Int</code> must correspond to a valid
    record ID.</p></li>
    <li><p>A bid in an auction must apply to one or more items and have
    a positive value.</p></li>
    <li><p>A username must contain at least four characters and all
    characters must be alphanumeric.</p></li>
    <li><p>An email address must contain a single <code>@</code> sign.
    Split the string at the <code>@</code>. The string to the left must
    not be empty. The string to the right must be at least three
    characters long and contain a dot.</p></li>
    </ul>
    <p>With these examples in mind we can state some goals:</p>
    <ul>
    <li><p>We should be able to associate meaningful messages with each
    validation failure, so the user knows why their data is not
    valid.</p></li>
    <li><p>We should be able to combine small checks into larger ones.
    Taking the username example above, we should be able to express this
    by combining a check of length and a check for alphanumeric
    values.</p></li>
    <li><p>We should be able to transform data while we are checking it.
    There is an example above requiring we parse data, changing its type
    from <code>String</code> to <code>Int</code>.</p></li>
    <li><p>Finally, we should be able to accumulate all the failures in
    one go, so the user can correct all the issues before
    resubmitting.</p></li>
    </ul>
    <p>These goals assume we’re checking a single piece of data. We will
    also need to combine checks across multiple pieces of data. For a
    login form, for example, we’ll need to combine the check results for
    the username and the password. This will turn out to be quite a
    small component of the library, so the majority of our time will
    focus on checking a single data item.</p>
    <h2 data-number="18.1" id="sketching-the-library-structure"><span class="header-section-number">18.1</span> Sketching the Library
    Structure</h2>
    <p>Let’s start at the bottom, checking individual pieces of data.
    Before we start coding let’s try to develop a feel for what we’ll be
    building. We can use a graphical notation to help us. We’ll go
    through our goals one by one.</p>
    <p><strong>Providing error messages</strong></p>
    <p>Our first goal requires us to associate useful error messages
    with a check failure. The output of a check could be either the
    value being checked, if it passed the check, or some kind of error
    message. We can abstractly represent this as a value in a context,
    where the context is the possibility of an error message as shown in
    Figure 18.</p>
    <figure id="fig:validation:result">
    <svg id="svg_4bbc799254346bd7d403" alt="A validation result" width="1921px" height="360px" viewBox="0 0 1921 360">
    <!-- Generator: Sketch 43.2 (39069) - http://www.bohemiancoding.com/sketch -->
    <title>result</title>
    <desc>Created with Sketch.</desc>
    <defs>
        <circle id="svg_4bbc799254346bd7d403_path-1" cx="100" cy="100" r="80"></circle>
    </defs>
    <g id="svg_4bbc799254346bd7d403_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_4bbc799254346bd7d403_result">
            <rect id="svg_4bbc799254346bd7d403_Background" fill="#FFFFFF" x="0" y="0" width="1921" height="360" />
            <g id="svg_4bbc799254346bd7d403_Group-2" transform="translate(861.000000, 38.000000)">
                <text id="svg_4bbc799254346bd7d403_F[A]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                    <tspan x="50.1" y="276">F[A]</tspan>
                </text>
                <g id="svg_4bbc799254346bd7d403_Group-11">
                    <g id="svg_4bbc799254346bd7d403_Oval-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_4bbc799254346bd7d403_path-1" />
                        <circle stroke="#000000" stroke-width="4" cx="100" cy="100" r="78"></circle>
                    </g>
                    <rect id="svg_4bbc799254346bd7d403_Rectangle-1" stroke="#000000" stroke-width="4" x="2" y="2" width="196" height="196" rx="8" />
                </g>
            </g>
        </g>
    </g>
</svg>
    <figcaption>Figure 18: A validation result</figcaption>
    </figure>
    <p>A check itself is therefore a function that transforms a value
    into a value in a context as shown in Figure 19.</p>
    <figure id="fig:validation:check">
    <svg id="svg_30bd034281b37652e2d4" alt="A validation check" width="1921px" height="360px" viewBox="0 0 1921 360">
    <!-- Generator: Sketch 43.2 (39069) - http://www.bohemiancoding.com/sketch -->
    <title>check</title>
    <desc>Created with Sketch.</desc>
    <defs>
        <circle id="svg_30bd034281b37652e2d4_path-1" cx="80" cy="100" r="80"></circle>
        <circle id="svg_30bd034281b37652e2d4_path-2" cx="100" cy="100" r="80"></circle>
    </defs>
    <g id="svg_30bd034281b37652e2d4_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_30bd034281b37652e2d4_check">
            <rect id="svg_30bd034281b37652e2d4_Background" fill="#FFFFFF" x="0" y="0" width="1921" height="360" />
            <g id="svg_30bd034281b37652e2d4_Group-3" transform="translate(702.000000, 40.000000)">
                <g id="svg_30bd034281b37652e2d4_Oval-1">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_30bd034281b37652e2d4_path-1" />
                    <circle stroke="#000000" stroke-width="4" cx="80" cy="100" r="78"></circle>
                </g>
                <g id="svg_30bd034281b37652e2d4_Group" transform="translate(318.000000, 0.000000)">
                    <g id="svg_30bd034281b37652e2d4_Oval-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_30bd034281b37652e2d4_path-2" />
                        <circle stroke="#000000" stroke-width="4" cx="100" cy="100" r="78"></circle>
                    </g>
                    <rect id="svg_30bd034281b37652e2d4_Rectangle-1" stroke="#000000" stroke-width="4" x="2" y="2" width="196" height="196" rx="8" />
                </g>
                <polygon id="svg_30bd034281b37652e2d4_Path-1" fill="#000000" points="200 80 240 80 240 60 280 99.4977671 240 140 240 120 200 120"></polygon>
            </g>
            <text id="svg_30bd034281b37652e2d4_A-=&gt;-F[A]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="847.1" y="314">A =&gt; F[A]</tspan>
            </text>
        </g>
    </g>
</svg>
    <figcaption>Figure 19: A validation check</figcaption>
    </figure>
    <p><strong>Combine checks</strong></p>
    <p>How do we combine smaller checks into larger ones? Is this an
    applicative or semigroupal as shown in Figure 20?</p>
    <figure id="fig:validation:applicative">
    <svg id="svg_27a9d31282fa5cbeb137" alt="Applicative combination of checks" width="2017px" height="272px" viewBox="0 0 2017 272">
    <!-- Generator: Sketch 43.2 (39069) - http://www.bohemiancoding.com/sketch -->
    <title>applicative</title>
    <desc>Created with Sketch.</desc>
    <defs>
        <ellipse id="svg_27a9d31282fa5cbeb137_path-1" cx="68.1239804" cy="85.2105263" rx="68.1239804" ry="68.2105263"></ellipse>
        <ellipse id="svg_27a9d31282fa5cbeb137_path-2" cx="86.1239804" cy="85.2105263" rx="68.1239804" ry="68.2105263"></ellipse>
        <ellipse id="svg_27a9d31282fa5cbeb137_path-3" cx="68.1239804" cy="85.2105263" rx="68.1239804" ry="68.2105263"></ellipse>
        <ellipse id="svg_27a9d31282fa5cbeb137_path-4" cx="85.1239804" cy="86.2105263" rx="68.1239804" ry="68.2105263"></ellipse>
        <ellipse id="svg_27a9d31282fa5cbeb137_path-5" cx="68.1239804" cy="85.2105263" rx="68.1239804" ry="68.2105263"></ellipse>
        <ellipse id="svg_27a9d31282fa5cbeb137_path-6" cx="89.1239804" cy="86.2105263" rx="68.1239804" ry="68.2105263"></ellipse>
        <ellipse id="svg_27a9d31282fa5cbeb137_path-7" cx="240.12398" cy="86.2105263" rx="68.1239804" ry="68.2105263"></ellipse>
    </defs>
    <g id="svg_27a9d31282fa5cbeb137_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_27a9d31282fa5cbeb137_applicative" transform="translate(-44.000000, -60.000000)">
            <rect id="svg_27a9d31282fa5cbeb137_Background" x="0" y="0" width="2105" height="360" />
            <g id="svg_27a9d31282fa5cbeb137_Group-7" transform="translate(84.000000, 61.000000)">
                <g id="svg_27a9d31282fa5cbeb137_Oval-1">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_27a9d31282fa5cbeb137_path-1" />
                    <ellipse stroke="#000000" stroke-width="4" cx="68.1239804" cy="85.2105263" rx="66.1239804" ry="66.2105263"></ellipse>
                </g>
                <g id="svg_27a9d31282fa5cbeb137_Group" transform="translate(272.000000, 0.000000)">
                    <g id="svg_27a9d31282fa5cbeb137_Oval-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_27a9d31282fa5cbeb137_path-2" />
                        <ellipse stroke="#000000" stroke-width="4" cx="86.1239804" cy="85.2105263" rx="66.1239804" ry="66.2105263"></ellipse>
                    </g>
                    <rect id="svg_27a9d31282fa5cbeb137_Rectangle-1" stroke="#000000" stroke-width="4" x="2" y="2" width="166.309951" height="166.526316" rx="8" />
                </g>
                <polygon id="svg_27a9d31282fa5cbeb137_Path-1" fill="#000000" points="171 70.0526316 205.06199 70.0526316 205.06199 53 239.12398 86.6770436 205.06199 121.210526 205.06199 104.157895 171 104.157895"></polygon>
            </g>
            <text id="svg_27a9d31282fa5cbeb137_A-=&gt;-F[A]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="191.936868" y="325">A =&gt; F[A]</tspan>
            </text>
            <g id="svg_27a9d31282fa5cbeb137_Group-6" transform="translate(584.000000, 60.000000)">
                <g id="svg_27a9d31282fa5cbeb137_Oval-1">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_27a9d31282fa5cbeb137_path-3" />
                    <ellipse stroke="#000000" stroke-width="4" cx="68.1239804" cy="85.2105263" rx="66.1239804" ry="66.2105263"></ellipse>
                </g>
                <g id="svg_27a9d31282fa5cbeb137_Group" transform="translate(273.000000, 0.000000)">
                    <rect id="svg_27a9d31282fa5cbeb137_Rectangle-1" stroke="#000000" stroke-width="4" x="2" y="2" width="166.309951" height="166.526316" rx="8" />
                    <g id="svg_27a9d31282fa5cbeb137_Oval-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_27a9d31282fa5cbeb137_path-4" />
                        <ellipse stroke="#000000" stroke-width="4" cx="85.1239804" cy="86.2105263" rx="66.1239804" ry="66.2105263"></ellipse>
                    </g>
                </g>
                <polygon id="svg_27a9d31282fa5cbeb137_Path-1" fill="#000000" points="172 71.0526316 206.06199 71.0526316 206.06199 54 240.12398 87.6770436 206.06199 122.210526 206.06199 105.157895 172 105.157895"></polygon>
            </g>
            <text id="svg_27a9d31282fa5cbeb137_A-=&gt;-F[A]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="691.351223" y="324">A =&gt; F[A]</tspan>
            </text>
            <text id="svg_27a9d31282fa5cbeb137_A-=&gt;-F[(A,-A)]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="1583.63426" y="324">A =&gt; F[(A, A)]</tspan>
            </text>
            <g id="svg_27a9d31282fa5cbeb137_Group-5" transform="translate(1460.000000, 60.000000)">
                <g id="svg_27a9d31282fa5cbeb137_Oval-1">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_27a9d31282fa5cbeb137_path-5" />
                    <ellipse stroke="#000000" stroke-width="4" cx="68.1239804" cy="85.2105263" rx="66.1239804" ry="66.2105263"></ellipse>
                </g>
                <polygon id="svg_27a9d31282fa5cbeb137_Path-1" fill="#000000" points="171 68.0526316 205.06199 68.0526316 205.06199 51 239.12398 84.6770436 205.06199 119.210526 205.06199 102.157895 171 102.157895"></polygon>
                <g id="svg_27a9d31282fa5cbeb137_Group-4" transform="translate(272.000000, 0.000000)">
                    <rect id="svg_27a9d31282fa5cbeb137_Rectangle-1" stroke="#000000" stroke-width="4" x="2.69004894" y="2" width="323.644372" height="166.526316" rx="8" />
                    <g id="svg_27a9d31282fa5cbeb137_Oval-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_27a9d31282fa5cbeb137_path-6" />
                        <ellipse stroke="#000000" stroke-width="4" cx="89.1239804" cy="86.2105263" rx="66.1239804" ry="66.2105263"></ellipse>
                    </g>
                    <g id="svg_27a9d31282fa5cbeb137_Oval-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_27a9d31282fa5cbeb137_path-7" />
                        <ellipse stroke="#000000" stroke-width="4" cx="240.12398" cy="86.2105263" rx="66.1239804" ry="66.2105263"></ellipse>
                    </g>
                </g>
            </g>
            <polygon id="svg_27a9d31282fa5cbeb137_Path-1" fill="#F6A623" points="1344 127 1384 127 1384 107 1424 146.497767 1384 187 1384 167 1344 167"></polygon>
            <text id="svg_27a9d31282fa5cbeb137_," font-family="FiraMono-Bold, Fira Mono" font-size="56" font-weight="bold" fill="#F6A623">
                <tspan x="540.2" y="169">,</tspan>
            </text>
            <text id="svg_27a9d31282fa5cbeb137_).tupled" font-family="FiraMono-Bold, Fira Mono" font-size="56" font-weight="bold" fill="#F6A623">
                <tspan x="1043.1" y="169">).tupled</tspan>
            </text>
            <text id="svg_27a9d31282fa5cbeb137_(" font-family="FiraMono-Bold, Fira Mono" font-size="56" font-weight="bold" fill="#F6A623">
                <tspan x="39.2" y="169">(</tspan>
            </text>
        </g>
    </g>
</svg>
    <figcaption>Figure 20: Applicative combination of
    checks</figcaption>
    </figure>
    <p>Not really. With applicative combination, both checks are applied
    to the same value and result in a tuple with the value repeated.
    What we want feels more like a monoid as shown in Figure 21. We can
    define a sensible identity—a check that always passes—and two binary
    combination operators—<em>and</em> and <em>or</em>:</p>
    <figure id="fig:validation:monoid">
    <svg id="svg_42cb475dbca8b225a537" alt="Monoid combination of checks" width="1643px" height="270px" viewBox="0 0 1643 270">
    <!-- Generator: Sketch 43.2 (39069) - http://www.bohemiancoding.com/sketch -->
    <title>monoid</title>
    <desc>Created with Sketch.</desc>
    <defs>
        <ellipse id="svg_42cb475dbca8b225a537_path-1" cx="68.1239804" cy="85.2105263" rx="68.1239804" ry="68.2105263"></ellipse>
        <ellipse id="svg_42cb475dbca8b225a537_path-2" cx="86.1239804" cy="85.2105263" rx="68.1239804" ry="68.2105263"></ellipse>
        <ellipse id="svg_42cb475dbca8b225a537_path-3" cx="68.1239804" cy="85.2105263" rx="68.1239804" ry="68.2105263"></ellipse>
        <ellipse id="svg_42cb475dbca8b225a537_path-4" cx="85.1239804" cy="86.2105263" rx="68.1239804" ry="68.2105263"></ellipse>
        <ellipse id="svg_42cb475dbca8b225a537_path-5" cx="68.1239804" cy="85.2105263" rx="68.1239804" ry="68.2105263"></ellipse>
        <ellipse id="svg_42cb475dbca8b225a537_path-6" cx="85.1239804" cy="86.2105263" rx="68.1239804" ry="68.2105263"></ellipse>
    </defs>
    <g id="svg_42cb475dbca8b225a537_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_42cb475dbca8b225a537_monoid" transform="translate(-139.000000, -60.000000)">
            <rect id="svg_42cb475dbca8b225a537_Background" x="0" y="0" width="1921" height="360" />
            <g id="svg_42cb475dbca8b225a537_Group-7" transform="translate(139.000000, 61.000000)">
                <g id="svg_42cb475dbca8b225a537_Oval-1">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_42cb475dbca8b225a537_path-1" />
                    <ellipse stroke="#000000" stroke-width="4" cx="68.1239804" cy="85.2105263" rx="66.1239804" ry="66.2105263"></ellipse>
                </g>
                <g id="svg_42cb475dbca8b225a537_Group" transform="translate(272.000000, 0.000000)">
                    <g id="svg_42cb475dbca8b225a537_Oval-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_42cb475dbca8b225a537_path-2" />
                        <ellipse stroke="#000000" stroke-width="4" cx="86.1239804" cy="85.2105263" rx="66.1239804" ry="66.2105263"></ellipse>
                    </g>
                    <rect id="svg_42cb475dbca8b225a537_Rectangle-1" stroke="#000000" stroke-width="4" x="2" y="2" width="166.309951" height="166.526316" rx="8" />
                </g>
                <polygon id="svg_42cb475dbca8b225a537_Path-1" fill="#000000" points="171 70.0526316 205.06199 70.0526316 205.06199 53 239.12398 86.6770436 205.06199 121.210526 205.06199 104.157895 171 104.157895"></polygon>
            </g>
            <text id="svg_42cb475dbca8b225a537_A-=&gt;-F[A]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="246.936868" y="325">A =&gt; F[A]</tspan>
            </text>
            <g id="svg_42cb475dbca8b225a537_Group-6" transform="translate(739.000000, 60.000000)">
                <g id="svg_42cb475dbca8b225a537_Oval-1">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_42cb475dbca8b225a537_path-3" />
                    <ellipse stroke="#000000" stroke-width="4" cx="68.1239804" cy="85.2105263" rx="66.1239804" ry="66.2105263"></ellipse>
                </g>
                <g id="svg_42cb475dbca8b225a537_Group" transform="translate(273.000000, 0.000000)">
                    <rect id="svg_42cb475dbca8b225a537_Rectangle-1" stroke="#000000" stroke-width="4" x="2" y="2" width="166.309951" height="166.526316" rx="8" />
                    <g id="svg_42cb475dbca8b225a537_Oval-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_42cb475dbca8b225a537_path-4" />
                        <ellipse stroke="#000000" stroke-width="4" cx="85.1239804" cy="86.2105263" rx="66.1239804" ry="66.2105263"></ellipse>
                    </g>
                </g>
                <polygon id="svg_42cb475dbca8b225a537_Path-1" fill="#000000" points="172 71.0526316 206.06199 71.0526316 206.06199 54 240.12398 87.6770436 206.06199 122.210526 206.06199 105.157895 172 105.157895"></polygon>
            </g>
            <text id="svg_42cb475dbca8b225a537_A-=&gt;-F[A]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="846.351223" y="324">A =&gt; F[A]</tspan>
            </text>
            <text id="svg_42cb475dbca8b225a537_A-=&gt;-F[A]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="1446.63426" y="324">A =&gt; F[A]</tspan>
            </text>
            <g id="svg_42cb475dbca8b225a537_Group-5" transform="translate(1339.000000, 60.000000)">
                <g id="svg_42cb475dbca8b225a537_Oval-1">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_42cb475dbca8b225a537_path-5" />
                    <ellipse stroke="#000000" stroke-width="4" cx="68.1239804" cy="85.2105263" rx="66.1239804" ry="66.2105263"></ellipse>
                </g>
                <polygon id="svg_42cb475dbca8b225a537_Path-1" fill="#000000" points="171 68.0526316 205.06199 68.0526316 205.06199 51 239.12398 84.6770436 205.06199 119.210526 205.06199 102.157895 171 102.157895"></polygon>
                <g id="svg_42cb475dbca8b225a537_Group-4" transform="translate(272.000000, 0.000000)">
                    <rect id="svg_42cb475dbca8b225a537_Rectangle-1" stroke="#000000" stroke-width="4" x="2.69004894" y="2" width="166.309951" height="166.526316" rx="8" />
                    <g id="svg_42cb475dbca8b225a537_Oval-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_42cb475dbca8b225a537_path-6" />
                        <ellipse stroke="#000000" stroke-width="4" cx="85.1239804" cy="86.2105263" rx="66.1239804" ry="66.2105263"></ellipse>
                    </g>
                </g>
            </g>
            <polygon id="svg_42cb475dbca8b225a537_Path-1" fill="#F6A623" points="1221 127 1261 127 1261 107 1301 146.497767 1261 187 1261 167 1221 167"></polygon>
            <text id="svg_42cb475dbca8b225a537_|+|" font-family="FiraMono-Bold, Fira Mono" font-size="56" font-weight="bold" fill="#F6A623">
                <tspan x="611.1" y="169">|+|</tspan>
            </text>
        </g>
    </g>
</svg>
    <figcaption>Figure 21: Monoid combination of checks</figcaption>
    </figure>
    <p>We’ll probably be using <em>and</em> and <em>or</em> about
    equally often with our validation library and it will be annoying to
    continuously switch between two monoids for combining rules. We
    consequently won’t actually use the monoid API: we’ll use two
    separate methods, <code>and</code> and <code>or</code>, instead.</p>
    <p><strong>Accumulating errors as we check</strong></p>
    <p>Monoids also feel like a good mechanism for accumulating error
    messages. If we store messages as a <code>List</code> or
    <code>NonEmptyList</code>, we can even use a pre-existing monoid
    from inside Cats.</p>
    <p><strong>Transforming data as we check it</strong></p>
    <p>In addition to checking data, we also have the goal of
    transforming it. This seems like it should be a <code>map</code> or
    a <code>flatMap</code> depending on whether the transform can fail
    or not, so it seems we also want checks to be a monad as shown in
    Figure 22.</p>
    <figure id="fig:validation:monad">
    <svg id="svg_7ea751333756e67e44d6" alt="Monadic combination of checks" width="1614px" height="542px" viewBox="0 0 1614 542">
    <!-- Generator: Sketch 43.2 (39069) - http://www.bohemiancoding.com/sketch -->
    <title>monad</title>
    <desc>Created with Sketch.</desc>
    <defs>
        <polygon id="svg_7ea751333756e67e44d6_path-1" points="279.385663 100.013471 245.151257 117.8958 251.689447 80.0204196 223.99323 53.1969265 262.26846 47.6709831 279.385663 13.2108239 296.502867 47.6709831 334.778097 53.1969265 307.08188 80.0204196 313.62007 117.8958"></polygon>
        <ellipse id="svg_7ea751333756e67e44d6_path-2" cx="53.168329" cy="66.1042853" rx="53.168329" ry="52.8934614"></ellipse>
        <polygon id="svg_7ea751333756e67e44d6_path-3" points="267.026863 98.1362496 232.792456 116.018578 239.330646 78.1431983 211.634429 51.3197052 249.909659 45.7937617 267.026863 11.3336026 284.144066 45.7937617 322.419296 51.3197052 294.723079 78.1431983 301.261269 116.018578"></polygon>
        <ellipse id="svg_7ea751333756e67e44d6_path-4" cx="53.2969557" cy="67.3288411" rx="53.168329" ry="52.8934614"></ellipse>
        <ellipse id="svg_7ea751333756e67e44d6_path-5" cx="53.422681" cy="66.3288411" rx="53.168329" ry="52.8934614"></ellipse>
        <ellipse id="svg_7ea751333756e67e44d6_path-6" cx="53.6267429" cy="66.3514582" rx="53.168329" ry="52.8934614"></ellipse>
        <polygon id="svg_7ea751333756e67e44d6_path-7" points="279.844077 99.4851995 245.609671 117.367528 252.147861 79.4921482 224.451644 52.6686551 262.726874 47.1427117 279.844077 12.6825525 296.961281 47.1427117 335.236511 52.6686551 307.540294 79.4921482 314.078484 117.367528"></polygon>
        <ellipse id="svg_7ea751333756e67e44d6_path-8" cx="53.1838029" cy="66.5760139" rx="53.168329" ry="52.8934614"></ellipse>
        <polygon id="svg_7ea751333756e67e44d6_path-9" points="55.6409826 87.2606438 21.4065761 105.142973 27.944766 67.2675925 0.248549323 40.4440994 38.5237794 34.9181559 55.6409826 0.457996769 72.7581858 34.9181559 111.033416 40.4440994 83.3371992 67.2675925 89.8753891 105.142973"></polygon>
    </defs>
    <g id="svg_7ea751333756e67e44d6_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_7ea751333756e67e44d6_monad" transform="translate(-155.000000, -37.000000)">
            <rect id="svg_7ea751333756e67e44d6_Background" x="0" y="0" width="1921" height="621" />
            <g id="svg_7ea751333756e67e44d6_flatmap" transform="translate(155.000000, 358.000000)">
                <g id="svg_7ea751333756e67e44d6_Group-10" transform="translate(0.000000, 2.000000)">
                    <g id="svg_7ea751333756e67e44d6_Star-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_7ea751333756e67e44d6_path-1" />
                        <path stroke="#000000" stroke-width="4" d="M247.810095,114.250545 L253.660298,80.3606353 L253.840095,79.3190787 L253.080844,78.5837521 L228.310883,54.5943066 L262.554245,49.6504595 L263.592833,49.5005145 L264.059655,48.5607134 L279.385663,17.7065679 L294.711672,48.5607134 L295.178494,49.5005145 L296.217082,49.6504595 L330.460444,54.5943066 L305.690483,78.5837521 L304.931232,79.3190787 L305.111029,80.3606353 L310.961232,114.250545 L280.311646,98.2407453 L279.385663,97.7570587 L278.459681,98.2407453 L247.810095,114.250545 Z" />
                    </g>
                    <g id="svg_7ea751333756e67e44d6_Oval-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_7ea751333756e67e44d6_path-2" />
                        <ellipse stroke="#000000" stroke-width="4" cx="53.168329" cy="66.1042853" rx="51.168329" ry="50.8934614"></ellipse>
                    </g>
                    <rect id="svg_7ea751333756e67e44d6_Rectangle-1" stroke="#000000" stroke-width="4" x="214.286267" y="2.02827141" width="128.920823" height="128.233654" rx="8" />
                    <polygon id="svg_7ea751333756e67e44d6_Path-1" fill="#000000" points="133.459381 54.3501828 160.043546 54.3501828 160.043546 41.1268174 186.62771 67.2414877 160.043546 94.0202789 160.043546 80.7969135 133.459381 80.7969135"></polygon>
                </g>
                <g id="svg_7ea751333756e67e44d6_Group-8" transform="translate(586.000000, 0.000000)">
                    <g id="svg_7ea751333756e67e44d6_Star-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_7ea751333756e67e44d6_path-3" />
                        <path stroke="#000000" stroke-width="4" d="M235.451294,112.373323 L241.301497,78.483414 L241.481294,77.4418574 L240.722043,76.7065308 L215.952082,52.7170852 L250.195444,47.7732382 L251.234032,47.6232932 L251.700855,46.6834921 L267.026863,15.8293466 L282.352871,46.6834921 L282.819693,47.6232932 L283.858281,47.7732382 L318.101643,52.7170852 L293.331682,76.7065308 L292.572431,77.4418574 L292.752228,78.483414 L298.602431,112.373323 L267.952845,96.363524 L267.026863,95.8798373 L266.10088,96.363524 L235.451294,112.373323 Z" />
                    </g>
                    <polygon id="svg_7ea751333756e67e44d6_Path-1" fill="#000000" points="347.435203 53.2484057 374.019368 53.2484057 374.019368 40.0250404 400.603532 66.1397107 374.019368 92.9185018 374.019368 79.6951365 347.435203 79.6951365"></polygon>
                    <rect id="svg_7ea751333756e67e44d6_Rectangle-1" stroke="#000000" stroke-width="4" x="428.800647" y="2.47738288" width="128.920823" height="128.233654" rx="8" />
                    <g id="svg_7ea751333756e67e44d6_Oval-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_7ea751333756e67e44d6_path-4" />
                        <ellipse stroke="#000000" stroke-width="4" cx="53.2969557" cy="67.3288411" rx="51.168329" ry="50.8934614"></ellipse>
                    </g>
                    <polygon id="svg_7ea751333756e67e44d6_Path-1" fill="#000000" points="133.588008 55.5747385 160.172172 55.5747385 160.172172 42.3513732 186.756337 68.4660435 160.172172 95.2448346 160.172172 82.0214693 133.588008 82.0214693"></polygon>
                    <polygon id="svg_7ea751333756e67e44d6_Polygon" stroke="#000000" stroke-width="4" fill="#FFFFFF" points="493.082597 23 539.165194 56.2656167 521.563208 110.090515 464.601986 110.090515 447 56.2656167"></polygon>
                </g>
                <text id="svg_7ea751333756e67e44d6_A-=&gt;-F[B]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                    <tspan x="59.4670213" y="215">A =&gt; F[B]</tspan>
                </text>
                <text id="svg_7ea751333756e67e44d6_B-=&gt;-(A-=&gt;-F[C])" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                    <tspan x="664.570696" y="215">B =&gt; (A =&gt; F[C])</tspan>
                </text>
                <text id="svg_7ea751333756e67e44d6_A-=&gt;-F[C]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                    <tspan x="1327.1103" y="215">A =&gt; F[C]</tspan>
                </text>
                <g id="svg_7ea751333756e67e44d6_Group-9" transform="translate(1268.000000, 1.000000)">
                    <g id="svg_7ea751333756e67e44d6_Oval-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_7ea751333756e67e44d6_path-5" />
                        <ellipse stroke="#000000" stroke-width="4" cx="53.422681" cy="66.3288411" rx="51.168329" ry="50.8934614"></ellipse>
                    </g>
                    <polygon id="svg_7ea751333756e67e44d6_Path-1" fill="#000000" points="133.713733 53.02385 160.297898 53.02385 160.297898 39.8004847 186.882062 65.9151549 160.297898 92.6939461 160.297898 79.4705807 133.713733 79.4705807"></polygon>
                    <rect id="svg_7ea751333756e67e44d6_Rectangle-1" stroke="#000000" stroke-width="4" x="215.079177" y="2.25282714" width="128.920823" height="128.233654" rx="8" />
                    <polygon id="svg_7ea751333756e67e44d6_Polygon" stroke="#000000" stroke-width="4" fill="#FFFFFF" points="280.082597 23 326.165194 56.2656167 308.563208 110.090515 251.601986 110.090515 234 56.2656167"></polygon>
                </g>
                <polygon id="svg_7ea751333756e67e44d6_Path-1" fill="#F6A623" points="1178.50097 53.2075929 1209.71954 53.2075929 1209.71954 37.6987076 1240.9381 68.3270246 1209.71954 99.7342488 1209.71954 84.2253635 1178.50097 84.2253635"></polygon>
                <text id="svg_7ea751333756e67e44d6_flatMap" font-family="FiraMono-Bold, Fira Mono" font-size="45" font-weight="bold" fill="#F6A623">
                    <tspan x="375.781673" y="82">flatMap</tspan>
                </text>
            </g>
            <g id="svg_7ea751333756e67e44d6_map" transform="translate(320.000000, 37.000000)">
                <text id="svg_7ea751333756e67e44d6_A-=&gt;-F[B]" font-family="FiraMono-Regular, Fira Mono" font-size="40" font-weight="normal" fill="#000000">
                    <tspan x="65.1378143" y="214">A =&gt; F[B]</tspan>
                </text>
                <g id="svg_7ea751333756e67e44d6_Group-14" transform="translate(0.000000, 1.000000)">
                    <g id="svg_7ea751333756e67e44d6_Oval-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_7ea751333756e67e44d6_path-6" />
                        <ellipse stroke="#000000" stroke-width="4" cx="53.6267429" cy="66.3514582" rx="51.168329" ry="50.8934614"></ellipse>
                    </g>
                    <rect id="svg_7ea751333756e67e44d6_Rectangle-1" stroke="#000000" stroke-width="4" x="214.744681" y="2.27544426" width="128.920823" height="128.233654" rx="8" />
                    <polygon id="svg_7ea751333756e67e44d6_Path-1" fill="#000000" points="133.917795 54.5973557 160.501959 54.5973557 160.501959 41.3739903 187.086124 67.4886606 160.501959 94.2674517 160.501959 81.0440864 133.917795 81.0440864"></polygon>
                    <g id="svg_7ea751333756e67e44d6_Star-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_7ea751333756e67e44d6_path-7" />
                        <path stroke="#000000" stroke-width="4" d="M248.268509,113.722273 L254.118712,79.8323639 L254.298509,78.7908073 L253.539258,78.0554807 L228.769297,54.0660352 L263.012659,49.1221881 L264.051247,48.9722431 L264.518069,48.032442 L279.844077,17.1782965 L295.170086,48.032442 L295.636908,48.9722431 L296.675496,49.1221881 L330.918858,54.0660352 L306.148897,78.0554807 L305.389646,78.7908073 L305.569443,79.8323639 L311.419646,113.722273 L280.77006,97.7124739 L279.844077,97.2287872 L278.918095,97.7124739 L248.268509,113.722273 Z" />
                    </g>
                </g>
                <text id="svg_7ea751333756e67e44d6_B-=&gt;-C" font-family="FiraMono-Regular, Fira Mono" font-size="40" font-weight="normal" fill="#000000">
                    <tspan x="570.900616" y="214">B =&gt; C</tspan>
                </text>
                <text id="svg_7ea751333756e67e44d6_A-=&gt;-F[C]" font-family="FiraMono-Regular, Fira Mono" font-size="40" font-weight="normal" fill="#000000">
                    <tspan x="1001.5103" y="214">A =&gt; F[C]</tspan>
                </text>
                <polygon id="svg_7ea751333756e67e44d6_Path-1" fill="#F6A623" points="837.116054 52.4547658 868.334623 52.4547658 868.334623 36.9458805 899.553191 67.5741975 868.334623 98.9814216 868.334623 83.4725363 837.116054 83.4725363"></polygon>
                <text font-family="FiraMono-Bold, Fira Mono" font-size="45" font-weight="bold" fill="#F6A623">
                    <tspan x="380.238395" y="81.6195477">map</tspan>
                </text>
                <g id="svg_7ea751333756e67e44d6_Group-12" transform="translate(937.000000, 0.000000)">
                    <g id="svg_7ea751333756e67e44d6_Oval-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_7ea751333756e67e44d6_path-8" />
                        <ellipse stroke="#000000" stroke-width="4" cx="53.1838029" cy="66.5760139" rx="51.168329" ry="50.8934614"></ellipse>
                    </g>
                    <polygon id="svg_7ea751333756e67e44d6_Path-1" fill="#000000" points="133.474855 53.2710229 160.059019 53.2710229 160.059019 40.0476575 186.643184 66.1623278 160.059019 92.941119 160.059019 79.7177536 133.474855 79.7177536"></polygon>
                    <rect id="svg_7ea751333756e67e44d6_Rectangle-1" stroke="#000000" stroke-width="4" x="214.840299" y="2.5" width="128.920823" height="128.233654" rx="8" />
                    <polygon id="svg_7ea751333756e67e44d6_Polygon" stroke="#000000" stroke-width="4" fill="#FFFFFF" points="279.597447 23.082766 325.680044 56.3483827 308.078058 110.173281 251.116836 110.173281 233.51485 56.3483827"></polygon>
                </g>
                <g id="svg_7ea751333756e67e44d6_Group-13" transform="translate(488.000000, 14.000000)">
                    <g id="svg_7ea751333756e67e44d6_Star-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_7ea751333756e67e44d6_path-9" />
                        <path stroke="#000000" stroke-width="4" d="M24.0654139,101.497717 L29.9156169,67.6078082 L30.0954143,66.5662516 L29.3361633,65.830925 L4.56620214,41.8414794 L38.8095641,36.8976324 L39.8481523,36.7476874 L40.3149744,35.8078863 L55.6409826,4.95374076 L70.9669908,35.8078863 L71.4338129,36.7476874 L72.4724011,36.8976324 L106.715763,41.8414794 L81.9458019,65.830925 L81.1865509,66.5662516 L81.3663483,67.6078082 L87.2165513,101.497717 L56.5669652,85.4879181 L55.6409826,85.0042315 L54.715,85.4879181 L24.0654139,101.497717 Z" />
                    </g>
                    <polygon id="svg_7ea751333756e67e44d6_Path-1" fill="#000000" points="136.829787 41.5973557 163.413952 41.5973557 163.413952 28.3739903 189.998116 54.4886606 163.413952 81.2674517 163.413952 68.0440864 136.829787 68.0440864"></polygon>
                    <polygon id="svg_7ea751333756e67e44d6_Polygon" stroke="#000000" stroke-width="4" fill="#FFFFFF" points="263.300199 8.21243942 309.382796 41.4780561 291.78081 95.3029545 234.819587 95.3029545 217.217602 41.4780561"></polygon>
                </g>
            </g>
        </g>
    </g>
</svg>
    <figcaption>Figure 22: Monadic combination of checks</figcaption>
    </figure>
    <p>We’ve now broken down our library into familiar abstractions and
    are in a good position to begin development.</p>
    <h2 data-number="18.2" id="the-check-datatype"><span class="header-section-number">18.2</span> The Check Datatype</h2>
    <p>Our design revolves around a <code>Check</code>, which we said
    was a function from a value to a value in a context. As soon as you
    see this description you should think of something like</p>
    <div class="sourceCode" id="cb926"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb926-1"><a href="#cb926-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Check<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> A <span class="op">=&gt;</span> Either<span class="op">[</span><span class="ex">String</span><span class="op">,</span> A<span class="op">]</span></span></code></pre></div>
    <p>Here we’ve represented the error message as a
    <code>String</code>. This is probably not the best representation.
    We may want to accumulate messages in a <code>List</code>, for
    example, or even use a different representation that allows for
    internationalization or standard error codes.</p>
    <p>We could attempt to build some kind of <code>ErrorMessage</code>
    type that holds all the information we can think of. However, we
    can’t predict the user’s requirements. Instead let’s let the user
    specify what they want. We can do this by adding a second type
    parameter to <code>Check</code>:</p>
    <div class="sourceCode" id="cb927"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb927-1"><a href="#cb927-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span> A <span class="op">=&gt;</span> Either<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span></span></code></pre></div>
    <p>We will probably want to add custom methods to <code>Check</code>
    so let’s declare it as a <code>trait</code> instead of a type
    alias:</p>
    <div class="sourceCode" id="cb928"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb928-1"><a href="#cb928-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb928-2"><a href="#cb928-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>value<span class="op">:</span> A<span class="op">):</span> Either<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span></span>
<span id="cb928-3"><a href="#cb928-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb928-4"><a href="#cb928-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// other methods...</span></span>
<span id="cb928-5"><a href="#cb928-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>As we said in <a href="http://underscore.io/books/essential-scala">Essential
    Scala</a>, there are two functional programming patterns that we
    should consider when defining a trait:</p>
    <ul>
    <li>we can make it a typeclass, or;</li>
    <li>we can make it an algebraic data type (and hence seal it).</li>
    </ul>
    <p>Type classes allow us to unify disparate data types with a common
    interface. This doesn’t seem like what we’re trying to do here. That
    leaves us with an algebraic data type. Let’s keep that thought in
    mind as we explore the design a bit further.</p>
    <h2 data-number="18.3" id="basic-combinators"><span class="header-section-number">18.3</span> Basic Combinators</h2>
    <p>Let’s add some combinator methods to <code>Check</code>, starting
    with <code>and</code>. This method combines two checks into one,
    succeeding only if both checks succeed. Think about implementing
    this method now. You should hit some problems. Read on when you
    do!</p>
    <div class="sourceCode" id="cb929"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb929-1"><a href="#cb929-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb929-2"><a href="#cb929-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">and</span><span class="op">(</span>that<span class="op">:</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">]):</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb929-3"><a href="#cb929-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb929-4"><a href="#cb929-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb929-5"><a href="#cb929-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// other methods...</span></span>
<span id="cb929-6"><a href="#cb929-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>The problem is: what do you do when <em>both</em> checks fail?
    The correct thing to do is to return both errors, but we don’t
    currently have any way to combine <code>Es</code>. We need a
    <em>type class</em> that abstracts over the concept of
    “accumulating” errors as shown in Figure 23 What type class do we
    know that looks like this? What method or operator should we use to
    implement the <code>?</code> operation?</p>
    <figure id="fig:validation:error-semigroup">
    <svg id="svg_e976ecb152dab2ac3991" alt="Combining error messages" width="1921px" height="660px" viewBox="0 0 1921 660">
    <!-- Generator: Sketch 43.2 (39069) - http://www.bohemiancoding.com/sketch -->
    <title>error-semigroup</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="svg_e976ecb152dab2ac3991_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_e976ecb152dab2ac3991_error-semigroup">
            <rect id="svg_e976ecb152dab2ac3991_Background" fill="#FFFFFF" x="0" y="0" width="1921" height="660" />
            <text id="svg_e976ecb152dab2ac3991_E-•-E-=&gt;-E" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="840" y="319">E • E =&gt; E</tspan>
            </text>
            <text id="svg_e976ecb152dab2ac3991_List[String]-•-List[" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="419.2" y="601">List[String] • List[String] =&gt; List[String]</tspan>
            </text>
            <g id="svg_e976ecb152dab2ac3991_Group-17" transform="translate(580.000000, 42.000000)">
                <polygon id="svg_e976ecb152dab2ac3991_Polygon-2" stroke="#000000" stroke-width="4" points="364.5 1 441.06005 56.624132 411.816713 146.625868 317.183287 146.625868 287.93995 56.624132"></polygon>
                <polygon id="svg_e976ecb152dab2ac3991_Polygon-2" stroke="#000000" stroke-width="4" points="76.5600496 0 153.120099 55.624132 123.876762 145.625868 29.2433368 145.625868 -1.42108547e-14 55.624132"></polygon>
                <polygon id="svg_e976ecb152dab2ac3991_Polygon-2" stroke="#000000" stroke-width="4" points="683.56005 0 760.120099 55.624132 730.876762 145.625868 636.243337 145.625868 607 55.624132"></polygon>
                <polygon id="svg_e976ecb152dab2ac3991_Path-1" fill="#000000" points="485 60 525 60 525 40 565 79.4977671 525 120 525 100 485 100"></polygon>
                <circle id="svg_e976ecb152dab2ac3991_Oval" fill="#000000" cx="219" cy="81" r="20"></circle>
            </g>
            <g id="svg_e976ecb152dab2ac3991_Group-20" transform="translate(565.000000, 334.000000)">
                <g id="svg_e976ecb152dab2ac3991_Group-18" transform="translate(289.000000, 9.000000)" stroke-width="4" stroke="#000000" fill="#FFFFFF">
                    <polygon id="svg_e976ecb152dab2ac3991_Polygon-2" points="95.5600496 27 172.120099 82.624132 142.876762 172.625868 48.2433368 172.625868 19 82.624132"></polygon>
                    <polygon id="svg_e976ecb152dab2ac3991_Polygon-2" points="76.5600496 0 153.120099 55.624132 123.876762 145.625868 29.2433368 145.625868 -1.42108547e-14 55.624132"></polygon>
                </g>
                <g id="svg_e976ecb152dab2ac3991_Group-18" transform="translate(0.000000, 5.000000)" stroke-width="4" stroke="#000000" fill="#FFFFFF">
                    <polygon id="svg_e976ecb152dab2ac3991_Polygon-2" points="95.5600496 27 172.120099 82.624132 142.876762 172.625868 48.2433368 172.625868 19 82.624132"></polygon>
                    <polygon id="svg_e976ecb152dab2ac3991_Polygon-2" points="76.5600496 0 153.120099 55.624132 123.876762 145.625868 29.2433368 145.625868 -1.42108547e-14 55.624132"></polygon>
                </g>
                <g id="svg_e976ecb152dab2ac3991_Group-19" transform="translate(597.000000, 0.000000)" stroke-width="4" stroke="#000000" fill="#FFFFFF">
                    <polygon id="svg_e976ecb152dab2ac3991_Polygon-2" points="116.56005 42 193.120099 97.624132 163.876762 187.625868 69.2433368 187.625868 40 97.624132"></polygon>
                    <polygon id="svg_e976ecb152dab2ac3991_Polygon-2" points="95.5600496 22 172.120099 77.624132 142.876762 167.625868 48.2433368 167.625868 19 77.624132"></polygon>
                    <polygon id="svg_e976ecb152dab2ac3991_Polygon-2" points="76.5600496 0 153.120099 55.624132 123.876762 145.625868 29.2433368 145.625868 -1.42108547e-14 55.624132"></polygon>
                </g>
                <polygon id="svg_e976ecb152dab2ac3991_Path-1" fill="#000000" points="494 82 534 82 534 62 574 101.497767 534 142 534 122 494 122"></polygon>
                <circle id="svg_e976ecb152dab2ac3991_Oval" fill="#000000" cx="228" cy="103" r="20"></circle>
            </g>
        </g>
    </g>
</svg>
    <figcaption>Figure 23: Combining error messages</figcaption>
    </figure>
    <div class="solution">
    <p>We need a <code>Semigroup</code> for <code>E</code>. Then we can
    combine values of <code>E</code> using the <code>combine</code>
    method or its associated <code>|+|</code> syntax:</p>
    <div class="sourceCode" id="cb930"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb930-1"><a href="#cb930-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Semigroup</span>
<span id="cb930-2"><a href="#cb930-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>list<span class="op">.</span>_   <span class="co">// for Semigroup</span></span>
<span id="cb930-3"><a href="#cb930-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>semigroup<span class="op">.</span>_ <span class="co">// for |+|</span></span>
<span id="cb930-4"><a href="#cb930-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb930-5"><a href="#cb930-5" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> semigroup <span class="op">=</span> Semigroup<span class="op">[</span><span class="ex">List</span><span class="op">[</span><span class="ex">String</span><span class="op">]]</span></span></code></pre></div>
    <div class="sourceCode" id="cb931"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb931-1"><a href="#cb931-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Combination using methods on Semigroup</span></span>
<span id="cb931-2"><a href="#cb931-2" aria-hidden="true" tabindex="-1"></a>semigroup<span class="op">.</span><span class="fu">combine</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span><span class="st">&quot;Badness&quot;</span><span class="op">),</span> <span class="ex">List</span><span class="op">(</span><span class="st">&quot;More badness&quot;</span><span class="op">))</span></span>
<span id="cb931-3"><a href="#cb931-3" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: List[String] = List(&quot;Badness&quot;, &quot;More badness&quot;)</span></span>
<span id="cb931-4"><a href="#cb931-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb931-5"><a href="#cb931-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Combination using Semigroup syntax</span></span>
<span id="cb931-6"><a href="#cb931-6" aria-hidden="true" tabindex="-1"></a><span class="ex">List</span><span class="op">(</span><span class="st">&quot;Oh noes&quot;</span><span class="op">)</span> <span class="op">|+|</span> <span class="ex">List</span><span class="op">(</span><span class="st">&quot;Fail happened&quot;</span><span class="op">)</span></span>
<span id="cb931-7"><a href="#cb931-7" aria-hidden="true" tabindex="-1"></a><span class="co">// res4: List[String] = List(&quot;Oh noes&quot;, &quot;Fail happened&quot;)</span></span></code></pre></div>
    <p>Note we don’t need a full <code>Monoid</code> because we don’t
    need the identity element. We should always try to keep our
    constraints as small as possible!</p>
    </div>
    <p>There is another semantic issue that will come up quite quickly:
    should <code>and</code> short-circuit if the first check fails. What
    do you think the most useful behaviour is?</p>
    <div class="solution">
    <p>We want to report all the errors we can, so we should prefer
    <em>not</em> short-circuiting whenever possible.</p>
    <p>In the case of the <code>and</code> method, the two checks we’re
    combining are independent of one another. We can always run both
    rules and combine any errors we see.</p>
    </div>
    <p>Use this knowledge to implement <code>and</code>. Make sure you
    end up with the behaviour you expect!</p>
    <div class="solution">
    <p>There are at least two implementation strategies.</p>
    <p>In the first we represent checks as functions. The
    <code>Check</code> data type becomes a simple wrapper for a function
    that provides our library of combinator methods. For the sake of
    disambiguation, we’ll call this implementation
    <code>CheckF</code>:</p>
    <div class="sourceCode" id="cb932"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb932-1"><a href="#cb932-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Semigroup</span>
<span id="cb932-2"><a href="#cb932-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>either<span class="op">.</span>_    <span class="co">// for asLeft and asRight</span></span>
<span id="cb932-3"><a href="#cb932-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>semigroup<span class="op">.</span>_ <span class="co">// for |+|</span></span></code></pre></div>
    <div class="sourceCode" id="cb933"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb933-1"><a href="#cb933-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> CheckF<span class="op">[</span>E<span class="op">,</span> A<span class="op">](</span>func<span class="op">:</span> A <span class="op">=&gt;</span> Either<span class="op">[</span>E<span class="op">,</span> A<span class="op">])</span> <span class="op">{</span></span>
<span id="cb933-2"><a href="#cb933-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>a<span class="op">:</span> A<span class="op">):</span> Either<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb933-3"><a href="#cb933-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">func</span><span class="op">(</span>a<span class="op">)</span></span>
<span id="cb933-4"><a href="#cb933-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb933-5"><a href="#cb933-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">and</span><span class="op">(</span>that<span class="op">:</span> CheckF<span class="op">[</span>E<span class="op">,</span> A<span class="op">])</span></span>
<span id="cb933-6"><a href="#cb933-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span><span class="kw">implicit</span> s<span class="op">:</span> Semigroup<span class="op">[</span>E<span class="op">]):</span> CheckF<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb933-7"><a href="#cb933-7" aria-hidden="true" tabindex="-1"></a>    CheckF <span class="op">{</span> a <span class="op">=&gt;</span></span>
<span id="cb933-8"><a href="#cb933-8" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span><span class="kw">this</span><span class="op">(</span>a<span class="op">),</span> <span class="fu">that</span><span class="op">(</span>a<span class="op">))</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb933-9"><a href="#cb933-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">(</span><span class="fu">Left</span><span class="op">(</span>e1<span class="op">),</span>  <span class="fu">Left</span><span class="op">(</span>e2<span class="op">))</span>  <span class="op">=&gt;</span> <span class="op">(</span>e1 <span class="op">|+|</span> e2<span class="op">).</span>asLeft</span>
<span id="cb933-10"><a href="#cb933-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">(</span><span class="fu">Left</span><span class="op">(</span>e<span class="op">),</span>   <span class="fu">Right</span><span class="op">(</span>_<span class="op">))</span>  <span class="op">=&gt;</span> e<span class="op">.</span>asLeft</span>
<span id="cb933-11"><a href="#cb933-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">(</span><span class="fu">Right</span><span class="op">(</span>_<span class="op">),</span>  <span class="fu">Left</span><span class="op">(</span>e<span class="op">))</span>   <span class="op">=&gt;</span> e<span class="op">.</span>asLeft</span>
<span id="cb933-12"><a href="#cb933-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">(</span><span class="fu">Right</span><span class="op">(</span>_<span class="op">),</span> <span class="fu">Right</span><span class="op">(</span>_<span class="op">))</span> <span class="op">=&gt;</span> a<span class="op">.</span>asRight</span>
<span id="cb933-13"><a href="#cb933-13" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb933-14"><a href="#cb933-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb933-15"><a href="#cb933-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Let’s test the behaviour we get. First we’ll setup some
    checks:</p>
    <div class="sourceCode" id="cb934"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb934-1"><a href="#cb934-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>list<span class="op">.</span>_ <span class="co">// for Semigroup</span></span>
<span id="cb934-2"><a href="#cb934-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb934-3"><a href="#cb934-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> a<span class="op">:</span> CheckF<span class="op">[</span><span class="ex">List</span><span class="op">[</span><span class="ex">String</span><span class="op">],</span> <span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb934-4"><a href="#cb934-4" aria-hidden="true" tabindex="-1"></a>  CheckF <span class="op">{</span> v <span class="op">=&gt;</span></span>
<span id="cb934-5"><a href="#cb934-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>v <span class="op">&gt;</span> <span class="dv">2</span><span class="op">)</span> v<span class="op">.</span>asRight</span>
<span id="cb934-6"><a href="#cb934-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="ex">List</span><span class="op">(</span><span class="st">&quot;Must be &gt; 2&quot;</span><span class="op">).</span>asLeft</span>
<span id="cb934-7"><a href="#cb934-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb934-8"><a href="#cb934-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb934-9"><a href="#cb934-9" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> b<span class="op">:</span> CheckF<span class="op">[</span><span class="ex">List</span><span class="op">[</span><span class="ex">String</span><span class="op">],</span> <span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb934-10"><a href="#cb934-10" aria-hidden="true" tabindex="-1"></a>  CheckF <span class="op">{</span> v <span class="op">=&gt;</span></span>
<span id="cb934-11"><a href="#cb934-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>v <span class="op">&lt;</span> <span class="op">-</span><span class="dv">2</span><span class="op">)</span> v<span class="op">.</span>asRight</span>
<span id="cb934-12"><a href="#cb934-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="ex">List</span><span class="op">(</span><span class="st">&quot;Must be &lt; -2&quot;</span><span class="op">).</span>asLeft</span>
<span id="cb934-13"><a href="#cb934-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb934-14"><a href="#cb934-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb934-15"><a href="#cb934-15" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> check<span class="op">:</span> CheckF<span class="op">[</span><span class="ex">List</span><span class="op">[</span><span class="ex">String</span><span class="op">],</span> <span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb934-16"><a href="#cb934-16" aria-hidden="true" tabindex="-1"></a>  a and b</span></code></pre></div>
    <p>Now run the check with some data:</p>
    <div class="sourceCode" id="cb935"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb935-1"><a href="#cb935-1" aria-hidden="true" tabindex="-1"></a><span class="fu">check</span><span class="op">(</span><span class="dv">5</span><span class="op">)</span></span>
<span id="cb935-2"><a href="#cb935-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: Either[List[String], Int] = Left(value = List(&quot;Must be &lt; -2&quot;))</span></span>
<span id="cb935-3"><a href="#cb935-3" aria-hidden="true" tabindex="-1"></a><span class="fu">check</span><span class="op">(</span><span class="dv">0</span><span class="op">)</span></span>
<span id="cb935-4"><a href="#cb935-4" aria-hidden="true" tabindex="-1"></a><span class="co">// res6: Either[List[String], Int] = Left(</span></span>
<span id="cb935-5"><a href="#cb935-5" aria-hidden="true" tabindex="-1"></a><span class="co">//   value = List(&quot;Must be &gt; 2&quot;, &quot;Must be &lt; -2&quot;)</span></span>
<span id="cb935-6"><a href="#cb935-6" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>Excellent! Everything works as expected! We’re running both
    checks and accumulating errors as required.</p>
    <p>What happens if we try to create checks that fail with a type
    that we can’t accumulate? For example, there is no
    <code>Semigroup</code> instance for <code>Nothing</code>. What
    happens if we create instances of
    <code>CheckF[Nothing, A]</code>?</p>
    <div class="sourceCode" id="cb936"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb936-1"><a href="#cb936-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> a<span class="op">:</span> CheckF<span class="op">[</span>Nothing<span class="op">,</span> <span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb936-2"><a href="#cb936-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">CheckF</span><span class="op">(</span>v <span class="op">=&gt;</span> v<span class="op">.</span>asRight<span class="op">)</span></span>
<span id="cb936-3"><a href="#cb936-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb936-4"><a href="#cb936-4" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> b<span class="op">:</span> CheckF<span class="op">[</span>Nothing<span class="op">,</span> <span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb936-5"><a href="#cb936-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">CheckF</span><span class="op">(</span>v <span class="op">=&gt;</span> v<span class="op">.</span>asRight<span class="op">)</span></span></code></pre></div>
    <p>We can create checks just fine but when we come to combine them
    we get an error we might expect:</p>
    <div class="sourceCode" id="cb937"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb937-1"><a href="#cb937-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> check <span class="op">=</span> a and b</span>
<span id="cb937-2"><a href="#cb937-2" aria-hidden="true" tabindex="-1"></a><span class="co">// error: </span></span>
<span id="cb937-3"><a href="#cb937-3" aria-hidden="true" tabindex="-1"></a><span class="co">// No given instance of type cats.kernel.Semigroup[Nothing] was found for parameter s of method and in class CheckF</span></span></code></pre></div>
    <p>Now let’s see another implementation strategy. In this approach
    we model checks as an algebraic data type, with an explicit data
    type for each combinator. We’ll call this implementation
    <code>Check</code>:</p>
    <div class="sourceCode" id="cb938"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb938-1"><a href="#cb938-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb938-2"><a href="#cb938-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">import</span> Check<span class="op">.</span>_</span>
<span id="cb938-3"><a href="#cb938-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb938-4"><a href="#cb938-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">and</span><span class="op">(</span>that<span class="op">:</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">]):</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb938-5"><a href="#cb938-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">And</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb938-6"><a href="#cb938-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb938-7"><a href="#cb938-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>a<span class="op">:</span> A<span class="op">)(</span><span class="kw">implicit</span> s<span class="op">:</span> Semigroup<span class="op">[</span>E<span class="op">]):</span> Either<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb938-8"><a href="#cb938-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb938-9"><a href="#cb938-9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Pure</span><span class="op">(</span>func<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb938-10"><a href="#cb938-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">func</span><span class="op">(</span>a<span class="op">)</span></span>
<span id="cb938-11"><a href="#cb938-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb938-12"><a href="#cb938-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">And</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb938-13"><a href="#cb938-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span><span class="fu">left</span><span class="op">(</span>a<span class="op">),</span> <span class="fu">right</span><span class="op">(</span>a<span class="op">))</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb938-14"><a href="#cb938-14" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> <span class="op">(</span><span class="fu">Left</span><span class="op">(</span>e1<span class="op">),</span>  <span class="fu">Left</span><span class="op">(</span>e2<span class="op">))</span>  <span class="op">=&gt;</span> <span class="op">(</span>e1 <span class="op">|+|</span> e2<span class="op">).</span>asLeft</span>
<span id="cb938-15"><a href="#cb938-15" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> <span class="op">(</span><span class="fu">Left</span><span class="op">(</span>e<span class="op">),</span>   <span class="fu">Right</span><span class="op">(</span>_<span class="op">))</span>  <span class="op">=&gt;</span> e<span class="op">.</span>asLeft</span>
<span id="cb938-16"><a href="#cb938-16" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> <span class="op">(</span><span class="fu">Right</span><span class="op">(</span>_<span class="op">),</span>  <span class="fu">Left</span><span class="op">(</span>e<span class="op">))</span>   <span class="op">=&gt;</span> e<span class="op">.</span>asLeft</span>
<span id="cb938-17"><a href="#cb938-17" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> <span class="op">(</span><span class="fu">Right</span><span class="op">(</span>_<span class="op">),</span> <span class="fu">Right</span><span class="op">(</span>_<span class="op">))</span> <span class="op">=&gt;</span> a<span class="op">.</span>asRight</span>
<span id="cb938-18"><a href="#cb938-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb938-19"><a href="#cb938-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb938-20"><a href="#cb938-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb938-21"><a href="#cb938-21" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Check <span class="op">{</span></span>
<span id="cb938-22"><a href="#cb938-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> And<span class="op">[</span>E<span class="op">,</span> A<span class="op">](</span></span>
<span id="cb938-23"><a href="#cb938-23" aria-hidden="true" tabindex="-1"></a>    left<span class="op">:</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">],</span></span>
<span id="cb938-24"><a href="#cb938-24" aria-hidden="true" tabindex="-1"></a>    right<span class="op">:</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">])</span> <span class="kw">extends</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span></span>
<span id="cb938-25"><a href="#cb938-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb938-26"><a href="#cb938-26" aria-hidden="true" tabindex="-1"></a>  <span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> Pure<span class="op">[</span>E<span class="op">,</span> A<span class="op">](</span></span>
<span id="cb938-27"><a href="#cb938-27" aria-hidden="true" tabindex="-1"></a>    func<span class="op">:</span> A <span class="op">=&gt;</span> Either<span class="op">[</span>E<span class="op">,</span> A<span class="op">])</span> <span class="kw">extends</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span></span>
<span id="cb938-28"><a href="#cb938-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb938-29"><a href="#cb938-29" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> pure<span class="op">[</span>E<span class="op">,</span> A<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> Either<span class="op">[</span>E<span class="op">,</span> A<span class="op">]):</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb938-30"><a href="#cb938-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Pure</span><span class="op">(</span>f<span class="op">)</span></span>
<span id="cb938-31"><a href="#cb938-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Let’s see an example:</p>
    <div class="sourceCode" id="cb939"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb939-1"><a href="#cb939-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> a<span class="op">:</span> Check<span class="op">[</span><span class="ex">List</span><span class="op">[</span><span class="ex">String</span><span class="op">],</span> <span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb939-2"><a href="#cb939-2" aria-hidden="true" tabindex="-1"></a>  Check<span class="op">.</span>pure <span class="op">{</span> v <span class="op">=&gt;</span></span>
<span id="cb939-3"><a href="#cb939-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>v <span class="op">&gt;</span> <span class="dv">2</span><span class="op">)</span> v<span class="op">.</span>asRight</span>
<span id="cb939-4"><a href="#cb939-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="ex">List</span><span class="op">(</span><span class="st">&quot;Must be &gt; 2&quot;</span><span class="op">).</span>asLeft</span>
<span id="cb939-5"><a href="#cb939-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb939-6"><a href="#cb939-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb939-7"><a href="#cb939-7" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> b<span class="op">:</span> Check<span class="op">[</span><span class="ex">List</span><span class="op">[</span><span class="ex">String</span><span class="op">],</span> <span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb939-8"><a href="#cb939-8" aria-hidden="true" tabindex="-1"></a>  Check<span class="op">.</span>pure <span class="op">{</span> v <span class="op">=&gt;</span></span>
<span id="cb939-9"><a href="#cb939-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>v <span class="op">&lt;</span> <span class="op">-</span><span class="dv">2</span><span class="op">)</span> v<span class="op">.</span>asRight</span>
<span id="cb939-10"><a href="#cb939-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="ex">List</span><span class="op">(</span><span class="st">&quot;Must be &lt; -2&quot;</span><span class="op">).</span>asLeft</span>
<span id="cb939-11"><a href="#cb939-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb939-12"><a href="#cb939-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb939-13"><a href="#cb939-13" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> check<span class="op">:</span> Check<span class="op">[</span><span class="ex">List</span><span class="op">[</span><span class="ex">String</span><span class="op">],</span> <span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb939-14"><a href="#cb939-14" aria-hidden="true" tabindex="-1"></a>  a and b</span></code></pre></div>
    <p>While the ADT implementation is more verbose than the function
    wrapper implementation, it has the advantage of cleanly separating
    the structure of the computation (the ADT instance we create) from
    the process that gives it meaning (the <code>apply</code> method).
    From here we have a number of options:</p>
    <ul>
    <li>inspect and refactor checks after they are created;</li>
    <li>move the <code>apply</code> “interpreter” out into its own
    module;</li>
    <li>implement alternative interpreters providing other functionality
    (for example visualizing checks).</li>
    </ul>
    <p>Because of its flexibility, we will use the ADT implementation
    for the rest of this case study.</p>
    </div>
    <p>Strictly speaking, <code>Either[E, A]</code> is the wrong
    abstraction for the output of our check. Why is this the case? What
    other data type could we use instead? Switch your implementation
    over to this new data type.</p>
    <div class="solution">
    <p>The implementation of <code>apply</code> for <code>And</code> is
    using the pattern for applicative functors. <code>Either</code> has
    an <code>Applicative</code> instance, but it doesn’t have the
    semantics we want. It fails fast instead of accumulating errors.</p>
    <p>If we want to accumulate errors <code>Validated</code> is a more
    appropriate abstraction. As a bonus, we get more code reuse because
    we can lean on the applicative instance of <code>Validated</code> in
    the implementation of <code>apply</code>.</p>
    <p>Here’s the complete implementation:</p>
    <div class="sourceCode" id="cb940"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb940-1"><a href="#cb940-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Semigroup</span>
<span id="cb940-2"><a href="#cb940-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>data<span class="op">.</span>Validated</span>
<span id="cb940-3"><a href="#cb940-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>apply<span class="op">.</span>_     <span class="co">// for mapN</span></span></code></pre></div>
    <div class="sourceCode" id="cb941"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb941-1"><a href="#cb941-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb941-2"><a href="#cb941-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">import</span> Check<span class="op">.</span>_</span>
<span id="cb941-3"><a href="#cb941-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb941-4"><a href="#cb941-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">and</span><span class="op">(</span>that<span class="op">:</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">]):</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb941-5"><a href="#cb941-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">And</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb941-6"><a href="#cb941-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb941-7"><a href="#cb941-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>a<span class="op">:</span> A<span class="op">)(</span><span class="kw">implicit</span> s<span class="op">:</span> Semigroup<span class="op">[</span>E<span class="op">]):</span> Validated<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb941-8"><a href="#cb941-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb941-9"><a href="#cb941-9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Pure</span><span class="op">(</span>func<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb941-10"><a href="#cb941-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">func</span><span class="op">(</span>a<span class="op">)</span></span>
<span id="cb941-11"><a href="#cb941-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb941-12"><a href="#cb941-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">And</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb941-13"><a href="#cb941-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span><span class="fu">left</span><span class="op">(</span>a<span class="op">),</span> <span class="fu">right</span><span class="op">(</span>a<span class="op">)).</span><span class="fu">mapN</span><span class="op">((</span>_<span class="op">,</span> _<span class="op">)</span> <span class="op">=&gt;</span> a<span class="op">)</span></span>
<span id="cb941-14"><a href="#cb941-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb941-15"><a href="#cb941-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb941-16"><a href="#cb941-16" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Check <span class="op">{</span></span>
<span id="cb941-17"><a href="#cb941-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> And<span class="op">[</span>E<span class="op">,</span> A<span class="op">](</span></span>
<span id="cb941-18"><a href="#cb941-18" aria-hidden="true" tabindex="-1"></a>    left<span class="op">:</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">],</span></span>
<span id="cb941-19"><a href="#cb941-19" aria-hidden="true" tabindex="-1"></a>    right<span class="op">:</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">])</span> <span class="kw">extends</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span></span>
<span id="cb941-20"><a href="#cb941-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb941-21"><a href="#cb941-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> Pure<span class="op">[</span>E<span class="op">,</span> A<span class="op">](</span></span>
<span id="cb941-22"><a href="#cb941-22" aria-hidden="true" tabindex="-1"></a>    func<span class="op">:</span> A <span class="op">=&gt;</span> Validated<span class="op">[</span>E<span class="op">,</span> A<span class="op">])</span> <span class="kw">extends</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span></span>
<span id="cb941-23"><a href="#cb941-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    </div>
    <p>Our implementation is looking pretty good now. Implement an
    <code>or</code> combinator to complement <code>and</code>.</p>
    <div class="solution">
    <p>This reuses the same technique for <code>and</code>. We have to
    do a bit more work in the <code>apply</code> method. Note that it’s
    OK to short-circuit in this case because the choice of rules is
    implicit in the semantics of “or”.</p>
    <div class="sourceCode" id="cb942"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb942-1"><a href="#cb942-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Semigroup</span>
<span id="cb942-2"><a href="#cb942-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>data<span class="op">.</span>Validated</span>
<span id="cb942-3"><a href="#cb942-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>semigroup<span class="op">.</span>_ <span class="co">// for |+|</span></span>
<span id="cb942-4"><a href="#cb942-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>apply<span class="op">.</span>_     <span class="co">// for mapN</span></span>
<span id="cb942-5"><a href="#cb942-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>data<span class="op">.</span>Validated<span class="op">.</span>_   <span class="co">// for Valid and Invalid</span></span></code></pre></div>
    <div class="sourceCode" id="cb943"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb943-1"><a href="#cb943-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb943-2"><a href="#cb943-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">import</span> Check<span class="op">.</span>_</span>
<span id="cb943-3"><a href="#cb943-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb943-4"><a href="#cb943-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">and</span><span class="op">(</span>that<span class="op">:</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">]):</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb943-5"><a href="#cb943-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">And</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb943-6"><a href="#cb943-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb943-7"><a href="#cb943-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">or</span><span class="op">(</span>that<span class="op">:</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">]):</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb943-8"><a href="#cb943-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Or</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb943-9"><a href="#cb943-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb943-10"><a href="#cb943-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>a<span class="op">:</span> A<span class="op">)(</span><span class="kw">implicit</span> s<span class="op">:</span> Semigroup<span class="op">[</span>E<span class="op">]):</span> Validated<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb943-11"><a href="#cb943-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb943-12"><a href="#cb943-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Pure</span><span class="op">(</span>func<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb943-13"><a href="#cb943-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">func</span><span class="op">(</span>a<span class="op">)</span></span>
<span id="cb943-14"><a href="#cb943-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb943-15"><a href="#cb943-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">And</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb943-16"><a href="#cb943-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span><span class="fu">left</span><span class="op">(</span>a<span class="op">),</span> <span class="fu">right</span><span class="op">(</span>a<span class="op">)).</span><span class="fu">mapN</span><span class="op">((</span>_<span class="op">,</span> _<span class="op">)</span> <span class="op">=&gt;</span> a<span class="op">)</span></span>
<span id="cb943-17"><a href="#cb943-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb943-18"><a href="#cb943-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Or</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb943-19"><a href="#cb943-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">left</span><span class="op">(</span>a<span class="op">)</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb943-20"><a href="#cb943-20" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> <span class="fu">Valid</span><span class="op">(</span>a<span class="op">)</span>    <span class="op">=&gt;</span> <span class="fu">Valid</span><span class="op">(</span>a<span class="op">)</span></span>
<span id="cb943-21"><a href="#cb943-21" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> <span class="ex">Invalid</span><span class="op">(</span>e1<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb943-22"><a href="#cb943-22" aria-hidden="true" tabindex="-1"></a>            <span class="fu">right</span><span class="op">(</span>a<span class="op">)</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb943-23"><a href="#cb943-23" aria-hidden="true" tabindex="-1"></a>              <span class="cf">case</span> <span class="fu">Valid</span><span class="op">(</span>a<span class="op">)</span>    <span class="op">=&gt;</span> <span class="fu">Valid</span><span class="op">(</span>a<span class="op">)</span></span>
<span id="cb943-24"><a href="#cb943-24" aria-hidden="true" tabindex="-1"></a>              <span class="cf">case</span> <span class="ex">Invalid</span><span class="op">(</span>e2<span class="op">)</span> <span class="op">=&gt;</span> <span class="ex">Invalid</span><span class="op">(</span>e1 <span class="op">|+|</span> e2<span class="op">)</span></span>
<span id="cb943-25"><a href="#cb943-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb943-26"><a href="#cb943-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb943-27"><a href="#cb943-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb943-28"><a href="#cb943-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb943-29"><a href="#cb943-29" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Check <span class="op">{</span></span>
<span id="cb943-30"><a href="#cb943-30" aria-hidden="true" tabindex="-1"></a>  <span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> And<span class="op">[</span>E<span class="op">,</span> A<span class="op">](</span></span>
<span id="cb943-31"><a href="#cb943-31" aria-hidden="true" tabindex="-1"></a>    left<span class="op">:</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">],</span></span>
<span id="cb943-32"><a href="#cb943-32" aria-hidden="true" tabindex="-1"></a>    right<span class="op">:</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">])</span> <span class="kw">extends</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span></span>
<span id="cb943-33"><a href="#cb943-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb943-34"><a href="#cb943-34" aria-hidden="true" tabindex="-1"></a>  <span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> Or<span class="op">[</span>E<span class="op">,</span> A<span class="op">](</span></span>
<span id="cb943-35"><a href="#cb943-35" aria-hidden="true" tabindex="-1"></a>    left<span class="op">:</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">],</span></span>
<span id="cb943-36"><a href="#cb943-36" aria-hidden="true" tabindex="-1"></a>    right<span class="op">:</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">])</span> <span class="kw">extends</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span></span>
<span id="cb943-37"><a href="#cb943-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb943-38"><a href="#cb943-38" aria-hidden="true" tabindex="-1"></a>  <span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> Pure<span class="op">[</span>E<span class="op">,</span> A<span class="op">](</span></span>
<span id="cb943-39"><a href="#cb943-39" aria-hidden="true" tabindex="-1"></a>    func<span class="op">:</span> A <span class="op">=&gt;</span> Validated<span class="op">[</span>E<span class="op">,</span> A<span class="op">])</span> <span class="kw">extends</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span></span>
<span id="cb943-40"><a href="#cb943-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    </div>
    <p>With <code>and</code> and <code>or</code> we can implement many
    of checks we’ll want in practice. However, we still have a few more
    methods to add. We’ll turn to <code>map</code> and related methods
    next.</p>
    <h2 data-number="18.4" id="transforming-data"><span class="header-section-number">18.4</span> Transforming Data</h2>
    <p>One of our requirements is the ability to transform data. This
    allows us to support additional scenarios like parsing input. In
    this section we’ll extend our check library with this additional
    functionality.</p>
    <p>The obvious starting point is <code>map</code>. When we try to
    implement this, we immediately run into a wall. Our current
    definition of <code>Check</code> requires the input and output types
    to be the same:</p>
    <div class="sourceCode" id="cb944"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb944-1"><a href="#cb944-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span> A <span class="op">=&gt;</span> Either<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span></span></code></pre></div>
    <p>When we map over a check, what type do we assign to the result?
    It can’t be <code>A</code> and it can’t be <code>B</code>. We are at
    an impasse:</p>
    <div class="sourceCode" id="cb945"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb945-1"><a href="#cb945-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">map</span><span class="op">(</span>check<span class="op">:</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">])(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> Check<span class="op">[</span>E<span class="op">,</span> <span class="op">???]</span></span></code></pre></div>
    <p>To implement <code>map</code> we need to change the definition of
    <code>Check</code>. Specifically, we need to a new type variable to
    separate the input type from the output:</p>
    <div class="sourceCode" id="cb946"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb946-1"><a href="#cb946-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">]</span> <span class="op">=</span> A <span class="op">=&gt;</span> Either<span class="op">[</span>E<span class="op">,</span> B<span class="op">]</span></span></code></pre></div>
    <p>Checks can now represent operations like parsing a
    <code>String</code> as an <code>Int</code>:</p>
    <div class="sourceCode" id="cb947"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb947-1"><a href="#cb947-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> parseInt<span class="op">:</span> Check<span class="op">[</span><span class="ex">List</span><span class="op">[</span><span class="ex">String</span><span class="op">],</span> <span class="ex">String</span><span class="op">,</span> <span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb947-2"><a href="#cb947-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// etc...</span></span></code></pre></div>
    <p>However, splitting our input and output types raises another
    issue. Up until now we have operated under the assumption that a
    <code>Check</code> always returns its input when successful. We used
    this in <code>and</code> and <code>or</code> to ignore the output of
    the left and right rules and simply return the original input on
    success:</p>
    <div class="sourceCode" id="cb948"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb948-1"><a href="#cb948-1" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="kw">this</span><span class="op">(</span>a<span class="op">),</span> <span class="fu">that</span><span class="op">(</span>a<span class="op">))</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb948-2"><a href="#cb948-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">And</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb948-3"><a href="#cb948-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span><span class="fu">left</span><span class="op">(</span>a<span class="op">),</span> <span class="fu">right</span><span class="op">(</span>a<span class="op">))</span></span>
<span id="cb948-4"><a href="#cb948-4" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">mapN</span><span class="op">((</span>result1<span class="op">,</span> result2<span class="op">)</span> <span class="op">=&gt;</span> <span class="fu">Right</span><span class="op">(</span>a<span class="op">))</span></span>
<span id="cb948-5"><a href="#cb948-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb948-6"><a href="#cb948-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// etc...</span></span>
<span id="cb948-7"><a href="#cb948-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>In our new formulation we can’t return <code>Right(a)</code>
    because its type is <code>Either[E, A]</code> not
    <code>Either[E, B]</code>. We’re forced to make an arbitrary choice
    between returning <code>Right(result1)</code> and
    <code>Right(result2)</code>. The same is true of the <code>or</code>
    method. From this we can derive two things:</p>
    <ul>
    <li>we should strive to make the laws we adhere to explicit;
    and</li>
    <li>the code is telling us we have the wrong abstraction in
    <code>Check</code>.</li>
    </ul>
    <h3 data-number="18.4.1" id="predicates"><span class="header-section-number">18.4.1</span> Predicates</h3>
    <p>We can make progress by pulling apart the concept of a
    <em>predicate</em>, which can be combined using logical operations
    such as <em>and</em> and <em>or</em>, and the concept of a
    <em>check</em>, which can transform data.</p>
    <p>What we have called <code>Check</code> so far we will call
    <code>Predicate</code>. For <code>Predicate</code> we can state the
    following <em>identity law</em> encoding the notion that a predicate
    always returns its input if it succeeds:</p>
    <blockquote>
    <p>For a predicate <code>p</code> of type
    <code>Predicate[E, A]</code> and elements <code>a1</code> and
    <code>a2</code> of type <code>A</code>, if
    <code>p(a1) == Success(a2)</code> then <code>a1 == a2</code>.</p>
    </blockquote>
    <p>Making this change gives us the following code:</p>
    <div class="sourceCode" id="cb949"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb949-1"><a href="#cb949-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Semigroup</span>
<span id="cb949-2"><a href="#cb949-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>data<span class="op">.</span>Validated</span>
<span id="cb949-3"><a href="#cb949-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>semigroup<span class="op">.</span>_ <span class="co">// for |+|</span></span>
<span id="cb949-4"><a href="#cb949-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>apply<span class="op">.</span>_     <span class="co">// for mapN</span></span>
<span id="cb949-5"><a href="#cb949-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>data<span class="op">.</span>Validated<span class="op">.</span>_   <span class="co">// for Valid and Invalid</span></span></code></pre></div>
    <div class="sourceCode" id="cb950"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb950-1"><a href="#cb950-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb950-2"><a href="#cb950-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">and</span><span class="op">(</span>that<span class="op">:</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">]):</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb950-3"><a href="#cb950-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">And</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb950-4"><a href="#cb950-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb950-5"><a href="#cb950-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">or</span><span class="op">(</span>that<span class="op">:</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">]):</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb950-6"><a href="#cb950-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Or</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb950-7"><a href="#cb950-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb950-8"><a href="#cb950-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>a<span class="op">:</span> A<span class="op">)(</span><span class="kw">implicit</span> s<span class="op">:</span> Semigroup<span class="op">[</span>E<span class="op">]):</span> Validated<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb950-9"><a href="#cb950-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb950-10"><a href="#cb950-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Pure</span><span class="op">(</span>func<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb950-11"><a href="#cb950-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">func</span><span class="op">(</span>a<span class="op">)</span></span>
<span id="cb950-12"><a href="#cb950-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb950-13"><a href="#cb950-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">And</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb950-14"><a href="#cb950-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span><span class="fu">left</span><span class="op">(</span>a<span class="op">),</span> <span class="fu">right</span><span class="op">(</span>a<span class="op">)).</span><span class="fu">mapN</span><span class="op">((</span>_<span class="op">,</span> _<span class="op">)</span> <span class="op">=&gt;</span> a<span class="op">)</span></span>
<span id="cb950-15"><a href="#cb950-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb950-16"><a href="#cb950-16" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Or</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb950-17"><a href="#cb950-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">left</span><span class="op">(</span>a<span class="op">)</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb950-18"><a href="#cb950-18" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> <span class="fu">Valid</span><span class="op">(</span>_<span class="op">)</span>   <span class="op">=&gt;</span> <span class="fu">Valid</span><span class="op">(</span>a<span class="op">)</span></span>
<span id="cb950-19"><a href="#cb950-19" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> <span class="ex">Invalid</span><span class="op">(</span>e1<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb950-20"><a href="#cb950-20" aria-hidden="true" tabindex="-1"></a>            <span class="fu">right</span><span class="op">(</span>a<span class="op">)</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb950-21"><a href="#cb950-21" aria-hidden="true" tabindex="-1"></a>              <span class="cf">case</span> <span class="fu">Valid</span><span class="op">(</span>_<span class="op">)</span>   <span class="op">=&gt;</span> <span class="fu">Valid</span><span class="op">(</span>a<span class="op">)</span></span>
<span id="cb950-22"><a href="#cb950-22" aria-hidden="true" tabindex="-1"></a>              <span class="cf">case</span> <span class="ex">Invalid</span><span class="op">(</span>e2<span class="op">)</span> <span class="op">=&gt;</span> <span class="ex">Invalid</span><span class="op">(</span>e1 <span class="op">|+|</span> e2<span class="op">)</span></span>
<span id="cb950-23"><a href="#cb950-23" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb950-24"><a href="#cb950-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb950-25"><a href="#cb950-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb950-26"><a href="#cb950-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb950-27"><a href="#cb950-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb950-28"><a href="#cb950-28" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> And<span class="op">[</span>E<span class="op">,</span> A<span class="op">](</span></span>
<span id="cb950-29"><a href="#cb950-29" aria-hidden="true" tabindex="-1"></a>  left<span class="op">:</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">],</span></span>
<span id="cb950-30"><a href="#cb950-30" aria-hidden="true" tabindex="-1"></a>  right<span class="op">:</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">])</span> <span class="kw">extends</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span></span>
<span id="cb950-31"><a href="#cb950-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb950-32"><a href="#cb950-32" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> Or<span class="op">[</span>E<span class="op">,</span> A<span class="op">](</span></span>
<span id="cb950-33"><a href="#cb950-33" aria-hidden="true" tabindex="-1"></a>  left<span class="op">:</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">],</span></span>
<span id="cb950-34"><a href="#cb950-34" aria-hidden="true" tabindex="-1"></a>  right<span class="op">:</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">])</span> <span class="kw">extends</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span></span>
<span id="cb950-35"><a href="#cb950-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb950-36"><a href="#cb950-36" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> Pure<span class="op">[</span>E<span class="op">,</span> A<span class="op">](</span></span>
<span id="cb950-37"><a href="#cb950-37" aria-hidden="true" tabindex="-1"></a>  func<span class="op">:</span> A <span class="op">=&gt;</span> Validated<span class="op">[</span>E<span class="op">,</span> A<span class="op">])</span> <span class="kw">extends</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span></span></code></pre></div>
    <h3 data-number="18.4.2" id="checks"><span class="header-section-number">18.4.2</span> Checks</h3>
    <p>We’ll use <code>Check</code> to represent a structure we build
    from a <code>Predicate</code> that also allows transformation of its
    input. Implement <code>Check</code> with the following
    interface:</p>
    <div class="sourceCode" id="cb951"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb951-1"><a href="#cb951-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">]</span> <span class="op">{</span></span>
<span id="cb951-2"><a href="#cb951-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>a<span class="op">:</span> A<span class="op">):</span> Validated<span class="op">[</span>E<span class="op">,</span> B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb951-3"><a href="#cb951-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb951-4"><a href="#cb951-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb951-5"><a href="#cb951-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>C<span class="op">](</span>func<span class="op">:</span> B <span class="op">=&gt;</span> C<span class="op">):</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> C<span class="op">]</span> <span class="op">=</span></span>
<span id="cb951-6"><a href="#cb951-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb951-7"><a href="#cb951-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <div class="solution">
    <p>If you follow the same strategy as <code>Predicate</code> you
    should be able to create code similar to the below:</p>
    <div class="sourceCode" id="cb952"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb952-1"><a href="#cb952-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Semigroup</span>
<span id="cb952-2"><a href="#cb952-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>data<span class="op">.</span>Validated</span></code></pre></div>
    <div class="sourceCode" id="cb953"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb953-1"><a href="#cb953-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">]</span> <span class="op">{</span></span>
<span id="cb953-2"><a href="#cb953-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">import</span> Check<span class="op">.</span>_</span>
<span id="cb953-3"><a href="#cb953-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb953-4"><a href="#cb953-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>in<span class="op">:</span> A<span class="op">)(</span><span class="kw">implicit</span> s<span class="op">:</span> Semigroup<span class="op">[</span>E<span class="op">]):</span> Validated<span class="op">[</span>E<span class="op">,</span> B<span class="op">]</span></span>
<span id="cb953-5"><a href="#cb953-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb953-6"><a href="#cb953-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>C<span class="op">](</span>f<span class="op">:</span> B <span class="op">=&gt;</span> C<span class="op">):</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> C<span class="op">]</span> <span class="op">=</span></span>
<span id="cb953-7"><a href="#cb953-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Map</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">,</span> C<span class="op">](</span><span class="kw">this</span><span class="op">,</span> f<span class="op">)</span></span>
<span id="cb953-8"><a href="#cb953-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb953-9"><a href="#cb953-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb953-10"><a href="#cb953-10" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Check <span class="op">{</span></span>
<span id="cb953-11"><a href="#cb953-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="ex">Map</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">,</span> C<span class="op">](</span></span>
<span id="cb953-12"><a href="#cb953-12" aria-hidden="true" tabindex="-1"></a>    check<span class="op">:</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">],</span></span>
<span id="cb953-13"><a href="#cb953-13" aria-hidden="true" tabindex="-1"></a>    func<span class="op">:</span> B <span class="op">=&gt;</span> C<span class="op">)</span> <span class="kw">extends</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> C<span class="op">]</span> <span class="op">{</span></span>
<span id="cb953-14"><a href="#cb953-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb953-15"><a href="#cb953-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>in<span class="op">:</span> A<span class="op">)(</span><span class="kw">implicit</span> s<span class="op">:</span> Semigroup<span class="op">[</span>E<span class="op">]):</span> Validated<span class="op">[</span>E<span class="op">,</span> C<span class="op">]</span> <span class="op">=</span></span>
<span id="cb953-16"><a href="#cb953-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">check</span><span class="op">(</span>in<span class="op">).</span><span class="fu">map</span><span class="op">(</span>func<span class="op">)</span></span>
<span id="cb953-17"><a href="#cb953-17" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb953-18"><a href="#cb953-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb953-19"><a href="#cb953-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> Pure<span class="op">[</span>E<span class="op">,</span> A<span class="op">](</span></span>
<span id="cb953-20"><a href="#cb953-20" aria-hidden="true" tabindex="-1"></a>    pred<span class="op">:</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">])</span> <span class="kw">extends</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb953-21"><a href="#cb953-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb953-22"><a href="#cb953-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>in<span class="op">:</span> A<span class="op">)(</span><span class="kw">implicit</span> s<span class="op">:</span> Semigroup<span class="op">[</span>E<span class="op">]):</span> Validated<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb953-23"><a href="#cb953-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pred</span><span class="op">(</span>in<span class="op">)</span></span>
<span id="cb953-24"><a href="#cb953-24" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb953-25"><a href="#cb953-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb953-26"><a href="#cb953-26" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> apply<span class="op">[</span>E<span class="op">,</span> A<span class="op">](</span>pred<span class="op">:</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">]):</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb953-27"><a href="#cb953-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Pure</span><span class="op">(</span>pred<span class="op">)</span></span>
<span id="cb953-28"><a href="#cb953-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    </div>
    <p>What about <code>flatMap</code>? The semantics are a bit unclear
    here. The method is simple enough to declare but it’s not so obvious
    what it means or how we should implement <code>apply</code>. The
    general shape of <code>flatMap</code> is shown in Figure 24.</p>
    <figure id="fig:validation:generic-flatmap">
    <svg id="svg_321a231bad3a1ef50c9a" alt="Type chart for flatMap" width="1921px" height="360px" viewBox="0 0 1921 360">
    <!-- Generator: Sketch 40.3 (33839) - http://www.bohemiancoding.com/sketch -->
    <title>generic-flatmap</title>
    <desc>Created with Sketch.</desc>
    <defs>
        <ellipse id="svg_321a231bad3a1ef50c9a_path-1" cx="885" cy="140" rx="80" ry="80"></ellipse>
        <mask id="svg_321a231bad3a1ef50c9a_mask-2" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="160" height="160" fill="white">
            <use xlink:href="#svg_321a231bad3a1ef50c9a_path-1" />
        </mask>
        <polygon id="svg_321a231bad3a1ef50c9a_path-3" points="101.595086 155 48.6944138 182.811529 58.7975432 123.905765 16 82.1884705 75.1447501 73.5942353 101.595086 20 128.045423 73.5942353 187.190173 82.1884705 144.39263 123.905765 154.495759 182.811529"></polygon>
        <mask id="svg_321a231bad3a1ef50c9a_mask-4" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="171.190173" height="162.811529" fill="white">
            <use xlink:href="#svg_321a231bad3a1ef50c9a_path-3" />
        </mask>
        <rect id="svg_321a231bad3a1ef50c9a_path-5" x="0" y="0" width="200" height="200" rx="8" />
        <mask id="svg_321a231bad3a1ef50c9a_mask-6" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="200" height="200" fill="white">
            <use xlink:href="#svg_321a231bad3a1ef50c9a_path-5" />
        </mask>
        <polygon id="svg_321a231bad3a1ef50c9a_path-7" points="101.595086 155 48.6944138 182.811529 58.7975432 123.905765 16 82.1884705 75.1447501 73.5942353 101.595086 20 128.045423 73.5942353 187.190173 82.1884705 144.39263 123.905765 154.495759 182.811529"></polygon>
        <mask id="svg_321a231bad3a1ef50c9a_mask-8" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="171.190173" height="162.811529" fill="white">
            <use xlink:href="#svg_321a231bad3a1ef50c9a_path-7" />
        </mask>
        <rect id="svg_321a231bad3a1ef50c9a_path-9" x="0" y="0" width="200" height="200" rx="8" />
        <mask id="svg_321a231bad3a1ef50c9a_mask-10" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="200" height="200" fill="white">
            <use xlink:href="#svg_321a231bad3a1ef50c9a_path-9" />
        </mask>
        <polygon id="svg_321a231bad3a1ef50c9a_path-11" points="994 120 1034 120 1034 100 1074 139.497767 1034 180 1034 160 994 160"></polygon>
        <mask id="svg_321a231bad3a1ef50c9a_mask-12" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="80" height="80" fill="white">
            <use xlink:href="#svg_321a231bad3a1ef50c9a_path-11" />
        </mask>
        <ellipse id="svg_321a231bad3a1ef50c9a_path-13" cx="100" cy="100" rx="80" ry="80"></ellipse>
        <mask id="svg_321a231bad3a1ef50c9a_mask-14" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="160" height="160" fill="white">
            <use xlink:href="#svg_321a231bad3a1ef50c9a_path-13" />
        </mask>
        <rect id="svg_321a231bad3a1ef50c9a_path-15" x="0" y="0" width="200" height="200" rx="8" />
        <mask id="svg_321a231bad3a1ef50c9a_mask-16" maskContentUnits="userSpaceOnUse" maskUnits="objectBoundingBox" x="0" y="0" width="200" height="200" fill="white">
            <use xlink:href="#svg_321a231bad3a1ef50c9a_path-15" />
        </mask>
    </defs>
    <g id="svg_321a231bad3a1ef50c9a_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_321a231bad3a1ef50c9a_generic-flatmap">
            <rect id="svg_321a231bad3a1ef50c9a_Background" fill="#FFFFFF" x="0" y="0" width="1921" height="360" />
            <use id="svg_321a231bad3a1ef50c9a_Oval-1" stroke="#000000" mask="url(#mask-2)" stroke-width="8" fill="#FFFFFF" xlink:href="#svg_321a231bad3a1ef50c9a_path-1" />
            <g id="svg_321a231bad3a1ef50c9a_Group" transform="translate(1459.000000, 37.000000)" stroke="#000000" stroke-width="8">
                <use id="svg_321a231bad3a1ef50c9a_Star-1" mask="url(#mask-4)" fill="#FFFFFF" xlink:href="#svg_321a231bad3a1ef50c9a_path-3" />
                <use id="svg_321a231bad3a1ef50c9a_Rectangle-1" mask="url(#mask-6)" xlink:href="#svg_321a231bad3a1ef50c9a_path-5" />
            </g>
            <g id="svg_321a231bad3a1ef50c9a_Group" transform="translate(1099.000000, 39.000000)" stroke="#000000" stroke-width="8">
                <use id="svg_321a231bad3a1ef50c9a_Star-1" mask="url(#mask-8)" fill="#FFFFFF" xlink:href="#svg_321a231bad3a1ef50c9a_path-7" />
                <use id="svg_321a231bad3a1ef50c9a_Rectangle-1" mask="url(#mask-10)" xlink:href="#svg_321a231bad3a1ef50c9a_path-9" />
            </g>
            <use id="svg_321a231bad3a1ef50c9a_Path-1" stroke="#000000" mask="url(#mask-12)" stroke-width="8" fill="#000000" xlink:href="#svg_321a231bad3a1ef50c9a_path-11" />
            <polygon id="svg_321a231bad3a1ef50c9a_Path-1" fill="#F6A623" points="1339 120 1379 120 1379 100 1419 139.497767 1379 180 1379 160 1339 160"></polygon>
            <text id="svg_321a231bad3a1ef50c9a_F[A]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="300.1" y="314">F[A]</tspan>
            </text>
            <text id="svg_321a231bad3a1ef50c9a_F[B]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="1512.6" y="314">F[B]</tspan>
            </text>
            <text id="svg_321a231bad3a1ef50c9a_A-=&gt;-F[B]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="945.6" y="314">A =&gt; F[B]</tspan>
            </text>
            <g id="svg_321a231bad3a1ef50c9a_Group-11" transform="translate(255.000000, 38.000000)" stroke="#000000" stroke-width="8">
                <use id="svg_321a231bad3a1ef50c9a_Oval-1" mask="url(#mask-14)" fill="#FFFFFF" xlink:href="#svg_321a231bad3a1ef50c9a_path-13" />
                <use id="svg_321a231bad3a1ef50c9a_Rectangle-1" mask="url(#mask-16)" xlink:href="#svg_321a231bad3a1ef50c9a_path-15" />
            </g>
            <text id="svg_321a231bad3a1ef50c9a_flatMap" font-family="FiraMono-Bold, Fira Mono" font-size="64" font-weight="bold" fill="#F6A623">
                <tspan x="496.2" y="155">flatMap</tspan>
            </text>
        </g>
    </g>
</svg>
    <figcaption>Figure 24: Type chart for flatMap</figcaption>
    </figure>
    <p>How do we relate <code>F</code> in the figure to
    <code>Check</code> in our code? <code>Check</code> has
    <em>three</em> type variables while <code>F</code> only has one.</p>
    <p>To unify the types we need to fix two of the type parameters. The
    idiomatic choices are the error type <code>E</code> and the input
    type <code>A</code>. This gives us the relationships shown in Figure
    25. In other words, the semantics of applying a <code>FlatMap</code>
    are:</p>
    <ul>
    <li><p>given an input of type <code>A</code>, convert to
    <code>F[B]</code>;</p></li>
    <li><p>use the output of type <code>B</code> to choose a
    <code>Check[E, A, C]</code>;</p></li>
    <li><p>return to the <em>original</em> input of type <code>A</code>
    and apply it to the chosen check to generate the final result of
    type <code>F[C]</code>.</p></li>
    </ul>
    <figure id="fig:validation:check-flatmap">
    <svg id="svg_af4c92286a8c01ebfd51" alt="Type chart for flatMap applied to Check" width="1614px" height="221px" viewBox="0 0 1614 221">
    <!-- Generator: Sketch 43.2 (39069) - http://www.bohemiancoding.com/sketch -->
    <title>flatmap</title>
    <desc>Created with Sketch.</desc>
    <defs>
        <polygon id="svg_af4c92286a8c01ebfd51_path-1" points="279.385663 100.013471 245.151257 117.8958 251.689447 80.0204196 223.99323 53.1969265 262.26846 47.6709831 279.385663 13.2108239 296.502867 47.6709831 334.778097 53.1969265 307.08188 80.0204196 313.62007 117.8958"></polygon>
        <ellipse id="svg_af4c92286a8c01ebfd51_path-2" cx="53.168329" cy="66.1042853" rx="53.168329" ry="52.8934614"></ellipse>
        <polygon id="svg_af4c92286a8c01ebfd51_path-3" points="267.026863 98.1362496 232.792456 116.018578 239.330646 78.1431983 211.634429 51.3197052 249.909659 45.7937617 267.026863 11.3336026 284.144066 45.7937617 322.419296 51.3197052 294.723079 78.1431983 301.261269 116.018578"></polygon>
        <ellipse id="svg_af4c92286a8c01ebfd51_path-4" cx="53.2969557" cy="67.3288411" rx="53.168329" ry="52.8934614"></ellipse>
        <ellipse id="svg_af4c92286a8c01ebfd51_path-5" cx="53.422681" cy="66.3288411" rx="53.168329" ry="52.8934614"></ellipse>
    </defs>
    <g id="svg_af4c92286a8c01ebfd51_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_af4c92286a8c01ebfd51_monadic" transform="translate(-155.000000, -358.000000)">
            <g id="svg_af4c92286a8c01ebfd51_flatmap" transform="translate(155.000000, 358.000000)">
                <g id="svg_af4c92286a8c01ebfd51_Group-10" transform="translate(0.000000, 2.000000)">
                    <g id="svg_af4c92286a8c01ebfd51_Star-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_af4c92286a8c01ebfd51_path-1" />
                        <path stroke="#000000" stroke-width="4" d="M247.810095,114.250545 L253.660298,80.3606353 L253.840095,79.3190787 L253.080844,78.5837521 L228.310883,54.5943066 L262.554245,49.6504595 L263.592833,49.5005145 L264.059655,48.5607134 L279.385663,17.7065679 L294.711672,48.5607134 L295.178494,49.5005145 L296.217082,49.6504595 L330.460444,54.5943066 L305.690483,78.5837521 L304.931232,79.3190787 L305.111029,80.3606353 L310.961232,114.250545 L280.311646,98.2407453 L279.385663,97.7570587 L278.459681,98.2407453 L247.810095,114.250545 Z" />
                    </g>
                    <g id="svg_af4c92286a8c01ebfd51_Oval-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_af4c92286a8c01ebfd51_path-2" />
                        <ellipse stroke="#000000" stroke-width="4" cx="53.168329" cy="66.1042853" rx="51.168329" ry="50.8934614"></ellipse>
                    </g>
                    <rect id="svg_af4c92286a8c01ebfd51_Rectangle-1" stroke="#000000" stroke-width="4" x="214.286267" y="2.02827141" width="128.920823" height="128.233654" rx="8" />
                    <polygon id="svg_af4c92286a8c01ebfd51_Path-1" fill="#000000" points="133.459381 54.3501828 160.043546 54.3501828 160.043546 41.1268174 186.62771 67.2414877 160.043546 94.0202789 160.043546 80.7969135 133.459381 80.7969135"></polygon>
                </g>
                <g id="svg_af4c92286a8c01ebfd51_Group-8" transform="translate(586.000000, 0.000000)">
                    <g id="svg_af4c92286a8c01ebfd51_Star-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_af4c92286a8c01ebfd51_path-3" />
                        <path stroke="#000000" stroke-width="4" d="M235.451294,112.373323 L241.301497,78.483414 L241.481294,77.4418574 L240.722043,76.7065308 L215.952082,52.7170852 L250.195444,47.7732382 L251.234032,47.6232932 L251.700855,46.6834921 L267.026863,15.8293466 L282.352871,46.6834921 L282.819693,47.6232932 L283.858281,47.7732382 L318.101643,52.7170852 L293.331682,76.7065308 L292.572431,77.4418574 L292.752228,78.483414 L298.602431,112.373323 L267.952845,96.363524 L267.026863,95.8798373 L266.10088,96.363524 L235.451294,112.373323 Z" />
                    </g>
                    <polygon id="svg_af4c92286a8c01ebfd51_Path-1" fill="#000000" points="347.435203 53.2484057 374.019368 53.2484057 374.019368 40.0250404 400.603532 66.1397107 374.019368 92.9185018 374.019368 79.6951365 347.435203 79.6951365"></polygon>
                    <rect id="svg_af4c92286a8c01ebfd51_Rectangle-1" stroke="#000000" stroke-width="4" x="428.800647" y="2.47738288" width="128.920823" height="128.233654" rx="8" />
                    <g id="svg_af4c92286a8c01ebfd51_Oval-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_af4c92286a8c01ebfd51_path-4" />
                        <ellipse stroke="#000000" stroke-width="4" cx="53.2969557" cy="67.3288411" rx="51.168329" ry="50.8934614"></ellipse>
                    </g>
                    <polygon id="svg_af4c92286a8c01ebfd51_Path-1" fill="#000000" points="133.588008 55.5747385 160.172172 55.5747385 160.172172 42.3513732 186.756337 68.4660435 160.172172 95.2448346 160.172172 82.0214693 133.588008 82.0214693"></polygon>
                    <polygon id="svg_af4c92286a8c01ebfd51_Polygon" stroke="#000000" stroke-width="4" fill="#FFFFFF" points="493.082597 23 539.165194 56.2656167 521.563208 110.090515 464.601986 110.090515 447 56.2656167"></polygon>
                </g>
                <text id="svg_af4c92286a8c01ebfd51_A-=&gt;-F[B]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                    <tspan x="59.4670213" y="215">A =&gt; F[B]</tspan>
                </text>
                <text id="svg_af4c92286a8c01ebfd51_B-=&gt;-(A-=&gt;-F[C])" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                    <tspan x="664.570696" y="215">B =&gt; (A =&gt; F[C])</tspan>
                </text>
                <text id="svg_af4c92286a8c01ebfd51_A-=&gt;-F[C]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                    <tspan x="1327.1103" y="215">A =&gt; F[C]</tspan>
                </text>
                <g id="svg_af4c92286a8c01ebfd51_Group-9" transform="translate(1268.000000, 1.000000)">
                    <g id="svg_af4c92286a8c01ebfd51_Oval-1">
                        <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_af4c92286a8c01ebfd51_path-5" />
                        <ellipse stroke="#000000" stroke-width="4" cx="53.422681" cy="66.3288411" rx="51.168329" ry="50.8934614"></ellipse>
                    </g>
                    <polygon id="svg_af4c92286a8c01ebfd51_Path-1" fill="#000000" points="133.713733 53.02385 160.297898 53.02385 160.297898 39.8004847 186.882062 65.9151549 160.297898 92.6939461 160.297898 79.4705807 133.713733 79.4705807"></polygon>
                    <rect id="svg_af4c92286a8c01ebfd51_Rectangle-1" stroke="#000000" stroke-width="4" x="215.079177" y="2.25282714" width="128.920823" height="128.233654" rx="8" />
                    <polygon id="svg_af4c92286a8c01ebfd51_Polygon" stroke="#000000" stroke-width="4" fill="#FFFFFF" points="280.082597 23 326.165194 56.2656167 308.563208 110.090515 251.601986 110.090515 234 56.2656167"></polygon>
                </g>
                <polygon id="svg_af4c92286a8c01ebfd51_Path-1" fill="#F6A623" points="1178.50097 53.2075929 1209.71954 53.2075929 1209.71954 37.6987076 1240.9381 68.3270246 1209.71954 99.7342488 1209.71954 84.2253635 1178.50097 84.2253635"></polygon>
                <text id="svg_af4c92286a8c01ebfd51_flatMap" font-family="FiraMono-Bold, Fira Mono" font-size="45" font-weight="bold" fill="#F6A623">
                    <tspan x="375.781673" y="82">flatMap</tspan>
                </text>
            </g>
        </g>
    </g>
</svg>
    <figcaption>Figure 25: Type chart for flatMap applied to
    Check</figcaption>
    </figure>
    <p>This is quite an odd method. We can implement it, but it is hard
    to find a use for it. Go ahead and implement <code>flatMap</code>
    for <code>Check</code>, and then we’ll see a more generally useful
    method.</p>
    <div class="solution">
    <p>It’s the same implementation strategy as before with one wrinkle:
    <code>Validated</code> doesn’t have a <code>flatMap</code> method.
    To implement <code>flatMap</code> we must momentarily switch to
    <code>Either</code> and then switch back to <code>Validated</code>.
    The <code>withEither</code> method on <code>Validated</code> does
    exactly this. From here we can just follow the types to implement
    <code>apply</code>.</p>
    <div class="sourceCode" id="cb954"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb954-1"><a href="#cb954-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Semigroup</span>
<span id="cb954-2"><a href="#cb954-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>data<span class="op">.</span>Validated</span></code></pre></div>
    <div class="sourceCode" id="cb955"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb955-1"><a href="#cb955-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">]</span> <span class="op">{</span></span>
<span id="cb955-2"><a href="#cb955-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>in<span class="op">:</span> A<span class="op">)(</span><span class="kw">implicit</span> s<span class="op">:</span> Semigroup<span class="op">[</span>E<span class="op">]):</span> Validated<span class="op">[</span>E<span class="op">,</span> B<span class="op">]</span></span>
<span id="cb955-3"><a href="#cb955-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb955-4"><a href="#cb955-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> flatMap<span class="op">[</span>C<span class="op">](</span>f<span class="op">:</span> B <span class="op">=&gt;</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> C<span class="op">])</span> <span class="op">=</span></span>
<span id="cb955-5"><a href="#cb955-5" aria-hidden="true" tabindex="-1"></a>    FlatMap<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">,</span> C<span class="op">](</span><span class="kw">this</span><span class="op">,</span> f<span class="op">)</span></span>
<span id="cb955-6"><a href="#cb955-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb955-7"><a href="#cb955-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// other methods...</span></span>
<span id="cb955-8"><a href="#cb955-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb955-9"><a href="#cb955-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb955-10"><a href="#cb955-10" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> FlatMap<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">,</span> C<span class="op">](</span></span>
<span id="cb955-11"><a href="#cb955-11" aria-hidden="true" tabindex="-1"></a>  check<span class="op">:</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">],</span></span>
<span id="cb955-12"><a href="#cb955-12" aria-hidden="true" tabindex="-1"></a>  func<span class="op">:</span> B <span class="op">=&gt;</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> C<span class="op">])</span> <span class="kw">extends</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> C<span class="op">]</span> <span class="op">{</span></span>
<span id="cb955-13"><a href="#cb955-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb955-14"><a href="#cb955-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>a<span class="op">:</span> A<span class="op">)(</span><span class="kw">implicit</span> s<span class="op">:</span> Semigroup<span class="op">[</span>E<span class="op">]):</span> Validated<span class="op">[</span>E<span class="op">,</span> C<span class="op">]</span> <span class="op">=</span></span>
<span id="cb955-15"><a href="#cb955-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">check</span><span class="op">(</span>a<span class="op">).</span><span class="fu">withEither</span><span class="op">(</span>_<span class="op">.</span><span class="fu">flatMap</span><span class="op">(</span>b <span class="op">=&gt;</span> <span class="fu">func</span><span class="op">(</span>b<span class="op">)(</span>a<span class="op">).</span>toEither<span class="op">))</span></span>
<span id="cb955-16"><a href="#cb955-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb955-17"><a href="#cb955-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb955-18"><a href="#cb955-18" aria-hidden="true" tabindex="-1"></a><span class="co">// other data types...</span></span></code></pre></div>
    </div>
    <p>We can write a more useful combinator that chains together two
    <code>Checks</code>. The output of the first check is connected to
    the input of the second. This is analogous to function composition
    using <code>andThen</code>:</p>
    <div class="sourceCode" id="cb956"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb956-1"><a href="#cb956-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> f<span class="op">:</span> A <span class="op">=&gt;</span> B <span class="op">=</span> <span class="op">???</span></span>
<span id="cb956-2"><a href="#cb956-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> g<span class="op">:</span> B <span class="op">=&gt;</span> C <span class="op">=</span> <span class="op">???</span></span>
<span id="cb956-3"><a href="#cb956-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> h<span class="op">:</span> A <span class="op">=&gt;</span> C <span class="op">=</span> f andThen g</span></code></pre></div>
    <p>A <code>Check</code> is basically a function
    <code>A =&gt; Validated[E, B]</code> so we can define an analagous
    <code>andThen</code> method:</p>
    <div class="sourceCode" id="cb957"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb957-1"><a href="#cb957-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">]</span> <span class="op">{</span></span>
<span id="cb957-2"><a href="#cb957-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> andThen<span class="op">[</span>C<span class="op">](</span>that<span class="op">:</span> Check<span class="op">[</span>E<span class="op">,</span> B<span class="op">,</span> C<span class="op">]):</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> C<span class="op">]</span></span>
<span id="cb957-3"><a href="#cb957-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Implement <code>andThen</code> now!</p>
    <div class="solution">
    <p>Here’s a minimal definition of <code>andThen</code> and its
    corresponding <code>AndThen</code> class:</p>
    <div class="sourceCode" id="cb958"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb958-1"><a href="#cb958-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">]</span> <span class="op">{</span></span>
<span id="cb958-2"><a href="#cb958-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>in<span class="op">:</span> A<span class="op">)(</span><span class="kw">implicit</span> s<span class="op">:</span> Semigroup<span class="op">[</span>E<span class="op">]):</span> Validated<span class="op">[</span>E<span class="op">,</span> B<span class="op">]</span></span>
<span id="cb958-3"><a href="#cb958-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb958-4"><a href="#cb958-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> andThen<span class="op">[</span>C<span class="op">](</span>that<span class="op">:</span> Check<span class="op">[</span>E<span class="op">,</span> B<span class="op">,</span> C<span class="op">]):</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> C<span class="op">]</span> <span class="op">=</span></span>
<span id="cb958-5"><a href="#cb958-5" aria-hidden="true" tabindex="-1"></a>    AndThen<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">,</span> C<span class="op">](</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb958-6"><a href="#cb958-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb958-7"><a href="#cb958-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb958-8"><a href="#cb958-8" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> AndThen<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">,</span> C<span class="op">](</span></span>
<span id="cb958-9"><a href="#cb958-9" aria-hidden="true" tabindex="-1"></a>  check1<span class="op">:</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">],</span></span>
<span id="cb958-10"><a href="#cb958-10" aria-hidden="true" tabindex="-1"></a>  check2<span class="op">:</span> Check<span class="op">[</span>E<span class="op">,</span> B<span class="op">,</span> C<span class="op">])</span> <span class="kw">extends</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> C<span class="op">]</span> <span class="op">{</span></span>
<span id="cb958-11"><a href="#cb958-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb958-12"><a href="#cb958-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>a<span class="op">:</span> A<span class="op">)(</span><span class="kw">implicit</span> s<span class="op">:</span> Semigroup<span class="op">[</span>E<span class="op">]):</span> Validated<span class="op">[</span>E<span class="op">,</span> C<span class="op">]</span> <span class="op">=</span></span>
<span id="cb958-13"><a href="#cb958-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">check1</span><span class="op">(</span>a<span class="op">).</span><span class="fu">withEither</span><span class="op">(</span>_<span class="op">.</span><span class="fu">flatMap</span><span class="op">(</span>b <span class="op">=&gt;</span> <span class="fu">check2</span><span class="op">(</span>b<span class="op">).</span>toEither<span class="op">))</span></span>
<span id="cb958-14"><a href="#cb958-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    </div>
    <h3 data-number="18.4.3" id="recap"><span class="header-section-number">18.4.3</span> Recap</h3>
    <p>We now have two algebraic data types, <code>Predicate</code> and
    <code>Check</code>, and a host of combinators with their associated
    case class implementations. Look at the following solution for a
    complete definition of each ADT.</p>
    <div class="solution">
    <p>Here’s our final implementaton, including some tidying and
    repackaging of the code:</p>
    <div class="sourceCode" id="cb959"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb959-1"><a href="#cb959-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Semigroup</span>
<span id="cb959-2"><a href="#cb959-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>data<span class="op">.</span>Validated</span>
<span id="cb959-3"><a href="#cb959-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>data<span class="op">.</span>Validated<span class="op">.</span>_   <span class="co">// for Valid and Invalid</span></span>
<span id="cb959-4"><a href="#cb959-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>semigroup<span class="op">.</span>_ <span class="co">// for |+|</span></span>
<span id="cb959-5"><a href="#cb959-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>apply<span class="op">.</span>_     <span class="co">// for mapN</span></span>
<span id="cb959-6"><a href="#cb959-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>validated<span class="op">.</span>_ <span class="co">// for valid and invalid</span></span></code></pre></div>
    <p>Here is our complete implementation of <code>Predicate</code>,
    including the <code>and</code> and <code>or</code> combinators and a
    <code>Predicate.apply</code> method to create a
    <code>Predicate</code> from a function:</p>
    <div class="sourceCode" id="cb960"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb960-1"><a href="#cb960-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb960-2"><a href="#cb960-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">import</span> <span class="ex">Predicate</span><span class="op">.</span>_</span>
<span id="cb960-3"><a href="#cb960-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">import</span> Validated<span class="op">.</span>_</span>
<span id="cb960-4"><a href="#cb960-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb960-5"><a href="#cb960-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">and</span><span class="op">(</span>that<span class="op">:</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">]):</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb960-6"><a href="#cb960-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">And</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb960-7"><a href="#cb960-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb960-8"><a href="#cb960-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">or</span><span class="op">(</span>that<span class="op">:</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">]):</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb960-9"><a href="#cb960-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Or</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> that<span class="op">)</span></span>
<span id="cb960-10"><a href="#cb960-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb960-11"><a href="#cb960-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>a<span class="op">:</span> A<span class="op">)(</span><span class="kw">implicit</span> s<span class="op">:</span> Semigroup<span class="op">[</span>E<span class="op">]):</span> Validated<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb960-12"><a href="#cb960-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb960-13"><a href="#cb960-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Pure</span><span class="op">(</span>func<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb960-14"><a href="#cb960-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">func</span><span class="op">(</span>a<span class="op">)</span></span>
<span id="cb960-15"><a href="#cb960-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb960-16"><a href="#cb960-16" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">And</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb960-17"><a href="#cb960-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span><span class="fu">left</span><span class="op">(</span>a<span class="op">),</span> <span class="fu">right</span><span class="op">(</span>a<span class="op">)).</span><span class="fu">mapN</span><span class="op">((</span>_<span class="op">,</span> _<span class="op">)</span> <span class="op">=&gt;</span> a<span class="op">)</span></span>
<span id="cb960-18"><a href="#cb960-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb960-19"><a href="#cb960-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Or</span><span class="op">(</span>left<span class="op">,</span> right<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb960-20"><a href="#cb960-20" aria-hidden="true" tabindex="-1"></a>        <span class="fu">left</span><span class="op">(</span>a<span class="op">)</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb960-21"><a href="#cb960-21" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> <span class="fu">Valid</span><span class="op">(</span>_<span class="op">)</span>   <span class="op">=&gt;</span> <span class="fu">Valid</span><span class="op">(</span>a<span class="op">)</span></span>
<span id="cb960-22"><a href="#cb960-22" aria-hidden="true" tabindex="-1"></a>          <span class="cf">case</span> <span class="ex">Invalid</span><span class="op">(</span>e1<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb960-23"><a href="#cb960-23" aria-hidden="true" tabindex="-1"></a>            <span class="fu">right</span><span class="op">(</span>a<span class="op">)</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb960-24"><a href="#cb960-24" aria-hidden="true" tabindex="-1"></a>              <span class="cf">case</span> <span class="fu">Valid</span><span class="op">(</span>_<span class="op">)</span>   <span class="op">=&gt;</span> <span class="fu">Valid</span><span class="op">(</span>a<span class="op">)</span></span>
<span id="cb960-25"><a href="#cb960-25" aria-hidden="true" tabindex="-1"></a>              <span class="cf">case</span> <span class="ex">Invalid</span><span class="op">(</span>e2<span class="op">)</span> <span class="op">=&gt;</span> <span class="ex">Invalid</span><span class="op">(</span>e1 <span class="op">|+|</span> e2<span class="op">)</span></span>
<span id="cb960-26"><a href="#cb960-26" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb960-27"><a href="#cb960-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb960-28"><a href="#cb960-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb960-29"><a href="#cb960-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb960-30"><a href="#cb960-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb960-31"><a href="#cb960-31" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> <span class="ex">Predicate</span> <span class="op">{</span></span>
<span id="cb960-32"><a href="#cb960-32" aria-hidden="true" tabindex="-1"></a>  <span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> And<span class="op">[</span>E<span class="op">,</span> A<span class="op">](</span></span>
<span id="cb960-33"><a href="#cb960-33" aria-hidden="true" tabindex="-1"></a>    left<span class="op">:</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">],</span></span>
<span id="cb960-34"><a href="#cb960-34" aria-hidden="true" tabindex="-1"></a>    right<span class="op">:</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">])</span> <span class="kw">extends</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span></span>
<span id="cb960-35"><a href="#cb960-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb960-36"><a href="#cb960-36" aria-hidden="true" tabindex="-1"></a>  <span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> Or<span class="op">[</span>E<span class="op">,</span> A<span class="op">](</span></span>
<span id="cb960-37"><a href="#cb960-37" aria-hidden="true" tabindex="-1"></a>    left<span class="op">:</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">],</span></span>
<span id="cb960-38"><a href="#cb960-38" aria-hidden="true" tabindex="-1"></a>    right<span class="op">:</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">])</span> <span class="kw">extends</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span></span>
<span id="cb960-39"><a href="#cb960-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb960-40"><a href="#cb960-40" aria-hidden="true" tabindex="-1"></a>  <span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> Pure<span class="op">[</span>E<span class="op">,</span> A<span class="op">](</span></span>
<span id="cb960-41"><a href="#cb960-41" aria-hidden="true" tabindex="-1"></a>    func<span class="op">:</span> A <span class="op">=&gt;</span> Validated<span class="op">[</span>E<span class="op">,</span> A<span class="op">])</span> <span class="kw">extends</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span></span>
<span id="cb960-42"><a href="#cb960-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb960-43"><a href="#cb960-43" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> apply<span class="op">[</span>E<span class="op">,</span> A<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> Validated<span class="op">[</span>E<span class="op">,</span> A<span class="op">]):</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb960-44"><a href="#cb960-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Pure</span><span class="op">(</span>f<span class="op">)</span></span>
<span id="cb960-45"><a href="#cb960-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb960-46"><a href="#cb960-46" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> lift<span class="op">[</span>E<span class="op">,</span> A<span class="op">](</span>err<span class="op">:</span> E<span class="op">,</span> fn<span class="op">:</span> A <span class="op">=&gt;</span> <span class="ex">Boolean</span><span class="op">):</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb960-47"><a href="#cb960-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Pure</span><span class="op">(</span>a <span class="op">=&gt;</span> <span class="cf">if</span><span class="op">(</span><span class="fu">fn</span><span class="op">(</span>a<span class="op">))</span> a<span class="op">.</span>valid <span class="cf">else</span> err<span class="op">.</span>invalid<span class="op">)</span></span>
<span id="cb960-48"><a href="#cb960-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Here is a complete implementation of <code>Check</code>. Due to
    <a href="https://issues.scala-lang.org/browse/SI-6680">a type
    inference bug</a> in Scala’s pattern matching, we’ve switched to
    implementing <code>apply</code> using inheritance:</p>
    <div class="sourceCode" id="cb961"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb961-1"><a href="#cb961-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Semigroup</span>
<span id="cb961-2"><a href="#cb961-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>data<span class="op">.</span>Validated</span>
<span id="cb961-3"><a href="#cb961-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>apply<span class="op">.</span>_     <span class="co">// for mapN</span></span>
<span id="cb961-4"><a href="#cb961-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>validated<span class="op">.</span>_ <span class="co">// for valid and invalid</span></span></code></pre></div>
    <div class="sourceCode" id="cb962"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb962-1"><a href="#cb962-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">]</span> <span class="op">{</span></span>
<span id="cb962-2"><a href="#cb962-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">import</span> Check<span class="op">.</span>_</span>
<span id="cb962-3"><a href="#cb962-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb962-4"><a href="#cb962-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>in<span class="op">:</span> A<span class="op">)(</span><span class="kw">implicit</span> s<span class="op">:</span> Semigroup<span class="op">[</span>E<span class="op">]):</span> Validated<span class="op">[</span>E<span class="op">,</span> B<span class="op">]</span></span>
<span id="cb962-5"><a href="#cb962-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb962-6"><a href="#cb962-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>C<span class="op">](</span>f<span class="op">:</span> B <span class="op">=&gt;</span> C<span class="op">):</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> C<span class="op">]</span> <span class="op">=</span></span>
<span id="cb962-7"><a href="#cb962-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Map</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">,</span> C<span class="op">](</span><span class="kw">this</span><span class="op">,</span> f<span class="op">)</span></span>
<span id="cb962-8"><a href="#cb962-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb962-9"><a href="#cb962-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> flatMap<span class="op">[</span>C<span class="op">](</span>f<span class="op">:</span> B <span class="op">=&gt;</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> C<span class="op">])</span> <span class="op">=</span></span>
<span id="cb962-10"><a href="#cb962-10" aria-hidden="true" tabindex="-1"></a>    FlatMap<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">,</span> C<span class="op">](</span><span class="kw">this</span><span class="op">,</span> f<span class="op">)</span></span>
<span id="cb962-11"><a href="#cb962-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb962-12"><a href="#cb962-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> andThen<span class="op">[</span>C<span class="op">](</span>next<span class="op">:</span> Check<span class="op">[</span>E<span class="op">,</span> B<span class="op">,</span> C<span class="op">]):</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> C<span class="op">]</span> <span class="op">=</span></span>
<span id="cb962-13"><a href="#cb962-13" aria-hidden="true" tabindex="-1"></a>    AndThen<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">,</span> C<span class="op">](</span><span class="kw">this</span><span class="op">,</span> next<span class="op">)</span></span>
<span id="cb962-14"><a href="#cb962-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb962-15"><a href="#cb962-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb962-16"><a href="#cb962-16" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Check <span class="op">{</span></span>
<span id="cb962-17"><a href="#cb962-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="ex">Map</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">,</span> C<span class="op">](</span></span>
<span id="cb962-18"><a href="#cb962-18" aria-hidden="true" tabindex="-1"></a>    check<span class="op">:</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">],</span></span>
<span id="cb962-19"><a href="#cb962-19" aria-hidden="true" tabindex="-1"></a>    func<span class="op">:</span> B <span class="op">=&gt;</span> C<span class="op">)</span> <span class="kw">extends</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> C<span class="op">]</span> <span class="op">{</span></span>
<span id="cb962-20"><a href="#cb962-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb962-21"><a href="#cb962-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>a<span class="op">:</span> A<span class="op">)</span></span>
<span id="cb962-22"><a href="#cb962-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span><span class="kw">implicit</span> s<span class="op">:</span> Semigroup<span class="op">[</span>E<span class="op">]):</span> Validated<span class="op">[</span>E<span class="op">,</span> C<span class="op">]</span> <span class="op">=</span></span>
<span id="cb962-23"><a href="#cb962-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">check</span><span class="op">(</span>a<span class="op">)</span> map func</span>
<span id="cb962-24"><a href="#cb962-24" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb962-25"><a href="#cb962-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb962-26"><a href="#cb962-26" aria-hidden="true" tabindex="-1"></a>  <span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> FlatMap<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">,</span> C<span class="op">](</span></span>
<span id="cb962-27"><a href="#cb962-27" aria-hidden="true" tabindex="-1"></a>    check<span class="op">:</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">],</span></span>
<span id="cb962-28"><a href="#cb962-28" aria-hidden="true" tabindex="-1"></a>    func<span class="op">:</span> B <span class="op">=&gt;</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> C<span class="op">])</span> <span class="kw">extends</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> C<span class="op">]</span> <span class="op">{</span></span>
<span id="cb962-29"><a href="#cb962-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb962-30"><a href="#cb962-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>a<span class="op">:</span> A<span class="op">)</span></span>
<span id="cb962-31"><a href="#cb962-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span><span class="kw">implicit</span> s<span class="op">:</span> Semigroup<span class="op">[</span>E<span class="op">]):</span> Validated<span class="op">[</span>E<span class="op">,</span> C<span class="op">]</span> <span class="op">=</span></span>
<span id="cb962-32"><a href="#cb962-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">check</span><span class="op">(</span>a<span class="op">).</span><span class="fu">withEither</span><span class="op">(</span>_<span class="op">.</span><span class="fu">flatMap</span><span class="op">(</span>b <span class="op">=&gt;</span> <span class="fu">func</span><span class="op">(</span>b<span class="op">)(</span>a<span class="op">).</span>toEither<span class="op">))</span></span>
<span id="cb962-33"><a href="#cb962-33" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb962-34"><a href="#cb962-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb962-35"><a href="#cb962-35" aria-hidden="true" tabindex="-1"></a>  <span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> AndThen<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">,</span> C<span class="op">](</span></span>
<span id="cb962-36"><a href="#cb962-36" aria-hidden="true" tabindex="-1"></a>    check<span class="op">:</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">],</span></span>
<span id="cb962-37"><a href="#cb962-37" aria-hidden="true" tabindex="-1"></a>    next<span class="op">:</span> Check<span class="op">[</span>E<span class="op">,</span> B<span class="op">,</span> C<span class="op">])</span> <span class="kw">extends</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> C<span class="op">]</span> <span class="op">{</span></span>
<span id="cb962-38"><a href="#cb962-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb962-39"><a href="#cb962-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>a<span class="op">:</span> A<span class="op">)</span></span>
<span id="cb962-40"><a href="#cb962-40" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span><span class="kw">implicit</span> s<span class="op">:</span> Semigroup<span class="op">[</span>E<span class="op">]):</span> Validated<span class="op">[</span>E<span class="op">,</span> C<span class="op">]</span> <span class="op">=</span></span>
<span id="cb962-41"><a href="#cb962-41" aria-hidden="true" tabindex="-1"></a>      <span class="fu">check</span><span class="op">(</span>a<span class="op">).</span><span class="fu">withEither</span><span class="op">(</span>_<span class="op">.</span><span class="fu">flatMap</span><span class="op">(</span>b <span class="op">=&gt;</span> <span class="fu">next</span><span class="op">(</span>b<span class="op">).</span>toEither<span class="op">))</span></span>
<span id="cb962-42"><a href="#cb962-42" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb962-43"><a href="#cb962-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb962-44"><a href="#cb962-44" aria-hidden="true" tabindex="-1"></a>  <span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> Pure<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">](</span></span>
<span id="cb962-45"><a href="#cb962-45" aria-hidden="true" tabindex="-1"></a>    func<span class="op">:</span> A <span class="op">=&gt;</span> Validated<span class="op">[</span>E<span class="op">,</span> B<span class="op">])</span> <span class="kw">extends</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">]</span> <span class="op">{</span></span>
<span id="cb962-46"><a href="#cb962-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb962-47"><a href="#cb962-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>a<span class="op">:</span> A<span class="op">)</span></span>
<span id="cb962-48"><a href="#cb962-48" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span><span class="kw">implicit</span> s<span class="op">:</span> Semigroup<span class="op">[</span>E<span class="op">]):</span> Validated<span class="op">[</span>E<span class="op">,</span> B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb962-49"><a href="#cb962-49" aria-hidden="true" tabindex="-1"></a>      <span class="fu">func</span><span class="op">(</span>a<span class="op">)</span></span>
<span id="cb962-50"><a href="#cb962-50" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb962-51"><a href="#cb962-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb962-52"><a href="#cb962-52" aria-hidden="true" tabindex="-1"></a>  <span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> PurePredicate<span class="op">[</span>E<span class="op">,</span> A<span class="op">](</span></span>
<span id="cb962-53"><a href="#cb962-53" aria-hidden="true" tabindex="-1"></a>    pred<span class="op">:</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">])</span> <span class="kw">extends</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb962-54"><a href="#cb962-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb962-55"><a href="#cb962-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>a<span class="op">:</span> A<span class="op">)</span></span>
<span id="cb962-56"><a href="#cb962-56" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span><span class="kw">implicit</span> s<span class="op">:</span> Semigroup<span class="op">[</span>E<span class="op">]):</span> Validated<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb962-57"><a href="#cb962-57" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pred</span><span class="op">(</span>a<span class="op">)</span></span>
<span id="cb962-58"><a href="#cb962-58" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb962-59"><a href="#cb962-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb962-60"><a href="#cb962-60" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> apply<span class="op">[</span>E<span class="op">,</span> A<span class="op">](</span>pred<span class="op">:</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">]):</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb962-61"><a href="#cb962-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">PurePredicate</span><span class="op">(</span>pred<span class="op">)</span></span>
<span id="cb962-62"><a href="#cb962-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb962-63"><a href="#cb962-63" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> apply<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">]</span></span>
<span id="cb962-64"><a href="#cb962-64" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>func<span class="op">:</span> A <span class="op">=&gt;</span> Validated<span class="op">[</span>E<span class="op">,</span> B<span class="op">]):</span> Check<span class="op">[</span>E<span class="op">,</span> A<span class="op">,</span> B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb962-65"><a href="#cb962-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Pure</span><span class="op">(</span>func<span class="op">)</span></span>
<span id="cb962-66"><a href="#cb962-66" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    </div>
    <p>We have a complete implementation of <code>Check</code> and
    <code>Predicate</code> that do most of what we originally set out to
    do. However, we are not finished yet. You have probably recognised
    structure in <code>Predicate</code> and <code>Check</code> that we
    can abstract over: <code>Predicate</code> has a monoid and
    <code>Check</code> has a monad. Furthermore, in implementing
    <code>Check</code> you might have felt the implementation doesn’t do
    much—all we do is call through to underlying methods on
    <code>Predicate</code> and <code>Validated</code>.</p>
    <p>There are a lot of ways this library could be cleaned up.
    However, let’s implement some examples to prove to ourselves that
    our library really does work, and then we’ll turn to improving
    it.</p>
    <p>Implement checks for some of the examples given in the
    introduction:</p>
    <ul>
    <li><p>A username must contain at least four characters and consist
    entirely of alphanumeric characters</p></li>
    <li><p>An email address must contain an <code>@</code> sign. Split
    the string at the <code>@</code>. The string to the left must not be
    empty. The string to the right must be at least three characters
    long and contain a dot.</p></li>
    </ul>
    <p>You might find the following predicates useful:</p>
    <div class="sourceCode" id="cb963"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb963-1"><a href="#cb963-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>data<span class="op">.{</span>NonEmptyList<span class="op">,</span> Validated<span class="op">}</span></span></code></pre></div>
    <div class="sourceCode" id="cb964"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb964-1"><a href="#cb964-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Errors <span class="op">=</span> NonEmptyList<span class="op">[</span><span class="ex">String</span><span class="op">]</span></span>
<span id="cb964-2"><a href="#cb964-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb964-3"><a href="#cb964-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">error</span><span class="op">(</span>s<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> NonEmptyList<span class="op">[</span><span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb964-4"><a href="#cb964-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">NonEmptyList</span><span class="op">(</span>s<span class="op">,</span> Nil<span class="op">)</span></span>
<span id="cb964-5"><a href="#cb964-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb964-6"><a href="#cb964-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">longerThan</span><span class="op">(</span>n<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="ex">Predicate</span><span class="op">[</span>Errors<span class="op">,</span> <span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb964-7"><a href="#cb964-7" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Predicate</span><span class="op">.</span><span class="fu">lift</span><span class="op">(</span></span>
<span id="cb964-8"><a href="#cb964-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">error</span><span class="op">(</span><span class="ss">s&quot;</span><span class="st">Must be longer than </span><span class="ss">$n</span><span class="st"> characters</span><span class="ss">&quot;</span><span class="op">),</span></span>
<span id="cb964-9"><a href="#cb964-9" aria-hidden="true" tabindex="-1"></a>    str <span class="op">=&gt;</span> str<span class="op">.</span>size <span class="op">&gt;</span> n<span class="op">)</span></span>
<span id="cb964-10"><a href="#cb964-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb964-11"><a href="#cb964-11" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> alphanumeric<span class="op">:</span> <span class="ex">Predicate</span><span class="op">[</span>Errors<span class="op">,</span> <span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb964-12"><a href="#cb964-12" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Predicate</span><span class="op">.</span><span class="fu">lift</span><span class="op">(</span></span>
<span id="cb964-13"><a href="#cb964-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">error</span><span class="op">(</span><span class="ss">s&quot;</span><span class="st">Must be all alphanumeric characters</span><span class="ss">&quot;</span><span class="op">),</span></span>
<span id="cb964-14"><a href="#cb964-14" aria-hidden="true" tabindex="-1"></a>    str <span class="op">=&gt;</span> str<span class="op">.</span><span class="fu">forall</span><span class="op">(</span>_<span class="op">.</span>isLetterOrDigit<span class="op">))</span></span>
<span id="cb964-15"><a href="#cb964-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb964-16"><a href="#cb964-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">contains</span><span class="op">(</span><span class="dt">char</span><span class="op">:</span> <span class="bu">Char</span><span class="op">):</span> <span class="ex">Predicate</span><span class="op">[</span>Errors<span class="op">,</span> <span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb964-17"><a href="#cb964-17" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Predicate</span><span class="op">.</span><span class="fu">lift</span><span class="op">(</span></span>
<span id="cb964-18"><a href="#cb964-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">error</span><span class="op">(</span><span class="ss">s&quot;</span><span class="st">Must contain the character </span><span class="ss">$char&quot;</span><span class="op">),</span></span>
<span id="cb964-19"><a href="#cb964-19" aria-hidden="true" tabindex="-1"></a>    str <span class="op">=&gt;</span> str<span class="op">.</span><span class="fu">contains</span><span class="op">(</span><span class="dt">char</span><span class="op">))</span></span>
<span id="cb964-20"><a href="#cb964-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb964-21"><a href="#cb964-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">containsOnce</span><span class="op">(</span><span class="dt">char</span><span class="op">:</span> <span class="bu">Char</span><span class="op">):</span> <span class="ex">Predicate</span><span class="op">[</span>Errors<span class="op">,</span> <span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb964-22"><a href="#cb964-22" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Predicate</span><span class="op">.</span><span class="fu">lift</span><span class="op">(</span></span>
<span id="cb964-23"><a href="#cb964-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">error</span><span class="op">(</span><span class="ss">s&quot;</span><span class="st">Must contain the character </span><span class="ss">$char</span><span class="st"> only once</span><span class="ss">&quot;</span><span class="op">),</span></span>
<span id="cb964-24"><a href="#cb964-24" aria-hidden="true" tabindex="-1"></a>    str <span class="op">=&gt;</span> str<span class="op">.</span><span class="fu">filter</span><span class="op">(</span>c <span class="op">=&gt;</span> c <span class="op">==</span> <span class="dt">char</span><span class="op">).</span>size <span class="op">==</span> <span class="dv">1</span><span class="op">)</span></span></code></pre></div>
    <div class="solution">
    <p>Here’s our reference solution. Implementing this required more
    thought than we expected. Switching between <code>Check</code> and
    <code>Predicate</code> at appropriate places felt a bit like
    guesswork till we got the rule into our heads that
    <code>Predicate</code> doesn’t transform its input. With this rule
    in mind things went fairly smoothly. In later sections we’ll make
    some changes that make the library easier to use.</p>
    <div class="sourceCode" id="cb965"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb965-1"><a href="#cb965-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>apply<span class="op">.</span>_     <span class="co">// for mapN</span></span>
<span id="cb965-2"><a href="#cb965-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>validated<span class="op">.</span>_ <span class="co">// for valid and invalid</span></span></code></pre></div>
    <p>Here’s the implementation of <code>checkUsername</code>:</p>
    <div class="sourceCode" id="cb966"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb966-1"><a href="#cb966-1" aria-hidden="true" tabindex="-1"></a><span class="co">// A username must contain at least four characters</span></span>
<span id="cb966-2"><a href="#cb966-2" aria-hidden="true" tabindex="-1"></a><span class="co">// and consist entirely of alphanumeric characters</span></span>
<span id="cb966-3"><a href="#cb966-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb966-4"><a href="#cb966-4" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> checkUsername<span class="op">:</span> Check<span class="op">[</span>Errors<span class="op">,</span> <span class="ex">String</span><span class="op">,</span> <span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb966-5"><a href="#cb966-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Check</span><span class="op">(</span><span class="fu">longerThan</span><span class="op">(</span><span class="dv">3</span><span class="op">)</span> and alphanumeric<span class="op">)</span></span></code></pre></div>
    <p>And here’s the implementation of <code>checkEmail</code>, built
    up from a number of smaller components:</p>
    <div class="sourceCode" id="cb967"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb967-1"><a href="#cb967-1" aria-hidden="true" tabindex="-1"></a><span class="co">// An email address must contain a single `@` sign.</span></span>
<span id="cb967-2"><a href="#cb967-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Split the string at the `@`.</span></span>
<span id="cb967-3"><a href="#cb967-3" aria-hidden="true" tabindex="-1"></a><span class="co">// The string to the left must not be empty.</span></span>
<span id="cb967-4"><a href="#cb967-4" aria-hidden="true" tabindex="-1"></a><span class="co">// The string to the right must be</span></span>
<span id="cb967-5"><a href="#cb967-5" aria-hidden="true" tabindex="-1"></a><span class="co">// at least three characters long and contain a dot.</span></span>
<span id="cb967-6"><a href="#cb967-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb967-7"><a href="#cb967-7" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> splitEmail<span class="op">:</span> Check<span class="op">[</span>Errors<span class="op">,</span> <span class="ex">String</span><span class="op">,</span> <span class="op">(</span><span class="ex">String</span><span class="op">,</span> <span class="ex">String</span><span class="op">)]</span> <span class="op">=</span></span>
<span id="cb967-8"><a href="#cb967-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Check</span><span class="op">(</span>_<span class="op">.</span><span class="fu">split</span><span class="op">(</span><span class="ch">&#39;@&#39;</span><span class="op">)</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb967-9"><a href="#cb967-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="ex">Array</span><span class="op">(</span>name<span class="op">,</span> domain<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb967-10"><a href="#cb967-10" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>name<span class="op">,</span> domain<span class="op">).</span>validNel<span class="op">[</span><span class="ex">String</span><span class="op">]</span></span>
<span id="cb967-11"><a href="#cb967-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb967-12"><a href="#cb967-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> _ <span class="op">=&gt;</span></span>
<span id="cb967-13"><a href="#cb967-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;Must contain a single @ character&quot;</span><span class="op">.</span></span>
<span id="cb967-14"><a href="#cb967-14" aria-hidden="true" tabindex="-1"></a>        invalidNel<span class="op">[(</span><span class="ex">String</span><span class="op">,</span> <span class="ex">String</span><span class="op">)]</span></span>
<span id="cb967-15"><a href="#cb967-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">})</span></span>
<span id="cb967-16"><a href="#cb967-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb967-17"><a href="#cb967-17" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> checkLeft<span class="op">:</span> Check<span class="op">[</span>Errors<span class="op">,</span> <span class="ex">String</span><span class="op">,</span> <span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb967-18"><a href="#cb967-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Check</span><span class="op">(</span><span class="fu">longerThan</span><span class="op">(</span><span class="dv">0</span><span class="op">))</span></span>
<span id="cb967-19"><a href="#cb967-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb967-20"><a href="#cb967-20" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> checkRight<span class="op">:</span> Check<span class="op">[</span>Errors<span class="op">,</span> <span class="ex">String</span><span class="op">,</span> <span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb967-21"><a href="#cb967-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Check</span><span class="op">(</span><span class="fu">longerThan</span><span class="op">(</span><span class="dv">3</span><span class="op">)</span> and <span class="fu">contains</span><span class="op">(</span><span class="ch">&#39;.&#39;</span><span class="op">))</span></span>
<span id="cb967-22"><a href="#cb967-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb967-23"><a href="#cb967-23" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> joinEmail<span class="op">:</span> Check<span class="op">[</span>Errors<span class="op">,</span> <span class="op">(</span><span class="ex">String</span><span class="op">,</span> <span class="ex">String</span><span class="op">),</span> <span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb967-24"><a href="#cb967-24" aria-hidden="true" tabindex="-1"></a>  Check <span class="op">{</span> <span class="cf">case</span> <span class="op">(</span>l<span class="op">,</span> r<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb967-25"><a href="#cb967-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span><span class="fu">checkLeft</span><span class="op">(</span>l<span class="op">),</span> <span class="fu">checkRight</span><span class="op">(</span>r<span class="op">)).</span><span class="fu">mapN</span><span class="op">(</span>_ <span class="op">+</span> <span class="st">&quot;@&quot;</span> <span class="op">+</span> _<span class="op">)</span></span>
<span id="cb967-26"><a href="#cb967-26" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb967-27"><a href="#cb967-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb967-28"><a href="#cb967-28" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> checkEmail<span class="op">:</span> Check<span class="op">[</span>Errors<span class="op">,</span> <span class="ex">String</span><span class="op">,</span> <span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb967-29"><a href="#cb967-29" aria-hidden="true" tabindex="-1"></a>  splitEmail andThen joinEmail</span></code></pre></div>
    <p>Finally, here’s a check for a <code>User</code> that depends on
    <code>checkUsername</code> and <code>checkEmail</code>:</p>
    <div class="sourceCode" id="cb968"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb968-1"><a href="#cb968-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">User</span><span class="op">(</span>username<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> email<span class="op">:</span> <span class="ex">String</span><span class="op">)</span></span>
<span id="cb968-2"><a href="#cb968-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb968-3"><a href="#cb968-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">createUser</span><span class="op">(</span></span>
<span id="cb968-4"><a href="#cb968-4" aria-hidden="true" tabindex="-1"></a>      username<span class="op">:</span> <span class="ex">String</span><span class="op">,</span></span>
<span id="cb968-5"><a href="#cb968-5" aria-hidden="true" tabindex="-1"></a>      email<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> Validated<span class="op">[</span>Errors<span class="op">,</span> User<span class="op">]</span> <span class="op">=</span></span>
<span id="cb968-6"><a href="#cb968-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">(</span><span class="fu">checkUsername</span><span class="op">(</span>username<span class="op">),</span> <span class="fu">checkEmail</span><span class="op">(</span>email<span class="op">)).</span><span class="fu">mapN</span><span class="op">(</span>User<span class="op">.</span>apply<span class="op">)</span></span></code></pre></div>
    <p>We can check our work by creating a couple of example users:</p>
    <div class="sourceCode" id="cb969"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb969-1"><a href="#cb969-1" aria-hidden="true" tabindex="-1"></a><span class="fu">createUser</span><span class="op">(</span><span class="st">&quot;Noel&quot;</span><span class="op">,</span> <span class="st">&quot;noel@underscore.io&quot;</span><span class="op">)</span></span>
<span id="cb969-2"><a href="#cb969-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res5: Validated[Errors, User] = Valid(</span></span>
<span id="cb969-3"><a href="#cb969-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   a = User(username = &quot;Noel&quot;, email = &quot;noel@underscore.io&quot;)</span></span>
<span id="cb969-4"><a href="#cb969-4" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span>
<span id="cb969-5"><a href="#cb969-5" aria-hidden="true" tabindex="-1"></a><span class="fu">createUser</span><span class="op">(</span><span class="st">&quot;&quot;</span><span class="op">,</span> <span class="st">&quot;dave@underscore.io@io&quot;</span><span class="op">)</span></span>
<span id="cb969-6"><a href="#cb969-6" aria-hidden="true" tabindex="-1"></a><span class="co">// res6: Validated[Errors, User] = Invalid(</span></span>
<span id="cb969-7"><a href="#cb969-7" aria-hidden="true" tabindex="-1"></a><span class="co">//   e = NonEmptyList(</span></span>
<span id="cb969-8"><a href="#cb969-8" aria-hidden="true" tabindex="-1"></a><span class="co">//     head = &quot;Must be longer than 3 characters&quot;,</span></span>
<span id="cb969-9"><a href="#cb969-9" aria-hidden="true" tabindex="-1"></a><span class="co">//     tail = List(&quot;Must contain a single @ character&quot;)</span></span>
<span id="cb969-10"><a href="#cb969-10" aria-hidden="true" tabindex="-1"></a><span class="co">//   )</span></span>
<span id="cb969-11"><a href="#cb969-11" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    <p>One distinct disadvantage of our example is that it doesn’t tell
    us <em>where</em> the errors came from. We can either achieve that
    through judicious manipulation of error messages, or we can modify
    our library to track error locations as well as messages. Tracking
    error locations is outside the scope of this case study, so we’ll
    leave this as an exercise to the reader.</p>
    </div>
    <h2 data-number="18.5" id="kleislis"><span class="header-section-number">18.5</span> Kleislis</h2>
    <p>We’ll finish off this case study by cleaning up the
    implementation of <code>Check</code>. A justifiable criticism of our
    approach is that we’ve written a lot of code to do very little. A
    <code>Predicate</code> is essentially a function
    <code>A =&gt; Validated[E, A]</code>, and a <code>Check</code> is
    basically a wrapper that lets us compose these functions.</p>
    <p>We can abstract <code>A =&gt; Validated[E, A]</code> to
    <code>A =&gt; F[B]</code>, which you’ll recognise as the type of
    function you pass to the <code>flatMap</code> method on a monad.
    Imagine we have the following sequence of operations:</p>
    <ul>
    <li><p>We lift some value into a monad (by using <code>pure</code>,
    for example). This is a function with type
    <code>A =&gt; F[A]</code>.</p></li>
    <li><p>We then sequence some transformations on the monad using
    <code>flatMap</code>.</p></li>
    </ul>
    <p>We can illustrate this as shown in Figure 26. We can also write
    out this example using the monad API as follows:</p>
    <div class="sourceCode" id="cb970"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb970-1"><a href="#cb970-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> aToB<span class="op">:</span> A <span class="op">=&gt;</span> F<span class="op">[</span>B<span class="op">]</span> <span class="op">=</span> <span class="op">???</span></span>
<span id="cb970-2"><a href="#cb970-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> bToC<span class="op">:</span> B <span class="op">=&gt;</span> F<span class="op">[</span>C<span class="op">]</span> <span class="op">=</span> <span class="op">???</span></span>
<span id="cb970-3"><a href="#cb970-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb970-4"><a href="#cb970-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> example<span class="op">[</span>A<span class="op">,</span> C<span class="op">](</span>a<span class="op">:</span> A<span class="op">):</span> F<span class="op">[</span>C<span class="op">]</span> <span class="op">=</span></span>
<span id="cb970-5"><a href="#cb970-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aToB</span><span class="op">(</span>a<span class="op">).</span><span class="fu">flatMap</span><span class="op">(</span>bToC<span class="op">)</span></span></code></pre></div>
    <figure id="fig:validation:kleisli">
    <svg id="svg_26488e6e2a06dbacad84" alt="Sequencing monadic transforms" width="1476px" height="220px" viewBox="0 0 1476 220">
    <!-- Generator: Sketch 43.2 (39069) - http://www.bohemiancoding.com/sketch -->
    <title>kleisli</title>
    <desc>Created with Sketch.</desc>
    <defs>
        <ellipse id="svg_26488e6e2a06dbacad84_path-1" cx="53.168329" cy="67.8934614" rx="53.168329" ry="52.8934614"></ellipse>
        <ellipse id="svg_26488e6e2a06dbacad84_path-2" cx="279.168329" cy="67.8934614" rx="53.168329" ry="52.8934614"></ellipse>
        <ellipse id="svg_26488e6e2a06dbacad84_path-3" cx="627.168329" cy="65.8934614" rx="53.168329" ry="52.8934614"></ellipse>
        <polygon id="svg_26488e6e2a06dbacad84_path-4" points="853.392433 99.802647 819.158027 117.684976 825.696217 79.8095957 798 52.9861026 836.27523 47.4601592 853.392433 13 870.509637 47.4601592 908.784867 52.9861026 881.08865 79.8095957 887.62684 117.684976"></polygon>
        <polygon id="svg_26488e6e2a06dbacad84_path-5" points="1201.39243 99.802647 1167.15803 117.684976 1173.69622 79.8095957 1146 52.9861026 1184.27523 47.4601592 1201.39243 13 1218.50964 47.4601592 1256.78487 52.9861026 1229.08865 79.8095957 1235.62684 117.684976"></polygon>
    </defs>
    <g id="svg_26488e6e2a06dbacad84_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_26488e6e2a06dbacad84_kleisli" transform="translate(-223.000000, -38.000000)">
            <rect id="svg_26488e6e2a06dbacad84_Background" x="0" y="0" width="1921" height="300" />
            <g id="svg_26488e6e2a06dbacad84_Group-15" transform="translate(223.000000, 38.000000)">
                <g id="svg_26488e6e2a06dbacad84_Oval-1">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_26488e6e2a06dbacad84_path-1" />
                    <ellipse stroke="#000000" stroke-width="4" cx="53.168329" cy="67.8934614" rx="51.168329" ry="50.8934614"></ellipse>
                </g>
                <g id="svg_26488e6e2a06dbacad84_Oval-1">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_26488e6e2a06dbacad84_path-2" />
                    <ellipse stroke="#000000" stroke-width="4" cx="279.168329" cy="67.8934614" rx="51.168329" ry="50.8934614"></ellipse>
                </g>
                <rect id="svg_26488e6e2a06dbacad84_Rectangle-1" stroke="#000000" stroke-width="4" x="214" y="4" width="128.920823" height="128.233654" rx="8" />
                <polygon id="svg_26488e6e2a06dbacad84_Path-1" fill="#000000" points="133 56.2233654 159.584165 56.2233654 159.584165 43 186.168329 69.1146703 159.584165 95.8934614 159.584165 82.6700961 133 82.6700961"></polygon>
                <text id="svg_26488e6e2a06dbacad84_A-=&gt;-F[A]" font-family="FiraMono-Regular, Fira Mono" font-size="42" font-weight="normal" fill="#000000">
                    <tspan x="59.4670213" y="215">A =&gt; F[A]</tspan>
                </text>
                <text id="svg_26488e6e2a06dbacad84_flatMap" font-family="FiraMono-Bold, Fira Mono" font-size="45" font-weight="bold" fill="#F6A623">
                    <tspan x="365.781673" y="82">flatMap</tspan>
                </text>
                <text id="svg_26488e6e2a06dbacad84_flatMap" font-family="FiraMono-Bold, Fira Mono" font-size="45" font-weight="bold" fill="#F6A623">
                    <tspan x="940.781673" y="82">flatMap</tspan>
                </text>
                <text id="svg_26488e6e2a06dbacad84_A-=&gt;-F[B]" font-family="FiraMono-Regular, Fira Mono" font-size="40" font-weight="normal" fill="#000000">
                    <tspan x="638.137814" y="213">A =&gt; F[B]</tspan>
                </text>
                <g id="svg_26488e6e2a06dbacad84_Oval-1">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_26488e6e2a06dbacad84_path-3" />
                    <ellipse stroke="#000000" stroke-width="4" cx="627.168329" cy="65.8934614" rx="51.168329" ry="50.8934614"></ellipse>
                </g>
                <rect id="svg_26488e6e2a06dbacad84_Rectangle-1" stroke="#000000" stroke-width="4" x="788" y="2" width="128.920823" height="128.233654" rx="8" />
                <rect id="svg_26488e6e2a06dbacad84_Rectangle-1" stroke="#000000" stroke-width="4" x="1345" y="2" width="128.920823" height="128.233654" rx="8" />
                <polygon id="svg_26488e6e2a06dbacad84_Path-1" fill="#000000" points="707 54.2233654 733.584165 54.2233654 733.584165 41 760.168329 67.1146703 733.584165 93.8934614 733.584165 80.6700961 707 80.6700961"></polygon>
                <g id="svg_26488e6e2a06dbacad84_Star-1">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_26488e6e2a06dbacad84_path-4" />
                    <path stroke="#000000" stroke-width="4" d="M821.816865,114.039721 L827.667068,80.1498114 L827.846865,79.1082548 L827.087614,78.3729282 L802.317653,54.3834827 L836.561015,49.4396356 L837.599603,49.2896906 L838.066425,48.3498895 L853.392433,17.495744 L868.718441,48.3498895 L869.185264,49.2896906 L870.223852,49.4396356 L904.467214,54.3834827 L879.697253,78.3729282 L878.938002,79.1082548 L879.117799,80.1498114 L884.968002,114.039721 L854.318416,98.0299214 L853.392433,97.5462347 L852.466451,98.0299214 L821.816865,114.039721 Z" />
                </g>
                <text id="svg_26488e6e2a06dbacad84_B-=&gt;-F[C]" font-family="FiraMono-Regular, Fira Mono" font-size="40" font-weight="normal" fill="#000000">
                    <tspan x="1193.40062" y="213">B =&gt; F[C]</tspan>
                </text>
                <g id="svg_26488e6e2a06dbacad84_Star-1">
                    <use fill="#FFFFFF" fill-rule="evenodd" xlink:href="#svg_26488e6e2a06dbacad84_path-5" />
                    <path stroke="#000000" stroke-width="4" d="M1169.81686,114.039721 L1175.66707,80.1498114 L1175.84686,79.1082548 L1175.08761,78.3729282 L1150.31765,54.3834827 L1184.56101,49.4396356 L1185.5996,49.2896906 L1186.06643,48.3498895 L1201.39243,17.495744 L1216.71844,48.3498895 L1217.18526,49.2896906 L1218.22385,49.4396356 L1252.46721,54.3834827 L1227.69725,78.3729282 L1226.938,79.1082548 L1227.1178,80.1498114 L1232.968,114.039721 L1202.31842,98.0299214 L1201.39243,97.5462347 L1200.46645,98.0299214 L1169.81686,114.039721 Z" />
                </g>
                <polygon id="svg_26488e6e2a06dbacad84_Path-1" fill="#000000" points="1283 54.2233654 1309.58416 54.2233654 1309.58416 41 1336.16833 67.1146703 1309.58416 93.8934614 1309.58416 80.6700961 1283 80.6700961"></polygon>
                <polygon id="svg_26488e6e2a06dbacad84_Polygon" stroke="#000000" stroke-width="4" fill="#FFFFFF" points="1409.0826 21 1455.16519 54.2656167 1437.56321 108.090515 1380.60199 108.090515 1363 54.2656167"></polygon>
            </g>
        </g>
    </g>
</svg>
    <figcaption>Figure 26: Sequencing monadic transforms</figcaption>
    </figure>
    <p>Recall that <code>Check</code> is, in the abstract, allowing us
    to compose functions of type <code>A =&gt; F[B]</code>. We can write
    the above in terms of <code>andThen</code> as:</p>
    <div class="sourceCode" id="cb971"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb971-1"><a href="#cb971-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> aToC <span class="op">=</span> aToB andThen bToC</span></code></pre></div>
    <p>The result is a (wrapped) function <code>aToC</code> of type
    <code>A =&gt; F[C]</code> that we can subsequently apply to a value
    of type <code>A</code>.</p>
    <p>We have achieved the same thing as the <code>example</code>
    method without having to reference an argument of type
    <code>A</code>. The <code>andThen</code> method on
    <code>Check</code> is analogous to function composition, but is
    composing function <code>A =&gt; F[B]</code> instead of
    <code>A =&gt; B</code>.</p>
    <p>The abstract concept of composing functions of type
    <code>A =&gt; F[B]</code> has a name: a <em>Kleisli</em>.</p>
    <p>Cats contains a data type <a href="http://typelevel.org/cats/api/cats/data/Kleisli.html"><code>cats.data.Kleisli</code></a>
    that wraps a function just as <code>Check</code> does.
    <code>Kleisli</code> has all the methods of <code>Check</code> plus
    some additional ones. If <code>Kleisli</code> seems familiar to you,
    then congratulations. You’ve seen through its disguise and
    recognised it as another concept from earlier in the book:
    <code>Kleisli</code> is just another name for
    <code>ReaderT</code>.</p>
    <p>Here is a simple example using <code>Kleisli</code> to transform
    an integer into a list of integers through three steps:</p>
    <div class="sourceCode" id="cb972"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb972-1"><a href="#cb972-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>data<span class="op">.</span>Kleisli</span>
<span id="cb972-2"><a href="#cb972-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>list<span class="op">.</span>_ <span class="co">// for Monad</span></span></code></pre></div>
    <p>These steps each transform an input <code>Int</code> into an
    output of type <code>List[Int]</code>:</p>
    <div class="sourceCode" id="cb973"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb973-1"><a href="#cb973-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> step1<span class="op">:</span> Kleisli<span class="op">[</span><span class="ex">List</span><span class="op">,</span> <span class="bu">Int</span><span class="op">,</span> <span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb973-2"><a href="#cb973-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Kleisli</span><span class="op">(</span>x <span class="op">=&gt;</span> <span class="ex">List</span><span class="op">(</span>x <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> x <span class="op">-</span> <span class="dv">1</span><span class="op">))</span></span>
<span id="cb973-3"><a href="#cb973-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb973-4"><a href="#cb973-4" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> step2<span class="op">:</span> Kleisli<span class="op">[</span><span class="ex">List</span><span class="op">,</span> <span class="bu">Int</span><span class="op">,</span> <span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb973-5"><a href="#cb973-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Kleisli</span><span class="op">(</span>x <span class="op">=&gt;</span> <span class="ex">List</span><span class="op">(</span>x<span class="op">,</span> <span class="op">-</span>x<span class="op">))</span></span>
<span id="cb973-6"><a href="#cb973-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb973-7"><a href="#cb973-7" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> step3<span class="op">:</span> Kleisli<span class="op">[</span><span class="ex">List</span><span class="op">,</span> <span class="bu">Int</span><span class="op">,</span> <span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb973-8"><a href="#cb973-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Kleisli</span><span class="op">(</span>x <span class="op">=&gt;</span> <span class="ex">List</span><span class="op">(</span>x <span class="op">*</span> <span class="dv">2</span><span class="op">,</span> x <span class="op">/</span> <span class="dv">2</span><span class="op">))</span></span></code></pre></div>
    <p>We can combine the steps into a single pipeline that combines the
    underlying <code>Lists</code> using <code>flatMap</code>:</p>
    <div class="sourceCode" id="cb974"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb974-1"><a href="#cb974-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> pipeline <span class="op">=</span> step1 andThen step2 andThen step3</span></code></pre></div>
    <p>The result is a function that consumes a single <code>Int</code>
    and returns eight outputs, each produced by a different combination
    of transformations from <code>step1</code>, <code>step2</code>, and
    <code>step3</code>:</p>
    <div class="sourceCode" id="cb975"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb975-1"><a href="#cb975-1" aria-hidden="true" tabindex="-1"></a>pipeline<span class="op">.</span><span class="fu">run</span><span class="op">(</span><span class="dv">20</span><span class="op">)</span></span>
<span id="cb975-2"><a href="#cb975-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res0: List[Int] = List(42, 10, -42, -10, 38, 9, -38, -9)</span></span></code></pre></div>
    <p>The only notable difference between <code>Kleisli</code> and
    <code>Check</code> in terms of API is that <code>Kleisli</code>
    renames our <code>apply</code> method to <code>run</code>.</p>
    <p>Let’s replace <code>Check</code> with <code>Kleisli</code> in our
    validation examples. To do so we need to make a few changes to
    <code>Predicate</code>. We must be able to convert a
    <code>Predicate</code> to a function, as <code>Kleisli</code> only
    works with functions. Somewhat more subtly, when we convert a
    <code>Predicate</code> to a function, it should have type
    <code>A =&gt; Either[E, A]</code> rather than
    <code>A =&gt; Validated[E, A]</code> because <code>Kleisli</code>
    relies on the wrapped function returning a monad.</p>
    <p>Add a method to <code>Predicate</code> called <code>run</code>
    that returns a function of the correct type. Leave the rest of the
    code in <code>Predicate</code> the same.</p>
    <div class="solution">
    <p>Here’s an abbreviated definition of <code>run</code>. Like
    <code>apply</code>, the method must accept an implicit
    <code>Semigroup</code>:</p>
    <div class="sourceCode" id="cb976"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb976-1"><a href="#cb976-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>Semigroup</span>
<span id="cb976-2"><a href="#cb976-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>data<span class="op">.</span>Validated</span>
<span id="cb976-3"><a href="#cb976-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb976-4"><a href="#cb976-4" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> <span class="ex">Predicate</span><span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb976-5"><a href="#cb976-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">run</span><span class="op">(</span><span class="kw">implicit</span> s<span class="op">:</span> Semigroup<span class="op">[</span>E<span class="op">]):</span> A <span class="op">=&gt;</span> Either<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb976-6"><a href="#cb976-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span>a<span class="op">:</span> A<span class="op">)</span> <span class="op">=&gt;</span> <span class="kw">this</span><span class="op">(</span>a<span class="op">).</span>toEither</span>
<span id="cb976-7"><a href="#cb976-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb976-8"><a href="#cb976-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>a<span class="op">:</span> A<span class="op">):</span> Validated<span class="op">[</span>E<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb976-9"><a href="#cb976-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span> <span class="co">// etc...</span></span>
<span id="cb976-10"><a href="#cb976-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb976-11"><a href="#cb976-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// other methods...</span></span>
<span id="cb976-12"><a href="#cb976-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    </div>
    <p>Now rewrite our username and email validation example in terms of
    <code>Kleisli</code> and <code>Predicate</code>. Here are few tips
    in case you get stuck:</p>
    <p>First, remember that the <code>run</code> method on
    <code>Predicate</code> takes an implicit parameter. If you call
    <code>aPredicate.run(a)</code> it will try to pass the implicit
    parameter explicitly. If you want to create a function from a
    <code>Predicate</code> and immediately apply that function, use
    <code>aPredicate.run.apply(a)</code></p>
    <p>Second, type inference can be tricky in this exercise. We found
    that the following definitions helped us to write code with fewer
    type declarations.</p>
    <div class="sourceCode" id="cb977"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb977-1"><a href="#cb977-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="ex">Result</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> Either<span class="op">[</span>Errors<span class="op">,</span> A<span class="op">]</span></span>
<span id="cb977-2"><a href="#cb977-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb977-3"><a href="#cb977-3" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Check<span class="op">[</span>A<span class="op">,</span> B<span class="op">]</span> <span class="op">=</span> Kleisli<span class="op">[</span><span class="ex">Result</span><span class="op">,</span> A<span class="op">,</span> B<span class="op">]</span></span>
<span id="cb977-4"><a href="#cb977-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb977-5"><a href="#cb977-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Create a check from a function:</span></span>
<span id="cb977-6"><a href="#cb977-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>func<span class="op">:</span> A <span class="op">=&gt;</span> <span class="ex">Result</span><span class="op">[</span>B<span class="op">]):</span> Check<span class="op">[</span>A<span class="op">,</span> B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb977-7"><a href="#cb977-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Kleisli</span><span class="op">(</span>func<span class="op">)</span></span>
<span id="cb977-8"><a href="#cb977-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb977-9"><a href="#cb977-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Create a check from a Predicate:</span></span>
<span id="cb977-10"><a href="#cb977-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> checkPred<span class="op">[</span>A<span class="op">](</span>pred<span class="op">:</span> <span class="ex">Predicate</span><span class="op">[</span>Errors<span class="op">,</span> A<span class="op">]):</span> Check<span class="op">[</span>A<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb977-11"><a href="#cb977-11" aria-hidden="true" tabindex="-1"></a>  Kleisli<span class="op">[</span><span class="ex">Result</span><span class="op">,</span> A<span class="op">,</span> A<span class="op">](</span>pred<span class="op">.</span>run<span class="op">)</span></span></code></pre></div>
    <div class="solution">
    <p>Working around limitations of type inference can be quite
    frustrating when writing this code, Working out when to convert
    between <code>Predicates</code>, functions, and
    <code>Validated</code>, and <code>Either</code> simplifies things,
    but the process is still complex:</p>
    <div class="sourceCode" id="cb978"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb978-1"><a href="#cb978-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>data<span class="op">.{</span>Kleisli<span class="op">,</span> NonEmptyList<span class="op">}</span></span>
<span id="cb978-2"><a href="#cb978-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>either<span class="op">.</span>_   <span class="co">// for Semigroupal</span></span></code></pre></div>
    <p>Here is the preamble we suggested in the main text of the case
    study:</p>
    <div class="sourceCode" id="cb979"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb979-1"><a href="#cb979-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Errors <span class="op">=</span> NonEmptyList<span class="op">[</span><span class="ex">String</span><span class="op">]</span></span>
<span id="cb979-2"><a href="#cb979-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb979-3"><a href="#cb979-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">error</span><span class="op">(</span>s<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> NonEmptyList<span class="op">[</span><span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb979-4"><a href="#cb979-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">NonEmptyList</span><span class="op">(</span>s<span class="op">,</span> Nil<span class="op">)</span></span>
<span id="cb979-5"><a href="#cb979-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb979-6"><a href="#cb979-6" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="ex">Result</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> Either<span class="op">[</span>Errors<span class="op">,</span> A<span class="op">]</span></span>
<span id="cb979-7"><a href="#cb979-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb979-8"><a href="#cb979-8" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Check<span class="op">[</span>A<span class="op">,</span> B<span class="op">]</span> <span class="op">=</span> Kleisli<span class="op">[</span><span class="ex">Result</span><span class="op">,</span> A<span class="op">,</span> B<span class="op">]</span></span>
<span id="cb979-9"><a href="#cb979-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb979-10"><a href="#cb979-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check<span class="op">[</span>A<span class="op">,</span> B<span class="op">](</span>func<span class="op">:</span> A <span class="op">=&gt;</span> <span class="ex">Result</span><span class="op">[</span>B<span class="op">]):</span> Check<span class="op">[</span>A<span class="op">,</span> B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb979-11"><a href="#cb979-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Kleisli</span><span class="op">(</span>func<span class="op">)</span></span>
<span id="cb979-12"><a href="#cb979-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb979-13"><a href="#cb979-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> checkPred<span class="op">[</span>A<span class="op">](</span>pred<span class="op">:</span> <span class="ex">Predicate</span><span class="op">[</span>Errors<span class="op">,</span> A<span class="op">]):</span> Check<span class="op">[</span>A<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb979-14"><a href="#cb979-14" aria-hidden="true" tabindex="-1"></a>  Kleisli<span class="op">[</span><span class="ex">Result</span><span class="op">,</span> A<span class="op">,</span> A<span class="op">](</span>pred<span class="op">.</span>run<span class="op">)</span></span></code></pre></div>
    <p>Our base predicate definitions are essenitally unchanged:</p>
    <div class="sourceCode" id="cb980"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb980-1"><a href="#cb980-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">longerThan</span><span class="op">(</span>n<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="ex">Predicate</span><span class="op">[</span>Errors<span class="op">,</span> <span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb980-2"><a href="#cb980-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Predicate</span><span class="op">.</span><span class="fu">lift</span><span class="op">(</span></span>
<span id="cb980-3"><a href="#cb980-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">error</span><span class="op">(</span><span class="ss">s&quot;</span><span class="st">Must be longer than </span><span class="ss">$n</span><span class="st"> characters</span><span class="ss">&quot;</span><span class="op">),</span></span>
<span id="cb980-4"><a href="#cb980-4" aria-hidden="true" tabindex="-1"></a>    str <span class="op">=&gt;</span> str<span class="op">.</span>size <span class="op">&gt;</span> n<span class="op">)</span></span>
<span id="cb980-5"><a href="#cb980-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb980-6"><a href="#cb980-6" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> alphanumeric<span class="op">:</span> <span class="ex">Predicate</span><span class="op">[</span>Errors<span class="op">,</span> <span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb980-7"><a href="#cb980-7" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Predicate</span><span class="op">.</span><span class="fu">lift</span><span class="op">(</span></span>
<span id="cb980-8"><a href="#cb980-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">error</span><span class="op">(</span><span class="ss">s&quot;</span><span class="st">Must be all alphanumeric characters</span><span class="ss">&quot;</span><span class="op">),</span></span>
<span id="cb980-9"><a href="#cb980-9" aria-hidden="true" tabindex="-1"></a>    str <span class="op">=&gt;</span> str<span class="op">.</span><span class="fu">forall</span><span class="op">(</span>_<span class="op">.</span>isLetterOrDigit<span class="op">))</span></span>
<span id="cb980-10"><a href="#cb980-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb980-11"><a href="#cb980-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">contains</span><span class="op">(</span><span class="dt">char</span><span class="op">:</span> <span class="bu">Char</span><span class="op">):</span> <span class="ex">Predicate</span><span class="op">[</span>Errors<span class="op">,</span> <span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb980-12"><a href="#cb980-12" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Predicate</span><span class="op">.</span><span class="fu">lift</span><span class="op">(</span></span>
<span id="cb980-13"><a href="#cb980-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">error</span><span class="op">(</span><span class="ss">s&quot;</span><span class="st">Must contain the character </span><span class="ss">$char&quot;</span><span class="op">),</span></span>
<span id="cb980-14"><a href="#cb980-14" aria-hidden="true" tabindex="-1"></a>    str <span class="op">=&gt;</span> str<span class="op">.</span><span class="fu">contains</span><span class="op">(</span><span class="dt">char</span><span class="op">))</span></span>
<span id="cb980-15"><a href="#cb980-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb980-16"><a href="#cb980-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">containsOnce</span><span class="op">(</span><span class="dt">char</span><span class="op">:</span> <span class="bu">Char</span><span class="op">):</span> <span class="ex">Predicate</span><span class="op">[</span>Errors<span class="op">,</span> <span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb980-17"><a href="#cb980-17" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Predicate</span><span class="op">.</span><span class="fu">lift</span><span class="op">(</span></span>
<span id="cb980-18"><a href="#cb980-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">error</span><span class="op">(</span><span class="ss">s&quot;</span><span class="st">Must contain the character </span><span class="ss">$char</span><span class="st"> only once</span><span class="ss">&quot;</span><span class="op">),</span></span>
<span id="cb980-19"><a href="#cb980-19" aria-hidden="true" tabindex="-1"></a>    str <span class="op">=&gt;</span> str<span class="op">.</span><span class="fu">filter</span><span class="op">(</span>c <span class="op">=&gt;</span> c <span class="op">==</span> <span class="dt">char</span><span class="op">).</span>size <span class="op">==</span> <span class="dv">1</span><span class="op">)</span></span></code></pre></div>
    <p>Our username and email examples are slightly different in that we
    make use of <code>check()</code> and <code>checkPred()</code> in
    different situations:</p>
    <div class="sourceCode" id="cb981"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb981-1"><a href="#cb981-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> checkUsername<span class="op">:</span> Check<span class="op">[</span><span class="ex">String</span><span class="op">,</span> <span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb981-2"><a href="#cb981-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">checkPred</span><span class="op">(</span><span class="fu">longerThan</span><span class="op">(</span><span class="dv">3</span><span class="op">)</span> and alphanumeric<span class="op">)</span></span>
<span id="cb981-3"><a href="#cb981-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb981-4"><a href="#cb981-4" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> splitEmail<span class="op">:</span> Check<span class="op">[</span><span class="ex">String</span><span class="op">,</span> <span class="op">(</span><span class="ex">String</span><span class="op">,</span> <span class="ex">String</span><span class="op">)]</span> <span class="op">=</span></span>
<span id="cb981-5"><a href="#cb981-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">check</span><span class="op">(</span>_<span class="op">.</span><span class="fu">split</span><span class="op">(</span><span class="ch">&#39;@&#39;</span><span class="op">)</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb981-6"><a href="#cb981-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="ex">Array</span><span class="op">(</span>name<span class="op">,</span> domain<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb981-7"><a href="#cb981-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">Right</span><span class="op">((</span>name<span class="op">,</span> domain<span class="op">))</span></span>
<span id="cb981-8"><a href="#cb981-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb981-9"><a href="#cb981-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> _ <span class="op">=&gt;</span></span>
<span id="cb981-10"><a href="#cb981-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">Left</span><span class="op">(</span><span class="fu">error</span><span class="op">(</span><span class="st">&quot;Must contain a single @ character&quot;</span><span class="op">))</span></span>
<span id="cb981-11"><a href="#cb981-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">})</span></span>
<span id="cb981-12"><a href="#cb981-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb981-13"><a href="#cb981-13" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> checkLeft<span class="op">:</span> Check<span class="op">[</span><span class="ex">String</span><span class="op">,</span> <span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb981-14"><a href="#cb981-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">checkPred</span><span class="op">(</span><span class="fu">longerThan</span><span class="op">(</span><span class="dv">0</span><span class="op">))</span></span>
<span id="cb981-15"><a href="#cb981-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb981-16"><a href="#cb981-16" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> checkRight<span class="op">:</span> Check<span class="op">[</span><span class="ex">String</span><span class="op">,</span> <span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb981-17"><a href="#cb981-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">checkPred</span><span class="op">(</span><span class="fu">longerThan</span><span class="op">(</span><span class="dv">3</span><span class="op">)</span> and <span class="fu">contains</span><span class="op">(</span><span class="ch">&#39;.&#39;</span><span class="op">))</span></span>
<span id="cb981-18"><a href="#cb981-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb981-19"><a href="#cb981-19" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> joinEmail<span class="op">:</span> Check<span class="op">[(</span><span class="ex">String</span><span class="op">,</span> <span class="ex">String</span><span class="op">),</span> <span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb981-20"><a href="#cb981-20" aria-hidden="true" tabindex="-1"></a>  check <span class="op">{</span></span>
<span id="cb981-21"><a href="#cb981-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="op">(</span>l<span class="op">,</span> r<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb981-22"><a href="#cb981-22" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span><span class="fu">checkLeft</span><span class="op">(</span>l<span class="op">),</span> <span class="fu">checkRight</span><span class="op">(</span>r<span class="op">)).</span><span class="fu">mapN</span><span class="op">(</span>_ <span class="op">+</span> <span class="st">&quot;@&quot;</span> <span class="op">+</span> _<span class="op">)</span></span>
<span id="cb981-23"><a href="#cb981-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb981-24"><a href="#cb981-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb981-25"><a href="#cb981-25" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> checkEmail<span class="op">:</span> Check<span class="op">[</span><span class="ex">String</span><span class="op">,</span> <span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb981-26"><a href="#cb981-26" aria-hidden="true" tabindex="-1"></a>  splitEmail andThen joinEmail</span></code></pre></div>
    <p>Finally, we can see that our <code>createUser</code> example
    works as expected using <code>Kleisli</code>:</p>
    <div class="sourceCode" id="cb982"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb982-1"><a href="#cb982-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">User</span><span class="op">(</span>username<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> email<span class="op">:</span> <span class="ex">String</span><span class="op">)</span></span>
<span id="cb982-2"><a href="#cb982-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb982-3"><a href="#cb982-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">createUser</span><span class="op">(</span></span>
<span id="cb982-4"><a href="#cb982-4" aria-hidden="true" tabindex="-1"></a>      username<span class="op">:</span> <span class="ex">String</span><span class="op">,</span></span>
<span id="cb982-5"><a href="#cb982-5" aria-hidden="true" tabindex="-1"></a>      email<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> Either<span class="op">[</span>Errors<span class="op">,</span> User<span class="op">]</span> <span class="op">=</span> <span class="op">(</span></span>
<span id="cb982-6"><a href="#cb982-6" aria-hidden="true" tabindex="-1"></a>  checkUsername<span class="op">.</span><span class="fu">run</span><span class="op">(</span>username<span class="op">),</span></span>
<span id="cb982-7"><a href="#cb982-7" aria-hidden="true" tabindex="-1"></a>  checkEmail<span class="op">.</span><span class="fu">run</span><span class="op">(</span>email<span class="op">)</span></span>
<span id="cb982-8"><a href="#cb982-8" aria-hidden="true" tabindex="-1"></a><span class="op">).</span><span class="fu">mapN</span><span class="op">(</span>User<span class="op">.</span>apply<span class="op">)</span></span></code></pre></div>
    <div class="sourceCode" id="cb983"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb983-1"><a href="#cb983-1" aria-hidden="true" tabindex="-1"></a><span class="fu">createUser</span><span class="op">(</span><span class="st">&quot;Noel&quot;</span><span class="op">,</span> <span class="st">&quot;noel@underscore.io&quot;</span><span class="op">)</span></span>
<span id="cb983-2"><a href="#cb983-2" aria-hidden="true" tabindex="-1"></a><span class="co">// res2: Either[Errors, User] = Right(</span></span>
<span id="cb983-3"><a href="#cb983-3" aria-hidden="true" tabindex="-1"></a><span class="co">//   value = User(username = &quot;Noel&quot;, email = &quot;noel@underscore.io&quot;)</span></span>
<span id="cb983-4"><a href="#cb983-4" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span>
<span id="cb983-5"><a href="#cb983-5" aria-hidden="true" tabindex="-1"></a><span class="fu">createUser</span><span class="op">(</span><span class="st">&quot;&quot;</span><span class="op">,</span> <span class="st">&quot;dave@underscore.io@io&quot;</span><span class="op">)</span></span>
<span id="cb983-6"><a href="#cb983-6" aria-hidden="true" tabindex="-1"></a><span class="co">// res3: Either[Errors, User] = Left(</span></span>
<span id="cb983-7"><a href="#cb983-7" aria-hidden="true" tabindex="-1"></a><span class="co">//   value = NonEmptyList(head = &quot;Must be longer than 3 characters&quot;, tail = List())</span></span>
<span id="cb983-8"><a href="#cb983-8" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span></code></pre></div>
    </div>
    <p>We have now written our code entirely in terms of
    <code>Kleisli</code> and <code>Predicate</code>, completely removing
    <code>Check</code>. This is a good first step to simplifying our
    library. There’s still plenty more to do, but we have a
    sophisticated building block from Cats to work with. We’ll leave
    further improvements up to the reader.</p>
    <h2 data-number="18.6" id="summary-8"><span class="header-section-number">18.6</span> Summary</h2>
    <p>This case study has been an exercise in removing rather than
    building abstractions. We started with a fairly complex
    <code>Check</code> type. Once we realised we were conflating two
    concepts, we separated out <code>Predicate</code> leaving us with
    something that could be implemented with <code>Kleisli</code>.</p>
    <!--
    `Predicate` is very much like a stripped down version
    of the matchers found in testing libraries like ScalaTest and Specs2.
    One next step would be to develop
    a more elaborate predicate library along these lines.
    There are a few other directions to consider.

    With the current representation of `Predicate`
    there is no way to implement logical negation.
    To implement negation we need to know the error message
    that a successful predicate would have returned if it had failed
    (so that the negation can return that message).
    One way to implement this is to have a predicate return a `Boolean` flag
    indicating success or failure and the associated message.

    We could also do better in how error messages are represented.
    At the moment there is no indication with an error message
    of the structure of the predicates that failed.
    For example, if we represent error messsages as a `List[String]`
    and we get back the message:

    ```scala
    List("Must be longer than 4 characters",
         "Must not contain a number")
    ```

    does this message indicate a failing conjunction (two `ands`)
    or a failing disjunction (two `ors`)?
    We can probably guess in this case
    but in general we don't have sufficient information to work this out.
    We can solve this problem by wrapping all messages in a type as follows:

    ```scala
    sealed trait Structure[E]

    final case class Or[E](messages: List[Structure[E]])
      extends Structure[E]

    final case class And[E](messages: List[Structure[E]])
      extends Structure[E]

    final case class Not[E](messages: List[Structure[E]])
      extends Structure[E]

    final case class Pure[E](message: E)
      extends Structure[E]
    ```

    We can simplify this structure by converting all predicates into a normal form.
    For example, if we use disjunctive normal form
    the structure of the predicate will always be
    a disjunction (logical or) of conjunctions (logical and).
    By doing so we could errors as a `List[List[Either[E, E]]]`,
    with the outer list representing disjunction,
    the inner list representing conjunction,
    and the `Either` representing negation.
    -->
    <p>We made several design choices above that reasonable developers
    may disagree with. Should the method that converts a
    <code>Predicate</code> to a function really be called
    <code>run</code> instead of, say, <code>toFunction</code>? Should
    <code>Predicate</code> be a subtype of <code>Function</code> to
    begin with? Many functional programmers prefer to avoid subtyping
    because it plays poorly with implicit resolution and type inference,
    but there could be an argument to use it here. As always the best
    decisions depend on the context in which the library will be
    used.</p>
    <h1 data-number="19" id="case-study-crdts"><span class="header-section-number">19</span> Case Study: CRDTs</h1>
    <p>In this case study we will explore <em>Commutative Replicated
    Data Types (CRDTs)</em>, a family of data structures that can be
    used to reconcile eventually consistent data.</p>
    <p>We’ll start by describing the utility and difficulty of
    eventually consistent systems, then show how we can use monoids and
    their extensions to solve the issues that arise. Finally, we will
    model the solutions in Scala.</p>
    <p>Our goal here is to focus on the implementation in Scala of a
    particular type of CRDT. We’re not aiming at a comprehensive survey
    of all CRDTs. CRDTs are a fast-moving field and we advise you to
    read the literature to learn about more.</p>
    <h2 data-number="19.1" id="eventual-consistency"><span class="header-section-number">19.1</span> Eventual Consistency</h2>
    <p>As soon as a system scales beyond a single machine we have to
    make a fundamental choice about how we manage data.</p>
    <p>One approach is to build a system that is <em>consistent</em>,
    meaning that all machines have the same view of data. For example,
    if a user changes their password then all machines that store a copy
    of that password must accept the change before we consider the
    operation to have completed successfully.</p>
    <p>Consistent systems are easy to work with but they have their
    disadvantages. They tend to have high latency because a single
    change can result in many messages being sent between machines. They
    also tend to have relatively low uptime because outages can cut
    communications between machines creating a <em>network
    partition</em>. When there is a network partition, a consistent
    system may refuse further updates to prevent inconsistencies across
    machines.</p>
    <p>An alternative approach is an <em>eventually consistent</em>
    system. This means that at any particular point in time machines are
    allowed to have differing views of data. However, if all machines
    can communicate and there are no further updates they will
    eventually all have the same view of data.</p>
    <p>Eventually consistent systems require less communication between
    machines so latency can be lower. A partitioned machine can still
    accept updates and reconcile its changes when the network is fixed,
    so systems can also have better uptime.</p>
    <p>The big question is: how do we do this reconciliation between
    machines? CRDTs provide one approach to the problem.</p>
    <h2 data-number="19.2" id="the-gcounter"><span class="header-section-number">19.2</span> The GCounter</h2>
    <p>Let’s look at one particular CRDT implementation. Then we’ll
    attempt to generalise properties to see if we can find a general
    pattern.</p>
    <p>The data structure we will look at is called a <em>GCounter</em>.
    It is a distributed <em>increment-only</em> counter that can be
    used, for example, to count the number of visitors to a web site
    where requests are served by many web servers.</p>
    <h3 data-number="19.2.1" id="simple-counters"><span class="header-section-number">19.2.1</span> Simple Counters</h3>
    <p>To see why a straightforward counter won’t work, imagine we have
    two servers storing a simple count of visitors. Let’s call the
    machines <code>A</code> and <code>B</code>. Each machine is storing
    an integer counter and the counters all start at zero as shown in
    Figure 27.</p>
    <figure id="fig:crdt:simple-counter1">
    <svg id="svg_580391d12f2faf6f45a7" alt="Simple counters: initial state" width="1761px" height="360px" viewBox="0 0 1761 360">
    <!-- Generator: Sketch 43.2 (39069) - http://www.bohemiancoding.com/sketch -->
    <title>simple-counter1</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="svg_580391d12f2faf6f45a7_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_580391d12f2faf6f45a7_simple-counter1">
            <rect id="svg_580391d12f2faf6f45a7_Background" fill="#FFFFFF" x="0" y="0" width="1761" height="360" />
            <text id="svg_580391d12f2faf6f45a7_Machine-B" font-family="Helvetica" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="981.283203" y="64">Machine B</tspan>
            </text>
            <rect id="svg_580391d12f2faf6f45a7_Rectangle-1" stroke="#000000" stroke-width="4" x="981" y="121" width="196" height="196" rx="8" />
            <text id="svg_580391d12f2faf6f45a7_Machine-A" font-family="Helvetica" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="583.431641" y="64">Machine A</tspan>
            </text>
            <text id="svg_580391d12f2faf6f45a7_0" font-family="FiraMono-Regular, Fira Mono" font-size="80" font-weight="normal" fill="#000000">
                <tspan x="656" y="246">0</tspan>
            </text>
            <text id="svg_580391d12f2faf6f45a7_0" font-family="FiraMono-Regular, Fira Mono" font-size="80" font-weight="normal" fill="#000000">
                <tspan x="1055" y="246">0</tspan>
            </text>
            <rect id="svg_580391d12f2faf6f45a7_Rectangle-1" stroke="#000000" stroke-width="4" x="582" y="121" width="196" height="196" rx="8" />
        </g>
    </g>
</svg>
    <figcaption>Figure 27: Simple counters: initial state</figcaption>
    </figure>
    <p>Now imagine we receive some web traffic. Our load balancer
    distributes five incoming requests to <code>A</code> and
    <code>B</code>, <code>A</code> serving three visitors and
    <code>B</code> two. The machines have inconsistent views of the
    system state that they need to <em>reconcile</em> to achieve
    consistency. One reconciliation strategy with simple counters is to
    exchange counts and add them as shown in Figure 28.</p>
    <figure id="fig:crdt:simple-counter3">
    <svg id="svg_a87cd531da9f0852c9e7" alt="Simple counters: first round of requests and reconciliation" width="1761px" height="660px" viewBox="0 0 1761 660">
    <!-- Generator: Sketch 43.2 (39069) - http://www.bohemiancoding.com/sketch -->
    <title>simple-counter3</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="svg_a87cd531da9f0852c9e7_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_a87cd531da9f0852c9e7_simple-counter3">
            <rect id="svg_a87cd531da9f0852c9e7_Background" fill="#FFFFFF" x="0" y="0" width="1761" height="660" />
            <rect id="svg_a87cd531da9f0852c9e7_Rectangle-1" stroke="#000000" stroke-width="4" x="981" y="422" width="196" height="196" rx="8" />
            <text id="svg_a87cd531da9f0852c9e7_5" font-family="FiraMono-Regular, Fira Mono" font-size="80" font-weight="normal" fill="#000000">
                <tspan x="656" y="548">5</tspan>
            </text>
            <text id="svg_a87cd531da9f0852c9e7_5" font-family="FiraMono-Regular, Fira Mono" font-size="80" font-weight="normal" fill="#000000">
                <tspan x="1055" y="547">5</tspan>
            </text>
            <rect id="svg_a87cd531da9f0852c9e7_Rectangle-1" stroke="#000000" stroke-width="4" x="582" y="422" width="196" height="196" rx="8" />
            <polygon id="svg_a87cd531da9f0852c9e7_Path-1-Copy-2" fill="#F6A623" transform="translate(885.401085, 374.401085) rotate(-315.000000) translate(-885.401085, -374.401085) " points="777.755655 354.691946 953.046515 354.401085 953.046515 334.401085 993.046515 373.898852 953.046515 414.401085 953.046515 394.401085 777.755655 394.691946"></polygon>
            <polygon id="svg_a87cd531da9f0852c9e7_Path-1-Copy-2" fill="#F6A623" transform="translate(878.401085, 374.401085) rotate(-225.000000) translate(-878.401085, -374.401085) " points="770.755655 354.691946 946.046515 354.401085 946.046515 334.401085 986.046515 373.898852 946.046515 414.401085 946.046515 394.401085 770.755655 394.691946"></polygon>
            <rect id="svg_a87cd531da9f0852c9e7_Rectangle-1" stroke="#000000" stroke-width="4" x="981" y="122" width="196" height="196" rx="8" />
            <text id="svg_a87cd531da9f0852c9e7_3" font-family="FiraMono-Regular, Fira Mono" font-size="80" font-weight="normal" fill="#000000">
                <tspan x="656" y="247">3</tspan>
            </text>
            <text id="svg_a87cd531da9f0852c9e7_2" font-family="FiraMono-Regular, Fira Mono" font-size="80" font-weight="normal" fill="#000000">
                <tspan x="1055" y="247">2</tspan>
            </text>
            <rect id="svg_a87cd531da9f0852c9e7_Rectangle-1" stroke="#000000" stroke-width="4" x="582" y="122" width="196" height="196" rx="8" />
            <text id="svg_a87cd531da9f0852c9e7_Machine-B" font-family="Helvetica" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="981.283203" y="70">Machine B</tspan>
            </text>
            <text id="svg_a87cd531da9f0852c9e7_Machine-A" font-family="Helvetica" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="583.431641" y="70">Machine A</tspan>
            </text>
            <text id="svg_a87cd531da9f0852c9e7_Add-counters" font-family="Helvetica" font-size="36" font-weight="normal" fill="#000000">
                <tspan x="775.433594" y="384">Add counters</tspan>
            </text>
            <polygon id="svg_a87cd531da9f0852c9e7_Path-1-Copy-2" fill="#F6A623" transform="translate(1327.645430, 220.000000) scale(-1, 1) translate(-1327.645430, -220.000000) " points="1220 200.290861 1395.29086 200 1395.29086 180 1435.29086 219.497767 1395.29086 260 1395.29086 240 1220 240.290861"></polygon>
            <text id="svg_a87cd531da9f0852c9e7_Incoming-requests" font-family="Helvetica" font-size="36" font-weight="normal" fill="#000000">
                <tspan x="1274.42383" y="181">Incoming requests</tspan>
            </text>
            <polygon id="svg_a87cd531da9f0852c9e7_Path-1-Copy-2" fill="#F6A623" points="326 200.290861 501.290861 200 501.290861 180 541.290861 219.497767 501.290861 260 501.290861 240 326 240.290861"></polygon>
            <text id="svg_a87cd531da9f0852c9e7_Incoming-requests" font-family="Helvetica" font-size="36" font-weight="normal" fill="#000000">
                <tspan x="190.423828" y="181">Incoming requests</tspan>
            </text>
        </g>
    </g>
</svg>
    <figcaption>Figure 28: Simple counters: first round of requests and
    reconciliation</figcaption>
    </figure>
    <p>So far so good, but things will start to fall apart shortly.
    Suppose <code>A</code> serves a single visitor, which means we’ve
    seen six visitors in total. The machines attempt to reconcile state
    again using addition leading to the answer shown in Figure 29.</p>
    <figure id="fig:crdt:simple-counter5">
    <svg id="svg_7ff27514e403adcfeb25" alt="Simple counters: second round of requests and (incorrect) reconciliation" width="1761px" height="660px" viewBox="0 0 1761 660">
    <!-- Generator: Sketch 43.2 (39069) - http://www.bohemiancoding.com/sketch -->
    <title>simple-counter5</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="svg_7ff27514e403adcfeb25_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_7ff27514e403adcfeb25_simple-counter5">
            <rect id="svg_7ff27514e403adcfeb25_Background" fill="#FFFFFF" x="0" y="0" width="1761" height="660" />
            <rect id="svg_7ff27514e403adcfeb25_Rectangle-1" stroke="#000000" stroke-width="4" x="981" y="422" width="196" height="196" rx="8" />
            <text id="svg_7ff27514e403adcfeb25_11" font-family="FiraMono-Regular, Fira Mono" font-size="80" font-weight="normal" fill="#000000">
                <tspan x="632" y="548">11</tspan>
            </text>
            <text id="svg_7ff27514e403adcfeb25_11" font-family="FiraMono-Regular, Fira Mono" font-size="80" font-weight="normal" fill="#000000">
                <tspan x="1031" y="547">11</tspan>
            </text>
            <rect id="svg_7ff27514e403adcfeb25_Rectangle-1" stroke="#000000" stroke-width="4" x="582" y="422" width="196" height="196" rx="8" />
            <polygon id="svg_7ff27514e403adcfeb25_Path-1-Copy-2" fill="#F6A623" transform="translate(885.401085, 374.401085) rotate(-315.000000) translate(-885.401085, -374.401085) " points="777.755655 354.691946 953.046515 354.401085 953.046515 334.401085 993.046515 373.898852 953.046515 414.401085 953.046515 394.401085 777.755655 394.691946"></polygon>
            <polygon id="svg_7ff27514e403adcfeb25_Path-1-Copy-2" fill="#F6A623" transform="translate(878.401085, 374.401085) rotate(-225.000000) translate(-878.401085, -374.401085) " points="770.755655 354.691946 946.046515 354.401085 946.046515 334.401085 986.046515 373.898852 946.046515 414.401085 946.046515 394.401085 770.755655 394.691946"></polygon>
            <rect id="svg_7ff27514e403adcfeb25_Rectangle-1" stroke="#000000" stroke-width="4" x="981" y="122" width="196" height="196" rx="8" />
            <text id="svg_7ff27514e403adcfeb25_6" font-family="FiraMono-Regular, Fira Mono" font-size="80" font-weight="normal" fill="#000000">
                <tspan x="656" y="247">6</tspan>
            </text>
            <text id="svg_7ff27514e403adcfeb25_5" font-family="FiraMono-Regular, Fira Mono" font-size="80" font-weight="normal" fill="#000000">
                <tspan x="1055" y="247">5</tspan>
            </text>
            <rect id="svg_7ff27514e403adcfeb25_Rectangle-1" stroke="#000000" stroke-width="4" x="582" y="122" width="196" height="196" rx="8" />
            <text id="svg_7ff27514e403adcfeb25_Machine-B" font-family="Helvetica" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="981.283203" y="70">Machine B</tspan>
            </text>
            <text id="svg_7ff27514e403adcfeb25_Machine-A" font-family="Helvetica" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="583.431641" y="70">Machine A</tspan>
            </text>
            <text id="svg_7ff27514e403adcfeb25_Add-counters" font-family="Helvetica" font-size="36" font-weight="normal" fill="#000000">
                <tspan x="775.433594" y="382">Add counters</tspan>
            </text>
            <text id="svg_7ff27514e403adcfeb25_Incorrect-result!" font-family="Helvetica" font-size="36" font-weight="normal" fill="#000000">
                <tspan x="1318.95996" y="529">Incorrect result!</tspan>
            </text>
            <g id="svg_7ff27514e403adcfeb25_Group" transform="translate(1272.679455, 519.679455) rotate(-315.000000) translate(-1272.679455, -519.679455) translate(1235.679455, 482.179455)" fill="#FF0000">
                <rect id="svg_7ff27514e403adcfeb25_Rectangle" x="0" y="26.5477272" width="73.7436867" height="20.6482323" />
                <rect id="svg_7ff27514e403adcfeb25_Rectangle" transform="translate(36.871843, 37.240562) rotate(-90.000000) translate(-36.871843, -37.240562) " x="0" y="28.0226009" width="73.7436867" height="18.4359217" />
            </g>
            <polygon id="svg_7ff27514e403adcfeb25_Path-1-Copy-2" fill="#F6A623" points="326 201.290861 501.290861 201 501.290861 181 541.290861 220.497767 501.290861 261 501.290861 241 326 241.290861"></polygon>
            <text id="svg_7ff27514e403adcfeb25_Incoming-request" font-family="Helvetica" font-size="36" font-weight="normal" fill="#000000">
                <tspan x="211.423828" y="182">Incoming request</tspan>
            </text>
        </g>
    </g>
</svg>
    <figcaption>Figure 29: Simple counters: second round of requests and
    (incorrect) reconciliation</figcaption>
    </figure>
    <p>This is clearly wrong! The problem is that simple counters don’t
    give us enough information about the history of interactions between
    the machines. Fortunately we don’t need to store the
    <em>complete</em> history to get the correct answer—just a summary
    of it. Let’s look at how the GCounter solves this problem.</p>
    <h3 data-number="19.2.2" id="gcounters"><span class="header-section-number">19.2.2</span> GCounters</h3>
    <p>The first clever idea in the GCounter is to have each machine
    storing a <em>separate</em> counter for every machine it knows about
    (including itself). In the previous example we had two machines,
    <code>A</code> and <code>B</code>. In this situation both machines
    would store a counter for <code>A</code> and a counter for
    <code>B</code> as shown in Figure 30.</p>
    <figure id="fig:crdt:g-counter1">
    <svg id="svg_e28f45d273797eed1a12" alt="GCounter: initial state" width="1761px" height="360px" viewBox="0 0 1761 360">
    <!-- Generator: Sketch 43.2 (39069) - http://www.bohemiancoding.com/sketch -->
    <title>g-counter1</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="svg_e28f45d273797eed1a12_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_e28f45d273797eed1a12_g-counter1">
            <rect id="svg_e28f45d273797eed1a12_Background" fill="#FFFFFF" x="0" y="0" width="1761" height="360" />
            <text id="svg_e28f45d273797eed1a12_Machine-B" font-family="Helvetica" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="981.283203" y="64">Machine B</tspan>
            </text>
            <rect id="svg_e28f45d273797eed1a12_Rectangle-1" stroke="#000000" stroke-width="4" x="981" y="121" width="196" height="196" rx="8" />
            <text id="svg_e28f45d273797eed1a12_Machine-A" font-family="Helvetica" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="583.431641" y="64">Machine A</tspan>
            </text>
            <text id="svg_e28f45d273797eed1a12_A:0-B:0" font-family="FiraMono-Regular, Fira Mono" font-size="60" font-weight="normal" fill="#000000">
                <tspan x="626" y="205">A:0</tspan>
                <tspan x="626" y="277">B:0</tspan>
            </text>
            <text id="svg_e28f45d273797eed1a12_A:0-B:0" font-family="FiraMono-Regular, Fira Mono" font-size="60" font-weight="normal" fill="#000000">
                <tspan x="1025" y="206">A:0</tspan>
                <tspan x="1025" y="278">B:0</tspan>
            </text>
            <rect id="svg_e28f45d273797eed1a12_Rectangle-1" stroke="#000000" stroke-width="4" x="582" y="121" width="196" height="196" rx="8" />
        </g>
    </g>
</svg>
    <figcaption>Figure 30: GCounter: initial state</figcaption>
    </figure>
    <p>The rule with GCounters is that a given machine is only allowed
    to increment its own counter. If <code>A</code> serves three
    visitors and <code>B</code> serves two visitors the counters look as
    shown in Figure 31.</p>
    <figure id="fig:crdt:g-counter2">
    <svg id="svg_b898fca665703bad30f3" alt="GCounter: first round of web requests" width="1761px" height="360px" viewBox="0 0 1761 360">
    <!-- Generator: Sketch 43.2 (39069) - http://www.bohemiancoding.com/sketch -->
    <title>g-counter2</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="svg_b898fca665703bad30f3_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_b898fca665703bad30f3_g-counter2">
            <rect id="svg_b898fca665703bad30f3_Background" fill="#FFFFFF" x="0" y="0" width="1761" height="360" />
            <rect id="svg_b898fca665703bad30f3_Rectangle-1" stroke="#000000" stroke-width="4" x="980" y="123" width="196" height="196" rx="8" />
            <text id="svg_b898fca665703bad30f3_A:3-B:0" font-family="FiraMono-Regular, Fira Mono" font-size="60" font-weight="normal" fill="#000000">
                <tspan x="625" y="205">A:3</tspan>
                <tspan x="625" y="277">B:0</tspan>
            </text>
            <text id="svg_b898fca665703bad30f3_A:0-B:2" font-family="FiraMono-Regular, Fira Mono" font-size="60" font-weight="normal" fill="#000000">
                <tspan x="1024" y="205">A:0</tspan>
                <tspan x="1024" y="277">B:2</tspan>
            </text>
            <rect id="svg_b898fca665703bad30f3_Rectangle-1" stroke="#000000" stroke-width="4" x="581" y="123" width="196" height="196" rx="8" />
            <text id="svg_b898fca665703bad30f3_Machine-B" font-family="Helvetica" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="980.283203" y="71">Machine B</tspan>
            </text>
            <text id="svg_b898fca665703bad30f3_Machine-A" font-family="Helvetica" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="582.431641" y="71">Machine A</tspan>
            </text>
            <polygon id="svg_b898fca665703bad30f3_Path-1-Copy-2" fill="#F6A623" transform="translate(1327.645430, 221.000000) scale(-1, 1) translate(-1327.645430, -221.000000) " points="1220 201.290861 1395.29086 201 1395.29086 181 1435.29086 220.497767 1395.29086 261 1395.29086 241 1220 241.290861"></polygon>
            <text id="svg_b898fca665703bad30f3_Incoming-requests" font-family="Helvetica" font-size="36" font-weight="normal" fill="#000000">
                <tspan x="1274.42383" y="182">Incoming requests</tspan>
            </text>
            <polygon id="svg_b898fca665703bad30f3_Path-1-Copy-2" fill="#F6A623" points="326 201.290861 501.290861 201 501.290861 181 541.290861 220.497767 501.290861 261 501.290861 241 326 241.290861"></polygon>
            <text id="svg_b898fca665703bad30f3_Incoming-requests" font-family="Helvetica" font-size="36" font-weight="normal" fill="#000000">
                <tspan x="190.423828" y="182">Incoming requests</tspan>
            </text>
        </g>
    </g>
</svg>
    <figcaption>Figure 31: GCounter: first round of web
    requests</figcaption>
    </figure>
    <p>When two machines reconcile their counters the rule is to take
    the largest value stored for each machine. In our example, the
    result of the first merge will be as shown in Figure 32.</p>
    <figure id="fig:crdt:g-counter3">
    <svg id="svg_575cf7edea62f97833cd" alt="GCounter: first reconciliation" width="1761px" height="660px" viewBox="0 0 1761 660">
    <!-- Generator: Sketch 43.2 (39069) - http://www.bohemiancoding.com/sketch -->
    <title>g-counter3</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="svg_575cf7edea62f97833cd_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_575cf7edea62f97833cd_g-counter3">
            <rect id="svg_575cf7edea62f97833cd_Background" fill="#FFFFFF" x="0" y="0" width="1761" height="660" />
            <rect id="svg_575cf7edea62f97833cd_Rectangle-1" stroke="#000000" stroke-width="4" x="981" y="422" width="196" height="196" rx="8" />
            <text id="svg_575cf7edea62f97833cd_A:3-B:2" font-family="FiraMono-Regular, Fira Mono" font-size="60" font-weight="normal" fill="#000000">
                <tspan x="626" y="504">A:3</tspan>
                <tspan x="626" y="576">B:2</tspan>
            </text>
            <text id="svg_575cf7edea62f97833cd_A:3-B:2" font-family="FiraMono-Regular, Fira Mono" font-size="60" font-weight="normal" fill="#000000">
                <tspan x="1025" y="503">A:3</tspan>
                <tspan x="1025" y="575">B:2</tspan>
            </text>
            <rect id="svg_575cf7edea62f97833cd_Rectangle-1" stroke="#000000" stroke-width="4" x="582" y="422" width="196" height="196" rx="8" />
            <polygon id="svg_575cf7edea62f97833cd_Path-1-Copy-2" fill="#F6A623" transform="translate(885.401085, 374.401085) rotate(-315.000000) translate(-885.401085, -374.401085) " points="777.755655 354.691946 953.046515 354.401085 953.046515 334.401085 993.046515 373.898852 953.046515 414.401085 953.046515 394.401085 777.755655 394.691946"></polygon>
            <polygon id="svg_575cf7edea62f97833cd_Path-1-Copy-2" fill="#F6A623" transform="translate(878.401085, 374.401085) rotate(-225.000000) translate(-878.401085, -374.401085) " points="770.755655 354.691946 946.046515 354.401085 946.046515 334.401085 986.046515 373.898852 946.046515 414.401085 946.046515 394.401085 770.755655 394.691946"></polygon>
            <rect id="svg_575cf7edea62f97833cd_Rectangle-1" stroke="#000000" stroke-width="4" x="981" y="122" width="196" height="196" rx="8" />
            <text id="svg_575cf7edea62f97833cd_A:3-B:0" font-family="FiraMono-Regular, Fira Mono" font-size="60" font-weight="normal" fill="#000000">
                <tspan x="626" y="203">A:3</tspan>
                <tspan x="626" y="275">B:0</tspan>
            </text>
            <text id="svg_575cf7edea62f97833cd_A:0-B:2" font-family="FiraMono-Regular, Fira Mono" font-size="60" font-weight="normal" fill="#000000">
                <tspan x="1025" y="203">A:0</tspan>
                <tspan x="1025" y="275">B:2</tspan>
            </text>
            <rect id="svg_575cf7edea62f97833cd_Rectangle-1" stroke="#000000" stroke-width="4" x="582" y="122" width="196" height="196" rx="8" />
            <text id="svg_575cf7edea62f97833cd_Machine-B" font-family="Helvetica" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="981.283203" y="70">Machine B</tspan>
            </text>
            <text id="svg_575cf7edea62f97833cd_Machine-A" font-family="Helvetica" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="583.431641" y="70">Machine A</tspan>
            </text>
            <text id="svg_575cf7edea62f97833cd_Merge,-take-max" font-family="Helvetica" font-size="36" font-weight="normal" fill="#000000">
                <tspan x="747.449219" y="384">Merge, take max</tspan>
            </text>
            <polygon id="svg_575cf7edea62f97833cd_Path-1-Copy-2" fill="#F6A623" transform="translate(1328.645430, 220.000000) scale(-1, 1) translate(-1328.645430, -220.000000) " points="1221 200.290861 1396.29086 200 1396.29086 180 1436.29086 219.497767 1396.29086 260 1396.29086 240 1221 240.290861"></polygon>
            <text id="svg_575cf7edea62f97833cd_Incoming-requests" font-family="Helvetica" font-size="36" font-weight="normal" fill="#000000">
                <tspan x="1275.42383" y="181">Incoming requests</tspan>
            </text>
            <polygon id="svg_575cf7edea62f97833cd_Path-1-Copy-2" fill="#F6A623" points="327 200.290861 502.290861 200 502.290861 180 542.290861 219.497767 502.290861 260 502.290861 240 327 240.290861"></polygon>
            <text id="svg_575cf7edea62f97833cd_Incoming-requests" font-family="Helvetica" font-size="36" font-weight="normal" fill="#000000">
                <tspan x="191.423828" y="181">Incoming requests</tspan>
            </text>
        </g>
    </g>
</svg>
    <figcaption>Figure 32: GCounter: first reconciliation</figcaption>
    </figure>
    <p>Subsequent incoming web requests are handled using the
    increment-own-counter rule and subsequent merges are handled using
    the take-maximum-value rule, producing the same correct values for
    each machine as shown in Figure 33.</p>
    <figure id="fig:crdt:g-counter5">
    <svg id="svg_3ee2daa379b832062759" alt="GCounter: second reconciliation" width="1761px" height="660px" viewBox="0 0 1761 660">
    <!-- Generator: Sketch 43.2 (39069) - http://www.bohemiancoding.com/sketch -->
    <title>g-counter5</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="svg_3ee2daa379b832062759_Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="svg_3ee2daa379b832062759_g-counter5">
            <rect id="svg_3ee2daa379b832062759_Background" fill="#FFFFFF" x="0" y="0" width="1761" height="660" />
            <rect id="svg_3ee2daa379b832062759_Rectangle-1" stroke="#000000" stroke-width="4" x="981" y="422" width="196" height="196" rx="8" />
            <text id="svg_3ee2daa379b832062759_A:4-B:2" font-family="FiraMono-Regular, Fira Mono" font-size="60" font-weight="normal" fill="#000000">
                <tspan x="626" y="507">A:4</tspan>
                <tspan x="626" y="579">B:2</tspan>
            </text>
            <text id="svg_3ee2daa379b832062759_A:4-B:2" font-family="FiraMono-Regular, Fira Mono" font-size="60" font-weight="normal" fill="#000000">
                <tspan x="1025" y="506">A:4</tspan>
                <tspan x="1025" y="578">B:2</tspan>
            </text>
            <rect id="svg_3ee2daa379b832062759_Rectangle-1" stroke="#000000" stroke-width="4" x="582" y="422" width="196" height="196" rx="8" />
            <polygon id="svg_3ee2daa379b832062759_Path-1-Copy-2" fill="#F6A623" transform="translate(885.401085, 374.401085) rotate(-315.000000) translate(-885.401085, -374.401085) " points="777.755655 354.691946 953.046515 354.401085 953.046515 334.401085 993.046515 373.898852 953.046515 414.401085 953.046515 394.401085 777.755655 394.691946"></polygon>
            <polygon id="svg_3ee2daa379b832062759_Path-1-Copy-2" fill="#F6A623" transform="translate(878.401085, 374.401085) rotate(-225.000000) translate(-878.401085, -374.401085) " points="770.755655 354.691946 946.046515 354.401085 946.046515 334.401085 986.046515 373.898852 946.046515 414.401085 946.046515 394.401085 770.755655 394.691946"></polygon>
            <rect id="svg_3ee2daa379b832062759_Rectangle-1" stroke="#000000" stroke-width="4" x="981" y="122" width="196" height="196" rx="8" />
            <text id="svg_3ee2daa379b832062759_A:4-B:2" font-family="FiraMono-Regular, Fira Mono" font-size="60" font-weight="normal" fill="#000000">
                <tspan x="626" y="206">A:4</tspan>
                <tspan x="626" y="278">B:2</tspan>
            </text>
            <text id="svg_3ee2daa379b832062759_A:3-B:2" font-family="FiraMono-Regular, Fira Mono" font-size="60" font-weight="normal" fill="#000000">
                <tspan x="1025" y="206">A:3</tspan>
                <tspan x="1025" y="278">B:2</tspan>
            </text>
            <rect id="svg_3ee2daa379b832062759_Rectangle-1" stroke="#000000" stroke-width="4" x="582" y="122" width="196" height="196" rx="8" />
            <text id="svg_3ee2daa379b832062759_Machine-B" font-family="Helvetica" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="981.283203" y="70">Machine B</tspan>
            </text>
            <text id="svg_3ee2daa379b832062759_Machine-A" font-family="Helvetica" font-size="42" font-weight="normal" fill="#000000">
                <tspan x="583.431641" y="70">Machine A</tspan>
            </text>
            <text id="svg_3ee2daa379b832062759_Merge,-take-max" font-family="Helvetica" font-size="36" font-weight="normal" fill="#000000">
                <tspan x="747.449219" y="382">Merge, take max</tspan>
            </text>
            <text id="svg_3ee2daa379b832062759_Correct-result!" font-family="Helvetica" font-size="36" font-weight="normal" fill="#000000">
                <tspan x="1329.97266" y="529">Correct result!</tspan>
            </text>
            <g id="svg_3ee2daa379b832062759_Group" transform="translate(1274.447222, 512.961941) rotate(-315.000000) translate(-1274.447222, -512.961941) translate(1255.947222, 475.461941)" fill="#417505">
                <rect id="svg_3ee2daa379b832062759_Rectangle" x="-2.27373675e-13" y="53.7609307" width="36.1162697" height="20.6482323" />
                <rect id="svg_3ee2daa379b832062759_Rectangle" transform="translate(27.528698, 37.583708) rotate(-90.000000) translate(-27.528698, -37.583708) " x="-9.34314575" y="28.3657467" width="73.7436867" height="18.4359217" />
            </g>
            <polygon id="svg_3ee2daa379b832062759_Path-1-Copy-2" fill="#F6A623" points="326 200.290861 501.290861 200 501.290861 180 541.290861 219.497767 501.290861 260 501.290861 240 326 240.290861"></polygon>
            <text id="svg_3ee2daa379b832062759_Incoming-request" font-family="Helvetica" font-size="36" font-weight="normal" fill="#000000">
                <tspan x="211.423828" y="181">Incoming request</tspan>
            </text>
        </g>
    </g>
</svg>
    <figcaption>Figure 33: GCounter: second reconciliation</figcaption>
    </figure>
    <p>GCounters allow each machine to keep an accurate account of the
    state of the whole system without storing the complete history of
    interactions. If a machine wants to calculate the total traffic for
    the whole web site, it sums up all the per-machine counters. The
    result is accurate or near-accurate depending on how recently we
    performed a reconciliation. Eventually, regardless of network
    outages, the system will always converge on a consistent state.</p>
    <h3 data-number="19.2.3" id="exercise-gcounter-implementation"><span class="header-section-number">19.2.3</span> Exercise: GCounter
    Implementation</h3>
    <p>We can implement a GCounter with the following interface, where
    we represent machine IDs as <code>Strings</code>.</p>
    <div class="sourceCode" id="cb984"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb984-1"><a href="#cb984-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">GCounter</span><span class="op">(</span>counters<span class="op">:</span> <span class="ex">Map</span><span class="op">[</span><span class="ex">String</span><span class="op">,</span> <span class="bu">Int</span><span class="op">])</span> <span class="op">{</span></span>
<span id="cb984-2"><a href="#cb984-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">increment</span><span class="op">(</span>machine<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> amount<span class="op">:</span> <span class="bu">Int</span><span class="op">)</span> <span class="op">=</span></span>
<span id="cb984-3"><a href="#cb984-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb984-4"><a href="#cb984-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb984-5"><a href="#cb984-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">merge</span><span class="op">(</span>that<span class="op">:</span> GCounter<span class="op">):</span> GCounter <span class="op">=</span></span>
<span id="cb984-6"><a href="#cb984-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb984-7"><a href="#cb984-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb984-8"><a href="#cb984-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> total<span class="op">:</span> <span class="bu">Int</span> <span class="op">=</span></span>
<span id="cb984-9"><a href="#cb984-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">???</span></span>
<span id="cb984-10"><a href="#cb984-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Finish the implementation!</p>
    <div class="solution">
    <p>Hopefully the description above was clear enough that you can get
    to an implementation like the one below.</p>
    <div class="sourceCode" id="cb985"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb985-1"><a href="#cb985-1" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> <span class="fu">GCounter</span><span class="op">(</span>counters<span class="op">:</span> <span class="ex">Map</span><span class="op">[</span><span class="ex">String</span><span class="op">,</span> <span class="bu">Int</span><span class="op">])</span> <span class="op">{</span></span>
<span id="cb985-2"><a href="#cb985-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">increment</span><span class="op">(</span>machine<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> amount<span class="op">:</span> <span class="bu">Int</span><span class="op">)</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb985-3"><a href="#cb985-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> value <span class="op">=</span> amount <span class="op">+</span> counters<span class="op">.</span><span class="fu">getOrElse</span><span class="op">(</span>machine<span class="op">,</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb985-4"><a href="#cb985-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GCounter</span><span class="op">(</span>counters <span class="op">+</span> <span class="op">(</span>machine <span class="op">-&gt;</span> value<span class="op">))</span></span>
<span id="cb985-5"><a href="#cb985-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb985-6"><a href="#cb985-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb985-7"><a href="#cb985-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">merge</span><span class="op">(</span>that<span class="op">:</span> GCounter<span class="op">):</span> GCounter <span class="op">=</span></span>
<span id="cb985-8"><a href="#cb985-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GCounter</span><span class="op">(</span>that<span class="op">.</span>counters <span class="op">++</span> <span class="kw">this</span><span class="op">.</span>counters<span class="op">.</span>map <span class="op">{</span></span>
<span id="cb985-9"><a href="#cb985-9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="op">(</span>k<span class="op">,</span> v<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb985-10"><a href="#cb985-10" aria-hidden="true" tabindex="-1"></a>        k <span class="op">-&gt;</span> <span class="op">(</span>v max that<span class="op">.</span>counters<span class="op">.</span><span class="fu">getOrElse</span><span class="op">(</span>k<span class="op">,</span> <span class="dv">0</span><span class="op">))</span></span>
<span id="cb985-11"><a href="#cb985-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">})</span></span>
<span id="cb985-12"><a href="#cb985-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb985-13"><a href="#cb985-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> total<span class="op">:</span> <span class="bu">Int</span> <span class="op">=</span></span>
<span id="cb985-14"><a href="#cb985-14" aria-hidden="true" tabindex="-1"></a>    counters<span class="op">.</span>values<span class="op">.</span>sum</span>
<span id="cb985-15"><a href="#cb985-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    </div>
    <h2 data-number="19.3" id="generalisation"><span class="header-section-number">19.3</span> Generalisation</h2>
    <p>We’ve now created a distributed, eventually consistent,
    increment-only counter. This is a useful achievement but we don’t
    want to stop here. In this section we will attempt to abstract the
    operations in the GCounter so it will work with more data types than
    just natural numbers.</p>
    <p>The GCounter uses the following operations on natural
    numbers:</p>
    <ul>
    <li>addition (in <code>increment</code> and
    <code>total</code>);</li>
    <li>maximum (in <code>merge</code>);</li>
    <li>and the identity element 0 (in <code>increment</code> and
    <code>merge</code>).</li>
    </ul>
    <p>You can probably guess that there’s a monoid in here somewhere,
    but let’s look in more detail at the properties we’re relying
    on.</p>
    <p>As a refresher, in Chapter 7 we saw that monoids must satisfy two
    laws. The binary operation <code>+</code> must be associative:</p>
    <p><code>(a + b) + c == a + (b + c)</code></p>
    <p>and the empty element must be an identity:</p>
    <p><code>0 + a == a + 0 == a</code></p>
    <p>We need an identity in <code>increment</code> to initialise the
    counter. We also rely on associativity to ensure the specific
    sequence of <code>merges</code> gives the correct value.</p>
    <p>In <code>total</code> we implicitly rely on associativity and
    commutativity to ensure we get the correct value no matter what
    arbitrary order we choose to sum the per-machine counters. We also
    implicitly assume an identity, which allows us to skip machines for
    which we do not store a counter.</p>
    <p>The properties of <code>merge</code> are a bit more interesting.
    We rely on commutativity to ensure that machine <code>A</code>
    merging with machine <code>B</code> yields the same result as
    machine <code>B</code> merging with machine <code>A</code>. We need
    associativity to ensure we obtain the correct result when three or
    more machines are merging data. We need an identity element to
    initialise empty counters. Finally, we need an additional property,
    called <em>idempotency</em>, to ensure that if two machines hold the
    same data in a per-machine counter, merging data will not lead to an
    incorrect result. Idempotent operations are ones that return the
    same result again and again if they are executed multiple times.
    Formally, a binary operation <code>max</code> is idempotent if the
    following relationship holds:</p>
    <pre><code>a max a = a</code></pre>
    <p>Written more compactly, we have:</p>
    <div class="table-responsive">
    <table style="width:96%;">
    <colgroup>
    <col style="width: 20%" />
    <col style="width: 16%" />
    <col style="width: 19%" />
    <col style="width: 19%" />
    <col style="width: 19%" />
    </colgroup>
    <thead>
    <tr class="header">
    <th style="text-align: center;">Method</th>
    <th style="text-align: center;">Identity</th>
    <th style="text-align: center;">Commutative</th>
    <th style="text-align: center;">Associative</th>
    <th style="text-align: center;">Idempotent</th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td style="text-align: center;"><code>increment</code></td>
    <td style="text-align: center;">Y</td>
    <td style="text-align: center;">N</td>
    <td style="text-align: center;">Y</td>
    <td style="text-align: center;">N</td>
    </tr>
    <tr class="even">
    <td style="text-align: center;"><code>merge</code></td>
    <td style="text-align: center;">Y</td>
    <td style="text-align: center;">Y</td>
    <td style="text-align: center;">Y</td>
    <td style="text-align: center;">Y</td>
    </tr>
    <tr class="odd">
    <td style="text-align: center;"><code>total</code></td>
    <td style="text-align: center;">Y</td>
    <td style="text-align: center;">Y</td>
    <td style="text-align: center;">Y</td>
    <td style="text-align: center;">N</td>
    </tr>
    </tbody>
    </table>
    </div>
    <p>From this we can see that</p>
    <ul>
    <li><code>increment</code> requires a monoid;</li>
    <li><code>total</code> requires a commutative monoid; and</li>
    <li><code>merge</code> required an idempotent commutative monoid,
    also called a <em>bounded semilattice</em>.</li>
    </ul>
    <p>Since <code>increment</code> and <code>get</code> both use the
    same binary operation (addition) it’s usual to require the same
    commutative monoid for both.</p>
    <p>This investigation demonstrates the powers of thinking about
    properties or laws of abstractions. Now we have identified these
    properties we can substitute the natural numbers used in our
    GCounter with any data type with operations satisfying these
    properties. A simple example is a set, with the binary operation
    being union and the identity element the empty set. With this simple
    substitution of <code>Int</code> for <code>Set[A]</code> we can
    create a GSet type.</p>
    <h3 data-number="19.3.1" id="implementation"><span class="header-section-number">19.3.1</span> Implementation</h3>
    <p>Let’s implement this generalisation in code. Remember
    <code>increment</code> and <code>total</code> require a commutative
    monoid and <code>merge</code> requires a bounded semilattice (or
    idempotent commutative monoid).</p>
    <p>Cats provides a type class for both <code>Monoid</code> and
    <code>CommutativeMonoid</code>, but doesn’t provide one for bounded
    semilattice<a href="#fn17" class="footnote-ref" id="fnref17" role="doc-noteref"><sup>17</sup></a>. That’s why we’re going to
    implement our own <code>BoundedSemiLattice</code> type class.</p>
    <div class="sourceCode" id="cb987"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb987-1"><a href="#cb987-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>kernel<span class="op">.</span>CommutativeMonoid</span>
<span id="cb987-2"><a href="#cb987-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb987-3"><a href="#cb987-3" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> BoundedSemiLattice<span class="op">[</span>A<span class="op">]</span> <span class="kw">extends</span> CommutativeMonoid<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb987-4"><a href="#cb987-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">combine</span><span class="op">(</span>a1<span class="op">:</span> A<span class="op">,</span> a2<span class="op">:</span> A<span class="op">):</span> A</span>
<span id="cb987-5"><a href="#cb987-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> empty<span class="op">:</span> A</span>
<span id="cb987-6"><a href="#cb987-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>In the implementation above, <code>BoundedSemiLattice[A]</code>
    extends <code>CommutativeMonoid[A]</code> because a bounded
    semilattice is a commutative monoid (a commutative idempotent one,
    to be exact).</p>
    <h3 data-number="19.3.2" id="exercise-boundedsemilattice-instances"><span class="header-section-number">19.3.2</span> Exercise:
    BoundedSemiLattice Instances</h3>
    <p>Implement <code>BoundedSemiLattice</code> type class instances
    for <code>Ints</code> and for <code>Sets</code>. The instance for
    <code>Int</code> will technically only hold for non-negative
    numbers, but you don’t need to model non-negativity explicitly in
    the types.</p>
    <div class="solution">
    <p>It’s common to place the instances in the companion object of
    <code>BoundedSemiLattice</code> so they are in the implicit scope
    without importing them.</p>
    <p>Implementing the instance for <code>Set</code> provides good
    practice with implicit methods.</p>
    <div class="sourceCode" id="cb988"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb988-1"><a href="#cb988-1" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> wrapper <span class="op">{</span></span>
<span id="cb988-2"><a href="#cb988-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">trait</span> BoundedSemiLattice<span class="op">[</span>A<span class="op">]</span> <span class="kw">extends</span> CommutativeMonoid<span class="op">[</span>A<span class="op">]</span> <span class="op">{</span></span>
<span id="cb988-3"><a href="#cb988-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">combine</span><span class="op">(</span>a1<span class="op">:</span> A<span class="op">,</span> a2<span class="op">:</span> A<span class="op">):</span> A</span>
<span id="cb988-4"><a href="#cb988-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> empty<span class="op">:</span> A</span>
<span id="cb988-5"><a href="#cb988-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb988-6"><a href="#cb988-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb988-7"><a href="#cb988-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">object</span> BoundedSemiLattice <span class="op">{</span></span>
<span id="cb988-8"><a href="#cb988-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">implicit</span> <span class="kw">val</span> intInstance<span class="op">:</span> BoundedSemiLattice<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb988-9"><a href="#cb988-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">new</span> BoundedSemiLattice<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">{</span></span>
<span id="cb988-10"><a href="#cb988-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> <span class="fu">combine</span><span class="op">(</span>a1<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> a2<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="bu">Int</span> <span class="op">=</span></span>
<span id="cb988-11"><a href="#cb988-11" aria-hidden="true" tabindex="-1"></a>          a1 max a2</span>
<span id="cb988-12"><a href="#cb988-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb988-13"><a href="#cb988-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">val</span> empty<span class="op">:</span> <span class="bu">Int</span> <span class="op">=</span></span>
<span id="cb988-14"><a href="#cb988-14" aria-hidden="true" tabindex="-1"></a>          <span class="dv">0</span></span>
<span id="cb988-15"><a href="#cb988-15" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb988-16"><a href="#cb988-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb988-17"><a href="#cb988-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">implicit</span> <span class="kw">def</span> setInstance<span class="op">[</span>A<span class="op">]:</span> BoundedSemiLattice<span class="op">[</span><span class="ex">Set</span><span class="op">[</span>A<span class="op">]]</span> <span class="op">=</span></span>
<span id="cb988-18"><a href="#cb988-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">new</span> BoundedSemiLattice<span class="op">[</span><span class="ex">Set</span><span class="op">[</span>A<span class="op">]]{</span></span>
<span id="cb988-19"><a href="#cb988-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> <span class="fu">combine</span><span class="op">(</span>a1<span class="op">:</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">],</span> a2<span class="op">:</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]):</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb988-20"><a href="#cb988-20" aria-hidden="true" tabindex="-1"></a>          a1 union a2</span>
<span id="cb988-21"><a href="#cb988-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb988-22"><a href="#cb988-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">val</span> empty<span class="op">:</span> <span class="ex">Set</span><span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb988-23"><a href="#cb988-23" aria-hidden="true" tabindex="-1"></a>          <span class="ex">Set</span><span class="op">.</span>empty<span class="op">[</span>A<span class="op">]</span></span>
<span id="cb988-24"><a href="#cb988-24" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb988-25"><a href="#cb988-25" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb988-26"><a href="#cb988-26" aria-hidden="true" tabindex="-1"></a><span class="op">};</span> <span class="kw">import</span> wrapper<span class="op">.</span>_</span></code></pre></div>
    </div>
    <h3 data-number="19.3.3" id="exercise-generic-gcounter"><span class="header-section-number">19.3.3</span> Exercise: Generic
    GCounter</h3>
    <p>Using <code>CommutativeMonoid</code> and
    <code>BoundedSemiLattice</code>, generalise
    <code>GCounter</code>.</p>
    <p>When you implement this, look for opportunities to use methods
    and syntax on <code>Monoid</code> to simplify your implementation.
    This is a good example of how type class abstractions work at
    multiple levels in our code. We’re using monoids to design a large
    component—our CRDTs—but they are also useful in the small,
    simplifying our code and making it shorter and clearer.</p>
    <div class="solution">
    <p>Here’s a working implementation. Note the use of <code>|+|</code>
    in the definition of <code>merge</code>, which significantly
    simplifies the process of merging and maximising counters:</p>
    <div class="sourceCode" id="cb989"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb989-1"><a href="#cb989-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>list<span class="op">.</span>_   <span class="co">// for Monoid</span></span>
<span id="cb989-2"><a href="#cb989-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>map<span class="op">.</span>_    <span class="co">// for Monoid</span></span>
<span id="cb989-3"><a href="#cb989-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>semigroup<span class="op">.</span>_ <span class="co">// for |+|</span></span>
<span id="cb989-4"><a href="#cb989-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>foldable<span class="op">.</span>_  <span class="co">// for combineAll</span></span>
<span id="cb989-5"><a href="#cb989-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb989-6"><a href="#cb989-6" aria-hidden="true" tabindex="-1"></a><span class="kw">final</span> <span class="cf">case</span> <span class="kw">class</span> GCounter<span class="op">[</span>A<span class="op">](</span>counters<span class="op">:</span> <span class="ex">Map</span><span class="op">[</span><span class="ex">String</span><span class="op">,</span>A<span class="op">])</span> <span class="op">{</span></span>
<span id="cb989-7"><a href="#cb989-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">increment</span><span class="op">(</span>machine<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> amount<span class="op">:</span> A<span class="op">)</span></span>
<span id="cb989-8"><a href="#cb989-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span><span class="kw">implicit</span> m<span class="op">:</span> CommutativeMonoid<span class="op">[</span>A<span class="op">]):</span> GCounter<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb989-9"><a href="#cb989-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> value <span class="op">=</span> amount <span class="op">|+|</span> counters<span class="op">.</span><span class="fu">getOrElse</span><span class="op">(</span>machine<span class="op">,</span> m<span class="op">.</span>empty<span class="op">)</span></span>
<span id="cb989-10"><a href="#cb989-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GCounter</span><span class="op">(</span>counters <span class="op">+</span> <span class="op">(</span>machine <span class="op">-&gt;</span> value<span class="op">))</span></span>
<span id="cb989-11"><a href="#cb989-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb989-12"><a href="#cb989-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb989-13"><a href="#cb989-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">merge</span><span class="op">(</span>that<span class="op">:</span> GCounter<span class="op">[</span>A<span class="op">])</span></span>
<span id="cb989-14"><a href="#cb989-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span><span class="kw">implicit</span> b<span class="op">:</span> BoundedSemiLattice<span class="op">[</span>A<span class="op">]):</span> GCounter<span class="op">[</span>A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb989-15"><a href="#cb989-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">GCounter</span><span class="op">(</span><span class="kw">this</span><span class="op">.</span>counters <span class="op">|+|</span> that<span class="op">.</span>counters<span class="op">)</span></span>
<span id="cb989-16"><a href="#cb989-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb989-17"><a href="#cb989-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">total</span><span class="op">(</span><span class="kw">implicit</span> m<span class="op">:</span> CommutativeMonoid<span class="op">[</span>A<span class="op">]):</span> A <span class="op">=</span></span>
<span id="cb989-18"><a href="#cb989-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span>counters<span class="op">.</span>values<span class="op">.</span>toList<span class="op">.</span>combineAll</span>
<span id="cb989-19"><a href="#cb989-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    </div>
    <h2 data-number="19.4" id="abstracting-gcounter-to-a-type-class"><span class="header-section-number">19.4</span> Abstracting GCounter to a
    Type Class</h2>
    <p>We’ve created a generic GCounter that works with any value that
    has instances of <code>BoundedSemiLattice</code> and
    <code>CommutativeMonoid</code>. However we’re still tied to a
    particular representation of the map from machine IDs to values.
    There is no need to have this restriction, and indeed it can be
    useful to abstract away from it. There are many key-value stores
    that we want to work with, from a simple <code>Map</code> to a
    relational database.</p>
    <p>If we define a <code>GCounter</code> type class we can abstract
    over different concrete implementations. This allows us to, for
    example, seamlessly substitute an in-memory store for a persistent
    store when we want to change performance and durability
    tradeoffs.</p>
    <p>There are a number of ways we can implement this. One approach is
    to define a <code>GCounter</code> type class with dependencies on
    <code>CommutativeMonoid</code> and <code>BoundedSemiLattice</code>.
    We define this as a type class that takes a type constructor with
    <em>two</em> type parameters represent the key and value types of
    the map abstraction.</p>
    <div class="sourceCode" id="cb990"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb990-1"><a href="#cb990-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> GCounter<span class="op">[</span>F<span class="op">[</span>_<span class="op">,</span>_<span class="op">],</span>K<span class="op">,</span> V<span class="op">]</span> <span class="op">{</span></span>
<span id="cb990-2"><a href="#cb990-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">increment</span><span class="op">(</span>f<span class="op">:</span> F<span class="op">[</span>K<span class="op">,</span> V<span class="op">])(</span>k<span class="op">:</span> K<span class="op">,</span> v<span class="op">:</span> V<span class="op">)</span></span>
<span id="cb990-3"><a href="#cb990-3" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span><span class="kw">implicit</span> m<span class="op">:</span> CommutativeMonoid<span class="op">[</span>V<span class="op">]):</span> F<span class="op">[</span>K<span class="op">,</span> V<span class="op">]</span></span>
<span id="cb990-4"><a href="#cb990-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb990-5"><a href="#cb990-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">merge</span><span class="op">(</span>f1<span class="op">:</span> F<span class="op">[</span>K<span class="op">,</span> V<span class="op">],</span> f2<span class="op">:</span> F<span class="op">[</span>K<span class="op">,</span> V<span class="op">])</span></span>
<span id="cb990-6"><a href="#cb990-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span><span class="kw">implicit</span> b<span class="op">:</span> BoundedSemiLattice<span class="op">[</span>V<span class="op">]):</span> F<span class="op">[</span>K<span class="op">,</span> V<span class="op">]</span></span>
<span id="cb990-7"><a href="#cb990-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb990-8"><a href="#cb990-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">total</span><span class="op">(</span>f<span class="op">:</span> F<span class="op">[</span>K<span class="op">,</span> V<span class="op">])</span></span>
<span id="cb990-9"><a href="#cb990-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span><span class="kw">implicit</span> m<span class="op">:</span> CommutativeMonoid<span class="op">[</span>V<span class="op">]):</span> V</span>
<span id="cb990-10"><a href="#cb990-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb990-11"><a href="#cb990-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb990-12"><a href="#cb990-12" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> GCounter <span class="op">{</span></span>
<span id="cb990-13"><a href="#cb990-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> apply<span class="op">[</span>F<span class="op">[</span>_<span class="op">,</span>_<span class="op">],</span> K<span class="op">,</span> V<span class="op">]</span></span>
<span id="cb990-14"><a href="#cb990-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span><span class="kw">implicit</span> counter<span class="op">:</span> GCounter<span class="op">[</span>F<span class="op">,</span> K<span class="op">,</span> V<span class="op">])</span> <span class="op">=</span></span>
<span id="cb990-15"><a href="#cb990-15" aria-hidden="true" tabindex="-1"></a>    counter</span>
<span id="cb990-16"><a href="#cb990-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Try defining an instance of this type class for <code>Map</code>.
    You should be able to reuse your code from the case class version of
    <code>GCounter</code> with some minor modifications.</p>
    <div class="solution">
    <p>Here’s the complete code for the instance. Write this definition
    in the companion object for <code>GCounter</code> to place it in
    global implicit scope:</p>
    <div class="sourceCode" id="cb991"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb991-1"><a href="#cb991-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>list<span class="op">.</span>_   <span class="co">// for Monoid</span></span>
<span id="cb991-2"><a href="#cb991-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span>map<span class="op">.</span>_    <span class="co">// for Monoid</span></span>
<span id="cb991-3"><a href="#cb991-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>semigroup<span class="op">.</span>_ <span class="co">// for |+|</span></span>
<span id="cb991-4"><a href="#cb991-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>syntax<span class="op">.</span>foldable<span class="op">.</span>_  <span class="co">// for combineAll</span></span>
<span id="cb991-5"><a href="#cb991-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb991-6"><a href="#cb991-6" aria-hidden="true" tabindex="-1"></a><span class="kw">implicit</span> <span class="kw">def</span> mapGCounterInstance<span class="op">[</span>K<span class="op">,</span> V<span class="op">]:</span> GCounter<span class="op">[</span><span class="ex">Map</span><span class="op">,</span> K<span class="op">,</span> V<span class="op">]</span> <span class="op">=</span></span>
<span id="cb991-7"><a href="#cb991-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> GCounter<span class="op">[</span><span class="ex">Map</span><span class="op">,</span> K<span class="op">,</span> V<span class="op">]</span> <span class="op">{</span></span>
<span id="cb991-8"><a href="#cb991-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">increment</span><span class="op">(</span>map<span class="op">:</span> <span class="ex">Map</span><span class="op">[</span>K<span class="op">,</span> V<span class="op">])(</span>key<span class="op">:</span> K<span class="op">,</span> value<span class="op">:</span> V<span class="op">)</span></span>
<span id="cb991-9"><a href="#cb991-9" aria-hidden="true" tabindex="-1"></a>          <span class="op">(</span><span class="kw">implicit</span> m<span class="op">:</span> CommutativeMonoid<span class="op">[</span>V<span class="op">]):</span> <span class="ex">Map</span><span class="op">[</span>K<span class="op">,</span> V<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb991-10"><a href="#cb991-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">val</span> total <span class="op">=</span> map<span class="op">.</span><span class="fu">getOrElse</span><span class="op">(</span>key<span class="op">,</span> m<span class="op">.</span>empty<span class="op">)</span> <span class="op">|+|</span> value</span>
<span id="cb991-11"><a href="#cb991-11" aria-hidden="true" tabindex="-1"></a>      map <span class="op">+</span> <span class="op">(</span>key <span class="op">-&gt;</span> total<span class="op">)</span></span>
<span id="cb991-12"><a href="#cb991-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb991-13"><a href="#cb991-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb991-14"><a href="#cb991-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">merge</span><span class="op">(</span>map1<span class="op">:</span> <span class="ex">Map</span><span class="op">[</span>K<span class="op">,</span> V<span class="op">],</span> map2<span class="op">:</span> <span class="ex">Map</span><span class="op">[</span>K<span class="op">,</span> V<span class="op">])</span></span>
<span id="cb991-15"><a href="#cb991-15" aria-hidden="true" tabindex="-1"></a>          <span class="op">(</span><span class="kw">implicit</span> b<span class="op">:</span> BoundedSemiLattice<span class="op">[</span>V<span class="op">]):</span> <span class="ex">Map</span><span class="op">[</span>K<span class="op">,</span> V<span class="op">]</span> <span class="op">=</span></span>
<span id="cb991-16"><a href="#cb991-16" aria-hidden="true" tabindex="-1"></a>      map1 <span class="op">|+|</span> map2</span>
<span id="cb991-17"><a href="#cb991-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb991-18"><a href="#cb991-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">total</span><span class="op">(</span>map<span class="op">:</span> <span class="ex">Map</span><span class="op">[</span>K<span class="op">,</span> V<span class="op">])</span></span>
<span id="cb991-19"><a href="#cb991-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span><span class="kw">implicit</span> m<span class="op">:</span> CommutativeMonoid<span class="op">[</span>V<span class="op">]):</span> V <span class="op">=</span></span>
<span id="cb991-20"><a href="#cb991-20" aria-hidden="true" tabindex="-1"></a>      map<span class="op">.</span>values<span class="op">.</span>toList<span class="op">.</span>combineAll</span>
<span id="cb991-21"><a href="#cb991-21" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    </div>
    <p>You should be able to use your instance as follows:</p>
    <div class="sourceCode" id="cb992"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb992-1"><a href="#cb992-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> cats<span class="op">.</span>instances<span class="op">.</span><span class="dt">int</span><span class="op">.</span>_ <span class="co">// for Monoid</span></span>
<span id="cb992-2"><a href="#cb992-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb992-3"><a href="#cb992-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> g1 <span class="op">=</span> <span class="ex">Map</span><span class="op">(</span><span class="st">&quot;a&quot;</span> <span class="op">-&gt;</span> <span class="dv">7</span><span class="op">,</span> <span class="st">&quot;b&quot;</span> <span class="op">-&gt;</span> <span class="dv">3</span><span class="op">)</span></span>
<span id="cb992-4"><a href="#cb992-4" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> g2 <span class="op">=</span> <span class="ex">Map</span><span class="op">(</span><span class="st">&quot;a&quot;</span> <span class="op">-&gt;</span> <span class="dv">2</span><span class="op">,</span> <span class="st">&quot;b&quot;</span> <span class="op">-&gt;</span> <span class="dv">5</span><span class="op">)</span></span>
<span id="cb992-5"><a href="#cb992-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb992-6"><a href="#cb992-6" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> counter <span class="op">=</span> GCounter<span class="op">[</span><span class="ex">Map</span><span class="op">,</span> <span class="ex">String</span><span class="op">,</span> <span class="bu">Int</span><span class="op">]</span></span></code></pre></div>
    <div class="sourceCode" id="cb993"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb993-1"><a href="#cb993-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> merged <span class="op">=</span> counter<span class="op">.</span><span class="fu">merge</span><span class="op">(</span>g1<span class="op">,</span> g2<span class="op">)</span></span>
<span id="cb993-2"><a href="#cb993-2" aria-hidden="true" tabindex="-1"></a><span class="co">// merged: Map[String, Int] = Map(&quot;a&quot; -&gt; 7, &quot;b&quot; -&gt; 5)</span></span>
<span id="cb993-3"><a href="#cb993-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> total  <span class="op">=</span> counter<span class="op">.</span><span class="fu">total</span><span class="op">(</span>merged<span class="op">)</span></span>
<span id="cb993-4"><a href="#cb993-4" aria-hidden="true" tabindex="-1"></a><span class="co">// total: Int = 12</span></span></code></pre></div>
    <p>The implementation strategy for the type class instance is a bit
    unsatisfying. Although the structure of the implementation will be
    the same for most instances we define, we won’t get any code
    reuse.</p>
    <h2 data-number="19.5" id="abstracting-a-key-value-store"><span class="header-section-number">19.5</span> Abstracting a Key Value
    Store</h2>
    <p>One solution is to capture the idea of a key-value store within a
    type class, and then generate <code>GCounter</code> instances for
    any type that has a <code>KeyValueStore</code> instance. Here’s the
    code for such a type class:</p>
    <div class="sourceCode" id="cb994"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb994-1"><a href="#cb994-1" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> KeyValueStore<span class="op">[</span>F<span class="op">[</span>_<span class="op">,</span>_<span class="op">]]</span> <span class="op">{</span></span>
<span id="cb994-2"><a href="#cb994-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> put<span class="op">[</span>K<span class="op">,</span> V<span class="op">](</span>f<span class="op">:</span> F<span class="op">[</span>K<span class="op">,</span> V<span class="op">])(</span>k<span class="op">:</span> K<span class="op">,</span> v<span class="op">:</span> V<span class="op">):</span> F<span class="op">[</span>K<span class="op">,</span> V<span class="op">]</span></span>
<span id="cb994-3"><a href="#cb994-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb994-4"><a href="#cb994-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> get<span class="op">[</span>K<span class="op">,</span> V<span class="op">](</span>f<span class="op">:</span> F<span class="op">[</span>K<span class="op">,</span> V<span class="op">])(</span>k<span class="op">:</span> K<span class="op">):</span> <span class="ex">Option</span><span class="op">[</span>V<span class="op">]</span></span>
<span id="cb994-5"><a href="#cb994-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb994-6"><a href="#cb994-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> getOrElse<span class="op">[</span>K<span class="op">,</span> V<span class="op">](</span>f<span class="op">:</span> F<span class="op">[</span>K<span class="op">,</span> V<span class="op">])(</span>k<span class="op">:</span> K<span class="op">,</span> default<span class="op">:</span> V<span class="op">):</span> V <span class="op">=</span></span>
<span id="cb994-7"><a href="#cb994-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">get</span><span class="op">(</span>f<span class="op">)(</span>k<span class="op">).</span><span class="fu">getOrElse</span><span class="op">(</span>default<span class="op">)</span></span>
<span id="cb994-8"><a href="#cb994-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb994-9"><a href="#cb994-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> values<span class="op">[</span>K<span class="op">,</span> V<span class="op">](</span>f<span class="op">:</span> F<span class="op">[</span>K<span class="op">,</span> V<span class="op">]):</span> <span class="ex">List</span><span class="op">[</span>V<span class="op">]</span></span>
<span id="cb994-10"><a href="#cb994-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Implement your own instance for <code>Map</code>.</p>
    <div class="solution">
    <p>Here’s the code for the instance. Write the definition in the
    companion object for <code>KeyValueStore</code> to place it in
    global implicit scope:</p>
    <div class="sourceCode" id="cb995"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb995-1"><a href="#cb995-1" aria-hidden="true" tabindex="-1"></a><span class="kw">implicit</span> <span class="kw">val</span> mapKeyValueStoreInstance<span class="op">:</span> KeyValueStore<span class="op">[</span><span class="ex">Map</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb995-2"><a href="#cb995-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> KeyValueStore<span class="op">[</span><span class="ex">Map</span><span class="op">]</span> <span class="op">{</span></span>
<span id="cb995-3"><a href="#cb995-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> put<span class="op">[</span>K<span class="op">,</span> V<span class="op">](</span>f<span class="op">:</span> <span class="ex">Map</span><span class="op">[</span>K<span class="op">,</span> V<span class="op">])(</span>k<span class="op">:</span> K<span class="op">,</span> v<span class="op">:</span> V<span class="op">):</span> <span class="ex">Map</span><span class="op">[</span>K<span class="op">,</span> V<span class="op">]</span> <span class="op">=</span></span>
<span id="cb995-4"><a href="#cb995-4" aria-hidden="true" tabindex="-1"></a>      f <span class="op">+</span> <span class="op">(</span>k <span class="op">-&gt;</span> v<span class="op">)</span></span>
<span id="cb995-5"><a href="#cb995-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb995-6"><a href="#cb995-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get<span class="op">[</span>K<span class="op">,</span> V<span class="op">](</span>f<span class="op">:</span> <span class="ex">Map</span><span class="op">[</span>K<span class="op">,</span> V<span class="op">])(</span>k<span class="op">:</span> K<span class="op">):</span> <span class="ex">Option</span><span class="op">[</span>V<span class="op">]</span> <span class="op">=</span></span>
<span id="cb995-7"><a href="#cb995-7" aria-hidden="true" tabindex="-1"></a>      f<span class="op">.</span><span class="fu">get</span><span class="op">(</span>k<span class="op">)</span></span>
<span id="cb995-8"><a href="#cb995-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb995-9"><a href="#cb995-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">def</span> getOrElse<span class="op">[</span>K<span class="op">,</span> V<span class="op">](</span>f<span class="op">:</span> <span class="ex">Map</span><span class="op">[</span>K<span class="op">,</span> V<span class="op">])</span></span>
<span id="cb995-10"><a href="#cb995-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span>k<span class="op">:</span> K<span class="op">,</span> default<span class="op">:</span> V<span class="op">):</span> V <span class="op">=</span></span>
<span id="cb995-11"><a href="#cb995-11" aria-hidden="true" tabindex="-1"></a>      f<span class="op">.</span><span class="fu">getOrElse</span><span class="op">(</span>k<span class="op">,</span> default<span class="op">)</span></span>
<span id="cb995-12"><a href="#cb995-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb995-13"><a href="#cb995-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> values<span class="op">[</span>K<span class="op">,</span> V<span class="op">](</span>f<span class="op">:</span> <span class="ex">Map</span><span class="op">[</span>K<span class="op">,</span> V<span class="op">]):</span> <span class="ex">List</span><span class="op">[</span>V<span class="op">]</span> <span class="op">=</span></span>
<span id="cb995-14"><a href="#cb995-14" aria-hidden="true" tabindex="-1"></a>      f<span class="op">.</span>values<span class="op">.</span>toList</span>
<span id="cb995-15"><a href="#cb995-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    </div>
    <p>With our type class in place we can implement syntax to enhance
    data types for which we have instances:</p>
    <div class="sourceCode" id="cb996"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb996-1"><a href="#cb996-1" aria-hidden="true" tabindex="-1"></a><span class="kw">implicit</span> <span class="kw">class</span> KvsOps<span class="op">[</span>F<span class="op">[</span>_<span class="op">,</span>_<span class="op">],</span> K<span class="op">,</span> V<span class="op">](</span>f<span class="op">:</span> F<span class="op">[</span>K<span class="op">,</span> V<span class="op">])</span> <span class="op">{</span></span>
<span id="cb996-2"><a href="#cb996-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">put</span><span class="op">(</span>key<span class="op">:</span> K<span class="op">,</span> value<span class="op">:</span> V<span class="op">)</span></span>
<span id="cb996-3"><a href="#cb996-3" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span><span class="kw">implicit</span> kvs<span class="op">:</span> KeyValueStore<span class="op">[</span>F<span class="op">]):</span> F<span class="op">[</span>K<span class="op">,</span> V<span class="op">]</span> <span class="op">=</span></span>
<span id="cb996-4"><a href="#cb996-4" aria-hidden="true" tabindex="-1"></a>    kvs<span class="op">.</span><span class="fu">put</span><span class="op">(</span>f<span class="op">)(</span>key<span class="op">,</span> value<span class="op">)</span></span>
<span id="cb996-5"><a href="#cb996-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb996-6"><a href="#cb996-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">get</span><span class="op">(</span>key<span class="op">:</span> K<span class="op">)(</span><span class="kw">implicit</span> kvs<span class="op">:</span> KeyValueStore<span class="op">[</span>F<span class="op">]):</span> <span class="ex">Option</span><span class="op">[</span>V<span class="op">]</span> <span class="op">=</span></span>
<span id="cb996-7"><a href="#cb996-7" aria-hidden="true" tabindex="-1"></a>    kvs<span class="op">.</span><span class="fu">get</span><span class="op">(</span>f<span class="op">)(</span>key<span class="op">)</span></span>
<span id="cb996-8"><a href="#cb996-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb996-9"><a href="#cb996-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">getOrElse</span><span class="op">(</span>key<span class="op">:</span> K<span class="op">,</span> default<span class="op">:</span> V<span class="op">)</span></span>
<span id="cb996-10"><a href="#cb996-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span><span class="kw">implicit</span> kvs<span class="op">:</span> KeyValueStore<span class="op">[</span>F<span class="op">]):</span> V <span class="op">=</span></span>
<span id="cb996-11"><a href="#cb996-11" aria-hidden="true" tabindex="-1"></a>    kvs<span class="op">.</span><span class="fu">getOrElse</span><span class="op">(</span>f<span class="op">)(</span>key<span class="op">,</span> default<span class="op">)</span></span>
<span id="cb996-12"><a href="#cb996-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb996-13"><a href="#cb996-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">values</span><span class="op">(</span><span class="kw">implicit</span> kvs<span class="op">:</span> KeyValueStore<span class="op">[</span>F<span class="op">]):</span> <span class="ex">List</span><span class="op">[</span>V<span class="op">]</span> <span class="op">=</span></span>
<span id="cb996-14"><a href="#cb996-14" aria-hidden="true" tabindex="-1"></a>    kvs<span class="op">.</span><span class="fu">values</span><span class="op">(</span>f<span class="op">)</span></span>
<span id="cb996-15"><a href="#cb996-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
    <p>Now we can generate <code>GCounter</code> instances for any data
    type that has instances of <code>KeyValueStore</code> and
    <code>CommutativeMonoid</code> using an
    <code>implicit def</code>:</p>
    <div class="sourceCode" id="cb997"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb997-1"><a href="#cb997-1" aria-hidden="true" tabindex="-1"></a><span class="kw">implicit</span> <span class="kw">def</span> gcounterInstance<span class="op">[</span>F<span class="op">[</span>_<span class="op">,</span>_<span class="op">],</span> K<span class="op">,</span> V<span class="op">]</span></span>
<span id="cb997-2"><a href="#cb997-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span><span class="kw">implicit</span> kvs<span class="op">:</span> KeyValueStore<span class="op">[</span>F<span class="op">],</span> km<span class="op">:</span> CommutativeMonoid<span class="op">[</span>F<span class="op">[</span>K<span class="op">,</span> V<span class="op">]]):</span> GCounter<span class="op">[</span>F<span class="op">,</span> K<span class="op">,</span> V<span class="op">]</span> <span class="op">=</span></span>
<span id="cb997-3"><a href="#cb997-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> GCounter<span class="op">[</span>F<span class="op">,</span> K<span class="op">,</span> V<span class="op">]</span> <span class="op">{</span></span>
<span id="cb997-4"><a href="#cb997-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">increment</span><span class="op">(</span>f<span class="op">:</span> F<span class="op">[</span>K<span class="op">,</span> V<span class="op">])(</span>key<span class="op">:</span> K<span class="op">,</span> value<span class="op">:</span> V<span class="op">)</span></span>
<span id="cb997-5"><a href="#cb997-5" aria-hidden="true" tabindex="-1"></a>          <span class="op">(</span><span class="kw">implicit</span> m<span class="op">:</span> CommutativeMonoid<span class="op">[</span>V<span class="op">]):</span> F<span class="op">[</span>K<span class="op">,</span> V<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb997-6"><a href="#cb997-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">val</span> total <span class="op">=</span> f<span class="op">.</span><span class="fu">getOrElse</span><span class="op">(</span>key<span class="op">,</span> m<span class="op">.</span>empty<span class="op">)</span> <span class="op">|+|</span> value</span>
<span id="cb997-7"><a href="#cb997-7" aria-hidden="true" tabindex="-1"></a>      f<span class="op">.</span><span class="fu">put</span><span class="op">(</span>key<span class="op">,</span> total<span class="op">)</span></span>
<span id="cb997-8"><a href="#cb997-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb997-9"><a href="#cb997-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb997-10"><a href="#cb997-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">merge</span><span class="op">(</span>f1<span class="op">:</span> F<span class="op">[</span>K<span class="op">,</span> V<span class="op">],</span> f2<span class="op">:</span> F<span class="op">[</span>K<span class="op">,</span> V<span class="op">])</span></span>
<span id="cb997-11"><a href="#cb997-11" aria-hidden="true" tabindex="-1"></a>          <span class="op">(</span><span class="kw">implicit</span> b<span class="op">:</span> BoundedSemiLattice<span class="op">[</span>V<span class="op">]):</span> F<span class="op">[</span>K<span class="op">,</span> V<span class="op">]</span> <span class="op">=</span></span>
<span id="cb997-12"><a href="#cb997-12" aria-hidden="true" tabindex="-1"></a>      f1 <span class="op">|+|</span> f2</span>
<span id="cb997-13"><a href="#cb997-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb997-14"><a href="#cb997-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">total</span><span class="op">(</span>f<span class="op">:</span> F<span class="op">[</span>K<span class="op">,</span> V<span class="op">])(</span><span class="kw">implicit</span> m<span class="op">:</span> CommutativeMonoid<span class="op">[</span>V<span class="op">]):</span> V <span class="op">=</span></span>
<span id="cb997-15"><a href="#cb997-15" aria-hidden="true" tabindex="-1"></a>      f<span class="op">.</span>values<span class="op">.</span>combineAll</span>
<span id="cb997-16"><a href="#cb997-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
    <p>The complete code for this case study is quite long, but most of
    it is boilerplate setting up syntax for operations on the type
    class. We can cut down on this using compiler plugins such as <a href="https://github.com/mpilquist/simulacrum">Simulacrum</a> and <a href="https://github.com/typelevel/kind-projector">Kind
    Projector</a>.</p>
    <h2 data-number="19.6" id="summary-9"><span class="header-section-number">19.6</span> Summary</h2>
    <p>In this case study we’ve seen how we can use type classes to
    model a simple CRDT, the GCounter, in Scala. Our implementation
    gives us a lot of flexibility and code reuse: we aren’t tied to the
    data type we “count”, nor to the data type that maps machine IDs to
    counters.</p>
    <p>The focus in this case study has been on using the tools that
    Scala provides, not on exploring CRDTs. There are many other CRDTs,
    some of which operate in a similar manner to the GCounter, and some
    of which have very different implementations. A <a href="https://hal.inria.fr/inria-00609399v2/document">fairly recent
    survey</a> gives a good overview of many of the basic CRDTs. However
    this is an active area of research and we encourage you to read the
    recent publications in the field if CRDTs and eventually consistency
    interest you.</p>
    <h1 data-number="20" id="acknowledgements"><span class="header-section-number">20</span> Acknowledgements</h1>
    <p>No book is an island. This book wouldn’t exist without it’s
    predecessor, <em>Scala with Cats</em>, and everyone involved in
    creating that book implicitly played some part in this book’s
    creation. See below for that book’s acknowledgements, but in
    particular I want to highlight my coauthor, Dave “Lord of Types”
    Pereira-Gurnell, without whom that book would not exist and hence
    neither would this one. Thanks Dave!</p>
    <p>Thanks also to Adam Rosien, who gave me low-key encouragement and
    put up with my bullshit. Also my wife and children, who put up with
    even more of my bullshit, and gave me the space to finish this
    project. The members of ScalaBridge London and attendees at various
    training courses acted as experimental subjects for a lot of the
    material here. Thank you for being willing test subjects; you
    greatly helped improve the content. Thanks for the members of the
    PLT research group who inspired me directly back in the day, and
    continue to provide inspiration from afar. Finally, thanks to the
    following who sponsored my work or contributed with corrections and
    suggestions:</p>
    <p>Charles Adetiloye, Johanna Odersky, Lunfu Zhong, Maciej Gorywoda
    , Mathieu Pichette, Murat Cetin , Olya Mazhara, Pavel Syvak, Philip
    Schwarz, Seth Tisue</p>
    <h2 data-number="20.1" id="acknowledgements-from-scala-with-cats"><span class="header-section-number">20.1</span> Acknowledgements from
    Scala with Cats</h2>
    <p>We’d like to thank our colleagues at Inner Product and
    Underscore, our friends at Typelevel, and everyone who helped
    contribute to this book. Special thanks to Jenny Clements for her
    fantastic artwork and Richard Dallaway for his proof reading
    expertise. Here is an alphabetical list of contributors:</p>
    <p>Alessandro Marrella, Cody Koeninger, Connie Chen, Conor Fennell,
    Dani Rey, Daniela Sfregola, Danielle Ashley, David Castillo, David
    Piggott, Denis Zjukow, Dennis Hunziker, Deokhwan Kim, Edd Steel,
    Eduardo Obando Boschini, Eugene Yushin, Evgeny Veretennikov, Francis
    Devereux, Ghislain Vaillant, Gregor Ihmor, Henk-Jan Meijer,
    HigherKindedType, Janne Pelkonen, Joao Azevedo, Jason Scott, Javier
    Arrieta, Jenny Clements, Jérémie Jost, Joachim Hofer, Jonathon
    Ferguson, Lance Paine, Leif Wickland, ltbs, Lunfu Zhong, Marc
    Prud’hommeaux, Martin Carolan, mizuno, Mr-SD, Narayan Iyer, Niccolo’
    Paravanti, niqdev, Noor Nashid, Pablo Francisco Pérez Hidalgo, Pawel
    Jurczenko, Phil Derome, Philip Schwarz, Riccardo Sirigu, Richard
    Dallaway, Robert Stoll, Rodney Jacobsen, Rodrigo B. de Oliveira, Rud
    Wangrungarun, Seoh Char, Sergio Magnacco, Shohei Shimomura, Tim
    McIver, Toby Weston, Victor Osolovskiy, and Yinka Erinle.</p>
    <p>If you spot an error or potential improvement, please raise an
    issue or submit a PR on the book’s <a href="https://github.com/scalawithcats/scala-with-cats">Github
    page</a>.</p>
    <h3 class="unnumbered" id="backers">Backers</h3>
    <p>We’d also like to extend very special thanks to our backers—fine
    people who helped fund the development of the book by buying a copy
    before we released it as open source. This book wouldn’t exist
    without you:</p>
    <p>A battle-hardened technologist, Aaron Pritzlaff, Abhishek
    Srivastava, Aleksey “Daron” Terekhin, Algolia, Allen George
    (@allenageorge), Andrew Johnson, Andrew Kerr, Andy Dwelly, Anler,
    anthony@dribble.ai, Aravindh Sridaran, Araxis Ltd, ArtemK, Arthur
    Kushka (@arhelmus), Artur Zhurat, Arturas Smorgun, Attila Mravik,
    Axel Gschaider, Bamboo Le, bamine, Barry Kern, Ben Darfler
    (@bdarfler), Ben Letton, Benjamin Neil, Benoit Hericher, Bernt
    Andreas Langøien, Bill Leck, Blaze K, Boniface Kabaso, Brian
    Wongchaowart, Bryan Dragon, @cannedprimates, Ceschiatti (@6qat),
    Chris Gojlo, Chris Phelps, @CliffRedmond, Cody Koeninger, Constantin
    Gonciulea, Dadepo Aderemi, Damir Vandic, Damon Rolfs, Dan Todor,
    Daniel Arndt, Daniela Sfregola, David Greco, David Poltorak, Dennis
    Hunziker, Dennis Vriend, Derek Morr, Dimitrios Liapis, Don McNamara,
    Doug Clinton, Doug Lindholm (dlindhol), Edgar Mueller, Edward J
    Renauer Jr, Emiliano Martinez, esthom, Etienne Peiniau, Fede Silva,
    Filipe Azevedo, Franck Rasolo, Gary Coady, George Ball, Gerald
    Loeffler, Integrational, Giles Taylor, Guilherme Dantas (@gamsd),
    Harish Hurchurn, Hisham Ismail, Iurii Susuk, Ivan (SkyWriter)
    Kasatenko, Ivano Pagano, Jacob Baumbach, James Morris, Jan Vincent
    Liwanag, Javier Gonzalez, Jeff Gentry, Joel Chovanec, Jon Bates,
    Jorge Aliss (@jaliss), Juan Macias (@1macias1), Juan Ortega, Juan
    Pablo Romero Méndez, Jungsun Kim, Kaushik Chakraborty (@kaychaks),
    Keith Mannock, Ken Hoffman, Kevin Esler, Kevin Kyyro, kgillies,
    Klaus Rehm, Kostas Skourtis, Lance Linder, Liang, Guang Hua, Loïc
    Girault, Luke Tebbs, Makis A, Malcolm Robbins, Mansur Ashraf
    (@mansur_ashraf), Marcel Lüthi, Marek Prochera @hicolour, Marianudo
    (Mariano Navas), Mark Eibes, Mark van Rensburg, Martijn Blankestijn,
    Martin Studer, Matthew Edwards, Matthew Pflueger, mauropalsgraaf,
    mbarak, Mehitabel, Michael Pigg, Mikael Moghadam, Mike Gehard
    (@mikegehard), MonadicBind, arjun.mukherjee@gmail.com, Stephen
    Arbogast, Narayan Iyer, @natewave, Netanel Rabinowitz, Nick
    Peterson, Nicolas Sitbon, Oier Blasco Linares, Oliver Daff, Oliver
    Schrenk, Olly Shaw, P Villela, pandaforme, Patrick Garrity, Pawel
    Wlodarski from JUG Lodz, @peel, Peter Perhac, Phil Glover, Philipp
    Leser-Wolf, Rachel Bowyer, Radu Gancea (@radusw), Rajit Singh, Ramin
    Alidousti, Raymond Tay, Riccardo Sirigu, Richard (Yin-Wu) Chuo, Rob
    Vermazeren, Robert “Kemichal” Andersson, Robin Taylor (@badgermind),
    Rongcui Dong, Rui Morais, Rupert Bates, Rustem Suniev, Sanjiv
    Sahayam, Shane Delmore, Stefan Plantikow, Sundy Wiliam Yaputra, Tal
    Pressman, Tamas Neltz, theLXK, Tim Pigden, Tobias Lutz, Tom Duhourq,
    @tomzalt, Utz Westermann, Vadym Shalts, Val Akkapeddi, Vasanth Loka,
    Vladimir Bacvanski, Vladimir Bystrov aka udav_pit, William Benton,
    Wojciech Langiewicz, Yann Ollivier (@ya2o), Yoshiro Naito, zero323,
    and zeronone.</p>
    <div id="refs" class="references csl-bib-body hanging-indent" role="list">
    <div id="ref-10.1093/comjnl/12.1.41" class="csl-entry" role="listitem">
    <span class="smallcaps">Burstall, R.M.</span> 1969. <a href="https://doi.org/10.1093/comjnl/12.1.41"><span class="nocase">Proving Properties of Programs by Structural
    Induction</span></a>. <em>The Computer Journal</em> <em>12</em>, 1,
    41–48.
    </div>
    <div id="ref-10.1145/773184.773202" class="csl-entry" role="listitem">
    <span class="smallcaps">Danvy, O. and Nielsen, L.R.</span> 2001. <a href="https://doi.org/10.1145/773184.773202">Defunctionalization at
    work</a>. <em>Proceedings of the 3rd ACM SIGPLAN international
    conference on principles and practice of declarative
    programming</em>, Association for Computing Machinery, 162–174.
    </div>
    <div id="ref-DBLP:journals/corr/abs-2103-06913" class="csl-entry" role="listitem">
    <span class="smallcaps">Downen, P. and Ariola, Z.M.</span> 2021. <a href="https://arxiv.org/abs/2103.06913">Classical (co)recursion:
    programming</a>. <em>CoRR</em> <em>abs/2103.06913</em>.
    </div>
    <div id="ref-downen2019codata" class="csl-entry" role="listitem">
    <span class="smallcaps">Downen, P., Sullivan, Z., Ariola, Z.M., and
    Peyton Jones, S.</span> 2019. <a href="https://www.microsoft.com/en-us/research/uploads/prod/2020/01/CoDataInAction.pdf">Codata
    in action</a>. <em>European symposium on programming</em>, Springer
    International Publishing Cham, 119–146.
    </div>
    <div id="ref-felleisen18:htdp" class="csl-entry" role="listitem">
    <span class="smallcaps">Felleisen, M., Findler, R.B., Flatt, M., and
    Krishnamurthi, S.</span> 2018. <em><a href="https://htdp.org/">How
    to design programs, second edition: An introductino to programming
    and computing</a></em>. The MIT Press.
    </div>
    <div id="ref-GIBBONS_2021" class="csl-entry" role="listitem">
    <span class="smallcaps">Gibbons, J.</span> 2021. <a href="https://doi.org/10.1017/S0956796821000113">How to design
    co-programs</a>. <em>Journal of Functional Programming</em>
    <em>31</em>, e15.
    </div>
    <div id="ref-gibbons22:cps" class="csl-entry" role="listitem">
    <span class="smallcaps">Gibbons, J.</span> 2022. <a href="https://doi.org/10.22152/programming-journal.org/2022/6/7">Continuation-passing
    style, defunctionalization, accumulations, and associativity</a>.
    <em>The Art, Science, and Engineering of Programming</em>
    <em>6</em>, 7, 2.
    </div>
    <div id="ref-10.1145/291251.289455" class="csl-entry" role="listitem">
    <span class="smallcaps">Gibbons, J. and Jones, G.</span> 1998. <a href="https://doi.org/10.1145/291251.289455">The under-appreciated
    unfold</a>. <em>SIGPLAN Not.</em> <em>34</em>, 1, 273–279.
    </div>
    <div id="ref-HAGINO1989629" class="csl-entry" role="listitem">
    <span class="smallcaps">Hagino, T.</span> 1989. <a href="https://doi.org/10.1016/S0747-7171(89)80065-3">Codatatypes in
    ML</a>. <em>Journal of Symbolic Computation</em> <em>8</em>, 6,
    629–650.
    </div>
    <div id="ref-10.1007/3-540-19027-9_9" class="csl-entry" role="listitem">
    <span class="smallcaps">Kaes, S.</span> 1988. Parametric overloading
    in polymorphic programming languages. <em>ESOP ’88</em>, Springer
    Berlin Heidelberg, 131–144.
    </div>
    <div id="ref-kiselyov05:beyond" class="csl-entry" role="listitem">
    <span class="smallcaps">Kiselyov, O.</span> 2005. Beyond church
    encoding: Boehm-berarducci isomorphism of algebraic data types and
    polymorphic lambda-terms. <a href="https://okmij.org/ftp/tagless-final/course/Boehm-Berarducci.html">https://okmij.org/ftp/tagless-final/course/Boehm-Berarducci.html</a>.
    </div>
    <div id="ref-10.1145/3360589" class="csl-entry" role="listitem">
    <span class="smallcaps">Křikava, F., Miller, H., and Vitek,
    J.</span> 2019. <a href="https://doi.org/10.1145/3360589">Scala
    implicits are everywhere: A large-scale study of the use of scala
    implicits in the wild</a>. <em>Proc. ACM Program. Lang.</em>
    <em>3</em>, OOPSLA.
    </div>
    <div id="ref-10.1145/331960.331977" class="csl-entry" role="listitem">
    <span class="smallcaps">Leijen, D. and Meijer, E.</span> 2000. <a href="https://doi.org/10.1145/331960.331977">Domain specific
    embedded compilers</a>. <em>Proceedings of the 2nd conference on
    domain-specific languages</em>, Association for Computing Machinery,
    109–122.
    </div>
    <div id="ref-10.1145/325694.325708" class="csl-entry" role="listitem">
    <span class="smallcaps">Lewis, J.R., Launchbury, J., Meijer, E., and
    Shields, M.B.</span> 2000. <a href="https://doi.org/10.1145/325694.325708">Implicit parameters:
    Dynamic scoping with static types</a>. <em>Proceedings of the 27th
    ACM SIGPLAN-SIGACT symposium on principles of programming
    languages</em>, Association for Computing Machinery, 108–118.
    </div>
    <div id="ref-10.1145/1708016.1708024" class="csl-entry" role="listitem">
    <span class="smallcaps">Lin, C. and Sheard, T.</span> 2010. <a href="https://doi.org/10.1145/1708016.1708024">Pointwise generalized
    algebraic data types</a>. <em>Proceedings of the 5th ACM SIGPLAN
    workshop on types in language design and implementation</em>,
    Association for Computing Machinery, 51–62.
    </div>
    <div id="ref-mcbride01:deriv" class="csl-entry" role="listitem">
    <span class="smallcaps">McBride, C.</span> 2001. The derivative of a
    regular type is its type of one-hole contexts. <a href="http://strictlypositive.org/diff.pdf">http://strictlypositive.org/diff.pdf</a>.
    </div>
    <div id="ref-10.1007/3540543961_7" class="csl-entry" role="listitem">
    <span class="smallcaps">Meijer, E., Fokkinga, M., and Paterson,
    R.</span> 1991. <a href="https://ris.utwente.nl/ws/portalfiles/portal/6142049/meijer91functional.pdf">Functional
    programming with bananas, lenses, envelopes and barbed wire</a>.
    <em>Functional programming languages and computer architecture</em>,
    Springer Berlin Heidelberg, 124–144.
    </div>
    <div id="ref-10.1145/3158130" class="csl-entry" role="listitem">
    <span class="smallcaps">Odersky, M., Blanvillain, O., Liu, F.,
    Biboudis, A., Miller, H., and Stucki, S.</span> 2017. <a href="https://doi.org/10.1145/3158130">Simplicitly: Foundations and
    applications of implicit function types</a>. <em>Proc. ACM Program.
    Lang.</em> <em>2</em>, POPL.
    </div>
    <div id="ref-OLIVEIRA_GIBBONS_2010" class="csl-entry" role="listitem">
    <span class="smallcaps">Oliveira, B.C.D.S. and Gibbons, J.</span>
    2010. <a href="https://doi.org/10.1017/S0956796810000171">Scala for
    generic programmers: Comparing haskell and scala support for generic
    programming</a>. <em>Journal of Functional Programming</em>
    <em>20</em>, 3–4, 303–352.
    </div>
    <div id="ref-10.1145/1869459.1869489" class="csl-entry" role="listitem">
    <span class="smallcaps">Oliveira, B.C.d.S., Moors, A., and Odersky,
    M.</span> 2010. <a href="https://doi.org/10.1145/1869459.1869489">Type classes as
    objects and implicits</a>. <em>Proceedings of the ACM international
    conference on object oriented programming systems languages and
    applications</em>, Association for Computing Machinery, 341–360.
    </div>
    <div id="ref-10.1145/800194.805852" class="csl-entry" role="listitem">
    <span class="smallcaps">Reynolds, J.C.</span> 1972. <a href="https://doi.org/10.1145/800194.805852">Definitional
    interpreters for higher-order programming languages</a>.
    <em>Proceedings of the ACM annual conference - volume 2</em>,
    Association for Computing Machinery, 717–740.
    </div>
    <div id="ref-Roth_2023" class="csl-entry" role="listitem">
    <span class="smallcaps">Roth, O. and Gil, Y.</span> 2023. <a href="https://doi.org/10.1145/3586057">Fluent APIs in functional
    languages</a>. <em>Proceedings of the ACM on Programming
    Languages</em> <em>7</em>, OOPSLA1, 876–901.
    </div>
    <div id="ref-DRP-201905-Sullivan" class="csl-entry" role="listitem">
    <span class="smallcaps">Sullivan, Z.</span> 2019. <em><a href="https://www.cs.uoregon.edu/Reports/DRP-201905-Sullivan.pdf">Exploring
    codata: The relation to object-orientation</a></em>. University of
    Oregon, Computer; Information Sciences Department.
    </div>
    <div id="ref-10.1145/3022670.2951929" class="csl-entry" role="listitem">
    <span class="smallcaps">Thibodeau, D., Cave, A., and Pientka,
    B.</span> 2016. <a href="https://doi.org/10.1145/3022670.2951929">Indexed codata
    types</a>. <em>SIGPLAN Not.</em> <em>51</em>, 9, 351–363.
    </div>
    <div id="ref-10.1145/99370.99404" class="csl-entry" role="listitem">
    <span class="smallcaps">Wadler, P.</span> 1989. <a href="https://doi.org/10.1145/99370.99404">Theorems for free!</a>
    <em>Proceedings of the fourth international conference on functional
    programming languages and computer architecture</em>, Association
    for Computing Machinery, 347–359.
    </div>
    <div id="ref-10.1145/75277.75283" class="csl-entry" role="listitem">
    <span class="smallcaps">Wadler, P. and Blott, S.</span> 1989. <a href="https://doi.org/10.1145/75277.75283">How to make ad-hoc
    polymorphism less ad hoc</a>. <em>Proceedings of the 16th ACM
    SIGPLAN-SIGACT symposium on principles of programming
    languages</em>, Association for Computing Machinery, 60–76.
    </div>
    <div id="ref-wadler1998add" class="csl-entry" role="listitem">
    <span class="smallcaps">Wadler, P., Taha, W., and MacQueen,
    D.</span> 1998. <a href="https://www.diva-portal.org/smash/get/diva2:413532/FULLTEXT01.pdf">How
    to add laziness to a strict language without even being odd</a>.
    <em>SML’98, the SML workshop</em>.
    </div>
    </div>
    <section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
    <hr />
    <ol>
    <li id="fn1"><p>We assume you are using SBT 1.0.0 or newer.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
    <li id="fn2"><p>The example I gave is fairly simple. A compiler that
    used <a href="https://en.wikipedia.org/wiki/Escape_analysis">escape
    analysis</a> could recognize that no reference to <code>total</code>
    is possible outside <code>sum</code> and hence <code>sum</code> is
    pure (or referentially transparent). Escape analysis is a well
    studied technique. In the general case the problem is a lot harder.
    We’d often like to know that a value is only referenced once at
    various points in our program, and hence we can mutate that value
    without changes being observable in other parts of the program. This
    might be used, for example, to pass an accumulator through various
    processing stages. To do this requires a programming language with
    what is called a <a href="https://en.wikipedia.org/wiki/Substructural_type_system">substructural
    type system</a>. Rust has such a system, with affine types. Linear
    types are in development for Haskell.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
    <li id="fn3"><p>The example I gave is fairly simple. A compiler that
    used <a href="https://en.wikipedia.org/wiki/Escape_analysis">escape
    analysis</a> could recognize that no reference to <code>total</code>
    is possible outside <code>sum</code> and hence <code>sum</code> is
    pure (or referentially transparent). Escape analysis is a well
    studied technique. In the general case the problem is a lot harder.
    We’d often like to know that a value is only referenced once at
    various points in our program, and hence we can mutate that value
    without changes being observable in other parts of the program. This
    might be used, for example, to pass an accumulator through various
    processing stages. To do this requires a programming language with
    what is called a <a href="https://en.wikipedia.org/wiki/Substructural_type_system">substructural
    type system</a>. Rust has such a system, with affine types. Linear
    types are in development for Haskell.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
    <li id="fn4"><p>「クラス」という言葉は、厳密には、ScalaやJavaにおける
    <code>class</code> を意味するものではない<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
    <li id="fn5"><p>「クラス」という言葉は、厳密には、ScalaやJavaにおける
    <code>class</code> を意味するものではない<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
    <li id="fn6"><p>You may occasionally see extension methods referred
    to as “type enrichment” or “pimping”. These are older terms that we
    don’t use anymore.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
    <li id="fn7"><p>Parametric polymorphism represents an abstraction
    boundary. At the point of definition we don’t know the concrete
    types that <code>A</code> will take; the concrete types are only
    known at the point of use. (Once again we see the distinction
    between definition site and call site.) This abstraction boundary
    allows a kind of reasoning known as <em>free theorems</em> <span class="citation" data-cites="10.1145/99370.99404">[Wadler
    1989]</span>. For example, if we see a function with type
    <code>A =&gt; A</code> we know it must be the identity function.
    This is the only possible function with this type. Unfortunately the
    JVM allows us to break the abstraction boundary introduced by
    parametric polymorphism. We can call <code>equals</code>,
    <code>hashCode</code>, and a few other methods on all values, and we
    can inspect runtime tags that reflect some type information at
    run-time.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
    <li id="fn8"><p>In the programming literature and Haskell,
    <code>pure</code> is referred to as <code>point</code> or
    <code>return</code> and <code>flatMap</code> is referred to as
    <code>bind</code> or <code>&gt;&gt;=</code>. This is purely a
    difference in terminology. We’ll use the term <code>flatMap</code>
    for compatibility with Cats and the Scala standard library.<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
    <li id="fn9"><p>Cats provides an instance of <code>MonadError</code>
    for <code>EitherT</code>, allowing us to create instances using
    <code>raiseError</code> as well as <code>pure</code>.<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
    <li id="fn10"><p>It is a well known fact that Autobot neural nets
    are implemented in Scala. Decepticon brains are, of course,
    dynamically typed.<a href="#fnref10" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
    <li id="fn11"><p>It<a href="#fnref11" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
    <li id="fn12"><p>Semigroupal is referred to as “monoidal” in the
    paper.<a href="#fnref12" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
    <li id="fn13"><p>See <a href="https://github.com/tpolecat/cats-infographic">Rob Norris’
    infographic</a> for a the complete picture.<a href="#fnref13" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
    <li id="fn14"><p>The HTML specification allows for very lenient
    parsing of HTML. For example, if we don’t define the
    <code>head</code> tag it will usually be inferred. However we aren’t
    going to allow that kind of leniency in our API.<a href="#fnref14" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
    <li id="fn15"><p>Technically this is a <em>warning</em> not an
    error. It has been promoted to an error in our case because we’re
    using the <code>-Xfatal-warnings</code> flag on
    <code>scalac</code>.<a href="#fnref15" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
    <li id="fn16"><p>In Hadoop there is also a shuffle phase that we
    will ignore here.<a href="#fnref16" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
    <li id="fn17"><p>A closely related library called <a href="https://github.com/non/spire">Spire</a> already provides that
    abstractions.<a href="#fnref17" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
    </ol>
    </section>
  </article>
</div>

<footer>
  <div class="container-lg text-center">
    <div>
      <img class="footer-brand" src="data:image/png;base64,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" alt="Inner Product" width="150" height="150">
    </div>


    <div class="row sitemap">
      <div class="col">
        <h5><a href="http://inner-product.com">Inner Product</a></h5>
        <ul class="list-unstyled">
          <li><a href="http://inner-product.com/services/training/">Our Course Directory</a></li>
          <li><a href="http://inner-product.com/services/consulting/">Our Consulting Services</a></li>
          <li><a href="http://inner-product.com/about/">About Us</a></li>
        </ul>
      </div>

      <div class="col">
        <h5><a href="http://inner-product.com/contact">Contact</a></h5>
        <ul class="list-unstyled">
          <li><a href="http://inner-product.com">http://inner-product.com</a></li>
          <li><a href="mailto:hello@inner-product.com">hello@inner-product.com</a></li>
          <li><a href="http://twitter.com/InnerProductLLC">@InnerProductLLC</a></li>
        </ul>
      </div>
    </div>

    <div class="small">
    <p>Functional Programming Strategies In Scala with
Cats is published by Inner Product</p>
    <p>
      Copyright 2022-24 Noel Welsh.
    </p>
    <p xmlns:cc="http://creativecommons.org/ns#" xmlns:dct="http://purl.org/dc/terms/">
      <span property="dct:title">Functional Programming Strategies in Scala with Cats</span>
      is licensed under
      <a href="http://creativecommons.org/licenses/by-sa/4.0/?ref=chooser-v1" target="_blank" rel="license noopener noreferrer" style="display:inline-block;">CC BY-SA 4.0</a>
    </p>
    <p>
      Portions of this work are based on Scala with Cats, by Dave Pereira-Gurnell and Noel Welsh. Scala with Cats is licensed under <a href="https://creativecommons.org/licenses/by-sa/3.0/">CC BY-SA 3.0</a>
    </p>
  </div>
</footer>

</body>
</html>
